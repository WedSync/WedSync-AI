# TECHNICAL SPECIFICATION: WS-140 - Trial Management System
## Generated by Feature Development Session - 2025-08-24

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding venue coordinator trying WedSync for the first time
**I want to:** Get 30 days to test all Professional features with my real wedding clients
**So that:** I can see the time savings and value before committing to a paid subscription

**Real Wedding Scenario:**
A venue coordinator signs up and imports their 15 upcoming weddings. Over 30 days, they test automated timelines, guest management, and supplier coordination. After seeing 10+ hours saved per week, they qualify for a 15-day extension and ultimately convert to Professional tier.

### SPECIFICATION SOURCE
- **Feature ID:** WS-140
- **Original Spec:** /CORE-SPECIFICATIONS/13-BUSINESS-OPERATIONS/02-trial-management md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** 
  - /src/app/(dashboard)/dashboard/page.tsx
  - /src/lib/billing/subscription-manager.ts
  - /src/components/dashboard/DashboardWidgets.tsx
- **New Files to Create:**
  - /src/lib/trial/trial-manager.ts
  - /src/lib/trial/activity-tracker.ts
  - /src/lib/trial/extension-service.ts
  - /src/components/trial/TrialStatusWidget.tsx
  - /src/components/trial/TrialChecklist.tsx
  - /src/app/api/trial/status/route.ts
  - /src/app/api/trial/extend/route.ts
  - /src/app/api/trial/activity/route.ts
  - /src/app/api/trial/convert/route.ts
  - /supabase/migrations/20250824000004_trial_management_system.sql

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Trial tracking main table
CREATE TABLE IF NOT EXISTS trial_tracking (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID REFERENCES suppliers(id) ON DELETE CASCADE,
  trial_start TIMESTAMPTZ DEFAULT NOW(),
  trial_end TIMESTAMPTZ NOT NULL,
  extended BOOLEAN DEFAULT false,
  extension_date TIMESTAMPTZ,
  conversion_date TIMESTAMPTZ,
  cancellation_date TIMESTAMPTZ,
  cancellation_reason TEXT,
  activity_score INT DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(supplier_id)
);

-- Trial activity metrics daily tracking
CREATE TABLE IF NOT EXISTS trial_activity (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID REFERENCES suppliers(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  logins INT DEFAULT 0,
  forms_created INT DEFAULT 0,
  clients_imported INT DEFAULT 0,
  journeys_created INT DEFAULT 0,
  emails_sent INT DEFAULT 0,
  feature_usage JSONB DEFAULT '{}',
  time_spent_minutes INT DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(supplier_id, date)
);

-- Trial email sequence tracking
CREATE TABLE IF NOT EXISTS trial_communications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID REFERENCES suppliers(id) ON DELETE CASCADE,
  email_type TEXT NOT NULL, -- 'welcome', 'checkin', 'extension_offer', 'ending_soon'
  sent_at TIMESTAMPTZ DEFAULT NOW(),
  opened_at TIMESTAMPTZ,
  clicked_at TIMESTAMPTZ,
  converted_after BOOLEAN DEFAULT false,
  UNIQUE(supplier_id, email_type)
);

-- Function to calculate activity score
CREATE OR REPLACE FUNCTION calculate_trial_activity_score(p_supplier_id UUID)
RETURNS INT AS $$
DECLARE
  v_score INT := 0;
  v_logins INT;
  v_clients INT;
  v_forms INT;
  v_journeys INT;
BEGIN
  SELECT 
    SUM(logins),
    SUM(clients_imported),
    SUM(forms_created),
    SUM(journeys_created)
  INTO v_logins, v_clients, v_forms, v_journeys
  FROM trial_activity
  WHERE supplier_id = p_supplier_id;
  
  -- Scoring weights
  v_score := LEAST(100, 
    LEAST(v_logins * 5, 25) +  -- Max 25 points for logins
    LEAST(v_clients * 2, 30) +  -- Max 30 points for clients
    LEAST(v_forms * 20, 20) +   -- Max 20 points for forms
    LEAST(v_journeys * 25, 25)  -- Max 25 points for journeys
  );
  
  RETURN v_score;
END;
$$ LANGUAGE plpgsql;
```

#### API Endpoints Required
```typescript
// GET /api/trial/status
interface TrialStatusResponse {
  isActive: boolean;
  daysLeft: number;
  trialEnd: string;
  activityScore: number;
  extended: boolean;
  eligibleForExtension: boolean;
  checklist: {
    hasImportedClients: boolean;
    hasCreatedForm: boolean;
    hasSetupJourney: boolean;
    hasInvitedTeam: boolean;
    hasSentEmails: boolean;
  };
}

// POST /api/trial/extend
interface ExtendTrialRequest {}

interface ExtendTrialResponse {
  success: boolean;
  newTrialEnd?: string;
  extensionDays?: number;
  error?: string;
}

// GET /api/trial/activity
interface TrialActivityResponse {
  dailyActivity: Array<{
    date: string;
    logins: number;
    actions: number;
    features: string[];
  }>;
  totalStats: {
    totalLogins: number;
    clientsImported: number;
    formsCreated: number;
    journeysCreated: number;
    emailsSent: number;
  };
}

// POST /api/trial/convert
interface ConvertTrialRequest {
  tierId: string;
  billingPeriod: 'monthly' | 'annual';
}
```

#### Frontend Components Required
```typescript
// Component: TrialStatusWidget
// Location: /src/components/trial/TrialStatusWidget.tsx

interface TrialStatusWidgetProps {
  supplierId: string;
  onExtend: () => void;
  onUpgrade: () => void;
}

// Component: TrialChecklist
// Location: /src/components/trial/TrialChecklist.tsx

interface ChecklistItem {
  id: string;
  label: string;
  description: string;
  completed: boolean;
  points: number;
  action?: () => void;
}

interface TrialChecklistProps {
  items: ChecklistItem[];
  totalScore: number;
  onItemComplete: (itemId: string) => void;
}

// Key functionality:
- Real-time trial countdown display
- Activity score calculation and visualization
- Onboarding checklist with progress tracking
- Extension eligibility checking
- One-click extension activation
- Conversion tracking and prompts
```

#### Integration Points
```typescript
// Service: TrialManagementService
// Dependencies: Supabase, Email Service, Analytics

class TrialManagementService {
  static async startTrial(supplierId: string): Promise<void> {
    const trialEnd = addDays(new Date(), 30);
    
    // Create trial record
    await supabase.from('trial_tracking').insert({
      supplier_id: supplierId,
      trial_end: trialEnd
    });
    
    // Grant Professional tier features
    await supabase.from('supplier_subscriptions').insert({
      supplier_id: supplierId,
      tier_id: 'professional',
      status: 'trialing',
      trial_ends_at: trialEnd
    });
    
    // Schedule email sequence
    await this.scheduleTrialEmails(supplierId);
  }

  static async checkExtensionEligibility(supplierId: string): Promise<boolean> {
    const score = await this.calculateActivityScore(supplierId);
    const trial = await this.getTrialData(supplierId);
    
    return !trial.extended && score >= 40 && 
           differenceInDays(trial.trial_end, new Date()) <= 5;
  }

  static async trackActivity(supplierId: string, action: string): Promise<void> {
    // Real-time activity tracking
    await supabase.rpc('increment_trial_activity', {
      supplier_id: supplierId,
      activity_type: action
    });
  }
}
```

### CODE EXAMPLES

#### Example 1: Trial Status Widget Implementation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import React, { useEffect, useState } from 'react';
import { differenceInDays, format } from 'date-fns';
import { CircularProgress } from '@/components/ui/CircularProgress';
import { Button } from '@/components/ui/Button';
import { useSupplier } from '@/hooks/useSupplier';

export const TrialStatusWidget: React.FC = () => {
  const { supplier } = useSupplier();
  const [trialData, setTrialData] = useState<TrialStatus | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchTrialStatus();
  }, [supplier?.id]);

  const fetchTrialStatus = async () => {
    try {
      const response = await fetch('/api/trial/status');
      const data = await response.json();
      setTrialData(data);
    } finally {
      setLoading(false);
    }
  };

  const handleExtendTrial = async () => {
    const response = await fetch('/api/trial/extend', { method: 'POST' });
    if (response.ok) {
      await fetchTrialStatus();
      toast.success('Trial extended by 15 days!');
    }
  };

  if (loading || !trialData) return <div>Loading trial status...</div>;

  const daysLeft = differenceInDays(new Date(trialData.trialEnd), new Date());
  const urgencyClass = daysLeft <= 5 ? 'text-red-600' : 
                       daysLeft <= 10 ? 'text-yellow-600' : 'text-green-600';

  return (
    <div className="bg-white rounded-lg shadow-md p-6">
      <div className="flex justify-between items-start mb-4">
        <div>
          <h3 className="text-lg font-semibold">Professional Trial</h3>
          <p className={`text-2xl font-bold ${urgencyClass}`}>
            {daysLeft} days remaining
          </p>
          <p className="text-sm text-gray-600">
            Expires {format(new Date(trialData.trialEnd), 'MMM dd, yyyy')}
          </p>
        </div>
        <CircularProgress
          value={trialData.activityScore}
          max={100}
          size={60}
          strokeWidth={6}
        />
      </div>

      <div className="space-y-3 mb-4">
        <div className="text-sm">
          <span className="font-medium">Setup Progress:</span>
          <span className="ml-2">{trialData.activityScore}%</span>
        </div>
        
        <div className="space-y-2">
          {Object.entries(trialData.checklist).map(([key, completed]) => (
            <div key={key} className="flex items-center">
              {completed ? (
                <CheckIcon className="w-5 h-5 text-green-500 mr-2" />
              ) : (
                <CircleIcon className="w-5 h-5 text-gray-400 mr-2" />
              )}
              <span className={completed ? 'line-through text-gray-500' : ''}>
                {formatChecklistLabel(key)}
              </span>
            </div>
          ))}
        </div>
      </div>

      <div className="flex gap-2">
        {trialData.eligibleForExtension && !trialData.extended && (
          <Button
            onClick={handleExtendTrial}
            variant="secondary"
            className="flex-1"
          >
            Get 15 Extra Days Free
          </Button>
        )}
        <Button
          onClick={() => router.push('/billing')}
          variant="primary"
          className="flex-1"
        >
          Upgrade Now
        </Button>
      </div>
    </div>
  );
};
```

#### Example 2: Activity Tracking Service
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { createClient } from '@/lib/supabase/server';
import { startOfDay } from 'date-fns';

export class TrialActivityTracker {
  private static readonly ACTIVITY_WEIGHTS = {
    login: 5,
    client_import: 2,
    form_creation: 20,
    journey_creation: 25,
    email_sent: 1,
    team_invite: 10
  };

  static async trackActivity(
    supplierId: string,
    activityType: keyof typeof TrialActivityTracker.ACTIVITY_WEIGHTS,
    metadata?: Record<string, any>
  ): Promise<void> {
    const supabase = createClient();
    const today = startOfDay(new Date());

    // Upsert daily activity record
    const { data: activity } = await supabase
      .from('trial_activity')
      .upsert({
        supplier_id: supplierId,
        date: today.toISOString(),
        [`${activityType}s`]: 1
      }, {
        onConflict: 'supplier_id,date',
        count: 'exact'
      })
      .select()
      .single();

    // Update activity score
    const score = await this.calculateActivityScore(supplierId);
    await supabase
      .from('trial_tracking')
      .update({ activity_score: score })
      .eq('supplier_id', supplierId);

    // Check for milestone achievements
    await this.checkMilestones(supplierId, activityType, activity);
  }

  static async calculateActivityScore(supplierId: string): Promise<number> {
    const supabase = createClient();
    
    const { data } = await supabase
      .from('trial_activity')
      .select('*')
      .eq('supplier_id', supplierId);

    if (!data) return 0;

    const totals = data.reduce((acc, day) => ({
      logins: acc.logins + day.logins,
      clients: acc.clients + day.clients_imported,
      forms: acc.forms + day.forms_created,
      journeys: acc.journeys + day.journeys_created
    }), { logins: 0, clients: 0, forms: 0, journeys: 0 });

    // Calculate weighted score (max 100)
    const score = Math.min(100,
      Math.min(totals.logins * 5, 25) +    // Max 25 points
      Math.min(totals.clients * 2, 30) +   // Max 30 points
      Math.min(totals.forms * 20, 20) +    // Max 20 points
      Math.min(totals.journeys * 25, 25)   // Max 25 points
    );

    return score;
  }

  private static async checkMilestones(
    supplierId: string,
    activityType: string,
    currentActivity: any
  ): Promise<void> {
    // Check for first-time achievements
    if (activityType === 'client_import' && currentActivity.clients_imported === 10) {
      await this.sendMilestoneEmail(supplierId, 'imported_10_clients');
    }
    
    if (activityType === 'form_creation' && currentActivity.forms_created === 1) {
      await this.sendMilestoneEmail(supplierId, 'created_first_form');
    }
  }
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [ ] Context7: Load docs for date-fns, email scheduling patterns
- [ ] Playwright: Test trial extension flows and conversion
- [ ] PostgreSQL: Test trial tracking queries and functions

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/date-fns/date-fns", "addDays differenceInDays", 2000);
await mcp__context7__get-library-docs("/supabase/supabase", "rpc functions", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('TrialManagementService', () => {
  it('should start 30-day trial with Professional features', async () => {
    const supplierId = 'test-supplier-1';
    await TrialManagementService.startTrial(supplierId);
    
    const trial = await getTrialData(supplierId);
    expect(trial.status).toBe('trialing');
    expect(differenceInDays(trial.trial_end, new Date())).toBe(30);
  });

  it('should calculate activity score correctly', async () => {
    const tracker = new TrialActivityTracker();
    // Setup test data: 5 logins, 10 clients, 1 form
    const score = await tracker.calculateActivityScore('supplier-1');
    expect(score).toBe(45); // 25 + 20 + 20 = 65 points
  });

  it('should check extension eligibility', async () => {
    const eligible = await TrialManagementService.checkExtensionEligibility('supplier-1');
    expect(eligible).toBeDefined();
    expect(typeof eligible).toBe('boolean');
  });
});

describe('TrialStatusWidget', () => {
  it('should display days remaining', () => {
    render(<TrialStatusWidget />);
    expect(screen.getByText(/days remaining/i)).toBeInTheDocument();
  });

  it('should show extension button when eligible', () => {
    const mockData = { eligibleForExtension: true, extended: false };
    render(<TrialStatusWidget />);
    expect(screen.getByText('Get 15 Extra Days Free')).toBeInTheDocument();
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Trial extension flow', async () => {
  // Setup: Create trial nearing expiry with good activity
  await setupTrialNearExpiry('test-supplier');
  
  await mcp__playwright__browser_navigate({ url: '/dashboard' });
  await mcp__playwright__browser_snapshot();
  
  // Should see extension offer
  await mcp__playwright__browser_wait_for({ text: 'Get 15 Extra Days Free' });
  
  // Click extension button
  await mcp__playwright__browser_click({
    element: 'Extension button',
    ref: '[data-testid="extend-trial-btn"]'
  });
  
  // Verify extension applied
  await mcp__playwright__browser_wait_for({ text: '45 days remaining' });
});

test('Trial conversion tracking', async () => {
  await mcp__playwright__browser_navigate({ url: '/billing' });
  
  // Click upgrade during trial
  await mcp__playwright__browser_click({
    element: 'Upgrade to Professional',
    ref: '[data-testid="upgrade-professional"]'
  });
  
  // Complete Stripe checkout
  // ...
  
  // Verify trial converted
  const subscription = await getSubscriptionStatus();
  expect(subscription.status).toBe('active');
  expect(subscription.wasTrialing).toBe(true);
});
```

### ACCEPTANCE CRITERIA
- [ ] 30-day trial starts immediately upon signup
- [ ] Professional features available during trial
- [ ] Activity score calculated from weighted actions
- [ ] Extension offer appears when eligible (40+ score, <5 days left)
- [ ] Extension adds exactly 15 days, one-time only
- [ ] Email sequence sent on schedule (day 0, 3, 7, 14, 25, 28, 30)
- [ ] Grace period of 3 days after trial ends
- [ ] Performance: Activity tracking under 100ms
- [ ] Security: Trial data protected by RLS policies
- [ ] Accessibility: Trial widget keyboard navigable

### DEPENDENCIES
- Must complete after: WS-139 (Pricing Strategy System)
- Must complete before: WS-142 (Customer Success System)
- Shares code with: WS-132 (Trial Management), WS-133 (Customer Success)

### ESTIMATED EFFORT
- Team A Frontend: 24 hours (widget, checklist, dashboard)
- Team B Backend: 32 hours (trial logic, activity tracking, emails)
- Team C Integration: 16 hours (testing, migrations, monitoring)
- Total: 72 hours