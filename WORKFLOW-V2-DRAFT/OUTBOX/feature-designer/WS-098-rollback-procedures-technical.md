# TECHNICAL SPECIFICATION: WS-098 - Rollback Procedures
## Generated by Feature Development Session - August 22, 2025

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding photographer using WedSync during a client's wedding day
**I want to:** Continue accessing shot lists and timeline updates even if a deployment fails
**So that:** I never miss critical moments or lose coordination with other vendors during the wedding

**Real Wedding Scenario:**
A venue coordinator updates the ceremony start time from 4:00 PM to 4:30 PM due to traffic delays. A bad deployment causes the system to crash just as vendors need this update. With rollback procedures, the system automatically reverts to the last stable version within 60 seconds, ensuring all vendors see the updated timeline and the wedding proceeds smoothly.

### SPECIFICATION SOURCE
- **Feature ID:** WS-098
- **Original Spec:** /CORE-SPECIFICATIONS/11-TESTING-DEPLOYMENT/02-CI-CD/04-rollback-procedures md.md
- **Current Implementation:** 0% complete
- **Files to Modify:**
  - `/wedsync/lib/deployment/version-tracker.ts` (create new)
  - `/wedsync/app/api/health/route.ts` (create new)
  - `/wedsync/monitoring/rollback-monitor.ts` (create new)
- **New Files to Create:**
  - `/wedsync/.github/workflows/rollback.yml`
  - `/wedsync/scripts/rollback-migration.ts`
  - `/wedsync/scripts/recover-state.sh`
  - `/wedsync/lib/feature-flags.ts`
  - `/wedsync/vercel.json` (blue-green deployment config)

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Deployment history tracking
CREATE TABLE IF NOT EXISTS deployment_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  git_sha VARCHAR(40) NOT NULL,
  vercel_deployment_id VARCHAR(100) NOT NULL,
  db_migration_version VARCHAR(50) NOT NULL,
  environment_variables JSONB DEFAULT '{}',
  health_check_status VARCHAR(20) DEFAULT 'unknown' CHECK (health_check_status IN ('passing', 'failing', 'unknown')),
  rollback_target BOOLEAN DEFAULT false,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Health check table for monitoring
CREATE TABLE IF NOT EXISTS health_check (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Feature flag rollback tracking
CREATE TABLE IF NOT EXISTS feature_rollbacks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  feature_name VARCHAR(100) NOT NULL,
  rolled_back_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  previous_state VARCHAR(20) NOT NULL,
  reason TEXT,
  rolled_back_by VARCHAR(100) NOT NULL,
  restored_at TIMESTAMP WITH TIME ZONE NULL
);
```

#### API Endpoints Required
```typescript
// GET /api/health
interface HealthResponse {
  api: 'healthy' | 'unhealthy';
  database: 'healthy' | 'unhealthy' | 'unknown';
  redis: 'healthy' | 'unhealthy' | 'unknown';
  stripe: 'healthy' | 'unhealthy' | 'unknown';
  timestamp: string;
  deployment_id: string;
}

// POST /api/rollback/trigger
interface RollbackRequest {
  deployment_id: string;
  reason: string;
  environment: 'production' | 'staging';
}

interface RollbackResponse {
  success: boolean;
  rollback_id: string;
  message: string;
}

// GET /api/rollback/status/:id
interface RollbackStatusResponse {
  status: 'pending' | 'in_progress' | 'completed' | 'failed';
  steps_completed: string[];
  current_step: string;
  error?: string;
}
```

#### Frontend Components Required
```typescript
// Component: RollbackStatusIndicator
// Location: /src/components/admin/RollbackStatusIndicator.tsx

interface Props {
  deploymentId: string;
  healthStatus: 'healthy' | 'degraded' | 'critical';
  onTriggerRollback: () => void;
}

// Key functionality:
- Shows deployment health in real-time
- Displays rollback button for emergencies
- Shows progress during rollback operations

// Component: DeploymentHistory
// Location: /src/components/admin/DeploymentHistory.tsx

interface Props {
  deployments: DeploymentVersion[];
  onSelectRollbackTarget: (id: string) => void;
}

// Key functionality:
- Lists recent deployments with health status
- Allows selection of rollback target
- Shows git SHA and timestamp for each deployment
```

#### Integration Points
```typescript
// Service: RollbackService
// Dependencies: Vercel API, Supabase, Redis

class RollbackService {
  async triggerRollback(deploymentId: string, reason: string) {
    // 1. Record rollback attempt
    // 2. Update Vercel alias to previous deployment
    // 3. Execute database rollback if needed
    // 4. Clear caches and restart services
    // 5. Verify rollback success
  }
  
  async checkDeploymentHealth(deploymentId: string) {
    // Tests API endpoints, database, external services
    // Returns boolean indicating if rollback needed
  }
  
  async getLastStableVersion() {
    // Queries deployment_history for last passing deployment
    // Returns deployment details for rollback target
  }
}

// Hook: useRollbackMonitor
export function useRollbackMonitor(deploymentId: string) {
  // Real-time health monitoring
  // Triggers alerts when thresholds exceeded
  // Returns health status and metrics
}
```

### CODE EXAMPLES

#### Example 1: Automated Health Check Implementation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { createClient } from '@supabase/supabase-js';
import { Redis } from '@upstash/redis';

export async function GET() {
  const checks = {
    api: 'healthy' as const,
    database: 'unknown' as const,
    redis: 'unknown' as const,
    stripe: 'unknown' as const,
  };
  
  try {
    // Database connectivity check
    const { error: dbError } = await supabase
      .from('health_check')
      .select('id')
      .limit(1);
    checks.database = dbError ? 'unhealthy' : 'healthy';
    
    // Redis connectivity check
    await redis.ping();
    checks.redis = 'healthy';
    
    // External service checks
    const stripeCheck = await fetch('https://api.stripe.com/v1/account', {
      headers: { Authorization: `Bearer ${process.env.STRIPE_SECRET_KEY}` }
    });
    checks.stripe = stripeCheck.ok ? 'healthy' : 'unhealthy';
    
  } catch (error) {
    console.error('Health check failed:', error);
  }
  
  const allHealthy = Object.values(checks).every(v => v === 'healthy');
  
  return Response.json({
    ...checks,
    timestamp: new Date().toISOString(),
    deployment_id: process.env.VERCEL_DEPLOYMENT_ID
  }, {
    status: allHealthy ? 200 : 503
  });
}
```

#### Example 2: Emergency Rollback Trigger
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { exec } from 'child_process';
import { promisify } from 'util';

const execAsync = promisify(exec);

export async function triggerEmergencyRollback(
  targetDeploymentId: string,
  environment: 'production' | 'staging',
  reason: string
) {
  try {
    // 1. Record rollback attempt
    const { data: rollbackRecord } = await supabase
      .from('deployment_history')
      .insert({
        git_sha: 'rollback',
        vercel_deployment_id: targetDeploymentId,
        db_migration_version: 'rollback',
        health_check_status: 'unknown'
      })
      .select()
      .single();
    
    // 2. Execute Vercel alias update
    await execAsync(`vercel alias set ${targetDeploymentId} ${environment}-wedsync.vercel.app --token=${process.env.VERCEL_TOKEN}`);
    
    // 3. Clear CDN cache
    await fetch('https://api.vercel.com/v1/purge', {
      method: 'POST',
      headers: { Authorization: `Bearer ${process.env.VERCEL_TOKEN}` },
      body: JSON.stringify({ urls: ['/'] })
    });
    
    // 4. Verify rollback success
    const healthCheck = await fetch(`https://${environment}-wedsync.vercel.app/api/health`);
    
    if (healthCheck.ok) {
      await supabase
        .from('deployment_history')
        .update({ health_check_status: 'passing' })
        .eq('id', rollbackRecord.id);
      
      return { success: true, rollback_id: rollbackRecord.id };
    }
    
    throw new Error('Rollback verification failed');
    
  } catch (error) {
    console.error('Rollback failed:', error);
    throw error;
  }
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [ ] Context7: Load docs for Vercel deployment API, GitHub Actions
- [ ] GitHub: Create and manage rollback workflows
- [ ] PostgreSQL: Create deployment tracking tables

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/vercel/vercel", "deployment api", 2500);
await mcp__context7__get-library-docs("/redis/upstash-redis", "redis operations", 1500);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('Rollback Procedures', () => {
  it('should identify last stable deployment correctly', () => {
    // Test version tracking and stable version identification
  });
  
  it('should execute rollback within 60 seconds', () => {
    // Test rollback speed requirements
  });
  
  it('should handle rollback failures gracefully', () => {
    // Test error handling and recovery procedures
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Emergency rollback workflow completes successfully', async () => {
  await mcp__playwright__browser_navigate({url: '/admin/deployments'});
  await mcp__playwright__browser_click({element: 'rollback button', ref: '#rollback-btn'});
  await mcp__playwright__browser_wait_for({text: 'Rollback completed'});
  // Verify system functionality after rollback
});
```

### ACCEPTANCE CRITERIA
- [ ] Rollback completes within 60 seconds of initiation
- [ ] System automatically reverts on error rate > 5%
- [ ] Database rollbacks preserve data integrity
- [ ] Health checks run every 30 seconds post-rollback
- [ ] Performance: Health check API responds under 500ms
- [ ] Security: Rollback actions logged with user attribution
- [ ] Accessibility: Admin interface meets WCAG 2.1 AA standards

### DEPENDENCIES
- Must complete after: WS-096 (Deployment Pipeline)
- Must complete before: Production go-live
- Shares code with: WS-100 (System Health Monitoring), WS-103 (Error Tracking)

### ESTIMATED EFFORT
- Team A Frontend: 6 hours (admin interface, status indicators)
- Team B Backend: 16 hours (rollback automation, health checks, database procedures)
- Team C Integration: 10 hours (Vercel API integration, GitHub workflows)
- Total: 32 hours