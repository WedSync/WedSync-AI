# TECHNICAL SPECIFICATION: WS-350 - Marketing Automation System
## Generated by Feature Development Session - 2025-01-20

### USER STORY & BUSINESS CONTEXT
**As a:** Wedding supplier using WedSync to grow my business
**I want to:** Automate my marketing campaigns, nurture leads, and engage with couples through personalized messaging
**So that:** I can maintain consistent communication, convert more leads, and grow my wedding business without manual effort

**Real Wedding Scenario:**
Emma, a wedding photographer, receives 50+ inquiries per month. With WedSync's marketing automation, she creates automated email sequences that nurture leads with her portfolio, client testimonials, and booking incentives. When couples visit her website, they're automatically tagged and entered into appropriate nurture sequences. Result: 40% increase in bookings with 80% less manual follow-up work.

**Business Impact:**
- 67% of wedding suppliers struggle with consistent lead follow-up
- Automated marketing increases conversion rates by 45-65%
- Personalized campaigns generate 3x higher engagement than broadcast emails
- Wedding booking cycles average 12-18 months requiring long-term nurturing
- Reduces manual marketing work by 75% while improving consistency

### SPECIFICATION SOURCE
- **Feature ID:** WS-350
- **Original Spec:** /CORE-SPECIFICATIONS/marketing-automation/campaign-management/
- **Current Implementation:** 0% complete (new feature)
- **Files to Modify:** Dashboard components, notification system, email templates
- **New Files to Create:** Campaign builder, automation workflows, lead scoring system

### TECHNICAL DESIGN

#### Database Schema Required

```sql
-- Marketing Campaign Templates
CREATE TABLE marketing_campaigns (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    supplier_id UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,
    campaign_name VARCHAR(255) NOT NULL,
    campaign_type VARCHAR(50) CHECK (campaign_type IN ('email_sequence', 'drip_campaign', 'promotional', 'seasonal', 'abandoned_inquiry', 'post_wedding', 'referral_nurture')) NOT NULL,
    campaign_status VARCHAR(50) CHECK (campaign_status IN ('draft', 'active', 'paused', 'completed', 'archived')) DEFAULT 'draft',
    campaign_description TEXT,
    target_audience JSONB DEFAULT '{}', -- Segmentation criteria
    trigger_conditions JSONB DEFAULT '{}', -- What triggers this campaign
    campaign_settings JSONB DEFAULT '{
        "send_days": ["monday", "tuesday", "wednesday", "thursday", "friday"],
        "send_times": ["09:00", "14:00"],
        "timezone": "Europe/London",
        "frequency_cap": 1,
        "respect_unsubscribe": true,
        "track_opens": true,
        "track_clicks": true
    }',
    goals JSONB DEFAULT '{}', -- Campaign objectives and KPIs
    budget_settings JSONB DEFAULT '{}', -- If paid campaigns
    start_date TIMESTAMPTZ,
    end_date TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Individual Campaign Steps/Messages
CREATE TABLE campaign_steps (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    campaign_id UUID NOT NULL REFERENCES marketing_campaigns(id) ON DELETE CASCADE,
    step_order INTEGER NOT NULL,
    step_name VARCHAR(255) NOT NULL,
    step_type VARCHAR(50) CHECK (step_type IN ('email', 'sms', 'push_notification', 'task_reminder', 'tag_action', 'wait_delay', 'condition_split')) NOT NULL,
    delay_config JSONB DEFAULT '{}', -- How long to wait before this step
    condition_config JSONB DEFAULT '{}', -- Conditional logic for this step
    content_config JSONB DEFAULT '{}', -- Message content and template
    action_config JSONB DEFAULT '{}', -- Actions to perform
    personalization_rules JSONB DEFAULT '{}', -- Dynamic content rules
    delivery_settings JSONB DEFAULT '{}', -- Channel-specific settings
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(campaign_id, step_order)
);

-- Contact Lists and Segments
CREATE TABLE contact_segments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    supplier_id UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,
    segment_name VARCHAR(255) NOT NULL,
    segment_type VARCHAR(50) CHECK (segment_type IN ('static', 'dynamic', 'behavioral', 'demographic', 'engagement_based')) NOT NULL,
    segment_criteria JSONB DEFAULT '{}', -- Rules for inclusion
    contact_count INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    last_updated TIMESTAMPTZ DEFAULT NOW(),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Campaign Enrollments (People in campaigns)
CREATE TABLE campaign_enrollments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    campaign_id UUID NOT NULL REFERENCES marketing_campaigns(id) ON DELETE CASCADE,
    contact_id UUID NOT NULL REFERENCES wedding_clients(id) ON DELETE CASCADE,
    enrollment_source VARCHAR(50) CHECK (enrollment_source IN ('manual', 'trigger', 'import', 'form_submission', 'api', 'webhook')) NOT NULL,
    enrollment_status VARCHAR(50) CHECK (enrollment_status IN ('active', 'paused', 'completed', 'unsubscribed', 'failed', 'suppressed')) DEFAULT 'active',
    current_step INTEGER DEFAULT 1,
    next_action_at TIMESTAMPTZ,
    enrollment_data JSONB DEFAULT '{}', -- Context data for personalization
    completion_reason TEXT,
    enrolled_at TIMESTAMPTZ DEFAULT NOW(),
    completed_at TIMESTAMPTZ,
    last_action_at TIMESTAMPTZ,
    
    UNIQUE(campaign_id, contact_id)
);

-- Campaign Message Deliveries
CREATE TABLE campaign_deliveries (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    enrollment_id UUID NOT NULL REFERENCES campaign_enrollments(id) ON DELETE CASCADE,
    campaign_step_id UUID NOT NULL REFERENCES campaign_steps(id) ON DELETE CASCADE,
    contact_id UUID NOT NULL REFERENCES wedding_clients(id),
    delivery_method VARCHAR(50) CHECK (delivery_method IN ('email', 'sms', 'push', 'webhook', 'task')) NOT NULL,
    delivery_status VARCHAR(50) CHECK (delivery_status IN ('pending', 'sent', 'delivered', 'opened', 'clicked', 'replied', 'failed', 'bounced', 'unsubscribed')) DEFAULT 'pending',
    recipient_info JSONB DEFAULT '{}', -- Email, phone, etc.
    message_content JSONB DEFAULT '{}', -- Final rendered content
    delivery_data JSONB DEFAULT '{}', -- Provider response data
    error_message TEXT,
    scheduled_at TIMESTAMPTZ NOT NULL,
    sent_at TIMESTAMPTZ,
    delivered_at TIMESTAMPTZ,
    opened_at TIMESTAMPTZ,
    clicked_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    INDEX(contact_id, scheduled_at),
    INDEX(delivery_status, scheduled_at)
);

-- Lead Scoring System
CREATE TABLE lead_scores (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    contact_id UUID NOT NULL REFERENCES wedding_clients(id) ON DELETE CASCADE,
    supplier_id UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,
    current_score INTEGER DEFAULT 0,
    demographic_score INTEGER DEFAULT 0,
    behavioral_score INTEGER DEFAULT 0,
    engagement_score INTEGER DEFAULT 0,
    fit_score INTEGER DEFAULT 0,
    last_activity_date TIMESTAMPTZ,
    score_history JSONB DEFAULT '[]', -- Track score changes over time
    qualification_status VARCHAR(50) CHECK (qualification_status IN ('cold', 'warm', 'hot', 'marketing_qualified', 'sales_qualified', 'customer', 'lost')) DEFAULT 'cold',
    qualification_date TIMESTAMPTZ,
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(contact_id, supplier_id)
);

-- Marketing Automation Rules
CREATE TABLE automation_rules (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    supplier_id UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,
    rule_name VARCHAR(255) NOT NULL,
    rule_type VARCHAR(50) CHECK (rule_type IN ('trigger_campaign', 'lead_scoring', 'contact_tagging', 'list_management', 'notification_alert')) NOT NULL,
    trigger_events JSONB DEFAULT '[]', -- What events trigger this rule
    conditions JSONB DEFAULT '{}', -- Additional conditions to check
    actions JSONB DEFAULT '[]', -- Actions to perform when triggered
    is_active BOOLEAN DEFAULT TRUE,
    execution_count INTEGER DEFAULT 0,
    last_executed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Email Templates
CREATE TABLE email_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    supplier_id UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,
    template_name VARCHAR(255) NOT NULL,
    template_category VARCHAR(100) CHECK (template_category IN ('welcome', 'nurture', 'promotional', 'booking_reminder', 'follow_up', 'testimonial_request', 'seasonal', 'thank_you')) NOT NULL,
    subject_line VARCHAR(255) NOT NULL,
    preview_text VARCHAR(150),
    html_content TEXT NOT NULL,
    text_content TEXT,
    design_config JSONB DEFAULT '{}', -- Template design settings
    personalization_fields JSONB DEFAULT '[]', -- Available merge fields
    template_tags VARCHAR(255)[] DEFAULT '{}',
    usage_count INTEGER DEFAULT 0,
    last_used_at TIMESTAMPTZ,
    is_shared BOOLEAN DEFAULT FALSE, -- Can other suppliers use this template
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Marketing Analytics
CREATE TABLE marketing_analytics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    supplier_id UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,
    analytics_date DATE NOT NULL,
    campaign_id UUID REFERENCES marketing_campaigns(id) ON DELETE CASCADE,
    
    -- Email metrics
    emails_sent INTEGER DEFAULT 0,
    emails_delivered INTEGER DEFAULT 0,
    emails_opened INTEGER DEFAULT 0,
    emails_clicked INTEGER DEFAULT 0,
    emails_bounced INTEGER DEFAULT 0,
    emails_unsubscribed INTEGER DEFAULT 0,
    
    -- SMS metrics
    sms_sent INTEGER DEFAULT 0,
    sms_delivered INTEGER DEFAULT 0,
    sms_clicked INTEGER DEFAULT 0,
    sms_failed INTEGER DEFAULT 0,
    
    -- Conversion metrics
    leads_generated INTEGER DEFAULT 0,
    consultations_booked INTEGER DEFAULT 0,
    quotes_requested INTEGER DEFAULT 0,
    bookings_made INTEGER DEFAULT 0,
    revenue_attributed DECIMAL(12,2) DEFAULT 0.00,
    
    -- Engagement metrics
    website_visits INTEGER DEFAULT 0,
    form_submissions INTEGER DEFAULT 0,
    social_interactions INTEGER DEFAULT 0,
    referrals_generated INTEGER DEFAULT 0,
    
    -- Cost metrics
    campaign_spend DECIMAL(10,2) DEFAULT 0.00,
    cost_per_lead DECIMAL(10,2) DEFAULT 0.00,
    return_on_ad_spend DECIMAL(5,4) DEFAULT 0.0000,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(supplier_id, analytics_date, campaign_id)
);

-- A/B Test Campaigns
CREATE TABLE campaign_ab_tests (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    campaign_id UUID NOT NULL REFERENCES marketing_campaigns(id) ON DELETE CASCADE,
    test_name VARCHAR(255) NOT NULL,
    test_type VARCHAR(50) CHECK (test_type IN ('subject_line', 'content', 'send_time', 'sender_name', 'call_to_action')) NOT NULL,
    variant_a_config JSONB NOT NULL,
    variant_b_config JSONB NOT NULL,
    traffic_split DECIMAL(3,2) DEFAULT 0.50, -- 50/50 split
    test_status VARCHAR(50) CHECK (test_status IN ('running', 'completed', 'paused', 'cancelled')) DEFAULT 'running',
    winner_variant CHAR(1) CHECK (winner_variant IN ('A', 'B')),
    confidence_level DECIMAL(5,4),
    start_date TIMESTAMPTZ NOT NULL,
    end_date TIMESTAMPTZ,
    results_data JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Performance Indexes
CREATE INDEX idx_marketing_campaigns_supplier_status ON marketing_campaigns(supplier_id, campaign_status);
CREATE INDEX idx_campaign_steps_campaign_order ON campaign_steps(campaign_id, step_order);
CREATE INDEX idx_campaign_enrollments_campaign_status ON campaign_enrollments(campaign_id, enrollment_status);
CREATE INDEX idx_campaign_deliveries_scheduled ON campaign_deliveries(scheduled_at) WHERE delivery_status = 'pending';
CREATE INDEX idx_lead_scores_supplier_score ON lead_scores(supplier_id, current_score DESC);
CREATE INDEX idx_marketing_analytics_date_supplier ON marketing_analytics(analytics_date, supplier_id);
CREATE INDEX idx_automation_rules_active_supplier ON automation_rules(supplier_id) WHERE is_active = true;
```

#### API Endpoints Required

```typescript
// Marketing Automation Types
interface MarketingCampaign {
  id: string;
  supplier_id: string;
  campaign_name: string;
  campaign_type: 'email_sequence' | 'drip_campaign' | 'promotional' | 'seasonal' | 'abandoned_inquiry' | 'post_wedding' | 'referral_nurture';
  campaign_status: 'draft' | 'active' | 'paused' | 'completed' | 'archived';
  campaign_description?: string;
  target_audience: SegmentationCriteria;
  trigger_conditions: TriggerConditions;
  campaign_settings: CampaignSettings;
  goals: CampaignGoals;
  budget_settings?: BudgetSettings;
  start_date?: string;
  end_date?: string;
  created_at: string;
  updated_at: string;
}

interface CampaignSettings {
  send_days: string[];
  send_times: string[];
  timezone: string;
  frequency_cap: number;
  respect_unsubscribe: boolean;
  track_opens: boolean;
  track_clicks: boolean;
}

interface SegmentationCriteria {
  wedding_type?: string[];
  budget_range?: { min: number; max: number };
  location_radius?: { lat: number; lng: number; radius: number };
  wedding_date_range?: { start: string; end: string };
  lead_score_range?: { min: number; max: number };
  previous_engagement?: string[];
  source_channels?: string[];
  behavior_tags?: string[];
}

interface TriggerConditions {
  trigger_type: 'immediate' | 'delayed' | 'event_based' | 'date_based' | 'behavioral';
  trigger_events?: string[];
  delay_amount?: number;
  delay_unit?: 'minutes' | 'hours' | 'days' | 'weeks';
  conditions?: Record<string, any>;
}

interface CampaignStep {
  id: string;
  campaign_id: string;
  step_order: number;
  step_name: string;
  step_type: 'email' | 'sms' | 'push_notification' | 'task_reminder' | 'tag_action' | 'wait_delay' | 'condition_split';
  delay_config: DelayConfig;
  condition_config?: ConditionConfig;
  content_config: ContentConfig;
  action_config?: ActionConfig;
  personalization_rules: PersonalizationRules;
  delivery_settings: DeliverySettings;
  is_active: boolean;
  created_at: string;
  updated_at: string;
}

interface DelayConfig {
  delay_type: 'immediate' | 'fixed_delay' | 'smart_timing' | 'business_hours';
  delay_amount?: number;
  delay_unit?: 'minutes' | 'hours' | 'days' | 'weeks';
  business_hours_config?: {
    start_time: string;
    end_time: string;
    days: string[];
    timezone: string;
  };
}

interface ContentConfig {
  template_id?: string;
  subject_line?: string;
  preview_text?: string;
  html_content?: string;
  text_content?: string;
  sms_content?: string;
  dynamic_content_rules?: DynamicContentRule[];
  call_to_action?: CallToAction;
}

interface DynamicContentRule {
  condition: string;
  content_variant: string;
  personalization_tokens: Record<string, string>;
}

interface CallToAction {
  text: string;
  url: string;
  style: 'primary' | 'secondary' | 'text';
  tracking_parameters?: Record<string, string>;
}

interface PersonalizationRules {
  merge_fields: Record<string, string>;
  conditional_content: ConditionalContent[];
  smart_recommendations: boolean;
  location_based_content: boolean;
}

interface ConditionalContent {
  condition: string;
  show_content: string;
  hide_content?: string;
}

interface LeadScore {
  id: string;
  contact_id: string;
  supplier_id: string;
  current_score: number;
  demographic_score: number;
  behavioral_score: number;
  engagement_score: number;
  fit_score: number;
  last_activity_date?: string;
  score_history: ScoreHistoryEntry[];
  qualification_status: 'cold' | 'warm' | 'hot' | 'marketing_qualified' | 'sales_qualified' | 'customer' | 'lost';
  qualification_date?: string;
  notes?: string;
  created_at: string;
  updated_at: string;
}

interface ScoreHistoryEntry {
  date: string;
  score_change: number;
  reason: string;
  source: string;
}

interface AutomationRule {
  id: string;
  supplier_id: string;
  rule_name: string;
  rule_type: 'trigger_campaign' | 'lead_scoring' | 'contact_tagging' | 'list_management' | 'notification_alert';
  trigger_events: string[];
  conditions: Record<string, any>;
  actions: AutomationAction[];
  is_active: boolean;
  execution_count: number;
  last_executed_at?: string;
  created_at: string;
  updated_at: string;
}

interface AutomationAction {
  action_type: 'enroll_campaign' | 'add_tag' | 'remove_tag' | 'update_score' | 'send_notification' | 'create_task' | 'update_field';
  action_config: Record<string, any>;
}

// API Request/Response Types
interface CreateCampaignRequest {
  campaign_name: string;
  campaign_type: MarketingCampaign['campaign_type'];
  campaign_description?: string;
  target_audience: SegmentationCriteria;
  trigger_conditions: TriggerConditions;
  campaign_settings: CampaignSettings;
  goals: CampaignGoals;
  steps: Omit<CampaignStep, 'id' | 'campaign_id' | 'created_at' | 'updated_at'>[];
}

interface CreateCampaignResponse {
  success: boolean;
  data: MarketingCampaign;
  campaign_steps: CampaignStep[];
  message?: string;
}

interface CampaignPerformanceRequest {
  campaign_id: string;
  date_range: {
    start_date: string;
    end_date: string;
  };
  metrics?: string[];
}

interface CampaignPerformanceResponse {
  success: boolean;
  data: {
    campaign: MarketingCampaign;
    performance_metrics: {
      total_enrollments: number;
      active_enrollments: number;
      completed_enrollments: number;
      total_sends: number;
      delivery_rate: number;
      open_rate: number;
      click_rate: number;
      unsubscribe_rate: number;
      conversion_rate: number;
      revenue_attributed: number;
      cost_per_conversion: number;
      roi: number;
    };
    step_performance: Array<{
      step_id: string;
      step_name: string;
      sends: number;
      opens: number;
      clicks: number;
      conversions: number;
    }>;
    timeline_data: Array<{
      date: string;
      sends: number;
      opens: number;
      clicks: number;
      conversions: number;
    }>;
  };
  message?: string;
}

interface EnrollContactRequest {
  campaign_id: string;
  contact_ids: string[];
  enrollment_source: 'manual' | 'trigger' | 'import' | 'form_submission' | 'api' | 'webhook';
  enrollment_data?: Record<string, any>;
  start_immediately?: boolean;
}

interface EnrollContactResponse {
  success: boolean;
  enrolled_count: number;
  failed_enrollments: Array<{
    contact_id: string;
    reason: string;
  }>;
  message?: string;
}

interface LeadScoringRequest {
  contact_id: string;
  scoring_events: Array<{
    event_type: string;
    event_data: Record<string, any>;
    timestamp: string;
  }>;
}

interface LeadScoringResponse {
  success: boolean;
  data: {
    previous_score: number;
    new_score: number;
    score_change: number;
    qualification_status: string;
    scoring_breakdown: {
      demographic: number;
      behavioral: number;
      engagement: number;
      fit: number;
    };
  };
  message?: string;
}

interface MarketingDashboardStats {
  total_campaigns: number;
  active_campaigns: number;
  total_contacts: number;
  marketing_qualified_leads: number;
  this_month_metrics: {
    emails_sent: number;
    open_rate: number;
    click_rate: number;
    conversion_rate: number;
    revenue_attributed: number;
    cost_per_lead: number;
    roi: number;
  };
  top_performing_campaigns: Array<{
    campaign_id: string;
    campaign_name: string;
    open_rate: number;
    click_rate: number;
    conversion_rate: number;
    revenue: number;
  }>;
  recent_conversions: Array<{
    contact_id: string;
    contact_name: string;
    campaign_name: string;
    conversion_type: string;
    value: number;
    date: string;
  }>;
  upcoming_sends: Array<{
    campaign_name: string;
    step_name: string;
    scheduled_count: number;
    scheduled_at: string;
  }>;
}
```

### COMPONENT IMPLEMENTATIONS

#### 1. Marketing Campaign Builder

```typescript
// src/components/marketing/CampaignBuilder.tsx
'use client';

import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Badge } from '@/components/ui/badge';
import { Switch } from '@/components/ui/switch';
import { 
  Plus, 
  Mail, 
  MessageSquare, 
  Clock, 
  Target, 
  Zap,
  Settings,
  Users,
  BarChart3,
  Calendar,
  Send,
  Save,
  Eye,
  Trash2,
  Copy,
  ArrowRight,
  Filter
} from 'lucide-react';
import { useToast } from '@/components/ui/use-toast';
import { cn } from '@/lib/utils';

interface CampaignBuilderProps {
  campaign?: MarketingCampaign;
  onSave: (campaign: CreateCampaignRequest) => Promise<void>;
  onCancel: () => void;
  className?: string;
}

export function CampaignBuilder({ campaign, onSave, onCancel, className }: CampaignBuilderProps) {
  const { toast } = useToast();
  const [formData, setFormData] = useState<CreateCampaignRequest>({
    campaign_name: '',
    campaign_type: 'email_sequence',
    campaign_description: '',
    target_audience: {},
    trigger_conditions: {
      trigger_type: 'immediate'
    },
    campaign_settings: {
      send_days: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'],
      send_times: ['09:00'],
      timezone: 'Europe/London',
      frequency_cap: 1,
      respect_unsubscribe: true,
      track_opens: true,
      track_clicks: true
    },
    goals: {},
    steps: []
  });

  const [currentTab, setCurrentTab] = useState('basics');
  const [loading, setLoading] = useState(false);

  // Initialize form with existing campaign data
  useEffect(() => {
    if (campaign) {
      setFormData({
        campaign_name: campaign.campaign_name,
        campaign_type: campaign.campaign_type,
        campaign_description: campaign.campaign_description || '',
        target_audience: campaign.target_audience,
        trigger_conditions: campaign.trigger_conditions,
        campaign_settings: campaign.campaign_settings,
        goals: campaign.goals,
        steps: [] // Would load existing steps
      });
    }
  }, [campaign]);

  const handleSave = async () => {
    setLoading(true);
    try {
      await onSave(formData);
      toast({
        title: "Campaign Saved",
        description: "Your marketing campaign has been saved successfully",
      });
    } catch (error) {
      toast({
        title: "Error",
        description: "Failed to save campaign",
        variant: "destructive",
      });
    } finally {
      setLoading(false);
    }
  };

  const addCampaignStep = () => {
    const newStep = {
      step_order: formData.steps.length + 1,
      step_name: `Step ${formData.steps.length + 1}`,
      step_type: 'email' as const,
      delay_config: {
        delay_type: 'fixed_delay' as const,
        delay_amount: 1,
        delay_unit: 'days' as const
      },
      content_config: {},
      personalization_rules: {
        merge_fields: {},
        conditional_content: [],
        smart_recommendations: true,
        location_based_content: false
      },
      delivery_settings: {},
      is_active: true
    };

    setFormData(prev => ({
      ...prev,
      steps: [...prev.steps, newStep]
    }));
  };

  const updateStep = (stepIndex: number, updates: Partial<CampaignStep>) => {
    setFormData(prev => ({
      ...prev,
      steps: prev.steps.map((step, index) => 
        index === stepIndex ? { ...step, ...updates } : step
      )
    }));
  };

  const removeStep = (stepIndex: number) => {
    setFormData(prev => ({
      ...prev,
      steps: prev.steps.filter((_, index) => index !== stepIndex)
    }));
  };

  return (
    <div className={cn("space-y-6", className)}>
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold">
            {campaign ? 'Edit Campaign' : 'Create New Campaign'}
          </h1>
          <p className="text-muted-foreground">
            Build automated marketing campaigns to nurture your wedding leads
          </p>
        </div>
        <div className="flex gap-2">
          <Button variant="outline" onClick={onCancel}>
            Cancel
          </Button>
          <Button onClick={handleSave} disabled={loading}>
            <Save className="h-4 w-4 mr-2" />
            {loading ? 'Saving...' : 'Save Campaign'}
          </Button>
        </div>
      </div>

      <Tabs value={currentTab} onValueChange={setCurrentTab}>
        <TabsList className="grid w-full grid-cols-5">
          <TabsTrigger value="basics">
            <Settings className="h-4 w-4 mr-2" />
            Basics
          </TabsTrigger>
          <TabsTrigger value="audience">
            <Users className="h-4 w-4 mr-2" />
            Audience
          </TabsTrigger>
          <TabsTrigger value="trigger">
            <Zap className="h-4 w-4 mr-2" />
            Trigger
          </TabsTrigger>
          <TabsTrigger value="steps">
            <ArrowRight className="h-4 w-4 mr-2" />
            Steps
          </TabsTrigger>
          <TabsTrigger value="settings">
            <BarChart3 className="h-4 w-4 mr-2" />
            Settings
          </TabsTrigger>
        </TabsList>

        <TabsContent value="basics" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle>Campaign Basics</CardTitle>
              <CardDescription>
                Define the core details of your marketing campaign
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="campaign_name">Campaign Name</Label>
                  <Input
                    id="campaign_name"
                    value={formData.campaign_name}
                    onChange={(e) => setFormData(prev => ({
                      ...prev,
                      campaign_name: e.target.value
                    }))}
                    placeholder="Welcome New Leads"
                  />
                </div>
                
                <div className="space-y-2">
                  <Label htmlFor="campaign_type">Campaign Type</Label>
                  <Select 
                    value={formData.campaign_type} 
                    onValueChange={(value) => setFormData(prev => ({
                      ...prev,
                      campaign_type: value as MarketingCampaign['campaign_type']
                    }))}
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="email_sequence">Email Sequence</SelectItem>
                      <SelectItem value="drip_campaign">Drip Campaign</SelectItem>
                      <SelectItem value="promotional">Promotional</SelectItem>
                      <SelectItem value="seasonal">Seasonal</SelectItem>
                      <SelectItem value="abandoned_inquiry">Abandoned Inquiry</SelectItem>
                      <SelectItem value="post_wedding">Post-Wedding</SelectItem>
                      <SelectItem value="referral_nurture">Referral Nurture</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>

              <div className="space-y-2">
                <Label htmlFor="campaign_description">Description</Label>
                <Textarea
                  id="campaign_description"
                  value={formData.campaign_description}
                  onChange={(e) => setFormData(prev => ({
                    ...prev,
                    campaign_description: e.target.value
                  }))}
                  placeholder="Describe what this campaign does and its goals..."
                  rows={3}
                />
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="audience" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Target className="h-5 w-5" />
                Target Audience
              </CardTitle>
              <CardDescription>
                Define who should receive this campaign
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>Wedding Types</Label>
                  <div className="flex flex-wrap gap-2">
                    {['Traditional', 'Modern', 'Rustic', 'Beach', 'Destination', 'Intimate'].map((type) => (
                      <Badge
                        key={type}
                        variant="outline"
                        className="cursor-pointer hover:bg-primary hover:text-primary-foreground"
                      >
                        {type}
                      </Badge>
                    ))}
                  </div>
                </div>

                <div className="space-y-2">
                  <Label>Budget Range (£)</Label>
                  <div className="grid grid-cols-2 gap-2">
                    <Input
                      placeholder="Min budget"
                      type="number"
                      value={formData.target_audience.budget_range?.min || ''}
                      onChange={(e) => setFormData(prev => ({
                        ...prev,
                        target_audience: {
                          ...prev.target_audience,
                          budget_range: {
                            ...prev.target_audience.budget_range,
                            min: parseInt(e.target.value) || 0,
                            max: prev.target_audience.budget_range?.max || 0
                          }
                        }
                      }))}
                    />
                    <Input
                      placeholder="Max budget"
                      type="number"
                      value={formData.target_audience.budget_range?.max || ''}
                      onChange={(e) => setFormData(prev => ({
                        ...prev,
                        target_audience: {
                          ...prev.target_audience,
                          budget_range: {
                            ...prev.target_audience.budget_range,
                            min: prev.target_audience.budget_range?.min || 0,
                            max: parseInt(e.target.value) || 0
                          }
                        }
                      }))}
                    />
                  </div>
                </div>

                <div className="space-y-2">
                  <Label>Lead Score Range</Label>
                  <div className="grid grid-cols-2 gap-2">
                    <Input
                      placeholder="Min score"
                      type="number"
                      value={formData.target_audience.lead_score_range?.min || ''}
                      onChange={(e) => setFormData(prev => ({
                        ...prev,
                        target_audience: {
                          ...prev.target_audience,
                          lead_score_range: {
                            ...prev.target_audience.lead_score_range,
                            min: parseInt(e.target.value) || 0,
                            max: prev.target_audience.lead_score_range?.max || 100
                          }
                        }
                      }))}
                    />
                    <Input
                      placeholder="Max score"
                      type="number"
                      value={formData.target_audience.lead_score_range?.max || ''}
                      onChange={(e) => setFormData(prev => ({
                        ...prev,
                        target_audience: {
                          ...prev.target_audience,
                          lead_score_range: {
                            ...prev.target_audience.lead_score_range,
                            min: prev.target_audience.lead_score_range?.min || 0,
                            max: parseInt(e.target.value) || 100
                          }
                        }
                      }))}
                    />
                  </div>
                </div>

                <div className="space-y-2">
                  <Label>Source Channels</Label>
                  <div className="flex flex-wrap gap-2">
                    {['Website', 'Social Media', 'Referral', 'Wedding Show', 'Google Ads', 'Facebook Ads'].map((source) => (
                      <Badge
                        key={source}
                        variant="outline"
                        className="cursor-pointer hover:bg-primary hover:text-primary-foreground"
                      >
                        {source}
                      </Badge>
                    ))}
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="trigger" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Zap className="h-5 w-5" />
                Campaign Trigger
              </CardTitle>
              <CardDescription>
                When should contacts enter this campaign?
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="space-y-2">
                <Label>Trigger Type</Label>
                <Select
                  value={formData.trigger_conditions.trigger_type}
                  onValueChange={(value) => setFormData(prev => ({
                    ...prev,
                    trigger_conditions: {
                      ...prev.trigger_conditions,
                      trigger_type: value as TriggerConditions['trigger_type']
                    }
                  }))}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="immediate">Immediate (Manual enrollment)</SelectItem>
                    <SelectItem value="delayed">Delayed start</SelectItem>
                    <SelectItem value="event_based">Event-based trigger</SelectItem>
                    <SelectItem value="date_based">Date-based trigger</SelectItem>
                    <SelectItem value="behavioral">Behavioral trigger</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              {formData.trigger_conditions.trigger_type === 'delayed' && (
                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label>Delay Amount</Label>
                    <Input
                      type="number"
                      value={formData.trigger_conditions.delay_amount || ''}
                      onChange={(e) => setFormData(prev => ({
                        ...prev,
                        trigger_conditions: {
                          ...prev.trigger_conditions,
                          delay_amount: parseInt(e.target.value) || 0
                        }
                      }))}
                    />
                  </div>
                  <div className="space-y-2">
                    <Label>Delay Unit</Label>
                    <Select
                      value={formData.trigger_conditions.delay_unit || 'days'}
                      onValueChange={(value) => setFormData(prev => ({
                        ...prev,
                        trigger_conditions: {
                          ...prev.trigger_conditions,
                          delay_unit: value as TriggerConditions['delay_unit']
                        }
                      }))}
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="minutes">Minutes</SelectItem>
                        <SelectItem value="hours">Hours</SelectItem>
                        <SelectItem value="days">Days</SelectItem>
                        <SelectItem value="weeks">Weeks</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                </div>
              )}

              {formData.trigger_conditions.trigger_type === 'event_based' && (
                <div className="space-y-2">
                  <Label>Trigger Events</Label>
                  <div className="flex flex-wrap gap-2">
                    {['Form Submission', 'Website Visit', 'Email Open', 'Email Click', 'Page View', 'Download'].map((event) => (
                      <Badge
                        key={event}
                        variant="outline"
                        className="cursor-pointer hover:bg-primary hover:text-primary-foreground"
                      >
                        {event}
                      </Badge>
                    ))}
                  </div>
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="steps" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <ArrowRight className="h-5 w-5" />
                  Campaign Steps
                </div>
                <Button onClick={addCampaignStep} size="sm">
                  <Plus className="h-4 w-4 mr-2" />
                  Add Step
                </Button>
              </CardTitle>
              <CardDescription>
                Define the sequence of messages and actions in your campaign
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              {formData.steps.length === 0 ? (
                <div className="text-center py-8 text-muted-foreground">
                  <Mail className="h-12 w-12 mx-auto mb-4 opacity-50" />
                  <p>No steps added yet. Click "Add Step" to get started.</p>
                </div>
              ) : (
                <div className="space-y-4">
                  {formData.steps.map((step, index) => (
                    <CampaignStepCard
                      key={index}
                      step={step}
                      stepIndex={index}
                      onUpdate={(updates) => updateStep(index, updates)}
                      onRemove={() => removeStep(index)}
                    />
                  ))}
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="settings" className="space-y-4">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <Card>
              <CardHeader>
                <CardTitle>Delivery Settings</CardTitle>
                <CardDescription>
                  Control when and how messages are sent
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="space-y-2">
                  <Label>Send Days</Label>
                  <div className="flex flex-wrap gap-2">
                    {['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].map((day) => (
                      <Badge
                        key={day}
                        variant={formData.campaign_settings.send_days.includes(day) ? 'default' : 'outline'}
                        className="cursor-pointer"
                        onClick={() => {
                          const newSendDays = formData.campaign_settings.send_days.includes(day)
                            ? formData.campaign_settings.send_days.filter(d => d !== day)
                            : [...formData.campaign_settings.send_days, day];
                          
                          setFormData(prev => ({
                            ...prev,
                            campaign_settings: {
                              ...prev.campaign_settings,
                              send_days: newSendDays
                            }
                          }));
                        }}
                      >
                        {day.charAt(0).toUpperCase() + day.slice(1, 3)}
                      </Badge>
                    ))}
                  </div>
                </div>

                <div className="space-y-2">
                  <Label>Send Times</Label>
                  <div className="grid grid-cols-2 gap-2">
                    {formData.campaign_settings.send_times.map((time, index) => (
                      <Input
                        key={index}
                        type="time"
                        value={time}
                        onChange={(e) => {
                          const newSendTimes = [...formData.campaign_settings.send_times];
                          newSendTimes[index] = e.target.value;
                          setFormData(prev => ({
                            ...prev,
                            campaign_settings: {
                              ...prev.campaign_settings,
                              send_times: newSendTimes
                            }
                          }));
                        }}
                      />
                    ))}
                  </div>
                </div>

                <div className="flex items-center justify-between">
                  <Label htmlFor="track_opens">Track Email Opens</Label>
                  <Switch
                    id="track_opens"
                    checked={formData.campaign_settings.track_opens}
                    onCheckedChange={(checked) => setFormData(prev => ({
                      ...prev,
                      campaign_settings: {
                        ...prev.campaign_settings,
                        track_opens: checked
                      }
                    }))}
                  />
                </div>

                <div className="flex items-center justify-between">
                  <Label htmlFor="track_clicks">Track Email Clicks</Label>
                  <Switch
                    id="track_clicks"
                    checked={formData.campaign_settings.track_clicks}
                    onCheckedChange={(checked) => setFormData(prev => ({
                      ...prev,
                      campaign_settings: {
                        ...prev.campaign_settings,
                        track_clicks: checked
                      }
                    }))}
                  />
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle>Campaign Goals</CardTitle>
                <CardDescription>
                  Set objectives and success metrics
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="space-y-2">
                  <Label>Primary Goal</Label>
                  <Select>
                    <SelectTrigger>
                      <SelectValue placeholder="Select primary goal" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="lead_generation">Lead Generation</SelectItem>
                      <SelectItem value="consultation_booking">Consultation Booking</SelectItem>
                      <SelectItem value="quote_request">Quote Request</SelectItem>
                      <SelectItem value="contract_signing">Contract Signing</SelectItem>
                      <SelectItem value="referral_generation">Referral Generation</SelectItem>
                      <SelectItem value="engagement">Engagement</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label>Target Open Rate (%)</Label>
                    <Input type="number" placeholder="25" />
                  </div>
                  <div className="space-y-2">
                    <Label>Target Click Rate (%)</Label>
                    <Input type="number" placeholder="5" />
                  </div>
                </div>

                <div className="space-y-2">
                  <Label>Target Conversions</Label>
                  <Input type="number" placeholder="10" />
                </div>
              </CardContent>
            </Card>
          </div>
        </TabsContent>
      </Tabs>
    </div>
  );
}

// Campaign Step Card Component
interface CampaignStepCardProps {
  step: Omit<CampaignStep, 'id' | 'campaign_id' | 'created_at' | 'updated_at'>;
  stepIndex: number;
  onUpdate: (updates: Partial<CampaignStep>) => void;
  onRemove: () => void;
}

function CampaignStepCard({ step, stepIndex, onUpdate, onRemove }: CampaignStepCardProps) {
  const [expanded, setExpanded] = useState(false);

  const getStepIcon = (type: string) => {
    switch (type) {
      case 'email':
        return <Mail className="h-4 w-4" />;
      case 'sms':
        return <MessageSquare className="h-4 w-4" />;
      case 'wait_delay':
        return <Clock className="h-4 w-4" />;
      default:
        return <Zap className="h-4 w-4" />;
    }
  };

  return (
    <Card className="relative">
      <CardHeader className="pb-3">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center">
              {getStepIcon(step.step_type)}
            </div>
            <div>
              <CardTitle className="text-sm">
                Step {stepIndex + 1}: {step.step_name}
              </CardTitle>
              <CardDescription className="text-xs">
                {step.step_type.replace('_', ' ')} • {step.delay_config.delay_amount || 0} {step.delay_config.delay_unit || 'days'} delay
              </CardDescription>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <Button
              variant="ghost"
              size="sm"
              onClick={() => setExpanded(!expanded)}
            >
              <Eye className="h-4 w-4" />
            </Button>
            <Button
              variant="ghost"
              size="sm"
              onClick={onRemove}
            >
              <Trash2 className="h-4 w-4" />
            </Button>
          </div>
        </div>
      </CardHeader>
      
      {expanded && (
        <CardContent className="pt-0 space-y-4">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label>Step Name</Label>
              <Input
                value={step.step_name}
                onChange={(e) => onUpdate({ step_name: e.target.value })}
                placeholder="Welcome Email"
              />
            </div>
            
            <div className="space-y-2">
              <Label>Step Type</Label>
              <Select
                value={step.step_type}
                onValueChange={(value) => onUpdate({ 
                  step_type: value as CampaignStep['step_type'] 
                })}
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="email">Email</SelectItem>
                  <SelectItem value="sms">SMS</SelectItem>
                  <SelectItem value="wait_delay">Wait/Delay</SelectItem>
                  <SelectItem value="condition_split">Condition Split</SelectItem>
                  <SelectItem value="tag_action">Tag Action</SelectItem>
                </SelectContent>
              </Select>
            </div>

            {step.step_type !== 'wait_delay' && (
              <div className="md:col-span-2 space-y-2">
                <Label>Email Subject Line</Label>
                <Input
                  value={step.content_config.subject_line || ''}
                  onChange={(e) => onUpdate({
                    content_config: {
                      ...step.content_config,
                      subject_line: e.target.value
                    }
                  })}
                  placeholder="Welcome to our wedding photography family!"
                />
              </div>
            )}
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label>Delay Amount</Label>
              <Input
                type="number"
                value={step.delay_config.delay_amount || ''}
                onChange={(e) => onUpdate({
                  delay_config: {
                    ...step.delay_config,
                    delay_amount: parseInt(e.target.value) || 0
                  }
                })}
              />
            </div>
            <div className="space-y-2">
              <Label>Delay Unit</Label>
              <Select
                value={step.delay_config.delay_unit || 'days'}
                onValueChange={(value) => onUpdate({
                  delay_config: {
                    ...step.delay_config,
                    delay_unit: value as DelayConfig['delay_unit']
                  }
                })}
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="minutes">Minutes</SelectItem>
                  <SelectItem value="hours">Hours</SelectItem>
                  <SelectItem value="days">Days</SelectItem>
                  <SelectItem value="weeks">Weeks</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>
        </CardContent>
      )}
    </Card>
  );
}
```

#### 2. Marketing Automation Service

```typescript
// src/lib/services/marketing-automation.service.ts
import { supabase } from '@/lib/supabase';
import { addDays, addHours, addMinutes, addWeeks, isAfter, isBefore, format } from 'date-fns';

export class MarketingAutomationService {
  // Create a new marketing campaign
  static async createCampaign(request: CreateCampaignRequest, supplierId: string): Promise<CreateCampaignResponse> {
    try {
      // Create campaign record
      const { data: campaign, error: campaignError } = await supabase
        .from('marketing_campaigns')
        .insert({
          supplier_id: supplierId,
          campaign_name: request.campaign_name,
          campaign_type: request.campaign_type,
          campaign_description: request.campaign_description,
          target_audience: request.target_audience,
          trigger_conditions: request.trigger_conditions,
          campaign_settings: request.campaign_settings,
          goals: request.goals
        })
        .select()
        .single();
        
      if (campaignError) throw campaignError;

      // Create campaign steps
      const stepsToInsert = request.steps.map((step, index) => ({
        campaign_id: campaign.id,
        step_order: index + 1,
        ...step
      }));

      const { data: campaignSteps, error: stepsError } = await supabase
        .from('campaign_steps')
        .insert(stepsToInsert)
        .select();
        
      if (stepsError) throw stepsError;

      return {
        success: true,
        data: campaign,
        campaign_steps: campaignSteps
      };
    } catch (error) {
      console.error('Error creating campaign:', error);
      return {
        success: false,
        data: null as any,
        campaign_steps: [],
        message: error instanceof Error ? error.message : 'Failed to create campaign'
      };
    }
  }

  // Enroll contacts into a campaign
  static async enrollContacts(request: EnrollContactRequest): Promise<EnrollContactResponse> {
    try {
      const enrolledContacts: string[] = [];
      const failedEnrollments: Array<{ contact_id: string; reason: string }> = [];

      for (const contactId of request.contact_ids) {
        try {
          // Check if contact is already enrolled
          const { data: existingEnrollment } = await supabase
            .from('campaign_enrollments')
            .select('id')
            .eq('campaign_id', request.campaign_id)
            .eq('contact_id', contactId)
            .single();

          if (existingEnrollment) {
            failedEnrollments.push({
              contact_id: contactId,
              reason: 'Already enrolled in this campaign'
            });
            continue;
          }

          // Calculate next action time
          const nextActionAt = request.start_immediately 
            ? new Date()
            : this.calculateNextActionTime(new Date(), { delay_type: 'fixed_delay', delay_amount: 0, delay_unit: 'minutes' });

          // Create enrollment
          const { error: enrollmentError } = await supabase
            .from('campaign_enrollments')
            .insert({
              campaign_id: request.campaign_id,
              contact_id: contactId,
              enrollment_source: request.enrollment_source,
              enrollment_status: 'active',
              current_step: 1,
              next_action_at: nextActionAt,
              enrollment_data: request.enrollment_data || {}
            });

          if (enrollmentError) throw enrollmentError;

          enrolledContacts.push(contactId);

          // If starting immediately, schedule first step
          if (request.start_immediately) {
            await this.scheduleNextCampaignStep(request.campaign_id, contactId);
          }

        } catch (error) {
          failedEnrollments.push({
            contact_id: contactId,
            reason: error instanceof Error ? error.message : 'Enrollment failed'
          });
        }
      }

      return {
        success: true,
        enrolled_count: enrolledContacts.length,
        failed_enrollments: failedEnrollments
      };
    } catch (error) {
      console.error('Error enrolling contacts:', error);
      return {
        success: false,
        enrolled_count: 0,
        failed_enrollments: request.contact_ids.map(id => ({
          contact_id: id,
          reason: 'System error during enrollment'
        })),
        message: error instanceof Error ? error.message : 'Failed to enroll contacts'
      };
    }
  }

  // Process lead scoring
  static async updateLeadScore(request: LeadScoringRequest): Promise<LeadScoringResponse> {
    try {
      // Get current lead score
      const { data: currentScore } = await supabase
        .from('lead_scores')
        .select('*')
        .eq('contact_id', request.contact_id)
        .single();

      let previousScore = currentScore?.current_score || 0;
      let newScore = previousScore;

      // Calculate score changes from events
      const scoringRules = await this.getLeadScoringRules();
      
      for (const event of request.scoring_events) {
        const rule = scoringRules.find(r => r.event_type === event.event_type);
        if (rule) {
          newScore += rule.score_change;
        }
      }

      // Ensure score stays within bounds (0-100)
      newScore = Math.max(0, Math.min(100, newScore));

      // Update lead score record
      const scoreData = {
        contact_id: request.contact_id,
        current_score: newScore,
        last_activity_date: new Date().toISOString(),
        score_history: [
          ...(currentScore?.score_history || []),
          ...request.scoring_events.map(event => ({
            date: event.timestamp,
            score_change: scoringRules.find(r => r.event_type === event.event_type)?.score_change || 0,
            reason: event.event_type,
            source: 'automation'
          }))
        ]
      };

      // Determine qualification status
      let qualificationStatus = this.determineQualificationStatus(newScore);
      
      if (currentScore) {
        await supabase
          .from('lead_scores')
          .update({
            ...scoreData,
            qualification_status: qualificationStatus,
            updated_at: new Date().toISOString()
          })
          .eq('id', currentScore.id);
      } else {
        await supabase
          .from('lead_scores')
          .insert({
            ...scoreData,
            supplier_id: 'current-supplier-id', // Would get from context
            qualification_status: qualificationStatus
          });
      }

      return {
        success: true,
        data: {
          previous_score: previousScore,
          new_score: newScore,
          score_change: newScore - previousScore,
          qualification_status: qualificationStatus,
          scoring_breakdown: {
            demographic: 0, // Would calculate from events
            behavioral: 0,
            engagement: 0,
            fit: 0
          }
        }
      };
    } catch (error) {
      console.error('Error updating lead score:', error);
      return {
        success: false,
        data: {
          previous_score: 0,
          new_score: 0,
          score_change: 0,
          qualification_status: 'cold',
          scoring_breakdown: {
            demographic: 0,
            behavioral: 0,
            engagement: 0,
            fit: 0
          }
        },
        message: error instanceof Error ? error.message : 'Failed to update lead score'
      };
    }
  }

  // Get campaign performance metrics
  static async getCampaignPerformance(request: CampaignPerformanceRequest): Promise<CampaignPerformanceResponse> {
    try {
      // Get campaign details
      const { data: campaign } = await supabase
        .from('marketing_campaigns')
        .select('*')
        .eq('id', request.campaign_id)
        .single();

      if (!campaign) {
        throw new Error('Campaign not found');
      }

      // Get performance metrics
      const { data: analytics } = await supabase
        .from('marketing_analytics')
        .select('*')
        .eq('campaign_id', request.campaign_id)
        .gte('analytics_date', request.date_range.start_date)
        .lte('analytics_date', request.date_range.end_date);

      // Aggregate metrics
      const performanceMetrics = analytics?.reduce((acc, day) => ({
        total_sends: acc.total_sends + day.emails_sent,
        total_opens: acc.total_opens + day.emails_opened,
        total_clicks: acc.total_clicks + day.emails_clicked,
        total_conversions: acc.total_conversions + day.bookings_made,
        revenue_attributed: acc.revenue_attributed + parseFloat(day.revenue_attributed.toString()),
        campaign_spend: acc.campaign_spend + parseFloat(day.campaign_spend.toString())
      }), {
        total_sends: 0,
        total_opens: 0,
        total_clicks: 0,
        total_conversions: 0,
        revenue_attributed: 0,
        campaign_spend: 0
      }) || {
        total_sends: 0,
        total_opens: 0,
        total_clicks: 0,
        total_conversions: 0,
        revenue_attributed: 0,
        campaign_spend: 0
      };

      // Calculate rates
      const deliveryRate = performanceMetrics.total_sends > 0 ? 100 : 0; // Would calculate from delivery data
      const openRate = performanceMetrics.total_sends > 0 
        ? (performanceMetrics.total_opens / performanceMetrics.total_sends) * 100 
        : 0;
      const clickRate = performanceMetrics.total_opens > 0 
        ? (performanceMetrics.total_clicks / performanceMetrics.total_opens) * 100 
        : 0;
      const conversionRate = performanceMetrics.total_sends > 0 
        ? (performanceMetrics.total_conversions / performanceMetrics.total_sends) * 100 
        : 0;
      const roi = performanceMetrics.campaign_spend > 0 
        ? ((performanceMetrics.revenue_attributed - performanceMetrics.campaign_spend) / performanceMetrics.campaign_spend) * 100 
        : 0;

      // Get enrollment counts
      const { count: totalEnrollments } = await supabase
        .from('campaign_enrollments')
        .select('id', { count: 'exact' })
        .eq('campaign_id', request.campaign_id);

      const { count: activeEnrollments } = await supabase
        .from('campaign_enrollments')
        .select('id', { count: 'exact' })
        .eq('campaign_id', request.campaign_id)
        .eq('enrollment_status', 'active');

      const { count: completedEnrollments } = await supabase
        .from('campaign_enrollments')
        .select('id', { count: 'exact' })
        .eq('campaign_id', request.campaign_id)
        .eq('enrollment_status', 'completed');

      return {
        success: true,
        data: {
          campaign,
          performance_metrics: {
            total_enrollments: totalEnrollments || 0,
            active_enrollments: activeEnrollments || 0,
            completed_enrollments: completedEnrollments || 0,
            total_sends: performanceMetrics.total_sends,
            delivery_rate: deliveryRate,
            open_rate: openRate,
            click_rate: clickRate,
            unsubscribe_rate: 0, // Would calculate from unsubscribe data
            conversion_rate: conversionRate,
            revenue_attributed: performanceMetrics.revenue_attributed,
            cost_per_conversion: performanceMetrics.total_conversions > 0 
              ? performanceMetrics.campaign_spend / performanceMetrics.total_conversions 
              : 0,
            roi: roi
          },
          step_performance: [], // Would get from campaign_deliveries
          timeline_data: analytics?.map(day => ({
            date: day.analytics_date.toString(),
            sends: day.emails_sent,
            opens: day.emails_opened,
            clicks: day.emails_clicked,
            conversions: day.bookings_made
          })) || []
        }
      };
    } catch (error) {
      console.error('Error getting campaign performance:', error);
      return {
        success: false,
        data: null as any,
        message: error instanceof Error ? error.message : 'Failed to get campaign performance'
      };
    }
  }

  // Process automation campaigns (background job)
  static async processAutomationCampaigns(): Promise<void> {
    try {
      // Get all pending campaign deliveries
      const { data: pendingDeliveries } = await supabase
        .from('campaign_deliveries')
        .select(`
          *,
          campaign_enrollments (
            campaign_id,
            contact_id,
            enrollment_data
          ),
          campaign_steps (
            step_type,
            content_config,
            delivery_settings
          )
        `)
        .eq('delivery_status', 'pending')
        .lte('scheduled_at', new Date().toISOString())
        .limit(100);

      if (!pendingDeliveries?.length) return;

      // Process each delivery
      for (const delivery of pendingDeliveries) {
        try {
          await this.processCampaignDelivery(delivery);
        } catch (error) {
          console.error(`Error processing delivery ${delivery.id}:`, error);
          
          // Mark delivery as failed
          await supabase
            .from('campaign_deliveries')
            .update({
              delivery_status: 'failed',
              error_message: error instanceof Error ? error.message : 'Processing failed'
            })
            .eq('id', delivery.id);
        }
      }
    } catch (error) {
      console.error('Error processing automation campaigns:', error);
    }
  }

  // Private helper methods
  private static calculateNextActionTime(fromDate: Date, delayConfig: DelayConfig): Date {
    switch (delayConfig.delay_unit) {
      case 'minutes':
        return addMinutes(fromDate, delayConfig.delay_amount || 0);
      case 'hours':
        return addHours(fromDate, delayConfig.delay_amount || 0);
      case 'days':
        return addDays(fromDate, delayConfig.delay_amount || 0);
      case 'weeks':
        return addWeeks(fromDate, delayConfig.delay_amount || 0);
      default:
        return fromDate;
    }
  }

  private static async scheduleNextCampaignStep(campaignId: string, contactId: string): Promise<void> {
    // Get enrollment and next step
    const { data: enrollment } = await supabase
      .from('campaign_enrollments')
      .select(`
        *,
        campaign_steps!campaign_steps_campaign_id_fkey (*)
      `)
      .eq('campaign_id', campaignId)
      .eq('contact_id', contactId)
      .single();

    if (!enrollment) return;

    // Find next step
    const nextStep = enrollment.campaign_steps?.find(
      (step: any) => step.step_order === enrollment.current_step
    );

    if (!nextStep) {
      // Mark enrollment as completed
      await supabase
        .from('campaign_enrollments')
        .update({
          enrollment_status: 'completed',
          completed_at: new Date().toISOString()
        })
        .eq('id', enrollment.id);
      return;
    }

    // Schedule delivery
    const scheduledAt = this.calculateNextActionTime(new Date(), nextStep.delay_config);

    await supabase
      .from('campaign_deliveries')
      .insert({
        enrollment_id: enrollment.id,
        campaign_step_id: nextStep.id,
        contact_id: contactId,
        delivery_method: nextStep.step_type,
        delivery_status: 'pending',
        scheduled_at: scheduledAt
      });
  }

  private static async processCampaignDelivery(delivery: any): Promise<void> {
    // Mark as sent
    await supabase
      .from('campaign_deliveries')
      .update({
        delivery_status: 'sent',
        sent_at: new Date().toISOString()
      })
      .eq('id', delivery.id);

    // Send the actual message (email, SMS, etc.)
    // Implementation would depend on your email/SMS service

    // Update enrollment to next step
    await supabase
      .from('campaign_enrollments')
      .update({
        current_step: delivery.campaign_enrollments.current_step + 1,
        last_action_at: new Date().toISOString()
      })
      .eq('id', delivery.enrollment_id);

    // Schedule next step if exists
    await this.scheduleNextCampaignStep(
      delivery.campaign_enrollments.campaign_id,
      delivery.contact_id
    );
  }

  private static async getLeadScoringRules() {
    // This would be configurable per supplier
    return [
      { event_type: 'email_open', score_change: 2 },
      { event_type: 'email_click', score_change: 5 },
      { event_type: 'website_visit', score_change: 3 },
      { event_type: 'form_submission', score_change: 10 },
      { event_type: 'consultation_booking', score_change: 25 },
      { event_type: 'quote_request', score_change: 20 },
      { event_type: 'social_interaction', score_change: 1 }
    ];
  }

  private static determineQualificationStatus(score: number): string {
    if (score >= 80) return 'sales_qualified';
    if (score >= 60) return 'marketing_qualified';
    if (score >= 40) return 'hot';
    if (score >= 20) return 'warm';
    return 'cold';
  }
}
```

### ACCEPTANCE CRITERIA

- [ ] **Campaign Management**
  - [ ] Create, edit, and delete marketing campaigns
  - [ ] Multiple campaign types (email sequence, drip, promotional, seasonal)
  - [ ] Campaign templates and cloning functionality
  - [ ] A/B testing for subject lines and content
  - [ ] Campaign scheduling and automation

- [ ] **Audience Segmentation**
  - [ ] Dynamic and static contact segments
  - [ ] Behavioral segmentation based on engagement
  - [ ] Demographic and geographic targeting
  - [ ] Lead score-based segmentation
  - [ ] Wedding type and budget-based segments

- [ ] **Email Marketing**
  - [ ] Drag-and-drop email template builder
  - [ ] Mobile-responsive email templates
  - [ ] Personalization and dynamic content
  - [ ] Email deliverability optimization
  - [ ] Unsubscribe management and compliance

- [ ] **Marketing Automation Workflows**
  - [ ] Visual workflow builder with drag-and-drop interface
  - [ ] Multiple trigger types (event-based, time-based, behavioral)
  - [ ] Conditional logic and branching
  - [ ] Multi-channel campaigns (email, SMS, push notifications)
  - [ ] Automated follow-up sequences

- [ ] **Lead Scoring System**
  - [ ] Configurable scoring rules and point values
  - [ ] Behavioral, demographic, and engagement scoring
  - [ ] Automatic qualification status updates
  - [ ] Score history tracking and analytics
  - [ ] Integration with CRM and sales processes

- [ ] **Analytics & Reporting**
  - [ ] Real-time campaign performance metrics
  - [ ] Open, click, and conversion tracking
  - [ ] Revenue attribution and ROI calculation
  - [ ] A/B test results and statistical significance
  - [ ] Funnel analysis and conversion paths

- [ ] **Contact Management**
  - [ ] Contact import from CSV and integrations
  - [ ] Contact lifecycle management
  - [ ] Engagement tracking and activity history
  - [ ] Contact preferences and communication settings
  - [ ] GDPR compliance and data management

- [ ] **Template Library**
  - [ ] Pre-built email templates for wedding industry
  - [ ] Seasonal and promotional template collections
  - [ ] Custom template creation and sharing
  - [ ] Template performance analytics
  - [ ] Brand customization and consistency

- [ ] **Deliverability & Compliance**
  - [ ] Email authentication (SPF, DKIM, DMARC)
  - [ ] Reputation monitoring and management
  - [ ] Bounce and complaint handling
  - [ ] CAN-SPAM and GDPR compliance
  - [ ] Suppression list management

- [ ] **Integration Capabilities**
  - [ ] CRM system integration for lead sync
  - [ ] Website tracking and behavior monitoring
  - [ ] Social media integration for enhanced targeting
  - [ ] Zapier integration for third-party connections
  - [ ] API access for custom integrations

- [ ] **Mobile Optimization**
  - [ ] Mobile-responsive campaign builder interface
  - [ ] Mobile-optimized email templates
  - [ ] Touch-friendly workflow builder
  - [ ] Mobile analytics and reporting
  - [ ] Push notification campaigns

- [ ] **Performance & Scalability**
  - [ ] High-volume email sending capability
  - [ ] Real-time campaign processing
  - [ ] Automated failover and retry logic
  - [ ] Database optimization for large contact lists
  - [ ] CDN delivery for email assets

### DEPENDENCIES
- Must complete after: Contact management system, Email service integration (Resend), SMS service (Twilio)
- Must complete before: Advanced analytics dashboard, Sales automation system
- Shares code with: CRM system, Lead management, Email templates, Analytics platform

### ESTIMATED EFFORT
- **Team A Frontend**: 40 hours
  - Campaign builder interface (20h)
  - Workflow designer (12h)
  - Analytics dashboard (8h)

- **Team B Backend**: 36 hours
  - Database schema and migrations (8h)
  - Campaign processing engine (16h)
  - API endpoints and services (12h)

- **Team C Integration**: 20 hours
  - Email service integration (8h)
  - CRM system integration (6h)
  - Analytics platform integration (6h)

- **Team D Platform**: 16 hours
  - Lead scoring engine (8h)
  - Automation processing (6h)
  - Performance optimization (2h)

- **Team E Testing**: 12 hours
  - End-to-end campaign testing (6h)
  - Performance testing (3h)
  - Deliverability testing (3h)

**Total Estimated Effort**: 124 hours

### BUSINESS IMPACT
**Expected Results:**
- **Lead Conversion**: Increase lead-to-customer conversion by 45-65%
- **Time Savings**: Reduce manual marketing work by 75%
- **Revenue Growth**: Generate 30-40% more bookings through automated nurturing
- **Customer Lifetime Value**: Increase CLV by 25% through better engagement
- **Marketing ROI**: Achieve 4:1 ROI on marketing automation investment

This marketing automation system transforms how wedding suppliers nurture leads and engage with potential clients, providing sophisticated yet easy-to-use tools that drive measurable business growth while saving significant time and effort.