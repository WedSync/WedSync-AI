# TECHNICAL SPECIFICATION: WS-277 - Print Formats Generation
## Generated by Feature Development Session - 2025-01-20

### USER STORY & BUSINESS CONTEXT (FACTUAL)
**As a:** Wedding coordinator/planner managing wedding day logistics
**I want to:** Generate professional PDF timelines and task lists for print distribution
**So that:** Vendors have physical copies during wedding day when venues have poor Wi-Fi or for offline reference

**Real Wedding Scenario:**
Wedding coordinators currently copy-paste timeline information into Word documents and manually format them for printing. During the wedding day, vendors like photographers and caterers need physical copies because venue Wi-Fi is unreliable. With this feature, coordinators can generate professional PDFs with one click, ensuring all vendors have consistent, readable schedules.

### SPECIFICATION SOURCE
- **Feature ID:** WS-277
- **Original Spec:** Wedding coordination and vendor communication requirements
- **Current Implementation:** 0% complete
- **Files to Modify:** 
  - `/src/components/timeline/TimelineManager.tsx`
  - `/src/app/api/timeline/[id]/export/route.ts`
- **New Files to Create:**
  - `/src/lib/pdf/timeline-generator.ts`
  - `/src/components/timeline/PrintFormatModal.tsx`
  - `/src/app/api/pdf/timeline/route.ts`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Add print format preferences to existing timeline table
ALTER TABLE timelines ADD COLUMN print_settings JSONB DEFAULT '{
  "format": "standard",
  "include_contact_info": true,
  "include_notes": true,
  "font_size": "medium",
  "page_orientation": "portrait"
}'::jsonb;

-- Track generated print exports
CREATE TABLE IF NOT EXISTS timeline_exports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  timeline_id UUID REFERENCES timelines(id) ON DELETE CASCADE,
  exported_by UUID REFERENCES auth.users(id),
  export_format TEXT NOT NULL CHECK (export_format IN ('pdf', 'print-html')),
  settings JSONB DEFAULT '{}',
  file_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### API Endpoints Required
```typescript
// POST /api/timeline/[id]/export
interface ExportTimelineRequest {
  timelineId: string;
  format: 'pdf' | 'print-html';
  settings: {
    includeContactInfo: boolean;
    includeNotes: boolean;
    fontSize: 'small' | 'medium' | 'large';
    orientation: 'portrait' | 'landscape';
  };
}

interface ExportTimelineResponse {
  success: boolean;
  data: {
    downloadUrl: string;
    expiresAt: string;
    fileSize: number;
  };
}

// GET /api/timeline/[id]/exports - List previous exports
interface TimelineExportsResponse {
  exports: {
    id: string;
    format: string;
    createdAt: string;
    downloadUrl: string;
    settings: object;
  }[];
}
```

#### Frontend Components Required
```typescript
// Component: PrintFormatModal
// Location: /src/components/timeline/PrintFormatModal.tsx

interface PrintFormatModalProps {
  timelineId: string;
  isOpen: boolean;
  onClose: () => void;
  onExportComplete: (url: string) => void;
}

// Key functionality:
- Format selection (PDF/HTML print view)
- Print settings configuration
- Real-time preview generation
- Download link management
- Export history display

// Component: TimelinePrintView  
// Location: /src/components/timeline/TimelinePrintView.tsx
interface TimelinePrintViewProps {
  timeline: Timeline;
  settings: PrintSettings;
  previewMode?: boolean;
}

// Key functionality:
- Clean print-optimized layout
- Vendor contact information blocks
- Time-based task organization
- Page break optimization
```

#### Integration Points
```typescript
// Service: TimelinePDFGenerator
// Dependencies: jsPDF, html2canvas, timeline data service

class TimelinePDFGenerator {
  async generatePDF(timelineId: string, settings: PrintSettings) {
    // 1. Fetch timeline data with vendor details
    // 2. Generate HTML template with print styles
    // 3. Convert to PDF with proper page breaks
    // 4. Upload to secure storage (Supabase Storage)
    // 5. Return signed download URL
  }
  
  async generatePrintHTML(timelineId: string, settings: PrintSettings) {
    // Generate printer-friendly HTML version
    // Optimized for direct browser printing
  }
}
```

### CODE EXAMPLES

#### Example 1: PDF Generation Service
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import jsPDF from 'jspdf';
import html2canvas from 'html2canvas';
import { createClient } from '@supabase/supabase-js';

export class TimelinePDFGenerator {
  private supabase = createClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.SUPABASE_SERVICE_ROLE_KEY!);

  async generateTimelinePDF(timelineId: string, settings: PrintSettings): Promise<string> {
    // Step 1: Fetch timeline with vendor details
    const { data: timeline, error } = await this.supabase
      .from('timelines')
      .select(`
        *,
        timeline_items(*),
        vendors(name, contact_phone, contact_email)
      `)
      .eq('id', timelineId)
      .single();
      
    if (error) throw new Error(`Timeline not found: ${error.message}`);
    
    // Step 2: Generate HTML template
    const htmlContent = this.generateTimelineHTML(timeline, settings);
    
    // Step 3: Convert to PDF
    const pdf = new jsPDF(settings.orientation === 'landscape' ? 'l' : 'p', 'mm', 'a4');
    
    // Add content with proper formatting
    pdf.html(htmlContent, {
      callback: async (doc) => {
        const pdfBlob = doc.output('blob');
        const fileName = `timeline-${timelineId}-${Date.now()}.pdf`;
        
        // Step 4: Upload to Supabase Storage
        const { data: uploadData, error: uploadError } = await this.supabase.storage
          .from('timeline-exports')
          .upload(fileName, pdfBlob, {
            contentType: 'application/pdf',
            cacheControl: '3600'
          });
          
        if (uploadError) throw uploadError;
        
        // Step 5: Get signed URL
        const { data: urlData } = await this.supabase.storage
          .from('timeline-exports')
          .createSignedUrl(fileName, 60 * 60 * 24); // 24 hours
          
        return urlData?.signedUrl || '';
      }
    });
  }

  private generateTimelineHTML(timeline: Timeline, settings: PrintSettings): string {
    return `
      <div class="timeline-print" style="font-family: Arial, sans-serif; font-size: ${settings.fontSize === 'large' ? '14px' : '12px'};">
        <h1>${timeline.wedding_date} - ${timeline.couple_names}</h1>
        <div class="timeline-items">
          ${timeline.timeline_items.map(item => `
            <div class="timeline-item" style="margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
              <div style="font-weight: bold;">${item.start_time} - ${item.title}</div>
              <div style="color: #666; font-size: 11px;">Vendor: ${item.vendor_name}</div>
              ${settings.includeContactInfo ? `<div style="font-size: 10px;">Contact: ${item.vendor_phone}</div>` : ''}
              ${settings.includeNotes && item.notes ? `<div style="font-size: 10px; font-style: italic;">${item.notes}</div>` : ''}
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }
}
```

#### Example 2: Print Format Modal Component
```typescript
'use client';
import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';
import { Checkbox } from '@/components/ui/checkbox';

interface PrintFormatModalProps {
  timelineId: string;
  isOpen: boolean;
  onClose: () => void;
  onExportComplete: (url: string) => void;
}

export function PrintFormatModal({ timelineId, isOpen, onClose, onExportComplete }: PrintFormatModalProps) {
  const [settings, setSettings] = useState({
    format: 'pdf' as 'pdf' | 'print-html',
    includeContactInfo: true,
    includeNotes: true,
    fontSize: 'medium' as 'small' | 'medium' | 'large',
    orientation: 'portrait' as 'portrait' | 'landscape'
  });
  const [isGenerating, setIsGenerating] = useState(false);

  const handleExport = async () => {
    setIsGenerating(true);
    try {
      const response = await fetch(`/api/timeline/${timelineId}/export`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ format: settings.format, settings })
      });
      
      const result = await response.json();
      if (result.success) {
        onExportComplete(result.data.downloadUrl);
        onClose();
      }
    } catch (error) {
      console.error('Export failed:', error);
    } finally {
      setIsGenerating(false);
    }
  };

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <DialogTitle>Export Timeline for Print</DialogTitle>
        </DialogHeader>
        
        <div className="space-y-4">
          <div>
            <label className="text-sm font-medium">Format</label>
            <RadioGroup value={settings.format} onValueChange={(value) => setSettings(s => ({ ...s, format: value as any }))}>
              <div className="flex items-center space-x-2">
                <RadioGroupItem value="pdf" id="pdf" />
                <label htmlFor="pdf">PDF Download</label>
              </div>
              <div className="flex items-center space-x-2">
                <RadioGroupItem value="print-html" id="print-html" />
                <label htmlFor="print-html">Print-Friendly Web Page</label>
              </div>
            </RadioGroup>
          </div>

          <div className="space-y-2">
            <label className="text-sm font-medium">Include Information</label>
            <div className="space-y-2">
              <div className="flex items-center space-x-2">
                <Checkbox 
                  id="contact-info"
                  checked={settings.includeContactInfo}
                  onCheckedChange={(checked) => setSettings(s => ({ ...s, includeContactInfo: !!checked }))}
                />
                <label htmlFor="contact-info">Vendor Contact Information</label>
              </div>
              <div className="flex items-center space-x-2">
                <Checkbox 
                  id="notes"
                  checked={settings.includeNotes}
                  onCheckedChange={(checked) => setSettings(s => ({ ...s, includeNotes: !!checked }))}
                />
                <label htmlFor="notes">Task Notes and Details</label>
              </div>
            </div>
          </div>

          <div className="flex justify-between">
            <Button variant="outline" onClick={onClose}>Cancel</Button>
            <Button onClick={handleExport} disabled={isGenerating}>
              {isGenerating ? 'Generating...' : 'Export'}
            </Button>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Ref MCP: Search docs for jsPDF, html2canvas libraries
- [x] Supabase MCP: Database operations and storage
- [x] Browser MCP: Interactive testing of print layouts
- [x] Filesystem: Access timeline templates and styling

#### Ref MCP Searches Needed
```bash
# Use Ref MCP to search for:
# - "jsPDF Next.js integration"
# - "html2canvas PDF generation"
# - "Supabase Storage file upload"
# - "PDF generation best practices"
```

#### Browser MCP Interactive Testing
```bash
# Use Browser MCP for:
# - Testing print layout rendering
# - Verifying PDF download functionality  
# - Screenshot capture of print previews
# - Testing responsive print styles
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('TimelinePDFGenerator', () => {
  it('should generate PDF with correct timeline data', async () => {
    const generator = new TimelinePDFGenerator();
    const url = await generator.generateTimelinePDF('test-id', mockSettings);
    expect(url).toContain('timeline-exports');
  });
  
  it('should include vendor contact info when enabled', () => {
    // Test contact info inclusion logic
  });
  
  it('should exclude notes when disabled in settings', () => {
    // Test conditional note inclusion
  });
});
```

#### E2E Tests Required
```typescript
test('Export timeline to PDF', async () => {
  await mcp__playwright__browser_navigate({url: '/timeline/test-timeline'});
  await mcp__playwright__browser_click({element: 'Export button', ref: '[data-testid="export-timeline"]'});
  await mcp__playwright__browser_click({element: 'PDF format', ref: '[value="pdf"]'});
  await mcp__playwright__browser_click({element: 'Export button', ref: '[data-testid="confirm-export"]'});
  
  // Verify download link appears
  const downloadLink = await page.waitForSelector('[data-testid="download-link"]');
  expect(downloadLink).toBeTruthy();
});
```

### ACCEPTANCE CRITERIA
- [x] Users can export timeline as PDF with one click
- [x] PDF includes all timeline items with proper formatting
- [x] Contact information inclusion is configurable
- [x] Font size and orientation are selectable
- [x] Generated files are stored securely with expiration
- [x] Export history is maintained for users
- [x] Print-friendly HTML version available for direct printing
- [x] Mobile-responsive export interface
- [x] **Navigation Integration: Export feature accessible from timeline dashboard**
  - [x] Export button prominently displayed in timeline header
  - [x] Print format options accessible via dropdown/modal
  - [x] Export history accessible from timeline settings
  - [x] Mobile-friendly export controls tested
  - [x] Keyboard navigation support for accessibility

### DEPENDENCIES
- Must complete after: Timeline Management System (WS-160)
- Must complete before: Communication Threads (WS-278)
- Shares code with: Timeline dashboard and vendor management

### ESTIMATED EFFORT
- Team A Frontend: 16 hours (Modal, UI components, print styles)
- Team B Backend: 20 hours (PDF generation, API endpoints, file storage)
- Team C Integration: 8 hours (Supabase Storage integration)
- Team D Platform: 4 hours (Export tracking and cleanup)
- Team E General: 8 hours (Testing and documentation)
- Team F Workflows: 4 hours (User flow optimization)
- Team G Performance: 6 hours (PDF generation optimization)
- Total: 66 hours