# TECHNICAL SPECIFICATION: WS-132 - Trial Management System
## Generated by Feature Development Session - 2025-01-23

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding supplier evaluating WedSync Professional features
**I want to:** Experience the full platform capabilities for 30 days without payment commitment
**So that:** I can validate ROI before making a financial commitment and see measurable business impact

**Real Business Scenario:**
A wedding photographer signs up for a free trial after seeing competitor success stories. During the 30-day trial, they connect 8 couples, automate their client intake process, and save 12 hours per week on administrative tasks. On day 25, they receive personalized trial results showing $2,400 in time savings value. They upgrade to Professional before trial expiration, increasing annual revenue by $18,000 while working fewer hours.

### SPECIFICATION SOURCE
- **Feature ID:** WS-132
- **Original Spec:** /CORE-SPECIFICATIONS/13-BUSINESS-OPERATIONS/02-trial-management md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** None (new feature)
- **New Files to Create:**
  - /src/lib/trial/trial-manager.ts
  - /src/lib/trial/trial-analytics.ts
  - /src/lib/trial/trial-onboarding.ts
  - /src/lib/trial/trial-conversion.ts
  - /src/app/api/trial/start/route.ts
  - /src/app/api/trial/status/route.ts
  - /src/app/api/trial/convert/route.ts
  - /src/components/trial/TrialBanner.tsx
  - /src/components/trial/TrialOnboarding.tsx
  - /src/components/trial/TrialProgressDashboard.tsx

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Trial subscriptions and management
CREATE TABLE IF NOT EXISTS trial_subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES user_profiles(id),
  tier_id UUID REFERENCES subscription_tiers(id),
  trial_start_date TIMESTAMP NOT NULL DEFAULT NOW(),
  trial_end_date TIMESTAMP NOT NULL,
  original_trial_length_days INTEGER DEFAULT 30,
  extensions_granted INTEGER DEFAULT 0,
  total_trial_days INTEGER GENERATED ALWAYS AS (original_trial_length_days + extensions_granted) STORED,
  status TEXT NOT NULL CHECK (status IN ('active', 'expired', 'converted', 'canceled')),
  conversion_tier_id UUID REFERENCES subscription_tiers(id),
  converted_at TIMESTAMP,
  canceled_at TIMESTAMP,
  cancellation_reason TEXT,
  signup_source TEXT, -- 'website', 'referral', 'paid_ad', 'content_marketing'
  referrer_id UUID REFERENCES user_profiles(id),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Trial feature usage and engagement tracking
CREATE TABLE IF NOT EXISTS trial_usage_tracking (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  trial_id UUID REFERENCES trial_subscriptions(id),
  user_id UUID REFERENCES user_profiles(id),
  feature_key TEXT NOT NULL, -- 'client_onboarding', 'form_creation', 'journey_automation', 'ai_assistant'
  usage_date DATE NOT NULL,
  usage_count INTEGER DEFAULT 1,
  time_saved_minutes INTEGER DEFAULT 0, -- Calculated time savings
  value_generated_dollars DECIMAL(8,2) DEFAULT 0, -- Estimated value
  engagement_score DECIMAL(3,2) DEFAULT 0, -- 0-1 scale
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(trial_id, feature_key, usage_date)
);

-- Trial milestone achievements
CREATE TABLE IF NOT EXISTS trial_milestones (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  trial_id UUID REFERENCES trial_subscriptions(id),
  milestone_key TEXT NOT NULL, -- 'first_client_added', 'first_form_created', 'first_journey_sent', 'ten_hours_saved'
  milestone_name TEXT NOT NULL,
  milestone_description TEXT,
  points_value INTEGER DEFAULT 10,
  achieved_at TIMESTAMP NOT NULL DEFAULT NOW(),
  days_into_trial INTEGER NOT NULL,
  celebrates_automatically BOOLEAN DEFAULT true,
  celebration_sent BOOLEAN DEFAULT false,
  UNIQUE(trial_id, milestone_key)
);

-- Trial communication and touchpoints
CREATE TABLE IF NOT EXISTS trial_communications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  trial_id UUID REFERENCES trial_subscriptions(id),
  communication_type TEXT NOT NULL, -- 'welcome', 'day_7_check', 'day_14_progress', 'day_21_urgency', 'day_28_final'
  scheduled_date TIMESTAMP NOT NULL,
  sent_at TIMESTAMP,
  opened_at TIMESTAMP,
  clicked_at TIMESTAMP,
  responded_at TIMESTAMP,
  template_id TEXT,
  personalization_data JSONB DEFAULT '{}',
  conversion_focused BOOLEAN DEFAULT false,
  status TEXT DEFAULT 'scheduled' CHECK (status IN ('scheduled', 'sent', 'delivered', 'failed')),
  created_at TIMESTAMP DEFAULT NOW()
);

-- Trial value proposition and ROI calculations
CREATE TABLE IF NOT EXISTS trial_roi_calculations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  trial_id UUID REFERENCES trial_subscriptions(id),
  calculation_date DATE NOT NULL DEFAULT CURRENT_DATE,
  hours_saved_total DECIMAL(6,2) DEFAULT 0,
  estimated_hourly_rate DECIMAL(8,2) DEFAULT 75, -- Default wedding supplier hourly rate
  calculated_value_dollars DECIMAL(10,2) DEFAULT 0,
  clients_managed INTEGER DEFAULT 0,
  forms_completed INTEGER DEFAULT 0,
  journeys_automated INTEGER DEFAULT 0,
  efficiency_score DECIMAL(3,2) DEFAULT 0, -- 0-1 scale
  predicted_annual_savings DECIMAL(10,2) DEFAULT 0,
  roi_percentage DECIMAL(5,2) DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(trial_id, calculation_date)
);

-- Trial extension requests and approvals
CREATE TABLE IF NOT EXISTS trial_extensions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  trial_id UUID REFERENCES trial_subscriptions(id),
  requested_by UUID REFERENCES user_profiles(id),
  requested_days INTEGER NOT NULL,
  requested_reason TEXT,
  business_justification TEXT,
  approved_by TEXT, -- Admin user or system
  approved_at TIMESTAMP,
  approved_days INTEGER,
  approval_reason TEXT,
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'denied')),
  created_at TIMESTAMP DEFAULT NOW()
);

-- Trial conversion optimization and A/B testing
CREATE TABLE IF NOT EXISTS trial_experiments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  experiment_name TEXT NOT NULL,
  variant_name TEXT NOT NULL, -- 'control', 'extended_trial', 'shorter_trial', 'milestone_rewards'
  trial_length_days INTEGER NOT NULL,
  features_enabled JSONB DEFAULT '{}',
  communication_cadence JSONB DEFAULT '{}', -- {day_3: 'welcome', day_7: 'progress', ...}
  conversion_incentives JSONB DEFAULT '{}',
  traffic_allocation DECIMAL(3,2) NOT NULL, -- 0.00 to 1.00
  start_date DATE NOT NULL,
  end_date DATE,
  target_conversion_rate DECIMAL(4,2), -- Target % conversion rate
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### API Endpoints Required
```typescript
// POST /api/trial/start
interface StartTrialRequest {
  tierId: string; // Which paid tier to trial
  signupSource: string; // Tracking attribution
  referrerCode?: string; // Referral tracking
  businessInfo?: {
    vendorType: string;
    annualWeddings: number;
    currentChallenges: string[];
  };
}

interface StartTrialResponse {
  success: boolean;
  trialId: string;
  trialEndDate: string;
  daysRemaining: number;
  featuresUnlocked: string[];
  onboardingSteps: OnboardingStep[];
  nextMilestones: TrialMilestone[];
}

// GET /api/trial/status
interface TrialStatusResponse {
  success: boolean;
  trial: {
    id: string;
    status: 'active' | 'expired' | 'converted' | 'canceled';
    daysRemaining: number;
    progressScore: number; // 0-100
    valueGenerated: number; // Dollars
    timeSaved: number; // Hours
    milestonesAchieved: TrialMilestone[];
    nextMilestones: TrialMilestone[];
    conversionRecommendation: ConversionRecommendation;
  };
}

// POST /api/trial/convert
interface ConvertTrialRequest {
  targetTierId: string;
  billingCycle: 'monthly' | 'yearly';
  paymentMethodId: string;
  discountCode?: string;
}

interface ConvertTrialResponse {
  success: boolean;
  subscriptionId: string;
  discountApplied?: {
    code: string;
    amount: number;
    description: string;
  };
  firstChargeDate: string;
}

// POST /api/trial/extend
interface ExtendTrialRequest {
  requestedDays: number;
  businessJustification: string;
  additionalInfo?: {
    upcomingWeddings: number;
    challengesFaced: string;
    expectedROI: string;
  };
}
```

#### Frontend Components Required
```typescript
// Component: TrialProgressDashboard
// Location: /src/components/trial/TrialProgressDashboard.tsx

interface TrialProgressProps {
  trial: TrialStatus;
  onUpgradeClick: () => void;
  onExtendRequest: (days: number, reason: string) => void;
}

interface TrialStatus {
  daysRemaining: number;
  totalDays: number;
  progressPercentage: number;
  valueGenerated: number;
  timeSaved: number;
  milestonesCompleted: number;
  totalMilestones: number;
  conversionRecommendation: {
    recommendedTier: string;
    discountAvailable?: string;
    urgencyLevel: 'low' | 'medium' | 'high';
  };
}

interface OnboardingStep {
  id: string;
  title: string;
  description: string;
  completed: boolean;
  estimatedMinutes: number;
  valueProposition: string;
  ctaText: string;
  ctaUrl: string;
}

interface TrialMilestone {
  key: string;
  name: string;
  description: string;
  pointsValue: number;
  achieved: boolean;
  achievedAt?: string;
  timeSavedHours?: number;
  estimatedValue?: number;
}

// Key functionality:
- Real-time trial countdown with visual progress
- Value calculator showing ROI and time savings
- Milestone tracking with celebration animations
- Personalized upgrade recommendations
- Trial extension request system
- Usage analytics and engagement insights
```

#### Integration Points
```typescript
// Service: TrialManager
// Dependencies: Subscription system, usage tracking, email automation, analytics

class TrialManager {
  async startTrial(userId: string, tierId: string, signupData: SignupData): Promise<TrialStartResult> {
    // Create trial subscription record
    // Enable premium features temporarily
    // Initialize milestone tracking
    // Schedule communication sequence
    // Track conversion funnel entry
  }
  
  async calculateTrialROI(trialId: string): Promise<ROICalculation> {
    // Analyze feature usage patterns
    // Calculate time savings based on automation
    // Estimate value generated from efficiency gains
    // Project annual savings potential
  }
  
  async checkConversionReadiness(trialId: string): Promise<ConversionRecommendation> {
    // Analyze engagement score
    // Review milestone achievements
    // Calculate trial success metrics
    // Generate personalized upgrade recommendation
  }
}
```

### CODE EXAMPLES

#### Example 1: Comprehensive Trial Management with ROI Tracking
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { addDays, differenceInDays, format } from 'date-fns';

interface TrialMilestone {
  key: string;
  name: string;
  description: string;
  pointsValue: number;
  triggerCondition: (usage: TrialUsage) => boolean;
  valueProp: string;
  timeSavedHours: number;
}

const TRIAL_MILESTONES: TrialMilestone[] = [
  {
    key: 'first_client_added',
    name: 'First Client Connected',
    description: 'You\'ve successfully added your first client to WedSync',
    pointsValue: 20,
    triggerCondition: (usage) => usage.clientsAdded >= 1,
    valueProp: 'Centralized client management saves 2 hours per wedding',
    timeSavedHours: 2
  },
  {
    key: 'first_form_created',
    name: 'First Form Created',
    description: 'You\'ve created your first automated client form',
    pointsValue: 25,
    triggerCondition: (usage) => usage.formsCreated >= 1,
    valueProp: 'Automated forms eliminate 3 hours of back-and-forth emails',
    timeSavedHours: 3
  },
  {
    key: 'first_journey_launched',
    name: 'Client Journey Automated',
    description: 'You\'ve sent your first automated client journey',
    pointsValue: 30,
    triggerCondition: (usage) => usage.journeysLaunched >= 1,
    valueProp: 'Journey automation saves 5 hours per client relationship',
    timeSavedHours: 5
  },
  {
    key: 'ten_hours_saved',
    name: 'Time Saver Champion',
    description: 'You\'ve saved over 10 hours using WedSync automation',
    pointsValue: 50,
    triggerCondition: (usage) => usage.totalTimeSaved >= 10,
    valueProp: 'You\'re now saving $750+ per month in administrative costs',
    timeSavedHours: 10
  },
  {
    key: 'five_clients_active',
    name: 'Growing Business',
    description: 'You\'re actively managing 5+ clients with WedSync',
    pointsValue: 40,
    triggerCondition: (usage) => usage.activeClients >= 5,
    valueProp: 'Multi-client management efficiency scales your business',
    timeSavedHours: 8
  }
];

export class TrialManager {
  private supabase = createClient();
  
  async startTrial(
    userId: string, 
    tierId: string, 
    signupData: TrialSignupData
  ): Promise<TrialStartResult> {
    try {
      const trialLength = 30; // Default 30-day trial
      const trialEndDate = addDays(new Date(), trialLength);

      // Create trial subscription
      const { data: trial, error: trialError } = await this.supabase
        .from('trial_subscriptions')
        .insert({
          user_id: userId,
          tier_id: tierId,
          trial_end_date: trialEndDate,
          original_trial_length_days: trialLength,
          status: 'active',
          signup_source: signupData.source,
          referrer_id: signupData.referrerId
        })
        .select('*')
        .single();

      if (trialError) throw trialError;

      // Enable premium features temporarily
      await this.enableTrialFeatures(userId, tierId);

      // Initialize milestone tracking
      await this.initializeTrialMilestones(trial.id);

      // Schedule communication sequence
      await this.scheduleTrialCommunications(trial.id, userId);

      // Create initial ROI calculation baseline
      await this.createInitialROIBaseline(trial.id);

      return {
        success: true,
        trialId: trial.id,
        trialEndDate: trialEndDate.toISOString(),
        daysRemaining: trialLength,
        featuresUnlocked: await this.getTrialFeatures(tierId),
        onboardingSteps: await this.getPersonalizedOnboarding(userId, signupData),
        nextMilestones: TRIAL_MILESTONES.slice(0, 3)
      };

    } catch (error) {
      console.error('Trial creation failed:', error);
      return {
        success: false,
        error: error instanceof Error ? error.message : 'Trial creation failed'
      };
    }
  }

  async calculateTrialROI(trialId: string): Promise<ROICalculation> {
    try {
      // Get trial usage data
      const { data: usage } = await this.supabase
        .from('trial_usage_tracking')
        .select('*')
        .eq('trial_id', trialId);

      if (!usage) return { totalValue: 0, timeSaved: 0, efficiency: 0 };

      // Calculate total time saved across all features
      const totalTimeSaved = usage.reduce((total, record) => {
        return total + (record.time_saved_minutes || 0);
      }, 0) / 60; // Convert to hours

      // Calculate monetary value (assuming $75/hour for wedding suppliers)
      const hourlyRate = 75;
      const calculatedValue = totalTimeSaved * hourlyRate;

      // Calculate efficiency score based on feature adoption
      const featuresUsed = new Set(usage.map(u => u.feature_key)).size;
      const totalAvailableFeatures = 8; // Number of trial features
      const efficiencyScore = featuresUsed / totalAvailableFeatures;

      // Project annual savings based on current usage patterns
      const { data: trial } = await this.supabase
        .from('trial_subscriptions')
        .select('trial_start_date')
        .eq('id', trialId)
        .single();

      const daysUsed = differenceInDays(new Date(), new Date(trial.trial_start_date));
      const projectedAnnualSavings = (totalTimeSaved / daysUsed) * 365 * hourlyRate;

      // Update ROI calculation in database
      await this.supabase
        .from('trial_roi_calculations')
        .upsert({
          trial_id: trialId,
          calculation_date: format(new Date(), 'yyyy-MM-dd'),
          hours_saved_total: totalTimeSaved,
          calculated_value_dollars: calculatedValue,
          efficiency_score: efficiencyScore,
          predicted_annual_savings: projectedAnnualSavings,
          roi_percentage: (projectedAnnualSavings / (149 * 12)) * 100 // ROI vs Premium plan cost
        });

      return {
        totalValue: calculatedValue,
        timeSaved: totalTimeSaved,
        efficiency: efficiencyScore,
        projectedAnnualSavings,
        roiPercentage: (projectedAnnualSavings / (149 * 12)) * 100
      };

    } catch (error) {
      console.error('ROI calculation failed:', error);
      return { totalValue: 0, timeSaved: 0, efficiency: 0 };
    }
  }

  async trackTrialUsage(
    trialId: string, 
    userId: string, 
    featureKey: string, 
    metadata?: TrialUsageMetadata
  ): Promise<void> {
    try {
      // Calculate time saved for this feature usage
      const timeSaved = this.calculateFeatureTimeSavings(featureKey, metadata);
      const valueGenerated = timeSaved * 75; // $75/hour standard rate

      // Update usage tracking
      await this.supabase
        .from('trial_usage_tracking')
        .upsert({
          trial_id: trialId,
          user_id: userId,
          feature_key: featureKey,
          usage_date: format(new Date(), 'yyyy-MM-dd'),
          usage_count: 1,
          time_saved_minutes: timeSaved * 60,
          value_generated_dollars: valueGenerated,
          engagement_score: this.calculateEngagementScore(featureKey, metadata)
        }, {
          onConflict: 'trial_id,feature_key,usage_date',
          ignoreDuplicates: false
        });

      // Check for milestone achievements
      await this.checkMilestoneAchievements(trialId);

      // Update real-time ROI
      await this.calculateTrialROI(trialId);

    } catch (error) {
      console.error('Usage tracking failed:', error);
    }
  }

  private calculateFeatureTimeSavings(featureKey: string, metadata?: any): number {
    const timeSavingsMap = {
      'client_onboarding': 2.5, // Hours saved per client onboarded
      'form_creation': 1.5, // Hours saved per form vs manual collection
      'journey_automation': 3.0, // Hours saved per automated journey
      'ai_assistant': 0.5, // Hours saved per AI interaction
      'document_sharing': 0.75, // Hours saved per document shared
      'payment_tracking': 1.0, // Hours saved per payment tracked
      'timeline_management': 2.0, // Hours saved per timeline created
      'vendor_coordination': 1.5 // Hours saved per vendor coordinated
    };

    const baseSavings = timeSavingsMap[featureKey] || 0.5;
    
    // Apply multipliers based on metadata
    if (metadata?.complexity === 'high') return baseSavings * 1.5;
    if (metadata?.clientCount > 1) return baseSavings * metadata.clientCount * 0.8;
    
    return baseSavings;
  }

  async checkMilestoneAchievements(trialId: string): Promise<void> {
    try {
      // Get current trial usage
      const currentUsage = await this.getCurrentTrialUsage(trialId);
      
      for (const milestone of TRIAL_MILESTONES) {
        // Check if milestone is already achieved
        const { data: existing } = await this.supabase
          .from('trial_milestones')
          .select('id')
          .eq('trial_id', trialId)
          .eq('milestone_key', milestone.key)
          .single();

        if (!existing && milestone.triggerCondition(currentUsage)) {
          // Achievement unlocked!
          const { data: trial } = await this.supabase
            .from('trial_subscriptions')
            .select('trial_start_date, user_id')
            .eq('id', trialId)
            .single();

          const daysIntoTrial = differenceInDays(
            new Date(), 
            new Date(trial.trial_start_date)
          );

          // Record milestone achievement
          await this.supabase
            .from('trial_milestones')
            .insert({
              trial_id: trialId,
              milestone_key: milestone.key,
              milestone_name: milestone.name,
              milestone_description: milestone.description,
              points_value: milestone.pointsValue,
              days_into_trial: daysIntoTrial
            });

          // Send celebration email/notification
          if (milestone.key === 'ten_hours_saved') {
            await this.sendMilestoneCelebration(
              trial.user_id,
              milestone,
              currentUsage.totalTimeSaved * 75 // Value in dollars
            );
          }
        }
      }
    } catch (error) {
      console.error('Milestone check failed:', error);
    }
  }

  async checkConversionReadiness(trialId: string): Promise<ConversionRecommendation> {
    try {
      const trial = await this.getTrialDetails(trialId);
      const roiData = await this.calculateTrialROI(trialId);
      const milestones = await this.getMilestonesAchieved(trialId);
      
      // Calculate conversion readiness score
      let readinessScore = 0;
      
      // Time usage (30% weight)
      const daysUsed = differenceInDays(new Date(), new Date(trial.trial_start_date));
      const usageRatio = Math.min(daysUsed / 30, 1);
      readinessScore += usageRatio * 30;
      
      // Feature adoption (25% weight)
      readinessScore += roiData.efficiency * 25;
      
      // Value demonstration (25% weight)
      const valueScore = Math.min(roiData.totalValue / 500, 1); // $500 target value
      readinessScore += valueScore * 25;
      
      // Milestone achievements (20% weight)
      const milestoneScore = milestones.length / TRIAL_MILESTONES.length;
      readinessScore += milestoneScore * 20;

      // Determine recommendation
      let recommendation: ConversionRecommendation;
      
      if (readinessScore >= 80) {
        recommendation = {
          readiness: 'high',
          recommendedTier: 'premium',
          discountCode: 'TRIAL_SUCCESS_20',
          urgency: 'high',
          personalizedMessage: `You've saved $${Math.round(roiData.totalValue)} during your trial! Upgrade now to continue your momentum.`,
          roi_summary: {
            timeSaved: roiData.timeSaved,
            valueGenerated: roiData.totalValue,
            projectedAnnualSavings: roiData.projectedAnnualSavings
          }
        };
      } else if (readinessScore >= 60) {
        recommendation = {
          readiness: 'medium',
          recommendedTier: 'professional',
          discountCode: 'TRIAL_10_OFF',
          urgency: 'medium',
          personalizedMessage: `Great progress! You've unlocked ${milestones.length} milestones. Continue building with Professional.`,
          roi_summary: {
            timeSaved: roiData.timeSaved,
            valueGenerated: roiData.totalValue,
            projectedAnnualSavings: roiData.projectedAnnualSavings
          }
        };
      } else {
        recommendation = {
          readiness: 'low',
          recommendedTier: 'professional',
          urgency: 'low',
          personalizedMessage: 'Need more time? Request a trial extension to fully explore WedSync\'s potential.',
          extendTrialOption: true,
          roi_summary: {
            timeSaved: roiData.timeSaved,
            valueGenerated: roiData.totalValue,
            projectedAnnualSavings: roiData.projectedAnnualSavings
          }
        };
      }

      return recommendation;

    } catch (error) {
      console.error('Conversion readiness check failed:', error);
      return {
        readiness: 'low',
        recommendedTier: 'professional',
        urgency: 'low',
        personalizedMessage: 'Continue exploring WedSync features to maximize your trial value.'
      };
    }
  }

  async scheduleTrialCommunications(trialId: string, userId: string): Promise<void> {
    const communicationSequence = [
      {
        type: 'welcome',
        dayOffset: 0,
        subject: 'Welcome to Your WedSync Trial! Let\'s Get Started',
        template: 'trial_welcome',
        conversionFocused: false
      },
      {
        type: 'day_3_checkin',
        dayOffset: 3,
        subject: 'Quick Check: How\'s Your WedSync Experience So Far?',
        template: 'trial_day_3',
        conversionFocused: false
      },
      {
        type: 'day_7_progress',
        dayOffset: 7,
        subject: 'Week 1 Complete! See Your Progress',
        template: 'trial_week_1_progress',
        conversionFocused: false
      },
      {
        type: 'day_14_value_demo',
        dayOffset: 14,
        subject: 'Halfway Point: Your WedSync ROI Report',
        template: 'trial_roi_report',
        conversionFocused: true
      },
      {
        type: 'day_21_conversion',
        dayOffset: 21,
        subject: 'Only 9 Days Left - Don\'t Lose Your Progress',
        template: 'trial_conversion_push',
        conversionFocused: true
      },
      {
        type: 'day_27_final_push',
        dayOffset: 27,
        subject: 'Last 3 Days: Secure Your WedSync Transformation',
        template: 'trial_final_conversion',
        conversionFocused: true
      },
      {
        type: 'day_30_expiration',
        dayOffset: 30,
        subject: 'Your Trial Expires Today - One-Click to Continue',
        template: 'trial_expiration',
        conversionFocused: true
      }
    ];

    const scheduledCommunications = communicationSequence.map(comm => {
      const scheduledDate = addDays(new Date(), comm.dayOffset);
      return {
        trial_id: trialId,
        communication_type: comm.type,
        scheduled_date: scheduledDate.toISOString(),
        template_id: comm.template,
        conversion_focused: comm.conversionFocused,
        personalization_data: {
          user_id: userId,
          trial_id: trialId
        }
      };
    });

    await this.supabase
      .from('trial_communications')
      .insert(scheduledCommunications);
  }
}

// Usage tracking middleware for trial features
export async function trackTrialFeatureUsage(
  userId: string,
  featureKey: string,
  metadata?: any
) {
  try {
    // Check if user is on trial
    const { data: trial } = await supabase
      .from('trial_subscriptions')
      .select('id')
      .eq('user_id', userId)
      .eq('status', 'active')
      .single();

    if (trial) {
      const trialManager = new TrialManager();
      await trialManager.trackTrialUsage(trial.id, userId, featureKey, metadata);
    }
  } catch (error) {
    // Fail silently - don't break feature usage
    console.warn('Trial usage tracking failed:', error);
  }
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [ ] Context7: Load trial management and conversion optimization patterns
- [ ] Playwright: Test trial onboarding flows, milestone tracking, and conversion funnels
- [ ] PostgreSQL: Manage trial data, usage tracking, and ROI calculations

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/stripe/stripe-node", "trial subscriptions and conversion", 3000);
await mcp__context7__get-library-docs("/date-fns/date-fns", "trial date calculations", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('TrialManager', () => {
  it('should create trial subscription with proper expiration date', async () => {
    const userId = 'test-user-id';
    const tierId = 'professional-tier';
    const signupData = { source: 'website', vendorType: 'photography' };
    
    const result = await trialManager.startTrial(userId, tierId, signupData);
    
    expect(result.success).toBe(true);
    expect(result.daysRemaining).toBe(30);
    expect(result.trialEndDate).toBeTruthy();
  });

  it('should track trial usage and calculate ROI accurately', async () => {
    const trialId = 'test-trial-id';
    const usage = {
      clientsAdded: 3,
      formsCreated: 2,
      journeysLaunched: 1,
      totalTimeSaved: 8.5
    };
    
    const roi = await trialManager.calculateTrialROI(trialId);
    
    expect(roi.timeSaved).toBe(8.5);
    expect(roi.totalValue).toBe(637.5); // 8.5 hours * $75/hour
    expect(roi.projectedAnnualSavings).toBeGreaterThan(0);
  });

  it('should detect milestone achievements correctly', async () => {
    const trialId = 'test-trial-id';
    await trialManager.trackTrialUsage(trialId, 'test-user', 'client_onboarding', {
      clientCount: 1
    });
    
    const milestones = await trialManager.getMilestonesAchieved(trialId);
    
    expect(milestones.some(m => m.milestone_key === 'first_client_added')).toBe(true);
  });

  it('should provide accurate conversion recommendations', async () => {
    const trialId = 'test-trial-id';
    const recommendation = await trialManager.checkConversionReadiness(trialId);
    
    expect(recommendation.readiness).toBeOneOf(['low', 'medium', 'high']);
    expect(recommendation.recommendedTier).toBeTruthy();
    expect(recommendation.roi_summary).toBeDefined();
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Complete trial signup and milestone tracking flow', async () => {
  await mcp__playwright__browser_navigate({url: '/trial/signup'});
  
  // Start trial process
  await mcp__playwright__browser_click({
    element: 'Start Professional Trial Button',
    ref: 'button[data-trial="professional"]'
  });
  
  // Complete trial registration
  await mcp__playwright__browser_type({
    element: 'Business Name Input',
    ref: 'input[name="businessName"]',
    text: 'Test Photography Studio'
  });
  
  await mcp__playwright__browser_select_option({
    element: 'Vendor Type Select',
    ref: 'select[name="vendorType"]',
    values: ['photography']
  });
  
  await mcp__playwright__browser_click({
    element: 'Start Trial Button',
    ref: 'button[type="submit"]'
  });
  
  // Verify trial activation
  await mcp__playwright__browser_wait_for({text: 'Trial Activated'});
  await mcp__playwright__browser_wait_for({text: '30 Days Remaining'});
  
  // Complete first milestone (add client)
  await mcp__playwright__browser_navigate({url: '/clients'});
  await mcp__playwright__browser_click({element: 'Add Client Button', ref: 'button.add-client'});
  
  await mcp__playwright__browser_type({
    element: 'Client Name Input',
    ref: 'input[name="clientName"]',
    text: 'John & Jane Smith'
  });
  
  await mcp__playwright__browser_click({element: 'Save Client Button', ref: 'button[type="submit"]'});
  
  // Verify milestone achievement
  await mcp__playwright__browser_wait_for({text: 'Milestone Achieved: First Client Connected'});
  
  // Check trial dashboard
  await mcp__playwright__browser_navigate({url: '/trial/dashboard'});
  await mcp__playwright__browser_wait_for({text: 'Time Saved: 2 hours'});
  await mcp__playwright__browser_wait_for({text: 'Value Generated: $150'});
  
  await mcp__playwright__browser_snapshot();
});

test('Trial conversion flow with discount application', async () => {
  // Set user in advanced trial state via API
  await fetch('/api/test/set-trial-state', {
    method: 'POST',
    body: JSON.stringify({
      userId: 'test-user',
      daysRemaining: 5,
      roiGenerated: 750,
      milestonesAchieved: 4
    })
  });
  
  await mcp__playwright__browser_navigate({url: '/trial/dashboard'});
  
  // Should show high-readiness conversion prompt
  await mcp__playwright__browser_wait_for({text: 'Ready to Upgrade'});
  await mcp__playwright__browser_wait_for({text: 'You\'ve saved $750'});
  
  // Click upgrade recommendation
  await mcp__playwright__browser_click({
    element: 'Upgrade to Premium Button',
    ref: 'button.upgrade-premium'
  });
  
  // Verify discount is applied
  await mcp__playwright__browser_wait_for({text: '20% Trial Success Discount'});
  
  // Complete subscription
  await mcp__playwright__browser_type({
    element: 'Card Number Input',
    ref: 'input[name="cardNumber"]',
    text: '4242424242424242'
  });
  
  await mcp__playwright__browser_click({
    element: 'Subscribe Button',
    ref: 'button.complete-subscription'
  });
  
  // Verify successful conversion
  await mcp__playwright__browser_wait_for({text: 'Welcome to WedSync Premium'});
  
  await mcp__playwright__browser_snapshot();
});
```

### ACCEPTANCE CRITERIA
- [ ] Support 30-day free trials for Professional and Premium tiers
- [ ] Track 8+ key feature usage metrics with time savings calculations
- [ ] Implement 5 milestone achievements with automated celebration
- [ ] Calculate ROI with 90%+ accuracy based on time savings
- [ ] Provide personalized conversion recommendations
- [ ] Support trial extensions with business justification
- [ ] Achieve 25%+ trial-to-paid conversion rate
- [ ] Generate comprehensive trial summary reports
- [ ] Automated email sequence with 7 touchpoints
- [ ] Real-time trial dashboard with progress tracking

### DEPENDENCIES
- Must complete after: WS-131 (Pricing Strategy System) - Requires subscription infrastructure
- Must complete before: WS-133 (Customer Success System)
- Shares code with: Subscription management, usage tracking, email automation

### ESTIMATED EFFORT
- Team A Frontend: 26 hours (Trial dashboard, onboarding flow, progress tracking)
- Team B Backend: 34 hours (Trial management, ROI calculations, milestone tracking)
- Team C Integration: 22 hours (Email automation, conversion optimization, analytics)
- Total: 82 hours