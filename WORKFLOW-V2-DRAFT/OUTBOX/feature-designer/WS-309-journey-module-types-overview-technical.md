# TECHNICAL SPECIFICATION: WS-309 - Journey Module Types Overview
## Generated by Feature Development Session - 2025-01-20

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding venue coordinator building automated client journeys
**I want to:** Access 7 different module types (email, SMS, forms, meetings, info, reviews, referrals) to create comprehensive wedding workflow automations
**So that:** I can build complete client experiences from booking to post-wedding follow-up using purpose-built components instead of generic workflow tools

**Real Wedding Scenario:**
"A wedding venue currently manages client communication through manual processes: sending booking confirmations via email, collecting dietary requirements through forms, scheduling final walkthroughs via phone calls, and requesting reviews after events. With journey module types, they can create a visual workflow that automatically sends the right type of communication at each stage, with each module optimized for its specific purpose (email templates for announcements, meeting schedulers for appointments, form modules for data collection)."

### SPECIFICATION SOURCE
- **Feature ID:** WS-309
- **Original Spec:** /CORE-SPECIFICATIONS/02-WEDSYNC-SUPPLIER-PLATFORM/05-Customer-Journey/03-module-types.md
- **Current Implementation:** 20% complete (basic module structure exists)
- **Files to Modify:**
  - /wedsync/src/lib/journey-engine/startup.ts
  - /wedsync/src/components/journeys/JourneyBuilder.tsx
- **New Files to Create:**
  - /wedsync/src/components/journeys/modules/ModuleTypeRegistry.tsx
  - /wedsync/src/components/journeys/modules/EmailModule.tsx
  - /wedsync/src/components/journeys/modules/FormModule.tsx
  - /wedsync/src/lib/services/journey-module-service.ts

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Module type definitions
CREATE TABLE IF NOT EXISTS journey_module_types (
  id VARCHAR(50) PRIMARY KEY,
  display_name VARCHAR(100) NOT NULL,
  description TEXT,
  category VARCHAR(50) NOT NULL,
  icon VARCHAR(50),
  config_schema JSONB NOT NULL DEFAULT '{}',
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Insert core module types
INSERT INTO journey_module_types (id, display_name, description, category, icon, config_schema) VALUES
('email', 'Email Module', 'Send automated emails with templates', 'communication', 'mail', '{"template_id": "required", "send_delay": "optional", "personalization": "optional"}'),
('sms', 'SMS Module', 'Send text messages via WhatsApp or SMS', 'communication', 'message-circle', '{"message_text": "required", "channel": "required", "send_time": "optional"}'),
('form', 'Form Module', 'Send forms and collect responses', 'data_collection', 'clipboard', '{"form_id": "required", "reminder_enabled": "optional", "deadline": "optional"}'),
('meeting', 'Meeting Module', 'Schedule meetings and appointments', 'scheduling', 'calendar', '{"meeting_type": "required", "duration": "required", "buffer_time": "optional"}'),
('info', 'Info Module', 'Share information and updates', 'communication', 'info', '{"title": "required", "content": "required", "attachments": "optional"}'),
('review', 'Review Module', 'Request reviews and testimonials', 'feedback', 'star', '{"platforms": "required", "custom_message": "optional", "incentive": "optional"}'),
('referral', 'Referral Module', 'Encourage referrals with rewards', 'growth', 'users', '{"reward_type": "required", "reward_amount": "optional", "tracking_code": "auto"'}');

-- Journey step configurations (module instances)
CREATE TABLE IF NOT EXISTS journey_steps (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  journey_id UUID NOT NULL REFERENCES journeys(id) ON DELETE CASCADE,
  step_id VARCHAR(100) NOT NULL, -- Unique within journey
  module_type VARCHAR(50) NOT NULL REFERENCES journey_module_types(id),
  step_name VARCHAR(255) NOT NULL,
  position_x INTEGER DEFAULT 0,
  position_y INTEGER DEFAULT 0,
  config_data JSONB NOT NULL DEFAULT '{}',
  conditions JSONB DEFAULT '{}', -- Conditional execution rules
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(journey_id, step_id)
);
```

#### API Endpoints Required
```typescript
// GET /api/journeys/module-types
interface ModuleTypesResponse {
  categories: ModuleTypeCategory[];
}

interface ModuleTypeCategory {
  name: string;
  label: string;
  modules: ModuleTypeDefinition[];
}

interface ModuleTypeDefinition {
  id: string;
  display_name: string;
  description: string;
  icon: string;
  config_schema: Record<string, ConfigField>;
  preview_component: string;
}

interface ConfigField {
  type: 'text' | 'email' | 'select' | 'textarea' | 'number' | 'boolean';
  label: string;
  required: boolean;
  options?: string[];
  default_value?: any;
  validation?: Record<string, any>;
}

// POST /api/journeys/{id}/steps
interface CreateStepRequest {
  step_id: string;
  module_type: string;
  step_name: string;
  position: { x: number; y: number };
  config_data: Record<string, any>;
}
```

#### Frontend Components Required
```typescript
// Component: ModuleTypeRegistry
// Location: /src/components/journeys/modules/ModuleTypeRegistry.tsx

interface ModuleTypeRegistryProps {
  onModuleSelect: (moduleType: ModuleTypeDefinition) => void;
  categories: ModuleTypeCategory[];
}

// Key functionality:
- Display available module types in categories
- Drag-and-drop interface for adding modules to journey
- Search and filter module types
- Preview module configurations

// Component: EmailModule
// Location: /src/components/journeys/modules/EmailModule.tsx

interface EmailModuleProps {
  config: {
    template_id: string;
    send_delay?: number;
    personalization?: Record<string, string>;
    subject_override?: string;
  };
  onChange: (config: EmailModuleConfig) => void;
  onValidate: (isValid: boolean) => void;
}

// Key functionality:
- Email template selection
- Personalization token insertion
- Send timing configuration
- Preview email output
- A/B testing variant setup

// Component: FormModule
// Location: /src/components/journeys/modules/FormModule.tsx

interface FormModuleProps {
  config: {
    form_id: string;
    reminder_enabled?: boolean;
    deadline?: string;
    completion_redirect?: string;
  };
  onChange: (config: FormModuleConfig) => void;
}

// Key functionality:
- Form selection from user's forms
- Reminder scheduling
- Deadline configuration
- Response tracking setup
```

#### Integration Points
```typescript
// Service: JourneyModuleService
// Dependencies: EmailService, FormService, MeetingService, SMSService

class JourneyModuleService {
  async getAvailableModules(): Promise<ModuleTypeCategory[]> {
    // Load all available module types organized by category
  }
  
  async validateModuleConfig(moduleType: string, config: any): Promise<ValidationResult> {
    // Validate module configuration against schema
  }
  
  async executeModule(moduleType: string, config: any, context: ExecutionContext): Promise<ExecutionResult> {
    // Execute specific module type with given configuration
  }
  
  async previewModule(moduleType: string, config: any, sampleData: any): Promise<PreviewResult> {
    // Generate preview of module output for testing
  }
}

// Module execution interface
interface ExecutionContext {
  client_id: string;
  journey_instance_id: string;
  step_data: Record<string, any>;
  client_data: Record<string, any>;
}

interface ExecutionResult {
  success: boolean;
  result_data: Record<string, any>;
  next_step?: string;
  error_message?: string;
}
```

### CODE EXAMPLES

#### Example 1: Email Module Implementation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import React, { useState, useEffect } from 'react';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';

interface EmailModuleConfig {
  template_id: string;
  send_delay?: number;
  personalization?: Record<string, string>;
  subject_override?: string;
}

interface EmailModuleProps {
  config: EmailModuleConfig;
  onChange: (config: EmailModuleConfig) => void;
  onValidate: (isValid: boolean) => void;
}

export const EmailModule: React.FC<EmailModuleProps> = ({
  config,
  onChange,
  onValidate
}) => {
  const [emailTemplates, setEmailTemplates] = useState<EmailTemplate[]>([]);
  const [previewData, setPreviewData] = useState<string>('');
  
  useEffect(() => {
    loadEmailTemplates();
  }, []);
  
  useEffect(() => {
    validateConfig();
  }, [config]);
  
  async function loadEmailTemplates() {
    try {
      const response = await fetch('/api/email/templates');
      const templates = await response.json();
      setEmailTemplates(templates);
    } catch (error) {
      console.error('Failed to load email templates:', error);
    }
  }
  
  function validateConfig() {
    const isValid = config.template_id && config.template_id.length > 0;
    onValidate(isValid);
  }
  
  function updateConfig(updates: Partial<EmailModuleConfig>) {
    const newConfig = { ...config, ...updates };
    onChange(newConfig);
  }
  
  async function previewEmail() {
    if (!config.template_id) return;
    
    try {
      const response = await fetch('/api/journeys/preview-module', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          module_type: 'email',
          config,
          sample_data: {
            couple_name: 'John & Jane Smith',
            wedding_date: '2025-06-15',
            venue_name: 'Grand Wedding Venue'
          }
        })
      });
      
      const preview = await response.json();
      setPreviewData(preview.html_content);
    } catch (error) {
      console.error('Failed to preview email:', error);
    }
  }
  
  return (
    <div className="space-y-4">
      <div>
        <Label htmlFor="template-select">Email Template *</Label>
        <Select
          value={config.template_id || ''}
          onValueChange={(value) => updateConfig({ template_id: value })}
        >
          <SelectTrigger>
            <SelectValue placeholder="Choose email template" />
          </SelectTrigger>
          <SelectContent>
            {emailTemplates.map((template) => (
              <SelectItem key={template.id} value={template.id}>
                {template.name}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>
      
      <div>
        <Label htmlFor="send-delay">Send Delay (minutes)</Label>
        <Input
          id="send-delay"
          type="number"
          min="0"
          placeholder="0 (immediate)"
          value={config.send_delay || ''}
          onChange={(e) => updateConfig({ 
            send_delay: e.target.value ? parseInt(e.target.value) : undefined 
          })}
        />
      </div>
      
      <div>
        <Label htmlFor="subject-override">Subject Override</Label>
        <Input
          id="subject-override"
          placeholder="Leave blank to use template subject"
          value={config.subject_override || ''}
          onChange={(e) => updateConfig({ subject_override: e.target.value })}
        />
      </div>
      
      <div>
        <Label>Personalization Tokens</Label>
        <div className="grid grid-cols-2 gap-2 mt-2">
          <Button
            type="button"
            variant="outline"
            size="sm"
            onClick={() => {
              const tokens = config.personalization || {};
              tokens['couple_name'] = '{{client.couple_name}}';
              updateConfig({ personalization: tokens });
            }}
          >
            + Couple Name
          </Button>
          <Button
            type="button"
            variant="outline"
            size="sm"
            onClick={() => {
              const tokens = config.personalization || {};
              tokens['wedding_date'] = '{{client.wedding_date}}';
              updateConfig({ personalization: tokens });
            }}
          >
            + Wedding Date
          </Button>
        </div>
      </div>
      
      <div>
        <div className="flex justify-between items-center mb-2">
          <Label>Email Preview</Label>
          <Button
            type="button"
            variant="outline"
            size="sm"
            onClick={previewEmail}
            disabled={!config.template_id}
          >
            Generate Preview
          </Button>
        </div>
        {previewData && (
          <div 
            className="border p-3 bg-gray-50 rounded max-h-40 overflow-y-auto text-sm"
            dangerouslySetInnerHTML={{ __html: previewData }}
          />
        )}
      </div>
    </div>
  );
};
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for workflow builders, module patterns
- [ ] Playwright: Test module configuration flows
- [ ] Filesystem: Access module template files

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/xyflow/xyflow", "custom nodes workflow", 2000);
await mcp__context7__get-library-docs("/facebook/react", "component composition patterns", 1500);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('JourneyModuleService', () => {
  it('should load available module types by category', async () => {
    const service = new JourneyModuleService();
    const categories = await service.getAvailableModules();
    
    expect(categories).toHaveLength(4); // communication, data_collection, scheduling, feedback, growth
    expect(categories[0].modules).toContain(expect.objectContaining({
      id: 'email',
      display_name: 'Email Module'
    }));
  });

  it('should validate email module configuration', async () => {
    const service = new JourneyModuleService();
    const validConfig = { template_id: 'template-123' };
    const invalidConfig = { template_id: '' };
    
    const validResult = await service.validateModuleConfig('email', validConfig);
    const invalidResult = await service.validateModuleConfig('email', invalidConfig);
    
    expect(validResult.is_valid).toBe(true);
    expect(invalidResult.is_valid).toBe(false);
  });

  it('should execute email module and send email', async () => {
    const service = new JourneyModuleService();
    const config = { template_id: 'welcome-template', send_delay: 0 };
    const context = {
      client_id: 'client-123',
      journey_instance_id: 'instance-456',
      client_data: { email: 'couple@example.com', couple_name: 'John & Jane' }
    };
    
    const result = await service.executeModule('email', config, context);
    expect(result.success).toBe(true);
    expect(result.result_data.email_sent).toBe(true);
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Journey builder module types workflow', async () => {
  await mcp__playwright__browser_navigate({url: '/journeys/builder'});
  await mcp__playwright__browser_snapshot();
  
  // Test dragging email module to canvas
  await mcp__playwright__browser_drag({
    startElement: "Email module from palette",
    startRef: "[data-module-type='email']",
    endElement: "Journey canvas",
    endRef: "[data-testid='journey-canvas']"
  });
  
  // Configure email module
  await mcp__playwright__browser_click({
    element: "Email module configuration",
    ref: "[data-step-id='email-1'] .config-button"
  });
  
  // Select email template
  await mcp__playwright__browser_select_option({
    element: "Email template dropdown",
    ref: "[data-testid='template-select']",
    values: ["welcome-email"]
  });
  
  await mcp__playwright__browser_snapshot();
});
```

### ACCEPTANCE CRITERIA
- [ ] 7 module types available: email, SMS, form, meeting, info, review, referral
- [ ] Each module type has specific configuration UI optimized for its purpose  
- [ ] Modules can be dragged from palette to journey canvas
- [ ] Module configurations are validated before saving
- [ ] Email modules support template selection and personalization tokens
- [ ] Form modules integrate with the forms system
- [ ] Meeting modules connect to calendar scheduling
- [ ] Performance: Module configuration panels load in under 1 second
- [ ] Security: Module execution is sandboxed and validated
- [ ] Accessibility: All module configuration forms are screen reader compatible

### DEPENDENCIES
- Must complete after: WS-308 (Customer Journey foundation)
- Must complete before: WS-310 (React Flow implementation)
- Shares code with: Email service, form system, meeting scheduler, SMS service

### ESTIMATED EFFORT
- Team A Frontend: 28 hours
- Team B Backend: 20 hours
- Team C Integration: 12 hours
- Team D Platform: 8 hours
- Team E General: 4 hours
- Team F Workflows: 16 hours
- Team G Performance: 4 hours
- Total: 92 hours