# TECHNICAL SPECIFICATION: WS-139 - Pricing Strategy System
## Generated by Feature Development Session - 2025-08-24

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding photographer running a small business
**I want to:** Start with a free account and upgrade to paid features as my business grows
**So that:** I can access advanced client management tools without upfront costs, and scale my subscription as I get more clients

**Real Wedding Scenario:**
A new wedding photographer signs up for free to try basic features like client lists. After booking 10 weddings, they need automated journeys and AI chatbot features. They upgrade to Professional ($49/month) to handle their growing business without manual work overload.

### SPECIFICATION SOURCE
- **Feature ID:** WS-139
- **Original Spec:** /CORE-SPECIFICATIONS/13-BUSINESS-OPERATIONS/01-pricing-strategy md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** 
  - /src/lib/billing/subscription-manager.ts
  - /src/middleware/featureGating.ts
  - /src/app/(dashboard)/billing/page.tsx
- **New Files to Create:**
  - /src/lib/billing/pricing-tiers.ts
  - /src/lib/billing/feature-gating.ts
  - /src/lib/billing/trial-management.ts
  - /src/components/billing/PricingCards.tsx
  - /src/components/billing/UpgradeModal.tsx
  - /src/app/api/pricing/tiers/route.ts
  - /src/app/api/subscription/upgrade/route.ts
  - /src/app/api/subscription/downgrade/route.ts
  - /src/app/api/trial/extend/route.ts
  - /supabase/migrations/20250824000003_pricing_strategy_system.sql

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Subscription tiers table
CREATE TABLE IF NOT EXISTS subscription_tiers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL UNIQUE, -- 'free', 'starter', 'professional', 'scale', 'enterprise'
  price_monthly DECIMAL(10,2) NOT NULL DEFAULT 0,
  price_annual DECIMAL(10,2) NOT NULL DEFAULT 0,
  features JSONB NOT NULL DEFAULT '{}',
  limits JSONB NOT NULL DEFAULT '{}',
  display_order INT NOT NULL DEFAULT 0,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Supplier subscriptions tracking
CREATE TABLE IF NOT EXISTS supplier_subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID REFERENCES suppliers(id) ON DELETE CASCADE,
  tier_id UUID REFERENCES subscription_tiers(id),
  status TEXT NOT NULL DEFAULT 'trialing', -- 'trialing', 'active', 'past_due', 'canceled', 'paused'
  trial_ends_at TIMESTAMPTZ,
  current_period_start TIMESTAMPTZ,
  current_period_end TIMESTAMPTZ,
  stripe_subscription_id TEXT,
  stripe_customer_id TEXT,
  has_extended_trial BOOLEAN DEFAULT false,
  pause_reason TEXT,
  pause_until TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(supplier_id)
);

-- Usage tracking for feature gating
CREATE TABLE IF NOT EXISTS subscription_usage (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID REFERENCES suppliers(id) ON DELETE CASCADE,
  month DATE NOT NULL, -- First day of month
  clients_count INT DEFAULT 0,
  forms_count INT DEFAULT 0,
  storage_used_mb BIGINT DEFAULT 0,
  api_calls_count BIGINT DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(supplier_id, month)
);

-- Insert default pricing tiers
INSERT INTO subscription_tiers (name, price_monthly, price_annual, features, limits, display_order) VALUES
('free', 0, 0, 
 '{"basic_dashboard": true, "powered_by_branding": true, "ai_form_generation": false, "customer_journeys": "view_only"}',
 '{"forms": 1, "clients": 10, "logins": 1, "storage": 100}', 1),
('starter', 19, 190,
 '{"custom_branding": true, "email_journeys": true, "basic_analytics": true, "sms_integration_ready": true}',
 '{"forms": "unlimited", "clients": 100, "logins": 2, "storage": 5000}', 2),
('professional', 49, 490,
 '{"ai_chatbot": true, "full_automation": true, "calendar_meetings": true, "review_collection": true, "marketplace_access": true}',
 '{"forms": "unlimited", "clients": "unlimited", "logins": 3, "storage": 50000}', 3);
```

#### API Endpoints Required
```typescript
// GET /api/pricing/tiers
interface GetTiersResponse {
  tiers: Array<{
    id: string;
    name: string;
    priceMonthly: number;
    priceAnnual: number;
    features: Record<string, boolean | string>;
    limits: Record<string, number | string>;
    isPopular?: boolean;
  }>;
}

// POST /api/subscription/upgrade
interface UpgradeRequest {
  tierId: string;
  billingPeriod: 'monthly' | 'annual';
}

interface UpgradeResponse {
  success: boolean;
  stripeClientSecret?: string;
  subscriptionId?: string;
  error?: string;
}

// POST /api/subscription/downgrade
interface DowngradeRequest {
  tierId: string;
  reason?: string;
  downgradeAt?: 'now' | 'period_end';
}

// POST /api/trial/extend
interface ExtendTrialResponse {
  success: boolean;
  eligible: boolean;
  newTrialEndDate?: string;
  extensionDays?: number;
  requirements?: string[];
}
```

#### Frontend Components Required
```typescript
// Component: PricingCards
// Location: /src/components/billing/PricingCards.tsx

interface PricingTier {
  id: string;
  name: string;
  priceMonthly: number;
  priceAnnual: number;
  features: string[];
  limits: Record<string, number | string>;
  isPopular?: boolean;
  isCurrentTier?: boolean;
}

interface PricingCardsProps {
  tiers: PricingTier[];
  currentTier?: string;
  onUpgrade: (tierId: string, billing: 'monthly' | 'annual') => void;
  billingPeriod: 'monthly' | 'annual';
  setBillingPeriod: (period: 'monthly' | 'annual') => void;
}

// Component: FeatureGateModal
// Location: /src/components/billing/FeatureGateModal.tsx

interface FeatureGateModalProps {
  feature: string;
  featureName: string;
  requiredTier: string;
  isOpen: boolean;
  onClose: () => void;
  onUpgrade: () => void;
}

// Key functionality:
- Display pricing tiers with feature comparison
- Handle upgrade/downgrade flows with Stripe integration
- Show feature gates with upgrade prompts
- Trial extension eligibility checking
- Usage tracking and limit enforcement
```

#### Integration Points
```typescript
// Service: PricingService
// Dependencies: Supabase, Stripe, Next.js

class PricingService {
  static async getUserSubscription(supplierId: string) {
    const { data } = await supabase
      .from('supplier_subscriptions')
      .select(`
        *,
        subscription_tiers(*)
      `)
      .eq('supplier_id', supplierId)
      .single();
    
    return data;
  }

  static async checkFeatureAccess(supplierId: string, feature: string): Promise<boolean> {
    const subscription = await this.getUserSubscription(supplierId);
    if (!subscription?.subscription_tiers) return false;
    
    const tierFeatures = subscription.subscription_tiers.features as Record<string, any>;
    return tierFeatures[feature] === true;
  }

  static async upgradeSubscription(supplierId: string, tierId: string) {
    // Create Stripe subscription and update database
    const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!);
    // Implementation logic here
  }
}
```

### CODE EXAMPLES

#### Example 1: Feature Gating Middleware
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { getCurrentSupplier } from '@/lib/auth/server';

export async function checkFeatureAccess(
  request: NextRequest,
  feature: string
): Promise<NextResponse | null> {
  const supplier = await getCurrentSupplier();
  if (!supplier) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const supabase = createClient();
  const { data: subscription } = await supabase
    .from('supplier_subscriptions')
    .select(`
      *,
      subscription_tiers(features, limits)
    `)
    .eq('supplier_id', supplier.id)
    .single();

  if (!subscription?.subscription_tiers) {
    return NextResponse.json({ error: 'No subscription found' }, { status: 403 });
  }

  const features = subscription.subscription_tiers.features as Record<string, any>;
  const hasAccess = features[feature] === true;

  if (!hasAccess) {
    return NextResponse.json({
      error: 'Feature requires upgrade',
      feature,
      requiredTier: 'professional',
      upgradeUrl: '/billing'
    }, { status: 403 });
  }

  return null; // Access granted
}

// Usage in API routes:
export async function POST(request: NextRequest) {
  const featureCheck = await checkFeatureAccess(request, 'ai_chatbot');
  if (featureCheck) return featureCheck;
  
  // Continue with feature logic
}
```

#### Example 2: Trial Extension Logic
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { createClient } from '@/lib/supabase/server';
import { addDays, differenceInDays } from 'date-fns';

interface TrialActivity {
  logins: number;
  clientsImported: number;
  formsCreated: number;
}

export async function checkTrialExtensionEligibility(
  supplierId: string
): Promise<{
  eligible: boolean;
  requirements: string[];
  activity: TrialActivity;
}> {
  const supabase = createClient();
  
  // Get current subscription
  const { data: subscription } = await supabase
    .from('supplier_subscriptions')
    .select('*')
    .eq('supplier_id', supplierId)
    .eq('status', 'trialing')
    .single();

  if (!subscription || subscription.has_extended_trial) {
    return { eligible: false, requirements: ['Trial already extended'], activity: null };
  }

  // Check if trial expires in 5 days
  const daysUntilExpiry = differenceInDays(
    new Date(subscription.trial_ends_at),
    new Date()
  );

  if (daysUntilExpiry > 5) {
    return { 
      eligible: false, 
      requirements: ['Extension available 5 days before trial expires'],
      activity: null
    };
  }

  // Get user activity
  const { data: activityData } = await supabase.rpc('get_supplier_activity', {
    supplier_id: supplierId
  });

  const activity: TrialActivity = {
    logins: activityData?.login_count || 0,
    clientsImported: activityData?.clients_count || 0,
    formsCreated: activityData?.forms_count || 0
  };

  const requirements: string[] = [];
  if (activity.logins < 5) requirements.push('Need 5+ logins');
  if (activity.clientsImported < 10) requirements.push('Need 10+ clients imported');
  if (activity.formsCreated < 1) requirements.push('Need to create at least 1 form');

  return {
    eligible: requirements.length === 0,
    requirements,
    activity
  };
}

export async function extendTrial(supplierId: string): Promise<boolean> {
  const { eligible } = await checkTrialExtensionEligibility(supplierId);
  if (!eligible) return false;

  const supabase = createClient();
  const { error } = await supabase
    .from('supplier_subscriptions')
    .update({
      trial_ends_at: addDays(new Date(), 15).toISOString(),
      has_extended_trial: true
    })
    .eq('supplier_id', supplierId);

  return !error;
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [ ] Context7: Load docs for Stripe, Supabase billing patterns
- [ ] Playwright: Test upgrade/downgrade flows
- [ ] PostgreSQL: Test billing database queries

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/stripe/stripe-node", "subscriptions pricing", 3000);
await mcp__context7__get-library-docs("/supabase/supabase", "row level security billing", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('PricingService', () => {
  it('should check feature access correctly', async () => {
    const mockSubscription = {
      subscription_tiers: {
        features: { ai_chatbot: true }
      }
    };
    
    jest.spyOn(PricingService, 'getUserSubscription')
      .mockResolvedValue(mockSubscription);
    
    const hasAccess = await PricingService.checkFeatureAccess('supplier-1', 'ai_chatbot');
    expect(hasAccess).toBe(true);
  });

  it('should handle trial extension eligibility', async () => {
    const result = await checkTrialExtensionEligibility('supplier-1');
    expect(result).toHaveProperty('eligible');
    expect(result).toHaveProperty('requirements');
    expect(result).toHaveProperty('activity');
  });
});

describe('FeatureGating Middleware', () => {
  it('should block access for insufficient tier', async () => {
    const response = await checkFeatureAccess(mockRequest, 'ai_chatbot');
    expect(response.status).toBe(403);
    
    const body = await response.json();
    expect(body.error).toContain('Feature requires upgrade');
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Pricing tier upgrade flow', async () => {
  await mcp__playwright__browser_navigate({ url: '/billing' });
  await mcp__playwright__browser_snapshot();
  
  // Click upgrade button
  await mcp__playwright__browser_click({
    element: 'Professional tier upgrade button',
    ref: '[data-testid="upgrade-professional"]'
  });
  
  // Should redirect to Stripe checkout
  await mcp__playwright__browser_wait_for({ text: 'Stripe' });
  
  // Verify checkout page loaded
  const url = await page.url();
  expect(url).toContain('checkout.stripe.com');
});

test('Feature gate modal appears for restricted features', async () => {
  await mcp__playwright__browser_navigate({ url: '/chatbot' });
  
  // Should show feature gate modal
  await mcp__playwright__browser_wait_for({ text: 'Upgrade to Professional' });
  await mcp__playwright__browser_snapshot();
  
  // Click upgrade in modal
  await mcp__playwright__browser_click({
    element: 'Upgrade button in modal',
    ref: '[data-testid="modal-upgrade-btn"]'
  });
  
  // Should navigate to billing page
  expect(page.url()).toContain('/billing');
});
```

### ACCEPTANCE CRITERIA
- [ ] Freemium tier allows 10 clients, 1 form, basic dashboard
- [ ] Feature gating blocks access with upgrade prompts
- [ ] Stripe integration handles subscriptions, upgrades, downgrades
- [ ] Trial extension available once per account (15 days)
- [ ] Usage tracking enforces tier limits accurately
- [ ] Downgrade preserves data but makes it read-only
- [ ] Performance: Billing queries under 200ms
- [ ] Security: RLS policies protect subscription data
- [ ] Accessibility: Pricing page meets WCAG 2.1 AA standards

### DEPENDENCIES
- Must complete after: WS-076 (Stripe Setup) must be complete
- Must complete before: WS-140 (Trial Management System)
- Shares code with: WS-071 (Subscription Tiers), WS-132 (Advanced Billing)

### ESTIMATED EFFORT
- Team A Frontend: 24 hours (pricing page, modals, gates)
- Team B Backend: 40 hours (billing logic, Stripe integration, feature gating)
- Team C Integration: 16 hours (testing, migration, RLS policies)
- Total: 80 hours