# TECHNICAL SPECIFICATION: WS-046 - Referral Programs System
## Generated by Feature Development Session - 2025-08-21

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding photographer/venue coordinator who completed a successful wedding
**I want to:** Automatically invite happy couples to refer friends getting married 
**So that:** I get 3x higher conversion referrals instead of cold leads, reducing acquisition costs by 60%

**Real Wedding Scenario:**
Sarah's wedding photographer delivered amazing photos 3 months ago. The system automatically sends Sarah a referral invitation with her unique code "SARAH2025" and $100 credit for both her and referred friends. Sarah shares this on her newlywed Facebook posts, generating 2 qualified leads for the photographer within a week.

### SPECIFICATION SOURCE
- **Feature ID:** WS-046
- **Original Spec:** /CORE-SPECIFICATIONS/02-WEDSYNC-SUPPLIER-PLATFORM/08-Growth-Features/01-referral-programs md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** None - new feature
- **New Files to Create:** 
  - `/src/components/growth/ReferralProgramBuilder.tsx`
  - `/src/app/api/referrals/route.ts`
  - `/src/app/api/referrals/[code]/route.ts`
  - `/src/lib/referrals/referral-engine.ts`
  - `/src/app/(dashboard)/referrals/page.tsx`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Referral Programs table
CREATE TABLE IF NOT EXISTS referral_programs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID NOT NULL REFERENCES suppliers(id),
  name VARCHAR(100) NOT NULL,
  reward_type VARCHAR(20) CHECK (reward_type IN ('monetary', 'percentage', 'upgrade', 'custom')),
  referrer_reward_amount DECIMAL(10,2),
  referee_reward_amount DECIMAL(10,2),
  milestone_rewards JSONB, -- {3: 50.00, 5: 100.00, 10: 250.00}
  attribution_window_days INTEGER DEFAULT 90,
  is_active BOOLEAN DEFAULT TRUE,
  expires_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Referral Codes table
CREATE TABLE IF NOT EXISTS referral_codes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code VARCHAR(20) UNIQUE NOT NULL,
  program_id UUID NOT NULL REFERENCES referral_programs(id),
  couple_id UUID NOT NULL REFERENCES couples(id),
  landing_page_url TEXT,
  qr_code_url TEXT,
  total_clicks INTEGER DEFAULT 0,
  total_conversions INTEGER DEFAULT 0,
  status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'expired', 'disabled')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Referral Conversions table
CREATE TABLE IF NOT EXISTS referral_conversions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  referral_code_id UUID NOT NULL REFERENCES referral_codes(id),
  referred_couple_id UUID REFERENCES couples(id),
  referred_email VARCHAR(255) NOT NULL,
  click_timestamp TIMESTAMP WITH TIME ZONE,
  conversion_timestamp TIMESTAMP WITH TIME ZONE,
  reward_fulfilled BOOLEAN DEFAULT FALSE,
  reward_amount DECIMAL(10,2),
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Referral Analytics table
CREATE TABLE IF NOT EXISTS referral_analytics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  program_id UUID NOT NULL REFERENCES referral_programs(id),
  date DATE NOT NULL,
  invitations_sent INTEGER DEFAULT 0,
  clicks INTEGER DEFAULT 0,
  conversions INTEGER DEFAULT 0,
  revenue_generated DECIMAL(10,2) DEFAULT 0,
  rewards_paid DECIMAL(10,2) DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(program_id, date)
);
```

#### API Endpoints Required
```typescript
// GET /api/referrals/programs
interface GetProgramsResponse {
  success: boolean;
  programs: ReferralProgram[];
}

// POST /api/referrals/programs
interface CreateProgramRequest {
  name: string;
  rewardType: 'monetary' | 'percentage' | 'upgrade' | 'custom';
  referrerRewardAmount: number;
  refereeRewardAmount: number;
  milestoneRewards?: Record<number, number>;
  attributionWindowDays?: number;
  expiresAt?: string;
}

// GET /api/referrals/codes/[coupleId]
interface GetReferralCodeResponse {
  success: boolean;
  code: string;
  landingPageUrl: string;
  qrCodeUrl: string;
  stats: {
    clicks: number;
    conversions: number;
    totalEarnings: number;
  };
}

// POST /api/referrals/track-click
interface TrackClickRequest {
  code: string;
  ipAddress: string;
  userAgent: string;
}

// POST /api/referrals/track-conversion
interface TrackConversionRequest {
  code: string;
  referredEmail: string;
  coupleId?: string;
}

// GET /api/referrals/analytics/[programId]
interface AnalyticsResponse {
  success: boolean;
  metrics: {
    totalInvitations: number;
    clickThroughRate: number;
    conversionRate: number;
    roi: number;
    topReferrers: Array<{
      coupleName: string;
      conversions: number;
      earnings: number;
    }>;
  };
}
```

#### Frontend Components Required
```typescript
// Component: ReferralProgramBuilder
// Location: /src/components/growth/ReferralProgramBuilder.tsx

interface ReferralProgramBuilderProps {
  supplierId: string;
  onProgramCreated: (program: ReferralProgram) => void;
}

// Key functionality:
- Visual program configuration form
- Reward type selector with preview calculations  
- Milestone reward builder
- Preview of referral materials
- Integration with email templates

// Component: ReferralDashboard
// Location: /src/components/growth/ReferralDashboard.tsx

interface ReferralDashboardProps {
  supplierId: string;
}

// Key functionality:
- Analytics charts (clicks, conversions, ROI)
- Top referrer leaderboard
- Active program management
- QR code generation and download
- Fraud detection alerts

// Component: ReferralInvitationEmail
// Location: /src/components/growth/ReferralInvitationEmail.tsx

interface ReferralInvitationEmailProps {
  couple: Couple;
  program: ReferralProgram;
  referralCode: string;
}

// Key functionality:
- Personalized email template
- Social sharing buttons
- Landing page preview
- Reward explanation
- One-click sharing to social platforms
```

#### Integration Points
```typescript
// Service: ReferralEngine
// Dependencies: EmailService, CoupleService, AnalyticsService

class ReferralEngine {
  async createProgram(supplierId: string, programData: CreateProgramRequest) {
    // Create program and generate initial codes for existing couples
  }
  
  async sendInvitations(programId: string, timing: 'immediate' | 'delayed') {
    // Send invitations at optimal times (3 months post-wedding)
  }
  
  async trackClick(code: string, metadata: ClickMetadata) {
    // Record click with fraud prevention checks
  }
  
  async processConversion(code: string, referredData: ConversionData) {
    // Handle conversion, calculate rewards, trigger notifications
  }
  
  async detectFraud(conversionId: string): Promise<FraudScore> {
    // Velocity limits, IP checking, pattern analysis
  }
}

// Service: QRCodeGenerator
// Dependencies: QRCode library

class QRCodeGenerator {
  async generateReferralQR(landingUrl: string): Promise<string> {
    // Generate QR code for physical marketing materials
  }
}
```

### CODE EXAMPLES

#### Example 1: Referral Code Generation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { nanoid } from 'nanoid';
import { supabase } from '@/lib/supabase';

export async function generateReferralCode(coupleId: string, programId: string) {
  // Step 1: Generate unique 8-character code
  let code: string;
  let isUnique = false;
  
  while (!isUnique) {
    code = nanoid(8).toUpperCase();
    const { data: existing } = await supabase
      .from('referral_codes')
      .select('id')
      .eq('code', code)
      .single();
    
    isUnique = !existing;
  }
  
  // Step 2: Create landing page URL
  const { data: supplier } = await supabase
    .from('suppliers')
    .select('slug')
    .eq('id', (await supabase.from('referral_programs').select('supplier_id').eq('id', programId).single()).data?.supplier_id)
    .single();
    
  const landingPageUrl = `https://wedsync.com/refer/${supplier?.slug}/${code}`;
  
  // Step 3: Generate QR code
  const qrCodeUrl = await generateQRCode(landingPageUrl);
  
  // Step 4: Store in database
  const { data, error } = await supabase
    .from('referral_codes')
    .insert({
      code,
      program_id: programId,
      couple_id: coupleId,
      landing_page_url: landingPageUrl,
      qr_code_url: qrCodeUrl
    })
    .select()
    .single();
    
  if (error) throw error;
  
  return data;
}
```

#### Example 2: Fraud Prevention
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { supabase } from '@/lib/supabase';

export async function detectFraudulentConversion(
  referralCodeId: string, 
  ipAddress: string, 
  userAgent: string
): Promise<{ isFraud: boolean; score: number; reasons: string[] }> {
  
  const reasons: string[] = [];
  let score = 0;
  
  // Check 1: Multiple conversions from same IP in 24 hours
  const { count: ipCount } = await supabase
    .from('referral_conversions')
    .select('id', { count: 'exact' })
    .eq('ip_address', ipAddress)
    .gte('created_at', new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString());
    
  if ((ipCount || 0) > 3) {
    score += 40;
    reasons.push('Multiple conversions from same IP');
  }
  
  // Check 2: Conversion without click (direct URL manipulation)
  const { data: recentClick } = await supabase
    .from('referral_conversions')
    .select('click_timestamp')
    .eq('referral_code_id', referralCodeId)
    .eq('ip_address', ipAddress)
    .gte('click_timestamp', new Date(Date.now() - 30 * 60 * 1000).toISOString()) // 30 min window
    .single();
    
  if (!recentClick) {
    score += 60;
    reasons.push('Conversion without recent click');
  }
  
  // Check 3: Suspicious user agent patterns
  if (!userAgent || userAgent.includes('bot') || userAgent.length < 20) {
    score += 30;
    reasons.push('Suspicious user agent');
  }
  
  return {
    isFraud: score >= 70,
    score,
    reasons
  };
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for email templates, QR generation
- [x] Filesystem: Access email template files
- [ ] Playwright: Test referral flow end-to-end

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/qrcode/qrcode", "node.js qr generation", 2000);
await mcp__context7__get-library-docs("/nodemailer/nodemailer", "email templates", 3000);
await mcp__context7__get-library-docs("/nanoid/nanoid", "unique id generation", 1500);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('Referral Engine', () => {
  it('should generate unique referral codes', async () => {
    const code1 = await generateReferralCode('couple1', 'program1');
    const code2 = await generateReferralCode('couple2', 'program1');
    expect(code1.code).not.toEqual(code2.code);
  });
  
  it('should detect fraudulent conversions', async () => {
    const result = await detectFraudulentConversion('code1', '192.168.1.1', 'suspicious-bot');
    expect(result.isFraud).toBe(true);
  });
  
  it('should calculate milestone rewards correctly', async () => {
    const rewards = calculateMilestoneReward(5, { 3: 50, 5: 100, 10: 250 });
    expect(rewards).toBe(100);
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Complete referral flow', async () => {
  // Step 1: Supplier creates referral program
  await mcp__playwright__browser_navigate({url: '/referrals'});
  await mcp__playwright__browser_click({element: 'Create Program button', ref: 'button[data-testid="create-program"]'});
  
  // Step 2: Configure program settings
  await mcp__playwright__browser_type({element: 'program name', ref: 'input[name="name"]', text: 'Friend Referral Program'});
  await mcp__playwright__browser_select_option({element: 'reward type', ref: 'select[name="rewardType"]', values: ['monetary']});
  
  // Step 3: Verify referral code generation
  await mcp__playwright__browser_navigate({url: '/referrals/codes'});
  await mcp__playwright__browser_snapshot();
  
  // Step 4: Test referral landing page
  const referralUrl = await page.locator('[data-testid="referral-url"]').textContent();
  await mcp__playwright__browser_navigate({url: referralUrl});
  await mcp__playwright__browser_snapshot();
  
  // Verify accessibility and mobile responsiveness
});
```

### ACCEPTANCE CRITERIA
- [x] Suppliers can create and configure referral programs with multiple reward types
- [x] System generates unique codes and QR codes for each couple automatically  
- [x] Landing pages track clicks and conversions with 99.5% accuracy
- [x] Fraud prevention blocks >90% of suspicious conversions
- [x] Analytics dashboard shows ROI, click-through rates, and top referrers
- [x] Performance: Page loads in <2 seconds, API responses <500ms
- [x] Security: All referral codes expire after attribution window
- [x] Accessibility: WCAG 2.1 AA compliance for all referral interfaces

### DEPENDENCIES
- Must complete after: Client Management System (WS-002) - needs couple data
- Must complete before: Viral Mechanics System (WS-050) - builds on referral foundation
- Shares code with: Email Templates (WS-012), Analytics Dashboard

### ESTIMATED EFFORT
- Team A Frontend: 28 hours
- Team B Backend: 32 hours  
- Team C Integration: 8 hours
- Total: 68 hours