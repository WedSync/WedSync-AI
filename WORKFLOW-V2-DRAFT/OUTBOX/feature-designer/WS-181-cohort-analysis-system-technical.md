# TECHNICAL SPECIFICATION: WS-181 - Cohort Analysis System
## Generated by Feature Development Session - August 25, 2025

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** WedSync administrator managing supplier growth and retention
**I want to:** Track supplier cohort performance by signup month showing retention, revenue, and expansion patterns
**So that:** I can identify successful onboarding periods, predict churn, and optimize supplier acquisition strategies to improve business sustainability

**Real Wedding Scenario:**
WedSync admins need to understand which monthly cohorts of wedding suppliers (photographers, venues, florists) have the highest lifetime value and retention rates. Currently, they can't identify whether the 50 photographers who joined in January 2024 are more valuable than those who joined in June 2024, making it impossible to optimize marketing spend or predict future revenue from supplier subscriptions.

### SPECIFICATION SOURCE
- **Feature ID:** WS-181
- **Original Spec:** /CORE-SPECIFICATIONS/07-ADMIN-DASHBOARD/02-Revenue-Analytics/02-cohort-analysis md.md
- **Current Implementation:** 0% complete (new)
- **Files to Modify:** None (new feature)
- **New Files to Create:** 
  - `/wedsync/src/components/admin/CohortAnalysis.tsx`
  - `/wedsync/src/lib/analytics/cohort-analyzer.ts`
  - `/wedsync/src/app/api/admin/cohorts/route.ts`
  - `/wedsync/supabase/migrations/cohort-analysis-tables.sql`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Cohort summary table
CREATE TABLE cohort_analysis (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  cohort_month DATE NOT NULL,
  period_month DATE NOT NULL,
  period_index INTEGER NOT NULL,
  cohort_size INTEGER NOT NULL,
  active_users INTEGER,
  churned_users INTEGER,
  revenue DECIMAL(10, 2),
  new_revenue DECIMAL(10, 2),
  expansion_revenue DECIMAL(10, 2),
  contraction_revenue DECIMAL(10, 2),
  calculated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(cohort_month, period_month)
);

-- User cohort assignments
CREATE TABLE user_cohorts (
  user_id UUID PRIMARY KEY REFERENCES users(id),
  cohort_month DATE NOT NULL,
  initial_plan TEXT,
  initial_mrr DECIMAL(10, 2),
  current_plan TEXT,
  current_mrr DECIMAL(10, 2),
  lifetime_value DECIMAL(10, 2),
  months_active INTEGER,
  last_active DATE
);

-- Materialized view for quick cohort queries
CREATE MATERIALIZED VIEW cohort_retention AS
  SELECT 
    cohort_month,
    period_index,
    COUNT(DISTINCT user_id) as active_users,
    COUNT(DISTINCT user_id)::FLOAT / cohort_size as retention_rate,
    AVG(revenue) as avg_revenue
  FROM cohort_analysis
  GROUP BY cohort_month, period_index, cohort_size;
```

#### API Endpoints Required
```typescript
// GET /api/admin/cohorts
interface CohortRequest {
  startDate: string;
  endDate: string;
  metric: 'retention' | 'revenue' | 'ltv';
}

interface CohortResponse {
  success: boolean;
  data: {
    cohorts: Cohort[];
    metrics: {
      retention: number[][];
      revenue: number[][];
      ltv: number[][];
    };
  };
}
```

#### Frontend Components Required
```typescript
// Component: CohortAnalysis
// Location: /src/components/admin/CohortAnalysis.tsx

interface Props {
  timeRange: number;
  selectedMetric: 'retention' | 'revenue' | 'ltv';
}

// Key functionality:
- Cohort heatmap visualization with color-coded performance
- Metric selector for retention, revenue, LTV analysis
- Time range controls for different analysis periods
- Automated insights generation for business decisions
```

#### Integration Points
```typescript
// Service: CohortAnalyzer
// Dependencies: Database connection, User management service

class CohortAnalyzer {
  async generateCohortAnalysis(
    startDate: Date,
    endDate: Date,
    metric: 'retention' | 'revenue' | 'ltv'
  ): Promise<CohortAnalysis> {
    // Complex cohort calculations from specification
  }
}
```

### CODE EXAMPLES

#### Example 1: Cohort Data Calculation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { supabase } from '@/lib/supabase';

export async function calculateCohortAnalysis(startDate: Date, endDate: Date) {
  // Step 1: Get all supplier cohorts in range
  const { data: cohorts, error } = await supabase.rpc('get_supplier_cohorts', {
    start_date: startDate,
    end_date: endDate
  });
    
  // Step 2: Calculate retention metrics for each cohort
  if (error) throw error;
  
  const analysisData = await Promise.all(
    cohorts.map(cohort => analyzeCohortPerformance(cohort))
  );
  
  return {
    cohorts: analysisData,
    metrics: buildRetentionMatrix(analysisData)
  };
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for Next.js App Router, Supabase RPC functions
- [x] PostgreSQL: Execute complex cohort analysis queries
- [x] Playwright: Test cohort visualization rendering

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/vercel/next.js", "app router api", 3000);
await mcp__context7__get-library-docs("/supabase/supabase", "rpc functions", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('CohortAnalyzer', () => {
  it('should calculate retention rates correctly for supplier cohorts', () => {
    // Test cohort retention calculation accuracy
  });
  
  it('should handle incomplete months in cohort data', () => {
    // Test edge case handling
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Admin can view cohort analysis dashboard', async () => {
  await mcp__playwright__browser_navigate({url: '/admin/analytics/cohorts'});
  await mcp__playwright__browser_snapshot();
  // Verify heatmap renders and metrics are accurate
});
```

### ACCEPTANCE CRITERIA
- [x] Cohort heatmap displays retention rates by signup month
- [x] Revenue analysis shows expansion and contraction patterns  
- [x] LTV calculations predict supplier lifetime value accurately
- [x] Performance: Cohort calculations complete within 3 seconds
- [x] Security: Admin-only access with proper authentication
- [x] Accessibility: Screen reader compatible chart descriptions

### DEPENDENCIES
- Must complete after: WS-120 (MRR Tracking Dashboard) - requires revenue foundation
- Must complete before: WS-182 (Churn Intelligence) - provides cohort data
- Shares code with: WS-183 (LTV Calculations) - common analytics infrastructure

### ESTIMATED EFFORT
- Team A Frontend: 24 hours (Cohort visualization components)
- Team B Backend: 32 hours (Complex cohort calculations and caching)
- Team C Integration: 16 hours (Database optimization and materialized views)
- Total: 72 hours