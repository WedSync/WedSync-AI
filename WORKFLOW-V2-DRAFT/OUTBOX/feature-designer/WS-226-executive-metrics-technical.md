# TECHNICAL SPECIFICATION: WS-226 - Executive Metrics
## Generated by Feature Development Session - 2025-01-25

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding platform executive
**I want to:** See real-time business metrics on a single dashboard
**So that:** I can make data-driven decisions about platform growth and identify issues before they impact revenue

**Real Wedding Scenario:**
An executive needs to monitor platform health during peak wedding season. With 500+ suppliers serving thousands of couples, they need instant visibility into MRR growth, user engagement, and viral coefficient to identify if marketing campaigns are working or if technical issues are causing churn.

### SPECIFICATION SOURCE
- **Feature ID:** WS-226
- **Original Spec:** /CORE-SPECIFICATIONS/07-ADMIN-DASHBOARD/01-Overview/01-executive-metrics md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** None (new feature)
- **New Files to Create:** 
  - /src/app/(dashboard)/admin/metrics/page.tsx
  - /src/components/admin/ExecutiveDashboard.tsx
  - /src/components/admin/MetricCard.tsx
  - /src/lib/services/metrics-aggregator.ts
  - /src/hooks/useRealtimeMetrics.ts

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Executive metrics materialized view for performance
CREATE MATERIALIZED VIEW daily_metrics AS
SELECT 
  DATE(created_at) as date,
  COUNT(DISTINCT supplier_id) as active_suppliers,
  COUNT(DISTINCT couple_id) as active_couples,
  AVG(session_duration) as avg_session_duration
FROM user_sessions
GROUP BY DATE(created_at);

CREATE INDEX idx_metrics_date ON daily_metrics(date);

-- Revenue metrics view
CREATE MATERIALIZED VIEW revenue_metrics AS
SELECT 
  DATE_TRUNC('month', created_at) as month,
  SUM(amount) as mrr,
  COUNT(*) as active_subscriptions,
  AVG(amount) as average_plan_value
FROM subscriptions 
WHERE status = 'active'
GROUP BY DATE_TRUNC('month', created_at);
```

#### API Endpoints Required
```typescript
// GET /api/admin/metrics/executive
interface ExecutiveMetricsResponse {
  success: boolean;
  data: {
    revenue: {
      mrr: number;
      arr: number;
      growth: number; // Month-over-month percentage
      churn: number;
    };
    users: {
      totalSuppliers: number;
      totalCouples: number;
      activeSuppliers: number; // Logged in last 30 days
      activeCouples: number;
      newSignupsToday: number;
    };
    viral: {
      coefficient: number; // Target > 1.0
      invitationsSent: number;
      invitationsAccepted: number;
      averageInvitesPerSupplier: number;
    };
    engagement: {
      dailyActiveUsers: number;
      weeklyActiveUsers: number;
      monthlyActiveUsers: number;
      averageSessionDuration: number;
    };
  };
  lastUpdated: string;
}
```

#### Frontend Components Required
```typescript
// Component: ExecutiveDashboard
// Location: /src/components/admin/ExecutiveDashboard.tsx

interface ExecutiveMetrics {
  revenue: RevenueMetrics;
  users: UserMetrics;
  viral: ViralMetrics;
  engagement: EngagementMetrics;
}

interface Props {
  initialData?: ExecutiveMetrics;
  realtime?: boolean;
}

// Key functionality:
- Real-time metric updates via WebSocket
- Responsive grid layout for metric cards
- Trend indicators and growth percentages
- Drill-down capability for detailed views
- Export functionality for board reports
```

#### Integration Points
```typescript
// Service: MetricsAggregator
// Dependencies: Database connection, WebSocket service

class MetricsAggregator {
  async getExecutiveMetrics(): Promise<ExecutiveMetrics> {
    const [revenue, users, viral, engagement] = await Promise.all([
      this.calculateRevenue(),
      this.calculateUsers(),
      this.calculateViralMetrics(),
      this.calculateEngagement()
    ]);
    
    return { revenue, users, viral, engagement };
  }
  
  private async calculateRevenue() {
    // Query materialized views for performance
    const result = await supabase
      .from('revenue_metrics')
      .select('*')
      .order('month', { ascending: false })
      .limit(2);
    
    return this.processRevenueData(result.data);
  }
}
```

### CODE EXAMPLES

#### Example 1: Metrics Service Implementation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { createClient } from '@supabase/supabase-js';
import { cache } from 'react';

export class MetricsAggregator {
  private supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
  );

  // Cache for 5 minutes to reduce database load
  getExecutiveMetrics = cache(async (): Promise<ExecutiveMetrics> => {
    try {
      const [revenue, users, viral, engagement] = await Promise.all([
        this.calculateRevenue(),
        this.calculateUsers(),
        this.calculateViralMetrics(),
        this.calculateEngagement()
      ]);
      
      return { revenue, users, viral, engagement };
    } catch (error) {
      console.error('Error fetching executive metrics:', error);
      throw new Error('Failed to fetch metrics');
    }
  });
  
  private async calculateRevenue(): Promise<RevenueMetrics> {
    const { data: revenueData } = await this.supabase
      .from('revenue_metrics')
      .select('mrr, active_subscriptions, month')
      .order('month', { ascending: false })
      .limit(2);
    
    if (!revenueData?.length) {
      return { mrr: 0, arr: 0, growth: 0, churn: 0 };
    }
    
    const currentMonth = revenueData[0];
    const previousMonth = revenueData[1];
    
    const growth = previousMonth ? 
      ((currentMonth.mrr - previousMonth.mrr) / previousMonth.mrr) * 100 : 0;
    
    return {
      mrr: currentMonth.mrr,
      arr: currentMonth.mrr * 12,
      growth,
      churn: await this.calculateChurn()
    };
  }
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for Next.js App Router, Supabase
- [x] Playwright: Test admin dashboard functionality
- [x] PostgreSQL: Execute database queries and view creation

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/vercel/next.js", "app router server components", 3000);
await mcp__context7__get-library-docs("/supabase/supabase", "materialized views", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('MetricsAggregator', () => {
  it('should calculate revenue metrics correctly', async () => {
    const aggregator = new MetricsAggregator();
    const metrics = await aggregator.calculateRevenue();
    
    expect(metrics.mrr).toBeGreaterThanOrEqual(0);
    expect(metrics.arr).toBe(metrics.mrr * 12);
    expect(typeof metrics.growth).toBe('number');
  });
  
  it('should handle empty data gracefully', async () => {
    // Mock empty database response
    const metrics = await aggregator.getExecutiveMetrics();
    expect(metrics).toBeDefined();
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Executive dashboard loads and displays metrics', async () => {
  await mcp__playwright__browser_navigate({url: '/admin/metrics'});
  await mcp__playwright__browser_snapshot();
  
  // Verify metric cards are visible
  const mrrCard = await page.locator('[data-testid="mrr-metric"]');
  await expect(mrrCard).toBeVisible();
  
  // Test real-time updates
  await page.waitForSelector('[data-testid="last-updated"]');
});
```

### ACCEPTANCE CRITERIA
- [x] Dashboard loads within 2 seconds with cached data
- [x] Real-time updates occur every 30 seconds via WebSocket
- [x] All metrics display with proper formatting (currency, percentages)
- [x] Responsive design works on desktop and tablet
- [x] Export functionality generates PDF/CSV reports
- [x] Error handling shows graceful fallbacks
- [x] Admin authentication required to access
- [x] Drill-down views available for each metric category

### DEPENDENCIES
- Must complete after: WS-255 (Infrastructure setup)
- Must complete before: WS-227 (System Health monitoring)
- Shares code with: WS-343 (Admin Dashboard main overview)

### ESTIMATED EFFORT
- Team A Frontend: 16 hours
- Team B Backend: 12 hours
- Team C Integration: 4 hours
- Team D Platform: 0 hours
- Team E General: 8 hours
- Team F Workflows: 0 hours
- Team G Performance: 4 hours
- Total: 44 hours