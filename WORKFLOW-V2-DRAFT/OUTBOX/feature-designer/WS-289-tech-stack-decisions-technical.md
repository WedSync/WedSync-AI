# TECHNICAL SPECIFICATION: WS-289 - Tech Stack Decisions
## Generated by Feature Development Session - 2025-08-25

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Development Team Member / Technical Lead / DevOps Engineer
**I want to:** Understand the complete technology stack with rationale for each choice and implementation guidelines
**So that:** I can implement features using the correct technologies and make consistent architectural decisions

**Real Wedding Scenario:**
"A photographer needs to quickly build a form for collecting wedding timeline details. Using our chosen tech stack (Next.js + Supabase + React Hook Form + Zod), they can create a form with real-time validation, auto-population from core fields, and instant synchronization across all vendors - all while maintaining type safety and optimal performance."

### SPECIFICATION SOURCE
- **Feature ID:** WS-289
- **Original Spec:** /CORE-SPECIFICATIONS/00-PROJECT-OVERVIEW/04-tech-stack-decisions.md
- **Current Implementation:** 60% complete (Next.js setup, Supabase, basic Tailwind)
- **Files to Modify:**
  - /package.json
  - /tailwind.config.js
  - /next.config.ts
  - /tsconfig.json
- **New Files to Create:**
  - /docs/tech-stack-guide.md
  - /src/lib/config/stack-validation.ts
  - /scripts/stack-setup.sh
  - /.env.example

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Tech Stack Configuration Tracking
CREATE TABLE IF NOT EXISTS tech_stack_metrics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  component VARCHAR(50) NOT NULL, -- 'nextjs', 'supabase', 'openai', etc.
  version VARCHAR(20) NOT NULL,
  performance_target JSONB,
  actual_performance JSONB,
  cost_target DECIMAL,
  actual_cost DECIMAL,
  last_updated TIMESTAMP DEFAULT NOW(),
  
  UNIQUE(component)
);

-- Insert initial tech stack components
INSERT INTO tech_stack_metrics (component, version, performance_target, cost_target) VALUES
('nextjs', '15.4.3', '{"lcp": 2500, "fid": 100, "cls": 0.1}', 20),
('supabase', 'latest', '{"query_time": 50, "uptime": 99.9}', 25),
('vercel', 'latest', '{"build_time": 120, "cold_start": 100}', 20),
('openai', 'gpt-4', '{"response_time": 2000, "accuracy": 95}', 100),
('tailwind', '4.1.11', '{"css_size": 50, "build_time": 5}', 0);

-- Performance monitoring table
CREATE TABLE IF NOT EXISTS performance_metrics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  metric_name VARCHAR(100) NOT NULL,
  target_value DECIMAL NOT NULL,
  actual_value DECIMAL,
  measurement_unit VARCHAR(20),
  measured_at TIMESTAMP DEFAULT NOW(),
  component VARCHAR(50),
  
  CONSTRAINT fk_component FOREIGN KEY (component) 
    REFERENCES tech_stack_metrics(component)
);
```

#### API Endpoints Required
```typescript
// Tech Stack Monitoring API
interface TechStackAPI {
  // GET /api/v1/tech-stack/status
  getStackStatus(): Promise<TechStackStatus>;
  
  // GET /api/v1/tech-stack/performance
  getPerformanceMetrics(): Promise<PerformanceMetrics>;
  
  // POST /api/v1/tech-stack/validate
  validateStackConfiguration(): Promise<ValidationResult>;
  
  // GET /api/v1/tech-stack/costs
  getCostAnalysis(): Promise<CostAnalysis>;
}

interface TechStackStatus {
  components: {
    nextjs: ComponentStatus;
    react: ComponentStatus;
    supabase: ComponentStatus;
    tailwind: ComponentStatus;
    openai: ComponentStatus;
    stripe: ComponentStatus;
    vercel: ComponentStatus;
  };
  overall_health: 'healthy' | 'warning' | 'critical';
  last_checked: string;
}

interface ComponentStatus {
  version: string;
  status: 'active' | 'deprecated' | 'updating';
  performance_score: number;
  cost_efficiency: number;
  issues?: string[];
}

interface PerformanceMetrics {
  core_web_vitals: {
    lcp: number; // Target: < 2.5s
    fid: number; // Target: < 100ms
    cls: number; // Target: < 0.1
  };
  application_metrics: {
    time_to_interactive: number; // Target: < 3s
    api_response_time: number; // Target: < 200ms
    database_query_time: number; // Target: < 50ms
  };
}
```

#### Frontend Components Required
```typescript
// Component: TechStackDashboard
// Location: /src/components/admin/TechStackDashboard.tsx

interface Props {
  showPerformance?: boolean;
  showCosts?: boolean;
  updateInterval?: number;
}

// Key functionality:
- Real-time tech stack health monitoring
- Performance metrics visualization
- Cost analysis and optimization suggestions
- Version update notifications
- Stack validation reports

// Component: StackConfigValidator
// Location: /src/components/dev/StackConfigValidator.tsx

interface Props {
  environment: 'development' | 'staging' | 'production';
  onValidationComplete: (results: ValidationResult[]) => void;
}

// Key functionality:
- Validate all environment variables
- Check package version compatibility
- Verify integration configurations
- Performance benchmark validation
```

#### Integration Points
```typescript
// Service: TechStackService
// Dependencies: Package.json, environment variables, external APIs

class TechStackService {
  async validateEnvironment(): Promise<ValidationResult> {
    const results = [];
    
    // Validate core dependencies
    results.push(await this.validateNextJs());
    results.push(await this.validateSupabase());
    results.push(await this.validateOpenAI());
    results.push(await this.validateStripe());
    
    return {
      overall_status: results.every(r => r.status === 'valid') ? 'valid' : 'invalid',
      component_results: results
    };
  }
  
  async validateNextJs(): Promise<ComponentValidation> {
    const packageJson = await import('../../../../package.json');
    const nextVersion = packageJson.dependencies.next;
    
    return {
      component: 'nextjs',
      status: this.compareVersions(nextVersion, '15.4.3') >= 0 ? 'valid' : 'outdated',
      current_version: nextVersion,
      target_version: '15.4.3',
      recommendations: ['Update to latest Next.js 15 for App Router features']
    };
  }
  
  async validateSupabase(): Promise<ComponentValidation> {
    const url = process.env.NEXT_PUBLIC_SUPABASE_URL;
    const anonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;
    
    if (!url || !anonKey) {
      return {
        component: 'supabase',
        status: 'invalid',
        error: 'Missing required Supabase environment variables'
      };
    }
    
    // Test connection
    try {
      const { createClient } = await import('@supabase/supabase-js');
      const supabase = createClient(url, anonKey);
      const { data, error } = await supabase.from('suppliers').select('count').limit(1);
      
      return {
        component: 'supabase',
        status: error ? 'invalid' : 'valid',
        connection_test: !error
      };
    } catch (error) {
      return {
        component: 'supabase',
        status: 'invalid',
        error: 'Supabase connection failed'
      };
    }
  }
}

// Service: PerformanceMonitor
// Dependencies: Web Vitals, API monitoring

class PerformanceMonitor {
  async measureCoreWebVitals(): Promise<CoreWebVitals> {
    return new Promise((resolve) => {
      import('web-vitals').then(({ getCLS, getFID, getLCP }) => {
        const metrics = { lcp: 0, fid: 0, cls: 0 };
        
        getLCP((metric) => {
          metrics.lcp = metric.value;
        });
        
        getFID((metric) => {
          metrics.fid = metric.value;
        });
        
        getCLS((metric) => {
          metrics.cls = metric.value;
          resolve(metrics);
        });
      });
    });
  }
  
  async validatePerformanceTargets(): Promise<PerformanceValidation> {
    const metrics = await this.measureCoreWebVitals();
    
    return {
      lcp: {
        value: metrics.lcp,
        target: 2500,
        status: metrics.lcp < 2500 ? 'pass' : 'fail'
      },
      fid: {
        value: metrics.fid,
        target: 100,
        status: metrics.fid < 100 ? 'pass' : 'fail'
      },
      cls: {
        value: metrics.cls,
        target: 0.1,
        status: metrics.cls < 0.1 ? 'pass' : 'fail'
      }
    };
  }
}
```

### CODE EXAMPLES

#### Example 1: Stack Setup Validation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { z } from 'zod';

// Environment validation schema
const envSchema = z.object({
  // Supabase
  NEXT_PUBLIC_SUPABASE_URL: z.string().url(),
  NEXT_PUBLIC_SUPABASE_ANON_KEY: z.string().min(1),
  SUPABASE_SERVICE_ROLE_KEY: z.string().min(1),
  
  // OpenAI
  OPENAI_API_KEY: z.string().startsWith('sk-'),
  
  // Stripe
  STRIPE_SECRET_KEY: z.string().startsWith('sk_'),
  STRIPE_WEBHOOK_SECRET: z.string().startsWith('whsec_'),
  
  // Twilio
  TWILIO_ACCOUNT_SID: z.string().startsWith('AC'),
  TWILIO_AUTH_TOKEN: z.string().min(1),
  
  // Resend
  RESEND_API_KEY: z.string().startsWith('re_'),
});

export function validateTechStack() {
  const validation = envSchema.safeParse(process.env);
  
  if (!validation.success) {
    console.error('❌ Tech Stack Validation Failed:');
    validation.error.issues.forEach(issue => {
      console.error(`  - ${issue.path.join('.')}: ${issue.message}`);
    });
    process.exit(1);
  }
  
  console.log('✅ Tech Stack Validation Passed');
  return validation.data;
}

// Usage in app startup
export default function RootLayout() {
  // Validate stack configuration on startup
  useEffect(() => {
    if (process.env.NODE_ENV === 'development') {
      validateTechStack();
    }
  }, []);
  
  return (
    // App layout
  );
}
```

#### Example 2: Performance Monitoring Setup
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { getCLS, getFID, getLCP } from 'web-vitals';

export function initPerformanceMonitoring() {
  // Core Web Vitals monitoring
  getCLS((metric) => {
    sendToAnalytics('CLS', metric.value, {
      target: 0.1,
      status: metric.value < 0.1 ? 'pass' : 'fail'
    });
  });
  
  getFID((metric) => {
    sendToAnalytics('FID', metric.value, {
      target: 100,
      status: metric.value < 100 ? 'pass' : 'fail'
    });
  });
  
  getLCP((metric) => {
    sendToAnalytics('LCP', metric.value, {
      target: 2500,
      status: metric.value < 2500 ? 'pass' : 'fail'
    });
  });
}

async function sendToAnalytics(metric: string, value: number, meta: any) {
  await fetch('/api/analytics/performance', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      metric,
      value,
      timestamp: Date.now(),
      url: window.location.pathname,
      ...meta
    })
  });
}

// Component-level performance tracking
export function withPerformanceTracking<P extends object>(
  Component: React.ComponentType<P>,
  componentName: string
) {
  return function PerformanceTrackedComponent(props: P) {
    const startTime = performance.now();
    
    useEffect(() => {
      const endTime = performance.now();
      const renderTime = endTime - startTime;
      
      if (renderTime > 16) { // 60fps threshold
        console.warn(`Slow render detected: ${componentName} took ${renderTime}ms`);
      }
    }, []);
    
    return <Component {...props} />;
  };
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [ ] Context7: Load docs for Next.js 15, Supabase, React 19
- [ ] Filesystem: Tech stack configuration files
- [ ] GitHub: Repository configuration management

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/vercel/next.js", "app router configuration", 3000);
await mcp__context7__get-library-docs("/supabase/supabase", "client configuration", 2000);
await mcp__context7__get-library-docs("/tailwindcss/tailwindcss", "configuration", 1500);
await mcp__context7__get-library-docs("/openai/openai-node", "configuration", 1000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('Tech Stack Configuration', () => {
  it('should validate all required environment variables', () => {
    const validator = new TechStackService();
    // Test environment variable validation
  });
  
  it('should meet all performance targets', async () => {
    const monitor = new PerformanceMonitor();
    const metrics = await monitor.validatePerformanceTargets();
    // Test Core Web Vitals meet targets
  });
  
  it('should initialize all services correctly', () => {
    // Test Supabase, OpenAI, Stripe, Twilio connections
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Tech stack performs within targets', async () => {
  await mcp__playwright__browser_navigate({url: '/'});
  
  // Measure performance
  const performance = await page.evaluate(() => {
    return performance.getEntriesByType('navigation')[0];
  });
  
  // Verify performance targets
  expect(performance.loadEventEnd - performance.loadEventStart).toBeLessThan(3000);
  
  await mcp__playwright__browser_snapshot();
});
```

### ACCEPTANCE CRITERIA
- [ ] All tech stack components properly configured and validated
- [ ] Environment variables schema validation implemented
- [ ] Performance targets met (LCP < 2.5s, FID < 100ms, CLS < 0.1)
- [ ] Cost targets documented and tracked
- [ ] Migration path defined for scaling
- [ ] Developer environment setup documented
- [ ] Stack health monitoring implemented
- [ ] Component compatibility verified
- [ ] Security considerations implemented

### DEPENDENCIES
- Must complete after: Solution architecture (WS-288)
- Must complete before: Technical architecture (WS-293)
- Shares code with: All technical features requiring specific stack components

### ESTIMATED EFFORT
- Team A Frontend: 8 hours (tech stack dashboard, validation UI)
- Team B Backend: 12 hours (stack validation API, performance monitoring)
- Team C Integration: 16 hours (environment setup, service integrations)
- Team D Platform: 4 hours (performance optimization)
- Team E General: 10 hours (documentation, setup scripts)
- Team F Workflows: 6 hours (CI/CD integration)
- Team G Performance: 8 hours (performance testing and validation)
- Total: 64 hours