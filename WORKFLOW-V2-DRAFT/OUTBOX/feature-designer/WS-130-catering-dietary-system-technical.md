# TECHNICAL SPECIFICATION: WS-130 - Catering Dietary System
## Generated by Feature Development Session - 2025-01-23

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding caterer managing 30+ events per year with complex dietary requirements
**I want to:** Analyze guest dietary needs, generate compliant menus, and avoid dangerous allergen exposure
**So that:** I eliminate the risk of medical emergencies and deliver inclusive dining experiences for all guests

**Real Wedding Scenario:**
A couple has 120 wedding guests with 15 vegetarians, 8 vegans, 5 people with nut allergies, 3 with celiac disease, and 2 with shellfish allergies. Instead of spending 6+ hours manually cross-referencing ingredients and calling suppliers about allergen contamination, the caterer uploads their planned menu and the AI identifies all conflicts, suggests safe alternatives, calculates exact portions needed, and generates prep lists with allergen-free preparation zones.

### SPECIFICATION SOURCE
- **Feature ID:** WS-130
- **Original Spec:** /CORE-SPECIFICATIONS/04-AI-INTEGRATION/05-Vendor-Specific/04-catering-dietary md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** None (new feature)
- **New Files to Create:**
  - /src/lib/catering/dietary-analyzer.ts
  - /src/lib/catering/menu-generator.ts
  - /src/lib/catering/ingredient-intelligence.ts
  - /src/lib/catering/portion-calculator.ts
  - /src/app/api/catering/menu/generate/route.ts
  - /src/app/api/catering/dietary/analyze/route.ts
  - /src/app/api/catering/portions/calculate/route.ts
  - /src/components/catering/MenuPlannerInterface.tsx
  - /src/components/catering/DietaryConflictAlert.tsx
  - /src/components/catering/PortionCalculator.tsx

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Core menu items with dietary information
CREATE TABLE IF NOT EXISTS catering_menu_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID REFERENCES user_profiles(id),
  name TEXT NOT NULL,
  description TEXT,
  category TEXT NOT NULL CHECK (category IN ('appetizer', 'salad', 'soup', 'entree', 'side', 'dessert', 'beverage')),
  ingredients JSONB NOT NULL, -- {name: string, amount: string, allergens: string[]}[]
  allergens TEXT[] DEFAULT '{}',
  dietary_tags TEXT[] DEFAULT '{}', -- 'vegan', 'vegetarian', 'gluten-free', 'dairy-free', etc
  prep_time_minutes INTEGER,
  base_portions INTEGER DEFAULT 10,
  cost_per_portion DECIMAL(8,2),
  prep_instructions TEXT,
  allergen_warnings TEXT,
  cross_contamination_risk TEXT[] DEFAULT '{}',
  nutritional_info JSONB DEFAULT '{}',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Guest dietary requirements for weddings
CREATE TABLE IF NOT EXISTS wedding_dietary_requirements (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  wedding_id UUID,
  supplier_id UUID REFERENCES user_profiles(id),
  guest_count INTEGER NOT NULL,
  dietary_breakdown JSONB NOT NULL, -- {vegan: 8, vegetarian: 15, gluten_free: 3, ...}
  allergen_list JSONB NOT NULL, -- {nuts: {count: 5, severity: 'severe'}, ...}
  special_requests TEXT[],
  medical_considerations TEXT,
  cultural_requirements TEXT[],
  created_at TIMESTAMP DEFAULT NOW()
);

-- AI-generated menu proposals
CREATE TABLE IF NOT EXISTS menu_proposals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  wedding_id UUID,
  supplier_id UUID REFERENCES user_profiles(id),
  guest_count INTEGER,
  dietary_requirements_id UUID REFERENCES wedding_dietary_requirements(id),
  proposed_menu JSONB NOT NULL, -- {courses: [{name, items: [{id, portions, modifications}]}]}
  ai_confidence_score DECIMAL(3,2),
  dietary_compliance_score DECIMAL(3,2),
  cost_estimate DECIMAL(10,2),
  prep_timeline_hours INTEGER,
  allergen_safety_validated BOOLEAN DEFAULT false,
  human_reviewed BOOLEAN DEFAULT false,
  approved BOOLEAN DEFAULT false,
  modifications JSONB DEFAULT '{}',
  created_at TIMESTAMP DEFAULT NOW()
);

-- Ingredient substitution database
CREATE TABLE IF NOT EXISTS ingredient_substitutions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  original_ingredient TEXT NOT NULL,
  substitute_ingredient TEXT NOT NULL,
  dietary_benefit TEXT, -- 'gluten-free', 'vegan', 'nut-free'
  conversion_ratio DECIMAL(5,2) DEFAULT 1.0,
  flavor_impact TEXT, -- 'neutral', 'mild_change', 'significant_change'
  cost_multiplier DECIMAL(4,2) DEFAULT 1.0,
  availability_rating INTEGER DEFAULT 5, -- 1-5 scale
  supplier_notes TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Allergen cross-contamination tracking
CREATE TABLE IF NOT EXISTS allergen_contamination_risks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  facility_equipment TEXT NOT NULL, -- 'oven', 'fryer', 'prep_surface', 'utensils'
  allergen_type TEXT NOT NULL,
  contamination_risk TEXT NOT NULL CHECK (contamination_risk IN ('low', 'medium', 'high', 'severe')),
  cleaning_protocol TEXT,
  separation_requirements TEXT,
  safe_for_allergens TEXT[] DEFAULT '{}',
  created_at TIMESTAMP DEFAULT NOW()
);

-- Portion and cost calculations
CREATE TABLE IF NOT EXISTS portion_calculations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  menu_proposal_id UUID REFERENCES menu_proposals(id),
  item_id UUID REFERENCES catering_menu_items(id),
  base_portions INTEGER,
  scaling_factor DECIMAL(4,2),
  final_portions INTEGER,
  ingredient_costs JSONB, -- {ingredient: {amount, cost, supplier}}
  labor_cost_estimate DECIMAL(8,2),
  total_item_cost DECIMAL(8,2),
  waste_buffer_percentage INTEGER DEFAULT 10,
  calculated_at TIMESTAMP DEFAULT NOW()
);
```

#### API Endpoints Required
```typescript
// POST /api/catering/menu/generate
interface MenuGenerationRequest {
  guestCount: number;
  dietaryRequirements: {
    [key: string]: number; // 'vegan': 8, 'vegetarian': 15
  };
  allergenList: {
    [key: string]: {
      count: number;
      severity: 'mild' | 'moderate' | 'severe';
    };
  };
  budgetPerPerson?: number;
  eventStyle: 'formal' | 'casual' | 'cocktail' | 'buffet' | 'plated';
  mealType: 'lunch' | 'dinner' | 'brunch';
  culturalRequirements?: string[];
}

interface MenuGenerationResponse {
  success: boolean;
  data: {
    menuProposal: {
      id: string;
      courses: Course[];
      totalCost: number;
      complianceScore: number;
      allergenWarnings: AllergenWarning[];
    };
    alternatives: MenuAlternative[];
    recommendedModifications: string[];
  };
}

// POST /api/catering/dietary/analyze
interface DietaryAnalysisRequest {
  menuItems: MenuItemInput[];
  guestRequirements: DietaryRequirement[];
  strictnessLevel: 'accommodating' | 'strict' | 'medical-grade';
}

interface DietaryAnalysisResponse {
  success: boolean;
  data: {
    conflicts: DietaryConflict[];
    safeItems: SafeItem[];
    recommendations: Recommendation[];
    crossContaminationRisks: ContaminationRisk[];
  };
}

// POST /api/catering/portions/calculate
interface PortionCalculationRequest {
  menuProposal: string; // Menu proposal ID
  guestCount: number;
  bufferPercentage?: number;
  servingStyle: 'buffet' | 'plated' | 'family-style';
}
```

#### Frontend Components Required
```typescript
// Component: MenuPlannerInterface
// Location: /src/components/catering/MenuPlannerInterface.tsx

interface MenuPlannerProps {
  wedding: WeddingContext;
  onMenuGenerated: (menu: MenuProposal) => void;
  existingRequirements?: DietaryRequirements;
}

interface DietaryRequirement {
  type: 'vegetarian' | 'vegan' | 'gluten-free' | 'dairy-free' | 'nut-free' | 'kosher' | 'halal';
  guestCount: number;
  severity?: 'preference' | 'medical' | 'religious';
  notes?: string;
}

interface AllergenWarning {
  allergen: string;
  affectedGuests: number;
  severity: 'mild' | 'moderate' | 'severe';
  menuItems: string[];
  recommendations: string[];
}

interface MenuProposal {
  id: string;
  courses: Course[];
  totalGuests: number;
  dietaryCompliance: number;
  estimatedCost: number;
  prepTime: number;
  allergenWarnings: AllergenWarning[];
  ingredientSources: IngredientSource[];
}

// Key functionality:
- AI-powered menu generation based on dietary constraints
- Real-time dietary conflict detection and alerts
- Ingredient substitution suggestions
- Portion and cost calculations with waste buffer
- Cross-contamination risk assessment
- Allergen severity tracking and warnings
```

#### Integration Points
```typescript
// Service: CateringDietarySystem
// Dependencies: OpenAI, Menu database, Ingredient intelligence, Allergen database

class CateringDietarySystem {
  async generateCompliantMenu(requirements: MenuGenerationRequest): Promise<MenuProposal> {
    // Step 1: Analyze dietary constraints and guest breakdown
    // Step 2: Query ingredient database for compliant options
    // Step 3: Use AI to generate creative menu combinations
    // Step 4: Validate against allergen database
    // Step 5: Calculate portions and costs with buffer
    // Step 6: Assess cross-contamination risks
  }
  
  async analyzeMenuCompliance(menu: MenuItemInput[], requirements: DietaryRequirement[]): Promise<ComplianceReport> {
    // Comprehensive dietary analysis with medical-grade accuracy
    // Cross-contamination risk assessment
    // Alternative ingredient suggestions
  }
}
```

### CODE EXAMPLES

#### Example 1: AI-Powered Menu Generation with Dietary Analysis
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { OpenAI } from 'openai';
import { supabase } from '@/lib/supabase';

interface DietaryConstraints {
  vegetarian: number;
  vegan: number;
  glutenFree: number;
  dairyFree: number;
  nutFree: number;
  kosher: number;
  halal: number;
  allergens: {
    [key: string]: {
      count: number;
      severity: 'mild' | 'moderate' | 'severe';
    };
  };
}

export class CateringDietarySystem {
  private openai: OpenAI;
  private allergenDatabase: AllergenDatabase;
  
  constructor() {
    this.openai = new OpenAI({
      apiKey: process.env.OPENAI_API_KEY
    });
    this.allergenDatabase = new AllergenDatabase();
  }

  async generateCompliantMenu(
    guestCount: number,
    dietaryConstraints: DietaryConstraints,
    eventDetails: EventDetails
  ): Promise<MenuProposal> {
    // Step 1: Calculate dietary percentages
    const dietaryBreakdown = this.calculateDietaryPercentages(guestCount, dietaryConstraints);
    
    // Step 2: Generate AI menu proposal
    const aiPrompt = this.constructMenuPrompt(dietaryBreakdown, eventDetails);
    const menuResponse = await this.openai.chat.completions.create({
      model: 'gpt-4',
      messages: [{
        role: 'system',
        content: `You are a professional wedding caterer with 15+ years experience. 
        You specialize in inclusive menus that accommodate all dietary needs safely.
        Always prioritize food safety and allergen management over taste preferences.
        Consider cross-contamination risks in your recommendations.`
      }, {
        role: 'user',
        content: aiPrompt
      }],
      response_format: { type: 'json_object' },
      temperature: 0.4
    });

    const proposedMenu = JSON.parse(menuResponse.choices[0].message.content);

    // Step 3: Validate against allergen database
    const validationResults = await this.validateMenuSafety(
      proposedMenu,
      dietaryConstraints.allergens
    );

    // Step 4: Calculate portions and costs
    const portionCalculations = await this.calculatePortionsAndCosts(
      proposedMenu,
      guestCount,
      dietaryBreakdown
    );

    return {
      id: crypto.randomUUID(),
      menu: proposedMenu,
      validation: validationResults,
      portions: portionCalculations,
      complianceScore: this.calculateComplianceScore(validationResults),
      estimatedCost: portionCalculations.totalCost,
      allergenWarnings: validationResults.warnings
    };
  }

  private constructMenuPrompt(
    dietaryBreakdown: DietaryBreakdown,
    eventDetails: EventDetails
  ): string {
    return `
Create a wedding menu for ${eventDetails.guestCount} guests:

DIETARY REQUIREMENTS:
- ${dietaryBreakdown.vegan} vegan guests (${dietaryBreakdown.veganPercentage}%)
- ${dietaryBreakdown.vegetarian} vegetarian guests (${dietaryBreakdown.vegetarianPercentage}%)
- ${dietaryBreakdown.glutenFree} gluten-free guests (${dietaryBreakdown.glutenFreePercentage}%)
- ${dietaryBreakdown.dairyFree} dairy-free guests (${dietaryBreakdown.dairyFreePercentage}%)

CRITICAL ALLERGENS:
${Object.entries(dietaryBreakdown.allergens)
  .filter(([_, data]) => data.severity === 'severe')
  .map(([allergen, data]) => `- ${allergen}: ${data.count} guests (SEVERE - NO CROSS-CONTAMINATION)`)
  .join('\n')}

EVENT DETAILS:
- Style: ${eventDetails.style}
- Service: ${eventDetails.serviceStyle}
- Budget per person: $${eventDetails.budgetPerPerson}
- Season: ${eventDetails.season}

REQUIREMENTS:
1. Create 3 courses (appetizer, entree, dessert)
2. Each course must have options for ALL dietary needs
3. Identify ALL ingredients and potential allergens
4. Suggest preparation zones to avoid cross-contamination
5. Calculate realistic portions per dietary group
6. Include ingredient substitution options

Return JSON with this structure:
{
  "courses": [
    {
      "name": "Appetizer Course",
      "options": [
        {
          "name": "Dish Name",
          "ingredients": ["ingredient1", "ingredient2"],
          "allergens": ["gluten", "dairy"],
          "dietaryTags": ["vegetarian"],
          "servesGroups": ["omnivore", "vegetarian"],
          "prepNotes": "Prep in dedicated gluten-free zone",
          "portionSize": "2 pieces per person"
        }
      ]
    }
  ],
  "totalEstimatedCost": 4500,
  "prepTimeHours": 8,
  "equipmentNeeded": ["dedicated fryer", "separate prep surfaces"],
  "safetyNotes": ["Use separate utensils for nut-free items"]
}`;
  }

  async validateMenuSafety(
    menu: MenuProposal,
    allergenConstraints: AllergenConstraints
  ): Promise<ValidationResults> {
    const warnings: AllergenWarning[] = [];
    const conflicts: DietaryConflict[] = [];

    for (const course of menu.courses) {
      for (const dish of course.options) {
        // Check each dish against allergen constraints
        for (const [allergen, constraint] of Object.entries(allergenConstraints)) {
          if (constraint.severity === 'severe') {
            const hasAllergen = this.allergenDatabase.containsAllergen(
              dish.ingredients,
              allergen
            );
            
            if (hasAllergen) {
              warnings.push({
                allergen,
                dishName: dish.name,
                affectedGuests: constraint.count,
                severity: constraint.severity,
                recommendation: await this.suggestAllergenFreeAlternative(dish, allergen)
              });
            }

            // Check cross-contamination risk
            const crossContamRisk = await this.assessCrossContaminationRisk(
              dish,
              allergen,
              menu.courses
            );
            
            if (crossContamRisk.level === 'high') {
              conflicts.push({
                type: 'cross_contamination',
                allergen,
                riskLevel: 'high',
                affectedDishes: crossContamRisk.affectedDishes,
                mitigation: crossContamRisk.mitigationSteps
              });
            }
          }
        }
      }
    }

    return { warnings, conflicts, isCompliant: warnings.length === 0 };
  }

  async calculatePortionsAndCosts(
    menu: MenuProposal,
    totalGuests: number,
    dietaryBreakdown: DietaryBreakdown
  ): Promise<PortionCalculations> {
    const calculations = {
      totalCost: 0,
      itemizedCosts: [] as ItemCost[],
      wasteBuffer: 1.15, // 15% buffer for wedding catering
      prepTime: 0
    };

    for (const course of menu.courses) {
      for (const dish of course.options) {
        // Calculate how many guests will eat this dish
        const estimatedPortions = this.estimatePortionsNeeded(
          dish,
          dietaryBreakdown,
          totalGuests
        );

        // Scale ingredients based on portions
        const ingredientCosts = await this.calculateIngredientCosts(
          dish.ingredients,
          estimatedPortions * calculations.wasteBuffer
        );

        const laborCost = this.calculateLaborCost(
          dish.prepTime,
          dish.complexity
        );

        const itemTotal = ingredientCosts.total + laborCost;
        
        calculations.totalCost += itemTotal;
        calculations.itemizedCosts.push({
          dishName: dish.name,
          portions: Math.ceil(estimatedPortions * calculations.wasteBuffer),
          ingredientCost: ingredientCosts.total,
          laborCost,
          totalCost: itemTotal,
          breakdown: ingredientCosts.breakdown
        });
      }
    }

    return calculations;
  }

  private estimatePortionsNeeded(
    dish: MenuDish,
    dietaryBreakdown: DietaryBreakdown,
    totalGuests: number
  ): number {
    let estimatedEaters = 0;

    // Calculate who can eat this dish based on dietary tags
    if (dish.dietaryTags.includes('vegan')) {
      estimatedEaters += dietaryBreakdown.vegan + dietaryBreakdown.vegetarian * 0.3;
    }
    if (dish.dietaryTags.includes('vegetarian')) {
      estimatedEaters += dietaryBreakdown.vegetarian;
    }
    if (dish.dietaryTags.includes('gluten-free')) {
      estimatedEaters += dietaryBreakdown.glutenFree;
    }
    
    // Add omnivore guests who can eat everything
    const omnivoreGuests = totalGuests - (
      dietaryBreakdown.vegan + 
      dietaryBreakdown.vegetarian + 
      dietaryBreakdown.glutenFree
    );
    
    // Assume 70% of omnivores will try vegetarian options
    if (dish.dietaryTags.includes('vegetarian')) {
      estimatedEaters += omnivoreGuests * 0.7;
    } else {
      estimatedEaters += omnivoreGuests;
    }

    return Math.min(estimatedEaters, totalGuests); // Cap at total guests
  }
}

// Ingredient intelligence with allergen detection
class AllergenDatabase {
  private allergenMap = {
    nuts: {
      primary: ['almonds', 'walnuts', 'pecans', 'cashews', 'pistachios', 'hazelnuts', 'brazil nuts', 'macadamias'],
      hidden: ['marzipan', 'nougat', 'praline', 'frangipane', 'gianduja', 'satay sauce', 'pesto'],
      crossContamination: ['oats processed in nut facilities', 'chocolate processed on nut equipment']
    },
    shellfish: {
      primary: ['shrimp', 'lobster', 'crab', 'scallops', 'mussels', 'clams', 'oysters', 'crawfish'],
      hidden: ['worcestershire sauce', 'caesar dressing', 'bouillabaisse', 'paella', 'jambalaya'],
      crossContamination: ['fish processed in shellfish facilities']
    },
    dairy: {
      primary: ['milk', 'cheese', 'butter', 'cream', 'yogurt', 'ice cream'],
      hidden: ['whey', 'casein', 'lactose', 'ghee', 'caramel', 'nougat', 'some margarines'],
      crossContamination: ['bread made with dairy equipment', 'chocolate processed on dairy lines']
    },
    gluten: {
      primary: ['wheat', 'barley', 'rye', 'spelt', 'triticale'],
      hidden: ['soy sauce', 'malt vinegar', 'beer', 'seitan', 'modified food starch', 'some seasonings'],
      crossContamination: ['oats processed in wheat facilities', 'fryer oil used for breaded items']
    },
    eggs: {
      primary: ['eggs', 'egg whites', 'egg yolks'],
      hidden: ['mayonnaise', 'meringue', 'custard', 'hollandaise', 'some pastas', 'lecithin'],
      crossContamination: ['bakery items made in facilities processing eggs']
    }
  };

  containsAllergen(ingredients: string[], allergen: string): boolean {
    const allergenData = this.allergenMap[allergen];
    if (!allergenData) return false;

    const allAllergens = [
      ...allergenData.primary,
      ...allergenData.hidden,
      ...allergenData.crossContamination
    ];

    return ingredients.some(ingredient => 
      allAllergens.some(allergenItem => 
        ingredient.toLowerCase().includes(allergenItem.toLowerCase())
      )
    );
  }

  async suggestSubstitutions(
    ingredient: string,
    avoidAllergen: string
  ): Promise<IngredientSubstitution[]> {
    const substitutions = {
      dairy: {
        'butter': [
          { substitute: 'vegan butter', ratio: 1.0, flavorImpact: 'minimal', cost: 1.3 },
          { substitute: 'coconut oil', ratio: 0.75, flavorImpact: 'mild coconut', cost: 1.1 },
          { substitute: 'olive oil', ratio: 0.75, flavorImpact: 'savory', cost: 1.2 }
        ],
        'milk': [
          { substitute: 'oat milk', ratio: 1.0, flavorImpact: 'slightly sweet', cost: 1.4 },
          { substitute: 'almond milk', ratio: 1.0, flavorImpact: 'nutty', cost: 1.3 },
          { substitute: 'coconut milk', ratio: 1.0, flavorImpact: 'tropical', cost: 1.5 }
        ],
        'cheese': [
          { substitute: 'nutritional yeast', ratio: 0.25, flavorImpact: 'nutty', cost: 2.0 },
          { substitute: 'cashew cream', ratio: 0.75, flavorImpact: 'creamy', cost: 2.5 }
        ]
      },
      gluten: {
        'flour': [
          { substitute: 'almond flour', ratio: 0.8, flavorImpact: 'nutty', cost: 3.0 },
          { substitute: 'rice flour', ratio: 1.0, flavorImpact: 'neutral', cost: 1.8 },
          { substitute: 'gluten-free flour blend', ratio: 1.0, flavorImpact: 'minimal', cost: 2.2 }
        ]
      },
      eggs: {
        'eggs': [
          { substitute: 'flax eggs (1 tbsp ground flax + 3 tbsp water per egg)', ratio: 1.0, flavorImpact: 'earthy', cost: 1.1 },
          { substitute: 'aquafaba (3 tbsp per egg)', ratio: 1.0, flavorImpact: 'neutral', cost: 0.8 }
        ]
      }
    };

    return substitutions[avoidAllergen]?.[ingredient.toLowerCase()] || [];
  }
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [ ] Context7: Load nutrition and allergen databases
- [ ] Playwright: Test dietary analysis interface and menu builders
- [ ] Filesystem: Access menu templates and ingredient databases

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/openai/openai-node", "structured output for menu generation", 3000);
await mcp__context7__get-library-docs("/usda/food-data-central", "nutritional information API", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('CateringDietarySystem', () => {
  it('should detect severe allergen conflicts in menu items', async () => {
    const menuItems = [{
      name: 'Walnut-Crusted Salmon',
      ingredients: ['salmon', 'walnuts', 'breadcrumbs', 'herbs']
    }];
    const requirements = [{
      type: 'nut-free',
      guestCount: 5,
      severity: 'severe'
    }];
    
    const analysis = await dietarySystem.analyzeMenuCompliance(menuItems, requirements);
    
    expect(analysis.conflicts).toHaveLength(1);
    expect(analysis.conflicts[0].allergen).toBe('nuts');
    expect(analysis.isCompliant).toBe(false);
  });

  it('should generate compliant menu for multiple dietary restrictions', async () => {
    const constraints = {
      vegetarian: 20,
      vegan: 8,
      glutenFree: 5,
      allergens: {
        nuts: { count: 3, severity: 'severe' }
      }
    };
    
    const menu = await dietarySystem.generateCompliantMenu(100, constraints, eventDetails);
    
    expect(menu.complianceScore).toBeGreaterThan(0.9);
    expect(menu.allergenWarnings.filter(w => w.severity === 'severe')).toHaveLength(0);
    expect(menu.courses).toHaveLength(3);
  });

  it('should calculate accurate portions with dietary breakdown', async () => {
    const dietaryBreakdown = {
      vegan: 10,
      vegetarian: 15,
      glutenFree: 8,
      omnivore: 67
    };
    
    const calculations = await dietarySystem.calculatePortionsAndCosts(
      sampleMenu, 
      100, 
      dietaryBreakdown
    );
    
    expect(calculations.totalCost).toBeGreaterThan(0);
    expect(calculations.itemizedCosts).toHaveLength.greaterThan(0);
    expect(calculations.wasteBuffer).toBe(1.15);
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Complete dietary analysis and menu generation workflow', async () => {
  await mcp__playwright__browser_navigate({url: '/catering/menu-planner'});
  
  // Input guest count and dietary requirements
  await mcp__playwright__browser_type({
    element: 'Guest Count Input',
    ref: 'input[name="guestCount"]',
    text: '150'
  });
  
  // Add dietary restrictions
  await mcp__playwright__browser_click({element: 'Add Dietary Restriction', ref: 'button.add-dietary'});
  await mcp__playwright__browser_select_option({
    element: 'Dietary Type Select',
    ref: 'select[name="dietaryType"]',
    values: ['vegan']
  });
  
  await mcp__playwright__browser_type({
    element: 'Dietary Count Input',
    ref: 'input[name="dietaryCount"]',
    text: '12'
  });
  
  // Add severe allergen
  await mcp__playwright__browser_click({element: 'Add Allergen', ref: 'button.add-allergen'});
  await mcp__playwright__browser_select_option({
    element: 'Allergen Type Select',
    ref: 'select[name="allergenType"]',
    values: ['nuts']
  });
  
  await mcp__playwright__browser_select_option({
    element: 'Severity Select',
    ref: 'select[name="severity"]',
    values: ['severe']
  });
  
  // Generate menu
  await mcp__playwright__browser_click({element: 'Generate Menu', ref: 'button.generate-menu'});
  await mcp__playwright__browser_wait_for({text: 'Menu Generated'});
  
  // Verify no severe allergen warnings
  const warnings = await mcp__playwright__browser_evaluate({
    function: '() => document.querySelectorAll(".allergen-warning.severe").length'
  });
  expect(warnings).toBe(0);
  
  await mcp__playwright__browser_snapshot();
});
```

### ACCEPTANCE CRITERIA
- [ ] Generate dietary-compliant menus with 95%+ safety accuracy
- [ ] Detect allergen conflicts with medical-grade precision (99.9%+)
- [ ] Calculate portions with 10-15% waste buffer for events
- [ ] Provide ingredient substitutions for all major allergens
- [ ] Process complex dietary requirements within 30 seconds
- [ ] Support cross-contamination risk assessment
- [ ] Generate cost estimates within 10% accuracy
- [ ] Handle 8+ simultaneous dietary restrictions per menu
- [ ] Provide prep timeline and kitchen organization guidance
- [ ] Export shopping lists with allergen-free suppliers

### DEPENDENCIES
- Must complete after: None - Can start immediately
- Must complete before: Full catering workflow implementation
- Shares code with: AI content generation infrastructure, supplier management system

### ESTIMATED EFFORT
- Team A Frontend: 20 hours (Dietary interface, menu builder, allergen warnings)
- Team B Backend: 32 hours (AI menu generation, allergen analysis, portion calculations)
- Team C Integration: 18 hours (Ingredient database, supplier integration, cost calculations)
- Total: 70 hours