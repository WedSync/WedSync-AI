# TECHNICAL SPECIFICATION: WS-124 - AI Email Templates
## Generated by Feature Development Session - 2025-01-23

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding photographer managing 30 couples at different planning stages
**I want to:** Generate professional email templates automatically based on planning stage and vendor type  
**So that:** I save 2-3 hours per week on email writing and maintain consistent professional communication

**Real Wedding Scenario:**
A photographer currently writes inquiry follow-ups, booking confirmations, and timeline emails from scratch for each couple. With AI email templates, they select "photographer + booking stage + friendly tone" and get 5 professional template variants with merge tags for couple names, venue, and wedding date, reducing email creation from 15 minutes to 2 minutes per email.

### SPECIFICATION SOURCE
- **Feature ID:** WS-124
- **Original Spec:** /CORE-SPECIFICATIONS/04-AI-INTEGRATION/03-Content-Generation/01-email-templates md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** 
  - /src/lib/ai/email-templates.ts (new)
  - /src/app/api/ai/email-templates/route.ts (new)
  - /src/components/email/TemplateGenerator.tsx (new)
- **New Files to Create:**
  - /src/types/email-templates.ts
  - /src/lib/services/email-template-service.ts

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Email templates storage
CREATE TABLE IF NOT EXISTS email_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID REFERENCES user_profiles(id),
  stage TEXT NOT NULL CHECK (stage IN ('inquiry', 'booking', 'planning', 'final', 'post')),
  vendor_type TEXT NOT NULL CHECK (vendor_type IN ('photographer', 'dj', 'caterer', 'venue', 'florist')),
  tone TEXT NOT NULL CHECK (tone IN ('formal', 'friendly', 'casual')),
  subject TEXT NOT NULL,
  body TEXT NOT NULL,
  merge_tags TEXT[] DEFAULT '{}',
  ai_generated BOOLEAN DEFAULT true,
  usage_count INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- A/B testing variants
CREATE TABLE IF NOT EXISTS email_template_variants (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  template_id UUID REFERENCES email_templates(id),
  variant_number INTEGER NOT NULL,
  subject TEXT NOT NULL,
  body TEXT NOT NULL,
  performance_score NUMERIC(3,2) DEFAULT 0.0,
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### API Endpoints Required
```typescript
// POST /api/ai/email-templates/generate
interface GenerateEmailRequest {
  vendorType: 'photographer' | 'dj' | 'caterer' | 'venue' | 'florist';
  stage: 'inquiry' | 'booking' | 'planning' | 'final' | 'post';
  tone: 'formal' | 'friendly' | 'casual';
  includeElements: string[]; // ['pricing', 'timeline', 'next-steps']
  customInstructions?: string;
}

interface GenerateEmailResponse {
  success: boolean;
  data: {
    templates: EmailTemplate[];
    variants: EmailTemplateVariant[];
  };
}

// GET /api/ai/email-templates/saved
interface SavedTemplatesResponse {
  success: boolean;
  data: {
    templates: EmailTemplate[];
    total: number;
  };
}
```

#### Frontend Components Required
```typescript
// Component: EmailTemplateGenerator
// Location: /src/components/email/TemplateGenerator.tsx

interface EmailTemplateGeneratorProps {
  vendorType: string;
  onTemplateGenerated: (templates: EmailTemplate[]) => void;
  onSaveTemplate: (template: EmailTemplate) => Promise<void>;
}

interface EmailTemplate {
  id?: string;
  stage: string;
  vendorType: string;
  tone: string;
  subject: string;
  body: string;
  mergeTags: string[];
  variants?: EmailTemplateVariant[];
}

// Key functionality:
- Stage and tone selection dropdowns
- Real-time template preview with merge tag highlighting
- A/B variant comparison view
- Template saving and customization
- Usage analytics display
```

#### Integration Points
```typescript
// Service: EmailTemplateService
// Dependencies: OpenAI API, Supabase, User context

class EmailTemplateService {
  async generateTemplate(request: GenerateEmailRequest): Promise<EmailTemplate[]> {
    // OpenAI integration for template generation
    // Merge tag injection based on vendor type
    // A/B variant generation
  }
  
  async personalizeTemplate(template: EmailTemplate, clientData: any): Promise<string> {
    // Client-specific personalization
    // Venue-aware content additions
    // Wedding date context injection
  }
}
```

### CODE EXAMPLES

#### Example 1: AI Template Generation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { OpenAI } from 'openai';
import { supabase } from '@/lib/supabase';

export class EmailTemplateAI {
  private openai = new OpenAI({
    apiKey: process.env.OPENAI_API_KEY
  });

  async generate(request: GenerateEmailRequest): Promise<EmailTemplate[]> {
    // Step 1: Build context-aware prompt
    const prompt = this.buildPrompt(request);
    
    // Step 2: Generate base template
    const completion = await this.openai.chat.completions.create({
      model: 'gpt-4',
      messages: [{ role: 'system', content: prompt }],
      temperature: 0.7,
      max_tokens: 500,
      n: 5 // Generate 5 variants
    });
    
    // Step 3: Process and structure templates
    const templates = completion.choices.map((choice, index) => ({
      stage: request.stage,
      vendorType: request.vendorType,
      tone: request.tone,
      subject: this.extractSubject(choice.message.content),
      body: this.extractBody(choice.message.content),
      mergeTags: this.getMergeTags(request.vendorType),
      variantNumber: index + 1
    }));
    
    return templates;
  }
  
  private buildPrompt(request: GenerateEmailRequest): string {
    const context = {
      photographer: 'You specialize in capturing wedding moments and need to communicate about timelines, shot lists, and deliverables.',
      dj: 'You provide music entertainment and need to discuss playlists, timing, and equipment setup.',
      caterer: 'You handle wedding catering and need to discuss menus, dietary requirements, and service timing.',
      venue: 'You provide wedding venues and need to discuss logistics, setup, and coordination with other vendors.',
      florist: 'You create floral arrangements and need to discuss designs, delivery timing, and setup requirements.'
    };
    
    return `You are a ${request.vendorType} writing a ${request.tone} email for the ${request.stage} stage of wedding planning. 
    Context: ${context[request.vendorType]}
    Include elements: ${request.includeElements.join(', ')}
    Generate a professional email with subject line and body. Use merge tags like {{couple_names}}, {{wedding_date}}, {{venue}}.`;
  }
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [ ] Context7: Load docs for OpenAI API patterns
- [ ] Playwright: Test email template generation flow
- [ ] Filesystem: Access template storage and caching

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/openai/openai-node", "chat completions", 3000);
await mcp__context7__get-library-docs("/supabase/supabase", "database operations", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('EmailTemplateAI', () => {
  it('should generate 5 template variants for photographer inquiry stage', async () => {
    const request = {
      vendorType: 'photographer',
      stage: 'inquiry',
      tone: 'friendly',
      includeElements: ['pricing', 'timeline']
    };
    
    const templates = await emailTemplateAI.generate(request);
    expect(templates).toHaveLength(5);
    expect(templates[0].mergeTags).toContain('{{couple_names}}');
  });
  
  it('should personalize templates with client venue data', async () => {
    const template = { body: 'Standard template' };
    const client = { venue: { outdoor: true } };
    
    const personalized = await emailTemplateAI.personalize(template, client);
    expect(personalized).toContain('outdoor ceremonies');
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Email template generation workflow', async () => {
  await mcp__playwright__browser_navigate({url: '/email-templates'});
  await mcp__playwright__browser_click({element: 'Vendor Type Dropdown', ref: 'select[name="vendorType"]'});
  await mcp__playwright__browser_click({element: 'Photographer Option', ref: 'option[value="photographer"]'});
  await mcp__playwright__browser_click({element: 'Generate Templates Button', ref: 'button[type="submit"]'});
  await mcp__playwright__browser_wait_for({text: 'Generated 5 template variants'});
  await mcp__playwright__browser_snapshot();
});
```

### ACCEPTANCE CRITERIA
- [ ] Generate 5 distinct template variants per request within 10 seconds
- [ ] Support all 5 vendor types (photographer, dj, caterer, venue, florist)
- [ ] Include appropriate merge tags for each vendor type
- [ ] Maintain 95% uptime for AI generation service
- [ ] Templates pass readability score of 8+ on Flesch Reading Ease
- [ ] Accessibility: WCAG 2.1 AA compliance for template editor UI

### DEPENDENCIES
- Must complete after: None - Can start immediately
- Must complete before: WS-126 (Chatbot Knowledge Base - shares AI infrastructure)
- Shares code with: Other AI content generation features

### ESTIMATED EFFORT
- Team A Frontend: 16 hours (Template UI, variant comparison, editor)
- Team B Backend: 12 hours (OpenAI integration, database schema, API)
- Team C Integration: 8 hours (Template personalization, merge tag system)
- Total: 36 hours