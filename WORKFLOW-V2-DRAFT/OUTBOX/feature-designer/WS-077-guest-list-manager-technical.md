# TECHNICAL SPECIFICATION: WS-077 - Guest List Manager
## Generated by Feature Development Session - August 22, 2025

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding couple managing 150+ guests across multiple events
**I want to:** Maintain one central guest list that all vendors can access for their specific needs
**So that:** My caterer knows dietary restrictions, photographer has family groups, and venue has accurate headcounts without me sending 20 different spreadsheets

**Real Wedding Scenario:**
A couple currently maintains 6 different guest lists: one for save-the-dates, one for invitations, one for the caterer (with meal choices), one for the photographer (with family relationships), one for seating charts, and one for thank-you cards. With this centralized system, they enter guest info once, and each vendor sees only what they need. Changes sync everywhere instantly, saving 10+ hours and preventing the "wrong list" disasters.

### SPECIFICATION SOURCE
- **Feature ID:** WS-077
- **Original Spec:** Centralized guest management with RSVP tracking
- **Current Implementation:** 0% complete
- **Files to Modify:**
  - /wedsync/src/app/(dashboard)/layout.tsx (add guests menu)
- **New Files to Create:**
  - /wedsync/src/app/(dashboard)/guests/page.tsx
  - /wedsync/src/app/(dashboard)/guests/import/page.tsx
  - /wedsync/src/app/(dashboard)/guests/groups/page.tsx
  - /wedsync/src/app/api/guests/route.ts
  - /wedsync/src/app/api/guests/[id]/route.ts
  - /wedsync/src/app/api/guests/import/route.ts
  - /wedsync/src/app/api/guests/export/route.ts
  - /wedsync/src/components/guests/GuestListManager.tsx
  - /wedsync/src/components/guests/GuestImporter.tsx
  - /wedsync/src/components/guests/RSVPTracker.tsx
  - /wedsync/src/lib/services/guestService.ts

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Guest list entries
CREATE TABLE IF NOT EXISTS wedding_guests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  couple_id UUID NOT NULL REFERENCES couples(id),
  first_name VARCHAR(100) NOT NULL,
  last_name VARCHAR(100),
  email VARCHAR(255),
  phone VARCHAR(50),
  address_line_1 VARCHAR(255),
  address_line_2 VARCHAR(255),
  city VARCHAR(100),
  state_province VARCHAR(100),
  postal_code VARCHAR(20),
  country VARCHAR(100) DEFAULT 'USA',
  guest_party_id UUID, -- Groups guests together (families, plus-ones)
  relationship VARCHAR(50), -- 'bride_family', 'groom_family', 'friend', 'coworker'
  side VARCHAR(20), -- 'bride', 'groom', 'both'
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  
  UNIQUE(couple_id, email) WHERE email IS NOT NULL
);

-- RSVP tracking
CREATE TABLE IF NOT EXISTS guest_rsvps (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  guest_id UUID NOT NULL REFERENCES wedding_guests(id) ON DELETE CASCADE,
  event_type VARCHAR(50) NOT NULL, -- 'ceremony', 'reception', 'rehearsal', 'brunch'
  attending VARCHAR(20), -- 'yes', 'no', 'maybe', 'pending'
  guest_count INTEGER DEFAULT 1,
  meal_choice VARCHAR(100),
  dietary_restrictions TEXT,
  notes TEXT,
  responded_at TIMESTAMP WITH TIME ZONE,
  reminder_sent_at TIMESTAMP WITH TIME ZONE,
  
  UNIQUE(guest_id, event_type)
);

-- Guest groups (families, tables, etc.)
CREATE TABLE IF NOT EXISTS guest_groups (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  couple_id UUID NOT NULL REFERENCES couples(id),
  group_name VARCHAR(255) NOT NULL,
  group_type VARCHAR(50), -- 'family', 'table', 'wedding_party', 'custom'
  max_size INTEGER,
  assigned_table VARCHAR(50),
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Guest tags for filtering
CREATE TABLE IF NOT EXISTS guest_tags (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  guest_id UUID NOT NULL REFERENCES wedding_guests(id) ON DELETE CASCADE,
  tag_name VARCHAR(50) NOT NULL,
  tag_value VARCHAR(255),
  
  UNIQUE(guest_id, tag_name)
);

-- Vendor guest access permissions
CREATE TABLE IF NOT EXISTS vendor_guest_access (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID NOT NULL REFERENCES suppliers(id),
  couple_id UUID NOT NULL REFERENCES couples(id),
  access_level VARCHAR(50) DEFAULT 'view', -- 'view', 'edit'
  fields_visible TEXT[], -- ['name', 'meal_choice', 'table']
  granted_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  
  UNIQUE(supplier_id, couple_id)
);

CREATE INDEX idx_guests_couple ON wedding_guests(couple_id);
CREATE INDEX idx_guests_party ON wedding_guests(guest_party_id);
CREATE INDEX idx_rsvps_guest ON guest_rsvps(guest_id);
```

#### API Endpoints Required
```typescript
// GET /api/guests - Get all guests with filters
interface GetGuestsRequest {
  filters?: {
    relationship?: string;
    side?: 'bride' | 'groom' | 'both';
    rsvpStatus?: 'yes' | 'no' | 'maybe' | 'pending';
    tags?: string[];
  };
}

interface GetGuestsResponse {
  guests: {
    id: string;
    name: string;
    email?: string;
    phone?: string;
    partySize: number;
    rsvpStatus: Record<string, string>;
    mealChoice?: string;
    dietaryRestrictions?: string;
    table?: string;
    tags: string[];
  }[];
  stats: {
    total: number;
    confirmed: number;
    declined: number;
    pending: number;
    totalAttending: number;
  };
}

// POST /api/guests/import - Bulk import guests
interface ImportGuestsRequest {
  source: 'csv' | 'excel' | 'contacts';
  data: any; // File data or contact list
  mappings: Record<string, string>; // Field mappings
}

// PUT /api/guests/[id]/rsvp - Update RSVP
interface UpdateRSVPRequest {
  eventType: string;
  attending: 'yes' | 'no' | 'maybe';
  guestCount?: number;
  mealChoice?: string;
  dietaryRestrictions?: string;
}
```

#### Frontend Components Required
```typescript
// Component: GuestListManager
// Location: /src/components/guests/GuestListManager.tsx

interface GuestListManagerProps {
  coupleId: string;
  onGuestUpdate: (guest: Guest) => void;
}

// Key functionality:
- Sortable/filterable guest table
- Bulk actions (send invites, export)
- Quick add guest form
- Group management
- RSVP status overview
- Seating chart integration

// Component: GuestImporter
// Location: /src/components/guests/GuestImporter.tsx

interface GuestImporterProps {
  onImportComplete: (guests: Guest[]) => void;
}

// Key functionality:
- CSV/Excel file upload
- Column mapping interface
- Duplicate detection
- Preview before import
- Error handling
- Progress tracking

// Component: RSVPTracker
// Location: /src/components/guests/RSVPTracker.tsx

interface RSVPTrackerProps {
  guests: Guest[];
  events: WeddingEvent[];
}

// Key functionality:
- RSVP status dashboard
- Send reminders
- Track meal choices
- Export for vendors
- Response analytics
```

### CODE EXAMPLES

#### Example 1: Smart Guest Import with Duplicate Detection
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { parse } from 'papaparse';
import { supabase } from '@/lib/supabase';

export async function importGuests(file: File, coupleId: string) {
  // Step 1: Parse CSV/Excel file
  const results = await new Promise<ParseResult>((resolve) => {
    parse(file, {
      header: true,
      complete: resolve,
      skipEmptyLines: true
    });
  });
  
  // Step 2: Detect and handle duplicates
  const existingGuests = await supabase
    .from('wedding_guests')
    .select('email, phone, first_name, last_name')
    .eq('couple_id', coupleId);
  
  const duplicates: Guest[] = [];
  const newGuests: Guest[] = [];
  
  for (const row of results.data) {
    const isDuplicate = existingGuests.data?.some(existing => 
      (existing.email && existing.email === row.email) ||
      (existing.phone && existing.phone === row.phone) ||
      (existing.first_name === row.first_name && existing.last_name === row.last_name)
    );
    
    if (isDuplicate) {
      duplicates.push(row);
    } else {
      newGuests.push({
        couple_id: coupleId,
        first_name: row.first_name,
        last_name: row.last_name,
        email: row.email,
        phone: row.phone,
        side: row.side || detectSide(row),
        relationship: row.relationship || 'friend'
      });
    }
  }
  
  // Step 3: Bulk insert new guests
  if (newGuests.length > 0) {
    const { data, error } = await supabase
      .from('wedding_guests')
      .insert(newGuests)
      .select();
    
    if (error) throw error;
  }
  
  return {
    imported: newGuests.length,
    duplicates: duplicates.length,
    duplicateDetails: duplicates
  };
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [ ] Context7: Load docs for CSV parsing, data tables
- [ ] Playwright: Test guest import and RSVP flows
- [ ] Filesystem: Access guest list templates

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/papaparse/papaparse", "csv parsing", 2000);
await mcp__context7__get-library-docs("/tanstack/react-table", "data tables", 2500);
await mcp__context7__get-library-docs("/react-hook-form/react-hook-form", "bulk forms", 1500);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('Guest Service', () => {
  it('should detect duplicate guests correctly', async () => {
    const duplicates = await guestService.findDuplicates(mockGuests, existingGuests);
    expect(duplicates).toHaveLength(2);
    expect(duplicates[0].reason).toBe('email_match');
  });
  
  it('should calculate accurate RSVP statistics', async () => {
    const stats = await guestService.calculateRSVPStats('couple-123');
    expect(stats.totalAttending).toBe(120);
    expect(stats.pendingResponse).toBe(30);
  });
});
```

#### E2E Tests Required
```typescript
test('Guest import and RSVP tracking flow', async () => {
  await mcp__playwright__browser_navigate({url: '/guests/import'});
  
  // Upload CSV file
  await mcp__playwright__browser_file_upload({
    paths: ['/test-data/guests.csv']
  });
  
  // Map columns
  await mcp__playwright__browser_select_option({
    element: "First name column",
    ref: "select[name='firstName']",
    values: ["First Name"]
  });
  
  // Complete import
  await mcp__playwright__browser_click({
    element: "Import Guests button",
    ref: "button[data-testid='import-guests']"
  });
  
  await mcp__playwright__browser_wait_for({text: "150 guests imported"});
});
```

### ACCEPTANCE CRITERIA
- [ ] Guests can be imported from CSV/Excel with duplicate detection
- [ ] RSVP tracking includes meal choices and dietary restrictions
- [ ] Vendors see only permitted guest information fields
- [ ] Guest groups enable family/table management
- [ ] Export formats work for different vendor needs
- [ ] Performance: Guest list loads in under 1 second for 500 guests
- [ ] Security: Vendor access is properly restricted
- [ ] Accessibility: Keyboard navigation for all features

### DEPENDENCIES
- Must complete after: Core couple accounts
- Must complete before: Seating chart features
- Shares code with: RSVP systems, vendor permissions

### ESTIMATED EFFORT
- Team A Frontend: 20 hours (Guest UI, import wizard, RSVP tracking)
- Team D Full-stack: 20 hours (Import logic, analytics, vendor access)
- Total: 40 hours