# TECHNICAL SPECIFICATION: WS-032 - Client Profiles
## Generated by Feature Development Session - 2025-08-21

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding venue coordinator managing 30 couples simultaneously
**I want to:** Access comprehensive client profiles with all wedding details, activity history, and communication logs
**So that:** I can instantly recall couple preferences, track what's been completed, and provide personalized service without asking for information multiple times

**Real Wedding Scenario:**
A venue coordinator receives a call from "Sarah" asking about catering options. Instead of asking "which Sarah?" and requesting the wedding date again, they can quickly search client profiles, see Sarah & Mike's October wedding details, view their dietary requirements already on file, and see that they've been waiting for catering timeline confirmation for 3 days.

### SPECIFICATION SOURCE
- **Feature ID:** WS-032
- **Original Spec:** /CORE-SPECIFICATIONS/02-WEDSYNC-SUPPLIER-PLATFORM/03-Client-Management/02-client-profiles md.md
- **Current Implementation:** 0% complete
- **Files to Modify:**
  - `/src/app/(dashboard)/clients/[id]/page.tsx` (new)
  - `/src/components/clients/ClientProfile.tsx` (new)
  - `/src/components/clients/ClientHeader.tsx` (new)
  - `/src/components/clients/ClientTabs.tsx` (new)
- **New Files to Create:**
  - `/src/components/clients/tabs/OverviewTab.tsx`
  - `/src/components/clients/tabs/DetailsTab.tsx`
  - `/src/components/clients/tabs/TimelineTab.tsx`
  - `/src/components/clients/tabs/NotesTab.tsx`
  - `/src/components/clients/tabs/DocumentsTab.tsx`
  - `/src/components/clients/tabs/JourneyTab.tsx`
  - `/src/components/clients/tabs/CommunicationsTab.tsx`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Client notes with timestamps
CREATE TABLE IF NOT EXISTS client_notes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  client_id UUID REFERENCES clients(id) ON DELETE CASCADE,
  supplier_id UUID REFERENCES suppliers(id) ON DELETE CASCADE,
  content TEXT NOT NULL,
  is_private BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Client activity log
CREATE TABLE IF NOT EXISTS client_activity (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  client_id UUID REFERENCES clients(id) ON DELETE CASCADE,
  activity_type TEXT NOT NULL, -- 'form_submitted', 'email_sent', 'note_added', etc.
  description TEXT NOT NULL,
  metadata JSONB,
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Client documents
CREATE TABLE IF NOT EXISTS client_documents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  client_id UUID REFERENCES clients(id) ON DELETE CASCADE,
  file_name TEXT NOT NULL,
  file_path TEXT NOT NULL,
  file_type TEXT NOT NULL,
  file_size INTEGER NOT NULL,
  uploaded_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Add indexes
CREATE INDEX IF NOT EXISTS idx_client_notes_client_id ON client_notes(client_id);
CREATE INDEX IF NOT EXISTS idx_client_activity_client_id ON client_activity(client_id);
CREATE INDEX IF NOT EXISTS idx_client_documents_client_id ON client_documents(client_id);
```

#### API Endpoints Required
```typescript
// GET /api/clients/[id]
interface GetClientProfileResponse {
  client: Client & {
    notes: ClientNote[];
    activity: ClientActivity[];
    documents: ClientDocument[];
    journey_position?: JourneyPosition;
    completion_percentage: number;
    wedme_connection_status: 'connected' | 'invited' | 'not_connected';
  };
}

// POST /api/clients/[id]/notes
interface CreateNoteRequest {
  content: string;
  is_private: boolean;
}

// PUT /api/clients/[id]
interface UpdateClientRequest {
  [key: string]: any; // Dynamic client fields
}

// POST /api/clients/[id]/activity
interface LogActivityRequest {
  activity_type: string;
  description: string;
  metadata?: any;
}
```

#### Frontend Components Required
```typescript
// Component: ClientProfile
// Location: /src/components/clients/ClientProfile.tsx

interface ClientProfileProps {
  clientId: string;
}

// Key functionality:
- Tabbed interface with lazy loading
- Auto-save edits with optimistic updates
- Real-time activity feed updates
- Photo upload with drag-and-drop
- Keyboard navigation between tabs

// Component: ClientHeader
// Location: /src/components/clients/ClientHeader.tsx
interface ClientHeaderProps {
  client: Client;
  onPhotoUpload: (file: File) => void;
  onEdit: () => void;
}

// Key functionality:
- Couple photo display with upload
- Wedding countdown timer
- Quick contact buttons (email, phone, SMS)
- Status badges and WedMe connection indicator
- Edit mode toggle

// Component: ClientTabs
// Each tab component handles specific data sections:
- OverviewTab: Essential details, venue, guest count
- DetailsTab: All form responses with edit capability
- TimelineTab: Chronological activity with infinite scroll
- NotesTab: Private notes with rich text editor
- DocumentsTab: File uploads with preview
- JourneyTab: Current journey position visualization
- CommunicationsTab: Email/SMS history
```

#### Integration Points
```typescript
// Service: ClientProfileService
// Dependencies: Supabase, Realtime subscriptions

class ClientProfileService {
  async getClientProfile(clientId: string) {
    const { data: client } = await supabase
      .from('clients')
      .select(`
        *,
        notes:client_notes(*),
        activity:client_activity(*),
        documents:client_documents(*)
      `)
      .eq('id', clientId)
      .single();
      
    return this.enrichClientData(client);
  }
  
  async updateClient(clientId: string, updates: Partial<Client>) {
    // Optimistic update with rollback
    const { data, error } = await supabase
      .from('clients')
      .update(updates)
      .eq('id', clientId)
      .select()
      .single();
      
    if (!error) {
      // Log activity
      await this.logActivity(clientId, 'client_updated', 'Client information updated');
    }
    
    return { data, error };
  }
  
  async createNote(clientId: string, content: string, isPrivate: boolean) {
    const { data, error } = await supabase
      .from('client_notes')
      .insert({
        client_id: clientId,
        content,
        is_private: isPrivate,
        supplier_id: getCurrentSupplierId()
      })
      .select()
      .single();
      
    return { data, error };
  }
}
```

### CODE EXAMPLES

#### Example 1: Client Profile Page Implementation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { useState, useEffect } from 'react';
import { useParams } from 'next/navigation';
import { supabase } from '@/lib/supabase';
import { ClientProfile } from '@/components/clients/ClientProfile';

export default function ClientProfilePage() {
  const { id } = useParams();
  const [client, setClient] = useState<Client | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  
  useEffect(() => {
    async function loadClient() {
      setIsLoading(true);
      
      const { data, error } = await supabase
        .from('clients')
        .select(`
          *,
          notes:client_notes(*),
          activity:client_activity(*),
          documents:client_documents(*)
        `)
        .eq('id', id)
        .single();
        
      if (error) {
        console.error('Error loading client:', error);
        return;
      }
      
      setClient(data);
      setIsLoading(false);
    }
    
    // Set up real-time subscription
    const subscription = supabase
      .channel(`client-${id}`)
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'client_activity',
        filter: `client_id=eq.${id}`
      }, (payload) => {
        // Update activity feed in real-time
        setClient(current => current ? {
          ...current,
          activity: [...current.activity, payload.new]
        } : null);
      })
      .subscribe();
      
    loadClient();
    
    return () => {
      subscription.unsubscribe();
    };
  }, [id]);
  
  if (isLoading) return <div>Loading...</div>;
  if (!client) return <div>Client not found</div>;
  
  return <ClientProfile client={client} />;
}
```

#### Example 2: Auto-save Edit Implementation
```typescript
import { useCallback, useEffect } from 'react';
import { useDebouncedCallback } from 'use-debounce';

export function useAutoSave(clientId: string, data: any) {
  const debouncedSave = useDebouncedCallback(
    async (updates) => {
      const { error } = await supabase
        .from('clients')
        .update(updates)
        .eq('id', clientId);
        
      if (error) {
        // Show error toast
        toast.error('Failed to save changes');
      } else {
        // Show success indicator
        toast.success('Changes saved');
      }
    },
    1000 // Save after 1 second of no changes
  );
  
  useEffect(() => {
    if (data && Object.keys(data).length > 0) {
      debouncedSave(data);
    }
  }, [data, debouncedSave]);
  
  return debouncedSave;
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for Next.js, React, Supabase real-time
- [x] Playwright: Test profile interactions, tab navigation, auto-save
- [x] Filesystem: Access existing form components for reuse

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/vercel/next.js", "dynamic routing", 2000);
await mcp__context7__get-library-docs("/supabase/supabase", "real-time subscriptions", 3000);
await mcp__context7__get-library-docs("/react/react", "useEffect patterns", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('ClientProfile', () => {
  it('should load client data on mount', () => {
    // Test data loading
  });
  
  it('should auto-save edits after debounce', () => {
    // Test auto-save functionality
  });
  
  it('should show real-time activity updates', () => {
    // Test real-time subscriptions
  });
  
  it('should handle photo upload', () => {
    // Test file upload
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Client profile workflow', async () => {
  await mcp__playwright__browser_navigate({url: '/clients/test-client-id'});
  await mcp__playwright__browser_snapshot();
  
  // Test tab navigation
  await mcp__playwright__browser_click({
    element: 'Details tab',
    ref: '[data-testid="tab-details"]'
  });
  
  // Test edit functionality
  await mcp__playwright__browser_type({
    element: 'Venue field',
    ref: '[data-testid="venue-input"]',
    text: 'Updated Venue Name'
  });
  
  // Wait for auto-save
  await mcp__playwright__browser_wait_for({time: 2});
  
  // Verify save indication
  await mcp__playwright__browser_snapshot();
});
```

### ACCEPTANCE CRITERIA
- [x] All 7 tabs load data correctly: Overview, Details, Timeline, Notes, Documents, Journey, Communications
- [x] Auto-save works within 1 second of edit completion
- [x] Real-time activity feed updates without refresh
- [x] Photo upload with drag-and-drop support
- [x] Performance: Profile loads in <2 seconds
- [x] Security: Users only see their own clients via RLS
- [x] Accessibility: Full keyboard navigation, screen reader compatible

### DEPENDENCIES
- Must complete after: WS-031 (Client List Views)
- Must complete before: WS-036 (Photo Management)
- Shares code with: Form components, file upload utilities

### ESTIMATED EFFORT
- Team A Frontend: 20 hours
- Team B Backend: 10 hours
- Team C Integration: 6 hours
- Total: 36 hours