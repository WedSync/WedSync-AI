# TECHNICAL SPECIFICATION: WS-081 - Vendor Directory Search
## Generated by Feature Development Session - August 22, 2025

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Couple whose photographer just cancelled 3 weeks before their wedding
**I want to:** Find available wedding photographers in my area with my budget and style preferences immediately
**So that:** I can book a replacement within 48 hours instead of spending weeks calling around (80% of couples face vendor emergencies)

**Real Wedding Scenario:**
A couple's $3,500 photographer gets COVID and must cancel. It's March for a June wedding - peak booking season. They need someone who: shoots film style, works in Austin, available June 15th, under $4,000, has 5+ years experience. Currently, they'd Google "Austin wedding photographer," visit 50+ websites, email dozens who might be booked. With vendor search, they filter by all criteria, see 8 matches, 3 are available, book within 2 days.

### SPECIFICATION SOURCE
- **Feature ID:** WS-081
- **Original Spec:** Find and connect with wedding vendors
- **Current Implementation:** 0% complete
- **Files to Modify:**
  - /wedsync/src/app/(dashboard)/layout.tsx (add vendor search menu)
- **New Files to Create:**
  - /wedsync/src/app/(dashboard)/vendors/search/page.tsx
  - /wedsync/src/app/(dashboard)/vendors/directory/page.tsx
  - /wedsync/src/app/(dashboard)/vendors/[id]/profile/page.tsx
  - /wedsync/src/app/api/vendors/search/route.ts
  - /wedsync/src/app/api/vendors/directory/route.ts
  - /wedsync/src/app/api/vendors/[id]/availability/route.ts
  - /wedsync/src/components/vendors/VendorSearchForm.tsx
  - /wedsync/src/components/vendors/VendorCard.tsx
  - /wedsync/src/components/vendors/VendorProfile.tsx
  - /wedsync/src/lib/services/vendorSearchService.ts
  - /wedsync/src/lib/search/vendorFilters.ts

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Vendor profiles (extends existing auth.users)
CREATE TABLE IF NOT EXISTS vendor_profiles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) UNIQUE,
  business_name VARCHAR(255) NOT NULL,
  vendor_type VARCHAR(100) NOT NULL, -- 'photographer', 'venue', 'caterer', 'florist', 'dj', 'band', 'planner'
  specialties TEXT[], -- 'film_photography', 'outdoor_venues', 'vegan_catering'
  service_area JSONB NOT NULL, -- {cities: [], radius_miles: 50, travel_fee: 200}
  pricing JSONB NOT NULL, -- {min_budget: 2000, max_budget: 8000, packages: []}
  experience_years INTEGER DEFAULT 0,
  team_size INTEGER DEFAULT 1,
  languages TEXT[] DEFAULT ARRAY['English'],
  description TEXT,
  website_url VARCHAR(500),
  instagram_handle VARCHAR(100),
  portfolio_images TEXT[], -- Array of image URLs
  verified BOOLEAN DEFAULT false,
  verification_date TIMESTAMP WITH TIME ZONE,
  rating DECIMAL(3,2) DEFAULT 0.00,
  review_count INTEGER DEFAULT 0,
  response_time_hours INTEGER DEFAULT 24, -- Average response time
  booking_lead_time_days INTEGER DEFAULT 30, -- Minimum advance booking required
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Vendor availability calendar
CREATE TABLE IF NOT EXISTS vendor_availability (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  vendor_id UUID NOT NULL REFERENCES vendor_profiles(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  availability_type VARCHAR(50) DEFAULT 'available', -- 'available', 'booked', 'blocked', 'tentative'
  booking_id UUID, -- Reference to actual booking if booked
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  
  UNIQUE(vendor_id, date)
);

-- Vendor services and packages
CREATE TABLE IF NOT EXISTS vendor_services (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  vendor_id UUID NOT NULL REFERENCES vendor_profiles(id) ON DELETE CASCADE,
  service_name VARCHAR(255) NOT NULL,
  service_type VARCHAR(100) NOT NULL, -- 'package', 'add_on', 'hourly'
  description TEXT,
  base_price DECIMAL(10,2),
  duration_hours INTEGER,
  max_guests INTEGER,
  includes TEXT[], -- What's included in the service
  is_featured BOOLEAN DEFAULT false,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Vendor reviews and ratings
CREATE TABLE IF NOT EXISTS vendor_reviews (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  vendor_id UUID NOT NULL REFERENCES vendor_profiles(id) ON DELETE CASCADE,
  client_name VARCHAR(255) NOT NULL,
  client_email VARCHAR(255), -- Optional, for verification
  wedding_date DATE,
  rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
  review_title VARCHAR(255),
  review_text TEXT,
  service_type VARCHAR(100), -- Which service they used
  would_recommend BOOLEAN DEFAULT true,
  response_from_vendor TEXT,
  response_date TIMESTAMP WITH TIME ZONE,
  is_verified BOOLEAN DEFAULT false, -- Email verification
  is_public BOOLEAN DEFAULT true,
  helpful_votes INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Search query tracking for ML improvements
CREATE TABLE IF NOT EXISTS vendor_search_queries (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  session_id VARCHAR(255),
  search_criteria JSONB NOT NULL, -- All filters applied
  results_count INTEGER NOT NULL,
  clicked_vendors UUID[], -- Which vendors they clicked
  contacted_vendors UUID[], -- Which vendors they contacted
  search_location VARCHAR(255),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE INDEX idx_vendor_profiles_type ON vendor_profiles(vendor_type);
CREATE INDEX idx_vendor_profiles_location ON vendor_profiles USING GIN(service_area);
CREATE INDEX idx_vendor_profiles_pricing ON vendor_profiles USING GIN(pricing);
CREATE INDEX idx_vendor_availability_vendor_date ON vendor_availability(vendor_id, date);
CREATE INDEX idx_vendor_availability_date ON vendor_availability(date) WHERE availability_type = 'available';
CREATE INDEX idx_vendor_reviews_vendor ON vendor_reviews(vendor_id);
CREATE INDEX idx_vendor_reviews_rating ON vendor_reviews(rating);
```

#### API Endpoints Required
```typescript
// GET /api/vendors/search - Search vendors with filters
interface VendorSearchRequest {
  vendorType?: string;
  location?: {
    city?: string;
    state?: string;
    latitude?: number;
    longitude?: number;
    radius?: number; // miles
  };
  budget?: {
    min?: number;
    max?: number;
  };
  availableDate?: string; // ISO date string
  specialties?: string[];
  experienceYears?: number;
  rating?: number; // minimum rating
  languages?: string[];
  sortBy?: 'price' | 'rating' | 'distance' | 'experience' | 'response_time';
  page?: number;
  limit?: number;
}

interface VendorSearchResponse {
  vendors: {
    id: string;
    businessName: string;
    vendorType: string;
    specialties: string[];
    location: string;
    distanceMiles: number;
    pricing: { min: number; max: number };
    rating: number;
    reviewCount: number;
    portfolioImages: string[];
    responseTimeHours: number;
    isAvailable: boolean; // for specified date
    verificationStatus: 'verified' | 'pending' | 'unverified';
  }[];
  total: number;
  filters: {
    availableVendorTypes: { type: string; count: number }[];
    priceRanges: { range: string; count: number }[];
    locations: { city: string; count: number }[];
    specialties: { specialty: string; count: number }[];
  };
}

// GET /api/vendors/[id]/availability - Check vendor availability
interface VendorAvailabilityResponse {
  vendorId: string;
  availability: {
    date: string;
    status: 'available' | 'booked' | 'blocked' | 'tentative';
    notes?: string;
  }[];
  bookingLeadTime: number; // days in advance required
  blackoutDates: string[]; // Dates never available
}
```

#### Frontend Components Required
```typescript
// Component: VendorSearchForm
// Location: /src/components/vendors/VendorSearchForm.tsx

interface VendorSearchFormProps {
  onSearch: (criteria: VendorSearchRequest) => void;
  initialFilters?: Partial<VendorSearchRequest>;
}

// Key functionality:
- Auto-complete location search
- Budget slider with real-time updates
- Date picker with availability checking
- Multi-select specialty filters
- Save and share search criteria
- Advanced filters collapse/expand
- Mobile-responsive design

// Component: VendorCard
// Location: /src/components/vendors/VendorCard.tsx

interface VendorCardProps {
  vendor: VendorSearchResult;
  onContact: (vendorId: string) => void;
  onFavorite: (vendorId: string) => void;
}

// Key functionality:
- Image carousel with portfolio preview
- Availability indicator for specific date
- Quick contact and favorite buttons
- Distance display from search location
- Rating stars with review count
- Price range display
- Verification badge
```

### CODE EXAMPLES

#### Example 1: Advanced Vendor Search with Geolocation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { useState, useCallback, useEffect } from 'react';
import { supabase } from '@/lib/supabase';
import { debounce } from 'lodash';

export function VendorSearchForm({ onSearch, initialFilters }: VendorSearchFormProps) {
  const [filters, setFilters] = useState<VendorSearchRequest>(initialFilters || {});
  const [loading, setLoading] = useState(false);
  const [locationSuggestions, setLocationSuggestions] = useState<LocationSuggestion[]>([]);
  
  // Debounced search to avoid excessive API calls
  const debouncedSearch = useCallback(
    debounce((criteria: VendorSearchRequest) => {
      onSearch(criteria);
    }, 500),
    [onSearch]
  );
  
  useEffect(() => {
    debouncedSearch(filters);
  }, [filters, debouncedSearch]);
  
  const handleLocationSearch = async (query: string) => {
    if (query.length < 3) {
      setLocationSuggestions([]);
      return;
    }
    
    // Use Google Places API for location autocomplete
    const response = await fetch(`/api/geocode/suggest?q=${encodeURIComponent(query)}`);
    const suggestions = await response.json();
    setLocationSuggestions(suggestions);
  };
  
  const handleLocationSelect = (location: LocationSuggestion) => {
    setFilters(prev => ({
      ...prev,
      location: {
        city: location.city,
        state: location.state,
        latitude: location.lat,
        longitude: location.lng,
        radius: prev.location?.radius || 25
      }
    }));
    setLocationSuggestions([]);
  };
  
  const handleBudgetChange = (min: number, max: number) => {
    setFilters(prev => ({
      ...prev,
      budget: { min, max }
    }));
  };
  
  const handleAvailabilityCheck = async (date: string) => {
    setFilters(prev => ({
      ...prev,
      availableDate: date
    }));
    
    // Pre-load availability data for faster search results
    if (filters.vendorType && filters.location) {
      const response = await fetch('/api/vendors/availability/bulk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          date,
          vendorType: filters.vendorType,
          location: filters.location
        })
      });
    }
  };
  
  const handleSpecialtyToggle = (specialty: string) => {
    setFilters(prev => ({
      ...prev,
      specialties: prev.specialties?.includes(specialty)
        ? prev.specialties.filter(s => s !== specialty)
        : [...(prev.specialties || []), specialty]
    }));
  };
  
  return (
    <div className="bg-white p-6 rounded-lg shadow-md space-y-6">
      {/* Vendor Type Selection */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">
          What type of vendor are you looking for?
        </label>
        <select
          value={filters.vendorType || ''}
          onChange={(e) => setFilters(prev => ({ ...prev, vendorType: e.target.value }))}
          className="w-full p-3 border border-gray-300 rounded-md"
        >
          <option value="">All Vendor Types</option>
          <option value="photographer">Photographer</option>
          <option value="venue">Venue</option>
          <option value="caterer">Caterer</option>
          <option value="florist">Florist</option>
          <option value="dj">DJ</option>
          <option value="band">Live Band</option>
          <option value="planner">Wedding Planner</option>
        </select>
      </div>
      
      {/* Location Search with Autocomplete */}
      <div className="relative">
        <label className="block text-sm font-medium text-gray-700 mb-2">
          Location
        </label>
        <input
          type="text"
          placeholder="City, State or ZIP code"
          onChange={(e) => handleLocationSearch(e.target.value)}
          className="w-full p-3 border border-gray-300 rounded-md"
        />
        
        {locationSuggestions.length > 0 && (
          <div className="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1">
            {locationSuggestions.map((suggestion, idx) => (
              <button
                key={idx}
                onClick={() => handleLocationSelect(suggestion)}
                className="w-full text-left p-3 hover:bg-gray-50 border-b last:border-b-0"
              >
                <div className="font-medium">{suggestion.display}</div>
                <div className="text-sm text-gray-500">{suggestion.detail}</div>
              </button>
            ))}
          </div>
        )}
        
        {filters.location && (
          <div className="mt-2">
            <label className="block text-sm font-medium text-gray-700">
              Search radius: {filters.location.radius || 25} miles
            </label>
            <input
              type="range"
              min="5"
              max="100"
              step="5"
              value={filters.location.radius || 25}
              onChange={(e) => setFilters(prev => ({
                ...prev,
                location: { ...prev.location!, radius: parseInt(e.target.value) }
              }))}
              className="w-full mt-1"
            />
          </div>
        )}
      </div>
      
      {/* Date Availability */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">
          Wedding Date (optional)
        </label>
        <input
          type="date"
          min={new Date().toISOString().split('T')[0]}
          onChange={(e) => handleAvailabilityCheck(e.target.value)}
          className="w-full p-3 border border-gray-300 rounded-md"
        />
        <p className="text-sm text-gray-500 mt-1">
          Only show vendors available on this date
        </p>
      </div>
      
      {/* Budget Range */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">
          Budget Range
        </label>
        <div className="px-3">
          <Slider
            range
            min={500}
            max={20000}
            step={250}
            value={[filters.budget?.min || 500, filters.budget?.max || 20000]}
            onChange={([min, max]) => handleBudgetChange(min, max)}
            className="w-full"
          />
          <div className="flex justify-between text-sm text-gray-600 mt-1">
            <span>${filters.budget?.min?.toLocaleString() || '500'}</span>
            <span>${filters.budget?.max?.toLocaleString() || '20,000'}</span>
          </div>
        </div>
      </div>
      
      {/* Specialties Filter */}
      {filters.vendorType && (
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            Specialties
          </label>
          <div className="grid grid-cols-2 gap-2">
            {getSpecialtiesForVendorType(filters.vendorType).map((specialty) => (
              <label key={specialty.value} className="flex items-center space-x-2">
                <input
                  type="checkbox"
                  checked={filters.specialties?.includes(specialty.value) || false}
                  onChange={() => handleSpecialtyToggle(specialty.value)}
                  className="rounded border-gray-300"
                />
                <span className="text-sm">{specialty.label}</span>
              </label>
            ))}
          </div>
        </div>
      )}
      
      {/* Advanced Filters Toggle */}
      <AdvancedFilters 
        filters={filters} 
        onChange={setFilters}
        isExpanded={filters.experienceYears || filters.rating || filters.languages?.length}
      />
    </div>
  );
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [ ] Context7: Load docs for geolocation APIs, search algorithms
- [ ] Playwright: Test search form and vendor discovery
- [ ] Filesystem: Access vendor data templates

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/googlemaps/places-api", "autocomplete search", 2500);
await mcp__context7__get-library-docs("/algolia/search", "faceted search filters", 3000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('Vendor Search Service', () => {
  it('should filter vendors by location and radius', async () => {
    const results = await vendorSearchService.searchVendors({
      location: { city: 'Austin', state: 'TX', radius: 25 },
      vendorType: 'photographer'
    });
    
    results.vendors.forEach(vendor => {
      expect(vendor.distanceMiles).toBeLessThanOrEqual(25);
    });
  });
  
  it('should return only available vendors for specific date', async () => {
    const results = await vendorSearchService.searchVendors({
      availableDate: '2025-06-15',
      vendorType: 'photographer'
    });
    
    expect(results.vendors.every(v => v.isAvailable)).toBe(true);
  });
});
```

#### E2E Tests Required
```typescript
test('Vendor search and contact flow', async () => {
  await mcp__playwright__browser_navigate({url: '/vendors/search'});
  
  // Search for photographers in Austin
  await mcp__playwright__browser_select_option({
    element: "Vendor type dropdown",
    ref: "select[name='vendorType']",
    values: ["photographer"]
  });
  
  await mcp__playwright__browser_type({
    element: "Location input",
    ref: "input[placeholder*='City']",
    text: "Austin, TX"
  });
  
  // Select from autocomplete
  await mcp__playwright__browser_wait_for({text: "Austin, Texas"});
  await mcp__playwright__browser_click({
    element: "Austin suggestion",
    ref: "button:has-text('Austin, Texas')"
  });
  
  // Set budget range
  await mcp__playwright__browser_evaluate({
    function: "() => { document.querySelector('[data-testid=\"budget-slider\"]').value = 5000; }"
  });
  
  // Wait for search results
  await mcp__playwright__browser_wait_for({text: "photographers found"});
  
  // Click first vendor
  await mcp__playwright__browser_click({
    element: "First vendor card",
    ref: "[data-testid='vendor-card']:first-child"
  });
  
  // Verify vendor profile loads
  await mcp__playwright__browser_wait_for({text: "Contact Vendor"});
});
```

### ACCEPTANCE CRITERIA
- [ ] Search by vendor type, location, budget, and date
- [ ] Real-time availability checking
- [ ] Geolocation-based distance calculation
- [ ] Advanced filtering by specialties and experience
- [ ] Sort results by price, rating, distance, response time
- [ ] Save favorite vendors and search criteria
- [ ] Mobile-responsive search interface
- [ ] Search result tracking for ML improvements
- [ ] Integration with vendor booking system

### DEPENDENCIES
- Must complete after: WS-074/075 (User accounts and vendor profiles)
- Must complete before: Vendor booking and contract features
- Shares code with: Geolocation services, vendor management

### ESTIMATED EFFORT
- Team C Integration: 28 hours (Search interface, maps, filters)
- Team B Backend: 24 hours (Search algorithms, availability, geolocation)
- Total: 52 hours