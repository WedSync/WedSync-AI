# TECHNICAL SPECIFICATION: WS-282 - Dashboard Tour System
## Generated by Feature Development Session - 2025-01-20

### USER STORY & BUSINESS CONTEXT (FACTUAL)
**As a:** Newly engaged couple experiencing wedding planning software for the first time
**I want to:** Have a guided tour showing me how to add my venue, vendors, and basic wedding details step-by-step
**So that:** I don't feel overwhelmed by all the features and can start organizing my wedding information immediately

**Real Wedding Scenario:**
Newly engaged couples typically have no experience with wedding planning software and are overwhelmed by the complexity of wedding coordination. They need to understand how to add their wedding date, venue, guest list, and connect with vendors, but don't know where to start. A guided tour reduces abandonment rates and helps couples become active users faster by showing them the essential first steps.

### SPECIFICATION SOURCE
- **Feature ID:** WS-282
- **Original Spec:** New user onboarding and guided tour requirements for couple platform
- **Current Implementation:** 0% complete
- **Files to Modify:** 
  - `/src/components/dashboard/WeddingDashboard.tsx`
  - `/src/app/(dashboard)/layout.tsx`
- **New Files to Create:**
  - `/src/components/tours/DashboardTour.tsx`
  - `/src/components/tours/TourProvider.tsx`
  - `/src/components/tours/TourStep.tsx`
  - `/src/app/api/tours/progress/route.ts`
  - `/src/app/api/tours/complete/route.ts`
  - `/src/lib/tours/tour-engine.ts`
  - `/src/hooks/useTour.ts`
  - `/src/app/(dashboard)/tour/page.tsx`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- User tour progress and completion tracking
CREATE TABLE IF NOT EXISTS user_tour_progress (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  tour_type VARCHAR(50) NOT NULL CHECK (tour_type IN (
    'dashboard_onboarding', 'vendor_setup', 'guest_management', 'timeline_creation',
    'sharing_setup', 'mobile_app_intro', 'advanced_features'
  )),
  current_step INTEGER DEFAULT 0,
  total_steps INTEGER NOT NULL,
  completed_steps JSONB DEFAULT '[]', -- Array of completed step IDs
  skipped_steps JSONB DEFAULT '[]',   -- Array of skipped step IDs
  tour_data JSONB DEFAULT '{}',       -- Tour-specific data and context
  started_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  completed_at TIMESTAMP WITH TIME ZONE,
  last_interaction_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  completion_percentage DECIMAL(5,2) DEFAULT 0.0,
  is_completed BOOLEAN DEFAULT FALSE,
  was_skipped BOOLEAN DEFAULT FALSE
);

-- Tour configuration and content
CREATE TABLE IF NOT EXISTS tour_configurations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tour_type VARCHAR(50) NOT NULL UNIQUE,
  tour_name VARCHAR(200) NOT NULL,
  tour_description TEXT,
  target_user_type VARCHAR(30) CHECK (target_user_type IN ('couple', 'vendor', 'planner', 'all')),
  is_mandatory BOOLEAN DEFAULT FALSE,
  is_active BOOLEAN DEFAULT TRUE,
  tour_steps JSONB NOT NULL, -- Array of step configurations
  triggers JSONB DEFAULT '{}', -- When to show tour (first login, feature access, etc.)
  display_settings JSONB DEFAULT '{}', -- UI settings, positioning, styling
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Tour interaction analytics
CREATE TABLE IF NOT EXISTS tour_analytics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  tour_type VARCHAR(50) NOT NULL,
  step_id VARCHAR(100) NOT NULL,
  action_type VARCHAR(30) NOT NULL CHECK (action_type IN (
    'step_viewed', 'step_completed', 'step_skipped', 'tour_started',
    'tour_completed', 'tour_abandoned', 'help_clicked', 'retry_action'
  )),
  step_duration_seconds INTEGER,
  interaction_data JSONB DEFAULT '{}',
  user_agent TEXT,
  viewport_size JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes for performance
CREATE INDEX idx_user_tour_progress_user_type ON user_tour_progress(user_id, tour_type);
CREATE INDEX idx_user_tour_progress_completion ON user_tour_progress(is_completed, started_at);
CREATE INDEX idx_tour_analytics_user_tour ON tour_analytics(user_id, tour_type, created_at DESC);
CREATE INDEX idx_tour_configurations_active ON tour_configurations(is_active, target_user_type);
```

#### API Endpoints Required
```typescript
// GET /api/tours/available - Get available tours for user
interface AvailableToursResponse {
  tours: {
    tourType: string;
    tourName: string;
    description: string;
    totalSteps: number;
    estimatedDuration: string; // e.g., "5 minutes"
    isMandatory: boolean;
    isCompleted: boolean;
    currentStep: number;
    completionPercentage: number;
  }[];
  recommendedTour?: string; // Next suggested tour
}

// POST /api/tours/start - Start a new tour
interface StartTourRequest {
  tourType: string;
  context?: Record<string, any>; // Additional context for tour customization
}

interface StartTourResponse {
  success: boolean;
  tourId: string;
  tourSteps: TourStep[];
  currentStep: number;
  tourData: any;
}

// PUT /api/tours/progress - Update tour progress
interface UpdateProgressRequest {
  tourType: string;
  stepId: string;
  action: 'viewed' | 'completed' | 'skipped';
  stepDuration?: number;
  interactionData?: Record<string, any>;
}

// POST /api/tours/complete - Mark tour as completed
interface CompleteTourRequest {
  tourType: string;
  feedback?: {
    rating: number; // 1-5
    comments?: string;
    wasHelpful: boolean;
    suggestedImprovements?: string;
  };
}

// GET /api/tours/[tourType]/steps - Get tour steps
interface TourStepsResponse {
  steps: {
    id: string;
    title: string;
    description: string;
    targetElement: string;
    position: 'top' | 'bottom' | 'left' | 'right' | 'center';
    content: string;
    actionRequired?: {
      type: 'click' | 'input' | 'navigate';
      target: string;
      expectedValue?: string;
    };
    nextTrigger: 'auto' | 'manual' | 'action_completion';
  }[];
  tourSettings: {
    overlay: boolean;
    highlightPadding: number;
    allowSkipping: boolean;
    showProgress: boolean;
  };
}
```

#### Frontend Components Required
```typescript
// Component: DashboardTour
// Location: /src/components/tours/DashboardTour.tsx

interface DashboardTourProps {
  tourType: string;
  isActive: boolean;
  onComplete: () => void;
  onSkip: () => void;
  onStepChange: (stepIndex: number) => void;
}

// Key functionality:
- Interactive tour overlay with step-by-step guidance
- Contextual tooltips and highlights
- Progress indication and navigation controls
- Action validation and completion checking
- Responsive positioning and mobile adaptation
- Skip and restart tour options

// Component: TourProvider
// Location: /src/components/tours/TourProvider.tsx
interface TourProviderProps {
  children: React.ReactNode;
  userId: string;
  userType: 'couple' | 'vendor' | 'planner';
}

// Key functionality:
- Global tour state management
- Automatic tour triggering based on conditions
- Tour progress persistence
- Multiple concurrent tour support
- Analytics tracking integration
- Tour conflict resolution

// Component: TourStep
// Location: /src/components/tours/TourStep.tsx
interface TourStepProps {
  step: TourStep;
  currentStepIndex: number;
  totalSteps: number;
  onNext: () => void;
  onPrevious: () => void;
  onSkip: () => void;
  onComplete: () => void;
  isVisible: boolean;
}

// Key functionality:
- Individual step rendering and positioning
- Element highlighting and focus management
- Action guidance and validation
- Animation and transition effects
- Accessibility compliance (ARIA labels, keyboard navigation)
- Mobile-responsive step layouts

// Component: TourTrigger
// Location: /src/components/tours/TourTrigger.tsx
interface TourTriggerProps {
  tourType: string;
  trigger: 'button' | 'auto' | 'first_visit' | 'feature_access';
  children?: React.ReactNode;
  className?: string;
}

// Key functionality:
- Tour launching mechanism
- Contextual tour suggestions
- Help button integration
- Tour restart functionality
- User preference respect (don't show again)
```

#### Integration Points
```typescript
// Service: TourEngine
// Dependencies: User management, analytics, tour configurations

class DashboardTourEngine {
  async getTourForUser(userId: string, context: TourContext): Promise<RecommendedTour | null> {
    // Determine which tour to show based on user progress
    // Check completion status of prerequisite tours
    // Apply tour triggering rules and conditions
    // Return most relevant tour recommendation
  }
  
  async startTour(userId: string, tourType: string, context?: any): Promise<TourSession> {
    // Initialize tour session with user-specific data
    // Load tour configuration and customize steps
    // Create progress tracking record
    // Return tour steps and session data
  }
  
  async updateProgress(userId: string, tourType: string, stepUpdate: StepUpdate): Promise<void> {
    // Update user's tour progress
    // Track step completion and interaction analytics
    // Check for tour completion conditions
    // Trigger next tour recommendations if applicable
  }
  
  async completeTour(userId: string, tourType: string, feedback?: TourFeedback): Promise<CompletionResult> {
    // Mark tour as completed
    // Process user feedback and ratings
    // Update user onboarding status
    // Suggest next recommended tours
  }
}

// Hook: useTour
// Dependencies: Tour provider, tour engine, user context

export function useTour(tourType?: string) {
  const {
    currentTour,
    isActive,
    currentStep,
    totalSteps,
    tourData,
    startTour,
    nextStep,
    previousStep,
    skipTour,
    completeTour,
    restartTour
  } = useTourContext();
  
  // Tour control functions
  // Progress tracking utilities
  // Step validation helpers
  // Analytics integration
  
  return {
    // Tour state and controls
    // Helper functions for tour management
  };
}
```

### CODE EXAMPLES

#### Example 1: Dashboard Tour Component
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
'use client';
import { useState, useEffect, useRef } from 'react';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { X, ChevronLeft, ChevronRight, Target, HelpCircle } from 'lucide-react';
import { createPortal } from 'react-dom';

interface TourStep {
  id: string;
  title: string;
  description: string;
  targetElement: string;
  position: 'top' | 'bottom' | 'left' | 'right' | 'center';
  content: string;
  actionRequired?: {
    type: 'click' | 'input' | 'navigate';
    target: string;
    expectedValue?: string;
  };
  nextTrigger: 'auto' | 'manual' | 'action_completion';
}

interface DashboardTourProps {
  tourType: string;
  isActive: boolean;
  onComplete: () => void;
  onSkip: () => void;
  onStepChange: (stepIndex: number) => void;
}

export function DashboardTour({ tourType, isActive, onComplete, onSkip, onStepChange }: DashboardTourProps) {
  const [currentStepIndex, setCurrentStepIndex] = useState(0);
  const [steps, setSteps] = useState<TourStep[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [highlightedElement, setHighlightedElement] = useState<HTMLElement | null>(null);
  const [stepPosition, setStepPosition] = useState({ x: 0, y: 0 });
  const [isStepVisible, setIsStepVisible] = useState(false);
  const overlayRef = useRef<HTMLDivElement>(null);
  const stepCardRef = useRef<HTMLDivElement>(null);

  // Default tour steps for dashboard onboarding
  const defaultSteps: TourStep[] = [
    {
      id: 'welcome',
      title: 'Welcome to WedSync! 🎉',
      description: 'Let\'s get your wedding organized in just a few minutes.',
      targetElement: '[data-tour="dashboard-header"]',
      position: 'center',
      content: 'This is your wedding command center where you\'ll manage all your wedding details, vendors, and timeline.',
      nextTrigger: 'manual'
    },
    {
      id: 'wedding-details',
      title: 'Add Your Wedding Details',
      description: 'Start by adding your wedding date and basic information.',
      targetElement: '[data-tour="wedding-details-card"]',
      position: 'right',
      content: 'Click here to add your wedding date, venue, and other essential details. This information will be shared with all your vendors.',
      actionRequired: {
        type: 'click',
        target: '[data-tour="wedding-details-card"]'
      },
      nextTrigger: 'action_completion'
    },
    {
      id: 'add-vendors',
      title: 'Connect Your Vendors',
      description: 'Add your wedding vendors to keep everyone coordinated.',
      targetElement: '[data-tour="vendors-section"]',
      position: 'top',
      content: 'Add your photographer, venue, caterer, and other vendors here. They\'ll get access to relevant wedding information and can update their timeline items.',
      actionRequired: {
        type: 'click',
        target: '[data-tour="add-vendor-button"]'
      },
      nextTrigger: 'manual'
    },
    {
      id: 'guest-list',
      title: 'Import Your Guest List',
      description: 'Upload or manually add your wedding guests.',
      targetElement: '[data-tour="guest-list-card"]',
      position: 'left',
      content: 'You can import from a CSV file or add guests manually. This helps with seating arrangements and dietary tracking.',
      nextTrigger: 'manual'
    },
    {
      id: 'timeline',
      title: 'Create Your Wedding Timeline',
      description: 'Build your wedding day schedule.',
      targetElement: '[data-tour="timeline-card"]',
      position: 'bottom',
      content: 'Create a detailed timeline for your wedding day. Your vendors can see relevant parts and add their own timeline items.',
      nextTrigger: 'manual'
    },
    {
      id: 'sharing',
      title: 'Share with Your Team',
      description: 'Control who sees what information.',
      targetElement: '[data-tour="sharing-controls"]',
      position: 'top',
      content: 'Set permissions for vendors, family members, and your wedding planner. You control exactly what information each person can access.',
      nextTrigger: 'manual'
    },
    {
      id: 'mobile-app',
      title: 'Don\'t Forget the Mobile App!',
      description: 'Access everything on the go.',
      targetElement: '[data-tour="mobile-app-banner"]',
      position: 'center',
      content: 'Download the WedSync mobile app to manage your wedding from anywhere. Perfect for venue visits and vendor meetings!',
      nextTrigger: 'manual'
    },
    {
      id: 'complete',
      title: 'You\'re All Set! 🎊',
      description: 'Your wedding organization hub is ready.',
      targetElement: '[data-tour="dashboard-header"]',
      position: 'center',
      content: 'You\'ve completed the setup tour! You can restart this tour anytime from the help menu. Happy planning!',
      nextTrigger: 'manual'
    }
  ];

  useEffect(() => {
    if (isActive) {
      loadTourSteps();
    }
  }, [isActive, tourType]);

  useEffect(() => {
    if (isActive && steps.length > 0) {
      showStep(currentStepIndex);
    }
  }, [currentStepIndex, steps, isActive]);

  // Handle clicks outside tour step
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (!isActive) return;
      
      const target = event.target as HTMLElement;
      const isStepCard = stepCardRef.current?.contains(target);
      const isTargetElement = highlightedElement?.contains(target);
      
      if (!isStepCard && !isTargetElement) {
        // Clicked outside - could advance tour or show hint
        const currentStep = steps[currentStepIndex];
        if (currentStep?.actionRequired) {
          // Show hint about required action
          showActionHint();
        }
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [isActive, currentStepIndex, steps, highlightedElement]);

  const loadTourSteps = async () => {
    setIsLoading(true);
    try {
      // In a real implementation, load from API
      // const response = await fetch(`/api/tours/${tourType}/steps`);
      // const data = await response.json();
      // setSteps(data.steps);
      
      // For now, use default steps
      setSteps(defaultSteps);
      setCurrentStepIndex(0);
    } catch (error) {
      console.error('Error loading tour steps:', error);
      setSteps(defaultSteps);
    } finally {
      setIsLoading(false);
    }
  };

  const showStep = async (stepIndex: number) => {
    if (stepIndex >= steps.length) return;

    const step = steps[stepIndex];
    const targetElement = document.querySelector(step.targetElement) as HTMLElement;
    
    if (!targetElement && step.targetElement !== '[data-tour="center"]') {
      console.warn(`Tour target element not found: ${step.targetElement}`);
      // Skip to next step or show in center
      setTimeout(() => nextStep(), 1000);
      return;
    }

    // Update analytics
    await trackStepView(step.id, stepIndex);
    
    // Position the step card
    if (targetElement) {
      setHighlightedElement(targetElement);
      const position = calculateStepPosition(targetElement, step.position);
      setStepPosition(position);
      
      // Scroll target element into view
      targetElement.scrollIntoView({ 
        behavior: 'smooth', 
        block: 'center',
        inline: 'nearest'
      });
    } else {
      // Center position for welcome/completion steps
      setHighlightedElement(null);
      setStepPosition({ 
        x: window.innerWidth / 2 - 200, 
        y: window.innerHeight / 2 - 150 
      });
    }
    
    setIsStepVisible(true);
    onStepChange(stepIndex);
  };

  const calculateStepPosition = (element: HTMLElement, position: string) => {
    const rect = element.getBoundingClientRect();
    const scrollX = window.pageXOffset;
    const scrollY = window.pageYOffset;
    
    const stepCardWidth = 400;
    const stepCardHeight = 200;
    const padding = 20;

    let x = 0;
    let y = 0;

    switch (position) {
      case 'top':
        x = rect.left + scrollX + (rect.width / 2) - (stepCardWidth / 2);
        y = rect.top + scrollY - stepCardHeight - padding;
        break;
      case 'bottom':
        x = rect.left + scrollX + (rect.width / 2) - (stepCardWidth / 2);
        y = rect.bottom + scrollY + padding;
        break;
      case 'left':
        x = rect.left + scrollX - stepCardWidth - padding;
        y = rect.top + scrollY + (rect.height / 2) - (stepCardHeight / 2);
        break;
      case 'right':
        x = rect.right + scrollX + padding;
        y = rect.top + scrollY + (rect.height / 2) - (stepCardHeight / 2);
        break;
      case 'center':
      default:
        x = window.innerWidth / 2 - stepCardWidth / 2;
        y = window.innerHeight / 2 - stepCardHeight / 2;
        break;
    }

    // Keep within viewport bounds
    x = Math.max(10, Math.min(x, window.innerWidth - stepCardWidth - 10));
    y = Math.max(10, Math.min(y, window.innerHeight - stepCardHeight - 10));

    return { x, y };
  };

  const trackStepView = async (stepId: string, stepIndex: number) => {
    try {
      await fetch('/api/tours/progress', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          tourType,
          stepId,
          action: 'viewed',
          interactionData: { stepIndex, timestamp: new Date().toISOString() }
        })
      });
    } catch (error) {
      console.error('Error tracking step view:', error);
    }
  };

  const nextStep = async () => {
    const currentStep = steps[currentStepIndex];
    
    // Track step completion
    await trackStepCompletion(currentStep.id);

    if (currentStepIndex < steps.length - 1) {
      setCurrentStepIndex(prev => prev + 1);
    } else {
      // Tour complete
      completeTour();
    }
  };

  const previousStep = () => {
    if (currentStepIndex > 0) {
      setCurrentStepIndex(prev => prev - 1);
    }
  };

  const skipTour = async () => {
    if (confirm('Are you sure you want to skip the tour? You can restart it anytime from the help menu.')) {
      await trackTourSkip();
      onSkip();
    }
  };

  const completeTour = async () => {
    try {
      await fetch('/api/tours/complete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          tourType,
          feedback: {
            wasHelpful: true, // Could show feedback modal
            rating: 5
          }
        })
      });
      
      onComplete();
    } catch (error) {
      console.error('Error completing tour:', error);
      onComplete();
    }
  };

  const trackStepCompletion = async (stepId: string) => {
    try {
      await fetch('/api/tours/progress', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          tourType,
          stepId,
          action: 'completed'
        })
      });
    } catch (error) {
      console.error('Error tracking step completion:', error);
    }
  };

  const trackTourSkip = async () => {
    try {
      await fetch('/api/tours/progress', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          tourType,
          stepId: 'tour_skipped',
          action: 'skipped'
        })
      });
    } catch (error) {
      console.error('Error tracking tour skip:', error);
    }
  };

  const showActionHint = () => {
    // Show a subtle animation or hint about the required action
    if (highlightedElement) {
      highlightedElement.style.animation = 'pulse 1s ease-in-out 2';
      setTimeout(() => {
        if (highlightedElement) {
          highlightedElement.style.animation = '';
        }
      }, 2000);
    }
  };

  if (!isActive || isLoading || steps.length === 0) {
    return null;
  }

  const currentStep = steps[currentStepIndex];
  const progress = ((currentStepIndex + 1) / steps.length) * 100;

  return createPortal(
    <>
      {/* Overlay */}
      <div 
        ref={overlayRef}
        className="fixed inset-0 z-50"
        style={{ 
          backgroundColor: 'rgba(0, 0, 0, 0.4)',
          backdropFilter: 'blur(2px)'
        }}
      />
      
      {/* Element Highlight */}
      {highlightedElement && (
        <div
          className="fixed z-[60] pointer-events-none"
          style={{
            left: highlightedElement.getBoundingClientRect().left - 8,
            top: highlightedElement.getBoundingClientRect().top - 8,
            width: highlightedElement.getBoundingClientRect().width + 16,
            height: highlightedElement.getBoundingClientRect().height + 16,
            border: '3px solid #2563eb',
            borderRadius: '8px',
            boxShadow: '0 0 20px rgba(37, 99, 235, 0.3)',
            animation: 'pulse 2s ease-in-out infinite'
          }}
        />
      )}

      {/* Tour Step Card */}
      {isStepVisible && (
        <Card 
          ref={stepCardRef}
          className="fixed z-[70] w-96 shadow-2xl border-2 border-blue-200"
          style={{
            left: stepPosition.x,
            top: stepPosition.y,
            animation: 'fadeIn 0.3s ease-out'
          }}
        >
          <CardContent className="p-6">
            {/* Header */}
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center space-x-2">
                <Target className="w-5 h-5 text-blue-600" />
                <span className="text-sm text-gray-600">
                  Step {currentStepIndex + 1} of {steps.length}
                </span>
              </div>
              <Button
                variant="ghost"
                size="sm"
                onClick={skipTour}
                className="text-gray-500 hover:text-gray-700"
              >
                <X className="w-4 h-4" />
              </Button>
            </div>

            {/* Progress */}
            <Progress value={progress} className="mb-4 h-2" />

            {/* Content */}
            <div className="mb-6">
              <h3 className="text-lg font-semibold mb-2">{currentStep.title}</h3>
              <p className="text-gray-700 mb-3">{currentStep.description}</p>
              <div className="text-sm text-gray-600">
                {currentStep.content}
              </div>
            </div>

            {/* Action Required Indicator */}
            {currentStep.actionRequired && (
              <div className="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div className="flex items-center space-x-2">
                  <HelpCircle className="w-4 h-4 text-yellow-600" />
                  <span className="text-sm font-medium text-yellow-800">
                    Action Required: {
                      currentStep.actionRequired.type === 'click' ? 'Click the highlighted element' :
                      currentStep.actionRequired.type === 'input' ? 'Fill in the required information' :
                      'Navigate to the specified area'
                    }
                  </span>
                </div>
              </div>
            )}

            {/* Navigation */}
            <div className="flex justify-between">
              <Button
                variant="outline"
                onClick={previousStep}
                disabled={currentStepIndex === 0}
                className="flex items-center space-x-2"
              >
                <ChevronLeft className="w-4 h-4" />
                <span>Previous</span>
              </Button>

              <div className="flex space-x-2">
                <Button
                  variant="outline"
                  onClick={skipTour}
                >
                  Skip Tour
                </Button>
                
                {currentStepIndex === steps.length - 1 ? (
                  <Button onClick={completeTour} className="bg-blue-600 hover:bg-blue-700">
                    Finish Tour 🎉
                  </Button>
                ) : (
                  <Button onClick={nextStep} className="flex items-center space-x-2">
                    <span>Next</span>
                    <ChevronRight className="w-4 h-4" />
                  </Button>
                )}
              </div>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Custom Styles */}
      <style jsx>{`
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(-10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
          0%, 100% { transform: scale(1); opacity: 1; }
          50% { transform: scale(1.05); opacity: 0.8; }
        }
      `}</style>
    </>,
    document.body
  );
}
```

#### Example 2: Tour Provider and Hook
```typescript
'use client';
import { createContext, useContext, useState, useEffect, ReactNode } from 'react';

interface TourContextValue {
  currentTour: string | null;
  isActive: boolean;
  currentStep: number;
  totalSteps: number;
  tourData: any;
  availableTours: AvailableTour[];
  startTour: (tourType: string, context?: any) => Promise<void>;
  nextStep: () => void;
  previousStep: () => void;
  skipTour: () => void;
  completeTour: () => void;
  restartTour: () => void;
  getTourProgress: (tourType: string) => TourProgress | null;
}

const TourContext = createContext<TourContextValue | null>(null);

interface TourProviderProps {
  children: ReactNode;
  userId: string;
  userType: 'couple' | 'vendor' | 'planner';
}

export function TourProvider({ children, userId, userType }: TourProviderProps) {
  const [currentTour, setCurrentTour] = useState<string | null>(null);
  const [isActive, setIsActive] = useState(false);
  const [currentStep, setCurrentStep] = useState(0);
  const [totalSteps, setTotalSteps] = useState(0);
  const [tourData, setTourData] = useState<any>({});
  const [availableTours, setAvailableTours] = useState<AvailableTour[]>([]);

  useEffect(() => {
    loadAvailableTours();
    checkForAutoTriggerTours();
  }, [userId]);

  const loadAvailableTours = async () => {
    try {
      const response = await fetch('/api/tours/available');
      const data = await response.json();
      setAvailableTours(data.tours || []);
      
      // Check for recommended tour
      if (data.recommendedTour && !isActive) {
        // Could auto-start recommended tour or show suggestion
        showTourSuggestion(data.recommendedTour);
      }
    } catch (error) {
      console.error('Error loading available tours:', error);
    }
  };

  const checkForAutoTriggerTours = async () => {
    // Check if user needs onboarding tour
    const hasCompletedOnboarding = availableTours.find(t => t.tourType === 'dashboard_onboarding')?.isCompleted;
    
    if (!hasCompletedOnboarding && userType === 'couple') {
      // Show onboarding suggestion after a short delay
      setTimeout(() => {
        showTourSuggestion('dashboard_onboarding');
      }, 2000);
    }
  };

  const showTourSuggestion = (tourType: string) => {
    const tour = availableTours.find(t => t.tourType === tourType);
    if (!tour) return;

    // Could show a non-intrusive banner or modal suggesting the tour
    if (confirm(`Would you like to take a quick ${tour.estimatedDuration} tour to get started with WedSync?`)) {
      startTour(tourType);
    }
  };

  const startTour = async (tourType: string, context?: any) => {
    try {
      setIsActive(true);
      setCurrentTour(tourType);
      setCurrentStep(0);
      
      const response = await fetch('/api/tours/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tourType, context })
      });
      
      const data = await response.json();
      if (data.success) {
        setTotalSteps(data.tourSteps.length);
        setTourData(data.tourData);
      }
    } catch (error) {
      console.error('Error starting tour:', error);
      setIsActive(false);
    }
  };

  const nextStep = () => {
    if (currentStep < totalSteps - 1) {
      setCurrentStep(prev => prev + 1);
    }
  };

  const previousStep = () => {
    if (currentStep > 0) {
      setCurrentStep(prev => prev - 1);
    }
  };

  const skipTour = () => {
    setIsActive(false);
    setCurrentTour(null);
    setCurrentStep(0);
    setTourData({});
  };

  const completeTour = () => {
    setIsActive(false);
    setCurrentTour(null);
    setCurrentStep(0);
    setTourData({});
    
    // Reload available tours to update completion status
    loadAvailableTours();
  };

  const restartTour = () => {
    if (currentTour) {
      setCurrentStep(0);
      setIsActive(true);
    }
  };

  const getTourProgress = (tourType: string): TourProgress | null => {
    const tour = availableTours.find(t => t.tourType === tourType);
    return tour ? {
      tourType: tour.tourType,
      currentStep: tour.currentStep,
      totalSteps: tour.totalSteps,
      completionPercentage: tour.completionPercentage,
      isCompleted: tour.isCompleted
    } : null;
  };

  const contextValue: TourContextValue = {
    currentTour,
    isActive,
    currentStep,
    totalSteps,
    tourData,
    availableTours,
    startTour,
    nextStep,
    previousStep,
    skipTour,
    completeTour,
    restartTour,
    getTourProgress
  };

  return (
    <TourContext.Provider value={contextValue}>
      {children}
    </TourContext.Provider>
  );
}

export function useTour(tourType?: string) {
  const context = useContext(TourContext);
  if (!context) {
    throw new Error('useTour must be used within a TourProvider');
  }

  const {
    currentTour,
    isActive,
    currentStep,
    totalSteps,
    tourData,
    availableTours,
    startTour,
    nextStep,
    previousStep,
    skipTour,
    completeTour,
    restartTour,
    getTourProgress
  } = context;

  // Tour-specific utilities
  const isCurrentTour = tourType ? currentTour === tourType : false;
  const tourProgress = tourType ? getTourProgress(tourType) : null;

  const startSpecificTour = (context?: any) => {
    if (tourType) {
      return startTour(tourType, context);
    }
    throw new Error('Tour type must be specified to start tour');
  };

  return {
    // Global tour state
    currentTour,
    isActive,
    currentStep,
    totalSteps,
    tourData,
    availableTours,

    // Tour controls
    startTour,
    startSpecificTour: tourType ? startSpecificTour : undefined,
    nextStep,
    previousStep,
    skipTour,
    completeTour,
    restartTour,

    // Tour-specific state (when tourType provided)
    isCurrentTour,
    tourProgress,

    // Utilities
    isTourCompleted: (checkTourType: string) => {
      const tour = availableTours.find(t => t.tourType === checkTourType);
      return tour?.isCompleted || false;
    },
    
    canStartTour: (checkTourType: string) => {
      return availableTours.some(t => t.tourType === checkTourType && !t.isCompleted);
    }
  };
}

// Custom hook for tour triggers
export function useTourTrigger(tourType: string, trigger: 'first_visit' | 'feature_access' | 'manual') {
  const { startTour, isTourCompleted, canStartTour } = useTour();
  const [hasTriggered, setHasTriggered] = useState(false);

  useEffect(() => {
    if (hasTriggered || !canStartTour(tourType) || isTourCompleted(tourType)) {
      return;
    }

    const triggerTour = () => {
      setHasTriggered(true);
      
      if (trigger === 'first_visit') {
        // Check localStorage or session storage for first visit
        const hasVisited = localStorage.getItem(`tour_${tourType}_triggered`);
        if (!hasVisited) {
          setTimeout(() => {
            if (confirm('Would you like a quick tour to get started?')) {
              startTour(tourType);
            }
          }, 1000);
          localStorage.setItem(`tour_${tourType}_triggered`, 'true');
        }
      }
    };

    triggerTour();
  }, [tourType, trigger, startTour, hasTriggered, canStartTour, isTourCompleted]);

  return {
    triggerTour: () => {
      if (canStartTour(tourType)) {
        startTour(tourType);
      }
    }
  };
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Ref MCP: Search docs for React tour libraries, onboarding patterns
- [x] Supabase MCP: Database operations and user progress tracking
- [x] Browser MCP: Interactive testing of tour functionality and positioning
- [x] Filesystem: Access tour configurations and templates

#### Ref MCP Searches Needed
```bash
# Use Ref MCP to search for:
# - "React onboarding tour libraries"
# - "User engagement tour patterns"
# - "Dashboard tour best practices"
# - "Interactive guide positioning algorithms"
```

#### Browser MCP Interactive Testing
```bash
# Use Browser MCP for:
# - Testing tour step positioning and responsiveness
# - Verifying tour navigation and progress tracking
# - Screenshot capture of tour steps
# - Testing mobile responsive tour behavior
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('DashboardTour', () => {
  it('should load and display tour steps correctly', async () => {
    // Test tour initialization and step rendering
  });
  
  it('should position tour steps relative to target elements', () => {
    // Test step positioning algorithm
  });
  
  it('should track tour progress and analytics', async () => {
    // Test progress tracking and analytics integration
  });
  
  it('should handle missing target elements gracefully', () => {
    // Test error handling for missing tour targets
  });
});

describe('useTour hook', () => {
  it('should provide tour control functions', () => {
    // Test hook functionality and state management
  });
  
  it('should trigger tours based on conditions', async () => {
    // Test automatic tour triggering logic
  });
});
```

#### E2E Tests Required
```typescript
test('Complete dashboard onboarding tour', async () => {
  await mcp__playwright__browser_navigate({url: '/dashboard'});
  
  // Tour should auto-suggest for new users
  const tourSuggestion = await page.waitForSelector('[data-testid="tour-suggestion"]');
  expect(tourSuggestion).toBeTruthy();
  
  // Start the tour
  await mcp__playwright__browser_click({element: 'Start tour button', ref: '[data-testid="start-tour"]'});
  
  // Verify first step appears
  const tourStep = await page.waitForSelector('[data-testid="tour-step"]');
  expect(tourStep).toBeTruthy();
  
  // Progress through several steps
  await mcp__playwright__browser_click({element: 'Next button', ref: '[data-testid="tour-next"]'});
  await mcp__playwright__browser_click({element: 'Next button', ref: '[data-testid="tour-next"]'});
  
  // Test action required step
  const actionStep = await page.waitForSelector('[data-testid="action-required"]');
  if (actionStep) {
    await mcp__playwright__browser_click({element: 'Required action target', ref: '[data-tour="wedding-details-card"]'});
  }
  
  // Complete tour
  await mcp__playwright__browser_click({element: 'Finish tour button', ref: '[data-testid="finish-tour"]'});
  
  // Verify tour completion
  const completionMessage = await page.waitForSelector('[data-testid="tour-complete"]');
  expect(completionMessage).toBeTruthy();
});

test('Tour positioning on different screen sizes', async () => {
  // Test mobile viewport
  await mcp__playwright__browser_resize({width: 375, height: 667});
  await mcp__playwright__browser_navigate({url: '/dashboard'});
  await mcp__playwright__browser_click({element: 'Start tour', ref: '[data-testid="start-tour"]'});
  
  // Take mobile screenshot
  await mcp__playwright__browser_take_screenshot({filename: 'tour-mobile.png'});
  
  // Test desktop viewport
  await mcp__playwright__browser_resize({width: 1920, height: 1080});
  
  // Take desktop screenshot
  await mcp__playwright__browser_take_screenshot({filename: 'tour-desktop.png'});
});
```

### ACCEPTANCE CRITERIA
- [x] Interactive guided tour for new couple onboarding
- [x] Step-by-step guidance with contextual tooltips
- [x] Responsive tour positioning for all screen sizes
- [x] Progress tracking and analytics for tour completion
- [x] Action-required steps with validation
- [x] Tour skip and restart functionality
- [x] Automatic tour triggering based on user behavior
- [x] Mobile-optimized tour experience
- [x] Accessibility compliance (ARIA labels, keyboard navigation)
- [x] Tour feedback collection and ratings
- [x] **Navigation Integration: Tour controls accessible from help menu and onboarding**
  - [x] Help/Tour button in main navigation header
  - [x] Onboarding progress indicator in user menu
  - [x] Quick restart tour option in settings
  - [x] Tour completion status in user profile
  - [x] Integration with dashboard welcome area for new users

### DEPENDENCIES
- Must complete after: Dashboard creation, wedding management system, vendor management
- Must complete before: Vendor Connections Hub (WS-283)
- Shares code with: Dashboard components, user onboarding system, analytics

### ESTIMATED EFFORT
- Team A Frontend: 32 hours (Tour UI, positioning system, responsive design, animations)
- Team B Backend: 16 hours (Tour APIs, progress tracking, analytics endpoints)
- Team C Integration: 8 hours (Dashboard integration, user management)
- Team D Platform: 12 hours (Tour configuration system, content management)
- Team E General: 20 hours (Testing, accessibility, mobile responsive, cross-browser)
- Team F Workflows: 12 hours (Onboarding flow integration, user experience optimization)
- Team G Performance: 4 hours (Tour loading optimization, animation performance)
- Total: 104 hours