# TECHNICAL SPECIFICATION: WS-092 - Integration Tests Setup
## Generated by Feature Development Session - 2025-08-22

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** WedSync development team
**I want to:** Test complete workflows across multiple components and services
**So that:** Supplier-couple connections never break, core field syncing always works, and wedding data flows correctly between all systems

**Real Wedding Scenario:**
A photographer updates their form fields, but couple's data doesn't sync to the caterer's system.
With integration tests, we catch these cross-system failures before they reach production, preventing couples from having to re-enter details for each vendor.

### SPECIFICATION SOURCE
- **Feature ID:** WS-092
- **Original Spec:** /CORE-SPECIFICATIONS/11-TESTING-DEPLOYMENT/01-Testing/02-integration-tests md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** 
  - /wedsync/package.json (add test scripts)
  - /wedsync/vitest.config.ts (add integration config)
- **New Files to Create:** 
  - /wedsync/tests/integration/setup.ts
  - /wedsync/tests/integration/*.test.ts
  - /wedsync/tests/factories/*.ts

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Test database functions for isolation
CREATE OR REPLACE FUNCTION begin_test_transaction()
RETURNS void
LANGUAGE plpgsql
AS $$
BEGIN
  BEGIN;
END;
$$;

CREATE OR REPLACE FUNCTION rollback_test_transaction()
RETURNS void
LANGUAGE plpgsql
AS $$
BEGIN
  ROLLBACK;
END;
$$;

CREATE OR REPLACE FUNCTION seed_test_data()
RETURNS void
LANGUAGE plpgsql
AS $$
BEGIN
  -- Insert test suppliers, couples, forms
  INSERT INTO suppliers (id, email, business_name, vendor_type, tier) VALUES
  ('test-supplier-123', 'supplier@test.com', 'Test Photography', 'photographer', 'professional');
  
  INSERT INTO couples (id, email, couple_names, core_fields) VALUES
  ('test-couple-456', 'couple@test.com', 'John & Sarah Test', 
   '{"wedding_date": "2025-06-15", "venue_name": "Test Venue", "guest_count": 100}');
END;
$$;
```

#### API Endpoints Required
```typescript
// No new endpoints - testing existing endpoints
// Integration test utilities
interface IntegrationTestContext {
  supplier: { id: string; email: string; tier: string };
  couple: { id: string; email: string; core_fields: any };
  testDb: SupabaseClient;
}

interface TestApiResponse {
  status: number;
  body: any;
  headers: Record<string, string>;
}
```

#### Frontend Components Required
```typescript
// No new components - testing component interactions
// Test harness for full-stack flows
const TestHarness: React.FC<{
  initialSupplier?: Supplier;
  initialCouple?: Couple;
  children: React.ReactNode;
}> = ({ initialSupplier, initialCouple, children }) => {
  return (
    <QueryClient>
      <SupabaseProvider testMode={true}>
        <AuthProvider mockSupplier={initialSupplier} mockCouple={initialCouple}>
          {children}
        </AuthProvider>
      </SupabaseProvider>
    </QueryClient>
  );
};
```

#### Integration Points
```typescript
// Integration Testing Service
class IntegrationTestingService {
  private testDb: SupabaseClient;
  
  constructor() {
    this.testDb = createClient(
      process.env.SUPABASE_TEST_URL!,
      process.env.SUPABASE_TEST_SERVICE_KEY!
    );
  }
  
  async setupTestTransaction() {
    await this.testDb.rpc('begin_test_transaction');
  }
  
  async cleanupTestTransaction() {
    await this.testDb.rpc('rollback_test_transaction');
  }
  
  async testSupplierCoupleConnection(supplierId: string, coupleId: string) {
    // Test complete supplier-couple workflow
    const connection = await connectSupplierToCouple(supplierId, coupleId);
    const formAccess = await this.verifyFormAccess(coupleId, supplierId);
    const coreFieldSync = await this.verifyCoreFieldSync(coupleId);
    
    return {
      connection,
      formAccess,
      coreFieldSync
    };
  }
}
```

### CODE EXAMPLES

#### Example 1: Test Environment Setup
```typescript
// tests/integration/setup.ts
import { createClient, SupabaseClient } from '@supabase/supabase-js';
import { beforeAll, afterAll, beforeEach, afterEach } from 'vitest';
import { execSync } from 'child_process';

export const testDb: SupabaseClient = createClient(
  process.env.SUPABASE_TEST_URL!,
  process.env.SUPABASE_TEST_SERVICE_KEY!
);

export const testSupplier = {
  id: 'test-supplier-123',
  email: 'supplier@test.com',
  business_name: 'Test Photography',
  vendor_type: 'photographer',
  tier: 'professional'
};

export const testCouple = {
  id: 'test-couple-456',
  email: 'couple@test.com',
  couple_names: 'John & Sarah Test',
  core_fields: {
    wedding_date: '2025-06-15',
    venue_name: 'Test Venue',
    guest_count: 100
  }
};

beforeAll(async () => {
  // Ensure test database is clean and migrated
  console.log('Setting up integration test database...');
  execSync('npm run db:migrate:test', { stdio: 'inherit' });
  
  // Seed basic test data
  await testDb.rpc('seed_test_data');
});

beforeEach(async () => {
  // Start transaction for test isolation
  await testDb.rpc('begin_test_transaction');
});

afterEach(async () => {
  // Rollback transaction to clean state
  await testDb.rpc('rollback_test_transaction');
});

afterAll(async () => {
  // Clean up test database
  await testDb.rpc('cleanup_test_database');
});
```

#### Example 2: Supplier-Couple Connection Integration Test
```typescript
// tests/integration/supplier-couple-flow.test.ts
import { describe, it, expect } from 'vitest';
import { testDb, testSupplier, testCouple } from './setup';
import { connectSupplierToCouple } from '@/lib/connections/supplier-couple';
import { syncCoreFields } from '@/lib/core-fields/sync';

describe('Supplier-Couple Connection Integration', () => {
  it('should establish full connection with data sync', async () => {
    // Create supplier with forms
    const supplier = await testDb
      .from('suppliers')
      .insert({
        ...testSupplier,
        created_at: new Date().toISOString()
      })
      .select()
      .single();
    
    // Create photographer questionnaire form
    const form = await testDb
      .from('forms')
      .insert({
        supplier_id: supplier.data.id,
        name: 'Photography Questionnaire',
        fields: [
          { id: 'wedding_date', type: 'date', label: 'Wedding Date', core_field: true, required: true },
          { id: 'venue_name', type: 'text', label: 'Venue Name', core_field: true, required: true },
          { id: 'photo_style', type: 'select', label: 'Photo Style', core_field: false, options: ['natural', 'posed'] }
        ]
      })
      .select()
      .single();
    
    // Create couple with core fields
    const couple = await testDb
      .from('couples')
      .insert({
        ...testCouple,
        created_at: new Date().toISOString()
      })
      .select()
      .single();
    
    // Test the connection process
    const connection = await connectSupplierToCouple(
      supplier.data.id,
      couple.data.id
    );
    
    // Verify connection was created successfully
    expect(connection.status).toBe('connected');
    expect(connection.supplier_id).toBe(supplier.data.id);
    expect(connection.couple_id).toBe(couple.data.id);
    
    // Verify couple can access supplier's forms
    const accessibleForms = await testDb
      .from('form_access')
      .select('*')
      .eq('couple_id', couple.data.id)
      .eq('form_id', form.data.id);
    
    expect(accessibleForms.data).toHaveLength(1);
    expect(accessibleForms.data[0].access_level).toBe('fill');
    
    // Test core fields auto-population
    const formWithCoreFields = await testDb
      .rpc('get_form_with_core_fields', {
        form_id: form.data.id,
        couple_id: couple.data.id
      });
    
    expect(formWithCoreFields.data.fields[0].value).toBe('2025-06-15');
    expect(formWithCoreFields.data.fields[1].value).toBe('Test Venue');
    expect(formWithCoreFields.data.fields[2].value).toBeNull(); // Non-core field
  });

  it('should sync core field changes across all connected suppliers', async () => {
    // Setup: Create couple connected to multiple suppliers
    const photographer = await testDb
      .from('suppliers')
      .insert({ ...testSupplier, vendor_type: 'photographer' })
      .select()
      .single();
    
    const caterer = await testDb
      .from('suppliers')
      .insert({ ...testSupplier, id: 'caterer-123', vendor_type: 'caterer' })
      .select()
      .single();
    
    const couple = await testDb
      .from('couples')
      .insert(testCouple)
      .select()
      .single();
    
    // Connect both suppliers
    await connectSupplierToCouple(photographer.data.id, couple.data.id);
    await connectSupplierToCouple(caterer.data.id, couple.data.id);
    
    // Update core fields from couple dashboard
    const updatedCoreFields = {
      wedding_date: '2025-08-20',
      venue_name: 'New Venue Name',
      guest_count: 150
    };
    
    await testDb
      .from('couples')
      .update({ core_fields: updatedCoreFields })
      .eq('id', couple.data.id);
    
    // Trigger sync across all suppliers
    await syncCoreFields(couple.data.id);
    
    // Verify photographer sees updated fields
    const photographerForms = await testDb
      .from('form_field_values')
      .select('*')
      .eq('supplier_id', photographer.data.id)
      .eq('couple_id', couple.data.id);
    
    expect(photographerForms.data).toContainEqual(
      expect.objectContaining({
        field_name: 'wedding_date',
        value: '2025-08-20'
      })
    );
    
    // Verify caterer sees updated fields
    const catererForms = await testDb
      .from('form_field_values')
      .select('*')
      .eq('supplier_id', caterer.data.id)
      .eq('couple_id', couple.data.id);
    
    expect(catererForms.data).toContainEqual(
      expect.objectContaining({
        field_name: 'venue_name',
        value: 'New Venue Name'
      })
    );
  });
});
```

#### Example 3: Journey Automation Integration Test
```typescript
// tests/integration/journey-automation.test.ts
import { describe, it, expect, vi } from 'vitest';
import { testDb, testSupplier, testCouple } from './setup';
import { executeJourneyModule, JourneyExecutor } from '@/lib/journey-engine/executor';
import { sendEmail } from '@/lib/services/email-service';
import { createCalendarEvent } from '@/lib/services/calendar-service';

// Mock external services
vi.mock('@/lib/services/email-service');
vi.mock('@/lib/services/calendar-service');

describe('Journey Automation Integration', () => {
  it('should execute multi-step journey correctly', async () => {
    const mockSendEmail = vi.mocked(sendEmail);
    const mockCreateCalendarEvent = vi.mocked(createCalendarEvent);
    
    // Create supplier and journey
    const supplier = await testDb
      .from('suppliers')
      .insert(testSupplier)
      .select()
      .single();
    
    const journey = await testDb
      .from('customer_journeys')
      .insert({
        supplier_id: supplier.data.id,
        name: 'Photography Onboarding Journey',
        status: 'active',
        modules: [
          {
            id: 'welcome-email',
            type: 'email',
            trigger: 'immediate',
            config: {
              template_id: 'photographer-welcome',
              subject: 'Welcome to our photography services!'
            }
          },
          {
            id: 'questionnaire-form',
            type: 'form',
            trigger: 'after_previous',
            delay_days: 1,
            config: {
              form_id: 'photography-questionnaire'
            }
          },
          {
            id: 'consultation-booking',
            type: 'meeting',
            trigger: 'form_complete',
            config: {
              meeting_type: 'consultation',
              duration_minutes: 60
            }
          }
        ]
      })
      .select()
      .single();
    
    // Create couple and start journey
    const couple = await testDb
      .from('couples')
      .insert(testCouple)
      .select()
      .single();
    
    const execution = await testDb
      .from('journey_executions')
      .insert({
        journey_id: journey.data.id,
        couple_id: couple.data.id,
        current_module: 'welcome-email',
        started_at: new Date().toISOString()
      })
      .select()
      .single();
    
    const executor = new JourneyExecutor(testDb);
    
    // Execute welcome email module
    await executor.executeModule(execution.data.id, 'welcome-email');
    
    expect(mockSendEmail).toHaveBeenCalledWith({
      to: couple.data.email,
      template_id: 'photographer-welcome',
      subject: 'Welcome to our photography services!',
      data: expect.objectContaining({
        couple_name: couple.data.couple_names,
        supplier_name: supplier.data.business_name
      })
    });
    
    // Advance to form module (simulating delay)
    vi.setSystemTime(new Date(Date.now() + 25 * 60 * 60 * 1000)); // +25 hours
    
    await executor.executeModule(execution.data.id, 'questionnaire-form');
    
    // Verify form access was granted
    const formAccess = await testDb
      .from('form_access')
      .select('*')
      .eq('couple_id', couple.data.id)
      .eq('form_id', 'photography-questionnaire');
    
    expect(formAccess.data).toHaveLength(1);
    
    // Simulate form completion
    await testDb
      .from('form_submissions')
      .insert({
        form_id: 'photography-questionnaire',
        couple_id: couple.data.id,
        execution_id: execution.data.id,
        data: { photo_style: 'natural', special_requests: 'Golden hour shots' },
        status: 'completed'
      });
    
    // Execute meeting module
    await executor.executeModule(execution.data.id, 'consultation-booking');
    
    expect(mockCreateCalendarEvent).toHaveBeenCalledWith({
      title: 'Photography Consultation',
      duration: 60,
      attendees: [couple.data.email, supplier.data.email],
      type: 'consultation'
    });
  });
});
```

### MCP SERVER USAGE

#### Required MCP Servers
- [ ] Context7: Load testing framework documentation
- [ ] Filesystem: Manage test file structure
- [ ] PostgreSQL: Direct database access for test verification

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/vitest/vitest", "integration testing", 2000);
await mcp__context7__get-library-docs("/supabase/supabase-js", "client testing", 2000);
await mcp__context7__get-library-docs("/testing-library/react", "integration", 1500);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
// Integration tests ARE the tests for this feature
// Testing the integration test framework itself
describe('Integration Test Framework', () => {
  it('should properly isolate tests with transactions', () => {
    // Test transaction isolation
  });
  
  it('should clean up test data between runs', () => {
    // Test cleanup mechanisms
  });
});
```

#### E2E Tests Required
```typescript
// E2E tests will use this integration framework
// See WS-093 for full E2E implementation
```

### ACCEPTANCE CRITERIA
- [ ] Test database configured with transaction isolation
- [ ] All critical user flows have integration tests
- [ ] Supplier-couple connection flow tested end-to-end
- [ ] Core field synchronization tested across multiple suppliers
- [ ] Journey automation tested with real workflow
- [ ] API request chains tested (auth → create → share → submit)
- [ ] Test execution completes in under 5 minutes
- [ ] Test data factories created for consistent setup
- [ ] Integration with CI/CD pipeline established

### DEPENDENCIES
- Must complete after: WS-091 (Unit Tests) 
- Must complete before: WS-093 (E2E Tests)
- Shares code with: All features (testing their integrations)

### ESTIMATED EFFORT
- Team A Frontend: 8 hours (component integration tests)
- Team B Backend: 16 hours (API/database integration tests)
- Team C Full-stack: 20 hours (end-to-end workflows)
- Total: 44 hours