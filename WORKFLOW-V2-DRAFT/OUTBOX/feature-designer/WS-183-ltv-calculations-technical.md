# TECHNICAL SPECIFICATION: WS-183 - LTV Calculations
## Generated by Feature Development Session - August 25, 2025

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** WedSync executive analyzing business unit economics and supplier profitability
**I want to:** Calculate accurate lifetime value (LTV) for wedding suppliers with predictive modeling and track LTV:CAC ratios by acquisition channel
**So that:** I can optimize marketing spend, identify high-value supplier segments, and make data-driven decisions about customer acquisition investments

**Real Wedding Scenario:**
WedSync's marketing team spends $500 to acquire a wedding photographer through Google Ads but only $50 to acquire one through referrals. Without LTV tracking, they can't determine which channel delivers more profitable suppliers long-term. The LTV system reveals that Google Ads photographers generate $2,400 lifetime value vs. $3,200 from referrals, showing that referral marketing (LTV:CAC of 64:1) significantly outperforms paid advertising (4.8:1), directing budget allocation decisions.

### SPECIFICATION SOURCE
- **Feature ID:** WS-183
- **Original Spec:** /CORE-SPECIFICATIONS/07-ADMIN-DASHBOARD/02-Revenue-Analytics/04-ltv-calculations md.md
- **Current Implementation:** 0% complete (new)
- **Files to Modify:** None (new feature)
- **New Files to Create:** 
  - `/wedsync/src/components/admin/LTVDashboard.tsx`
  - `/wedsync/src/lib/analytics/ltv-calculator.ts`
  - `/wedsync/src/lib/analytics/cac-calculator.ts`
  - `/wedsync/src/app/api/admin/ltv/route.ts`
  - `/wedsync/supabase/migrations/ltv-calculations-tables.sql`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- User LTV tracking
CREATE TABLE user_ltv (
  user_id UUID PRIMARY KEY REFERENCES users(id),
  historical_ltv DECIMAL(10, 2) NOT NULL DEFAULT 0,
  predicted_ltv DECIMAL(10, 2),
  total_ltv DECIMAL(10, 2),
  confidence_score INTEGER,
  months_active INTEGER,
  last_payment_date DATE,
  churn_probability DECIMAL(3, 2),
  expansion_rate DECIMAL(3, 2),
  cac DECIMAL(10, 2),
  ltv_cac_ratio DECIMAL(5, 2),
  payback_months INTEGER,
  calculated_at TIMESTAMPTZ DEFAULT NOW()
);

-- LTV by segment
CREATE TABLE ltv_segments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  segment_type TEXT NOT NULL,
  segment_value TEXT NOT NULL,
  avg_ltv DECIMAL(10, 2),
  median_ltv DECIMAL(10, 2),
  p90_ltv DECIMAL(10, 2),
  user_count INTEGER,
  avg_tenure DECIMAL(5, 2),
  calculated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(segment_type, segment_value, calculated_at)
);

-- CAC tracking
CREATE TABLE customer_acquisition_costs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  period_start DATE NOT NULL,
  period_end DATE NOT NULL,
  channel TEXT,
  marketing_spend DECIMAL(10, 2),
  operational_spend DECIMAL(10, 2),
  new_customers INTEGER,
  cac DECIMAL(10, 2),
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### API Endpoints Required
```typescript
// GET /api/admin/ltv
interface LTVRequest {
  segment?: 'vendor_type' | 'plan' | 'acquisition_channel';
  timeframe: '12m' | '24m' | 'all';
}

interface LTVResponse {
  success: boolean;
  data: {
    metrics: LTVMetrics;
    segments: LTVSegment[];
    distribution: number[];
    cacRatios: ChannelCAC[];
  };
}
```

#### Frontend Components Required
```typescript
// Component: LTVDashboard
// Location: /src/components/admin/LTVDashboard.tsx

interface Props {
  segment: 'all' | 'vendor_type' | 'plan' | 'acquisition_channel';
  timeframe: '12m' | '24m' | 'all';
}

// Key functionality:
- Average LTV and LTV:CAC ratio monitoring with target thresholds
- Payback period tracking by customer segment and acquisition channel
- LTV distribution histogram showing value concentration
- Predictive LTV modeling with confidence intervals
```

#### Integration Points
```typescript
// Service: LTVCalculator  
// Dependencies: Cohort analysis, subscription billing, payment processing

class LTVCalculator {
  async calculatePredictiveLTV(userId: string): Promise<LTVMetrics> {
    // Multi-model approach combining cohort, probabilistic, and ML predictions
  }
  
  private cohortBasedModel(user: any, cohort: any) {
    // Use cohort retention patterns for LTV prediction
  }
}
```

### CODE EXAMPLES

#### Example 1: Multi-Model LTV Prediction
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { supabase } from '@/lib/supabase';

export async function calculatePredictiveLTV(userId: string) {
  // Step 1: Get user metrics and cohort data
  const { data: userMetrics } = await supabase.rpc('get_user_metrics', {
    user_id: userId
  });
    
  // Step 2: Run multiple prediction models
  if (!userMetrics) throw new Error('User metrics not found');
  
  const models = [
    await cohortBasedPrediction(userMetrics),
    await probabilisticModel(userMetrics), 
    await machinelearningModel(userMetrics)
  ];
  
  // Step 3: Calculate weighted average with confidence scoring
  const prediction = calculateWeightedAverage(models);
  
  return {
    historical: userMetrics.total_revenue,
    predicted: prediction.value,
    total: userMetrics.total_revenue + prediction.value,
    confidence: prediction.confidence,
    paybackPeriod: calculatePaybackMonths(userMetrics.cac, userMetrics.mrr),
    ltvcac: prediction.total / userMetrics.cac
  };
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for statistical analysis libraries, ML prediction models
- [x] PostgreSQL: Execute complex LTV and CAC calculation queries
- [x] Playwright: Test LTV dashboard visualization accuracy

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/vercel/next.js", "api caching strategies", 3000);
await mcp__context7__get-library-docs("/supabase/supabase", "materialized views", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('LTVCalculator', () => {
  it('should accurately predict LTV using cohort-based modeling', () => {
    // Test LTV prediction accuracy against known cohort data
  });
  
  it('should calculate payback periods correctly for different supplier types', () => {
    // Test payback period calculations for photographers vs. venues
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Executive can analyze LTV metrics and channel ROI', async () => {
  await mcp__playwright__browser_navigate({url: '/admin/analytics/ltv'});
  await mcp__playwright__browser_snapshot();
  // Verify LTV:CAC ratios display and segment analysis works
});
```

### ACCEPTANCE CRITERIA
- [x] LTV predictions achieve 80%+ accuracy within 6-month prediction window
- [x] Dashboard displays LTV:CAC ratios by acquisition channel with target indicators
- [x] Payback period calculations account for supplier type and plan variations
- [x] Performance: LTV calculations for all users complete within 5 minutes nightly
- [x] Security: Executive dashboard access with comprehensive audit trails
- [x] Accessibility: Financial data tables compatible with screen readers

### DEPENDENCIES
- Must complete after: WS-181 (Cohort Analysis) AND WS-182 (Churn Intelligence) - requires behavioral data
- Must complete before: Marketing optimization features - provides ROI data
- Shares code with: Revenue analytics infrastructure and predictive modeling

### ESTIMATED EFFORT
- Team A Frontend: 32 hours (LTV dashboard with complex visualizations and segment analysis)
- Team B Backend: 42 hours (Multi-model LTV prediction engine and CAC calculations)
- Team C Integration: 24 hours (Payment data integration, nightly calculation jobs)
- Total: 98 hours