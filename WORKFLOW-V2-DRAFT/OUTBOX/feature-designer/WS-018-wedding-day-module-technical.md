# TECHNICAL SPECIFICATION: WS-018 - Wedding Day Module
## Generated by Feature Development Session - August 21, 2025

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding photographer rushing between two venues on Saturday
**I want to:** See all critical wedding day info (venue address, timeline, contacts) in one dashboard
**So that:** I never miss a shot because I'm searching through emails for the venue address or ceremony time

**Real Wedding Scenario:**
A photographer arrives at wrong church location (St. Mary's on Oak vs St. Mary's on Pine).
They miss the bride's entrance, losing irreplaceable moments and facing angry clients.
With this module, venue details with Google Maps link appear automatically 48 hours before.

### SPECIFICATION SOURCE
- **Feature ID:** WS-018
- **Original Spec:** /CORE-SPECIFICATIONS/02-WEDSYNC-SUPPLIER-PLATFORM/02-Dashboard/06-wedding-day-module.md
- **Current Implementation:** 0% complete
- **Files to Modify:** 
  - /wedsync/src/app/(dashboard)/dashboard/page.tsx
- **New Files to Create:**
  - /wedsync/src/components/dashboard/WeddingDayModule.tsx
  - /wedsync/src/components/dashboard/TravelTimeWidget.tsx
  - /wedsync/src/components/dashboard/TimelineTracker.tsx
  - /wedsync/src/lib/services/wedding-day-service.ts
  - /wedsync/src/app/api/wedding-day/route.ts
  - /wedsync/supabase/migrations/019_wedding_day_module.sql

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Wedding day cached data for offline support
CREATE TABLE IF NOT EXISTS wedding_day_cache (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,
  client_id UUID NOT NULL REFERENCES clients(id) ON DELETE CASCADE,
  wedding_date DATE NOT NULL,
  venue_data JSONB NOT NULL,
  timeline_data JSONB NOT NULL,
  contacts_data JSONB NOT NULL,
  travel_data JSONB,
  checklist_data JSONB DEFAULT '[]',
  cache_updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(supplier_id, client_id, wedding_date)
);

-- Travel time calculations
CREATE TABLE IF NOT EXISTS travel_calculations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID NOT NULL REFERENCES suppliers(id),
  from_location JSONB NOT NULL,
  to_location JSONB NOT NULL,
  departure_time TIMESTAMPTZ NOT NULL,
  estimated_duration_minutes INTEGER,
  traffic_level TEXT CHECK (traffic_level IN ('light', 'moderate', 'heavy')),
  alternative_routes JSONB,
  calculated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Day-of checklists
CREATE TABLE IF NOT EXISTS wedding_day_checklists (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID NOT NULL REFERENCES suppliers(id),
  client_id UUID NOT NULL REFERENCES clients(id),
  item_text TEXT NOT NULL,
  category TEXT CHECK (category IN ('pre_ceremony', 'ceremony', 'reception', 'post_event')),
  is_completed BOOLEAN DEFAULT false,
  completed_at TIMESTAMPTZ,
  completed_by UUID REFERENCES team_members(id),
  sort_order INTEGER DEFAULT 0
);

-- Indexes
CREATE INDEX idx_wedding_day_date ON wedding_day_cache(wedding_date);
CREATE INDEX idx_wedding_day_supplier ON wedding_day_cache(supplier_id, wedding_date);
CREATE INDEX idx_travel_calc_departure ON travel_calculations(departure_time);
```

#### API Endpoints Required
```typescript
// GET /api/wedding-day/active
interface ActiveWeddingsResponse {
  success: boolean;
  data: {
    weddings: {
      clientId: string;
      clientName: string;
      weddingDate: string;
      venue: {
        name: string;
        address: string;
        coordinates: { lat: number; lng: number };
        phone: string;
      };
      ceremonyTime: string;
      isToday: boolean;
      hoursUntil: number;
    }[];
  };
}

// GET /api/wedding-day/{clientId}/details
interface WeddingDayDetailsResponse {
  success: boolean;
  data: {
    logistics: {
      venue: {
        name: string;
        address: string;
        googleMapsUrl: string;
        parkingInstructions?: string;
      };
      travel: {
        estimatedDuration: number;
        recommendedDeparture: string;
        trafficStatus: string;
        alternativeRoutes?: Route[];
      };
    };
    timeline: {
      events: {
        time: string;
        title: string;
        location?: string;
        duration: number;
        isCurrent: boolean;
        isNext: boolean;
      }[];
    };
    contacts: {
      couple: Contact[];
      venue: Contact;
      vendors: VendorContact[];
      emergency: Contact[];
    };
    checklist: {
      items: ChecklistItem[];
      completionPercentage: number;
    };
  };
}

// POST /api/wedding-day/checklist/{itemId}/complete
interface CompleteChecklistRequest {
  completed: boolean;
}
```

#### Frontend Components Required
```typescript
// Component: WeddingDayModule
// Location: /src/components/dashboard/WeddingDayModule.tsx

interface WeddingDayModuleProps {
  weddings: WeddingDayData[];
  currentTime: Date;
  onChecklistUpdate?: (itemId: string, completed: boolean) => void;
}

// Key functionality:
- Auto-activate 48 hours before wedding
- Display countdown timer
- Show current/next timeline event
- Quick access to all contacts
- Offline data caching
- Print-friendly view option

// Component: TravelTimeWidget
// Location: /src/components/dashboard/TravelTimeWidget.tsx

interface TravelTimeWidgetProps {
  from: Location;
  to: Location;
  departureTime: Date;
  onRouteSelect?: (route: Route) => void;
}

// Key functionality:
- Real-time traffic updates
- Weather impact calculation
- Alternative route display
- Integration with Google Maps
- Departure reminder notifications
```

#### Integration Points
```typescript
// Service: WeddingDayService
// Dependencies: GoogleMapsAPI, WeatherService, NotificationService

class WeddingDayService {
  async getActiveWeddings(supplierId: string) {
    // Check for weddings within 48 hours
    // Fetch venue and timeline data
    // Calculate travel times
    // Return prioritized list
  }

  async calculateTravelTime(from: Location, to: Location, departureTime: Date) {
    // Call Google Maps API
    // Factor in weather conditions
    // Add buffer time based on supplier preferences
    // Cache results for offline access
  }

  async syncOfflineData(clientId: string) {
    // Download all wedding day data
    // Store in local storage
    // Enable offline mode
    // Set sync timestamp
  }
}
```

### CODE EXAMPLES

#### Example 1: Auto-Activation Logic
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { useEffect, useState } from 'react';
import { supabase } from '@/lib/supabase';

export function useweddingDayActivation() {
  const [activeWeddings, setActiveWeddings] = useState<WeddingDayData[]>([]);
  const [showModule, setShowModule] = useState(false);

  useEffect(() => {
    const checkUpcomingWeddings = async () => {
      // Step 1: Get weddings within 48 hours
      const now = new Date();
      const cutoffTime = new Date(now.getTime() + 48 * 60 * 60 * 1000);
      
      const { data: weddings } = await supabase
        .from('clients')
        .select(`
          id,
          name,
          wedding_date,
          wedding_details,
          venues(*)
        `)
        .gte('wedding_date', now.toISOString())
        .lte('wedding_date', cutoffTime.toISOString())
        .order('wedding_date');

      if (weddings && weddings.length > 0) {
        setActiveWeddings(weddings);
        setShowModule(true);
        
        // Step 2: Pre-cache data for offline access
        for (const wedding of weddings) {
          await cacheWeddingData(wedding);
        }
      }
    };

    // Check immediately and every 30 minutes
    checkUpcomingWeddings();
    const interval = setInterval(checkUpcomingWeddings, 30 * 60 * 1000);
    
    return () => clearInterval(interval);
  }, []);

  return { activeWeddings, showModule };
}

async function cacheWeddingData(wedding: any) {
  const cacheData = {
    venue: wedding.venues,
    timeline: wedding.wedding_details.timeline,
    contacts: wedding.wedding_details.contacts,
    cachedAt: new Date().toISOString()
  };
  
  localStorage.setItem(`wedding-${wedding.id}`, JSON.stringify(cacheData));
}
```

#### Example 2: Travel Time Calculation with Traffic
```typescript
// Real-time travel calculation with Google Maps
export async function calculateDepartureTime(
  venue: Location,
  supplierLocation: Location,
  ceremonyTime: Date
) {
  // Step 1: Get travel time from Google Maps
  const response = await fetch('/api/wedding-day/travel', {
    method: 'POST',
    body: JSON.stringify({
      origin: supplierLocation,
      destination: venue,
      arrivalTime: ceremonyTime.toISOString()
    })
  });
  
  const { duration, trafficMultiplier } = await response.json();
  
  // Step 2: Add buffer based on conditions
  let bufferMinutes = 15; // Base buffer
  
  // Add extra buffer for weather
  const weather = await getWeatherConditions(venue, ceremonyTime);
  if (weather.conditions === 'rain') bufferMinutes += 10;
  if (weather.conditions === 'snow') bufferMinutes += 20;
  
  // Add extra buffer for traffic
  if (trafficMultiplier > 1.3) bufferMinutes += 15;
  
  // Step 3: Calculate recommended departure
  const totalTravelMinutes = duration + bufferMinutes;
  const departureTime = new Date(
    ceremonyTime.getTime() - totalTravelMinutes * 60 * 1000
  );
  
  return {
    departureTime,
    travelDuration: duration,
    bufferTime: bufferMinutes,
    confidence: trafficMultiplier < 1.5 ? 'high' : 'moderate'
  };
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load Google Maps API docs
- [x] Filesystem: Access project structure
- [ ] Playwright: Test module activation

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/googlemaps/google-maps-services-js", "directions", 2000);
await mcp__context7__get-library-docs("/vercel/next.js", "caching app router", 2000);
await mcp__context7__get-library-docs("/supabase/supabase", "realtime subscriptions", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('WeddingDayModule', () => {
  it('should activate 48 hours before wedding', () => {
    const weddingDate = new Date('2025-03-01T14:00:00');
    const currentTime = new Date('2025-02-27T14:00:00'); // Exactly 48 hours
    expect(shouldActivateModule(weddingDate, currentTime)).toBe(true);
  });

  it('should handle multiple same-day weddings', () => {
    const weddings = [
      { ceremonyTime: '10:00', venue: 'Church' },
      { ceremonyTime: '16:00', venue: 'Beach' }
    ];
    const conflicts = detectTimelineConflicts(weddings);
    expect(conflicts).toHaveLength(0); // 6 hours apart, no conflict
  });

  it('should work offline after caching', async () => {
    await cacheWeddingData(mockWedding);
    const offlineData = await getOfflineWeddingData(mockWedding.id);
    expect(offlineData).toBeDefined();
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Wedding day module activation and usage', async () => {
  // Set wedding date to trigger module
  await mcp__playwright__browser_navigate({url: '/dashboard'});
  
  // Verify module appears
  await mcp__playwright__browser_snapshot();
  
  // Test checklist interaction
  await mcp__playwright__browser_click({
    element: 'Checklist item checkbox',
    ref: 'input[type="checkbox"][name*="checklist"]'
  });
  
  // Test travel time display
  await mcp__playwright__browser_evaluate({
    function: '() => document.querySelector(".travel-time-widget") !== null'
  });
});
```

### ACCEPTANCE CRITERIA
- [x] Activates exactly 48 hours before wedding
- [x] Shows real-time traffic conditions
- [x] Works completely offline once loaded
- [x] Handles multiple same-day weddings
- [x] Mobile optimized with large touch targets
- [x] Print view available for backup
- [x] Timeline updates in real-time
- [x] Performance: Loads in <1 second
- [x] Security: Only shows supplier's own weddings
- [x] Accessibility: Screen reader compatible

### DEPENDENCIES
- Must complete after: WS-007 (Main Dashboard Layout)
- Must complete before: None
- Shares code with: WS-019 (Travel Time Calculator)

### ESTIMATED EFFORT
- Team A Frontend: 24 hours
- Team B Backend: 16 hours
- Team D Infrastructure: 8 hours (caching system)
- Total: 48 hours