# TECHNICAL SPECIFICATION: WS-146 - App Store Preparation System
## Generated by Feature Development Session - 2025-01-24

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding supplier who wants WedSync easily accessible on my phone
**I want to:** Download WedSync from the App Store or Google Play like any professional app
**So that:** I can have it on my home screen with push notifications and native mobile features

**Real Wedding Scenario:**
Lisa, a wedding planner, discovers WedSync through a colleague's recommendation. Instead of remembering a URL, she searches "WedSync" in the App Store, finds it with 4.8 stars and 200+ reviews, downloads it instantly, and gets push notifications when couples update their timelines. Having it as a "real app" makes her trust it more for her business-critical wedding coordination.

### SPECIFICATION SOURCE
- **Feature ID:** WS-146
- **Original Spec:** /CORE-SPECIFICATIONS/09-MOBILE-OPTIMIZATION/06-app-store-preparation md.md
- **Current Implementation:** 20% complete (PWA manifest exists)
- **Files to Modify:** 
  - /wedsync/public/manifest.json (app store requirements)
  - /wedsync/next.config.js (PWA configuration)
  - /wedsync/public/sw.js (service worker enhancements)
- **New Files to Create:** 
  - /src/lib/pwa/app-store-config.ts
  - /src/lib/pwa/installation-manager.ts
  - /src/components/pwa/InstallPrompt.tsx
  - /src/components/pwa/UpdateNotification.tsx
  - /app-store-assets/ (icons, screenshots, metadata)
  - /capacitor.config.ts (native wrapper configuration)

### TECHNICAL DESIGN

#### PWA App Store Configuration
```typescript
// PWA manifest for app stores
export const APP_STORE_MANIFEST = {
  // Microsoft Store (immediate deployment)
  microsoftStore: {
    name: "WedSync - Wedding Vendor Platform",
    short_name: "WedSync",
    description: "Professional wedding vendor management platform. Manage clients, automate workflows, and coordinate with couples seamlessly.",
    categories: ["business", "productivity"],
    iarc_rating_id: "e84b8d71-ff39-4c75-b6e3-23f3bcb7bcac",
    screenshots: [
      {
        src: "/app-store-assets/screenshots/desktop-dashboard-1280x800.png",
        sizes: "1280x800",
        type: "image/png",
        platform: "wide"
      },
      {
        src: "/app-store-assets/screenshots/mobile-forms-750x1334.png", 
        sizes: "750x1334",
        type: "image/png",
        platform: "narrow"
      }
    ]
  },

  // Google Play Store (via TWA)
  googlePlay: {
    packageName: "app.wedsync.supplier",
    versionCode: 1,
    versionName: "1.0.0",
    minSdkVersion: 21,
    targetSdkVersion: 34,
    twa: {
      applicationId: "app.wedsync.supplier",
      hostName: "wedsync.app",
      launcherName: "WedSync",
      themeColor: "#6366F1",
      backgroundColor: "#FFFFFF",
      enableNotifications: true,
      orientation: "portrait",
      display: "standalone",
      fallbackType: "customtabs"
    }
  },

  // iOS App Store (Capacitor wrapper)
  appleAppStore: {
    bundleId: "app.wedsync.supplier",
    version: "1.0.0",
    buildNumber: "1",
    displayName: "WedSync",
    appName: "WedSync - Wedding Vendors",
    iosScheme: "wedsync",
    backgroundColor: "#ffffff",
    requiresFullScreen: false,
    statusBarStyle: "default",
    allowsArbitraryLoads: false
  }
};

// Icon sizes for all platforms
export const ICON_REQUIREMENTS = {
  pwa: [
    { size: "72x72", purpose: "maskable any" },
    { size: "96x96", purpose: "maskable any" },
    { size: "128x128", purpose: "maskable any" },
    { size: "144x144", purpose: "maskable any" },
    { size: "152x152", purpose: "maskable any" },
    { size: "192x192", purpose: "maskable any" },
    { size: "384x384", purpose: "maskable any" },
    { size: "512x512", purpose: "maskable any" }
  ],
  ios: [
    { size: "20x20", scale: [2, 3], usage: "notification" },
    { size: "29x29", scale: [2, 3], usage: "settings" },
    { size: "40x40", scale: [2, 3], usage: "spotlight" },
    { size: "60x60", scale: [2, 3], usage: "iphone" },
    { size: "76x76", scale: [1, 2], usage: "ipad" },
    { size: "83.5x83.5", scale: [2], usage: "ipad-pro" },
    { size: "1024x1024", scale: [1], usage: "app-store" }
  ],
  android: [
    { size: "48x48", density: "mdpi" },
    { size: "72x72", density: "hdpi" },
    { size: "96x96", density: "xhdpi" },
    { size: "144x144", density: "xxhdpi" },
    { size: "192x192", density: "xxxhdpi" },
    { size: "512x512", density: "playstore" }
  ]
};
```

#### App Store Optimization (ASO) Content
```typescript
// ASO content management
export interface AppStoreContent {
  title: string;
  subtitle: string;
  description: string;
  keywords: string[];
  category: string;
  contentRating: string;
}

export const APP_STORE_CONTENT: Record<string, AppStoreContent> = {
  wedsync_supplier: {
    title: "WedSync - Wedding Vendor Hub",
    subtitle: "Manage Clients & Automate Workflows", 
    description: `Transform your wedding business with WedSync - the all-in-one platform that saves you 10+ hours per wedding.

‚≠ê SMART CLIENT MANAGEMENT
‚Ä¢ Import existing clients instantly
‚Ä¢ Track wedding timelines and tasks  
‚Ä¢ Never chase information again

üìù INTELLIGENT FORMS
‚Ä¢ Convert PDFs to smart forms with AI
‚Ä¢ Auto-populate client information
‚Ä¢ Collect responses seamlessly

üöÄ WORKFLOW AUTOMATION  
‚Ä¢ Build visual customer journeys
‚Ä¢ Automate emails and reminders
‚Ä¢ Track client engagement

üìä BUSINESS INSIGHTS
‚Ä¢ Monitor performance metrics
‚Ä¢ Track conversion rates
‚Ä¢ Identify growth opportunities

Join 5,000+ wedding professionals who've transformed their business with WedSync.

Download now and start your 30-day free trial - no credit card required!`,
    keywords: [
      "wedding vendor", "wedding planner", "photographer tools", 
      "wedding business", "client management", "wedding CRM",
      "workflow automation", "wedding forms", "vendor coordination"
    ],
    category: "Business",
    contentRating: "4+"
  },

  wedme_couples: {
    title: "WedMe - Wedding Planning Hub",
    subtitle: "Coordinate All Your Wedding Vendors",
    description: `Plan your perfect wedding with WedMe - the couples' command center that connects you with all your vendors.

üíï VENDOR COORDINATION
‚Ä¢ Connect with photographers, DJs, florists
‚Ä¢ Share details automatically
‚Ä¢ Track progress in real-time

üìã PLANNING MADE EASY  
‚Ä¢ Fill out vendor forms once
‚Ä¢ Auto-populate across all suppliers
‚Ä¢ Never duplicate information

‚è∞ TIMELINE MANAGEMENT
‚Ä¢ Visual wedding day timeline
‚Ä¢ Coordinate all vendor schedules
‚Ä¢ Share with your wedding party

üì± MOBILE FIRST
‚Ä¢ Access everything on your phone
‚Ä¢ Real-time updates from vendors
‚Ä¢ Offline access for wedding day

Trusted by 15,000+ couples for stress-free wedding planning.

Free to use - your vendors handle the subscription!`,
    keywords: [
      "wedding planning", "wedding organizer", "vendor coordination",
      "wedding checklist", "wedding timeline", "couple planning",
      "wedding day", "vendor communication", "wedding management"
    ],
    category: "Lifestyle", 
    contentRating: "4+"
  }
};
```

#### Installation & Update Management
```typescript
// PWA installation management
export class InstallationManager {
  private deferredPrompt: any = null;
  private isStandalone = false;

  constructor() {
    this.detectStandalone();
    this.setupInstallPrompt();
    this.setupUpdateManager();
  }

  private detectStandalone() {
    this.isStandalone = 
      window.matchMedia('(display-mode: standalone)').matches ||
      ('standalone' in window.navigator) ||
      document.referrer.includes('android-app://');
  }

  private setupInstallPrompt() {
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      this.deferredPrompt = e;
      
      // Show custom install prompt after user engagement
      this.showInstallPrompt();
    });
  }

  async showInstallPrompt(): Promise<boolean> {
    if (!this.deferredPrompt || this.isStandalone) {
      return false;
    }

    // Wait for user engagement before showing prompt
    if (!this.hasUserEngagement()) {
      await this.waitForEngagement();
    }

    try {
      this.deferredPrompt.prompt();
      
      const choiceResult = await this.deferredPrompt.userChoice;
      
      if (choiceResult.outcome === 'accepted') {
        this.trackInstallation('pwa_prompt');
        return true;
      }
      
      this.deferredPrompt = null;
      return false;
    } catch (error) {
      console.error('Install prompt failed:', error);
      return false;
    }
  }

  private hasUserEngagement(): boolean {
    // Check if user has interacted with the app
    const hasClicked = sessionStorage.getItem('user_clicked') === 'true';
    const hasScrolled = window.scrollY > 100;
    const hasNavigated = sessionStorage.getItem('pages_visited') || '0' > '1';
    
    return hasClicked || hasScrolled || hasNavigated;
  }

  private async waitForEngagement(): Promise<void> {
    return new Promise((resolve) => {
      const engagementEvents = ['click', 'scroll', 'keydown'];
      
      const handler = () => {
        sessionStorage.setItem('user_clicked', 'true');
        engagementEvents.forEach(event => 
          document.removeEventListener(event, handler)
        );
        resolve();
      };
      
      engagementEvents.forEach(event => 
        document.addEventListener(event, handler, { once: true })
      );
    });
  }

  // Check for iOS installation
  showIOSInstallInstructions(): boolean {
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    
    if (isIOS && isSafari && !this.isStandalone) {
      this.showIOSModal();
      return true;
    }
    
    return false;
  }

  private showIOSModal() {
    const modal = document.createElement('div');
    modal.className = 'ios-install-modal';
    modal.innerHTML = `
      <div class="modal-content">
        <h3>Install WedSync</h3>
        <p>Add WedSync to your home screen for the best experience:</p>
        <ol>
          <li>Tap the Share button <span class="share-icon">‚ñ°‚Üó</span></li>
          <li>Scroll down and tap "Add to Home Screen"</li>
          <li>Tap "Add" to confirm</li>
        </ol>
        <button onclick="this.closest('.ios-install-modal').remove()">
          Got it!
        </button>
      </div>
    `;
    
    document.body.appendChild(modal);
  }

  private setupUpdateManager() {
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        this.showUpdateNotification();
      });
    }
  }

  private showUpdateNotification() {
    const notification = document.createElement('div');
    notification.className = 'update-notification';
    notification.innerHTML = `
      <div class="notification-content">
        <span>App updated! Refresh for new features.</span>
        <button onclick="window.location.reload()">Refresh</button>
        <button onclick="this.closest('.update-notification').remove()">Later</button>
      </div>
    `;
    
    document.body.appendChild(notification);
  }

  private trackInstallation(method: string) {
    // Analytics tracking
    if (typeof gtag !== 'undefined') {
      gtag('event', 'app_install', {
        method: method,
        app_name: 'WedSync'
      });
    }

    // Custom analytics
    fetch('/api/analytics/app-install', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        method,
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent,
        referrer: document.referrer
      })
    });
  }
}
```

#### Native App Wrapper (Capacitor)
```typescript
// capacitor.config.ts for native app stores
import { CapacitorConfig } from '@capacitor/cli';

const config: CapacitorConfig = {
  appId: 'app.wedsync.supplier',
  appName: 'WedSync',
  webDir: 'out',
  bundledWebRuntime: false,

  server: {
    androidScheme: 'https'
  },

  plugins: {
    SplashScreen: {
      launchShowDuration: 2000,
      backgroundColor: "#6366F1",
      showSpinner: false,
      spinnerColor: "#FFFFFF"
    },
    
    PushNotifications: {
      presentationOptions: ["badge", "sound", "alert"]
    },

    LocalNotifications: {
      smallIcon: "ic_stat_notification",
      iconColor: "#6366F1"
    },

    StatusBar: {
      style: "default",
      backgroundColor: "#6366F1"
    },

    Keyboard: {
      resize: "body",
      style: "default"
    },

    Camera: {
      permissions: {
        camera: "WedSync needs camera access to capture wedding photos"
      }
    }
  },

  ios: {
    scheme: 'WedSync',
    contentInset: 'automatic',
    backgroundColor: '#ffffff',
    limitsNavigationsToAppBoundDomains: true,
    allowsLinkPreview: false,
    handleApplicationURL: true,
    
    // App Store metadata
    bundleId: 'app.wedsync.supplier',
    version: '1.0.0',
    buildNumber: '1',
    
    // Permissions
    permissions: {
      camera: 'WedSync uses camera to capture wedding moments',
      photos: 'WedSync needs photo access to manage wedding galleries',
      notifications: 'Get notified when couples update their details'
    }
  },

  android: {
    buildOptions: {
      keystorePath: 'android/app/wedsync-release.keystore',
      keystoreAlias: 'wedsync-key',
      releaseType: 'APK'
    },
    
    // App permissions
    permissions: [
      'android.permission.CAMERA',
      'android.permission.READ_EXTERNAL_STORAGE',
      'android.permission.WRITE_EXTERNAL_STORAGE',
      'android.permission.INTERNET',
      'android.permission.ACCESS_NETWORK_STATE'
    ],

    // Google Play requirements
    targetSdk: 34,
    minSdk: 21,
    versionCode: 1,
    versionName: '1.0.0'
  }
};

export default config;
```

### CODE EXAMPLES

#### Example 1: Smart Install Promotion Strategy
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
export class SmartInstallPromotion {
  private installMetrics = {
    promptsShown: 0,
    installsCompleted: 0,
    dismissals: 0
  };

  async evaluateInstallTiming(): Promise<boolean> {
    // Don't show if already installed
    if (this.isInstalled()) return false;
    
    // Don't show if user recently dismissed
    const lastDismissal = localStorage.getItem('install_dismissed');
    if (lastDismissal) {
      const daysSinceDismissal = this.daysSince(new Date(lastDismissal));
      if (daysSinceDismissal < 7) return false;
    }

    // Check user engagement signals
    const engagement = await this.getUserEngagement();
    
    // Only show to engaged users
    const shouldShow = 
      engagement.sessionsCount >= 3 &&
      engagement.timeSpentMinutes >= 10 &&
      engagement.actionsCompleted >= 5 &&
      engagement.returningUser;

    if (shouldShow) {
      this.trackPromptTiming('engaged_user');
    }

    return shouldShow;
  }

  async showContextualInstallPrompt(): Promise<void> {
    const context = this.getCurrentContext();
    
    let message: string;
    let timing: 'immediate' | 'after_success' | 'on_exit';

    switch (context.page) {
      case 'dashboard':
        if (context.hasCompletedActions) {
          message = "Love using WedSync? Install the app for faster access and push notifications!";
          timing = 'after_success';
        } else {
          return; // Don't interrupt dashboard usage
        }
        break;

      case 'form_builder':
        if (context.formSaved) {
          message = "Great work! Install WedSync to get notified when clients complete forms.";
          timing = 'after_success';
        } else {
          return;
        }
        break;

      case 'client_management':
        message = "Install WedSync to access client details even when you're offline at venues.";
        timing = 'immediate';
        break;

      default:
        message = "Install WedSync for a better mobile experience with offline access.";
        timing = 'on_exit';
    }

    await this.displayInstallBanner(message, timing);
  }

  private async displayInstallBanner(message: string, timing: string): Promise<void> {
    if (timing === 'after_success') {
      // Show after user completes an action
      setTimeout(() => this.renderBanner(message), 1000);
    } else if (timing === 'on_exit') {
      // Show when user is about to leave
      window.addEventListener('beforeunload', () => this.renderBanner(message));
    } else {
      // Show immediately
      this.renderBanner(message);
    }
  }

  private renderBanner(message: string): void {
    // Don't show multiple banners
    if (document.querySelector('.install-banner')) return;

    const banner = document.createElement('div');
    banner.className = 'install-banner';
    banner.innerHTML = `
      <div class="banner-content">
        <div class="banner-icon">üì±</div>
        <div class="banner-text">
          <div class="banner-title">Install WedSync</div>
          <div class="banner-message">${message}</div>
        </div>
        <div class="banner-actions">
          <button class="install-btn" onclick="this.closest('.install-banner').dispatchEvent(new CustomEvent('install'))">
            Install
          </button>
          <button class="dismiss-btn" onclick="this.closest('.install-banner').dispatchEvent(new CustomEvent('dismiss'))">
            Not now
          </button>
        </div>
      </div>
    `;

    banner.addEventListener('install', async () => {
      const installed = await this.triggerInstall();
      if (installed) {
        banner.remove();
        this.showInstallSuccess();
      }
    });

    banner.addEventListener('dismiss', () => {
      localStorage.setItem('install_dismissed', new Date().toISOString());
      banner.remove();
      this.trackDismissal();
    });

    document.body.appendChild(banner);
    this.trackPromptShown();

    // Auto-remove after 10 seconds
    setTimeout(() => {
      if (banner.parentNode) {
        banner.remove();
      }
    }, 10000);
  }

  private async triggerInstall(): Promise<boolean> {
    const installManager = new InstallationManager();
    
    // Try PWA install first
    const pwaInstalled = await installManager.showInstallPrompt();
    if (pwaInstalled) {
      this.trackInstallSuccess('pwa');
      return true;
    }

    // Fallback to platform-specific instructions
    if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
      installManager.showIOSInstallInstructions();
      this.trackInstallSuccess('ios_instructions');
      return true;
    }

    // Android users without PWA support
    if (/Android/.test(navigator.userAgent)) {
      this.showAndroidPlayStoreRedirect();
      this.trackInstallSuccess('play_store_redirect');
      return true;
    }

    return false;
  }

  private showInstallSuccess(): void {
    const success = document.createElement('div');
    success.className = 'install-success';
    success.innerHTML = `
      <div class="success-content">
        <div class="success-icon">‚úÖ</div>
        <div class="success-title">WedSync Installed!</div>
        <div class="success-message">You can now access WedSync from your home screen.</div>
      </div>
    `;

    document.body.appendChild(success);

    setTimeout(() => success.remove(), 3000);
  }

  private async getUserEngagement(): Promise<{
    sessionsCount: number;
    timeSpentMinutes: number;
    actionsCompleted: number;
    returningUser: boolean;
  }> {
    // Get from analytics or localStorage
    const sessions = parseInt(localStorage.getItem('session_count') || '0');
    const timeSpent = parseInt(localStorage.getItem('time_spent') || '0');
    const actions = parseInt(localStorage.getItem('actions_completed') || '0');
    const returning = localStorage.getItem('returning_user') === 'true';

    return {
      sessionsCount: sessions,
      timeSpentMinutes: Math.floor(timeSpent / 60000),
      actionsCompleted: actions,
      returningUser: returning
    };
  }

  private trackPromptShown(): void {
    this.installMetrics.promptsShown++;
    
    // Analytics
    gtag?.('event', 'install_prompt_shown', {
      custom_parameter_1: 'pwa_install'
    });
  }

  private trackInstallSuccess(method: string): void {
    this.installMetrics.installsCompleted++;
    
    gtag?.('event', 'app_install_completed', {
      method: method,
      from_prompt: true
    });
  }

  private trackDismissal(): void {
    this.installMetrics.dismissals++;
    
    gtag?.('event', 'install_prompt_dismissed', {
      dismissal_count: this.installMetrics.dismissals
    });
  }
}
```

#### Example 2: App Store Review Management
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
export class ReviewManager {
  private reviewPromptTriggers = {
    minSessionCount: 5,
    minDaysInstalled: 7,
    mustHaveCompletedAction: true,
    noRecentPromptDays: 60,
    positiveSignalsRequired: 3
  };

  async evaluateReviewPrompt(): Promise<boolean> {
    const userState = await this.getUserState();
    
    // Check all trigger conditions
    const meetsRequirements = 
      userState.sessionCount >= this.reviewPromptTriggers.minSessionCount &&
      userState.daysInstalled >= this.reviewPromptTriggers.minDaysInstalled &&
      userState.hasCompletedAction &&
      userState.daysSinceLastPrompt >= this.reviewPromptTriggers.noRecentPromptDays;

    if (!meetsRequirements) return false;

    // Check for positive signals
    const positiveSignals = this.detectPositiveSignals(userState);
    
    return positiveSignals >= this.reviewPromptTriggers.positiveSignalsRequired;
  }

  private detectPositiveSignals(userState: any): number {
    let signals = 0;

    // Just completed a wedding successfully
    if (userState.recentWeddingCompleted) signals++;

    // High client engagement
    if (userState.clientResponseRate > 0.8) signals++;

    // Using advanced features
    if (userState.automationUsage > 0) signals++;

    // Repeat usage pattern
    if (userState.consecutiveDaysActive >= 3) signals++;

    // Positive feature feedback
    if (userState.hasGivenPositiveFeedback) signals++;

    // Time saved metric
    if (userState.timeSavedHours > 10) signals++;

    return signals;
  }

  async showReviewPrompt(): Promise<void> {
    // First ask for feedback
    const feedbackResponse = await this.showFeedbackDialog();
    
    if (feedbackResponse === 'positive') {
      // Direct to app store
      this.showAppStoreReview();
    } else if (feedbackResponse === 'negative') {
      // Direct to feedback form
      this.showFeedbackForm();
    }
    
    // Record that we showed the prompt
    localStorage.setItem('last_review_prompt', new Date().toISOString());
  }

  private async showFeedbackDialog(): Promise<'positive' | 'negative' | 'dismissed'> {
    return new Promise((resolve) => {
      const dialog = document.createElement('div');
      dialog.className = 'review-dialog';
      dialog.innerHTML = `
        <div class="dialog-content">
          <h3>How's your WedSync experience?</h3>
          <p>Are you enjoying using WedSync for your wedding business?</p>
          <div class="dialog-actions">
            <button class="btn-positive" data-response="positive">
              Yes, loving it! üòç
            </button>
            <button class="btn-negative" data-response="negative">
              Could be better ü§î
            </button>
            <button class="btn-dismiss" data-response="dismissed">
              Ask me later
            </button>
          </div>
        </div>
      `;

      dialog.addEventListener('click', (e) => {
        const response = (e.target as any)?.dataset?.response;
        if (response) {
          dialog.remove();
          resolve(response as any);
        }
      });

      document.body.appendChild(dialog);

      // Auto-dismiss after 30 seconds
      setTimeout(() => {
        if (dialog.parentNode) {
          dialog.remove();
          resolve('dismissed');
        }
      }, 30000);
    });
  }

  private showAppStoreReview(): void {
    const modal = document.createElement('div');
    modal.className = 'app-store-review-modal';
    modal.innerHTML = `
      <div class="modal-content">
        <h3>üåü Love WedSync? Help other suppliers discover us!</h3>
        <p>Your review helps other wedding professionals find the tools they need to grow their business.</p>
        <div class="modal-actions">
          <button class="btn-primary" onclick="this.closest('.app-store-review-modal').dispatchEvent(new CustomEvent('review'))">
            Write Review
          </button>
          <button class="btn-secondary" onclick="this.closest('.app-store-review-modal').remove()">
            Maybe Later
          </button>
        </div>
      </div>
    `;

    modal.addEventListener('review', () => {
      this.openAppStoreReview();
      modal.remove();
    });

    document.body.appendChild(modal);
  }

  private openAppStoreReview(): void {
    const userAgent = navigator.userAgent;
    let reviewUrl = '';

    if (/iPad|iPhone|iPod/.test(userAgent)) {
      // iOS App Store
      reviewUrl = 'https://apps.apple.com/app/wedsync/id1234567890?action=write-review';
    } else if (/Android/.test(userAgent)) {
      // Google Play Store
      reviewUrl = 'https://play.google.com/store/apps/details?id=app.wedsync.supplier&showAllReviews=true';
    } else {
      // Microsoft Store or web
      reviewUrl = 'https://www.microsoft.com/store/apps/wedsync';
    }

    window.open(reviewUrl, '_blank');
    
    this.trackReviewRedirect();
  }

  private showFeedbackForm(): void {
    const form = document.createElement('div');
    form.className = 'feedback-form-modal';
    form.innerHTML = `
      <div class="modal-content">
        <h3>Help us improve WedSync</h3>
        <p>What could we do better? Your feedback helps us build a better product.</p>
        <textarea placeholder="Tell us what's not working well or what features you'd like to see..." rows="4"></textarea>
        <div class="modal-actions">
          <button class="btn-primary" onclick="this.closest('.feedback-form-modal').dispatchEvent(new CustomEvent('submit'))">
            Send Feedback
          </button>
          <button class="btn-secondary" onclick="this.closest('.feedback-form-modal').remove()">
            Cancel
          </button>
        </div>
      </div>
    `;

    form.addEventListener('submit', () => {
      const feedback = form.querySelector('textarea')?.value;
      this.submitFeedback(feedback || '');
      form.remove();
    });

    document.body.appendChild(form);
  }

  private async submitFeedback(feedback: string): Promise<void> {
    try {
      await fetch('/api/feedback', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          feedback,
          source: 'review_prompt',
          timestamp: new Date().toISOString()
        })
      });

      // Show thank you message
      this.showThankYouMessage();
    } catch (error) {
      console.error('Failed to submit feedback:', error);
    }
  }

  private trackReviewRedirect(): void {
    gtag?.('event', 'review_redirect', {
      source: 'in_app_prompt',
      platform: this.getPlatform()
    });
  }

  private getPlatform(): string {
    const userAgent = navigator.userAgent;
    if (/iPad|iPhone|iPod/.test(userAgent)) return 'ios';
    if (/Android/.test(userAgent)) return 'android';
    return 'web';
  }
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [ ] Context7: Load docs for PWA best practices, Capacitor configuration
- [ ] PostgreSQL: Track app store metrics and user behavior
- [ ] Supabase: Store app installation analytics

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/ionic/capacitor", "app store deployment", 3000);
await mcp__context7__get-library-docs("/pwa/workbox", "app manifest", 2000);
await mcp__context7__get-library-docs("/next.js/next", "pwa configuration", 2500);
```

### TEST REQUIREMENTS

#### App Store Preparation Tests
```typescript
describe('PWA Installation', () => {
  it('should show install prompt for engaged users', async () => {
    // Simulate user engagement
    await simulateUserActivity();
    
    const installManager = new InstallationManager();
    const shouldShow = await installManager.evaluateInstallTiming();
    
    expect(shouldShow).toBe(true);
  });

  it('should handle iOS install instructions', async () => {
    // Mock iOS Safari
    Object.defineProperty(navigator, 'userAgent', {
      value: 'Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 Safari/604.1'
    });

    const installManager = new InstallationManager();
    const shown = installManager.showIOSInstallInstructions();
    
    expect(shown).toBe(true);
    expect(document.querySelector('.ios-install-modal')).toBeTruthy();
  });

  it('should track installation metrics', async () => {
    const spy = jest.spyOn(global, 'fetch');
    
    const installManager = new InstallationManager();
    installManager.trackInstallation('pwa_prompt');
    
    expect(spy).toHaveBeenCalledWith('/api/analytics/app-install', expect.any(Object));
  });
});

describe('App Store Review Flow', () => {
  it('should show review prompt for satisfied users', async () => {
    // Mock positive user state
    localStorage.setItem('session_count', '10');
    localStorage.setItem('actions_completed', '25');
    
    const reviewManager = new ReviewManager();
    const shouldPrompt = await reviewManager.evaluateReviewPrompt();
    
    expect(shouldPrompt).toBe(true);
  });
});
```

#### E2E App Store Tests
```typescript
// Using Playwright MCP
test('App store preparation workflow', async () => {
  await mcp__playwright__browser_navigate({url: '/'});
  
  // Should detect PWA capability
  const isPWA = await mcp__playwright__browser_evaluate({
    function: '() => window.matchMedia("(display-mode: standalone)").matches'
  });
  
  expect(isPWA).toBeDefined();
});

test('Install prompt appears for engaged users', async () => {
  // Simulate engagement
  await mcp__playwright__browser_click({
    element: 'Dashboard link',
    ref: '[href="/dashboard"]'
  });
  
  await mcp__playwright__browser_wait_for({
    text: 'Install WedSync'
  });
  
  await mcp__playwright__browser_snapshot();
});
```

### ACCEPTANCE CRITERIA
- [ ] PWA manifest meets all app store requirements (Microsoft, Google, Apple)
- [ ] App icons generated in all required sizes (72x72 to 1024x1024)
- [ ] Screenshots created for all device types and platforms
- [ ] Install prompts show only for engaged users (3+ sessions, 10+ minutes)
- [ ] iOS install instructions work for Safari users
- [ ] Android TWA (Trusted Web Activity) configured for Play Store
- [ ] App store descriptions optimized with relevant keywords
- [ ] Review prompts trigger after positive user signals
- [ ] Installation analytics tracked with conversion funnels
- [ ] Update notifications shown when new version available
- [ ] App store metadata localized for UK/US markets
- [ ] Content rating appropriate (4+ for all ages)
- [ ] Privacy policy and terms of service linked correctly
- [ ] App store approval process documented for team

### DEPENDENCIES
- Must complete after: WS-145 (Performance Targets) - Need performance scores for app stores
- Must complete before: Production launch - Required for mobile user acquisition
- Shares code with: WS-144 (Offline Functionality), All PWA-related features

### ESTIMATED EFFORT
- Team A Frontend: 24 hours (install prompts, review management, PWA enhancements)
- Team B Backend: 12 hours (analytics tracking, app store APIs, user engagement)
- Team C Integration: 16 hours (Capacitor setup, app store assets, CI/CD for stores)
- Total: 52 hours