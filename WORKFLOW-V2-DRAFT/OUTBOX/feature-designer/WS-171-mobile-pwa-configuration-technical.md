# TECHNICAL SPECIFICATION: WS-171 - Mobile PWA Configuration
## Generated by Feature Development Session - 2025-01-24

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding supplier working on-site at wedding venues
**I want to:** Access WedSync as a mobile app that works offline and installs on my phone
**So that:** I can manage timelines, check vendor status, and update couples without needing internet at remote venues

**Real Wedding Scenario:**
A wedding coordinator at a countryside venue with poor WiFi can install WedSync as a PWA, access offline timeline views, check vendor arrival status, and sync changes when connection returns. This prevents 3+ hours of delays from communication gaps.

### SPECIFICATION SOURCE
- **Feature ID:** WS-171
- **Original Spec:** /CORE-SPECIFICATIONS/09-MOBILE-OPTIMIZATION/02-pwa-configuration md.md
- **Current Implementation:** 0% complete
- **Files to Modify:**
  - /wedsync/next.config.js (add PWA plugin)
  - /wedsync/src/app/layout.tsx (add PWA metadata)
- **New Files to Create:**
  - /wedsync/public/manifest.json
  - /wedsync/public/sw.js
  - /wedsync/src/lib/pwa/install-prompt.ts
  - /wedsync/src/lib/pwa/offline-handler.ts
  - /wedsync/src/components/pwa/InstallButton.tsx

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- PWA installation tracking
CREATE TABLE IF NOT EXISTS pwa_installations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES user_profiles(id),
  device_type TEXT,
  browser TEXT,
  installed_at TIMESTAMPTZ DEFAULT NOW(),
  last_used TIMESTAMPTZ
);

-- Offline usage metrics
CREATE TABLE IF NOT EXISTS offline_usage (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES user_profiles(id),
  page_url TEXT,
  offline_duration INT, -- seconds
  actions_taken JSONB,
  sync_issues INT DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_pwa_installations_user ON pwa_installations(user_id);
CREATE INDEX idx_offline_usage_user ON offline_usage(user_id);
```

#### API Endpoints Required
```typescript
// POST /api/pwa/install-prompt
interface InstallPromptRequest {
  deviceInfo: {
    userAgent: string;
    platform: string;
    standalone: boolean;
  };
}

interface InstallPromptResponse {
  showPrompt: boolean;
  message: string;
  benefits: string[];
}

// GET /api/pwa/offline-data/:userId
interface OfflineDataResponse {
  clientData: Array<{
    id: string;
    name: string;
    wedding_date: string;
    timeline: object;
  }>;
  forms: Array<{
    id: string;
    title: string;
    fields: object;
  }>;
  lastSync: string;
}
```

#### Frontend Components Required
```typescript
// Component: InstallButton
// Location: /src/components/pwa/InstallButton.tsx

interface Props {
  onInstallClick: () => void;
  isInstallable: boolean;
  platform: 'ios' | 'android' | 'desktop';
}

// Key functionality:
- Platform-specific install instructions
- Install button with custom styling
- Post-install success messaging
- Usage tips after installation
- Progress tracking for install funnel
```

#### Integration Points
```typescript
// Service: PWAManager
// Dependencies: Service Worker, IndexedDB, Push API

class PWAManager {
  async configurePWA(): Promise<void> {
    // Register service worker
    // Set up offline caching
    // Configure background sync
  }
  
  async promptInstall(): Promise<boolean> {
    // Check if PWA installable
    // Show install prompt
    // Track install events
  }
  
  async syncOfflineData(): Promise<void> {
    // Upload offline changes
    // Download latest data
    // Resolve conflicts
  }
}
```

### CODE EXAMPLES

#### Example 1: Service Worker Configuration
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
// File: /public/sw.js

const CACHE_NAME = 'wedsync-v1';
const OFFLINE_PAGES = [
  '/',
  '/dashboard',
  '/clients',
  '/offline'
];

self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then((cache) => cache.addAll(OFFLINE_PAGES))
  );
});

self.addEventListener('fetch', (event) => {
  if (event.request.destination === 'document') {
    event.respondWith(
      caches.match(event.request)
        .then((response) => {
          if (response) {
            return response;
          }
          return fetch(event.request)
            .then((response) => {
              const responseClone = response.clone();
              caches.open(CACHE_NAME)
                .then((cache) => cache.put(event.request, responseClone));
              return response;
            })
            .catch(() => caches.match('/offline'));
        })
    );
  }
});

// Background sync for form submissions
self.addEventListener('sync', (event) => {
  if (event.tag === 'form-submission') {
    event.waitUntil(syncFormData());
  }
});

async function syncFormData() {
  const submissions = await getOfflineSubmissions();
  for (const submission of submissions) {
    try {
      await fetch('/api/forms/submit', {
        method: 'POST',
        body: JSON.stringify(submission)
      });
      await removeOfflineSubmission(submission.id);
    } catch (error) {
      console.error('Sync failed:', error);
    }
  }
}
```

#### Example 2: PWA Install Prompt
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { useState, useEffect } from 'react';

interface BeforeInstallPromptEvent extends Event {
  prompt(): Promise<void>;
  userChoice: Promise<{ outcome: 'accepted' | 'dismissed' }>;
}

export function usePWAInstall() {
  const [deferredPrompt, setDeferredPrompt] = useState<BeforeInstallPromptEvent | null>(null);
  const [isInstalled, setIsInstalled] = useState(false);
  const [showPrompt, setShowPrompt] = useState(false);

  useEffect(() => {
    // Check if already installed
    setIsInstalled(window.matchMedia('(display-mode: standalone)').matches);

    // Listen for install prompt
    const handleBeforeInstallPrompt = (e: BeforeInstallPromptEvent) => {
      e.preventDefault();
      setDeferredPrompt(e);
      setShowPrompt(true);
    };

    window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);

    // Listen for successful install
    window.addEventListener('appinstalled', () => {
      setIsInstalled(true);
      setShowPrompt(false);
      setDeferredPrompt(null);
      
      // Track installation
      fetch('/api/pwa/track-install', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userAgent: navigator.userAgent,
          timestamp: new Date().toISOString()
        })
      });
    });

    return () => {
      window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
    };
  }, []);

  const installPWA = async () => {
    if (!deferredPrompt) return;

    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    
    if (outcome === 'accepted') {
      console.log('PWA installed');
    }
    
    setDeferredPrompt(null);
    setShowPrompt(false);
  };

  return { isInstalled, showPrompt, installPWA };
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [ ] Context7: Load docs for PWA libraries, Workbox
- [ ] Filesystem: Create manifest and service worker files
- [ ] PostgreSQL: Create PWA tracking tables

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/google/workbox", "service worker", 3000);
await mcp__context7__get-library-docs("/vercel/next.js", "pwa configuration", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('PWA Configuration', () => {
  it('should register service worker correctly', async () => {
    const registration = await registerServiceWorker();
    expect(registration).toBeDefined();
  });
  
  it('should cache critical pages for offline use', async () => {
    const cached = await getCachedPages();
    expect(cached).toContain('/dashboard');
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('PWA install prompt appears', async () => {
  await mcp__playwright__browser_navigate({url: '/dashboard'});
  
  // Simulate PWA installable state
  await mcp__playwright__browser_evaluate({
    function: `() => {
      window.dispatchEvent(new Event('beforeinstallprompt'));
    }`
  });
  
  // Check install button appears
  await mcp__playwright__browser_wait_for({
    text: 'Install App'
  });
});
```

### ACCEPTANCE CRITERIA
- [ ] PWA manifest configured with correct icons and metadata
- [ ] Service worker caches critical pages for offline use
- [ ] Install prompt appears for eligible browsers
- [ ] App installs successfully on mobile devices
- [ ] Offline functionality works for key pages
- [ ] Background sync works for form submissions
- [ ] Push notifications capability configured
- [ ] App launches in standalone mode when installed
- [ ] Analytics track PWA usage and installs
- [ ] iOS add-to-homescreen instructions shown

### DEPENDENCIES
- Must complete after: WS-136 (Responsive Design System)
- Must complete before: WS-172 (Offline Functionality)
- Shares code with: WS-173 (Performance Optimization)

### ESTIMATED EFFORT
- Team A Frontend: 16 hours
- Team C Integration: 12 hours
- Total: 28 hours