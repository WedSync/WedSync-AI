# TECHNICAL SPECIFICATION: WS-177 - Audit Logging System
## Generated by Feature Development Session - 2025-01-24

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding business owner handling client data
**I want to:** Complete audit trail of who accessed what data when
**So that:** I can prove compliance during audits and investigate security incidents

### SPECIFICATION SOURCE
- **Feature ID:** WS-177
- **Original Spec:** /CORE-SPECIFICATIONS/10-SECURITY-COMPLIANCE/04-audit-logging md.md
- **Current Implementation:** 0% complete
- **Files to Create:**
  - /src/lib/audit/audit-logger.ts
  - /src/lib/audit/log-analyzer.ts
  - /src/components/admin/AuditLogViewer.tsx
  - /src/app/api/audit/logs/route.ts

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Comprehensive audit log
CREATE TABLE IF NOT EXISTS audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES user_profiles(id),
  action TEXT NOT NULL,
  resource_type TEXT NOT NULL,
  resource_id TEXT,
  ip_address INET,
  user_agent TEXT,
  details JSONB,
  severity TEXT CHECK (severity IN ('info', 'warning', 'critical')),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_audit_logs_user ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_resource ON audit_logs(resource_type, resource_id);
CREATE INDEX idx_audit_logs_created ON audit_logs(created_at);
```

### CODE EXAMPLES

#### Example 1: Audit Logger Implementation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
export class AuditLogger {
  static async logAction(params: {
    userId?: string;
    action: string;
    resourceType: string;
    resourceId?: string;
    details?: Record<string, any>;
    severity?: 'info' | 'warning' | 'critical';
    request?: Request;
  }) {
    const { userId, action, resourceType, resourceId, details, severity = 'info', request } = params;
    
    let ipAddress: string | undefined;
    let userAgent: string | undefined;
    
    if (request) {
      ipAddress = request.headers.get('x-forwarded-for') || 
                  request.headers.get('x-real-ip') || 
                  'unknown';
      userAgent = request.headers.get('user-agent') || 'unknown';
    }
    
    await supabase
      .from('audit_logs')
      .insert({
        user_id: userId,
        action,
        resource_type: resourceType,
        resource_id: resourceId,
        ip_address: ipAddress,
        user_agent: userAgent,
        details,
        severity
      });
  }
}

// Middleware integration
export async function auditMiddleware(
  req: NextRequest,
  action: string,
  resourceType: string,
  resourceId?: string
) {
  const session = await getSession(req);
  
  await AuditLogger.logAction({
    userId: session?.user?.id,
    action,
    resourceType,
    resourceId,
    request: req
  });
}
```

### MCP SERVER USAGE
- [ ] Context7: Load docs for logging libraries
- [ ] PostgreSQL: Create audit tables with proper indexing
- [ ] Supabase: Configure log retention policies

### ACCEPTANCE CRITERIA
- [ ] All data access logged automatically
- [ ] User actions tracked with context
- [ ] Security events flagged appropriately
- [ ] Log retention policy enforced
- [ ] Search and filter capabilities
- [ ] Export functionality for compliance
- [ ] Real-time suspicious activity alerts
- [ ] Integration with monitoring systems

### DEPENDENCIES
- Must complete after: WS-174 (Authentication), WS-175 (Encryption)
- Must complete before: WS-179 (Incident Response)
- Shares code with: WS-176 (GDPR), WS-179 (Incident Response)

### ESTIMATED EFFORT
- Team B Backend: 16 hours
- Team D Security: 20 hours
- Total: 36 hours