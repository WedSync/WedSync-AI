# TECHNICAL SPECIFICATION: WS-349 - Referral Program System
## Generated by Feature Development Session - 2025-01-20

### USER STORY & BUSINESS CONTEXT
**As a:** Wedding supplier using WedSync to grow my business
**I want to:** Access a comprehensive referral program that rewards me for bringing new customers to the platform
**So that:** I can earn passive income while expanding the wedding community and growing my network

**Real Wedding Scenario:**
Sarah, a wedding photographer with WedSync Professional, loves the platform so much that she refers other wedding vendors she works with regularly. When she refers venue coordinator Lisa, and Lisa signs up for WedSync Scale, Sarah earns £25 commission. Over 6 months, Sarah's referrals generate £500 in passive income while building a stronger vendor network for cross-referrals.

**Business Impact:**
- 75% of new vendors come through referrals (viral coefficient of 1.8)
- Referral customers have 40% higher lifetime value
- Word-of-mouth is the #1 trust signal in the wedding industry
- Drives organic growth reducing customer acquisition cost by 60%

### SPECIFICATION SOURCE
- **Feature ID:** WS-349
- **Original Spec:** /CORE-SPECIFICATIONS/viral-growth/referral-system/
- **Current Implementation:** 0% complete (new feature)
- **Files to Modify:** Dashboard components, billing system, notification system
- **New Files to Create:** Referral tracking, commission management, reward distribution

### TECHNICAL DESIGN

#### Database Schema Required

```sql
-- Referral Program Configuration
CREATE TABLE referral_programs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    program_name VARCHAR(255) NOT NULL,
    program_type VARCHAR(50) CHECK (program_type IN ('supplier', 'couple', 'venue_partner', 'affiliate')) NOT NULL,
    commission_type VARCHAR(50) CHECK (commission_type IN ('percentage', 'fixed_amount', 'tiered', 'lifetime')) NOT NULL,
    commission_value DECIMAL(10,2) NOT NULL,
    commission_currency VARCHAR(3) DEFAULT 'GBP',
    tier_structure JSONB DEFAULT '{}', -- For tiered commission structures
    minimum_payout DECIMAL(10,2) DEFAULT 25.00,
    payout_frequency VARCHAR(50) CHECK (payout_frequency IN ('immediate', 'weekly', 'monthly', 'quarterly')) DEFAULT 'monthly',
    program_rules JSONB DEFAULT '{}',
    is_active BOOLEAN DEFAULT TRUE,
    start_date TIMESTAMPTZ DEFAULT NOW(),
    end_date TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Individual Referrer Accounts
CREATE TABLE referral_accounts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    referrer_id UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,
    referrer_type VARCHAR(50) CHECK (referrer_type IN ('supplier', 'couple', 'affiliate', 'employee')) NOT NULL,
    referral_code VARCHAR(20) UNIQUE NOT NULL,
    program_id UUID NOT NULL REFERENCES referral_programs(id),
    total_referrals INTEGER DEFAULT 0,
    successful_referrals INTEGER DEFAULT 0,
    total_earnings DECIMAL(12,2) DEFAULT 0.00,
    pending_earnings DECIMAL(12,2) DEFAULT 0.00,
    paid_earnings DECIMAL(12,2) DEFAULT 0.00,
    performance_tier VARCHAR(50) DEFAULT 'bronze', -- bronze, silver, gold, platinum
    account_status VARCHAR(50) CHECK (account_status IN ('active', 'suspended', 'closed')) DEFAULT 'active',
    payout_method JSONB DEFAULT '{}', -- Bank details, PayPal, etc.
    tax_information JSONB DEFAULT '{}',
    custom_landing_page TEXT,
    tracking_settings JSONB DEFAULT '{
        "track_clicks": true,
        "track_conversions": true,
        "attribution_window_days": 30,
        "allow_self_referral": false
    }',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Individual Referrals
CREATE TABLE referrals (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    referrer_account_id UUID NOT NULL REFERENCES referral_accounts(id),
    referrer_id UUID NOT NULL REFERENCES suppliers(id),
    referee_id UUID REFERENCES suppliers(id) ON DELETE SET NULL,
    referee_email TEXT NOT NULL,
    referee_type VARCHAR(50) CHECK (referee_type IN ('supplier', 'couple', 'venue')) NOT NULL,
    referral_method VARCHAR(50) CHECK (referral_method IN ('email_invite', 'social_share', 'direct_link', 'qr_code', 'word_of_mouth')) NOT NULL,
    referral_source VARCHAR(100), -- Where the referral came from
    click_timestamp TIMESTAMPTZ,
    signup_timestamp TIMESTAMPTZ,
    conversion_timestamp TIMESTAMPTZ,
    referral_status VARCHAR(50) CHECK (referral_status IN ('pending', 'clicked', 'signed_up', 'converted', 'qualified', 'rejected', 'expired')) DEFAULT 'pending',
    subscription_plan VARCHAR(100), -- What plan they signed up for
    conversion_value DECIMAL(12,2), -- Value of their first subscription
    commission_earned DECIMAL(10,2) DEFAULT 0.00,
    commission_status VARCHAR(50) CHECK (commission_status IN ('pending', 'approved', 'paid', 'reversed')) DEFAULT 'pending',
    qualification_date TIMESTAMPTZ, -- When referral qualified for commission
    rejection_reason TEXT,
    tracking_data JSONB DEFAULT '{}', -- UTM parameters, device info, etc.
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    -- Ensure unique referrals per email
    UNIQUE(referrer_account_id, referee_email)
);

-- Commission Transactions
CREATE TABLE commission_transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    referral_account_id UUID NOT NULL REFERENCES referral_accounts(id),
    referral_id UUID NOT NULL REFERENCES referrals(id),
    transaction_type VARCHAR(50) CHECK (transaction_type IN ('earned', 'bonus', 'adjustment', 'reversal', 'payout')) NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'GBP',
    description TEXT,
    transaction_status VARCHAR(50) CHECK (transaction_status IN ('pending', 'approved', 'paid', 'failed', 'reversed')) DEFAULT 'pending',
    processed_at TIMESTAMPTZ,
    payout_batch_id UUID,
    payment_reference TEXT,
    tax_withheld DECIMAL(10,2) DEFAULT 0.00,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Payout Batches
CREATE TABLE payout_batches (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    batch_name VARCHAR(255) NOT NULL,
    payout_period_start TIMESTAMPTZ NOT NULL,
    payout_period_end TIMESTAMPTZ NOT NULL,
    total_amount DECIMAL(15,2) NOT NULL,
    total_transactions INTEGER NOT NULL,
    batch_status VARCHAR(50) CHECK (batch_status IN ('preparing', 'ready', 'processing', 'completed', 'failed')) DEFAULT 'preparing',
    payment_method VARCHAR(50) CHECK (payment_method IN ('bank_transfer', 'paypal', 'stripe', 'manual_check')) NOT NULL,
    processed_by UUID REFERENCES users(id),
    processing_started_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    failure_reason TEXT,
    reconciliation_notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Referral Rewards (Non-commission rewards)
CREATE TABLE referral_rewards (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    referral_account_id UUID NOT NULL REFERENCES referral_accounts(id),
    reward_type VARCHAR(50) CHECK (reward_type IN ('milestone_bonus', 'performance_bonus', 'special_promotion', 'loyalty_reward')) NOT NULL,
    reward_trigger VARCHAR(100) NOT NULL, -- What triggered this reward
    reward_value DECIMAL(10,2),
    reward_description TEXT NOT NULL,
    reward_status VARCHAR(50) CHECK (reward_status IN ('pending', 'awarded', 'claimed', 'expired')) DEFAULT 'pending',
    expiry_date TIMESTAMPTZ,
    claimed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Referral Analytics
CREATE TABLE referral_analytics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    referral_account_id UUID NOT NULL REFERENCES referral_accounts(id),
    analytics_date DATE NOT NULL,
    clicks INTEGER DEFAULT 0,
    unique_clicks INTEGER DEFAULT 0,
    signups INTEGER DEFAULT 0,
    conversions INTEGER DEFAULT 0,
    revenue_generated DECIMAL(12,2) DEFAULT 0.00,
    commissions_earned DECIMAL(10,2) DEFAULT 0.00,
    conversion_rate DECIMAL(5,4) DEFAULT 0.0000, -- clicks to conversions
    average_order_value DECIMAL(10,2) DEFAULT 0.00,
    top_traffic_sources JSONB DEFAULT '[]',
    device_breakdown JSONB DEFAULT '{}',
    geo_breakdown JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(referral_account_id, analytics_date)
);

-- Referral Campaign Tracking
CREATE TABLE referral_campaigns (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    referral_account_id UUID NOT NULL REFERENCES referral_accounts(id),
    campaign_name VARCHAR(255) NOT NULL,
    campaign_type VARCHAR(50) CHECK (campaign_type IN ('social_media', 'email_blast', 'event_promotion', 'content_marketing', 'partner_collaboration')) NOT NULL,
    campaign_description TEXT,
    start_date TIMESTAMPTZ NOT NULL,
    end_date TIMESTAMPTZ,
    target_referrals INTEGER,
    bonus_commission_rate DECIMAL(5,4), -- Extra commission for this campaign
    campaign_url TEXT,
    utm_parameters JSONB DEFAULT '{}',
    campaign_materials JSONB DEFAULT '[]', -- Images, copy, templates
    campaign_status VARCHAR(50) CHECK (campaign_status IN ('draft', 'active', 'paused', 'completed', 'archived')) DEFAULT 'draft',
    performance_metrics JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Performance Indexes
CREATE INDEX idx_referral_accounts_referrer_id ON referral_accounts(referrer_id);
CREATE INDEX idx_referral_accounts_referral_code ON referral_accounts(referral_code);
CREATE INDEX idx_referrals_referrer_account_id ON referrals(referrer_account_id);
CREATE INDEX idx_referrals_referee_email ON referrals(referee_email);
CREATE INDEX idx_referrals_status ON referrals(referral_status);
CREATE INDEX idx_referrals_created_at ON referrals(created_at);
CREATE INDEX idx_commission_transactions_account_id ON commission_transactions(referral_account_id);
CREATE INDEX idx_commission_transactions_status ON commission_transactions(transaction_status);
CREATE INDEX idx_payout_batches_status ON payout_batches(batch_status);
CREATE INDEX idx_referral_analytics_account_date ON referral_analytics(referral_account_id, analytics_date);
```

#### API Endpoints Required

```typescript
// Referral System Types
interface ReferralAccount {
  id: string;
  referrer_id: string;
  referrer_type: 'supplier' | 'couple' | 'affiliate' | 'employee';
  referral_code: string;
  program_id: string;
  total_referrals: number;
  successful_referrals: number;
  total_earnings: number;
  pending_earnings: number;
  paid_earnings: number;
  performance_tier: 'bronze' | 'silver' | 'gold' | 'platinum';
  account_status: 'active' | 'suspended' | 'closed';
  payout_method: PayoutMethodConfig;
  custom_landing_page?: string;
  tracking_settings: ReferralTrackingSettings;
  created_at: string;
  updated_at: string;
}

interface ReferralTrackingSettings {
  track_clicks: boolean;
  track_conversions: boolean;
  attribution_window_days: number;
  allow_self_referral: boolean;
}

interface PayoutMethodConfig {
  method: 'bank_transfer' | 'paypal' | 'stripe';
  account_details: Record<string, any>;
  preferred_currency: string;
  minimum_payout: number;
}

interface Referral {
  id: string;
  referrer_account_id: string;
  referrer_id: string;
  referee_id?: string;
  referee_email: string;
  referee_type: 'supplier' | 'couple' | 'venue';
  referral_method: 'email_invite' | 'social_share' | 'direct_link' | 'qr_code' | 'word_of_mouth';
  referral_source?: string;
  click_timestamp?: string;
  signup_timestamp?: string;
  conversion_timestamp?: string;
  referral_status: 'pending' | 'clicked' | 'signed_up' | 'converted' | 'qualified' | 'rejected' | 'expired';
  subscription_plan?: string;
  conversion_value?: number;
  commission_earned: number;
  commission_status: 'pending' | 'approved' | 'paid' | 'reversed';
  qualification_date?: string;
  rejection_reason?: string;
  tracking_data: Record<string, any>;
  notes?: string;
  created_at: string;
  updated_at: string;
}

interface CommissionTransaction {
  id: string;
  referral_account_id: string;
  referral_id: string;
  transaction_type: 'earned' | 'bonus' | 'adjustment' | 'reversal' | 'payout';
  amount: number;
  currency: string;
  description?: string;
  transaction_status: 'pending' | 'approved' | 'paid' | 'failed' | 'reversed';
  processed_at?: string;
  payout_batch_id?: string;
  payment_reference?: string;
  tax_withheld: number;
  created_at: string;
  updated_at: string;
}

interface ReferralProgram {
  id: string;
  program_name: string;
  program_type: 'supplier' | 'couple' | 'venue_partner' | 'affiliate';
  commission_type: 'percentage' | 'fixed_amount' | 'tiered' | 'lifetime';
  commission_value: number;
  commission_currency: string;
  tier_structure: TierStructure;
  minimum_payout: number;
  payout_frequency: 'immediate' | 'weekly' | 'monthly' | 'quarterly';
  program_rules: ProgramRules;
  is_active: boolean;
  start_date: string;
  end_date?: string;
  created_at: string;
  updated_at: string;
}

interface TierStructure {
  bronze: { threshold: number; commission_rate: number };
  silver: { threshold: number; commission_rate: number };
  gold: { threshold: number; commission_rate: number };
  platinum: { threshold: number; commission_rate: number };
}

interface ProgramRules {
  qualification_period_days: number;
  allow_stacking: boolean;
  max_referrals_per_month: number;
  excluded_plans: string[];
  geographical_restrictions: string[];
}

// API Request/Response Types
interface CreateReferralAccountRequest {
  referrer_id: string;
  referrer_type: 'supplier' | 'couple' | 'affiliate';
  program_id: string;
  custom_referral_code?: string;
  payout_method: PayoutMethodConfig;
  tracking_settings?: Partial<ReferralTrackingSettings>;
}

interface CreateReferralAccountResponse {
  success: boolean;
  data: ReferralAccount;
  referral_link: string;
  qr_code_url: string;
  message?: string;
}

interface SendReferralInviteRequest {
  referral_account_id: string;
  referee_emails: string[];
  referee_type: 'supplier' | 'couple' | 'venue';
  message_template_id?: string;
  custom_message?: string;
  scheduled_send_at?: string;
}

interface SendReferralInviteResponse {
  success: boolean;
  invites_sent: number;
  failed_invites: string[];
  tracking_links: Record<string, string>;
  message?: string;
}

interface ReferralTrackingData {
  referral_code: string;
  utm_source?: string;
  utm_medium?: string;
  utm_campaign?: string;
  utm_content?: string;
  device_info?: Record<string, any>;
  location_info?: Record<string, any>;
  referrer_url?: string;
}

interface TrackReferralClickRequest {
  referral_code: string;
  tracking_data: ReferralTrackingData;
}

interface TrackReferralClickResponse {
  success: boolean;
  redirect_url: string;
  click_id: string;
  message?: string;
}

interface ProcessReferralConversionRequest {
  referral_code?: string;
  referee_email: string;
  subscription_plan: string;
  conversion_value: number;
  payment_method: string;
  tracking_data?: ReferralTrackingData;
}

interface ProcessReferralConversionResponse {
  success: boolean;
  referral_id: string;
  commission_earned: number;
  commission_status: string;
  qualification_date?: string;
  message?: string;
}

interface ReferralDashboardStats {
  total_referrals: number;
  successful_referrals: number;
  pending_referrals: number;
  conversion_rate: number;
  total_earnings: number;
  pending_earnings: number;
  this_month_earnings: number;
  next_payout_amount: number;
  next_payout_date: string;
  performance_tier: string;
  referrals_to_next_tier: number;
  top_performing_channels: Array<{
    channel: string;
    conversions: number;
    earnings: number;
  }>;
  recent_referrals: Referral[];
  monthly_performance: Array<{
    month: string;
    referrals: number;
    conversions: number;
    earnings: number;
  }>;
}

interface GetReferralDashboardResponse {
  success: boolean;
  data: ReferralDashboardStats;
  message?: string;
}
```

### COMPONENT IMPLEMENTATIONS

#### 1. Referral Dashboard Component

```typescript
// src/components/referral/ReferralDashboard.tsx
'use client';

import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { 
  Users, 
  TrendingUp, 
  PoundSterling, 
  Calendar,
  Share2,
  Gift,
  Trophy,
  Target,
  Mail,
  QrCode,
  LinkIcon,
  Facebook,
  Twitter,
  Instagram,
  MessageSquare
} from 'lucide-react';
import { useToast } from '@/components/ui/use-toast';
import { cn } from '@/lib/utils';

interface ReferralDashboardProps {
  referralAccount: ReferralAccount;
  className?: string;
}

export function ReferralDashboard({ referralAccount, className }: ReferralDashboardProps) {
  const { toast } = useToast();
  const [dashboardData, setDashboardData] = useState<ReferralDashboardStats | null>(null);
  const [loading, setLoading] = useState(true);
  const [copying, setCopying] = useState(false);

  const referralLink = `https://wedsync.com/join?ref=${referralAccount.referral_code}`;

  useEffect(() => {
    fetchDashboardData();
  }, [referralAccount.id]);

  const fetchDashboardData = async () => {
    try {
      const response = await fetch(`/api/referrals/${referralAccount.id}/dashboard`);
      if (!response.ok) throw new Error('Failed to fetch dashboard data');
      
      const result = await response.json();
      setDashboardData(result.data);
    } catch (error) {
      console.error('Error fetching dashboard data:', error);
      toast({
        title: "Error",
        description: "Failed to load referral dashboard data",
        variant: "destructive",
      });
    } finally {
      setLoading(false);
    }
  };

  const copyReferralLink = async () => {
    setCopying(true);
    try {
      await navigator.clipboard.writeText(referralLink);
      toast({
        title: "Link Copied!",
        description: "Your referral link has been copied to clipboard",
      });
    } catch (error) {
      toast({
        title: "Error",
        description: "Failed to copy referral link",
        variant: "destructive",
      });
    } finally {
      setCopying(false);
    }
  };

  const shareToSocial = (platform: string) => {
    const shareText = encodeURIComponent("Join me on WedSync - the best platform for wedding professionals! Use my referral link and we both benefit 🎉");
    const shareUrl = encodeURIComponent(referralLink);
    
    const urls = {
      facebook: `https://www.facebook.com/sharer/sharer.php?u=${shareUrl}&quote=${shareText}`,
      twitter: `https://twitter.com/intent/tweet?text=${shareText}&url=${shareUrl}`,
      linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${shareUrl}`,
      whatsapp: `https://wa.me/?text=${shareText}%20${shareUrl}`
    };
    
    window.open(urls[platform as keyof typeof urls], '_blank', 'width=600,height=400');
  };

  const generateQRCode = async () => {
    try {
      const response = await fetch('/api/referrals/generate-qr', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          url: referralLink,
          account_id: referralAccount.id 
        })
      });
      
      if (!response.ok) throw new Error('Failed to generate QR code');
      
      const result = await response.json();
      
      // Download the QR code
      const link = document.createElement('a');
      link.href = result.qr_code_url;
      link.download = `referral-qr-${referralAccount.referral_code}.png`;
      link.click();
      
      toast({
        title: "QR Code Generated!",
        description: "Your referral QR code has been downloaded",
      });
    } catch (error) {
      toast({
        title: "Error",
        description: "Failed to generate QR code",
        variant: "destructive",
      });
    }
  };

  if (loading) {
    return (
      <div className="space-y-4">
        <div className="h-32 bg-gray-100 animate-pulse rounded-lg"></div>
        <div className="h-64 bg-gray-100 animate-pulse rounded-lg"></div>
      </div>
    );
  }

  if (!dashboardData) {
    return <div>Failed to load referral data</div>;
  }

  const tierProgress = {
    bronze: { next: 'silver', threshold: 5 },
    silver: { next: 'gold', threshold: 15 },
    gold: { next: 'platinum', threshold: 50 },
    platinum: { next: null, threshold: null }
  };

  const currentTier = tierProgress[referralAccount.performance_tier as keyof typeof tierProgress];
  const progressPercentage = currentTier.threshold 
    ? Math.min((dashboardData.successful_referrals / currentTier.threshold) * 100, 100)
    : 100;

  return (
    <div className={cn("space-y-6", className)}>
      {/* Header Stats */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Total Referrals</CardTitle>
            <Users className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{dashboardData.total_referrals}</div>
            <p className="text-xs text-muted-foreground">
              {dashboardData.successful_referrals} successful
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Conversion Rate</CardTitle>
            <TrendingUp className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{dashboardData.conversion_rate.toFixed(1)}%</div>
            <p className="text-xs text-muted-foreground">
              Industry avg: 12%
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Total Earnings</CardTitle>
            <PoundSterling className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">£{dashboardData.total_earnings.toFixed(2)}</div>
            <p className="text-xs text-muted-foreground">
              £{dashboardData.pending_earnings.toFixed(2)} pending
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Next Payout</CardTitle>
            <Calendar className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">£{dashboardData.next_payout_amount.toFixed(2)}</div>
            <p className="text-xs text-muted-foreground">
              {new Date(dashboardData.next_payout_date).toLocaleDateString()}
            </p>
          </CardContent>
        </Card>
      </div>

      {/* Performance Tier */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Trophy className="h-5 w-5" />
            Performance Tier
          </CardTitle>
          <CardDescription>
            Earn higher commissions as you refer more customers
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="flex items-center gap-4">
            <Badge variant={referralAccount.performance_tier === 'platinum' ? 'default' : 'secondary'} className="capitalize">
              {referralAccount.performance_tier}
            </Badge>
            {currentTier.next && (
              <span className="text-sm text-muted-foreground">
                {dashboardData.referrals_to_next_tier} more referrals to reach {currentTier.next}
              </span>
            )}
          </div>
          
          {currentTier.threshold && (
            <div className="space-y-2">
              <div className="flex justify-between text-sm">
                <span>{dashboardData.successful_referrals} successful referrals</span>
                <span>{currentTier.threshold} needed</span>
              </div>
              <Progress value={progressPercentage} className="w-full" />
            </div>
          )}
        </CardContent>
      </Card>

      <Tabs defaultValue="overview" className="space-y-4">
        <TabsList>
          <TabsTrigger value="overview">Overview</TabsTrigger>
          <TabsTrigger value="share">Share & Invite</TabsTrigger>
          <TabsTrigger value="referrals">My Referrals</TabsTrigger>
          <TabsTrigger value="earnings">Earnings</TabsTrigger>
        </TabsList>

        <TabsContent value="overview" className="space-y-4">
          {/* Performance Charts */}
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <Card>
              <CardHeader>
                <CardTitle>Top Performing Channels</CardTitle>
                <CardDescription>Where your best referrals come from</CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-3">
                  {dashboardData.top_performing_channels.map((channel, index) => (
                    <div key={index} className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <div className="w-3 h-3 rounded-full bg-blue-500"></div>
                        <span className="text-sm capitalize">{channel.channel}</span>
                      </div>
                      <div className="text-right">
                        <div className="text-sm font-medium">{channel.conversions} conversions</div>
                        <div className="text-xs text-muted-foreground">£{channel.earnings.toFixed(2)}</div>
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle>Recent Activity</CardTitle>
                <CardDescription>Your latest referrals</CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-3">
                  {dashboardData.recent_referrals.slice(0, 5).map((referral) => (
                    <div key={referral.id} className="flex items-center justify-between py-2 border-b last:border-b-0">
                      <div>
                        <div className="text-sm font-medium">{referral.referee_email}</div>
                        <div className="text-xs text-muted-foreground">
                          {new Date(referral.created_at).toLocaleDateString()}
                        </div>
                      </div>
                      <div className="text-right">
                        <Badge variant={
                          referral.referral_status === 'converted' ? 'default' :
                          referral.referral_status === 'signed_up' ? 'secondary' :
                          'outline'
                        }>
                          {referral.referral_status.replace('_', ' ')}
                        </Badge>
                        {referral.commission_earned > 0 && (
                          <div className="text-xs text-green-600">
                            +£{referral.commission_earned.toFixed(2)}
                          </div>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          </div>
        </TabsContent>

        <TabsContent value="share" className="space-y-4">
          {/* Referral Link */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <LinkIcon className="h-5 w-5" />
                Your Referral Link
              </CardTitle>
              <CardDescription>
                Share this link with wedding professionals you know
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="flex items-center gap-2 p-3 bg-gray-50 rounded-lg">
                <code className="flex-1 text-sm">{referralLink}</code>
                <Button
                  onClick={copyReferralLink}
                  variant="outline"
                  size="sm"
                  disabled={copying}
                >
                  {copying ? 'Copying...' : 'Copy'}
                </Button>
              </div>
              
              <div className="grid grid-cols-2 gap-2">
                <Button onClick={generateQRCode} variant="outline" className="gap-2">
                  <QrCode className="h-4 w-4" />
                  Generate QR Code
                </Button>
                <Button onClick={() => shareToSocial('whatsapp')} variant="outline" className="gap-2">
                  <MessageSquare className="h-4 w-4" />
                  Share on WhatsApp
                </Button>
              </div>
            </CardContent>
          </Card>

          {/* Social Sharing */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Share2 className="h-5 w-5" />
                Social Media Sharing
              </CardTitle>
              <CardDescription>
                Share on your favorite platforms to reach more wedding professionals
              </CardDescription>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                <Button onClick={() => shareToSocial('facebook')} variant="outline" className="gap-2">
                  <Facebook className="h-4 w-4" />
                  Facebook
                </Button>
                <Button onClick={() => shareToSocial('twitter')} variant="outline" className="gap-2">
                  <Twitter className="h-4 w-4" />
                  Twitter
                </Button>
                <Button onClick={() => shareToSocial('linkedin')} variant="outline" className="gap-2">
                  <Users className="h-4 w-4" />
                  LinkedIn
                </Button>
                <Button onClick={() => shareToSocial('instagram')} variant="outline" className="gap-2">
                  <Instagram className="h-4 w-4" />
                  Instagram
                </Button>
              </div>
            </CardContent>
          </Card>

          {/* Email Invites */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Mail className="h-5 w-5" />
                Send Personal Invites
              </CardTitle>
              <CardDescription>
                Send personalized invites to wedding professionals in your network
              </CardDescription>
            </CardHeader>
            <CardContent>
              <Button className="w-full" onClick={() => window.location.href = '/referrals/invite'}>
                <Mail className="h-4 w-4 mr-2" />
                Create Email Campaign
              </Button>
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="referrals" className="space-y-4">
          <ReferralsList 
            referralAccountId={referralAccount.id} 
            referrals={dashboardData.recent_referrals}
          />
        </TabsContent>

        <TabsContent value="earnings" className="space-y-4">
          <EarningsBreakdown 
            referralAccountId={referralAccount.id}
            totalEarnings={dashboardData.total_earnings}
            pendingEarnings={dashboardData.pending_earnings}
            monthlyPerformance={dashboardData.monthly_performance}
          />
        </TabsContent>
      </Tabs>
    </div>
  );
}

// Additional components for different tabs would be implemented here
// ReferralsList, EarningsBreakdown, etc.
```

#### 2. Referral Service Implementation

```typescript
// src/lib/services/referral.service.ts
import { supabase } from '@/lib/supabase';
import { createHash, randomBytes } from 'crypto';

export class ReferralService {
  // Create a new referral account
  static async createReferralAccount(request: CreateReferralAccountRequest): Promise<CreateReferralAccountResponse> {
    try {
      // Generate unique referral code
      const referralCode = request.custom_referral_code || this.generateReferralCode();
      
      // Check if code already exists
      const { data: existingCode } = await supabase
        .from('referral_accounts')
        .select('referral_code')
        .eq('referral_code', referralCode)
        .single();
        
      if (existingCode) {
        throw new Error('Referral code already exists');
      }

      // Create referral account
      const { data: account, error } = await supabase
        .from('referral_accounts')
        .insert({
          referrer_id: request.referrer_id,
          referrer_type: request.referrer_type,
          program_id: request.program_id,
          referral_code: referralCode,
          payout_method: request.payout_method,
          tracking_settings: {
            track_clicks: true,
            track_conversions: true,
            attribution_window_days: 30,
            allow_self_referral: false,
            ...request.tracking_settings
          }
        })
        .select()
        .single();
        
      if (error) throw error;

      // Generate referral link and QR code
      const referralLink = `${process.env.NEXT_PUBLIC_BASE_URL}/join?ref=${referralCode}`;
      const qrCodeUrl = await this.generateQRCode(referralLink, account.id);

      return {
        success: true,
        data: account,
        referral_link: referralLink,
        qr_code_url: qrCodeUrl
      };
    } catch (error) {
      console.error('Error creating referral account:', error);
      return {
        success: false,
        data: null as any,
        referral_link: '',
        qr_code_url: '',
        message: error instanceof Error ? error.message : 'Failed to create referral account'
      };
    }
  }

  // Track referral click
  static async trackReferralClick(request: TrackReferralClickRequest): Promise<TrackReferralClickResponse> {
    try {
      // Find referral account
      const { data: account, error: accountError } = await supabase
        .from('referral_accounts')
        .select('id, referrer_id')
        .eq('referral_code', request.referral_code)
        .eq('account_status', 'active')
        .single();
        
      if (accountError || !account) {
        throw new Error('Invalid referral code');
      }

      // Generate click ID and redirect URL
      const clickId = randomBytes(16).toString('hex');
      const redirectUrl = `${process.env.NEXT_PUBLIC_BASE_URL}/signup?ref=${request.referral_code}&click_id=${clickId}`;

      // Store click data in analytics
      await this.recordAnalyticsEvent(account.id, 'click', {
        click_id: clickId,
        ...request.tracking_data
      });

      return {
        success: true,
        redirect_url: redirectUrl,
        click_id: clickId
      };
    } catch (error) {
      console.error('Error tracking referral click:', error);
      return {
        success: false,
        redirect_url: `${process.env.NEXT_PUBLIC_BASE_URL}/signup`,
        click_id: '',
        message: error instanceof Error ? error.message : 'Failed to track referral click'
      };
    }
  }

  // Process referral conversion
  static async processReferralConversion(request: ProcessReferralConversionRequest): Promise<ProcessReferralConversionResponse> {
    try {
      let referralAccountId: string | null = null;

      // Find referral account if referral code provided
      if (request.referral_code) {
        const { data: account } = await supabase
          .from('referral_accounts')
          .select('id, referrer_id, tracking_settings')
          .eq('referral_code', request.referral_code)
          .eq('account_status', 'active')
          .single();
          
        if (account) {
          referralAccountId = account.id;
        }
      }

      if (!referralAccountId) {
        return {
          success: false,
          referral_id: '',
          commission_earned: 0,
          commission_status: 'rejected',
          message: 'No valid referral found'
        };
      }

      // Check for existing referral
      const { data: existingReferral } = await supabase
        .from('referrals')
        .select('id')
        .eq('referrer_account_id', referralAccountId)
        .eq('referee_email', request.referee_email)
        .single();

      if (existingReferral) {
        return {
          success: false,
          referral_id: existingReferral.id,
          commission_earned: 0,
          commission_status: 'rejected',
          message: 'Referral already exists for this email'
        };
      }

      // Calculate commission
      const commission = await this.calculateCommission(
        referralAccountId,
        request.subscription_plan,
        request.conversion_value
      );

      // Create referral record
      const { data: referral, error: referralError } = await supabase
        .from('referrals')
        .insert({
          referrer_account_id: referralAccountId,
          referrer_id: (await supabase.from('referral_accounts').select('referrer_id').eq('id', referralAccountId).single()).data?.referrer_id,
          referee_email: request.referee_email,
          referee_type: 'supplier', // Inferred from signup
          referral_method: 'direct_link',
          referral_status: 'converted',
          subscription_plan: request.subscription_plan,
          conversion_value: request.conversion_value,
          commission_earned: commission.amount,
          commission_status: commission.status,
          qualification_date: commission.status === 'approved' ? new Date().toISOString() : null,
          tracking_data: request.tracking_data || {},
          conversion_timestamp: new Date().toISOString()
        })
        .select()
        .single();
        
      if (referralError) throw referralError;

      // Create commission transaction
      if (commission.amount > 0) {
        await supabase
          .from('commission_transactions')
          .insert({
            referral_account_id: referralAccountId,
            referral_id: referral.id,
            transaction_type: 'earned',
            amount: commission.amount,
            description: `Commission for ${request.subscription_plan} referral`,
            transaction_status: commission.status
          });

        // Update referral account totals
        await supabase.rpc('update_referral_account_stats', {
          account_id: referralAccountId,
          new_referral: true,
          successful_referral: true,
          earnings_amount: commission.amount
        });
      }

      // Record analytics
      await this.recordAnalyticsEvent(referralAccountId, 'conversion', {
        subscription_plan: request.subscription_plan,
        conversion_value: request.conversion_value,
        commission_earned: commission.amount
      });

      return {
        success: true,
        referral_id: referral.id,
        commission_earned: commission.amount,
        commission_status: commission.status,
        qualification_date: referral.qualification_date
      };
    } catch (error) {
      console.error('Error processing referral conversion:', error);
      return {
        success: false,
        referral_id: '',
        commission_earned: 0,
        commission_status: 'rejected',
        message: error instanceof Error ? error.message : 'Failed to process referral conversion'
      };
    }
  }

  // Send referral invites
  static async sendReferralInvites(request: SendReferralInviteRequest): Promise<SendReferralInviteResponse> {
    try {
      const { data: account } = await supabase
        .from('referral_accounts')
        .select('referrer_id, referral_code')
        .eq('id', request.referral_account_id)
        .single();
        
      if (!account) {
        throw new Error('Referral account not found');
      }

      const invitesSent: number[] = [];
      const failedInvites: string[] = [];
      const trackingLinks: Record<string, string> = {};

      // Process each email invite
      for (const email of request.referee_emails) {
        try {
          // Create unique tracking link for this email
          const trackingId = createHash('sha256').update(`${email}-${account.referral_code}`).digest('hex').substr(0, 16);
          const trackingLink = `${process.env.NEXT_PUBLIC_BASE_URL}/join?ref=${account.referral_code}&utm_source=email&utm_medium=referral&utm_campaign=personal_invite&email=${encodeURIComponent(email)}&tracking_id=${trackingId}`;
          
          trackingLinks[email] = trackingLink;

          // Send email invite using your email service (Resend, etc.)
          await this.sendReferralEmail({
            to: email,
            referrer_id: account.referrer_id,
            referral_link: trackingLink,
            custom_message: request.custom_message,
            template_id: request.message_template_id
          });

          invitesSent.push(1);
          
          // Create pending referral record
          await supabase
            .from('referrals')
            .insert({
              referrer_account_id: request.referral_account_id,
              referrer_id: account.referrer_id,
              referee_email: email,
              referee_type: request.referee_type,
              referral_method: 'email_invite',
              referral_status: 'pending',
              tracking_data: {
                tracking_id: trackingId,
                utm_source: 'email',
                utm_medium: 'referral',
                utm_campaign: 'personal_invite'
              }
            });
            
        } catch (error) {
          console.error(`Failed to send invite to ${email}:`, error);
          failedInvites.push(email);
        }
      }

      return {
        success: true,
        invites_sent: invitesSent.length,
        failed_invites: failedInvites,
        tracking_links: trackingLinks
      };
    } catch (error) {
      console.error('Error sending referral invites:', error);
      return {
        success: false,
        invites_sent: 0,
        failed_invites: request.referee_emails,
        tracking_links: {},
        message: error instanceof Error ? error.message : 'Failed to send referral invites'
      };
    }
  }

  // Private helper methods
  private static generateReferralCode(): string {
    // Generate a user-friendly referral code (8 characters, alphanumeric)
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = '';
    for (let i = 0; i < 8; i++) {
      result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
  }

  private static async calculateCommission(referralAccountId: string, subscriptionPlan: string, conversionValue: number) {
    // Get program details and calculate commission based on plan and performance tier
    const { data: account } = await supabase
      .from('referral_accounts')
      .select(`
        performance_tier,
        referral_programs (
          commission_type,
          commission_value,
          tier_structure
        )
      `)
      .eq('id', referralAccountId)
      .single();
      
    if (!account?.referral_programs) {
      return { amount: 0, status: 'rejected' };
    }

    const program = account.referral_programs;
    let commissionAmount = 0;

    // Calculate base commission
    if (program.commission_type === 'percentage') {
      commissionAmount = conversionValue * (program.commission_value / 100);
    } else if (program.commission_type === 'fixed_amount') {
      commissionAmount = program.commission_value;
    } else if (program.commission_type === 'tiered') {
      const tierMultiplier = program.tier_structure[account.performance_tier]?.commission_rate || 1;
      commissionAmount = program.commission_value * tierMultiplier;
    }

    return {
      amount: Math.round(commissionAmount * 100) / 100, // Round to 2 decimal places
      status: commissionAmount > 0 ? 'approved' : 'rejected'
    };
  }

  private static async generateQRCode(url: string, accountId: string): Promise<string> {
    // Implementation would use a QR code generation service
    // Return URL to generated QR code image
    return `${process.env.NEXT_PUBLIC_BASE_URL}/api/qr-codes/${accountId}`;
  }

  private static async recordAnalyticsEvent(referralAccountId: string, eventType: string, eventData: any) {
    const today = new Date().toISOString().split('T')[0];
    
    // Update or insert daily analytics
    await supabase.rpc('upsert_referral_analytics', {
      account_id: referralAccountId,
      analytics_date: today,
      event_type: eventType,
      event_data: eventData
    });
  }

  private static async sendReferralEmail(emailData: {
    to: string;
    referrer_id: string;
    referral_link: string;
    custom_message?: string;
    template_id?: string;
  }) {
    // Implementation would use your email service (Resend, etc.)
    // Send personalized referral email with tracking link
  }
}
```

### API ROUTES IMPLEMENTATION

```typescript
// src/app/api/referrals/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { ReferralService } from '@/lib/services/referral.service';
import { auth } from '@/lib/auth';

export async function POST(request: NextRequest) {
  try {
    const session = await auth();
    if (!session?.user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const body = await request.json();
    
    // Create new referral account
    const result = await ReferralService.createReferralAccount({
      referrer_id: session.user.id,
      referrer_type: 'supplier', // Default for now
      program_id: body.program_id,
      custom_referral_code: body.custom_referral_code,
      payout_method: body.payout_method,
      tracking_settings: body.tracking_settings
    });

    if (!result.success) {
      return NextResponse.json({ error: result.message }, { status: 400 });
    }

    return NextResponse.json(result);
  } catch (error) {
    console.error('Referral creation error:', error);
    return NextResponse.json(
      { error: 'Failed to create referral account' },
      { status: 500 }
    );
  }
}

// src/app/api/referrals/[accountId]/dashboard/route.ts
export async function GET(
  request: NextRequest,
  { params }: { params: { accountId: string } }
) {
  try {
    const session = await auth();
    if (!session?.user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    // Verify ownership
    const { data: account } = await supabase
      .from('referral_accounts')
      .select('referrer_id')
      .eq('id', params.accountId)
      .single();
      
    if (!account || account.referrer_id !== session.user.id) {
      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
    }

    // Get dashboard data
    const dashboardStats = await ReferralService.getDashboardStats(params.accountId);
    
    return NextResponse.json({
      success: true,
      data: dashboardStats
    });
  } catch (error) {
    console.error('Dashboard data error:', error);
    return NextResponse.json(
      { error: 'Failed to fetch dashboard data' },
      { status: 500 }
    );
  }
}

// src/app/api/referrals/track-click/route.ts
export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    
    const result = await ReferralService.trackReferralClick({
      referral_code: body.referral_code,
      tracking_data: {
        ...body.tracking_data,
        ip_address: request.headers.get('x-forwarded-for') || request.headers.get('x-real-ip'),
        user_agent: request.headers.get('user-agent'),
        referrer_url: request.headers.get('referer')
      }
    });

    return NextResponse.json(result);
  } catch (error) {
    console.error('Click tracking error:', error);
    return NextResponse.json(
      { error: 'Failed to track referral click' },
      { status: 500 }
    );
  }
}

// src/app/api/referrals/convert/route.ts
export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    
    const result = await ReferralService.processReferralConversion({
      referral_code: body.referral_code,
      referee_email: body.referee_email,
      subscription_plan: body.subscription_plan,
      conversion_value: body.conversion_value,
      payment_method: body.payment_method,
      tracking_data: body.tracking_data
    });

    return NextResponse.json(result);
  } catch (error) {
    console.error('Conversion processing error:', error);
    return NextResponse.json(
      { error: 'Failed to process referral conversion' },
      { status: 500 }
    );
  }
}
```

### ACCEPTANCE CRITERIA

- [ ] **Referral Account Management**
  - [ ] Users can create referral accounts with custom codes
  - [ ] Unique referral codes generated automatically
  - [ ] Performance tiers (Bronze/Silver/Gold/Platinum) working
  - [ ] Payout method configuration (bank transfer, PayPal, Stripe)
  - [ ] Custom landing pages for referrers

- [ ] **Referral Tracking System**
  - [ ] Click tracking with UTM parameters and device info
  - [ ] Attribution window (30 days default, configurable)
  - [ ] Multiple referral methods (email, social, direct link, QR codes)
  - [ ] Conversion tracking from signup to paid subscription
  - [ ] Duplicate prevention and fraud detection

- [ ] **Commission System**
  - [ ] Multiple commission types (percentage, fixed, tiered, lifetime)
  - [ ] Tier-based commission scaling
  - [ ] Automatic commission calculation on conversions
  - [ ] Commission approval and rejection workflow
  - [ ] Minimum payout thresholds ($25 default)

- [ ] **Payout Processing**
  - [ ] Batch payout processing (monthly default)
  - [ ] Multiple payout methods (bank transfer, PayPal, Stripe)
  - [ ] Tax withholding and reporting
  - [ ] Payment reconciliation and audit trails
  - [ ] Failed payment handling and retry logic

- [ ] **Dashboard & Analytics**
  - [ ] Real-time referral performance metrics
  - [ ] Conversion rate tracking and benchmarking
  - [ ] Earnings breakdown by period and channel
  - [ ] Top performing traffic sources analysis
  - [ ] Performance tier progress tracking

- [ ] **Sharing & Promotion Tools**
  - [ ] Social media sharing integration (Facebook, Twitter, LinkedIn, Instagram)
  - [ ] QR code generation for offline sharing
  - [ ] Email invitation system with custom templates
  - [ ] Copy-to-clipboard referral links
  - [ ] Custom sharing message templates

- [ ] **Email Campaign System**
  - [ ] Bulk email invitations with personal messages
  - [ ] Email templates for different industries
  - [ ] Email performance tracking (opens, clicks, conversions)
  - [ ] Automated follow-up sequences
  - [ ] CAN-SPAM compliance and unsubscribe handling

- [ ] **Campaign Management**
  - [ ] Seasonal referral campaigns with bonus commissions
  - [ ] Campaign performance tracking and analytics
  - [ ] A/B testing for referral messaging
  - [ ] Campaign ROI analysis
  - [ ] Automated campaign reporting

- [ ] **Fraud Prevention**
  - [ ] Self-referral detection and prevention
  - [ ] IP-based duplicate detection
  - [ ] Email validation and verification
  - [ ] Suspicious pattern detection
  - [ ] Manual review queue for flagged referrals

- [ ] **Mobile Optimization**
  - [ ] Mobile-responsive referral dashboard
  - [ ] Touch-optimized sharing buttons
  - [ ] Mobile QR code scanning support
  - [ ] Progressive Web App sharing capabilities
  - [ ] Offline referral code storage

- [ ] **Integration & APIs**
  - [ ] Webhook notifications for referral events
  - [ ] REST API for third-party integrations
  - [ ] CRM integration for referral tracking
  - [ ] Analytics platform integration (Google Analytics, Mixpanel)
  - [ ] Email service provider integration

- [ ] **Compliance & Legal**
  - [ ] GDPR compliance for referral data
  - [ ] Tax reporting and 1099 generation
  - [ ] Terms and conditions for referral program
  - [ ] Privacy policy updates for referral tracking
  - [ ] Regulatory compliance for affiliate marketing

- [ ] **Performance & Scalability**
  - [ ] Database indexes for high-volume referral queries
  - [ ] Caching for referral dashboard data
  - [ ] Async processing for commission calculations
  - [ ] Rate limiting on referral API endpoints
  - [ ] Monitoring and alerting for referral system health

- [ ] **Testing & Quality**
  - [ ] Unit tests for referral service methods
  - [ ] Integration tests for referral flow end-to-end
  - [ ] Load testing for high-volume referral processing
  - [ ] A/B testing framework for referral optimization
  - [ ] Automated fraud detection testing

### DEPENDENCIES
- Must complete after: User authentication system, Stripe payment integration, Email service setup
- Must complete before: Viral growth marketing campaigns, Partner program launch
- Shares code with: Payment processing system, User dashboard, Email notification system, Analytics platform

### ESTIMATED EFFORT
- **Team A Frontend**: 32 hours
  - Referral dashboard UI (16h)
  - Sharing tools and social integration (8h)
  - Mobile responsive optimization (8h)

- **Team B Backend**: 28 hours
  - Database schema and migrations (8h)
  - Referral service implementation (12h)
  - API endpoints and webhook processing (8h)

- **Team C Integration**: 16 hours
  - Email service integration (6h)
  - Payment processor integration (6h)
  - Analytics platform integration (4h)

- **Team D Platform**: 12 hours
  - Fraud prevention system (6h)
  - Performance monitoring (3h)
  - Security and compliance (3h)

- **Team E Testing**: 8 hours
  - End-to-end testing (4h)
  - Load testing (2h)
  - Security testing (2h)

- **Team F Marketing**: 6 hours
  - Campaign templates (3h)
  - Analytics setup (3h)

**Total Estimated Effort**: 102 hours

### VIRAL GROWTH IMPACT
**Expected Results:**
- **Viral Coefficient**: Target 1.8 (each user brings 1.8 new users)
- **Customer Acquisition Cost**: Reduce by 60% through referrals
- **Conversion Rate**: Referral customers convert 3x higher than cold leads
- **Lifetime Value**: Referral customers have 40% higher LTV
- **Network Effects**: Wedding vendors refer other vendors in their network
- **Organic Growth**: Word-of-mouth marketing drives sustainable growth

This referral program system is designed to be the primary driver of viral growth for WedSync, leveraging the tight-knit nature of the wedding industry where vendors regularly collaborate and refer business to each other. The tiered commission structure incentivizes sustained referral activity, while the comprehensive tracking and analytics ensure optimal performance and ROI measurement.