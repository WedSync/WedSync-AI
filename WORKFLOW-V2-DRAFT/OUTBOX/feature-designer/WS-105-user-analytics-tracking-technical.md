# TECHNICAL SPECIFICATION: WS-105 - User Analytics Tracking
## Generated by Feature Development Session - August 22, 2025

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding photographer reviewing quarterly business performance with their accountant
**I want to:** See which client interaction features generate the most bookings and engagement
**So that:** I can focus my time on high-value activities that directly lead to wedding contracts

**Real Wedding Scenario:**
A photographer reviews their analytics dashboard in March before wedding season starts. They discover that clients who complete the "venue preferences" form section are 3.2x more likely to book, but only 23% of clients are filling it out. The analytics show this drop-off happens at the "outdoor ceremony" question. Based on this data, they simplify the form and send personalized follow-ups to clients who haven't completed it. This insight-driven approach increases their booking rate from 45% to 68% during peak season, resulting in 12 additional weddings worth $84,000 in revenue.

### SPECIFICATION SOURCE
- **Feature ID:** WS-105
- **Original Spec:** /CORE-SPECIFICATIONS/11-TESTING-DEPLOYMENT/03-Monitoring/03-user-analytics md.md
- **Current Implementation:** 0% complete
- **Files to Modify:**
  - `/wedsync/lib/analytics/posthog.ts` (create new)
  - `/wedsync/lib/analytics/events.ts` (create new)
- **New Files to Create:**
  - `/wedsync/src/hooks/usePageTracking.ts`
  - `/wedsync/src/hooks/useAnalytics.ts`
  - `/wedsync/src/components/analytics/AnalyticsDashboard.tsx`
  - `/wedsync/src/components/analytics/MetricCard.tsx`
  - `/wedsync/src/components/analytics/FunnelChart.tsx`
  - `/wedsync/src/components/analytics/RetentionChart.tsx`
  - `/wedsync/src/components/analytics/FeatureAdoptionTable.tsx`
  - `/wedsync/lib/analytics/feature-adoption.ts`
  - `/wedsync/lib/analytics/funnels.ts`
  - `/wedsync/lib/analytics/cohorts.ts`
  - `/wedsync/lib/analytics/ab-testing.ts`
  - `/wedsync/app/admin/analytics/page.tsx`
  - `/wedsync/app/api/analytics/metrics/route.ts`
  - `/wedsync/app/api/analytics/cohorts/route.ts`
  - `/wedsync/supabase/migrations/20250822000006_analytics_tracking.sql`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- User analytics events and sessions
CREATE TABLE IF NOT EXISTS analytics_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  session_id VARCHAR(255) NOT NULL,
  event_name VARCHAR(255) NOT NULL,
  event_properties JSONB DEFAULT '{}',
  page_url TEXT,
  page_title VARCHAR(500),
  referrer TEXT,
  user_agent TEXT,
  platform VARCHAR(50), -- 'wedsync' or 'wedme'
  user_type VARCHAR(20), -- 'supplier' or 'couple'
  wedding_context JSONB DEFAULT '{}', -- Wedding-specific context
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_analytics_events_user_time ON analytics_events(user_id, created_at DESC);
CREATE INDEX idx_analytics_events_name ON analytics_events(event_name, created_at DESC);
CREATE INDEX idx_analytics_events_session ON analytics_events(session_id, created_at);
CREATE INDEX idx_analytics_events_platform ON analytics_events(platform, user_type, created_at DESC);

-- Feature adoption tracking
CREATE TABLE IF NOT EXISTS feature_adoption (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id),
  feature_name VARCHAR(255) NOT NULL,
  first_used_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  last_used_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  usage_count INTEGER DEFAULT 1,
  platform VARCHAR(50) NOT NULL,
  user_type VARCHAR(20) NOT NULL,
  vendor_type VARCHAR(50), -- For suppliers only
  subscription_tier VARCHAR(50),
  UNIQUE(user_id, feature_name)
);

CREATE INDEX idx_feature_adoption_user ON feature_adoption(user_id, last_used_at DESC);
CREATE INDEX idx_feature_adoption_feature ON feature_adoption(feature_name, usage_count DESC);
CREATE INDEX idx_feature_adoption_tier ON feature_adoption(subscription_tier, vendor_type);

-- User cohorts for retention analysis
CREATE TABLE IF NOT EXISTS user_cohorts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id),
  cohort_date DATE NOT NULL, -- Week of signup
  signup_date DATE NOT NULL,
  platform VARCHAR(50) NOT NULL,
  user_type VARCHAR(20) NOT NULL,
  vendor_type VARCHAR(50),
  subscription_tier VARCHAR(50),
  first_wedding_date DATE, -- For couples
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(user_id)
);

CREATE INDEX idx_user_cohorts_date ON user_cohorts(cohort_date, platform);
CREATE INDEX idx_user_cohorts_type ON user_cohorts(user_type, vendor_type);

-- User activity tracking for retention
CREATE TABLE IF NOT EXISTS user_activity_weeks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id),
  week_date DATE NOT NULL, -- Monday of the week
  activity_count INTEGER DEFAULT 0,
  unique_features_used INTEGER DEFAULT 0,
  session_count INTEGER DEFAULT 0,
  total_time_minutes INTEGER DEFAULT 0,
  last_activity_at TIMESTAMP WITH TIME ZONE,
  UNIQUE(user_id, week_date)
);

CREATE INDEX idx_user_activity_weeks_user_time ON user_activity_weeks(user_id, week_date DESC);
CREATE INDEX idx_user_activity_weeks_date ON user_activity_weeks(week_date, activity_count DESC);

-- A/B test experiments and assignments
CREATE TABLE IF NOT EXISTS ab_experiments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) UNIQUE NOT NULL,
  description TEXT,
  variants JSONB NOT NULL, -- Array of variant names
  traffic_allocation DECIMAL(3,2) DEFAULT 1.0, -- 0.0 to 1.0
  status VARCHAR(20) DEFAULT 'draft' CHECK (status IN ('draft', 'running', 'paused', 'completed')),
  start_date TIMESTAMP WITH TIME ZONE,
  end_date TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS ab_assignments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  experiment_id UUID NOT NULL REFERENCES ab_experiments(id),
  user_id UUID NOT NULL REFERENCES auth.users(id),
  variant_name VARCHAR(100) NOT NULL,
  assigned_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(experiment_id, user_id)
);

-- Wedding-specific analytics context
CREATE TABLE IF NOT EXISTS wedding_analytics_context (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  event_id UUID REFERENCES analytics_events(id),
  user_id UUID NOT NULL REFERENCES auth.users(id),
  wedding_date DATE,
  days_until_wedding INTEGER,
  client_id UUID REFERENCES clients(id),
  vendor_type VARCHAR(50),
  business_impact VARCHAR(20) CHECK (business_impact IN ('low', 'medium', 'high', 'critical')),
  season_type VARCHAR(20), -- 'peak', 'off_peak', 'shoulder'
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_wedding_analytics_context_user ON wedding_analytics_context(user_id, wedding_date);
CREATE INDEX idx_wedding_analytics_context_impact ON wedding_analytics_context(business_impact, season_type);
```

#### API Endpoints Required
```typescript
// POST /api/analytics/track
interface TrackEventRequest {
  eventName: string;
  properties?: Record<string, any>;
  sessionId: string;
  pageUrl?: string;
  pageTitle?: string;
  weddingContext?: {
    weddingDate?: string;
    clientId?: string;
    vendorType?: string;
    urgency?: string;
  };
}

interface TrackEventResponse {
  success: boolean;
  eventId?: string;
}

// GET /api/analytics/metrics
interface AnalyticsMetricsResponse {
  overview: {
    dau: number; // Daily Active Users
    wau: number; // Weekly Active Users
    mau: number; // Monthly Active Users
    stickiness: number; // DAU/MAU ratio
    avgSessionDuration: number; // minutes
  };
  growth: {
    signupsThisWeek: number;
    signupsLastWeek: number;
    retentionWeek1: number;
    retentionWeek4: number;
  };
  engagement: {
    topFeatures: Array<{
      feature: string;
      users: number;
      sessions: number;
      avgUsage: number;
    }>;
    funnelConversion: Record<string, number>;
  };
  business: {
    conversionRate: number;
    avgTimeToConversion: number; // days
    topConversionSources: Array<{
      source: string;
      conversions: number;
      rate: number;
    }>;
  };
}

// GET /api/analytics/cohorts
interface CohortsResponse {
  retention: Array<{
    cohortWeek: string;
    week0: number;
    week1: number;
    week2: number;
    week4: number;
    week8: number;
    week12: number;
  }>;
  featureAdoption: Array<{
    feature: string;
    adoptionRate: number;
    timeToAdopt: number; // days
    powerUsers: number;
  }>;
  revenue: Array<{
    cohortWeek: string;
    week0Revenue: number;
    week4Revenue: number;
    week12Revenue: number;
    ltv: number;
  }>;
}

// GET /api/analytics/funnels/:funnelName
interface FunnelAnalysisResponse {
  funnel: {
    name: string;
    steps: Array<{
      step: string;
      users: number;
      conversionRate: number;
      dropoffRate: number;
    }>;
  };
  segments: Array<{
    segment: string;
    conversionRates: number[];
  }>;
}

// POST /api/analytics/experiments/:experimentId/assign
interface ExperimentAssignmentRequest {
  userId: string;
}

interface ExperimentAssignmentResponse {
  variant: string;
  experimentId: string;
  assignedAt: string;
}
```

#### Frontend Components Required
```typescript
// Component: AnalyticsDashboard
// Location: /src/components/analytics/AnalyticsDashboard.tsx

interface Props {
  timeRange?: '7d' | '30d' | '90d' | '1y';
  platform?: 'wedsync' | 'wedme' | 'all';
  userType?: 'supplier' | 'couple' | 'all';
}

// Key functionality:
- Real-time metrics overview with key KPIs
- Interactive time range and segment filtering
- Drill-down capability for detailed analysis
- Export functionality for reports
- Wedding season impact visualization

// Component: MetricCard
// Location: /src/components/analytics/MetricCard.tsx

interface Props {
  title: string;
  value: string | number;
  trend?: number;
  format?: 'number' | 'percentage' | 'currency' | 'duration';
  comparison?: string;
  target?: number;
}

// Key functionality:
- Clean metric display with trend indicators
- Color-coded performance against targets
- Contextual tooltips with definitions
- Responsive design for mobile dashboards

// Component: FunnelChart
// Location: /src/components/analytics/FunnelChart.tsx

interface Props {
  data: FunnelStep[];
  title: string;
  segmentBy?: string;
  onStepClick?: (step: string) => void;
}

// Key functionality:
- Visual funnel representation with drop-offs
- Segment comparison overlays
- Click-through for step analysis
- Conversion rate annotations

// Component: RetentionChart
// Location: /src/components/analytics/RetentionChart.tsx

interface Props {
  cohortData: CohortRetention[];
  heatmapView?: boolean;
  highlightPeriods?: string[];
}

// Key functionality:
- Cohort retention heatmap visualization
- Period-over-period comparison
- Wedding season highlighting
- Export to CSV for external analysis

// Component: FeatureAdoptionTable
// Location: /src/components/analytics/FeatureAdoptionTable.tsx

interface Props {
  features: FeatureAdoption[];
  sortBy?: 'adoption' | 'usage' | 'retention';
  filterBy?: string;
  showWeddingContext?: boolean;
}

// Key functionality:
- Sortable feature adoption metrics
- Wedding-specific usage patterns
- Power user identification
- Feature deprecation recommendations
```

#### Integration Points
```typescript
// Service: AnalyticsService
// Dependencies: PostHog, Supabase, wedding context

class AnalyticsService {
  async trackEvent(
    eventName: string,
    properties: Record<string, any>,
    userId?: string,
    sessionId?: string
  ): Promise<void> {
    // 1. Store event in local database
    // 2. Send to PostHog for product analytics
    // 3. Add wedding-specific context if applicable
    // 4. Update feature adoption counters
    // 5. Process real-time metrics
  }
  
  async trackPageView(
    url: string,
    title: string,
    userId?: string,
    referrer?: string
  ): Promise<void> {
    // Track page navigation with context
    // Update session data
    // Calculate engagement metrics
  }
  
  async getBusinessMetrics(
    timeRange: string,
    segments?: Record<string, any>
  ): Promise<BusinessMetrics> {
    // Calculate wedding industry specific KPIs
    // Factor in seasonal trends
    // Include conversion funnel analysis
  }
}

// Service: CohortAnalyzer
// Dependencies: Database queries, retention calculations

class CohortAnalyzer {
  async calculateRetention(
    cohortDate: Date,
    periods: number[]
  ): Promise<RetentionData> {
    // Calculate retention for signup cohorts
    // Factor in wedding season effects
    // Include feature-specific retention
  }
  
  async analyzeFeatureAdoption(
    features: string[],
    timeRange: string
  ): Promise<AdoptionData> {
    // Time-to-adoption analysis
    // Power user identification
    // Churn risk based on feature usage
  }
}

// Hook: useAnalytics
export function useAnalytics() {
  // Event tracking functions
  // Automatic page view tracking
  // User identification management
  // Privacy consent handling
}

// Hook: useExperiments
export function useExperiments() {
  // A/B test variant assignment
  // Conversion tracking
  // Experiment configuration
  // Statistical significance calculation
}
```

### CODE EXAMPLES

#### Example 1: PostHog Integration with Wedding Context
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import posthog from 'posthog-js';
import { User } from '@supabase/supabase-js';

export function initPostHog() {
  if (typeof window !== 'undefined') {
    posthog.init(process.env.NEXT_PUBLIC_POSTHOG_KEY!, {
      api_host: process.env.NEXT_PUBLIC_POSTHOG_HOST || 'https://app.posthog.com',
      loaded: (posthog) => {
        if (process.env.NODE_ENV === 'development') {
          posthog.opt_out_capturing();
        }
      },
      autocapture: {
        dom_event_allowlist: ['click', 'change', 'submit'],
        url_allowlist: [window.location.origin],
        css_selector_allowlist: [
          '[data-analytics]',
          '.analytics-track',
          'button',
          'a',
          'form'
        ]
      },
      capture_pageview: false, // Manual page view tracking
      capture_pageleave: true,
      cross_subdomain_cookie: true,
      persistence: 'localStorage+cookie',
      session_recording: {
        maskAllInputs: false,
        maskInputOptions: {
          password: true,
          email: true,
          phone: true,
          credit_card: true
        },
        maskTextSelector: '.sensitive-data, .pii-data',
        blockSelector: '.no-record'
      }
    });
  }
}

export function identifyUser(user: User, additionalContext?: Record<string, any>) {
  if (typeof window !== 'undefined' && user) {
    posthog.identify(user.id, {
      email: user.email,
      created_at: user.created_at,
      
      // Core user properties
      platform: user.user_metadata?.is_couple ? 'wedme' : 'wedsync',
      user_type: user.user_metadata?.is_couple ? 'couple' : 'supplier',
      
      // Supplier-specific properties
      vendor_type: user.user_metadata?.vendor_type,
      business_name: user.user_metadata?.business_name,
      subscription_tier: user.user_metadata?.tier || 'free',
      
      // Couple-specific properties
      wedding_date: user.user_metadata?.wedding_date,
      partner_name: user.user_metadata?.partner_name,
      
      // Business context
      signup_source: user.user_metadata?.signup_source,
      referral_code: user.user_metadata?.referral_code,
      
      ...additionalContext
    });
    
    // Set super properties for all events
    posthog.register({
      platform: user.user_metadata?.is_couple ? 'wedme' : 'wedsync',
      user_type: user.user_metadata?.is_couple ? 'couple' : 'supplier',
      vendor_type: user.user_metadata?.vendor_type,
      subscription_tier: user.user_metadata?.tier || 'free',
      is_wedding_season: isWeddingSeason(),
      app_version: process.env.NEXT_PUBLIC_APP_VERSION
    });
  }
}

// Predefined events for consistency across the platform
export const AnalyticsEvents = {
  // Onboarding funnel
  SIGNUP_STARTED: 'signup_started',
  VENDOR_TYPE_SELECTED: 'vendor_type_selected',
  ACCOUNT_CREATED: 'account_created',
  PROFILE_COMPLETED: 'profile_completed',
  ONBOARDING_COMPLETED: 'onboarding_completed',
  
  // Form builder events
  FORM_BUILDER_OPENED: 'form_builder_opened',
  FORM_FIELD_ADDED: 'form_field_added',
  FORM_SAVED: 'form_saved',
  FORM_PUBLISHED: 'form_published',
  FORM_SHARED: 'form_shared',
  
  // Client management
  CLIENT_ADDED: 'client_added',
  CLIENT_IMPORTED: 'clients_imported',
  CLIENT_PROFILE_VIEWED: 'client_profile_viewed',
  CLIENT_CONNECTED_WEDME: 'client_connected_wedme',
  
  // Journey automation
  JOURNEY_CREATED: 'journey_created',
  JOURNEY_ACTIVATED: 'journey_activated',
  JOURNEY_MODULE_ADDED: 'journey_module_added',
  JOURNEY_TRIGGERED: 'journey_triggered',
  
  // Form responses and engagement
  FORM_SUBMISSION_RECEIVED: 'form_submission_received',
  RESPONSE_VIEWED: 'response_viewed',
  RESPONSE_EXPORTED: 'response_exported',
  
  // Feature adoption
  FEATURE_DISCOVERED: 'feature_discovered',
  FEATURE_FIRST_USE: 'feature_first_use',
  FEATURE_POWER_USER: 'feature_power_user',
  
  // Business outcomes
  LEAD_CONVERTED: 'lead_converted',
  CONTRACT_SIGNED: 'contract_signed',
  PAYMENT_RECEIVED: 'payment_received',
  WEDDING_COMPLETED: 'wedding_completed',
  
  // Support and help
  HELP_ACCESSED: 'help_accessed',
  SUPPORT_CONTACTED: 'support_contacted',
  TUTORIAL_COMPLETED: 'tutorial_completed'
} as const;

export function trackEvent(
  eventName: string,
  properties?: Record<string, any>,
  weddingContext?: {
    weddingDate?: string;
    clientId?: string;
    vendorType?: string;
    urgency?: 'low' | 'medium' | 'high' | 'critical';
  }
) {
  if (typeof window !== 'undefined') {
    const eventProperties = {
      ...properties,
      timestamp: new Date().toISOString(),
      page_url: window.location.href,
      page_title: document.title,
      referrer: document.referrer,
      session_id: getSessionId(),
      
      // Wedding-specific context
      ...(weddingContext && {
        wedding_date: weddingContext.weddingDate,
        client_id: weddingContext.clientId,
        vendor_type: weddingContext.vendorType,
        urgency: weddingContext.urgency,
        days_until_wedding: weddingContext.weddingDate
          ? Math.ceil((new Date(weddingContext.weddingDate).getTime() - Date.now()) / (1000 * 60 * 60 * 24))
          : null,
        is_wedding_season: isWeddingSeason(),
        season_type: getSeasonType()
      })
    };
    
    // Send to PostHog
    posthog.capture(eventName, eventProperties);
    
    // Also store in local database for business analytics
    storeEventLocally(eventName, eventProperties);
  }
}

async function storeEventLocally(eventName: string, properties: Record<string, any>) {
  try {
    await fetch('/api/analytics/track', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        eventName,
        properties,
        sessionId: getSessionId()
      })
    });
  } catch (error) {
    console.error('Failed to store analytics event locally:', error);
  }
}

function getSessionId(): string {
  let sessionId = sessionStorage.getItem('analytics_session_id');
  if (!sessionId) {
    sessionId = crypto.randomUUID();
    sessionStorage.setItem('analytics_session_id', sessionId);
  }
  return sessionId;
}

function isWeddingSeason(): boolean {
  const month = new Date().getMonth() + 1; // 1-12
  return month >= 5 && month <= 10; // May through October
}

function getSeasonType(): string {
  const month = new Date().getMonth() + 1;
  if (month >= 6 && month <= 9) return 'peak'; // June-September
  if (month >= 4 && month <= 5 || month === 10) return 'shoulder'; // April-May, October
  return 'off_peak'; // November-March
}

// Wedding-specific event tracking helpers
export function trackWeddingMilestone(
  milestone: string,
  clientId: string,
  weddingDate: string,
  vendorType: string,
  additionalProperties?: Record<string, any>
) {
  trackEvent('wedding_milestone_reached', {
    milestone,
    client_id: clientId,
    ...additionalProperties
  }, {
    weddingDate,
    clientId,
    vendorType,
    urgency: calculateUrgency(weddingDate)
  });
}

export function trackBusinessOutcome(
  outcome: 'lead_generated' | 'consultation_booked' | 'contract_signed' | 'payment_received',
  value?: number,
  clientId?: string,
  source?: string
) {
  trackEvent('business_outcome', {
    outcome,
    value,
    client_id: clientId,
    source,
    revenue_impact: value || 0
  });
}

function calculateUrgency(weddingDate: string): 'low' | 'medium' | 'high' | 'critical' {
  const days = Math.ceil((new Date(weddingDate).getTime() - Date.now()) / (1000 * 60 * 60 * 24));
  if (days <= 7) return 'critical';
  if (days <= 30) return 'high';
  if (days <= 90) return 'medium';
  return 'low';
}
```

#### Example 2: Analytics Dashboard Component
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, FunnelChart, Funnel, LabelList } from 'recharts';

interface AnalyticsMetrics {
  overview: {
    dau: number;
    wau: number;
    mau: number;
    stickiness: number;
    avgSessionDuration: number;
  };
  growth: {
    signupsThisWeek: number;
    signupsLastWeek: number;
    retentionWeek1: number;
    retentionWeek4: number;
  };
  engagement: {
    topFeatures: Array<{
      feature: string;
      users: number;
      sessions: number;
      avgUsage: number;
    }>;
    funnelConversion: Record<string, number>;
  };
  business: {
    conversionRate: number;
    avgTimeToConversion: number;
    topConversionSources: Array<{
      source: string;
      conversions: number;
      rate: number;
    }>;
  };
}

export function AnalyticsDashboard() {
  const [metrics, setMetrics] = useState<AnalyticsMetrics | null>(null);
  const [loading, setLoading] = useState(true);
  const [timeRange, setTimeRange] = useState<'7d' | '30d' | '90d'>('30d');
  const [platform, setPlatform] = useState<'all' | 'wedsync' | 'wedme'>('all');
  const [userType, setUserType] = useState<'all' | 'supplier' | 'couple'>('all');
  
  useEffect(() => {
    fetchMetrics();
  }, [timeRange, platform, userType]);
  
  const fetchMetrics = async () => {
    setLoading(true);
    try {
      const params = new URLSearchParams({
        timeRange,
        platform,
        userType
      });
      
      const response = await fetch(`/api/analytics/metrics?${params}`);
      const data = await response.json();
      setMetrics(data);
    } catch (error) {
      console.error('Failed to fetch analytics metrics:', error);
    } finally {
      setLoading(false);
    }
  };
  
  const formatNumber = (num: number): string => {
    if (num >= 1000000) return `${(num / 1000000).toFixed(1)}M`;
    if (num >= 1000) return `${(num / 1000).toFixed(1)}K`;
    return num.toString();
  };
  
  const formatPercentage = (num: number): string => {
    return `${(num * 100).toFixed(1)}%`;
  };
  
  const formatDuration = (minutes: number): string => {
    const hours = Math.floor(minutes / 60);
    const mins = Math.round(minutes % 60);
    if (hours > 0) return `${hours}h ${mins}m`;
    return `${mins}m`;
  };
  
  const calculateTrend = (current: number, previous: number): number => {
    if (previous === 0) return 0;
    return ((current - previous) / previous) * 100;
  };
  
  const getTrendColor = (trend: number): string => {
    if (trend > 0) return 'text-green-600';
    if (trend < 0) return 'text-red-600';
    return 'text-gray-600';
  };
  
  if (loading) {
    return (
      <div className="flex items-center justify-center h-96">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
          <p className="mt-2 text-muted-foreground">Loading analytics...</p>
        </div>
      </div>
    );
  }
  
  if (!metrics) {
    return (
      <div className="text-center py-8">
        <p className="text-muted-foreground">Failed to load analytics data</p>
        <Button onClick={fetchMetrics} className="mt-2">
          Retry
        </Button>
      </div>
    );
  }
  
  const signupTrend = calculateTrend(metrics.growth.signupsThisWeek, metrics.growth.signupsLastWeek);
  
  return (
    <div className="space-y-6 p-6">
      {/* Header and Filters */}
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold">User Analytics</h1>
        <div className="flex space-x-2">
          <Select value={timeRange} onValueChange={(value: any) => setTimeRange(value)}>
            <SelectTrigger className="w-32">
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="7d">Last 7 days</SelectItem>
              <SelectItem value="30d">Last 30 days</SelectItem>
              <SelectItem value="90d">Last 90 days</SelectItem>
            </SelectContent>
          </Select>
          
          <Select value={platform} onValueChange={(value: any) => setPlatform(value)}>
            <SelectTrigger className="w-32">
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">All Platforms</SelectItem>
              <SelectItem value="wedsync">WedSync</SelectItem>
              <SelectItem value="wedme">WedMe</SelectItem>
            </SelectContent>
          </Select>
          
          <Select value={userType} onValueChange={(value: any) => setUserType(value)}>
            <SelectTrigger className="w-32">
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">All Users</SelectItem>
              <SelectItem value="supplier">Suppliers</SelectItem>
              <SelectItem value="couple">Couples</SelectItem>
            </SelectContent>
          </Select>
          
          <Button onClick={fetchMetrics} variant="outline">
            Refresh
          </Button>
        </div>
      </div>
      
      {/* Key Metrics Overview */}
      <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium text-muted-foreground">
              Daily Active Users
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{formatNumber(metrics.overview.dau)}</div>
            <p className="text-xs text-muted-foreground">
              {formatPercentage(metrics.overview.stickiness)} stickiness
            </p>
          </CardContent>
        </Card>
        
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium text-muted-foreground">
              Weekly Active Users
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{formatNumber(metrics.overview.wau)}</div>
            <p className="text-xs text-muted-foreground">
              {formatPercentage(metrics.growth.retentionWeek1)} week 1 retention
            </p>
          </CardContent>
        </Card>
        
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium text-muted-foreground">
              Monthly Active Users
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{formatNumber(metrics.overview.mau)}</div>
            <p className="text-xs text-muted-foreground">
              {formatPercentage(metrics.growth.retentionWeek4)} month retention
            </p>
          </CardContent>
        </Card>
        
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium text-muted-foreground">
              Avg Session Duration
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {formatDuration(metrics.overview.avgSessionDuration)}
            </div>
            <p className="text-xs text-muted-foreground">
              Per active session
            </p>
          </CardContent>
        </Card>
        
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium text-muted-foreground">
              New Signups
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{formatNumber(metrics.growth.signupsThisWeek)}</div>
            <p className={`text-xs ${getTrendColor(signupTrend)}`}>
              {signupTrend > 0 ? '↗' : signupTrend < 0 ? '↘' : '→'} {Math.abs(signupTrend).toFixed(1)}% vs last week
            </p>
          </CardContent>
        </Card>
      </div>
      
      {/* Feature Adoption and Business Metrics */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {/* Top Features */}
        <Card>
          <CardHeader>
            <CardTitle>Feature Adoption</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {metrics.engagement.topFeatures.slice(0, 8).map((feature, index) => (
                <div key={feature.feature} className="flex items-center justify-between">
                  <div className="flex items-center space-x-3">
                    <div className="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center text-xs font-medium">
                      {index + 1}
                    </div>
                    <div>
                      <p className="font-medium">{feature.feature}</p>
                      <p className="text-xs text-muted-foreground">
                        {formatNumber(feature.sessions)} sessions
                      </p>
                    </div>
                  </div>
                  <div className="text-right">
                    <p className="font-medium">{formatNumber(feature.users)}</p>
                    <p className="text-xs text-muted-foreground">users</p>
                  </div>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
        
        {/* Business Metrics */}
        <Card>
          <CardHeader>
            <CardTitle>Business Performance</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              <div className="flex items-center justify-between">
                <span className="text-sm text-muted-foreground">Lead Conversion Rate</span>
                <div className="text-right">
                  <span className="font-bold">{formatPercentage(metrics.business.conversionRate)}</span>
                </div>
              </div>
              
              <div className="flex items-center justify-between">
                <span className="text-sm text-muted-foreground">Avg Time to Convert</span>
                <div className="text-right">
                  <span className="font-bold">{metrics.business.avgTimeToConversion} days</span>
                </div>
              </div>
              
              <div className="space-y-2">
                <p className="text-sm font-medium">Top Conversion Sources</p>
                {metrics.business.topConversionSources.slice(0, 5).map((source, index) => (
                  <div key={source.source} className="flex items-center justify-between text-sm">
                    <span className="text-muted-foreground">{source.source}</span>
                    <div className="flex items-center space-x-2">
                      <span>{source.conversions}</span>
                      <Badge variant="outline">
                        {formatPercentage(source.rate)}
                      </Badge>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </CardContent>
        </Card>
      </div>
      
      {/* Conversion Funnel */}
      {Object.keys(metrics.engagement.funnelConversion).length > 0 && (
        <Card>
          <CardHeader>
            <CardTitle>Onboarding Funnel</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="h-80">
              <ResponsiveContainer width="100%" height="100%">
                <FunnelChart data={Object.entries(metrics.engagement.funnelConversion).map(([step, rate]) => ({
                  step,
                  value: rate * 100,
                  fill: rate > 0.8 ? '#10b981' : rate > 0.6 ? '#f59e0b' : '#ef4444'
                }))}>
                  <Tooltip />
                  <Funnel dataKey="value" nameKey="step">
                    <LabelList position="center" fill="#fff" stroke="none" />
                  </Funnel>
                </FunnelChart>
              </ResponsiveContainer>
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [ ] Context7: Load docs for PostHog integration, analytics patterns
- [ ] PostgreSQL: Create analytics tracking tables
- [ ] Filesystem: Create analytics components and services

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/posthog/posthog-js", "analytics tracking", 2000);
await mcp__context7__get-library-docs("/recharts/recharts", "funnel charts", 1500);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('User Analytics Tracking', () => {
  it('should track events with wedding context', () => {
    // Test event tracking with business context
  });
  
  it('should calculate retention cohorts correctly', () => {
    // Test cohort analysis and retention calculations
  });
  
  it('should respect privacy settings and opt-outs', () => {
    // Test privacy compliance and data masking
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Analytics dashboard displays metrics correctly', async () => {
  await mcp__playwright__browser_navigate({url: '/admin/analytics'});
  await mcp__playwright__browser_snapshot();
  // Verify analytics data loads and displays properly
});
```

### ACCEPTANCE CRITERIA
- [ ] All user interactions tracked with wedding business context
- [ ] Privacy-compliant data collection with opt-out mechanisms
- [ ] Real-time analytics dashboard showing key wedding industry KPIs
- [ ] Cohort retention analysis factoring in wedding seasonality
- [ ] Feature adoption tracking with power user identification
- [ ] Performance: Analytics tracking adds less than 50ms to page loads
- [ ] Security: No PII stored in analytics events
- [ ] Accessibility: Analytics dashboard is screen reader accessible

### DEPENDENCIES
- Must complete after: User authentication, privacy compliance framework
- Must complete before: Business intelligence reporting, A/B testing platform
- Shares code with: WS-104 (Performance Monitoring), privacy compliance system

### ESTIMATED EFFORT
- Team A Frontend: 20 hours (analytics dashboard, charts, user tracking components)
- Team B Backend: 18 hours (event processing, cohort analysis, API endpoints, database schema)
- Team C Integration: 8 hours (PostHog integration, privacy compliance, data export)
- Total: 46 hours