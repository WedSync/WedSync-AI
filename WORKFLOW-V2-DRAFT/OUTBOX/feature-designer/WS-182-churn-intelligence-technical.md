# TECHNICAL SPECIFICATION: WS-182 - Churn Intelligence
## Generated by Feature Development Session - August 25, 2025

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** WedSync customer success manager monitoring supplier retention
**I want to:** Predict which wedding suppliers are at risk of canceling their subscriptions and automatically trigger retention campaigns
**So that:** I can proactively prevent churn, reduce revenue loss, and maintain strong relationships with valuable photographers, venues, and other wedding professionals

**Real Wedding Scenario:**
A wedding photographer who joined 8 months ago hasn't logged in for 15 days, has only used 2 features in the last month, and submitted 3 support tickets about integration problems. Without churn prediction, WedSync loses this supplier and their $99/month revenue. With churn intelligence, the system automatically flags them as high-risk, triggers a retention email with a 30% discount, and alerts the customer success team to schedule a personal call.

### SPECIFICATION SOURCE
- **Feature ID:** WS-182
- **Original Spec:** /CORE-SPECIFICATIONS/07-ADMIN-DASHBOARD/02-Revenue-Analytics/03-churn-intelligence md.md
- **Current Implementation:** 0% complete (new)
- **Files to Modify:** None (new feature)
- **New Files to Create:** 
  - `/wedsync/src/components/admin/ChurnDashboard.tsx`
  - `/wedsync/src/lib/analytics/churn-predictor.ts`
  - `/wedsync/src/lib/automation/retention-automation.ts`
  - `/wedsync/src/app/api/admin/churn/route.ts`
  - `/wedsync/supabase/migrations/churn-intelligence-tables.sql`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Churn predictions table
CREATE TABLE churn_predictions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  risk_score INTEGER CHECK (risk_score >= 0 AND risk_score <= 100),
  predicted_churn_date DATE,
  risk_factors JSONB,
  recommended_actions JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  executed_actions JSONB
);

-- Retention campaigns
CREATE TABLE retention_campaigns (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  campaign_type TEXT,
  risk_score INTEGER,
  started_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ,
  outcome TEXT CHECK (outcome IN ('saved', 'churned', 'pending')),
  actions_taken JSONB,
  cost DECIMAL(10, 2)
);

-- Churn reasons tracking
CREATE TABLE churn_reasons (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  reason_category TEXT,
  reason_details TEXT,
  feedback TEXT,
  would_recommend INTEGER CHECK (would_recommend >= 0 AND would_recommend <= 10),
  churned_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### API Endpoints Required
```typescript
// GET /api/admin/churn
interface ChurnRequest {
  timeRange: '30d' | '90d' | '365d';
  riskLevel?: 'critical' | 'high' | 'medium' | 'low';
}

interface ChurnResponse {
  success: boolean;
  data: {
    metrics: ChurnMetrics;
    atRiskUsers: ChurnPrediction[];
    trends: ChurnTrend[];
    campaigns: RetentionCampaign[];
  };
}
```

#### Frontend Components Required
```typescript
// Component: ChurnDashboard
// Location: /src/components/admin/ChurnDashboard.tsx

interface Props {
  timeRange: '30d' | '90d' | '365d';
  autoRefresh: boolean;
}

// Key functionality:
- Real-time churn risk monitoring with color-coded alerts
- At-risk supplier list with automated action recommendations
- Churn reason analysis and trend visualization  
- Retention campaign tracking and ROI metrics
```

#### Integration Points
```typescript
// Service: ChurnPredictor
// Dependencies: User activity tracking, billing service, support system

class ChurnPredictor {
  async predictChurnRisk(userId: string): Promise<ChurnPrediction> {
    // Machine learning-based risk scoring from user behavior signals
  }
  
  private calculateRiskScore(signals: ChurnSignals): number {
    // Weighted scoring algorithm for churn prediction
  }
}
```

### CODE EXAMPLES

#### Example 1: Churn Risk Calculation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { supabase } from '@/lib/supabase';

export async function calculateChurnRisk(userId: string) {
  // Step 1: Collect behavioral signals
  const { data: signals } = await supabase.rpc('collect_churn_signals', {
    user_id: userId,
    lookback_days: 30
  });
    
  // Step 2: Calculate risk score
  if (!signals) throw new Error('Unable to collect user signals');
  
  const riskScore = calculateWeightedRiskScore({
    loginFrequency: signals.days_since_login,
    featureUsage: signals.features_used,
    supportTickets: signals.open_tickets,
    paymentFailures: signals.failed_payments,
    engagementScore: signals.engagement_score
  });
  
  return {
    userId,
    riskScore,
    predictedChurnDate: estimateChurnDate(riskScore),
    recommendedActions: getRetentionActions(riskScore)
  };
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for machine learning libraries, email automation
- [x] PostgreSQL: Execute complex churn analysis queries
- [x] Playwright: Test retention campaign workflows

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/vercel/next.js", "api routes middleware", 3000);
await mcp__context7__get-library-docs("/supabase/supabase", "stored procedures", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('ChurnPredictor', () => {
  it('should calculate accurate risk scores for wedding suppliers', () => {
    // Test risk scoring algorithm with known supplier behavior patterns
  });
  
  it('should recommend appropriate retention actions by risk level', () => {
    // Test retention action selection logic
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Customer success manager can view churn dashboard', async () => {
  await mcp__playwright__browser_navigate({url: '/admin/churn'});
  await mcp__playwright__browser_snapshot();
  // Verify at-risk users display and retention actions available
});
```

### ACCEPTANCE CRITERIA
- [x] Risk scoring algorithm identifies 85%+ of actual churns within 30-day window
- [x] Automated retention campaigns show 15%+ improvement in save rate
- [x] Dashboard displays real-time at-risk supplier alerts by risk level
- [x] Performance: Churn predictions update within 2 seconds for dashboard
- [x] Security: Customer success team access only with audit logging
- [x] Accessibility: Screen reader support for risk alerts and data tables

### DEPENDENCIES
- Must complete after: WS-181 (Cohort Analysis) - requires behavioral analytics foundation
- Must complete before: WS-183 (LTV Calculations) - provides churn data for lifetime value
- Shares code with: Customer success automation workflows

### ESTIMATED EFFORT
- Team A Frontend: 28 hours (Churn dashboard and at-risk user interfaces)
- Team B Backend: 36 hours (Risk prediction engine and automated workflows)
- Team C Integration: 20 hours (Email automation, Slack notifications, billing integration)
- Total: 84 hours