# TECHNICAL SPECIFICATION: WS-016 - Notes Feature
## Generated by Feature Development Session - August 21, 2025

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding photographer managing 40+ weddings per year
**I want to:** Keep private notes about each couple's preferences, family dynamics, and special requests
**So that:** I never forget important details like "grandmother in wheelchair needs special seating for photos" or "bride's parents divorced - keep separate"

**Real Wedding Scenario:**
A photographer currently keeps notes in scattered places - phone, notebook, emails.
They missed that the groom's father passed away recently because the note was in a different system.
With this feature, all sensitive client information stays in one secure place, searchable and never shown to clients.

### SPECIFICATION SOURCE
- **Feature ID:** WS-016
- **Original Spec:** /CORE-SPECIFICATIONS/02-WEDSYNC-SUPPLIER-PLATFORM/03-Client-Management/08-notes-feature.md
- **Current Implementation:** 0% complete
- **Files to Modify:** None (new feature)
- **New Files to Create:** 
  - /wedsync/src/components/notes/NotesPanel.tsx
  - /wedsync/src/components/notes/NoteEditor.tsx
  - /wedsync/src/lib/services/notes-service.ts
  - /wedsync/src/app/api/notes/route.ts
  - /wedsync/supabase/migrations/017_notes_system.sql

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Notes table for storing all client notes
CREATE TABLE IF NOT EXISTS supplier_notes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,
  client_id UUID NOT NULL REFERENCES clients(id) ON DELETE CASCADE,
  author_id UUID NOT NULL REFERENCES team_members(id),
  category TEXT NOT NULL CHECK (category IN ('general', 'important', 'reminder', 'private', 'team')),
  title TEXT,
  content TEXT NOT NULL,
  metadata JSONB DEFAULT '{}',
  tags TEXT[] DEFAULT '{}',
  is_pinned BOOLEAN DEFAULT false,
  is_archived BOOLEAN DEFAULT false,
  reminder_date TIMESTAMPTZ,
  sentiment TEXT CHECK (sentiment IN ('positive', 'neutral', 'concern')),
  related_to_type TEXT CHECK (related_to_type IN ('meeting', 'call', 'email', 'journey_stage')),
  related_to_id UUID,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Note edit history
CREATE TABLE IF NOT EXISTS note_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  note_id UUID NOT NULL REFERENCES supplier_notes(id) ON DELETE CASCADE,
  editor_id UUID NOT NULL REFERENCES team_members(id),
  previous_content TEXT,
  new_content TEXT,
  changed_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes for performance
CREATE INDEX idx_notes_supplier_client ON supplier_notes(supplier_id, client_id);
CREATE INDEX idx_notes_author ON supplier_notes(author_id);
CREATE INDEX idx_notes_reminder ON supplier_notes(reminder_date) WHERE reminder_date IS NOT NULL;
CREATE INDEX idx_notes_search ON supplier_notes USING gin(to_tsvector('english', content));

-- RLS policies
ALTER TABLE supplier_notes ENABLE ROW LEVEL SECURITY;
ALTER TABLE note_history ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Suppliers can manage their own notes" ON supplier_notes
  FOR ALL USING (supplier_id = auth.uid());

CREATE POLICY "Note history visible to note owners" ON note_history
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM supplier_notes 
      WHERE supplier_notes.id = note_history.note_id 
      AND supplier_notes.supplier_id = auth.uid()
    )
  );
```

#### API Endpoints Required
```typescript
// POST /api/notes
interface CreateNoteRequest {
  clientId: string;
  category: 'general' | 'important' | 'reminder' | 'private' | 'team';
  title?: string;
  content: string;
  tags?: string[];
  reminderDate?: string;
  sentiment?: 'positive' | 'neutral' | 'concern';
  relatedToType?: 'meeting' | 'call' | 'email' | 'journey_stage';
  relatedToId?: string;
}

interface NoteResponse {
  success: boolean;
  data: {
    id: string;
    clientId: string;
    category: string;
    title: string | null;
    content: string;
    author: {
      id: string;
      name: string;
    };
    isPinned: boolean;
    createdAt: string;
    updatedAt: string;
  };
}

// GET /api/notes?clientId={clientId}&category={category}
interface GetNotesResponse {
  success: boolean;
  data: NoteResponse[];
  pagination: {
    total: number;
    page: number;
    limit: number;
  };
}

// PUT /api/notes/{noteId}
interface UpdateNoteRequest {
  content?: string;
  title?: string;
  isPinned?: boolean;
  isArchived?: boolean;
  tags?: string[];
}

// DELETE /api/notes/{noteId}
interface DeleteNoteResponse {
  success: boolean;
  message: string;
}
```

#### Frontend Components Required
```typescript
// Component: NotesPanel
// Location: /src/components/notes/NotesPanel.tsx

interface NotesPanelProps {
  clientId: string;
  onNoteAdded?: () => void;
  allowedCategories?: string[];
}

// Key functionality:
- Display all notes for a client
- Filter by category, author, date
- Search notes full-text
- Pin/unpin important notes
- Archive old notes
- Handle reminder notifications

// Component: NoteEditor
// Location: /src/components/notes/NoteEditor.tsx

interface NoteEditorProps {
  note?: Note;
  clientId: string;
  onSave: (note: Note) => void;
  onCancel: () => void;
  mode: 'create' | 'edit';
}

// Key functionality:
- Rich text editing with formatting
- Template selection
- Tag management
- Reminder date picker
- Auto-save drafts
- Sentiment selection
```

#### Integration Points
```typescript
// Service: NotesService
// Dependencies: Supabase, NotificationService

class NotesService {
  async createNote(data: CreateNoteRequest) {
    // Validate user permissions
    // Save to database
    // Schedule reminder if needed
    // Track in audit log
  }

  async searchNotes(query: string, clientId?: string) {
    // Full-text search across notes
    // Filter by permissions
    // Return ranked results
  }

  async processReminders() {
    // Check for due reminders
    // Send notifications
    // Update reminder status
  }
}
```

### CODE EXAMPLES

#### Example 1: Note Creation with Auto-save
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabase';
import { debounce } from '@/lib/utils';

export function NoteEditor({ clientId, onSave }: NoteEditorProps) {
  const [content, setContent] = useState('');
  const [isSaving, setIsSaving] = useState(false);

  // Auto-save draft after 2 seconds of no typing
  const saveDraft = debounce(async (text: string) => {
    if (!text.trim()) return;
    
    setIsSaving(true);
    const { error } = await supabase
      .from('supplier_notes')
      .upsert({
        client_id: clientId,
        content: text,
        category: 'general',
        metadata: { isDraft: true }
      });
    
    if (!error) {
      setIsSaving(false);
    }
  }, 2000);

  useEffect(() => {
    saveDraft(content);
  }, [content]);

  return (
    <div className="relative">
      <textarea
        value={content}
        onChange={(e) => setContent(e.target.value)}
        placeholder="Add a note about this client..."
        className="w-full p-3 border rounded-lg"
      />
      {isSaving && <span className="text-sm text-gray-500">Saving...</span>}
    </div>
  );
}
```

#### Example 2: Note Search Implementation
```typescript
// Backend search with full-text and filters
export async function searchNotes(
  query: string,
  filters: { clientId?: string; category?: string }
) {
  let searchQuery = supabase
    .from('supplier_notes')
    .select(`
      *,
      author:team_members(id, name),
      client:clients(id, name)
    `)
    .eq('is_archived', false);

  // Add full-text search
  if (query) {
    searchQuery = searchQuery.textSearch('content', query);
  }

  // Apply filters
  if (filters.clientId) {
    searchQuery = searchQuery.eq('client_id', filters.clientId);
  }
  if (filters.category) {
    searchQuery = searchQuery.eq('category', filters.category);
  }

  // Sort pinned first, then by date
  searchQuery = searchQuery
    .order('is_pinned', { ascending: false })
    .order('created_at', { ascending: false });

  const { data, error } = await searchQuery;
  
  if (error) throw error;
  return data;
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load Next.js App Router docs
- [x] Filesystem: Access project structure
- [ ] Playwright: Test note creation and search flows

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/vercel/next.js", "app router api routes", 3000);
await mcp__context7__get-library-docs("/supabase/supabase", "row level security", 2000);
await mcp__context7__get-library-docs("/supabase/supabase", "full text search", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('NotesService', () => {
  it('should create a note with proper permissions', async () => {
    const note = await createNote({ 
      clientId: 'test-client',
      content: 'Test note',
      category: 'general'
    });
    expect(note.authorId).toBe(currentUser.id);
  });

  it('should not show private notes to other team members', async () => {
    const privateNote = await createNote({ category: 'private' });
    const notes = await getNotesAsTeamMember(otherUser);
    expect(notes).not.toContainEqual(privateNote);
  });

  it('should trigger reminders at correct time', async () => {
    const reminder = await createNote({ 
      reminderDate: '2025-03-01T10:00:00Z'
    });
    await processReminders();
    expect(notificationService.send).toHaveBeenCalled();
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Create and search notes', async () => {
  await mcp__playwright__browser_navigate({url: '/clients/123/notes'});
  await mcp__playwright__browser_type({
    element: 'Note editor textarea',
    ref: 'textarea[placeholder*="Add a note"]',
    text: 'Bride prefers roses over peonies'
  });
  await mcp__playwright__browser_click({
    element: 'Save note button',
    ref: 'button:has-text("Save")'
  });
  await mcp__playwright__browser_type({
    element: 'Search notes input',
    ref: 'input[placeholder*="Search notes"]',
    text: 'roses'
  });
  await mcp__playwright__browser_snapshot();
  // Verify note appears in search results
});
```

### ACCEPTANCE CRITERIA
- [x] Notes are NEVER visible to clients
- [x] Private notes only visible to creator
- [x] Team notes visible to all team members
- [x] Full-text search works across all notes
- [x] Reminders trigger notifications on time
- [x] Notes auto-save as drafts
- [x] Pinned notes stay at top
- [x] Edit history tracked for audit
- [x] Performance: Search returns in <200ms
- [x] Security: RLS policies prevent unauthorized access
- [x] Accessibility: WCAG 2.1 AA compliant

### DEPENDENCIES
- Must complete after: WS-002 (Client Profiles)
- Must complete before: None
- Shares code with: WS-027 (Message History - similar UI patterns)

### ESTIMATED EFFORT
- Team A Frontend: 16 hours
- Team B Backend: 12 hours
- Team C Integration: 4 hours (notification system)
- Total: 32 hours