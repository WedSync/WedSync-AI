# TECHNICAL SPECIFICATION: WS-307 - Field Types Overview
## Generated by Feature Development Session - 2025-01-20

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding venue coordinator creating intake forms
**I want to:** Access 25+ specialized field types designed for wedding data (guest counts, dietary requirements, timeline slots, venue layouts)
**So that:** I can collect wedding-specific information accurately instead of using generic text fields that require couples to interpret what format to use

**Real Wedding Scenario:**
"A wedding venue currently asks couples 'How many guests?' in a text field and receives answers like '150ish', '140 adults + kids', or '130-160 depending on final RSVPs'. With wedding-specific field types, a guest count matrix field collects adults/children/infants separately with validation against venue capacity, ensuring accurate headcounts for catering and seating."

### SPECIFICATION SOURCE
- **Feature ID:** WS-307
- **Original Spec:** /CORE-SPECIFICATIONS/02-WEDSYNC-SUPPLIER-PLATFORM/04-Forms-System/03-field-types.md
- **Current Implementation:** 25% complete (basic field types exist)
- **Files to Modify:**
  - /wedsync/src/lib/validations/forms.ts
  - /wedsync/src/components/forms/FormBuilder.tsx
- **New Files to Create:**
  - /wedsync/src/components/forms/field-types/BasicFields.tsx
  - /wedsync/src/components/forms/field-types/WeddingFields.tsx
  - /wedsync/src/lib/form-field-registry.ts
  - /wedsync/src/types/form-fields.ts

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Form field definitions table
CREATE TABLE IF NOT EXISTS form_field_definitions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  field_type VARCHAR(50) NOT NULL,
  display_name VARCHAR(100) NOT NULL,
  description TEXT,
  category VARCHAR(50) NOT NULL,
  is_wedding_specific BOOLEAN DEFAULT FALSE,
  validation_schema JSONB DEFAULT '{}',
  default_config JSONB DEFAULT '{}',
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Insert core field types
INSERT INTO form_field_definitions (field_type, display_name, description, category, is_wedding_specific, validation_schema, default_config) VALUES
('text', 'Text Input', 'Single line text field', 'basic', false, '{"maxLength": 255}', '{"placeholder": ""}'),
('email', 'Email Address', 'Email with validation', 'basic', false, '{"format": "email"}', '{"placeholder": "email@example.com"}'),
('phone', 'Phone Number', 'International phone number', 'basic', false, '{"format": "phone"}', '{"countryCode": "US"}'),
('guest_count_matrix', 'Guest Count Matrix', 'Adults, children, infants breakdown', 'wedding', true, '{"maxTotal": 500}', '{"showInfants": true, "showChildren": true}'),
('wedding_date', 'Wedding Date', 'Date picker with venue availability', 'wedding', true, '{"minDate": "today"}', '{"showAvailability": true}'),
('venue_selector', 'Venue Selector', 'Venue with Google Places integration', 'wedding', true, '{}', '{"allowMultiple": true}'),
('dietary_matrix', 'Dietary Requirements', 'Structured dietary needs collector', 'wedding', true, '{}', '{"includeAllergies": true}'),
('timeline_builder', 'Wedding Timeline', 'Hour-by-hour schedule builder', 'wedding', true, '{}', '{"startTime": "08:00", "endTime": "24:00"}');
```

#### API Endpoints Required
```typescript
// GET /api/forms/field-types
interface FieldTypeResponse {
  categories: FieldTypeCategory[];
}

interface FieldTypeCategory {
  name: string;
  label: string;
  fields: FieldTypeDefinition[];
}

interface FieldTypeDefinition {
  type: string;
  display_name: string;
  description: string;
  is_wedding_specific: boolean;
  validation_schema: Record<string, any>;
  default_config: Record<string, any>;
  preview_component: string;
}

// POST /api/forms/validate-field
interface ValidateFieldRequest {
  field_type: string;
  value: any;
  config: Record<string, any>;
}

interface ValidateFieldResponse {
  is_valid: boolean;
  errors: string[];
  formatted_value?: any;
}
```

#### Frontend Components Required
```typescript
// Component: FieldTypeRegistry
// Location: /src/lib/form-field-registry.ts

interface FieldTypeComponent {
  component: React.ComponentType<FieldProps>;
  validator: (value: any, config: any) => ValidationResult;
  defaultConfig: Record<string, any>;
}

class FieldTypeRegistry {
  private static registry = new Map<string, FieldTypeComponent>();
  
  static register(type: string, component: FieldTypeComponent) {
    this.registry.set(type, component);
  }
  
  static get(type: string): FieldTypeComponent | undefined {
    return this.registry.get(type);
  }
  
  static getCategories(): FieldTypeCategory[] {
    // Return organized field types by category
  }
}

// Component: WeddingSpecificFields
// Location: /src/components/forms/field-types/WeddingFields.tsx

interface GuestCountMatrixProps extends FieldProps {
  config: {
    showInfants: boolean;
    showChildren: boolean;
    maxTotal: number;
    venueCapacity?: number;
  };
}

const GuestCountMatrix: React.FC<GuestCountMatrixProps> = ({ value, onChange, config }) => {
  // Component for structured guest counting
  // Adults, children, infants with +/- buttons
  // Validation against venue capacity
  // Visual progress bar for capacity
};
```

#### Integration Points
```typescript
// Service: FieldTypeService
// Dependencies: ValidationService, ConfigurationService

class FieldTypeService {
  async getAvailableFieldTypes(): Promise<FieldTypeDefinition[]> {
    // Load all available field types with configurations
  }
  
  async validateFieldValue(fieldType: string, value: any, config: any): Promise<ValidationResult> {
    // Validate field value against type-specific rules
  }
  
  async renderFieldPreview(fieldType: string, config: any): Promise<string> {
    // Generate preview HTML for form builder
  }
  
  async getWeddingFieldSuggestions(vendorType: string): Promise<string[]> {
    // Return recommended field types based on vendor type
  }
}
```

### CODE EXAMPLES

#### Example 1: Wedding-Specific Field Implementation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import React, { useState } from 'react';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Alert, AlertDescription } from '@/components/ui/alert';

interface GuestCountValue {
  adults: number;
  children: number;
  infants: number;
}

interface GuestCountMatrixProps {
  value: GuestCountValue;
  onChange: (value: GuestCountValue) => void;
  config: {
    showChildren: boolean;
    showInfants: boolean;
    maxTotal: number;
    venueCapacity?: number;
  };
  error?: string;
}

export const GuestCountMatrix: React.FC<GuestCountMatrixProps> = ({
  value,
  onChange,
  config,
  error
}) => {
  const [localValue, setLocalValue] = useState(value || { adults: 0, children: 0, infants: 0 });
  
  const totalGuests = localValue.adults + localValue.children + localValue.infants;
  const isOverCapacity = config.venueCapacity && totalGuests > config.venueCapacity;
  
  const updateCount = (type: keyof GuestCountValue, delta: number) => {
    const newValue = { ...localValue };
    const newCount = Math.max(0, newValue[type] + delta);
    
    if (newCount + (totalGuests - newValue[type]) <= config.maxTotal) {
      newValue[type] = newCount;
      setLocalValue(newValue);
      onChange(newValue);
    }
  };
  
  return (
    <div className="space-y-4">
      {/* Adults Counter */}
      <div className="flex items-center justify-between p-3 border rounded">
        <div>
          <label className="font-medium">Adults (13+)</label>
          <p className="text-sm text-gray-500">Full meals required</p>
        </div>
        <div className="flex items-center space-x-2">
          <Button
            type="button"
            variant="outline"
            size="sm"
            onClick={() => updateCount('adults', -1)}
            disabled={localValue.adults === 0}
          >
            -
          </Button>
          <span className="w-12 text-center font-medium">{localValue.adults}</span>
          <Button
            type="button"
            variant="outline"
            size="sm"
            onClick={() => updateCount('adults', 1)}
          >
            +
          </Button>
        </div>
      </div>
      
      {/* Children Counter (if enabled) */}
      {config.showChildren && (
        <div className="flex items-center justify-between p-3 border rounded">
          <div>
            <label className="font-medium">Children (2-12)</label>
            <p className="text-sm text-gray-500">Kids meals available</p>
          </div>
          <div className="flex items-center space-x-2">
            <Button
              type="button"
              variant="outline"
              size="sm"
              onClick={() => updateCount('children', -1)}
              disabled={localValue.children === 0}
            >
              -
            </Button>
            <span className="w-12 text-center font-medium">{localValue.children}</span>
            <Button
              type="button"
              variant="outline"
              size="sm"
              onClick={() => updateCount('children', 1)}
            >
              +
            </Button>
          </div>
        </div>
      )}
      
      {/* Infants Counter (if enabled) */}
      {config.showInfants && (
        <div className="flex items-center justify-between p-3 border rounded">
          <div>
            <label className="font-medium">Infants (0-2)</label>
            <p className="text-sm text-gray-500">No meal required</p>
          </div>
          <div className="flex items-center space-x-2">
            <Button
              type="button"
              variant="outline"
              size="sm"
              onClick={() => updateCount('infants', -1)}
              disabled={localValue.infants === 0}
            >
              -
            </Button>
            <span className="w-12 text-center font-medium">{localValue.infants}</span>
            <Button
              type="button"
              variant="outline"
              size="sm"
              onClick={() => updateCount('infants', 1)}
            >
              +
            </Button>
          </div>
        </div>
      )}
      
      {/* Total Display */}
      <div className="p-3 bg-gray-50 rounded">
        <div className="flex justify-between items-center">
          <span className="font-medium">Total Guests</span>
          <span className="text-lg font-bold">{totalGuests}</span>
        </div>
        {config.venueCapacity && (
          <div className="mt-2">
            <div className="w-full bg-gray-200 rounded-full h-2">
              <div
                className={`h-2 rounded-full ${
                  isOverCapacity ? 'bg-red-500' : 'bg-green-500'
                }`}
                style={{
                  width: `${Math.min(100, (totalGuests / config.venueCapacity) * 100)}%`
                }}
              />
            </div>
            <p className="text-sm text-gray-500 mt-1">
              {totalGuests} / {config.venueCapacity} venue capacity
            </p>
          </div>
        )}
      </div>
      
      {/* Validation Errors */}
      {(error || isOverCapacity) && (
        <Alert variant="destructive">
          <AlertDescription>
            {error || `Guest count exceeds venue capacity of ${config.venueCapacity}`}
          </AlertDescription>
        </Alert>
      )}
    </div>
  );
};
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for React form libraries, validation patterns
- [ ] Playwright: Test complex field interactions
- [ ] Filesystem: Access field component templates

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/react-hook-form/react-hook-form", "custom field components", 2000);
await mcp__context7__get-library-docs("/colinhacks/zod", "validation schemas", 1500);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('GuestCountMatrix', () => {
  it('should increment and decrement guest counts correctly', () => {
    const mockOnChange = jest.fn();
    const { getByText } = render(
      <GuestCountMatrix
        value={{ adults: 0, children: 0, infants: 0 }}
        onChange={mockOnChange}
        config={{ showChildren: true, showInfants: true, maxTotal: 200 }}
      />
    );
    
    // Test adult increment
    fireEvent.click(getByText('+'));
    expect(mockOnChange).toHaveBeenCalledWith({ adults: 1, children: 0, infants: 0 });
  });
  
  it('should enforce venue capacity limits', () => {
    const mockOnChange = jest.fn();
    const { getByText } = render(
      <GuestCountMatrix
        value={{ adults: 100, children: 0, infants: 0 }}
        onChange={mockOnChange}
        config={{ showChildren: true, showInfants: true, maxTotal: 200, venueCapacity: 100 }}
      />
    );
    
    // Should show capacity warning
    expect(getByText(/venue capacity/)).toBeInTheDocument();
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Wedding field types in form builder', async () => {
  await mcp__playwright__browser_navigate({url: '/forms/builder'});
  
  // Test dragging wedding-specific field
  await mcp__playwright__browser_drag({
    startElement: "Guest count matrix field",
    startRef: "[data-field-type='guest_count_matrix']",
    endElement: "Form canvas",
    endRef: "[data-testid='form-canvas']"
  });
  
  // Configure field settings
  await mcp__playwright__browser_click({
    element: "Field settings",
    ref: "[data-testid='field-settings']"
  });
  
  await mcp__playwright__browser_snapshot();
});
```

### ACCEPTANCE CRITERIA
- [ ] 25+ field types available including 8+ wedding-specific types
- [ ] Guest count matrix validates against venue capacity
- [ ] Wedding date picker shows venue availability
- [ ] Dietary matrix collects structured allergy/preference data
- [ ] Timeline builder prevents scheduling conflicts
- [ ] Performance: Complex fields (timeline, matrices) load in under 1 second
- [ ] Security: All field values validated server-side
- [ ] Accessibility: All custom fields support screen readers and keyboard navigation

### DEPENDENCIES
- Must complete after: WS-306 (Forms System foundation)
- Must complete before: WS-308 (Customer Journey integration)
- Shares code with: Form validation, field configuration, PDF import mapping

### ESTIMATED EFFORT
- Team A Frontend: 32 hours
- Team B Backend: 8 hours
- Team C Integration: 4 hours
- Team D Platform: 6 hours
- Team E General: 4 hours
- Team F Workflows: 0 hours
- Team G Performance: 6 hours
- Total: 60 hours