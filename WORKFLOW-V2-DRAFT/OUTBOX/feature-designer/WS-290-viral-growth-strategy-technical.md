# TECHNICAL SPECIFICATION: WS-290 - Viral Growth Strategy
## Generated by Feature Development Session - 2025-08-25

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Growth Marketing Manager / Product Manager / Analytics Team Member
**I want to:** Implement a comprehensive viral growth system with invitation triggers, incentive mechanics, and viral coefficient tracking
**So that:** We achieve sustainable growth through user-driven referrals and reach our target K-factor of >1.5

**Real Wedding Scenario:**
"A photographer joins WedSync and imports 20 existing couples. The system triggers invitation prompts after they create their first form, suggesting they 'invite couples to collaborate for seamless planning.' When couples join and experience instant value (no repeat data entry), they naturally invite their other vendors. This creates a viral loop where each supplier brings 3-4 couples, and each couple brings 8-12 new suppliers to the platform."

### SPECIFICATION SOURCE
- **Feature ID:** WS-290
- **Original Spec:** /CORE-SPECIFICATIONS/00-PROJECT-OVERVIEW/05-viral-growth-strategy.md
- **Current Implementation:** 0% complete (new viral system)
- **Files to Modify:**
  - /src/lib/analytics/viral-tracking.ts
  - /src/components/invitations/InvitationPrompts.tsx
- **New Files to Create:**
  - /src/lib/viral/invitation-engine.ts
  - /src/lib/viral/incentive-system.ts
  - /src/lib/viral/viral-analytics.ts
  - /src/components/viral/InvitationTriggers.tsx
  - /src/components/viral/ReferralDashboard.tsx

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Viral Growth Tracking Tables
CREATE TABLE IF NOT EXISTS viral_invitations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  inviter_id UUID NOT NULL, -- User who sent invitation
  inviter_type VARCHAR(20) NOT NULL, -- 'supplier' or 'couple'
  invitee_email VARCHAR(255) NOT NULL,
  invitee_type VARCHAR(20) NOT NULL, -- Expected type: 'supplier' or 'couple'
  invitation_trigger VARCHAR(50) NOT NULL, -- What triggered the invitation
  template_used VARCHAR(50),
  
  -- Tracking
  sent_at TIMESTAMP DEFAULT NOW(),
  opened_at TIMESTAMP,
  clicked_at TIMESTAMP,
  converted_at TIMESTAMP,
  converted_user_id UUID,
  
  -- Context
  wedding_id UUID, -- If related to specific wedding
  referral_code VARCHAR(20) UNIQUE,
  incentive_offered JSONB,
  
  -- Metrics
  conversion_value DECIMAL DEFAULT 0,
  ltv_impact DECIMAL DEFAULT 0,
  
  CONSTRAINT fk_inviter FOREIGN KEY (inviter_id) 
    REFERENCES users(id) ON DELETE CASCADE,
  CONSTRAINT fk_converted_user FOREIGN KEY (converted_user_id) 
    REFERENCES users(id) ON DELETE SET NULL
);

-- Viral Coefficient Tracking
CREATE TABLE IF NOT EXISTS viral_metrics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  period_start DATE NOT NULL,
  period_end DATE NOT NULL,
  
  -- Invitations
  invitations_sent INTEGER DEFAULT 0,
  invitations_opened INTEGER DEFAULT 0,
  invitations_clicked INTEGER DEFAULT 0,
  invitations_converted INTEGER DEFAULT 0,
  
  -- Rates
  open_rate DECIMAL DEFAULT 0,
  click_rate DECIMAL DEFAULT 0,
  conversion_rate DECIMAL DEFAULT 0,
  
  -- Viral Coefficient
  k_factor DECIMAL DEFAULT 0, -- Calculated: (invites_per_user * conversion_rate)
  doubling_time_days INTEGER,
  
  -- Segmented metrics
  supplier_k_factor DECIMAL DEFAULT 0,
  couple_k_factor DECIMAL DEFAULT 0,
  
  created_at TIMESTAMP DEFAULT NOW(),
  
  UNIQUE(period_start, period_end)
);

-- Incentive Tracking
CREATE TABLE IF NOT EXISTS viral_incentives (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL,
  user_type VARCHAR(20) NOT NULL,
  
  -- Incentive details
  incentive_type VARCHAR(50) NOT NULL, -- 'tier1', 'tier2', 'tier3', 'discount', etc.
  threshold_value INTEGER NOT NULL, -- Number of referrals needed
  current_progress INTEGER DEFAULT 0,
  reward_description TEXT,
  reward_value DECIMAL,
  
  -- Status
  status VARCHAR(20) DEFAULT 'active', -- 'active', 'completed', 'expired'
  earned_at TIMESTAMP,
  redeemed_at TIMESTAMP,
  
  -- Tracking
  created_at TIMESTAMP DEFAULT NOW(),
  expires_at TIMESTAMP,
  
  CONSTRAINT fk_incentive_user FOREIGN KEY (user_id) 
    REFERENCES users(id) ON DELETE CASCADE
);

-- Viral Triggers Configuration
CREATE TABLE IF NOT EXISTS viral_triggers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  trigger_name VARCHAR(50) UNIQUE NOT NULL,
  user_type VARCHAR(20) NOT NULL, -- 'supplier' or 'couple'
  
  -- Trigger conditions
  event_type VARCHAR(50) NOT NULL, -- 'contract_signed', 'form_created', etc.
  delay_minutes INTEGER DEFAULT 0,
  conditions JSONB, -- Additional conditions
  
  -- Template
  template_subject VARCHAR(200),
  template_body TEXT,
  call_to_action VARCHAR(100),
  
  -- Configuration
  active BOOLEAN DEFAULT true,
  priority INTEGER DEFAULT 1, -- Higher = more important
  max_triggers_per_user INTEGER DEFAULT 100,
  
  -- A/B Testing
  variant_name VARCHAR(50),
  traffic_percentage DECIMAL DEFAULT 100,
  
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### API Endpoints Required
```typescript
// Viral Growth API
interface ViralGrowthAPI {
  // GET /api/v1/viral/metrics
  getViralMetrics(period: 'day' | 'week' | 'month'): Promise<ViralMetrics>;
  
  // POST /api/v1/viral/invite
  sendInvitation(request: InvitationRequest): Promise<InvitationResponse>;
  
  // GET /api/v1/viral/incentives/:userId
  getUserIncentives(userId: string): Promise<IncentiveStatus[]>;
  
  // POST /api/v1/viral/track-trigger
  trackViralTrigger(trigger: ViralTriggerEvent): Promise<void>;
  
  // GET /api/v1/viral/leaderboard
  getViralLeaderboard(category?: string): Promise<LeaderboardEntry[]>;
}

interface ViralMetrics {
  k_factor: number;
  invitations_sent: number;
  invitation_open_rate: number;
  invitation_click_rate: number;
  invitation_conversion_rate: number;
  time_to_first_invite_avg: number;
  time_to_activation_avg: number;
  doubling_time_days: number;
  
  segments: {
    suppliers: {
      k_factor: number;
      avg_invites_per_user: number;
      conversion_rate: number;
    };
    couples: {
      k_factor: number;
      avg_invites_per_user: number;
      conversion_rate: number;
    };
  };
}

interface InvitationRequest {
  invitee_emails: string[];
  invitee_type: 'supplier' | 'couple';
  trigger_context: string;
  template_override?: string;
  incentive_offered?: IncentiveOffer;
  wedding_id?: string;
}

interface IncentiveStatus {
  type: string;
  description: string;
  threshold: number;
  current_progress: number;
  percentage_complete: number;
  reward_value: number;
  status: 'active' | 'completed' | 'expired';
  expires_at?: string;
}
```

#### Frontend Components Required
```typescript
// Component: ViralInvitationTrigger
// Location: /src/components/viral/ViralInvitationTrigger.tsx

interface Props {
  userId: string;
  userType: 'supplier' | 'couple';
  triggerContext: string;
  weddingId?: string;
  onInvitationSent?: (count: number) => void;
}

// Key functionality:
- Smart invitation prompts based on user actions
- One-click invitation sending
- Progress tracking towards incentives
- Social proof integration
- Urgency triggers

// Component: ReferralDashboard
// Location: /src/components/viral/ReferralDashboard.tsx

interface Props {
  userId: string;
  showLeaderboard?: boolean;
  showIncentives?: boolean;
}

// Key functionality:
- Visual progress towards referral rewards
- Invitation history and status
- Referral performance metrics
- Gamification elements (badges, levels)
- Social sharing tools
```

#### Integration Points
```typescript
// Service: ViralInvitationEngine
// Dependencies: Email service, template engine, analytics

class ViralInvitationEngine {
  async sendInvitation(request: InvitationRequest): Promise<InvitationResponse> {
    // Generate unique referral code
    const referralCode = await this.generateReferralCode();
    
    // Select optimal template
    const template = await this.selectTemplate(
      request.invitee_type,
      request.trigger_context
    );
    
    // Personalize invitation content
    const content = await this.personalizeContent(template, request);
    
    // Track invitation
    await this.trackInvitation({
      ...request,
      referral_code: referralCode,
      template_used: template.id
    });
    
    // Send emails
    const results = await this.emailService.sendBulk(content);
    
    return {
      referral_code: referralCode,
      invitations_sent: results.length,
      estimated_conversions: results.length * template.avg_conversion_rate
    };
  }
  
  async triggerViralPrompt(userId: string, eventType: string, context: any) {
    // Check if trigger should fire
    const triggers = await this.getApplicableTriggers(userId, eventType);
    
    for (const trigger of triggers) {
      if (await this.shouldTrigger(trigger, userId, context)) {
        await this.showInvitationPrompt({
          userId,
          trigger: trigger.name,
          template: trigger.template,
          context
        });
      }
    }
  }
}

// Service: ViralIncentiveSystem
// Dependencies: User management, billing system

class ViralIncentiveSystem {
  async updateUserProgress(userId: string, event: 'invitation_sent' | 'referral_converted') {
    const incentives = await this.getUserActiveIncentives(userId);
    
    for (const incentive of incentives) {
      const newProgress = await this.calculateProgress(incentive, event);
      
      if (newProgress >= incentive.threshold && incentive.status === 'active') {
        await this.completeIncentive(incentive);
        await this.notifyUserReward(userId, incentive);
      }
      
      await this.updateIncentiveProgress(incentive.id, newProgress);
    }
  }
  
  async completeIncentive(incentive: IncentiveRecord) {
    switch (incentive.incentive_type) {
      case 'tier1':
        await this.billingService.creditAccount(incentive.user_id, 'one_month_free');
        break;
      case 'tier2':
        await this.billingService.upgradeUser(incentive.user_id, 'professional');
        break;
      case 'tier3':
        await this.billingService.applyLifetimeDiscount(incentive.user_id, 0.25);
        break;
    }
    
    await this.updateIncentiveStatus(incentive.id, 'completed');
  }
}

// Service: ViralAnalytics
// Dependencies: Analytics service, database

class ViralAnalytics {
  async calculateViralCoefficient(period: DateRange): Promise<ViralCoefficient> {
    const invitations = await this.getInvitationMetrics(period);
    const conversions = await this.getConversionMetrics(period);
    
    const invitesPerUser = invitations.total / invitations.unique_senders;
    const conversionRate = conversions.total / invitations.total;
    const kFactor = invitesPerUser * conversionRate;
    
    return {
      k_factor: kFactor,
      invites_per_user: invitesPerUser,
      conversion_rate: conversionRate,
      doubling_time_days: Math.log(2) / Math.log(1 + kFactor),
      period_start: period.start,
      period_end: period.end
    };
  }
  
  async trackViralEvent(event: ViralEvent) {
    // Track individual viral events
    await this.database.insert('viral_events', {
      user_id: event.userId,
      event_type: event.type,
      event_data: event.data,
      timestamp: new Date()
    });
    
    // Update aggregated metrics
    await this.updateDailyMetrics(event);
    
    // Check for milestone achievements
    await this.checkMilestones(event.userId);
  }
}
```

### CODE EXAMPLES

#### Example 1: Smart Invitation Triggers
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { useEffect, useState } from 'react';
import { ViralInvitationEngine } from '@/lib/viral/invitation-engine';

interface InvitationTriggerProps {
  userId: string;
  userType: 'supplier' | 'couple';
}

export function useViralTriggers({ userId, userType }: InvitationTriggerProps) {
  const [activePrompts, setActivePrompts] = useState([]);
  const invitationEngine = new ViralInvitationEngine();
  
  useEffect(() => {
    // Listen for viral trigger events
    const handleUserEvent = async (event: UserEvent) => {
      const triggers = await invitationEngine.getTriggersForEvent(
        event.type,
        userId,
        userType
      );
      
      for (const trigger of triggers) {
        if (trigger.shouldShow) {
          setActivePrompts(prev => [...prev, {
            id: trigger.id,
            message: trigger.message,
            cta: trigger.callToAction,
            urgency: trigger.urgency,
            incentive: trigger.incentive
          }]);
        }
      }
    };
    
    // Example triggers for suppliers
    if (userType === 'supplier') {
      window.addEventListener('contract_signed', handleUserEvent);
      window.addEventListener('form_created', handleUserEvent);
      window.addEventListener('client_imported', handleUserEvent);
    }
    
    // Example triggers for couples
    if (userType === 'couple') {
      window.addEventListener('venue_added', handleUserEvent);
      window.addEventListener('vendor_mentioned', handleUserEvent);
      window.addEventListener('timeline_created', handleUserEvent);
    }
    
    return () => {
      window.removeEventListener('contract_signed', handleUserEvent);
      // ... other cleanup
    };
  }, [userId, userType]);
  
  const sendInvitations = async (emails: string[], context: string) => {
    const result = await invitationEngine.sendInvitation({
      invitee_emails: emails,
      invitee_type: userType === 'supplier' ? 'couple' : 'supplier',
      trigger_context: context
    });
    
    // Remove prompt after successful send
    setActivePrompts(prev => prev.filter(p => p.id !== context));
    
    // Track success
    await invitationEngine.trackViralEvent({
      userId,
      type: 'invitations_sent',
      data: { count: emails.length, context }
    });
    
    return result;
  };
  
  return { activePrompts, sendInvitations };
}
```

#### Example 2: Viral Analytics Dashboard
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import React, { useEffect, useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';

interface ViralDashboardProps {
  timeframe: 'week' | 'month' | 'quarter';
}

export function ViralAnalyticsDashboard({ timeframe }: ViralDashboardProps) {
  const [metrics, setMetrics] = useState<ViralMetrics | null>(null);
  const [loading, setLoading] = useState(true);
  
  useEffect(() => {
    loadViralMetrics();
  }, [timeframe]);
  
  const loadViralMetrics = async () => {
    setLoading(true);
    try {
      const response = await fetch(`/api/v1/viral/metrics?period=${timeframe}`);
      const data = await response.json();
      setMetrics(data);
    } catch (error) {
      console.error('Failed to load viral metrics:', error);
    } finally {
      setLoading(false);
    }
  };
  
  if (loading) return <div>Loading viral metrics...</div>;
  if (!metrics) return <div>Failed to load metrics</div>;
  
  const kFactorStatus = metrics.k_factor >= 1.5 ? 'success' : 
                      metrics.k_factor >= 1.0 ? 'warning' : 'danger';
  
  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <Card>
        <CardHeader>
          <CardTitle>Viral Coefficient (K-Factor)</CardTitle>
        </CardHeader>
        <CardContent>
          <div className={`text-3xl font-bold ${
            kFactorStatus === 'success' ? 'text-green-600' :
            kFactorStatus === 'warning' ? 'text-yellow-600' : 'text-red-600'
          }`}>
            {metrics.k_factor.toFixed(2)}
          </div>
          <div className="text-sm text-muted-foreground">
            Target: >1.5 (viral growth)
          </div>
          <Progress 
            value={Math.min((metrics.k_factor / 1.5) * 100, 100)} 
            className="mt-2" 
          />
        </CardContent>
      </Card>
      
      <Card>
        <CardHeader>
          <CardTitle>Invitation Performance</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-2">
            <div className="flex justify-between">
              <span className="text-sm">Sent</span>
              <span className="text-sm font-medium">{metrics.invitations_sent}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-sm">Open Rate</span>
              <span className="text-sm font-medium">
                {(metrics.invitation_open_rate * 100).toFixed(1)}%
              </span>
            </div>
            <div className="flex justify-between">
              <span className="text-sm">Click Rate</span>
              <span className="text-sm font-medium">
                {(metrics.invitation_click_rate * 100).toFixed(1)}%
              </span>
            </div>
            <div className="flex justify-between">
              <span className="text-sm">Conversion</span>
              <span className="text-sm font-medium">
                {(metrics.invitation_conversion_rate * 100).toFixed(1)}%
              </span>
            </div>
          </div>
        </CardContent>
      </Card>
      
      <Card>
        <CardHeader>
          <CardTitle>Growth Velocity</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="text-2xl font-bold">
            {metrics.doubling_time_days} days
          </div>
          <div className="text-sm text-muted-foreground">
            Time to double user base
          </div>
          <div className="mt-4">
            <div className="text-sm">
              Suppliers K-factor: {metrics.segments.suppliers.k_factor.toFixed(2)}
            </div>
            <div className="text-sm">
              Couples K-factor: {metrics.segments.couples.k_factor.toFixed(2)}
            </div>
          </div>
        </CardContent>
      </Card>
      
      <Card>
        <CardHeader>
          <CardTitle>Activation Metrics</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-3">
            <div>
              <div className="text-sm font-medium">Time to First Invite</div>
              <div className="text-xl">
                {Math.round(metrics.time_to_first_invite_avg / 60)} min
              </div>
              <div className="text-sm text-muted-foreground">Target: <3 days</div>
            </div>
            <div>
              <div className="text-sm font-medium">Time to Activation</div>
              <div className="text-xl">
                {Math.round(metrics.time_to_activation_avg / 60)} min
              </div>
              <div className="text-sm text-muted-foreground">Target: <10 min</div>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [ ] Context7: Load docs for analytics, email services
- [ ] Supabase: Real-time viral metrics tracking
- [ ] Playwright: Test viral flows end-to-end

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/resend/resend-node", "email templates", 2000);
await mcp__context7__get-library-docs("/vercel/analytics", "event tracking", 1500);
await mcp__context7__get-library-docs("/supabase/supabase", "realtime subscriptions", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('Viral Growth System', () => {
  it('should calculate K-factor correctly', () => {
    const analytics = new ViralAnalytics();
    // Test viral coefficient calculations
  });
  
  it('should trigger invitations at right moments', () => {
    const engine = new ViralInvitationEngine();
    // Test invitation trigger logic
  });
  
  it('should track incentive progress accurately', () => {
    const incentives = new ViralIncentiveSystem();
    // Test referral reward tracking
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Complete viral loop works end-to-end', async () => {
  // Supplier joins
  await mcp__playwright__browser_navigate({url: '/signup/supplier'});
  await mcp__playwright__browser_fill_form({
    fields: [
      {name: 'email', type: 'textbox', ref: 'input[name="email"]', value: 'supplier@test.com'},
      {name: 'business_name', type: 'textbox', ref: 'input[name="business_name"]', value: 'Test Photography'}
    ]
  });
  
  // Trigger invitation prompt
  await mcp__playwright__browser_click({
    element: 'create form button',
    ref: 'button[data-testid="create-form"]'
  });
  
  // Verify invitation prompt appears
  await mcp__playwright__browser_snapshot();
  
  // Send invitation
  await mcp__playwright__browser_type({
    element: 'invitation email input',
    ref: 'input[name="invitee_email"]',
    text: 'couple@test.com'
  });
  
  // Test complete viral flow
});
```

### ACCEPTANCE CRITERIA
- [ ] Viral coefficient tracking system implemented with K-factor >1.5 target
- [ ] Smart invitation triggers fire at optimal moments (contract signed, form created, etc.)
- [ ] Incentive system tracks progress and awards referral rewards
- [ ] Social proof integration increases conversion rates
- [ ] A/B testing framework optimizes invitation templates
- [ ] Geographic concentration strategy supported for rollout
- [ ] Viral analytics dashboard shows real-time metrics
- [ ] Anti-gaming measures prevent fake referrals
- [ ] Performance targets met (60% open rate, 25% click rate, 15% conversion)

### DEPENDENCIES
- Must complete after: Solution architecture (WS-288), Tech stack decisions (WS-289)
- Must complete before: Revenue model (WS-291)
- Shares code with: Analytics system, email service, incentive/billing system

### ESTIMATED EFFORT
- Team A Frontend: 24 hours (viral prompts, referral dashboard, gamification UI)
- Team B Backend: 32 hours (invitation engine, incentive system, viral analytics API)
- Team C Integration: 16 hours (email service, analytics integration, webhook setup)
- Team D Platform: 8 hours (A/B testing framework)
- Team E General: 12 hours (viral strategy documentation, templates)
- Team F Workflows: 8 hours (viral triggers integration)
- Team G Performance: 6 hours (viral system optimization)
- Total: 106 hours