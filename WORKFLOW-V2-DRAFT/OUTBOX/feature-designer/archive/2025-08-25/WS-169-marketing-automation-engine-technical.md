# TECHNICAL SPECIFICATION: WS-169 - Marketing Automation Engine
## Generated by Feature Development Session - 2025-01-24

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding supplier marketing manager
**I want to:** Automatically nurture leads and engage clients with targeted email sequences
**So that:** I can maintain consistent communication without manual effort and convert more trials to paid subscriptions

**Real Wedding Scenario:**
A venue coordinator has 200 past couples and 50 active ones. The automation engine sends anniversary emails to past couples encouraging referrals, weekly tips to active couples, and targeted content based on wedding timeline. This automation saves 15 hours/month and increases referral bookings by 30%.

### SPECIFICATION SOURCE
- **Feature ID:** WS-169
- **Original Spec:** /CORE-SPECIFICATIONS/13-BUSINESS-OPERATIONS/04-marketing-automation md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** None (new feature)
- **New Files to Create:**
  - /src/lib/marketing/automation-engine.ts
  - /src/lib/marketing/email-sequences.ts
  - /src/lib/marketing/behavioral-triggers.ts
  - /src/components/marketing/AutomationBuilder.tsx
  - /src/app/api/marketing/campaigns/route.ts

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Marketing campaigns
CREATE TABLE IF NOT EXISTS marketing_campaigns (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID REFERENCES suppliers(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  type TEXT CHECK (type IN ('email_sequence', 'behavioral', 'milestone', 'seasonal')),
  status TEXT CHECK (status IN ('draft', 'active', 'paused', 'completed')),
  trigger_conditions JSONB,
  settings JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Email sequences
CREATE TABLE IF NOT EXISTS email_sequences (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  campaign_id UUID REFERENCES marketing_campaigns(id) ON DELETE CASCADE,
  sequence_order INT NOT NULL,
  delay_days INT DEFAULT 0,
  email_template_id UUID,
  subject TEXT NOT NULL,
  content TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Campaign recipients
CREATE TABLE IF NOT EXISTS campaign_recipients (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  campaign_id UUID REFERENCES marketing_campaigns(id) ON DELETE CASCADE,
  recipient_email TEXT NOT NULL,
  client_id UUID REFERENCES clients(id),
  enrolled_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ,
  current_step INT DEFAULT 0,
  unsubscribed BOOLEAN DEFAULT false
);

CREATE INDEX idx_marketing_campaigns_supplier ON marketing_campaigns(supplier_id);
CREATE INDEX idx_campaign_recipients_campaign ON campaign_recipients(campaign_id);
```

#### API Endpoints Required
```typescript
// POST /api/marketing/campaigns
interface CreateCampaignRequest {
  name: string;
  type: 'email_sequence' | 'behavioral' | 'milestone';
  triggerConditions: {
    event?: string;
    segment?: string;
    dateField?: string;
  };
  emails: Array<{
    delayDays: number;
    subject: string;
    content: string;
  }>;
}

// GET /api/marketing/campaigns/:id/analytics
interface CampaignAnalyticsResponse {
  sent: number;
  opened: number;
  clicked: number;
  converted: number;
  unsubscribed: number;
  revenue: number;
}
```

#### Frontend Components Required
```typescript
// Component: AutomationBuilder
// Location: /src/components/marketing/AutomationBuilder.tsx

interface Props {
  campaignId?: string;
  onSave: (campaign: Campaign) => void;
}

// Key functionality:
- Visual sequence builder
- Email template editor
- Trigger condition setup
- Delay configuration
- Preview mode
- Analytics dashboard
```

### CODE EXAMPLES

#### Example 1: Behavioral Trigger System
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { supabase } from '@/lib/supabase';

interface BehavioralTrigger {
  event: string;
  conditions: Record<string, any>;
  action: string;
  campaignId: string;
}

export async function processBehavioralTriggers(
  userId: string,
  event: string,
  metadata: Record<string, any>
): Promise<void> {
  // Find matching triggers
  const { data: triggers } = await supabase
    .from('marketing_campaigns')
    .select('*')
    .eq('type', 'behavioral')
    .eq('status', 'active')
    .contains('trigger_conditions', { event });
  
  for (const trigger of triggers || []) {
    if (evaluateConditions(trigger.trigger_conditions, metadata)) {
      await enrollInCampaign(userId, trigger.id);
    }
  }
}

export async function enrollInCampaign(
  userId: string,
  campaignId: string
): Promise<void> {
  // Check if already enrolled
  const { data: existing } = await supabase
    .from('campaign_recipients')
    .select('id')
    .eq('campaign_id', campaignId)
    .eq('client_id', userId)
    .single();
  
  if (!existing) {
    await supabase
      .from('campaign_recipients')
      .insert({
        campaign_id: campaignId,
        client_id: userId,
        enrolled_at: new Date().toISOString()
      });
    
    // Schedule first email
    await scheduleNextEmail(userId, campaignId, 0);
  }
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [ ] Context7: Load docs for email marketing libraries
- [ ] PostgreSQL: Execute migration scripts
- [ ] Supabase: Configure email sending

### ACCEPTANCE CRITERIA
- [ ] Email sequences created and scheduled correctly
- [ ] Behavioral triggers fire on specified events
- [ ] Milestone campaigns activate on dates
- [ ] Analytics track open/click rates
- [ ] Unsubscribe functionality works
- [ ] Campaign pausing/resuming works
- [ ] Personalization tokens replaced correctly
- [ ] A/B testing capability available

### DEPENDENCIES
- Must complete after: WS-061 (Email Templates)
- Must complete before: None
- Shares code with: WS-168 (Customer Success)

### ESTIMATED EFFORT
- Team C Integration: 16 hours
- Team E Full-stack: 20 hours
- Total: 36 hours