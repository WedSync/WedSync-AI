# TECHNICAL SPECIFICATION: WS-167 - Trial Management System
## Generated by Feature Development Session - 2025-01-24

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding supplier new to digital management
**I want to:** Try all Professional features free for 30 days with guidance on getting started
**So that:** I can experience the full value before committing financially and get help transitioning from manual processes

**Real Wedding Scenario:**
A wedding venue coordinator managing 40 weddings annually currently uses email and Excel. They start a 30-day trial, import their upcoming weddings, and discover automated timelines save them 8 hours per wedding. On day 25, having used key features actively, they receive an extension offer for 15 more days to fully onboard their team before converting to paid.

### SPECIFICATION SOURCE
- **Feature ID:** WS-167
- **Original Spec:** /CORE-SPECIFICATIONS/13-BUSINESS-OPERATIONS/02-trial-management md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** None (new feature)
- **New Files to Create:**
  - /src/lib/trial/trial-manager.ts
  - /src/lib/trial/activity-tracker.ts
  - /src/lib/trial/extension-logic.ts
  - /src/components/trial/TrialStatusWidget.tsx
  - /src/components/trial/TrialChecklist.tsx
  - /src/app/api/trial/status/route.ts
  - /src/app/api/trial/extend/route.ts
  - /src/app/api/trial/activity/route.ts

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Trial tracking table
CREATE TABLE IF NOT EXISTS trial_tracking (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID REFERENCES suppliers(id) ON DELETE CASCADE,
  trial_start TIMESTAMPTZ DEFAULT NOW(),
  trial_end TIMESTAMPTZ NOT NULL,
  extended BOOLEAN DEFAULT false,
  extension_date TIMESTAMPTZ,
  conversion_date TIMESTAMPTZ,
  cancellation_date TIMESTAMPTZ,
  cancellation_reason TEXT,
  activity_score INT DEFAULT 0 CHECK (activity_score >= 0 AND activity_score <= 100),
  converted_tier TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Trial activity metrics
CREATE TABLE IF NOT EXISTS trial_activity (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID REFERENCES suppliers(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  logins INT DEFAULT 0,
  forms_created INT DEFAULT 0,
  clients_imported INT DEFAULT 0,
  journeys_created INT DEFAULT 0,
  emails_sent INT DEFAULT 0,
  feature_usage JSONB DEFAULT '{}',
  activity_points INT DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(supplier_id, date)
);

-- Trial email schedule
CREATE TABLE IF NOT EXISTS trial_email_schedule (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID REFERENCES suppliers(id) ON DELETE CASCADE,
  day_number INT NOT NULL,
  email_type TEXT NOT NULL,
  scheduled_for TIMESTAMPTZ NOT NULL,
  sent_at TIMESTAMPTZ,
  opened_at TIMESTAMPTZ,
  clicked_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes for performance
CREATE INDEX idx_trial_tracking_supplier ON trial_tracking(supplier_id);
CREATE INDEX idx_trial_tracking_end ON trial_tracking(trial_end);
CREATE INDEX idx_trial_activity_supplier_date ON trial_activity(supplier_id, date);
CREATE INDEX idx_trial_email_schedule_pending ON trial_email_schedule(scheduled_for) WHERE sent_at IS NULL;
```

#### API Endpoints Required
```typescript
// GET /api/trial/status
interface TrialStatusResponse {
  isActive: boolean;
  daysLeft: number;
  trialEnd: string;
  activityScore: number;
  extended: boolean;
  eligibleForExtension: boolean;
  checklist: {
    hasImportedClients: boolean;
    hasCreatedForm: boolean;
    hasSetupJourney: boolean;
    hasInvitedTeam: boolean;
    hasSentEmails: boolean;
  };
  recommendedActions: string[];
}

// POST /api/trial/extend
interface ExtendTrialRequest {
  reason?: string;
}

interface ExtendTrialResponse {
  success: boolean;
  newEndDate: string;
  daysAdded: number;
  message: string;
}

// GET /api/trial/activity
interface TrialActivityResponse {
  dailyActivity: Array<{
    date: string;
    logins: number;
    actions: number;
    score: number;
  }>;
  totalScore: number;
  mostUsedFeatures: Array<{
    feature: string;
    usageCount: number;
  }>;
  milestones: Array<{
    name: string;
    completed: boolean;
    completedAt?: string;
  }>;
}

// POST /api/trial/convert
interface ConvertTrialRequest {
  tierId: string;
  billingPeriod: 'monthly' | 'annual';
  paymentMethodId: string;
}

interface ConvertTrialResponse {
  success: boolean;
  subscription: {
    id: string;
    status: string;
    currentPeriodEnd: string;
  };
}
```

#### Frontend Components Required
```typescript
// Component: TrialStatusWidget
// Location: /src/components/trial/TrialStatusWidget.tsx

interface TrialStatusWidgetProps {
  supplierId: string;
  onExtendClick: () => void;
  onUpgradeClick: () => void;
}

// Key functionality:
- Display days remaining with visual countdown
- Show activity score progress bar
- Display setup checklist with completion status
- Show extension offer button when eligible
- Urgent styling when < 5 days remaining
- Celebrate milestones with animations

// Component: TrialChecklist
// Location: /src/components/trial/TrialChecklist.tsx

interface TrialChecklistProps {
  supplierId: string;
  onItemClick: (item: string) => void;
}

// Key functionality:
- Interactive checklist items
- Progress indicators for each item
- Quick action buttons to complete items
- Tooltips with helpful guidance
- Completion celebration animation
```

#### Integration Points
```typescript
// Service: TrialManager
// Dependencies: Email service, Analytics, Supabase

class TrialManager {
  async startTrial(supplierId: string): Promise<Trial> {
    // Create 30-day trial with Professional features
    // Schedule email sequence
    // Initialize activity tracking
  }
  
  async calculateActivityScore(supplierId: string): Promise<number> {
    // Weight actions by business value
    // Forms created: 20 points each
    // Clients imported: 2 points each (max 20)
    // Journeys created: 15 points each
    // Team members invited: 10 points each
  }
  
  async checkExtensionEligibility(supplierId: string): Promise<ExtensionResult> {
    // Verify activity score >= 40
    // Check hasn't extended before
    // Ensure within day 20-28 window
  }
  
  async extendTrial(supplierId: string): Promise<void> {
    // Add 15 days to trial end
    // Update database flags
    // Send confirmation email
    // Track analytics event
  }
  
  async scheduleTrialEmails(supplierId: string): Promise<void> {
    // Create email schedule based on trial start
    // Set up conditional sends based on activity
  }
}
```

### CODE EXAMPLES

#### Example 1: Activity Score Calculation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { supabase } from '@/lib/supabase';

interface ActivityWeights {
  login: 1;
  clientImport: 2;
  formCreation: 20;
  journeyCreation: 15;
  teamInvite: 10;
  emailSent: 0.5;
}

export async function calculateActivityScore(
  supplierId: string
): Promise<number> {
  // Get all trial activity
  const { data: activities } = await supabase
    .from('trial_activity')
    .select('*')
    .eq('supplier_id', supplierId);
  
  if (!activities) return 0;
  
  // Calculate weighted score
  let score = 0;
  const weights: ActivityWeights = {
    login: 1,
    clientImport: 2,
    formCreation: 20,
    journeyCreation: 15,
    teamInvite: 10,
    emailSent: 0.5
  };
  
  activities.forEach(activity => {
    score += Math.min(activity.logins * weights.login, 10); // Cap login points
    score += Math.min(activity.clients_imported * weights.clientImport, 20);
    score += activity.forms_created * weights.formCreation;
    score += activity.journeys_created * weights.journeyCreation;
    score += Math.min(activity.emails_sent * weights.emailSent, 10);
  });
  
  // Cap at 100
  return Math.min(score, 100);
}

export async function updateActivityScore(supplierId: string): Promise<void> {
  const score = await calculateActivityScore(supplierId);
  
  await supabase
    .from('trial_tracking')
    .update({ 
      activity_score: score,
      updated_at: new Date().toISOString()
    })
    .eq('supplier_id', supplierId);
}
```

#### Example 2: Trial Extension Logic
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { addDays, differenceInDays } from 'date-fns';
import { supabase } from '@/lib/supabase';

export async function processTrialExtension(
  supplierId: string
): Promise<{ success: boolean; message: string }> {
  // Get trial data
  const { data: trial } = await supabase
    .from('trial_tracking')
    .select('*')
    .eq('supplier_id', supplierId)
    .single();
  
  if (!trial) {
    return { success: false, message: 'No trial found' };
  }
  
  // Check if already extended
  if (trial.extended) {
    return { success: false, message: 'Trial already extended' };
  }
  
  // Check timing (must be between day 20-28)
  const daysInTrial = differenceInDays(new Date(), new Date(trial.trial_start));
  if (daysInTrial < 20 || daysInTrial > 28) {
    return { success: false, message: 'Outside extension window' };
  }
  
  // Check activity score
  if (trial.activity_score < 40) {
    return { success: false, message: 'Activity requirements not met' };
  }
  
  // Extend trial by 15 days
  const newEndDate = addDays(new Date(trial.trial_end), 15);
  
  await supabase
    .from('trial_tracking')
    .update({
      trial_end: newEndDate.toISOString(),
      extended: true,
      extension_date: new Date().toISOString()
    })
    .eq('supplier_id', supplierId);
  
  // Update subscription end date
  await supabase
    .from('supplier_subscriptions')
    .update({
      trial_ends_at: newEndDate.toISOString()
    })
    .eq('supplier_id', supplierId);
  
  // Send confirmation email
  await sendEmail(supplierId, 'trial_extended', {
    newEndDate: newEndDate.toISOString(),
    daysAdded: 15
  });
  
  return { success: true, message: 'Trial extended by 15 days!' };
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [ ] Context7: Load docs for date-fns, email templates
- [ ] PostgreSQL: Execute migration scripts
- [ ] Supabase: Configure RLS policies

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/date-fns/date-fns", "date manipulation", 2000);
await mcp__context7__get-library-docs("/vercel/next.js", "server components", 2000);
await mcp__context7__get-library-docs("/react-email/react-email", "email templates", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('TrialManager', () => {
  it('should create 30-day trial for new supplier', async () => {
    const trial = await startTrial('supplier-id');
    expect(trial.status).toBe('trialing');
    expect(differenceInDays(trial.trial_end, trial.trial_start)).toBe(30);
  });
  
  it('should calculate activity score correctly', async () => {
    const score = await calculateActivityScore('supplier-id');
    expect(score).toBeGreaterThanOrEqual(0);
    expect(score).toBeLessThanOrEqual(100);
  });
  
  it('should only allow one extension per trial', async () => {
    await processTrialExtension('supplier-id');
    const second = await processTrialExtension('supplier-id');
    expect(second.success).toBe(false);
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Trial extension flow', async () => {
  await mcp__playwright__browser_navigate({url: '/dashboard'});
  
  // Check trial widget visible
  await mcp__playwright__browser_wait_for({
    text: 'days left'
  });
  
  // Click extension button
  await mcp__playwright__browser_click({
    element: 'Get 15 Extra Days button',
    ref: '[data-testid="extend-trial-btn"]'
  });
  
  // Verify success message
  await mcp__playwright__browser_wait_for({
    text: 'Trial extended'
  });
});
```

### ACCEPTANCE CRITERIA
- [ ] 30-day trial auto-starts for new suppliers
- [ ] Professional features immediately available during trial
- [ ] Activity score calculates correctly with weighted actions
- [ ] Extension offer appears between days 20-28 for eligible users
- [ ] Extension adds exactly 15 days (one-time only)
- [ ] Email sequence sends on schedule with conditional logic
- [ ] Trial dashboard widget shows accurate countdown
- [ ] Checklist tracks completion of key onboarding steps
- [ ] Grace period of 3 days after trial ends before feature removal
- [ ] Previous trial users cannot start new trial with same email
- [ ] Conversion tracking captures all required metrics

### DEPENDENCIES
- Must complete after: WS-166 (Pricing Strategy) - Needs tier foundation
- Must complete before: WS-168 (Customer Success) - Success metrics depend on trial data
- Shares code with: WS-169 (Marketing Automation) - Email sequences

### ESTIMATED EFFORT
- Team A Frontend: 12 hours (trial widget, checklist UI)
- Team B Backend: 20 hours (trial logic, activity tracking, extension system)
- Team C Integration: 8 hours (email scheduling, analytics)
- Total: 40 hours