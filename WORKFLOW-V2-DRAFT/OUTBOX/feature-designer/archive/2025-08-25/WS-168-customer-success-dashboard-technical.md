# TECHNICAL SPECIFICATION: WS-168 - Customer Success Dashboard
## Generated by Feature Development Session - 2025-01-24

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** WedSync platform administrator
**I want to:** Monitor supplier health scores and intervene proactively when usage drops
**So that:** I can prevent churn, increase feature adoption, and ensure suppliers get maximum value from the platform

**Real Wedding Scenario:**
A photographer signs up but hasn't logged in for 7 days after initial setup. The system automatically detects this, sends a re-engagement email with helpful tips, and flags them for a personal check-in call. This intervention prevents 40% of early-stage churn.

### SPECIFICATION SOURCE
- **Feature ID:** WS-168
- **Original Spec:** /CORE-SPECIFICATIONS/13-BUSINESS-OPERATIONS/03-customer-success md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** None (new feature)
- **New Files to Create:**
  - /src/lib/customer-success/health-scorer.ts
  - /src/lib/customer-success/intervention-engine.ts
  - /src/components/admin/CustomerHealthDashboard.tsx
  - /src/app/api/customer-success/health/route.ts
  - /src/app/api/customer-success/interventions/route.ts

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Customer health scoring
CREATE TABLE IF NOT EXISTS customer_health (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID REFERENCES suppliers(id) ON DELETE CASCADE,
  health_score INT CHECK (health_score >= 0 AND health_score <= 100),
  risk_level TEXT CHECK (risk_level IN ('healthy', 'at_risk', 'critical')),
  last_login TIMESTAMPTZ,
  feature_adoption_score INT,
  client_engagement_score INT,
  calculated_at TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Success milestones tracking
CREATE TABLE IF NOT EXISTS success_milestones (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID REFERENCES suppliers(id) ON DELETE CASCADE,
  milestone_type TEXT NOT NULL,
  achieved_at TIMESTAMPTZ DEFAULT NOW(),
  celebrated BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(supplier_id, milestone_type)
);

-- Support interactions
CREATE TABLE IF NOT EXISTS support_interactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID REFERENCES suppliers(id) ON DELETE CASCADE,
  type TEXT CHECK (type IN ('onboarding_call', 'check_in', 'technical_support', 'upgrade_discussion')),
  notes TEXT,
  outcome TEXT,
  scheduled_for TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  created_by UUID REFERENCES user_profiles(id),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_customer_health_supplier ON customer_health(supplier_id);
CREATE INDEX idx_customer_health_risk ON customer_health(risk_level);
CREATE INDEX idx_success_milestones_supplier ON success_milestones(supplier_id);
```

#### API Endpoints Required
```typescript
// GET /api/customer-success/health
interface HealthDashboardResponse {
  summary: {
    totalSuppliers: number;
    healthyCount: number;
    atRiskCount: number;
    criticalCount: number;
  };
  suppliers: Array<{
    id: string;
    name: string;
    healthScore: number;
    riskLevel: string;
    lastLogin: string;
    daysActive: number;
    tier: string;
    recommendations: string[];
  }>;
}

// POST /api/customer-success/interventions
interface InterventionRequest {
  supplierId: string;
  type: 'email' | 'call' | 'in_app';
  template?: string;
  message?: string;
}

interface InterventionResponse {
  success: boolean;
  interventionId: string;
  scheduledFor?: string;
}
```

#### Frontend Components Required
```typescript
// Component: CustomerHealthDashboard
// Location: /src/components/admin/CustomerHealthDashboard.tsx

interface Props {
  onSupplierSelect: (supplierId: string) => void;
  onInterventionTrigger: (supplierId: string, type: string) => void;
}

// Key functionality:
- Display health scores in visual grid
- Risk level color coding (green/yellow/red)
- Quick intervention actions
- Trend graphs for each supplier
- Filter by risk level
- Export health reports
```

#### Integration Points
```typescript
// Service: HealthScorer
// Dependencies: Analytics, Supabase, Email service

class HealthScorer {
  async calculateHealthScore(supplierId: string): Promise<HealthScore> {
    // Calculate based on multiple metrics
    // Weight by importance
    // Return score and risk level
  }
  
  async runDailyHealthCheck(): Promise<void> {
    // Calculate for all active suppliers
    // Trigger interventions as needed
    // Update health records
  }
}
```

### CODE EXAMPLES

#### Example 1: Health Score Calculation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { differenceInDays } from 'date-fns';
import { supabase } from '@/lib/supabase';

interface HealthMetrics {
  loginFrequency: number;
  featureAdoption: number;
  clientActivity: number;
  formCompletionRate: number;
  journeyPerformance: number;
}

export async function calculateHealthScore(
  supplierId: string
): Promise<{ score: number; risk: 'healthy' | 'at_risk' | 'critical' }> {
  // Gather metrics
  const metrics = await gatherHealthMetrics(supplierId);
  
  let score = 0;
  
  // Login frequency (30 points)
  const daysSinceLogin = metrics.loginFrequency;
  if (daysSinceLogin < 3) score += 30;
  else if (daysSinceLogin < 7) score += 20;
  else if (daysSinceLogin < 14) score += 10;
  
  // Feature adoption (25 points)
  score += Math.min(25, metrics.featureAdoption * 25);
  
  // Client activity (25 points)
  score += Math.min(25, metrics.clientActivity * 25);
  
  // Form completion (10 points)
  score += Math.min(10, metrics.formCompletionRate * 10);
  
  // Journey performance (10 points)
  score += Math.min(10, metrics.journeyPerformance * 10);
  
  // Determine risk level
  const risk = score < 40 ? 'critical' : 
               score < 70 ? 'at_risk' : 'healthy';
  
  // Store result
  await supabase
    .from('customer_health')
    .upsert({
      supplier_id: supplierId,
      health_score: score,
      risk_level: risk,
      calculated_at: new Date().toISOString()
    });
  
  return { score, risk };
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [ ] Context7: Load docs for analytics libraries
- [ ] PostgreSQL: Execute migration scripts
- [ ] Supabase: Configure admin access policies

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/vercel/next.js", "server actions", 2000);
await mcp__context7__get-library-docs("/recharts/recharts", "dashboard charts", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('HealthScorer', () => {
  it('should calculate health score accurately', async () => {
    const score = await calculateHealthScore('supplier-id');
    expect(score.score).toBeGreaterThanOrEqual(0);
    expect(score.score).toBeLessThanOrEqual(100);
  });
  
  it('should trigger interventions for at-risk suppliers', async () => {
    const interventions = await checkInterventions('at-risk-supplier');
    expect(interventions.length).toBeGreaterThan(0);
  });
});
```

### ACCEPTANCE CRITERIA
- [ ] Health scores calculate daily for all active suppliers
- [ ] Risk levels accurately categorize suppliers
- [ ] Automated interventions trigger based on conditions
- [ ] Admin dashboard displays real-time health metrics
- [ ] Intervention history tracked and visible
- [ ] Success milestones celebrated automatically
- [ ] Export functionality for health reports
- [ ] Email notifications for critical risk suppliers

### DEPENDENCIES
- Must complete after: WS-167 (Trial Management) - Uses trial data
- Must complete before: None
- Shares code with: WS-169 (Marketing Automation)

### ESTIMATED EFFORT
- Team D Analytics: 20 hours
- Team E Automation: 16 hours
- Total: 36 hours