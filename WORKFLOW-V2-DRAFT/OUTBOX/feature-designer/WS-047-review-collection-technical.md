# TECHNICAL SPECIFICATION: WS-047 - Review Collection System
## Generated by Feature Development Session - 2025-08-21

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding photographer who just completed a wedding
**I want to:** Automatically collect reviews 10 days post-wedding when couples are happiest
**So that:** I get 67% more bookings from online reviews instead of manually chasing testimonials for months

**Real Wedding Scenario:**
Jake photographed Emma & Mike's wedding on June 15th. On June 25th, the system automatically sends Emma a personalized review request: "Hi Emma! Hope you're still glowing from your beautiful ceremony at Sunset Manor! Would you mind sharing your experience with Jake?" One-click takes her to a pre-filled form with her wedding details, she leaves a 5-star Google review, and Jake gets 3 inquiries that week from couples who found him through that review.

### SPECIFICATION SOURCE
- **Feature ID:** WS-047
- **Original Spec:** /CORE-SPECIFICATIONS/02-WEDSYNC-SUPPLIER-PLATFORM/08-Growth-Features/02-review-collection md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** None - new feature
- **New Files to Create:**
  - `/src/components/reviews/ReviewRequestBuilder.tsx`
  - `/src/components/reviews/ReviewDashboard.tsx`
  - `/src/app/api/reviews/request/route.ts`
  - `/src/app/api/reviews/collect/route.ts`
  - `/src/app/review/[token]/page.tsx`
  - `/src/lib/reviews/review-engine.ts`
  - `/src/lib/reviews/platform-integrations.ts`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Review Campaigns table
CREATE TABLE IF NOT EXISTS review_campaigns (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID NOT NULL REFERENCES suppliers(id),
  name VARCHAR(100) NOT NULL,
  trigger_days_after_wedding INTEGER DEFAULT 10,
  secondary_trigger_days INTEGER, -- After gallery delivery
  message_template TEXT NOT NULL,
  incentive_type VARCHAR(20), -- 'discount', 'credit', 'gift', 'none'
  incentive_value DECIMAL(10,2),
  target_platforms TEXT[] DEFAULT '{google,facebook,internal}',
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Review Requests table
CREATE TABLE IF NOT EXISTS review_requests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  campaign_id UUID NOT NULL REFERENCES review_campaigns(id),
  couple_id UUID NOT NULL REFERENCES couples(id),
  wedding_date DATE NOT NULL,
  request_token VARCHAR(64) UNIQUE NOT NULL,
  sent_at TIMESTAMP WITH TIME ZONE,
  opened_at TIMESTAMP WITH TIME ZONE,
  responded_at TIMESTAMP WITH TIME ZONE,
  status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'sent', 'opened', 'completed', 'expired')),
  platform_preference VARCHAR(20), -- Which platform couple prefers
  sentiment_score DECIMAL(3,2), -- 0.00-1.00 from sentiment analysis
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Collected Reviews table
CREATE TABLE IF NOT EXISTS collected_reviews (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  request_id UUID NOT NULL REFERENCES review_requests(id),
  platform VARCHAR(20) NOT NULL, -- 'google', 'facebook', 'weddingwire', 'internal'
  rating INTEGER CHECK (rating >= 1 AND rating <= 5),
  review_text TEXT,
  reviewer_name VARCHAR(100),
  reviewer_email VARCHAR(255),
  photos TEXT[], -- Array of uploaded photo URLs
  is_verified BOOLEAN DEFAULT FALSE,
  external_review_id VARCHAR(100), -- ID from external platform
  external_review_url TEXT,
  published_at TIMESTAMP WITH TIME ZONE,
  response_text TEXT, -- Supplier's response
  response_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Review Analytics table
CREATE TABLE IF NOT EXISTS review_analytics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  campaign_id UUID NOT NULL REFERENCES review_campaigns(id),
  date DATE NOT NULL,
  requests_sent INTEGER DEFAULT 0,
  requests_opened INTEGER DEFAULT 0,
  reviews_collected INTEGER DEFAULT 0,
  average_rating DECIMAL(2,1),
  conversion_rate DECIMAL(5,2), -- percentage
  booking_attributions INTEGER DEFAULT 0, -- Bookings attributed to reviews
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(campaign_id, date)
);

-- Platform Integrations table
CREATE TABLE IF NOT EXISTS platform_integrations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID NOT NULL REFERENCES suppliers(id),
  platform VARCHAR(20) NOT NULL,
  api_credentials JSONB, -- Encrypted credentials
  business_id VARCHAR(100), -- Google Business ID, Facebook Page ID
  is_active BOOLEAN DEFAULT TRUE,
  last_sync_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(supplier_id, platform)
);
```

#### API Endpoints Required
```typescript
// POST /api/reviews/campaigns
interface CreateCampaignRequest {
  name: string;
  triggerDaysAfterWedding: number;
  secondaryTriggerDays?: number;
  messageTemplate: string;
  incentiveType?: 'discount' | 'credit' | 'gift' | 'none';
  incentiveValue?: number;
  targetPlatforms: string[];
}

// GET /api/reviews/campaigns/[supplierId]
interface GetCampaignsResponse {
  success: boolean;
  campaigns: ReviewCampaign[];
  stats: {
    totalRequests: number;
    responseRate: number;
    averageRating: number;
  };
}

// POST /api/reviews/request/send
interface SendReviewRequestRequest {
  campaignId: string;
  coupleId: string;
  customMessage?: string;
  scheduledFor?: string; // ISO date
}

// GET /api/reviews/request/[token]
interface GetReviewFormResponse {
  success: boolean;
  campaign: ReviewCampaign;
  couple: {
    names: string;
    weddingDate: string;
    venue: string;
  };
  platforms: Array<{
    name: string;
    icon: string;
    url: string;
  }>;
}

// POST /api/reviews/collect
interface SubmitReviewRequest {
  token: string;
  platform: string;
  rating: number;
  reviewText?: string;
  reviewerName: string;
  reviewerEmail: string;
  photos?: string[]; // Base64 encoded images
}

// GET /api/reviews/analytics/[campaignId]
interface ReviewAnalyticsResponse {
  success: boolean;
  metrics: {
    totalSent: number;
    responseRate: number;
    averageRating: number;
    platformBreakdown: Record<string, number>;
    recentReviews: CollectedReview[];
    conversionToBookings: number;
  };
}

// POST /api/reviews/platforms/connect
interface ConnectPlatformRequest {
  platform: 'google' | 'facebook' | 'weddingwire';
  credentials: {
    apiKey?: string;
    businessId?: string;
    accessToken?: string;
  };
}
```

#### Frontend Components Required
```typescript
// Component: ReviewRequestBuilder
// Location: /src/components/reviews/ReviewRequestBuilder.tsx

interface ReviewRequestBuilderProps {
  supplierId: string;
  onCampaignCreated: (campaign: ReviewCampaign) => void;
}

// Key functionality:
- Campaign configuration form with timing options
- Message template builder with merge fields
- Platform selection and integration status
- Incentive configuration
- A/B testing setup for messaging
- Preview of review request email/form

// Component: ReviewDashboard
// Location: /src/components/reviews/ReviewDashboard.tsx

interface ReviewDashboardProps {
  supplierId: string;
}

// Key functionality:
- Analytics charts (response rates, ratings over time)
- Recent reviews display with photos
- Platform-specific performance metrics
- Automated response management
- Review showcase gallery
- Negative review alert system

// Component: ReviewForm
// Location: /src/app/review/[token]/page.tsx

interface ReviewFormProps {
  token: string;
}

// Key functionality:
- Mobile-optimized review submission form
- Pre-populated wedding details
- Platform selection (Google, Facebook, etc.)
- Photo upload capability
- One-click rating with optional text
- Thank you page with social sharing
```

#### Integration Points
```typescript
// Service: ReviewEngine
// Dependencies: EmailService, CoupleService, SentimentAnalysis

class ReviewEngine {
  async createCampaign(supplierId: string, campaignData: CreateCampaignRequest) {
    // Create campaign and schedule automated triggers
  }
  
  async scheduleRequests(campaignId: string) {
    // Schedule review requests based on wedding dates + trigger timing
  }
  
  async sendReviewRequest(requestId: string) {
    // Send personalized review request with unique token
  }
  
  async analyzeSentiment(coupleId: string, weddingId: string): Promise<number> {
    // Analyze journey interactions for happiness indicators
  }
  
  async submitReview(token: string, reviewData: SubmitReviewRequest) {
    // Process review submission and post to external platforms
  }
}

// Service: PlatformIntegrations
// Dependencies: Google Business API, Facebook Graph API

class PlatformIntegrations {
  async connectGoogleBusiness(supplierId: string, credentials: GoogleCredentials) {
    // Set up Google Business Profile integration
  }
  
  async postToGoogleBusiness(businessId: string, review: ReviewData) {
    // Submit review to Google Business Profile
  }
  
  async connectFacebookPage(supplierId: string, credentials: FacebookCredentials) {
    // Set up Facebook page review integration
  }
  
  async syncExternalReviews(supplierId: string) {
    // Pull existing reviews from connected platforms
  }
}

// Service: SentimentAnalyzer
// Dependencies: Natural language processing

class SentimentAnalyzer {
  async analyzeClientSentiment(coupleId: string): Promise<SentimentScore> {
    // Analyze journey completion, response times, communication tone
  }
  
  async optimizeTimingForClient(coupleId: string, weddingDate: Date): Promise<Date> {
    // Determine optimal review request timing based on engagement patterns
  }
}
```

### CODE EXAMPLES

#### Example 1: Automated Review Request Scheduling
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { supabase } from '@/lib/supabase';
import { addDays } from 'date-fns';

export async function scheduleReviewRequests(campaignId: string) {
  // Step 1: Get campaign details and active couples
  const { data: campaign } = await supabase
    .from('review_campaigns')
    .select(`
      *,
      suppliers!inner(
        couples(id, wedding_date, bride_name, groom_name)
      )
    `)
    .eq('id', campaignId)
    .eq('is_active', true)
    .single();
    
  if (!campaign) throw new Error('Campaign not found');
  
  // Step 2: Filter couples who haven't been sent requests
  const existingRequests = await supabase
    .from('review_requests')
    .select('couple_id')
    .eq('campaign_id', campaignId);
    
  const existingCoupleIds = new Set(existingRequests.data?.map(r => r.couple_id));
  
  // Step 3: Create requests for eligible couples
  const eligibleCouples = campaign.suppliers.couples.filter(couple => {
    const daysSinceWedding = Math.floor(
      (Date.now() - new Date(couple.wedding_date).getTime()) / (1000 * 60 * 60 * 24)
    );
    return daysSinceWedding >= campaign.trigger_days_after_wedding && 
           !existingCoupleIds.has(couple.id);
  });
  
  // Step 4: Analyze sentiment and create requests
  const reviewRequests = await Promise.all(
    eligibleCouples.map(async (couple) => {
      const sentimentScore = await analyzeSentiment(couple.id);
      
      // Only create requests for couples with positive sentiment (>0.6)
      if (sentimentScore < 0.6) return null;
      
      const token = generateSecureToken();
      const scheduledFor = addDays(new Date(couple.wedding_date), campaign.trigger_days_after_wedding);
      
      return {
        campaign_id: campaignId,
        couple_id: couple.id,
        wedding_date: couple.wedding_date,
        request_token: token,
        sentiment_score: sentimentScore,
        created_at: new Date().toISOString()
      };
    })
  );
  
  const validRequests = reviewRequests.filter(Boolean);
  
  // Step 5: Batch insert requests
  if (validRequests.length > 0) {
    const { data, error } = await supabase
      .from('review_requests')
      .insert(validRequests)
      .select();
      
    if (error) throw error;
    
    // Step 6: Schedule email sends
    await Promise.all(
      data.map(request => 
        scheduleEmail(request.id, request.couple_id, scheduledFor)
      )
    );
  }
  
  return {
    scheduled: validRequests.length,
    skippedLowSentiment: eligibleCouples.length - validRequests.length
  };
}
```

#### Example 2: Multi-Platform Review Submission
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { supabase } from '@/lib/supabase';

export async function submitReviewToMultiplePlatforms(
  token: string, 
  reviewData: SubmitReviewRequest
) {
  // Step 1: Validate token and get request details
  const { data: request } = await supabase
    .from('review_requests')
    .select(`
      *,
      review_campaigns(
        target_platforms,
        supplier_id,
        suppliers(platform_integrations(*))
      )
    `)
    .eq('request_token', token)
    .eq('status', 'opened')
    .single();
    
  if (!request) throw new Error('Invalid or expired token');
  
  // Step 2: Create internal review record
  const { data: review, error } = await supabase
    .from('collected_reviews')
    .insert({
      request_id: request.id,
      platform: 'internal',
      rating: reviewData.rating,
      review_text: reviewData.reviewText,
      reviewer_name: reviewData.reviewerName,
      reviewer_email: reviewData.reviewerEmail,
      photos: reviewData.photos || [],
      published_at: new Date().toISOString()
    })
    .select()
    .single();
    
  if (error) throw error;
  
  // Step 3: Submit to selected external platforms
  const platformResults: Record<string, boolean> = {};
  const campaign = request.review_campaigns;
  
  if (reviewData.platform === 'google' && campaign.target_platforms.includes('google')) {
    try {
      const googleIntegration = campaign.suppliers.platform_integrations
        .find(p => p.platform === 'google');
        
      if (googleIntegration) {
        await submitToGoogleBusiness(googleIntegration, {
          rating: reviewData.rating,
          text: reviewData.reviewText,
          reviewer: reviewData.reviewerName
        });
        platformResults.google = true;
      }
    } catch (error) {
      console.error('Google submission failed:', error);
      platformResults.google = false;
    }
  }
  
  if (reviewData.platform === 'facebook' && campaign.target_platforms.includes('facebook')) {
    try {
      const facebookIntegration = campaign.suppliers.platform_integrations
        .find(p => p.platform === 'facebook');
        
      if (facebookIntegration) {
        await submitToFacebook(facebookIntegration, reviewData);
        platformResults.facebook = true;
      }
    } catch (error) {
      console.error('Facebook submission failed:', error);
      platformResults.facebook = false;
    }
  }
  
  // Step 4: Update request status and analytics
  await supabase
    .from('review_requests')
    .update({ 
      status: 'completed',
      responded_at: new Date().toISOString()
    })
    .eq('id', request.id);
    
  // Step 5: Update daily analytics
  await updateDailyAnalytics(campaign.id, {
    reviews_collected: 1,
    average_rating: reviewData.rating
  });
  
  // Step 6: Send thank you email if positive review
  if (reviewData.rating >= 4) {
    await sendThankYouEmail(reviewData.reviewerEmail, campaign.supplier_id);
  }
  
  return {
    success: true,
    review,
    platformResults,
    message: 'Review submitted successfully!'
  };
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for Google Business API, Facebook Graph API
- [x] Filesystem: Access email templates and review form layouts
- [ ] Playwright: Test review submission flow across platforms

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/googleapis/googleapis", "google business profile api", 3000);
await mcp__context7__get-library-docs("/facebook/facebook-sdk", "facebook graph api reviews", 2500);
await mcp__context7__get-library-docs("/natural/natural", "sentiment analysis", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('Review Collection Engine', () => {
  it('should schedule requests for eligible couples only', async () => {
    const result = await scheduleReviewRequests('campaign-123');
    expect(result.scheduled).toBeGreaterThan(0);
    expect(result.skippedLowSentiment).toBeGreaterThanOrEqual(0);
  });
  
  it('should analyze sentiment correctly', async () => {
    const score = await analyzeSentiment('couple-happy');
    expect(score).toBeGreaterThan(0.6);
  });
  
  it('should submit reviews to multiple platforms', async () => {
    const result = await submitReviewToMultiplePlatforms('token-123', mockReviewData);
    expect(result.platformResults.google).toBe(true);
  });
  
  it('should handle platform API failures gracefully', async () => {
    // Mock API failure and verify internal review still saves
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Complete review collection flow', async () => {
  // Step 1: Supplier creates review campaign
  await mcp__playwright__browser_navigate({url: '/reviews/campaigns'});
  await mcp__playwright__browser_click({element: 'Create Campaign', ref: 'button[data-testid="create-campaign"]'});
  
  // Step 2: Configure campaign settings
  await mcp__playwright__browser_type({element: 'campaign name', ref: 'input[name="name"]', text: 'Post-Wedding Reviews'});
  await mcp__playwright__browser_type({element: 'trigger days', ref: 'input[name="triggerDays"]', text: '10'});
  
  // Step 3: Test review request email
  await mcp__playwright__browser_navigate({url: '/review/test-token-123'});
  await mcp__playwright__browser_snapshot();
  
  // Step 4: Submit review with photos
  await mcp__playwright__browser_type({element: 'reviewer name', ref: 'input[name="reviewerName"]', text: 'Sarah Johnson'});
  await mcp__playwright__browser_click({element: '5 stars', ref: 'button[data-rating="5"]'});
  await mcp__playwright__browser_type({element: 'review text', ref: 'textarea[name="reviewText"]', text: 'Amazing photographer!'});
  
  // Step 5: Verify analytics update
  await mcp__playwright__browser_navigate({url: '/reviews/analytics'});
  await mcp__playwright__browser_snapshot();
  
  // Verify mobile responsiveness and accessibility
});
```

### ACCEPTANCE CRITERIA
- [x] System automatically sends review requests 10 days post-wedding to couples with >60% sentiment score
- [x] One-click review submission to Google Business, Facebook, and internal system
- [x] Mobile-optimized review forms load in <2 seconds on 3G connections
- [x] Photo upload supports up to 5 images, max 2MB each with automatic compression
- [x] Analytics track response rates, platform performance, and booking attribution with 99% accuracy
- [x] Performance: API responses <500ms, email delivery within 5 minutes
- [x] Security: Review tokens expire after 30 days, all platform credentials encrypted
- [x] Accessibility: WCAG 2.1 AA compliance for all review interfaces

### DEPENDENCIES
- Must complete after: Client Management System (WS-002) - needs couple and wedding data
- Must complete before: Viral Mechanics System (WS-050) - reviews feed viral sharing
- Shares code with: Email Templates (WS-012), Analytics Dashboard, Journey System

### ESTIMATED EFFORT
- Team A Frontend: 24 hours
- Team B Backend: 36 hours
- Team C Integration: 16 hours
- Total: 76 hours