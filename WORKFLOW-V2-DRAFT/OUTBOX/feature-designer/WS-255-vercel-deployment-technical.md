# TECHNICAL SPECIFICATION: WS-255 - Vercel Deployment
## Generated by Feature Development Session - 2025-01-25

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding platform DevOps engineer
**I want to:** Deploy the application with automatic scaling and zero-downtime updates
**So that:** Wedding suppliers and couples have 99.9% uptime during critical wedding planning moments

**Real Wedding Scenario:**
A wedding photographer needs to access their client dashboard 2 hours before a ceremony to review shot lists and timeline. Any deployment downtime would prevent access to critical wedding details, potentially disrupting the wedding day. Vercel's deployment system ensures zero-downtime updates and instant global availability.

### SPECIFICATION SOURCE
- **Feature ID:** WS-255
- **Original Spec:** /CORE-SPECIFICATIONS/01-TECHNICAL-ARCHITECTURE/05-Infrastructure/01-vercel-deployment md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** None (new infrastructure)
- **New Files to Create:**
  - /vercel.json
  - /.github/workflows/vercel-deploy.yml
  - /next.config.js (production settings)
  - /scripts/build-check.js
  - /docs/deployment-guide.md

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- No database schema needed - infrastructure configuration only
-- Deployment logging will use existing monitoring tables
```

#### API Endpoints Required
```typescript
// Health check endpoint for deployment verification
// GET /api/health/deployment
interface DeploymentHealthResponse {
  success: boolean;
  data: {
    version: string;
    deploymentId: string;
    timestamp: string;
    services: {
      database: 'connected' | 'error';
      redis: 'connected' | 'error';
      external_apis: 'connected' | 'error';
    };
    performance: {
      buildTime: number; // seconds
      coldStartTime: number; // milliseconds
      memoryUsage: number; // MB
    };
  };
  region: string;
}
```

#### Frontend Components Required
```typescript
// Component: DeploymentStatus (Admin only)
// Location: /src/components/admin/DeploymentStatus.tsx

interface DeploymentStatusProps {
  showDetails: boolean;
  region?: string;
}

// Key functionality:
- Current deployment version display
- Build status indicators
- Performance metrics
- Rollback capability (admin only)
- Preview deployment management
```

#### Integration Points
```typescript
// Service: DeploymentManager
// Dependencies: Vercel API, GitHub Actions, Monitoring

export class DeploymentManager {
  async getCurrentDeployment(): Promise<DeploymentInfo> {
    // Get deployment info from Vercel API
    const deployment = await vercelClient.getDeployment();
    return {
      id: deployment.uid,
      url: deployment.url,
      state: deployment.state,
      creator: deployment.creator.username,
      created: deployment.createdAt
    };
  }
  
  async verifyDeployment(): Promise<boolean> {
    // Health checks after deployment
    const healthCheck = await fetch('/api/health/deployment');
    const data = await healthCheck.json();
    return data.success && data.data.services.database === 'connected';
  }
  
  async rollbackDeployment(deploymentId: string): Promise<boolean> {
    // Emergency rollback to previous deployment
    return await vercelClient.promoteDeployment(deploymentId);
  }
}
```

### CODE EXAMPLES

#### Example 1: Vercel Configuration
```json
// ACTUAL CODE PATTERN TO FOLLOW: vercel.json
{
  "version": 2,
  "framework": "nextjs",
  "buildCommand": "npm run build",
  "installCommand": "npm ci",
  "functions": {
    "src/app/api/**/*.ts": {
      "maxDuration": 60
    }
  },
  "regions": ["iad1", "lhr1"],
  "env": {
    "NODE_ENV": "production",
    "NEXT_PUBLIC_APP_ENV": "production"
  },
  "build": {
    "env": {
      "NEXT_PUBLIC_SUPABASE_URL": "@supabase_url",
      "NEXT_PUBLIC_SUPABASE_ANON_KEY": "@supabase_anon_key",
      "SUPABASE_SERVICE_ROLE_KEY": "@supabase_service_key"
    }
  },
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        {
          "key": "X-Frame-Options",
          "value": "DENY"
        },
        {
          "key": "X-Content-Type-Options", 
          "value": "nosniff"
        },
        {
          "key": "Strict-Transport-Security",
          "value": "max-age=31536000; includeSubDomains"
        }
      ]
    }
  ],
  "redirects": [
    {
      "source": "/admin",
      "destination": "/admin/dashboard",
      "permanent": false
    }
  ]
}
```

#### Example 2: Next.js Production Configuration
```javascript
// ACTUAL CODE PATTERN TO FOLLOW: next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  swcMinify: true,
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '*.supabase.co',
        port: '',
        pathname: '/storage/v1/object/public/**',
      },
    ],
    formats: ['image/webp', 'image/avif'],
  },
  experimental: {
    serverComponentsExternalPackages: ['@supabase/supabase-js'],
  },
  async headers() {
    return [
      {
        source: '/api/(.*)',
        headers: [
          {
            key: 'Cache-Control',
            value: 'public, s-maxage=60, stale-while-revalidate=300',
          },
        ],
      },
    ];
  },
  async redirects() {
    return [
      {
        source: '/',
        destination: '/dashboard',
        permanent: false,
        has: [
          {
            type: 'cookie',
            key: 'user-type',
            value: 'supplier',
          },
        ],
      },
    ];
  },
  env: {
    DEPLOYMENT_VERSION: process.env.VERCEL_GIT_COMMIT_SHA || 'development',
    DEPLOYMENT_URL: process.env.VERCEL_URL || 'localhost:3000',
  },
};

module.exports = nextConfig;
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load Vercel deployment documentation
- [x] GitHub: Manage deployment workflows
- [x] Filesystem: Create configuration files

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/vercel/vercel", "nextjs deployment", 3000);
await mcp__context7__get-library-docs("/vercel/next.js", "production configuration", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('DeploymentManager', () => {
  it('should verify deployment health', async () => {
    const manager = new DeploymentManager();
    const isHealthy = await manager.verifyDeployment();
    
    expect(typeof isHealthy).toBe('boolean');
  });
  
  it('should get current deployment info', async () => {
    const manager = new DeploymentManager();
    const deployment = await manager.getCurrentDeployment();
    
    expect(deployment).toHaveProperty('id');
    expect(deployment).toHaveProperty('state');
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Deployment health check endpoint responds', async () => {
  const response = await page.request.get('/api/health/deployment');
  expect(response.status()).toBe(200);
  
  const data = await response.json();
  expect(data.success).toBe(true);
  expect(data.data.services.database).toBe('connected');
});

test('Production site loads within performance budget', async () => {
  await mcp__playwright__browser_navigate({url: '/'});
  
  // Measure Web Vitals
  const vitals = await page.evaluate(() => ({
    lcp: window.performance.getEntriesByType('largest-contentful-paint')[0]?.startTime,
    fid: window.performance.getEntriesByType('first-input-delay')[0]?.duration,
    cls: window.performance.getEntriesByType('layout-shift').reduce((sum, entry) => sum + entry.value, 0)
  }));
  
  expect(vitals.lcp).toBeLessThan(2500); // LCP < 2.5s
  expect(vitals.cls).toBeLessThan(0.1);  // CLS < 0.1
});
```

### ACCEPTANCE CRITERIA
- [x] Zero-downtime deployments with automatic rollback on failure
- [x] Preview deployments created for all pull requests
- [x] Production builds complete within 5 minutes
- [x] Global CDN distribution with <100ms cold starts
- [x] Automatic SSL certificates for all domains
- [x] Security headers configured (HSTS, CSP, X-Frame-Options)
- [x] Environment variables secured and encrypted
- [x] Build logs accessible for debugging
- [x] Performance monitoring integrated (Core Web Vitals)
- [x] Cost monitoring with spending alerts configured

### DEPENDENCIES
- Must complete before: All other features (foundational)
- Must complete after: None (infrastructure prerequisite)
- Shares code with: WS-256 (Environment Variables), WS-257 (Monitoring Setup)

### ESTIMATED EFFORT
- Team A Frontend: 4 hours
- Team B Backend: 8 hours
- Team C Integration: 16 hours
- Team D Platform: 0 hours
- Team E General: 0 hours
- Team F Workflows: 0 hours
- Team G Performance: 8 hours
- Total: 36 hours