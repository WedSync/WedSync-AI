# TECHNICAL SPECIFICATION: WS-174 - Authentication Security Enhancements
## Generated by Feature Development Session - 2025-01-24

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding supplier storing sensitive client data
**I want to:** Strong authentication with multi-factor security
**So that:** Client personal information and wedding details remain protected from unauthorized access

### SPECIFICATION SOURCE
- **Feature ID:** WS-174
- **Original Spec:** /CORE-SPECIFICATIONS/10-SECURITY-COMPLIANCE/01-authentication-security md.md
- **Current Implementation:** 0% complete
- **Files to Create:**
  - /src/lib/auth/mfa-manager.ts
  - /src/lib/auth/session-security.ts
  - /src/lib/auth/password-policy.ts
  - /src/components/auth/MFASetup.tsx

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- MFA configurations
CREATE TABLE IF NOT EXISTS user_mfa (
  user_id UUID REFERENCES user_profiles(id) PRIMARY KEY,
  enabled BOOLEAN DEFAULT false,
  secret TEXT,
  backup_codes TEXT[],
  method TEXT CHECK (method IN ('totp', 'sms', 'email')),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Session security
CREATE TABLE IF NOT EXISTS user_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES user_profiles(id),
  token_hash TEXT NOT NULL,
  ip_address INET,
  user_agent TEXT,
  expires_at TIMESTAMPTZ NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### API Endpoints Required
```typescript
// POST /api/auth/mfa/setup
interface MFASetupResponse {
  secret: string;
  qrCode: string;
  backupCodes: string[];
}

// POST /api/auth/mfa/verify
interface MFAVerifyRequest {
  token: string;
}
```

### CODE EXAMPLES

#### Example 1: MFA Implementation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { authenticator } from 'otplib';
import QRCode from 'qrcode';

export class MFAManager {
  async setupTOTP(userId: string): Promise<{
    secret: string;
    qrCode: string;
    backupCodes: string[];
  }> {
    const secret = authenticator.generateSecret();
    const service = 'WedSync';
    const account = await getUserEmail(userId);
    
    const otpauth = authenticator.keyuri(account, service, secret);
    const qrCode = await QRCode.toDataURL(otpauth);
    
    const backupCodes = Array.from({ length: 10 }, () => 
      Math.random().toString(36).substring(2, 8).toUpperCase()
    );
    
    await supabase
      .from('user_mfa')
      .upsert({
        user_id: userId,
        secret,
        backup_codes: backupCodes,
        method: 'totp'
      });
    
    return { secret, qrCode, backupCodes };
  }
  
  async verifyTOTP(userId: string, token: string): Promise<boolean> {
    const { data: mfa } = await supabase
      .from('user_mfa')
      .select('secret, backup_codes')
      .eq('user_id', userId)
      .single();
    
    if (!mfa) return false;
    
    // Check TOTP token
    const isValid = authenticator.verify({
      token,
      secret: mfa.secret
    });
    
    if (isValid) return true;
    
    // Check backup codes
    const isBackupCode = mfa.backup_codes?.includes(token);
    if (isBackupCode) {
      // Remove used backup code
      const updatedCodes = mfa.backup_codes.filter(code => code !== token);
      await supabase
        .from('user_mfa')
        .update({ backup_codes: updatedCodes })
        .eq('user_id', userId);
      return true;
    }
    
    return false;
  }
}
```

### MCP SERVER USAGE
- [ ] Context7: Load docs for authentication libraries
- [ ] PostgreSQL: Create security tables
- [ ] Supabase: Configure auth policies

### ACCEPTANCE CRITERIA
- [ ] MFA setup flow works with TOTP apps
- [ ] Backup codes generated and validated
- [ ] Session management prevents hijacking
- [ ] Password policies enforced
- [ ] Security headers implemented
- [ ] Failed login attempts rate limited
- [ ] Account lockout after failed attempts

### DEPENDENCIES
- Must complete after: Base authentication system
- Must complete before: WS-175 (Data Encryption)
- Shares code with: WS-176 (GDPR), WS-177 (Audit)

### ESTIMATED EFFORT
- Team B Backend: 20 hours
- Team D Security: 16 hours
- Total: 36 hours