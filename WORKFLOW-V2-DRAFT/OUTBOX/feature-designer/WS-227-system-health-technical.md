# TECHNICAL SPECIFICATION: WS-227 - System Health
## Generated by Feature Development Session - 2025-01-25

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Platform technical administrator  
**I want to:** Monitor all system services and infrastructure health in real-time
**So that:** I can detect and resolve issues before they impact wedding suppliers and couples during critical planning moments

**Real Wedding Scenario:**
During peak wedding season, a database slowdown could prevent a photographer from accessing client details hours before a wedding shoot. The system health dashboard alerts the admin within 30 seconds, allowing immediate remediation before couples notice any service disruption.

### SPECIFICATION SOURCE
- **Feature ID:** WS-227
- **Original Spec:** /CORE-SPECIFICATIONS/07-ADMIN-DASHBOARD/01-Overview/02-system-health md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** None (new feature)
- **New Files to Create:**
  - /src/app/(dashboard)/admin/health/page.tsx
  - /src/components/admin/SystemHealthDashboard.tsx
  - /src/components/admin/ServiceCard.tsx
  - /src/components/admin/PerformanceChart.tsx
  - /src/lib/services/health-monitor.ts
  - /src/lib/services/alert-manager.ts
  - /src/hooks/useSystemHealth.ts

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Health check logs for service monitoring
CREATE TABLE health_checks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  service TEXT NOT NULL,
  status TEXT NOT NULL,
  latency INTEGER,
  error_message TEXT,
  metadata JSONB,
  checked_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_health_checks_service ON health_checks(service, checked_at DESC);
CREATE INDEX idx_health_checks_status ON health_checks(status, checked_at DESC);

-- System metrics for performance tracking
CREATE TABLE system_metrics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  metric_type TEXT NOT NULL,
  value DECIMAL NOT NULL,
  metadata JSONB,
  recorded_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_system_metrics_type ON system_metrics(metric_type, recorded_at DESC);
```

#### API Endpoints Required
```typescript
// GET /api/admin/health
interface SystemHealthResponse {
  success: boolean;
  data: {
    infrastructure: {
      serverUptime: number; // Percentage
      responseTime: number; // Milliseconds  
      cpuUsage: number;
      memoryUsage: number;
      diskSpace: number;
    };
    services: {
      database: ServiceStatus;
      redis: ServiceStatus;
      emailService: ServiceStatus;
      smsService: ServiceStatus;
      supabase: ServiceStatus;
    };
    apiHealth: {
      requestsPerMinute: number;
      errorRate: number;
      p95ResponseTime: number;
      p99ResponseTime: number;
    };
    jobQueue: {
      pending: number;
      processing: number;
      failed: number;
      completed24h: number;
    };
  };
  lastUpdated: string;
}

interface ServiceStatus {
  status: 'healthy' | 'degraded' | 'down';
  latency: number;
  lastCheck: string;
  errorCount24h: number;
}
```

#### Frontend Components Required
```typescript
// Component: SystemHealthDashboard
// Location: /src/components/admin/SystemHealthDashboard.tsx

interface SystemHealthProps {
  realtime?: boolean;
  refreshInterval?: number;
}

// Key functionality:
- Real-time health status monitoring
- Service availability indicators with color coding
- Performance charts for response times
- Alert threshold management
- Historical trend analysis
```

#### Integration Points
```typescript
// Service: HealthMonitor
// Dependencies: Database, Redis, External APIs

class HealthMonitor {
  private checks = new Map<string, HealthCheck>();
  
  async checkAllServices(): Promise<SystemHealth> {
    const results = await Promise.allSettled([
      this.checkDatabase(),
      this.checkRedis(), 
      this.checkSupabase(),
      this.checkEmailService(),
      this.checkInfrastructure()
    ]);
    
    return this.aggregateResults(results);
  }
  
  private async checkDatabase(): Promise<ServiceStatus> {
    const start = Date.now();
    try {
      await supabase.from('health_checks').select('id').limit(1);
      return {
        status: 'healthy',
        latency: Date.now() - start,
        lastCheck: new Date(),
        errorCount24h: await this.getErrorCount('database')
      };
    } catch (error) {
      await this.logHealthCheck('database', 'down', -1, error.message);
      return {
        status: 'down',
        latency: -1,
        lastCheck: new Date(),
        errorCount24h: await this.getErrorCount('database')
      };
    }
  }
}
```

### CODE EXAMPLES

#### Example 1: Health Monitor Service
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { createClient } from '@supabase/supabase-js';
import { AlertManager } from './alert-manager';

export class HealthMonitor {
  private supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
  );
  private alertManager = new AlertManager();

  async performHealthCheck(): Promise<SystemHealth> {
    const startTime = Date.now();
    
    try {
      const [infrastructure, services, apiHealth, jobQueue] = await Promise.allSettled([
        this.checkInfrastructure(),
        this.checkAllServices(),
        this.checkApiHealth(),
        this.checkJobQueue()
      ]);
      
      const health: SystemHealth = {
        infrastructure: infrastructure.status === 'fulfilled' ? infrastructure.value : this.getDefaultInfrastructure(),
        services: services.status === 'fulfilled' ? services.value : this.getDefaultServices(),
        apiHealth: apiHealth.status === 'fulfilled' ? apiHealth.value : this.getDefaultApiHealth(),
        jobQueue: jobQueue.status === 'fulfilled' ? jobQueue.value : this.getDefaultJobQueue()
      };
      
      // Check alert thresholds
      await this.alertManager.checkThresholds(health);
      
      // Log health check
      await this.logHealthCheck('system', 'healthy', Date.now() - startTime);
      
      return health;
    } catch (error) {
      console.error('Health check failed:', error);
      await this.logHealthCheck('system', 'down', Date.now() - startTime, error.message);
      throw new Error('System health check failed');
    }
  }
  
  private async checkDatabase(): Promise<ServiceStatus> {
    const start = Date.now();
    try {
      const { error } = await this.supabase.from('health_checks').select('id').limit(1);
      if (error) throw error;
      
      return {
        status: 'healthy',
        latency: Date.now() - start,
        lastCheck: new Date().toISOString(),
        errorCount24h: await this.getErrorCount('database')
      };
    } catch (error) {
      return {
        status: 'down',
        latency: -1,
        lastCheck: new Date().toISOString(),
        errorCount24h: await this.getErrorCount('database')
      };
    }
  }
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for monitoring best practices
- [x] Playwright: Test health dashboard UI
- [x] PostgreSQL: Execute health check queries

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/vercel/next.js", "api routes monitoring", 2000);
await mcp__context7__get-library-docs("/supabase/supabase", "database health monitoring", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('HealthMonitor', () => {
  it('should check database connectivity', async () => {
    const monitor = new HealthMonitor();
    const status = await monitor.checkDatabase();
    
    expect(status).toBeDefined();
    expect(['healthy', 'degraded', 'down']).toContain(status.status);
    expect(typeof status.latency).toBe('number');
  });
  
  it('should handle service failures gracefully', async () => {
    // Mock service failure
    const health = await monitor.performHealthCheck();
    expect(health).toBeDefined();
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('System health dashboard displays service statuses', async () => {
  await mcp__playwright__browser_navigate({url: '/admin/health'});
  await mcp__playwright__browser_snapshot();
  
  // Verify service cards are visible
  const dbStatus = await page.locator('[data-testid="database-status"]');
  await expect(dbStatus).toBeVisible();
  
  // Test auto-refresh functionality
  await page.waitForTimeout(5000);
  await expect(page.locator('[data-testid="last-updated"]')).toContainText('seconds ago');
});
```

### ACCEPTANCE CRITERIA
- [x] Health checks complete within 5 seconds
- [x] Service status updates every 30 seconds automatically
- [x] Color-coded status indicators (green=healthy, yellow=degraded, red=down)
- [x] Alert thresholds trigger notifications to admin team
- [x] Performance metrics display with trend charts
- [x] 24-hour error count tracking for all services
- [x] Mobile-responsive design for on-call monitoring
- [x] Admin authentication required for access

### DEPENDENCIES
- Must complete after: WS-226 (Executive Metrics)
- Must complete before: WS-228 (Alert System)
- Shares code with: WS-354 (Realtime Monitoring System)

### ESTIMATED EFFORT
- Team A Frontend: 14 hours
- Team B Backend: 18 hours
- Team C Integration: 8 hours
- Team D Platform: 0 hours
- Team E General: 6 hours
- Team F Workflows: 0 hours
- Team G Performance: 6 hours
- Total: 52 hours