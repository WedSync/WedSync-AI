# TECHNICAL SPECIFICATION: WS-062 - SMS Configuration
## Generated by Feature Development Session - August 21, 2025

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding venue coordinator
**I want to:** Send timely SMS reminders and updates to couples about venue requirements, timeline changes, and day-of logistics
**So that:** I can ensure couples receive critical information instantly (98% SMS open rate vs 22% email) and reduce last-minute confusion that causes wedding day delays

**Real Wedding Scenario:**
A venue coordinator needs to notify 15 couples about a required final headcount confirmation 72 hours before their weddings. Instead of calling each couple individually (30+ minutes), they send personalized SMS messages with merge fields like "Hi {{couple_names}}, please confirm your final guest count of {{estimated_guests}} for {{venue_name}} by {{deadline_date}}." All couples receive and respond within hours.

### SPECIFICATION SOURCE
- **Feature ID:** WS-062
- **Original Spec:** /CORE-SPECIFICATIONS/02-WEDSYNC-SUPPLIER-PLATFORM/06-Communications/02-sms-configuration md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** 
  - `/wedsync/src/lib/services/sms-service.ts`
  - `/wedsync/src/app/api/sms/route.ts`
- **New Files to Create:** 
  - `/wedsync/src/components/communications/SMSConfiguration.tsx`
  - `/wedsync/src/components/communications/SMSTemplateEditor.tsx`
  - `/wedsync/src/components/communications/SMSCompliance.tsx`
  - `/wedsync/src/types/sms.ts`
  - `/wedsync/supabase/migrations/025_sms_configuration_system.sql`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- SMS configuration per supplier
CREATE TABLE IF NOT EXISTS sms_configurations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  twilio_account_sid VARCHAR(255) NOT NULL,
  twilio_auth_token_encrypted TEXT NOT NULL, -- Encrypted storage
  twilio_phone_number VARCHAR(20) NOT NULL,
  messaging_service_sid VARCHAR(255),
  status_callback_url TEXT,
  is_active BOOLEAN DEFAULT false,
  configuration_verified BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- SMS templates (extends email template concept)
CREATE TABLE IF NOT EXISTS sms_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  category sms_template_category NOT NULL,
  message_content TEXT NOT NULL,
  merge_fields JSONB DEFAULT '[]'::jsonb,
  character_count INTEGER NOT NULL,
  segment_count INTEGER NOT NULL,
  has_unicode BOOLEAN DEFAULT false,
  is_favorite BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TYPE sms_template_category AS ENUM (
  'reminder',
  'confirmation', 
  'timeline_update',
  'logistics',
  'emergency',
  'follow_up',
  'custom'
);

-- SMS delivery tracking
CREATE TABLE IF NOT EXISTS sms_messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  client_id UUID REFERENCES clients(id) ON DELETE CASCADE,
  template_id UUID REFERENCES sms_templates(id) ON DELETE SET NULL,
  twilio_message_sid VARCHAR(255) UNIQUE,
  recipient_phone VARCHAR(20) NOT NULL,
  message_content TEXT NOT NULL,
  character_count INTEGER NOT NULL,
  segment_count INTEGER NOT NULL,
  cost_per_segment DECIMAL(6,4),
  total_cost DECIMAL(10,2),
  status sms_status DEFAULT 'queued',
  error_code VARCHAR(10),
  error_message TEXT,
  sent_at TIMESTAMPTZ,
  delivered_at TIMESTAMPTZ,
  failed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TYPE sms_status AS ENUM (
  'queued',
  'sending', 
  'sent',
  'delivered',
  'undelivered',
  'failed'
);

-- SMS compliance and opt-in management
CREATE TABLE IF NOT EXISTS sms_opt_ins (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  client_id UUID REFERENCES clients(id) ON DELETE CASCADE,
  phone_number VARCHAR(20) NOT NULL,
  opted_in_at TIMESTAMPTZ DEFAULT NOW(),
  opted_out_at TIMESTAMPTZ,
  opt_in_method VARCHAR(50) DEFAULT 'manual', -- 'manual', 'form', 'keyword'
  is_active BOOLEAN DEFAULT true,
  UNIQUE(user_id, phone_number)
);

-- SMS usage tracking for cost management
CREATE TABLE IF NOT EXISTS sms_usage_tracking (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  month_year VARCHAR(7) NOT NULL, -- 'YYYY-MM'
  messages_sent INTEGER DEFAULT 0,
  total_segments INTEGER DEFAULT 0,
  total_cost DECIMAL(10,2) DEFAULT 0.00,
  budget_limit DECIMAL(10,2),
  budget_alert_sent BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, month_year)
);

-- RLS policies
ALTER TABLE sms_configurations ENABLE ROW LEVEL SECURITY;
ALTER TABLE sms_templates ENABLE ROW LEVEL SECURITY;
ALTER TABLE sms_messages ENABLE ROW LEVEL SECURITY;
ALTER TABLE sms_opt_ins ENABLE ROW LEVEL SECURITY;
ALTER TABLE sms_usage_tracking ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage their own SMS configuration" ON sms_configurations
  FOR ALL USING (auth.uid() = user_id);

CREATE POLICY "Users can manage their own SMS templates" ON sms_templates
  FOR ALL USING (auth.uid() = user_id);

CREATE POLICY "Users can access their own SMS messages" ON sms_messages
  FOR ALL USING (auth.uid() = user_id);

CREATE POLICY "Users can manage their own SMS opt-ins" ON sms_opt_ins
  FOR ALL USING (auth.uid() = user_id);

CREATE POLICY "Users can access their own SMS usage" ON sms_usage_tracking
  FOR ALL USING (auth.uid() = user_id);
```

#### API Endpoints Required
```typescript
// POST /api/sms/configure
interface ConfigureSMSRequest {
  twilioAccountSid: string;
  twilioAuthToken: string;
  twilioPhoneNumber: string;
  messagingServiceSid?: string;
}

interface ConfigureSMSResponse {
  success: boolean;
  data: {
    configurationId: string;
    verified: boolean;
    phoneNumber: string;
  };
}

// POST /api/sms/verify
interface VerifyConfigurationResponse {
  success: boolean;
  data: {
    verified: boolean;
    testMessageSent: boolean;
  };
}

// POST /api/sms/send
interface SendSMSRequest {
  clientId: string;
  templateId?: string;
  customMessage?: string;
  mergeData?: Record<string, any>;
  scheduleFor?: string; // ISO datetime
}

interface SendSMSResponse {
  success: boolean;
  data: {
    messageId: string;
    twilioMessageSid: string;
    characterCount: number;
    segmentCount: number;
    estimatedCost: number;
  };
}

// GET /api/sms/templates
interface GetSMSTemplatesResponse {
  success: boolean;
  data: {
    templates: SMSTemplate[];
    totalCount: number;
  };
}

// POST /api/sms/templates
interface CreateSMSTemplateRequest {
  name: string;
  category: SMSTemplateCategory;
  messageContent: string;
  mergeFields: string[];
}

// POST /api/sms/preview
interface PreviewSMSRequest {
  templateId: string;
  clientId: string;
  mergeData?: Record<string, any>;
}

interface PreviewSMSResponse {
  success: boolean;
  data: {
    messageContent: string;
    characterCount: number;
    segmentCount: number;
    hasUnicode: boolean;
    estimatedCost: number;
  };
}

// GET /api/sms/usage
interface GetSMSUsageResponse {
  success: boolean;
  data: {
    currentMonth: {
      messagesSent: number;
      totalCost: number;
      budgetLimit: number;
      remainingBudget: number;
    };
    recentMessages: SMSMessage[];
    dailyUsage: Array<{date: string; count: number; cost: number}>;
  };
}

// POST /api/sms/webhooks/status
interface TwilioStatusWebhookPayload {
  MessageSid: string;
  MessageStatus: string;
  ErrorCode?: string;
  ErrorMessage?: string;
}
```

#### Frontend Components Required
```typescript
// Component: SMSConfiguration
// Location: /src/components/communications/SMSConfiguration.tsx

interface SMSConfigurationProps {
  onConfigurationComplete: (config: SMSConfiguration) => void;
}

// Key functionality:
- Twilio credentials input with validation
- Phone number verification flow
- Test message sending capability
- Configuration status display
- Security warnings for credential storage
- Integration with existing email templates

// Component: SMSTemplateEditor  
// Location: /src/components/communications/SMSTemplateEditor.tsx

interface SMSTemplateEditorProps {
  template?: SMSTemplate;
  onSave: (template: Partial<SMSTemplate>) => Promise<void>;
  onPreview: (content: string, clientId: string) => Promise<SMSPreview>;
}

// Key functionality:
- Real-time character and segment counting
- Unicode character detection and warnings
- Merge field insertion (reuse from email templates)
- Live cost estimation per message
- Message preview with actual client data
- Template categorization for wedding workflows

// Component: SMSCompliance
// Location: /src/components/communications/SMSCompliance.tsx

interface SMSComplianceProps {
  clientId: string;
  onOptInStatusChange: (isOptedIn: boolean) => void;
}

// Key functionality:
- Opt-in/opt-out management per client
- STOP keyword handling display
- Time zone and sending restrictions
- Compliance status indicators
- Bulk opt-in import from client list
```

#### Integration Points
```typescript
// Service: SMSService (extends existing sms-service.ts)
// Dependencies: Twilio SDK, EmailTemplateService, ClientService

class SMSService {
  private twilio: Twilio;
  
  async sendSMS(
    recipient: string, 
    content: string, 
    clientId: string,
    templateId?: string
  ): Promise<SMSMessage> {
    // 1. Validate opt-in status for recipient
    // 2. Process content for character limits and segments
    // 3. Calculate cost before sending
    // 4. Send via Twilio with proper error handling
    // 5. Log delivery status and update usage tracking
  }

  async processTemplate(
    templateId: string, 
    clientData: any
  ): Promise<{content: string; characterCount: number; segmentCount: number}> {
    // 1. Fetch SMS template
    // 2. Reuse merge field logic from EmailTemplateService
    // 3. Apply SMS-specific formatting (character limits)
    // 4. Calculate segments and detect unicode
  }

  async handleStatusWebhook(twilioPayload: any): Promise<void> {
    // 1. Validate webhook signature
    // 2. Update message status in database
    // 3. Handle delivery failures and retries
    // 4. Update usage tracking for cost management
  }

  async validateOptInStatus(phone: string, userId: string): Promise<boolean> {
    // 1. Check opt-in table for phone number
    // 2. Handle STOP keyword detection
    // 3. Validate time-of-day and geographic restrictions
  }
}
```

### CODE EXAMPLES

#### Example 1: SMS Template Rendering with Character Counting
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { supabase } from '@/lib/supabase';
import { Twilio } from 'twilio';
import { SMSTemplate, SMSPreview } from '@/types/sms';

export async function renderSMSTemplate(
  templateId: string,
  clientId: string
): Promise<SMSPreview> {
  // Step 1: Fetch SMS template
  const { data: template, error: templateError } = await supabase
    .from('sms_templates')
    .select('*')
    .eq('id', templateId)
    .single();
    
  if (templateError) throw templateError;
  
  // Step 2: Get client data (reuse from email template service)
  const { data: client, error: clientError } = await supabase
    .from('clients')
    .select(`
      *,
      wedding_details:wedding_details(*)
    `)
    .eq('id', clientId)
    .single();
    
  if (clientError) throw clientError;
  
  // Step 3: Build merge data for SMS
  const mergeData = {
    '{{couple_names}}': `${client.partner1_name} & ${client.partner2_name}`,
    '{{wedding_date}}': new Date(client.wedding_date).toLocaleDateString(),
    '{{venue_name}}': client.wedding_details?.venue_name || 'TBD',
    '{{days_until}}': Math.ceil((new Date(client.wedding_date).getTime() - Date.now()) / (1000 * 60 * 60 * 24)),
    '{{deadline_date}}': new Date(Date.now() + (72 * 60 * 60 * 1000)).toLocaleDateString()
  };
  
  // Step 4: Render and analyze content
  let renderedContent = template.message_content;
  Object.entries(mergeData).forEach(([field, value]) => {
    const regex = new RegExp(field.replace(/[{}]/g, '\\$&'), 'g');
    renderedContent = renderedContent.replace(regex, String(value));
  });
  
  // Step 5: Calculate SMS metrics
  const characterCount = renderedContent.length;
  const hasUnicode = /[^\x00-\x7F]/.test(renderedContent);
  const maxSingleSegment = hasUnicode ? 70 : 160;
  const maxMultiSegment = hasUnicode ? 67 : 153;
  
  let segmentCount = 1;
  if (characterCount > maxSingleSegment) {
    segmentCount = Math.ceil(characterCount / maxMultiSegment);
  }
  
  // Step 6: Estimate cost (Twilio rates: $0.0075 per segment in US)
  const costPerSegment = 0.0075;
  const estimatedCost = segmentCount * costPerSegment;
  
  return {
    messageContent: renderedContent,
    characterCount,
    segmentCount,
    hasUnicode,
    estimatedCost
  };
}

export async function sendSMSWithCompliance(
  recipientPhone: string,
  content: string,
  userId: string,
  clientId: string
): Promise<void> {
  // Step 1: Validate opt-in status
  const { data: optIn } = await supabase
    .from('sms_opt_ins')
    .select('is_active')
    .eq('user_id', userId)
    .eq('phone_number', recipientPhone)
    .eq('is_active', true)
    .single();
    
  if (!optIn) {
    throw new Error('Recipient has not opted in to SMS communications');
  }
  
  // Step 2: Check time restrictions (9 AM - 9 PM local time)
  const currentHour = new Date().getHours();
  if (currentHour < 9 || currentHour > 21) {
    throw new Error('SMS sending restricted outside 9 AM - 9 PM hours');
  }
  
  // Step 3: Get Twilio config
  const { data: config } = await supabase
    .from('sms_configurations')
    .select('*')
    .eq('user_id', userId)
    .eq('is_active', true)
    .single();
    
  if (!config) {
    throw new Error('SMS not configured for this account');
  }
  
  // Step 4: Send via Twilio
  const twilio = new Twilio(config.twilio_account_sid, config.twilio_auth_token_encrypted);
  
  const message = await twilio.messages.create({
    body: content,
    from: config.twilio_phone_number,
    to: recipientPhone,
    statusCallback: `${process.env.NEXT_PUBLIC_APP_URL}/api/sms/webhooks/status`
  });
  
  // Step 5: Log message for tracking
  await supabase
    .from('sms_messages')
    .insert({
      user_id: userId,
      client_id: clientId,
      twilio_message_sid: message.sid,
      recipient_phone: recipientPhone,
      message_content: content,
      character_count: content.length,
      segment_count: calculateSegmentCount(content),
      status: 'sent'
    });
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for Twilio SDK, SMS compliance regulations
- [x] Filesystem: Access existing SMS service implementation
- [x] Memory: Store SMS template patterns and compliance requirements

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/twilio/twilio-node", "sms messaging", 3000);
await mcp__context7__get-library-docs("/vercel/next.js", "api routes webhooks", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('SMSService', () => {
  it('should calculate SMS segments correctly for unicode content', () => {
    const content = 'Hello 👰‍♀️ Wedding reminder for June 15th';
    const result = calculateSMSMetrics(content);
    expect(result.hasUnicode).toBe(true);
    expect(result.segmentCount).toBe(1);
  });

  it('should respect opt-in compliance before sending', async () => {
    await expect(
      sendSMSWithCompliance('+1234567890', 'Test', 'user-123', 'client-456')
    ).rejects.toThrow('Recipient has not opted in');
  });

  it('should merge wedding data into SMS templates', async () => {
    const preview = await renderSMSTemplate('template-123', 'client-456');
    expect(preview.messageContent).toContain('John & Jane');
    expect(preview.estimatedCost).toBeGreaterThan(0);
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('SMS configuration and template sending', async () => {
  await mcp__playwright__browser_navigate({url: '/communications/sms/setup'});
  
  // Configure Twilio credentials
  await mcp__playwright__browser_type({
    element: 'account SID input',
    ref: 'input[name="twilioAccountSid"]',
    text: 'AC123test456'
  });
  
  await mcp__playwright__browser_type({
    element: 'auth token input', 
    ref: 'input[name="twilioAuthToken"]',
    text: 'test_token_123'
  });
  
  // Verify configuration
  await mcp__playwright__browser_click({element: 'verify button', ref: 'button[data-testid="verify-config"]'});
  await mcp__playwright__browser_wait_for({text: 'Configuration verified'});
  
  // Create SMS template
  await mcp__playwright__browser_navigate({url: '/communications/sms/templates'});
  await mcp__playwright__browser_click({element: 'create template button', ref: 'button[data-testid="create-sms-template"]'});
  
  await mcp__playwright__browser_type({
    element: 'message content textarea',
    ref: 'textarea[name="messageContent"]', 
    text: 'Hi {{couple_names}}, reminder: {{days_until}} days until your wedding at {{venue_name}}!'
  });
  
  // Verify character count and preview
  await mcp__playwright__browser_click({element: 'preview button', ref: 'button[data-testid="preview-sms"]'});
  await mcp__playwright__browser_wait_for({text: 'Character count: 89'});
  
  // Verify accessibility
  await mcp__playwright__browser_evaluate({
    function: '() => axe.run()'
  });
});
```

### ACCEPTANCE CRITERIA
- [x] Twilio SMS configuration with credential verification
- [x] SMS templates with wedding-specific merge fields
- [x] Real-time character counting and segment calculation
- [x] Unicode detection with cost warnings
- [x] Opt-in/opt-out compliance management per client
- [x] Performance: SMS sending completes within 2 seconds
- [x] Security: Twilio credentials encrypted at rest
- [x] Accessibility: SMS interface meets WCAG 2.1 AA standards

### DEPENDENCIES
- Must complete after: WS-061 (Email Templates System)
- Must complete before: WS-063 (WhatsApp Setup), WS-026 (Bulk Messaging)
- Shares code with: Email template service, client data services, communication infrastructure

### ESTIMATED EFFORT
- Team B Backend: 20 hours (Twilio integration, compliance, webhooks, encryption)
- Team C Integration: 12 hours (Template system integration, merge field processing)
- Team A Frontend: 16 hours (Configuration UI, template editor, compliance dashboard)
- Total: 48 hours