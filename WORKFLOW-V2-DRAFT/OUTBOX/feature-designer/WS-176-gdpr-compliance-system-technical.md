# TECHNICAL SPECIFICATION: WS-176 - GDPR Compliance System
## Generated by Feature Development Session - 2025-01-24

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding supplier processing EU guest data
**I want to:** Automated GDPR compliance for consent, deletion, and data requests
**So that:** I meet legal requirements without manual privacy management overhead

### SPECIFICATION SOURCE
- **Feature ID:** WS-176
- **Original Spec:** /CORE-SPECIFICATIONS/10-SECURITY-COMPLIANCE/03-gdpr-compliance md.md
- **Current Implementation:** 0% complete
- **Files to Create:**
  - /src/lib/gdpr/consent-manager.ts
  - /src/lib/gdpr/data-processor.ts
  - /src/lib/gdpr/deletion-engine.ts
  - /src/components/gdpr/ConsentBanner.tsx
  - /src/app/api/gdpr/data-request/route.ts

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- GDPR consent tracking
CREATE TABLE IF NOT EXISTS gdpr_consent (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID,
  email TEXT,
  consent_type TEXT CHECK (consent_type IN ('marketing', 'analytics', 'functional')),
  granted BOOLEAN NOT NULL,
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Data processing requests
CREATE TABLE IF NOT EXISTS gdpr_requests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email TEXT NOT NULL,
  request_type TEXT CHECK (request_type IN ('access', 'rectification', 'erasure', 'portability')),
  status TEXT CHECK (status IN ('pending', 'processing', 'completed', 'rejected')),
  verification_token TEXT,
  processed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_gdpr_consent_user ON gdpr_consent(user_id);
CREATE INDEX idx_gdpr_requests_email ON gdpr_requests(email);
```

#### API Endpoints Required
```typescript
// POST /api/gdpr/consent
interface ConsentRequest {
  consentTypes: Array<{
    type: 'marketing' | 'analytics' | 'functional';
    granted: boolean;
  }>;
  email?: string;
}

// POST /api/gdpr/data-request
interface DataRequestRequest {
  email: string;
  requestType: 'access' | 'rectification' | 'erasure' | 'portability';
  details?: string;
}

interface DataRequestResponse {
  requestId: string;
  verificationRequired: boolean;
  estimatedCompletion: string;
}
```

### CODE EXAMPLES

#### Example 1: Data Deletion Engine
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
export class GDPRDeletionEngine {
  async processErasureRequest(email: string): Promise<{
    deleted: string[];
    retained: string[];
    reason: string;
  }> {
    const deletedTables: string[] = [];
    const retainedTables: string[] = [];
    
    // Define tables and retention rules
    const deletionRules = {
      'user_profiles': { delete: true, cascade: true },
      'guest_lists': { delete: true, anonymize: ['name', 'email'] },
      'form_responses': { delete: false, reason: 'Legal obligation' },
      'payments': { delete: false, reason: 'Tax records retention' }
    };
    
    for (const [table, rule] of Object.entries(deletionRules)) {
      if (rule.delete) {
        if (rule.anonymize) {
          // Anonymize instead of delete
          await this.anonymizeData(table, email, rule.anonymize);
          deletedTables.push(`${table} (anonymized)`);
        } else {
          // Hard delete
          await this.deleteData(table, email);
          deletedTables.push(table);
        }
      } else {
        retainedTables.push(`${table}: ${rule.reason}`);
      }
    }
    
    return {
      deleted: deletedTables,
      retained: retainedTables,
      reason: 'GDPR Article 17 - Right to erasure'
    };
  }
  
  private async anonymizeData(
    table: string, 
    email: string, 
    fields: string[]
  ): Promise<void> {
    const anonymizedValues = fields.reduce((acc, field) => {
      acc[field] = field === 'email' ? 'anonymized@deleted.local' : '[DELETED]';
      return acc;
    }, {} as Record<string, string>);
    
    await supabase
      .from(table)
      .update(anonymizedValues)
      .eq('email', email);
  }
}
```

### MCP SERVER USAGE
- [ ] Context7: Load docs for GDPR libraries
- [ ] PostgreSQL: Create compliance tables
- [ ] Supabase: Configure data retention policies

### ACCEPTANCE CRITERIA
- [ ] Consent banners appear and record choices
- [ ] Data subject access requests automated
- [ ] Right to erasure processes correctly
- [ ] Data portability exports complete
- [ ] Consent withdrawal honored immediately
- [ ] Legal basis tracking implemented
- [ ] Breach notification system ready
- [ ] Privacy policy integration complete

### DEPENDENCIES
- Must complete after: WS-175 (Data Encryption)
- Must complete before: WS-177 (Audit Logging)
- Shares code with: WS-177 (Audit), WS-178 (Backup)

### ESTIMATED EFFORT
- Team E Full-stack: 28 hours
- Team D Security: 20 hours
- Total: 48 hours