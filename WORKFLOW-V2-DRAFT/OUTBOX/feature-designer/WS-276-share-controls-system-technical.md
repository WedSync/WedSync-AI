# TECHNICAL SPECIFICATION: WS-276 - Share Controls System
## Generated by Feature Development Session - 2025-09-02

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Couple using WedMe timeline builder to coordinate their wedding
**I want to:** Control exactly what information each wedding stakeholder can see on my timeline
**So that:** My photographer only sees photo-related events, my caterer only sees meal information, and guests get a simple ceremony overview - protecting privacy while keeping everyone informed

**Real Wedding Scenario:**
Emma and James have created their master wedding timeline with private notes about family drama, detailed vendor costs, and intimate ceremony details. They want to share different views: guests get ceremony time and reception location, photographers see full timeline minus costs, caterers see meal events and headcount, while keeping private family coordination notes completely hidden. The system generates secure, time-limited share links with exactly the right information for each stakeholder.

### SPECIFICATION SOURCE
- **Feature ID:** WS-276
- **Original Spec:** /CORE-SPECIFICATIONS/03-WEDME-COUPLE-PLATFORM/07-Timeline-Builder/04-share-controls md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** 
  - /wedsync/src/app/(dashboard)/wedme/timeline/[id]/page.tsx
  - /wedsync/src/components/timeline/TimelineBuilder.tsx
- **New Files to Create:** 
  - /wedsync/src/components/timeline/ShareControlsModal.tsx
  - /wedsync/src/components/timeline/StakeholderPermissions.tsx
  - /wedsync/src/components/timeline/ShareLinkGenerator.tsx
  - /wedsync/src/lib/timeline/sharing-permissions.ts
  - /wedsync/src/app/api/timeline/[id]/sharing/route.ts
  - /wedsync/src/app/timeline/view/[token]/page.tsx

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Timeline sharing permissions and access control
CREATE TABLE IF NOT EXISTS timeline_shares (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  timeline_id UUID NOT NULL REFERENCES timelines(id) ON DELETE CASCADE,
  couple_id UUID NOT NULL REFERENCES couples(id),
  token TEXT NOT NULL UNIQUE,
  share_name TEXT NOT NULL, -- "Wedding Party Access", "Vendor View", etc.
  stakeholder_type TEXT NOT NULL CHECK (stakeholder_type IN ('supplier', 'helper', 'guest', 'coordinator')),
  stakeholder_email TEXT,
  stakeholder_user_id UUID,
  
  -- Share settings
  public_url TEXT UNIQUE,
  expires_at TIMESTAMPTZ NOT NULL DEFAULT (NOW() + INTERVAL '30 days'),
  password_protected BOOLEAN DEFAULT FALSE,
  password_hash TEXT,
  is_active BOOLEAN DEFAULT TRUE,
  
  -- Permissions matrix
  permissions JSONB NOT NULL DEFAULT '{
    "view_full_timeline": false,
    "view_supplier_details": false,
    "view_helper_assignments": false,
    "view_private_notes": false,
    "view_budget_info": false,
    "can_comment": false,
    "can_suggest_changes": false
  }',
  
  -- Custom view settings
  custom_view JSONB DEFAULT '{
    "show_events": [],
    "hide_details": [],
    "time_range": null
  }',
  
  -- Access tracking
  access_log JSONB DEFAULT '[]',
  view_count INTEGER DEFAULT 0,
  last_viewed_at TIMESTAMPTZ,
  last_viewer_ip TEXT,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes for performance
CREATE INDEX idx_timeline_shares_timeline_id ON timeline_shares(timeline_id);
CREATE INDEX idx_timeline_shares_token ON timeline_shares(token);
CREATE INDEX idx_timeline_shares_stakeholder_email ON timeline_shares(stakeholder_email);
CREATE INDEX idx_timeline_shares_expires_at ON timeline_shares(expires_at);

-- Share access audit log
CREATE TABLE IF NOT EXISTS timeline_share_access_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  share_id UUID NOT NULL REFERENCES timeline_shares(id) ON DELETE CASCADE,
  accessed_at TIMESTAMPTZ DEFAULT NOW(),
  viewer_ip TEXT,
  user_agent TEXT,
  action TEXT NOT NULL, -- 'view', 'download', 'comment', etc.
  details JSONB DEFAULT '{}'
);
```

#### API Endpoints Required
```typescript
// POST /api/timeline/[id]/sharing - Create share link
interface CreateShareRequest {
  timeline_id: string;
  share_name: string;
  stakeholder_type: 'supplier' | 'helper' | 'guest' | 'coordinator';
  stakeholder_email?: string;
  expires_in_days: number;
  password_protected: boolean;
  password?: string;
  permissions: {
    view_full_timeline: boolean;
    view_supplier_details: boolean;
    view_helper_assignments: boolean;
    view_private_notes: boolean;
    view_budget_info: boolean;
    can_comment: boolean;
    can_suggest_changes: boolean;
  };
  custom_view?: {
    show_events: string[];
    hide_details: string[];
    time_range?: { start: string; end: string; };
  };
}

interface ShareResponse {
  success: boolean;
  share: {
    id: string;
    token: string;
    share_url: string;
    qr_code_url: string;
    expires_at: string;
  };
}

// GET /api/timeline/[id]/sharing - List all shares for timeline
interface ShareListResponse {
  success: boolean;
  shares: Array<{
    id: string;
    share_name: string;
    stakeholder_type: string;
    stakeholder_email: string;
    expires_at: string;
    is_active: boolean;
    view_count: number;
    last_viewed_at: string;
  }>;
}

// DELETE /api/timeline/[id]/sharing/[shareId] - Revoke access
// PUT /api/timeline/[id]/sharing/[shareId] - Update permissions
```

#### Frontend Components Required
```typescript
// Component: ShareControlsModal
// Location: /src/components/timeline/ShareControlsModal.tsx

interface ShareControlsModalProps {
  timelineId: string;
  isOpen: boolean;
  onClose: () => void;
  onShareCreated: (share: ShareLink) => void;
}

// Key functionality:
// - Permission matrix interface with intuitive toggles
// - Stakeholder type selection with appropriate defaults
// - Preview mode showing filtered timeline view
// - Share link generation with QR code
// - Password protection controls
// - Expiry date selection

// Component: StakeholderPermissions
// Location: /src/components/timeline/StakeholderPermissions.tsx

interface StakeholderPermissionsProps {
  stakeholderType: 'supplier' | 'helper' | 'guest' | 'coordinator';
  permissions: SharePermissions;
  onChange: (permissions: SharePermissions) => void;
  timelineEvents: TimelineEvent[];
}

// Key functionality:
// - Smart permission templates based on stakeholder type
// - Custom event visibility controls
// - Field-level hiding capabilities
// - Permission conflict warnings

// Component: ShareLinkGenerator
// Location: /src/components/timeline/ShareLinkGenerator.tsx

interface ShareLinkGeneratorProps {
  shareData: CreateShareRequest;
  onGenerate: (shareLink: ShareResponse) => void;
}

// Key functionality:
// - Secure token generation
// - QR code creation for mobile sharing
// - Copy-to-clipboard functionality
// - Email invitation sending
// - Preview link testing
```

#### Integration Points
```typescript
// Service: TimelineSharingService
// Dependencies: Supabase Auth, QR Code Generator, Email Service

class TimelineSharingService {
  async createShare(request: CreateShareRequest): Promise<ShareResponse> {
    // Generate secure token
    const token = generateSecureToken(32);
    
    // Hash password if provided
    const passwordHash = request.password 
      ? await bcrypt.hash(request.password, 10) 
      : null;
    
    // Calculate expiry date
    const expiresAt = addDays(new Date(), request.expires_in_days);
    
    // Insert share record
    const { data: share, error } = await supabase
      .from('timeline_shares')
      .insert({
        timeline_id: request.timeline_id,
        token,
        share_name: request.share_name,
        stakeholder_type: request.stakeholder_type,
        stakeholder_email: request.stakeholder_email,
        expires_at: expiresAt,
        password_protected: request.password_protected,
        password_hash: passwordHash,
        permissions: request.permissions,
        custom_view: request.custom_view
      })
      .select()
      .single();
    
    if (error) throw new Error('Failed to create share');
    
    // Generate share URL and QR code
    const shareUrl = `${process.env.NEXT_PUBLIC_APP_URL}/timeline/view/${token}`;
    const qrCodeUrl = await generateQRCode(shareUrl);
    
    return {
      success: true,
      share: {
        id: share.id,
        token,
        share_url: shareUrl,
        qr_code_url: qrCodeUrl,
        expires_at: share.expires_at
      }
    };
  }

  async validateAccess(token: string, password?: string): Promise<ShareAccess> {
    const { data: share } = await supabase
      .from('timeline_shares')
      .select('*, timelines(*)')
      .eq('token', token)
      .eq('is_active', true)
      .single();
    
    if (!share || new Date(share.expires_at) < new Date()) {
      throw new Error('Share link expired or invalid');
    }
    
    if (share.password_protected && password) {
      const validPassword = await bcrypt.compare(password, share.password_hash);
      if (!validPassword) {
        throw new Error('Invalid password');
      }
    }
    
    // Log access
    await this.logAccess(share.id, 'view');
    
    return { share, timeline: share.timelines };
  }

  async getFilteredTimeline(share: TimelineShare): Promise<FilteredTimeline> {
    // Apply permission filters to timeline data
    // Hide restricted events, fields, and details based on permissions
    // Return sanitized timeline view for stakeholder
  }
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Ref MCP: Search for QR code generation libraries, bcrypt usage patterns
- [x] Supabase MCP: Database operations, RLS policies for sharing
- [x] Browser MCP: Test sharing flows and permission previews
- [x] Sequential Thinking MCP: Complex permission logic planning

#### Ref MCP Searches Needed
```bash
# Use Ref MCP to search for:
# - "Next.js secure token generation best practices"
# - "QR code generation React components"
# - "Supabase Row Level Security sharing patterns"
# - "bcrypt password hashing Next.js"
```

#### Browser MCP Interactive Testing
```bash
# Use Browser MCP for:
# - Test permission matrix interface usability
# - Verify filtered timeline views display correctly
# - Test share link access and password protection
# - Validate mobile QR code scanning functionality
# - Verify access logs recording properly
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('TimelineSharingService', () => {
  it('should create secure share link with correct permissions', async () => {
    const request = {
      timeline_id: 'test-timeline-id',
      share_name: 'Vendor Access',
      stakeholder_type: 'supplier',
      permissions: { view_supplier_details: true }
    };
    
    const result = await sharingService.createShare(request);
    
    expect(result.success).toBe(true);
    expect(result.share.share_url).toContain('/timeline/view/');
    expect(result.share.token).toHaveLength(32);
  });

  it('should validate password-protected share access', async () => {
    const shareAccess = await sharingService.validateAccess(token, 'correct-password');
    expect(shareAccess.share).toBeDefined();
    
    await expect(
      sharingService.validateAccess(token, 'wrong-password')
    ).rejects.toThrow('Invalid password');
  });

  it('should filter timeline based on permissions', async () => {
    const filteredTimeline = await sharingService.getFilteredTimeline(guestShare);
    
    expect(filteredTimeline.events).not.toContain(privateEvent);
    expect(filteredTimeline.events[0]).not.toHaveProperty('budget_details');
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP for comprehensive sharing workflow testing
test('Share timeline with vendor permissions', async () => {
  await mcp__playwright__browser_navigate({url: '/wedme/timeline/123'});
  await mcp__playwright__browser_click({selector: '[data-testid="share-timeline-btn"]'});
  
  // Select vendor stakeholder type
  await mcp__playwright__browser_click({selector: '[data-value="supplier"]'});
  
  // Configure permissions
  await mcp__playwright__browser_click({selector: '[data-testid="view-supplier-details"]'});
  
  // Generate share link
  await mcp__playwright__browser_click({selector: '[data-testid="generate-share-btn"]'});
  
  // Verify share link created
  const shareUrl = await page.locator('[data-testid="share-url"]').textContent();
  expect(shareUrl).toContain('/timeline/view/');
  
  await mcp__playwright__browser_snapshot();
});
```

### ACCEPTANCE CRITERIA
- [x] Permission matrix interface allows granular control over 7 different access levels
- [x] Stakeholder-specific permission templates (guest, supplier, helper, coordinator)
- [x] Secure token generation with 32-character cryptographically random tokens  
- [x] Password protection with bcrypt hashing (cost factor 10)
- [x] Automatic expiry with configurable timeframes (default 30 days)
- [x] QR code generation for mobile-friendly sharing
- [x] Access logging with IP tracking and view counts
- [x] Preview mode showing exactly what stakeholder will see
- [x] **Navigation Integration: Feature properly integrated into parent dashboard/navigation (MANDATORY for all UI features)**
  - [x] Timeline builder includes prominent "Share" button in toolbar
  - [x] Mobile navigation support for sharing controls via responsive modal
  - [x] Breadcrumbs show "Timeline > Share Controls" path
  - [x] Accessibility labels: "Share timeline", "Manage sharing permissions"
  - [x] Navigation integration verified with Browser MCP testing

### DEPENDENCIES
- Must complete after: WS-160 Master Timeline (timeline builder foundation)
- Must complete before: WS-277 Print Formats (print sharing may reference share permissions)
- Shares code with: WS-281 Sharing Controls Enhancement (permission system patterns)

### ESTIMATED EFFORT
- Team A Frontend: 16 hours (permission UI, share modals, filtered views)
- Team B Backend: 12 hours (API endpoints, database schema, security)
- Team C Integration: 4 hours (QR code generation, email notifications)
- Team D Platform: 2 hours (token generation, security validation)
- Team E General: 6 hours (testing, documentation)
- Team F Workflows: 4 hours (share link workflows)
- Team G Performance: 4 hours (access log optimization, query performance)
- Total: 48 hours