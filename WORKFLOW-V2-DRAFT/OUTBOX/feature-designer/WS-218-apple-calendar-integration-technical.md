# TECHNICAL SPECIFICATION: WS-218 - Apple Calendar Integration
## Generated by Feature Development Session - 2025-01-25

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding photographer who uses Mac/iPhone for my business calendar
**I want to:** Have my WedSync bookings automatically appear in my Apple Calendar across all my devices
**So that:** I can check my schedule on my iPhone while meeting clients, get notifications on my Apple Watch, and never miss a wedding or client meeting, saving 1-2 hours per week of manual calendar entry

**Real Wedding Scenario:**
A wedding photographer books 3 weddings through WedSync this week - Saturday ceremony at 4pm in Napa, Sunday engagement shoot at 10am in San Francisco, and a Tuesday client consultation at 2pm. They want these events to automatically appear in their Apple Calendar so when they're driving to a venue and ask Siri "What's my next appointment," it knows about the WedSync booking. When the Saturday wedding couple changes their ceremony time from 4pm to 5pm through WedSync, that change needs to sync to Apple Calendar so the photographer gets the updated notification on their Apple Watch. The photographer also uses Apple Calendar for personal events, so they need WedSync events to appear in a separate calendar or with clear labeling.

### SPECIFICATION SOURCE
- **Feature ID:** WS-218
- **Original Spec:** /CORE-SPECIFICATIONS/08-INTEGRATIONS/03-Calendar-Systems/03-apple-calendar md.md
- **Current Implementation:** 0% complete (requires WS-201 Webhook Endpoints)
- **Files to Modify:** 
  - /src/lib/webhooks/webhook-manager.ts (add CalDAV webhook handlers)
  - /src/components/calendar/CalendarSettings.tsx (add Apple Calendar connection)
- **New Files to Create:** 
  - /src/lib/integrations/caldav-client.ts
  - /src/lib/integrations/apple-calendar-client.ts
  - /src/lib/services/apple-calendar-sync-service.ts
  - /src/components/calendar/AppleCalendarSync.tsx
  - /src/components/calendar/CalDAVEventMapping.tsx
  - /src/hooks/useAppleCalendarSync.ts
  - /src/app/api/calendar/apple/auth/route.ts
  - /src/app/api/calendar/apple/calendars/route.ts
  - /src/app/api/calendar/apple/events/route.ts
  - /src/app/api/calendar/apple/sync/route.ts

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Apple Calendar (CalDAV) integration configuration
CREATE TABLE IF NOT EXISTS apple_calendar_integrations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  apple_id VARCHAR(255) NOT NULL, -- Apple ID email
  caldav_server_url TEXT NOT NULL, -- CalDAV server URL (icloud.com for personal)
  caldav_username VARCHAR(255) NOT NULL, -- Usually Apple ID
  caldav_password_encrypted TEXT NOT NULL, -- Encrypted app-specific password
  caldav_principal_url TEXT, -- CalDAV principal URL
  default_calendar_url TEXT, -- Default calendar to sync with
  default_calendar_name TEXT, -- Calendar display name
  sync_enabled BOOLEAN DEFAULT true,
  sync_direction TEXT DEFAULT 'bidirectional' CHECK (sync_direction IN ('to_apple', 'from_apple', 'bidirectional')),
  sync_preferences JSONB DEFAULT '{
    "syncClientMeetings": true,
    "syncWeddingEvents": true,
    "syncDeadlines": true,
    "syncTravelTime": false,
    "eventPrefix": "WedSync: ",
    "createSeparateCalendar": true,
    "wedSyncCalendarName": "WedSync Events",
    "notificationMinutes": [15, 60],
    "syncToDevices": ["iPhone", "iPad", "Mac"]
  }',
  last_sync_at TIMESTAMP,
  last_sync_status TEXT DEFAULT 'pending' CHECK (last_sync_status IN ('pending', 'success', 'error', 'partial')),
  sync_errors JSONB DEFAULT '[]',
  caldav_ctag TEXT, -- CalDAV collection tag for change detection
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- CalDAV calendar discovery and mapping
CREATE TABLE IF NOT EXISTS apple_calendars (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  integration_id UUID REFERENCES apple_calendar_integrations(id) ON DELETE CASCADE,
  caldav_url TEXT NOT NULL UNIQUE, -- CalDAV calendar collection URL
  calendar_name TEXT NOT NULL,
  calendar_color VARCHAR(7), -- Hex color code
  calendar_order INTEGER DEFAULT 0,
  is_default BOOLEAN DEFAULT false,
  is_writable BOOLEAN DEFAULT true,
  supports_todos BOOLEAN DEFAULT false,
  timezone TEXT DEFAULT 'UTC',
  caldav_ctag TEXT, -- Collection tag for this calendar
  last_synced_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Event synchronization mapping (CalDAV uses UIDs)
CREATE TABLE IF NOT EXISTS apple_calendar_event_mappings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  integration_id UUID REFERENCES apple_calendar_integrations(id) ON DELETE CASCADE,
  calendar_id UUID REFERENCES apple_calendars(id) ON DELETE CASCADE,
  wedsync_event_type TEXT NOT NULL CHECK (wedsync_event_type IN (
    'client_meeting', 'venue_visit', 'vendor_meeting', 'wedding_ceremony', 
    'wedding_reception', 'engagement_shoot', 'deadline', 'task_due', 'rehearsal'
  )),
  wedsync_event_id VARCHAR(255) NOT NULL, -- ID of the event in WedSync
  caldav_uid VARCHAR(255) NOT NULL, -- CalDAV event UID (globally unique)
  caldav_url TEXT NOT NULL, -- Full CalDAV URL for this event
  caldav_etag VARCHAR(255), -- ETag for change detection
  ical_data TEXT, -- Full iCalendar data for the event
  last_synced_at TIMESTAMP DEFAULT NOW(),
  sync_hash VARCHAR(255), -- Hash of event data to detect changes
  sync_conflicts JSONB DEFAULT '[]', -- Record of any sync conflicts
  created_at TIMESTAMP DEFAULT NOW(),
  
  UNIQUE(integration_id, wedsync_event_id),
  UNIQUE(caldav_uid, calendar_id)
);

-- Sync operation history for Apple Calendar
CREATE TABLE IF NOT EXISTS apple_calendar_sync_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  integration_id UUID REFERENCES apple_calendar_integrations(id) ON DELETE CASCADE,
  sync_type TEXT NOT NULL CHECK (sync_type IN ('full_sync', 'incremental', 'single_event', 'manual')),
  sync_direction TEXT NOT NULL CHECK (sync_direction IN ('to_apple', 'from_apple', 'bidirectional')),
  calendars_synced TEXT[], -- Calendar URLs that were synced
  events_processed INTEGER DEFAULT 0,
  events_created INTEGER DEFAULT 0,
  events_updated INTEGER DEFAULT 0,
  events_deleted INTEGER DEFAULT 0,
  conflicts_detected INTEGER DEFAULT 0,
  sync_status TEXT NOT NULL CHECK (sync_status IN ('in_progress', 'completed', 'failed', 'cancelled')),
  sync_errors JSONB DEFAULT '[]',
  caldav_requests INTEGER DEFAULT 0, -- Number of CalDAV requests made
  sync_duration_ms INTEGER,
  started_at TIMESTAMP DEFAULT NOW(),
  completed_at TIMESTAMP,
  triggered_by TEXT DEFAULT 'manual' -- 'manual', 'scheduled', 'webhook', 'auto'
);

-- Indexes for performance
CREATE INDEX idx_apple_calendar_integrations_user ON apple_calendar_integrations(user_id);
CREATE INDEX idx_apple_calendars_integration ON apple_calendars(integration_id);
CREATE INDEX idx_apple_calendar_event_mappings_integration ON apple_calendar_event_mappings(integration_id);
CREATE INDEX idx_apple_calendar_event_mappings_wedsync_event ON apple_calendar_event_mappings(wedsync_event_id);
CREATE INDEX idx_apple_calendar_event_mappings_caldav_uid ON apple_calendar_event_mappings(caldav_uid);
CREATE INDEX idx_apple_calendar_sync_history_integration ON apple_calendar_sync_history(integration_id);
```

#### API Endpoints Required

**1. Apple Calendar Authentication & Setup**
```typescript
// POST /api/calendar/apple/auth
// Authenticate with Apple ID and app-specific password
interface AppleCalendarAuthRequest {
  appleId: string; // Apple ID email
  appSpecificPassword: string; // Generated from appleid.apple.com
  serverType: 'icloud' | 'custom'; // iCloud or custom CalDAV server
  customServerUrl?: string; // For non-iCloud CalDAV servers
}

interface AppleCalendarAuthResponse {
  success: boolean;
  integration: AppleCalendarIntegration;
  availableCalendars: AppleCalendar[];
  capabilities: CalDAVCapabilities;
}

interface AppleCalendarIntegration {
  id: string;
  appleId: string;
  caldavServerUrl: string;
  defaultCalendarUrl?: string;
  defaultCalendarName?: string;
  syncEnabled: boolean;
  syncDirection: 'to_apple' | 'from_apple' | 'bidirectional';
  syncPreferences: AppleCalendarSyncPreferences;
  lastSyncAt?: string;
  lastSyncStatus: 'pending' | 'success' | 'error' | 'partial';
}

interface AppleCalendar {
  id: string;
  caldavUrl: string;
  name: string;
  color: string;
  isDefault: boolean;
  isWritable: boolean;
  supportsTodos: boolean;
  timezone: string;
  eventCount?: number;
}

interface CalDAVCapabilities {
  supportedComponents: string[]; // VEVENT, VTODO, etc.
  maxResourceSize: number;
  supportedCalendarData: string[]; // text/calendar, etc.
  supportedFeatures: string[]; // calendar-access, calendar-schedule, etc.
}

interface AppleCalendarSyncPreferences {
  syncClientMeetings: boolean;
  syncWeddingEvents: boolean;
  syncDeadlines: boolean;
  syncTravelTime: boolean;
  eventPrefix: string;
  createSeparateCalendar: boolean;
  wedSyncCalendarName: string;
  notificationMinutes: number[];
  syncToDevices: string[];
}
```

**2. Calendar Discovery & Management**
```typescript
// GET /api/calendar/apple/calendars
// Discover and list available CalDAV calendars
interface AppleCalendarsResponse {
  calendars: AppleCalendar[];
  principalUrl: string;
  serverCapabilities: CalDAVCapabilities;
  syncStats: {
    totalCalendars: number;
    writableCalendars: number;
    syncEnabledCalendars: number;
  };
}

// POST /api/calendar/apple/calendars
// Create new WedSync calendar in Apple Calendar
interface CreateAppleCalendarRequest {
  calendarName: string;
  color?: string;
  description?: string;
  timezone?: string;
}

interface CreateAppleCalendarResponse {
  calendar: AppleCalendar;
  caldavUrl: string;
  created: boolean;
}

// PUT /api/calendar/apple/calendars/{calendarId}
// Update calendar settings or select as default
interface UpdateAppleCalendarRequest {
  setAsDefault?: boolean;
  syncEnabled?: boolean;
  name?: string;
  color?: string;
}
```

**3. Event Synchronization**
```typescript
// GET /api/calendar/apple/sync
// Get current sync status and configuration
interface AppleCalendarSyncStatusResponse {
  integration: AppleCalendarIntegration;
  syncStats: {
    totalEvents: number;
    syncedEvents: number;
    pendingEvents: number;
    conflictedEvents: number;
    lastFullSync: string;
    nextScheduledSync: string;
  };
  recentSyncHistory: AppleCalendarSyncHistoryItem[];
  caldavStatus: {
    serverReachable: boolean;
    authenticationValid: boolean;
    lastConnectionTest: string;
    caldavVersion: string;
  };
}

interface AppleCalendarSyncHistoryItem {
  id: string;
  syncType: 'full_sync' | 'incremental' | 'single_event' | 'manual';
  syncDirection: string;
  calendarsSync: string[];
  eventsProcessed: number;
  eventsCreated: number;
  eventsUpdated: number;
  eventsDeleted: number;
  conflictsDetected: number;
  syncStatus: 'in_progress' | 'completed' | 'failed' | 'cancelled';
  caldavRequests: number;
  syncDurationMs: number;
  startedAt: string;
  completedAt?: string;
  triggeredBy: string;
  errors?: CalDAVSyncError[];
}

interface CalDAVSyncError {
  eventId: string;
  eventTitle: string;
  caldavUrl?: string;
  errorType: 'network' | 'authentication' | 'conflict' | 'format' | 'permission';
  errorCode: number;
  errorMessage: string;
  retryable: boolean;
  retryAfter?: number;
}

// POST /api/calendar/apple/sync
// Trigger manual sync operation
interface AppleCalendarSyncRequest {
  syncType?: 'full_sync' | 'incremental';
  syncDirection?: 'to_apple' | 'from_apple' | 'bidirectional';
  specificEvents?: string[]; // Sync only these WedSync event IDs
  specificCalendars?: string[]; // Sync only these calendar URLs
  forceResync?: boolean; // Ignore change detection
}

interface AppleCalendarSyncResponse {
  syncId: string;
  status: 'started' | 'queued';
  estimatedDuration: number; // seconds
  eventsToProcess: number;
  calendarsToSync: string[];
}

// GET /api/calendar/apple/sync/{syncId}
// Get status of specific sync operation
interface AppleCalendarSyncJobResponse {
  syncId: string;
  status: 'in_progress' | 'completed' | 'failed' | 'cancelled';
  progress: {
    totalEvents: number;
    processedEvents: number;
    createdEvents: number;
    updatedEvents: number;
    deletedEvents: number;
    errorEvents: number;
    currentCalendar?: string;
    currentEvent?: string;
  };
  errors?: CalDAVSyncError[];
  startedAt: string;
  completedAt?: string;
  estimatedTimeRemaining?: number;
}
```

**4. Event Management & Conflicts**
```typescript
// GET /api/calendar/apple/events
// Get synced events and their mapping status
interface AppleCalendarEventsResponse {
  events: AppleCalendarMappedEvent[];
  pagination: {
    page: number;
    totalPages: number;
    totalEvents: number;
  };
  filters: {
    eventTypes: string[];
    syncStatuses: string[];
    calendars: string[];
    dateRange?: {
      start: string;
      end: string;
    };
  };
}

interface AppleCalendarMappedEvent {
  wedSyncEventId: string;
  wedSyncEventType: string;
  wedSyncEventTitle: string;
  wedSyncEventDate: string;
  caldavUid: string;
  caldavUrl: string;
  appleEventTitle: string;
  appleEventDate: string;
  appleCalendarName: string;
  syncStatus: 'synced' | 'pending' | 'conflict' | 'error';
  lastSynced: string;
  syncConflicts?: CalDAVSyncConflict[];
  canResync: boolean;
  iCalData?: string; // Raw iCalendar data
}

interface CalDAVSyncConflict {
  field: string;
  wedSyncValue: any;
  appleValue: any;
  conflictType: 'datetime' | 'summary' | 'description' | 'location' | 'duration';
  suggestedResolution: 'use_wedsync' | 'use_apple' | 'manual_review';
  lastModified: {
    wedsync: string;
    apple: string;
  };
}

// POST /api/calendar/apple/events/{eventId}/resolve
// Resolve sync conflicts for specific event
interface ResolveAppleConflictRequest {
  resolutions: Record<string, {
    useValue: 'wedsync' | 'apple' | 'custom';
    customValue?: any;
  }>;
  setAsDefault?: boolean;
  updateCalDavImmediately?: boolean;
}

// POST /api/calendar/apple/events/{eventId}/force-sync
// Force sync single event (override normal sync rules)
interface ForceAppleSyncEventRequest {
  direction: 'to_apple' | 'from_apple';
  overwriteConflicts?: boolean;
  targetCalendarUrl?: string; // Move to different calendar
}
```

#### Frontend Components Required

**1. Apple Calendar Sync Component**
```typescript
// src/components/calendar/AppleCalendarSync.tsx
import React, { useState, useEffect } from 'react';
import { useAppleCalendarSync } from '@/hooks/useAppleCalendarSync';
import { CalDAVEventMapping } from './CalDAVEventMapping';

interface AppleCalendarSyncProps {
  onConnectionChange?: (connected: boolean) => void;
}

export function AppleCalendarSync({ onConnectionChange }: AppleCalendarSyncProps) {
  const {
    integration,
    syncStatus,
    syncHistory,
    availableCalendars,
    isLoading,
    connectAppleCalendar,
    disconnectAppleCalendar,
    triggerSync,
    updateSettings,
    createWedSyncCalendar,
    testConnection
  } = useAppleCalendarSync();

  const [showSetup, setShowSetup] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const [setupForm, setSetupForm] = useState({
    appleId: '',
    appSpecificPassword: '',
    serverType: 'icloud' as 'icloud' | 'custom',
    customServerUrl: ''
  });

  useEffect(() => {
    if (onConnectionChange) {
      onConnectionChange(!!integration);
    }
  }, [integration, onConnectionChange]);

  const handleConnect = async () => {
    try {
      await connectAppleCalendar(setupForm);
      setShowSetup(false);
      setSetupForm({
        appleId: '',
        appSpecificPassword: '',
        serverType: 'icloud',
        customServerUrl: ''
      });
    } catch (error) {
      console.error('Failed to connect Apple Calendar:', error);
    }
  };

  const handleCreateWedSyncCalendar = async () => {
    try {
      await createWedSyncCalendar({
        calendarName: 'WedSync Events',
        color: '#0066CC',
        description: 'Wedding events and meetings synced from WedSync'
      });
    } catch (error) {
      console.error('Failed to create WedSync calendar:', error);
    }
  };

  if (isLoading) {
    return <div className="animate-pulse">Loading Apple Calendar integration...</div>;
  }

  if (!integration) {
    return (
      <div className="bg-white border border-gray-200 rounded-lg p-6">
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center space-x-3">
            <div className="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
              🍎
            </div>
            <div>
              <h3 className="text-lg font-semibold text-gray-900">
                Apple Calendar Integration
              </h3>
              <p className="text-sm text-gray-600">
                Sync your wedding events with Apple Calendar (iCloud, macOS, iOS)
              </p>
            </div>
          </div>
        </div>

        <div className="space-y-4">
          <div className="bg-blue-50 p-4 rounded-lg">
            <h4 className="text-sm font-medium text-blue-900 mb-2">
              Before you start:
            </h4>
            <ul className="text-sm text-blue-700 space-y-1">
              <li>• Generate an app-specific password at appleid.apple.com</li>
              <li>• Make sure 2-factor authentication is enabled</li>
              <li>• Events will sync across iPhone, iPad, Mac, and Apple Watch</li>
              <li>• Creates a separate "WedSync Events" calendar by default</li>
            </ul>
          </div>

          {!showSetup ? (
            <button
              onClick={() => setShowSetup(true)}
              className="w-full flex items-center justify-center px-4 py-3 bg-gray-900 text-white rounded-md hover:bg-gray-800 transition-colors"
            >
              <svg className="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
              </svg>
              Connect Apple Calendar
            </button>
          ) : (
            <div className="space-y-4 p-4 border border-gray-200 rounded-lg">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Apple ID
                </label>
                <input
                  type="email"
                  value={setupForm.appleId}
                  onChange={(e) => setSetupForm(prev => ({ ...prev, appleId: e.target.value }))}
                  placeholder="your.email@example.com"
                  className="w-full px-3 py-2 border border-gray-300 rounded-md"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  App-Specific Password
                  <a 
                    href="https://appleid.apple.com/sign-in"
                    target="_blank"
                    className="ml-2 text-xs text-blue-600 hover:text-blue-800"
                  >
                    Generate one here
                  </a>
                </label>
                <input
                  type="password"
                  value={setupForm.appSpecificPassword}
                  onChange={(e) => setSetupForm(prev => ({ ...prev, appSpecificPassword: e.target.value }))}
                  placeholder="xxxx-xxxx-xxxx-xxxx"
                  className="w-full px-3 py-2 border border-gray-300 rounded-md"
                />
                <p className="text-xs text-gray-500 mt-1">
                  Generated at appleid.apple.com → Security → App-Specific Passwords
                </p>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Calendar Server
                </label>
                <select
                  value={setupForm.serverType}
                  onChange={(e) => setSetupForm(prev => ({ ...prev, serverType: e.target.value as 'icloud' | 'custom' }))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md"
                >
                  <option value="icloud">iCloud (recommended)</option>
                  <option value="custom">Custom CalDAV Server</option>
                </select>
              </div>

              {setupForm.serverType === 'custom' && (
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    CalDAV Server URL
                  </label>
                  <input
                    type="url"
                    value={setupForm.customServerUrl}
                    onChange={(e) => setSetupForm(prev => ({ ...prev, customServerUrl: e.target.value }))}
                    placeholder="https://caldav.example.com/"
                    className="w-full px-3 py-2 border border-gray-300 rounded-md"
                  />
                </div>
              )}

              <div className="flex space-x-2">
                <button
                  onClick={handleConnect}
                  disabled={!setupForm.appleId || !setupForm.appSpecificPassword}
                  className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-300"
                >
                  Connect
                </button>
                <button
                  onClick={() => setShowSetup(false)}
                  className="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50"
                >
                  Cancel
                </button>
              </div>
            </div>
          )}
        </div>
      </div>
    );
  }

  return (
    <div className="bg-white border border-gray-200 rounded-lg p-6">
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center space-x-3">
          <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
            ✅
          </div>
          <div>
            <h3 className="text-lg font-semibold text-gray-900">
              Apple Calendar Connected
            </h3>
            <p className="text-sm text-gray-600">
              Syncing with: {integration.defaultCalendarName || 'Default Calendar'}
            </p>
          </div>
        </div>
        
        <div className="flex items-center space-x-2">
          <button
            onClick={() => setShowSettings(!showSettings)}
            className="px-3 py-2 text-sm text-gray-600 hover:text-gray-900 border border-gray-300 rounded-md"
          >
            Settings
          </button>
          <button
            onClick={() => triggerSync({ syncType: 'incremental' })}
            className="px-4 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700"
          >
            Sync Now
          </button>
        </div>
      </div>

      {/* Sync Status */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div className="bg-gray-50 p-3 rounded-lg">
          <div className="text-2xl font-bold text-gray-900">
            {syncStatus?.syncStats.syncedEvents || 0}
          </div>
          <div className="text-sm text-gray-600">Synced Events</div>
        </div>
        
        <div className="bg-blue-50 p-3 rounded-lg">
          <div className="text-2xl font-bold text-blue-600">
            {syncStatus?.syncStats.pendingEvents || 0}
          </div>
          <div className="text-sm text-blue-700">Pending Sync</div>
        </div>
        
        <div className="bg-yellow-50 p-3 rounded-lg">
          <div className="text-2xl font-bold text-yellow-600">
            {syncStatus?.syncStats.conflictedEvents || 0}
          </div>
          <div className="text-sm text-yellow-700">Conflicts</div>
        </div>
        
        <div className="bg-green-50 p-3 rounded-lg">
          <div className="text-sm text-green-700 font-medium">Connection</div>
          <div className="text-sm text-green-600">
            {syncStatus?.caldavStatus.serverReachable ? 'Active' : 'Offline'}
          </div>
        </div>
      </div>

      {/* Settings Panel */}
      {showSettings && (
        <div className="border-t border-gray-200 pt-6 mb-6">
          {/* Settings content similar to Outlook but adapted for Apple Calendar */}
        </div>
      )}

      {/* Available Calendars */}
      {availableCalendars && availableCalendars.length > 0 && (
        <div className="mb-6">
          <div className="flex items-center justify-between mb-4">
            <h4 className="text-md font-semibold text-gray-900">
              Available Calendars
            </h4>
            <button
              onClick={handleCreateWedSyncCalendar}
              className="text-sm text-blue-600 hover:text-blue-800"
            >
              Create WedSync Calendar
            </button>
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            {availableCalendars.map((calendar) => (
              <div key={calendar.id} className="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                <div className="flex items-center space-x-3">
                  <div 
                    className="w-4 h-4 rounded-full"
                    style={{ backgroundColor: calendar.color }}
                  />
                  <div>
                    <div className="text-sm font-medium text-gray-900">
                      {calendar.name}
                    </div>
                    <div className="text-xs text-gray-600">
                      {calendar.isDefault ? 'Default Calendar' : ''}
                      {calendar.eventCount !== undefined ? ` • ${calendar.eventCount} events` : ''}
                    </div>
                  </div>
                </div>
                
                {calendar.isWritable && (
                  <button
                    onClick={() => updateSettings({
                      defaultCalendarUrl: calendar.caldavUrl,
                      defaultCalendarName: calendar.name
                    })}
                    className={`text-xs px-2 py-1 rounded ${
                      integration.defaultCalendarUrl === calendar.caldavUrl
                        ? 'bg-blue-100 text-blue-700'
                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                    }`}
                  >
                    {integration.defaultCalendarUrl === calendar.caldavUrl ? 'Active' : 'Use'}
                  </button>
                )}
              </div>
            ))}
          </div>
        </div>
      )}

      {/* CalDAV Event Mapping */}
      <CalDAVEventMapping 
        integration={integration}
        syncStatus={syncStatus}
      />
    </div>
  );
}
```

### TESTING REQUIREMENTS

#### Unit Tests
- CalDAV client methods and authentication
- iCalendar (RFC 5545) parsing and generation
- Event mapping and transformation logic
- Sync conflict detection and resolution
- App-specific password validation and storage

#### Integration Tests
- Complete CalDAV authentication flow
- Calendar discovery and access
- Bidirectional event synchronization
- iCalendar format compliance
- Error handling for network issues

#### E2E Tests
- Full Apple Calendar setup workflow
- Event creation and sync verification
- Cross-device sync validation (iOS, macOS)
- Conflict resolution interface
- Integration disconnect and cleanup

### DEPENDENCIES & EFFORT ESTIMATE

#### Dependencies
- **WS-201 Webhook Endpoints** - Required for change notifications
- **CalDAV Protocol Implementation** - RFC 4791 compliance
- **iCalendar Processing** - RFC 5545 support
- **App-Specific Password Management** - Secure credential storage

#### Effort Estimate: 22 development days
- **CalDAV Client Implementation**: 5 days
- **iCalendar Processing Engine**: 4 days  
- **Authentication & Security**: 3 days
- **Bidirectional Sync Logic**: 5 days
- **Conflict Resolution System**: 3 days
- **UI Components & Settings**: 2 days

#### Risk Factors
- **High:** Apple's CalDAV implementation variations and limitations
- **Medium:** iCalendar format complexity and timezone handling
- **Medium:** App-specific password user experience confusion
- **Low:** Network reliability and error recovery

### SUCCESS CRITERIA
1. CalDAV authentication works with iCloud and custom servers
2. Events sync bidirectionally within 60 seconds of changes
3. iCalendar data maintains full compatibility with Apple Calendar
4. Sync works across iPhone, iPad, Mac, and Apple Watch
5. App-specific password setup is clearly documented
6. Conflicts are resolved without data loss
7. Custom calendar creation works reliably
8. Integration handles network interruptions gracefully