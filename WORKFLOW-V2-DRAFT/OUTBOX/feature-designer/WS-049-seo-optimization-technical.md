# TECHNICAL SPECIFICATION: WS-049 - SEO Optimization Tools
## Generated by Feature Development Session - 2025-08-21

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding photographer in Denver
**I want to:** Rank #1 for "wedding photographer Denver" in Google search
**So that:** I get 60% of my new clients from organic search instead of paying $200/click on Google Ads

**Real Wedding Scenario:**
Maria is a wedding photographer whose WedSync profile auto-generates an SEO-optimized page at "/suppliers/denver/photographer/maria-rodriguez-photography". The system creates unique meta descriptions, schema markup, and location-specific content. When couples search "Denver wedding photographer", Maria's profile ranks on page 1, generating 15 organic inquiries per month worth $45,000 in potential revenue.

### SPECIFICATION SOURCE
- **Feature ID:** WS-049
- **Original Spec:** /CORE-SPECIFICATIONS/02-WEDSYNC-SUPPLIER-PLATFORM/08-Growth-Features/04-seo-optimization md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** 
  - `/src/app/layout.tsx` - Add global SEO configuration
  - `/src/app/sitemap.ts` - Dynamic sitemap generation
- **New Files to Create:**
  - `/src/components/seo/SEOOptimizer.tsx`
  - `/src/lib/seo/meta-generator.ts`
  - `/src/lib/seo/schema-generator.ts`
  - `/src/lib/seo/content-optimizer.ts`
  - `/src/app/suppliers/[location]/[category]/[slug]/page.tsx`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- SEO Configuration table
CREATE TABLE IF NOT EXISTS seo_configurations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID NOT NULL REFERENCES suppliers(id),
  meta_title VARCHAR(60),
  meta_description VARCHAR(160),
  keywords TEXT[],
  canonical_url TEXT,
  og_title VARCHAR(60),
  og_description VARCHAR(160),
  og_image_url TEXT,
  schema_markup JSONB,
  content_blocks JSONB, -- {about: "...", services: "...", location: "..."}
  is_auto_generated BOOLEAN DEFAULT TRUE,
  seo_score DECIMAL(3,1) DEFAULT 0, -- 0-100 SEO health score
  last_optimized TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- SEO Performance table
CREATE TABLE IF NOT EXISTS seo_performance (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID NOT NULL REFERENCES suppliers(id),
  date DATE NOT NULL,
  organic_impressions INTEGER DEFAULT 0,
  organic_clicks INTEGER DEFAULT 0,
  average_position DECIMAL(4,1),
  click_through_rate DECIMAL(5,2),
  top_keywords JSONB, -- {keyword: position}
  page_speed_score INTEGER,
  core_web_vitals JSONB,
  backlink_count INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(supplier_id, date)
);

-- Location Pages table
CREATE TABLE IF NOT EXISTS location_pages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  city VARCHAR(100) NOT NULL,
  state VARCHAR(50) NOT NULL,
  country VARCHAR(50) NOT NULL,
  category VARCHAR(50) NOT NULL, -- photographer, venue, florist
  slug VARCHAR(200) NOT NULL, -- denver-co-photographers
  meta_title VARCHAR(60),
  meta_description VARCHAR(160),
  content TEXT,
  supplier_count INTEGER DEFAULT 0,
  average_rating DECIMAL(2,1),
  is_published BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(slug)
);

-- URL Redirects table
CREATE TABLE IF NOT EXISTS url_redirects (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  from_url VARCHAR(500) NOT NULL,
  to_url VARCHAR(500) NOT NULL,
  redirect_type INTEGER DEFAULT 301, -- 301 or 302
  is_active BOOLEAN DEFAULT TRUE,
  hit_count INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(from_url)
);
```

#### API Endpoints Required
```typescript
// GET /api/seo/config/[supplierId]
interface GetSEOConfigResponse {
  success: boolean;
  config: {
    metaTitle: string;
    metaDescription: string;
    keywords: string[];
    canonicalUrl: string;
    schemaMarkup: object;
    seoScore: number;
    recommendations: string[];
  };
}

// PUT /api/seo/config/[supplierId]
interface UpdateSEOConfigRequest {
  metaTitle?: string;
  metaDescription?: string;
  keywords?: string[];
  contentBlocks?: Record<string, string>;
  customSchema?: object;
}

// POST /api/seo/analyze/[supplierId]
interface SEOAnalysisResponse {
  success: boolean;
  score: number;
  issues: Array<{
    type: 'error' | 'warning' | 'info';
    message: string;
    fix: string;
  }>;
  opportunities: Array<{
    keyword: string;
    difficulty: number;
    searchVolume: number;
    currentPosition?: number;
  }>;
}

// GET /api/seo/performance/[supplierId]
interface SEOPerformanceResponse {
  success: boolean;
  metrics: {
    organicTraffic: TimeSeriesData;
    keywordRankings: Array<{
      keyword: string;
      position: number;
      change: number;
    }>;
    coreWebVitals: {
      lcp: number; // Largest Contentful Paint
      fid: number; // First Input Delay
      cls: number; // Cumulative Layout Shift
    };
    competitorComparison: {
      yourRank: number;
      topCompetitors: string[];
    };
  };
}

// POST /api/seo/generate-content
interface GenerateContentRequest {
  supplierId: string;
  contentType: 'about' | 'services' | 'location';
  keywords: string[];
  wordCount: number;
}

// GET /api/sitemap.xml
// Dynamic XML sitemap with all supplier profiles and location pages
```

#### Frontend Components Required
```typescript
// Component: SEOOptimizer
// Location: /src/components/seo/SEOOptimizer.tsx

interface SEOOptimizerProps {
  supplierId: string;
  currentConfig?: SEOConfiguration;
}

// Key functionality:
- Real-time SEO score calculator
- Meta tag preview (Google/Facebook/Twitter)
- Keyword research and suggestions
- Content length and readability analyzer
- Schema markup validator
- Page speed recommendations
- Competitive analysis dashboard

// Component: MetaTagPreview
// Location: /src/components/seo/MetaTagPreview.tsx

interface MetaTagPreviewProps {
  title: string;
  description: string;
  url: string;
  imageUrl?: string;
}

// Key functionality:
- Live preview of Google search results
- Facebook Open Graph preview
- Twitter card preview
- Character count warnings
- Click-through rate predictions

// Component: SEODashboard
// Location: /src/components/seo/SEODashboard.tsx

interface SEODashboardProps {
  supplierId: string;
}

// Key functionality:
- Organic traffic trends
- Keyword ranking changes
- Core Web Vitals monitoring
- Backlink tracking
- Competitor comparison
- SEO task prioritization
```

#### Integration Points
```typescript
// Service: MetaGenerator
// Dependencies: SupplierService, LocationService

class MetaGenerator {
  async generateMetaTags(supplierId: string): Promise<MetaTags> {
    // Generate location + service + unique value prop combinations
  }
  
  async generateSchemaMarkup(supplierId: string): Promise<object> {
    // LocalBusiness, Review, Event schema
  }
  
  async optimizeContent(content: string, keywords: string[]): Promise<string> {
    // Keyword density, readability, length optimization
  }
}

// Service: SEOAnalyzer
// Dependencies: WebVitalsService, KeywordService

class SEOAnalyzer {
  async analyzePageSEO(url: string): Promise<SEOAnalysis> {
    // Technical SEO audit
  }
  
  async trackKeywordRankings(supplierId: string): Promise<KeywordRankings> {
    // Monitor Google Search Console rankings
  }
  
  async getCoreWebVitals(url: string): Promise<WebVitals> {
    // Real User Metrics from PageSpeed Insights API
  }
}

// Service: ContentOptimizer
// Dependencies: AIService, KeywordService

class ContentOptimizer {
  async generateSEOContent(
    supplierId: string, 
    contentType: string, 
    keywords: string[]
  ): Promise<string> {
    // AI-generated, locally-optimized content
  }
  
  async optimizeExistingContent(content: string, targetKeywords: string[]): Promise<string> {
    // Improve existing content for SEO
  }
}
```

### CODE EXAMPLES

#### Example 1: Dynamic Meta Tag Generation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { supabase } from '@/lib/supabase';
import { Metadata } from 'next';

export async function generateSupplierMetadata(slug: string): Promise<Metadata> {
  // Step 1: Get supplier data
  const { data: supplier } = await supabase
    .from('suppliers')
    .select(`
      *,
      directory_profiles(*),
      seo_configurations(*),
      collected_reviews(rating)
    `)
    .eq('slug', slug)
    .single();
    
  if (!supplier) {
    return {
      title: 'Supplier Not Found | WedSync',
      description: 'The supplier you are looking for could not be found.'
    };
  }
  
  const profile = supplier.directory_profiles;
  const seoConfig = supplier.seo_configurations;
  const reviews = supplier.collected_reviews || [];
  
  // Step 2: Generate dynamic title
  const location = `${profile.primary_location.city}, ${profile.primary_location.state}`;
  const category = profile.category.charAt(0).toUpperCase() + profile.category.slice(1);
  
  const title = seoConfig?.meta_title || 
    `${supplier.business_name} - ${category} in ${location} | WedSync`;
  
  // Step 3: Generate description with value props
  const avgRating = reviews.length > 0 
    ? (reviews.reduce((sum, r) => sum + r.rating, 0) / reviews.length).toFixed(1)
    : null;
  
  const ratingText = avgRating ? `${avgRating}â˜… rated ` : '';
  const reviewText = reviews.length > 0 ? `${reviews.length} reviews` : '';
  
  const description = seoConfig?.meta_description || 
    `${ratingText}${category.toLowerCase()} in ${location}. ${supplier.business_name} specializes in ${profile.subcategories?.join(', ') || 'wedding services'}. ${reviewText}.`;
  
  // Step 4: Generate schema markup
  const schemaMarkup = {
    '@context': 'https://schema.org',
    '@type': 'LocalBusiness',
    name: supplier.business_name,
    description: profile.description,
    image: profile.gallery_images?.[0],
    telephone: supplier.phone,
    email: supplier.email,
    address: {
      '@type': 'PostalAddress',
      streetAddress: profile.primary_location.address,
      addressLocality: profile.primary_location.city,
      addressRegion: profile.primary_location.state,
      addressCountry: profile.primary_location.country
    },
    aggregateRating: reviews.length > 0 ? {
      '@type': 'AggregateRating',
      ratingValue: avgRating,
      reviewCount: reviews.length
    } : undefined,
    priceRange: profile.price_range
  };
  
  // Step 5: Return Next.js metadata
  return {
    title: title.substring(0, 60), // Truncate to 60 chars
    description: description.substring(0, 160), // Truncate to 160 chars
    keywords: seoConfig?.keywords?.join(', ') || [
      category.toLowerCase(),
      location.toLowerCase(),
      'wedding',
      'vendor'
    ].join(', '),
    openGraph: {
      title: title,
      description: description,
      url: `https://wedsync.com/suppliers/${location.toLowerCase().replace(/\s+/g, '-')}/${profile.category}/${slug}`,
      images: [{
        url: profile.gallery_images?.[0] || '/default-supplier-og.jpg',
        width: 1200,
        height: 630,
        alt: `${supplier.business_name} - ${category} in ${location}`
      }],
      type: 'website'
    },
    twitter: {
      card: 'summary_large_image',
      title: title,
      description: description,
      images: [profile.gallery_images?.[0] || '/default-supplier-twitter.jpg']
    },
    other: {
      'application-ld+json': JSON.stringify(schemaMarkup)
    }
  };
}
```

#### Example 2: SEO Performance Tracking
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { supabase } from '@/lib/supabase';

export async function trackSEOPerformance(supplierId: string) {
  try {
    // Step 1: Get Google Search Console data (requires API setup)
    const gscData = await fetchGoogleSearchConsoleData(supplierId);
    
    // Step 2: Get PageSpeed Insights data
    const supplierUrl = await getSupplierUrl(supplierId);
    const pageSpeedData = await fetchPageSpeedInsights(supplierUrl);
    
    // Step 3: Calculate metrics
    const metrics = {
      date: new Date().toISOString().split('T')[0],
      organic_impressions: gscData.impressions || 0,
      organic_clicks: gscData.clicks || 0,
      average_position: gscData.position || 0,
      click_through_rate: gscData.impressions > 0 
        ? (gscData.clicks / gscData.impressions) * 100 
        : 0,
      top_keywords: gscData.topKeywords || {},
      page_speed_score: pageSpeedData.performance || 0,
      core_web_vitals: {
        lcp: pageSpeedData.lcp || 0,
        fid: pageSpeedData.fid || 0,
        cls: pageSpeedData.cls || 0
      }
    };
    
    // Step 4: Store in database
    const { error } = await supabase
      .from('seo_performance')
      .upsert({
        supplier_id: supplierId,
        ...metrics
      }, {
        onConflict: 'supplier_id,date'
      });
      
    if (error) throw error;
    
    // Step 5: Update SEO configuration score
    const seoScore = calculateSEOScore(metrics, pageSpeedData);
    await supabase
      .from('seo_configurations')
      .update({ seo_score: seoScore })
      .eq('supplier_id', supplierId);
    
    return metrics;
    
  } catch (error) {
    console.error('SEO performance tracking failed:', error);
    throw error;
  }
}

async function fetchGoogleSearchConsoleData(supplierId: string) {
  // Simplified example - would use actual Google Search Console API
  return {
    impressions: Math.floor(Math.random() * 1000),
    clicks: Math.floor(Math.random() * 100),
    position: 5 + Math.random() * 10,
    topKeywords: {
      'wedding photographer': 3.2,
      'denver wedding': 8.1,
      'wedding photos': 12.5
    }
  };
}

async function fetchPageSpeedInsights(url: string) {
  try {
    const apiKey = process.env.GOOGLE_PAGESPEED_API_KEY;
    const response = await fetch(
      `https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=${encodeURIComponent(url)}&key=${apiKey}&category=performance`
    );
    
    const data = await response.json();
    const metrics = data.loadingExperience?.metrics;
    
    return {
      performance: data.lighthouseResult?.categories?.performance?.score * 100,
      lcp: metrics?.LARGEST_CONTENTFUL_PAINT_MS?.percentile || 0,
      fid: metrics?.FIRST_INPUT_DELAY_MS?.percentile || 0,
      cls: metrics?.CUMULATIVE_LAYOUT_SHIFT_SCORE?.percentile || 0
    };
  } catch (error) {
    console.error('PageSpeed API error:', error);
    return { performance: 0, lcp: 0, fid: 0, cls: 0 };
  }
}

function calculateSEOScore(metrics: any, pageSpeedData: any): number {
  // Weighted SEO scoring algorithm
  const factors = {
    pageSpeed: Math.min(pageSpeedData.performance || 0, 100) * 0.25,
    ctr: Math.min(metrics.click_through_rate * 10, 100) * 0.20,
    position: Math.max(0, (21 - metrics.average_position) / 20 * 100) * 0.25,
    coreWebVitals: calculateWebVitalsScore(pageSpeedData) * 0.30
  };
  
  return Math.round(Object.values(factors).reduce((sum, score) => sum + score, 0));
}

function calculateWebVitalsScore(data: any): number {
  const lcpScore = data.lcp < 2500 ? 100 : data.lcp < 4000 ? 50 : 0;
  const fidScore = data.fid < 100 ? 100 : data.fid < 300 ? 50 : 0;
  const clsScore = data.cls < 0.1 ? 100 : data.cls < 0.25 ? 50 : 0;
  
  return (lcpScore + fidScore + clsScore) / 3;
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for Google Search Console API, PageSpeed Insights
- [x] Filesystem: Access SEO template content
- [ ] Playwright: Test SEO implementation and Core Web Vitals

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/googleapis/googleapis", "search console api", 3000);
await mcp__context7__get-library-docs("/next.js/next.js", "metadata api seo", 2500);
await mcp__context7__get-library-docs("/cheerio/cheerio", "html parsing seo analysis", 1500);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('SEO Optimizer', () => {
  it('should generate proper meta tags for suppliers', async () => {
    const metadata = await generateSupplierMetadata('denver-photographer-jane');
    expect(metadata.title).toContain('Denver');
    expect(metadata.description.length).toBeLessThanOrEqual(160);
  });
  
  it('should calculate SEO scores accurately', () => {
    const score = calculateSEOScore(mockMetrics, mockPageSpeed);
    expect(score).toBeGreaterThanOrEqual(0);
    expect(score).toBeLessThanOrEqual(100);
  });
  
  it('should generate valid schema markup', async () => {
    const schema = await generateSchemaMarkup('supplier-123');
    expect(schema['@type']).toBe('LocalBusiness');
    expect(schema.address).toBeDefined();
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('SEO optimization complete flow', async () => {
  // Step 1: Navigate to supplier SEO settings
  await mcp__playwright__browser_navigate({url: '/dashboard/seo'});
  
  // Step 2: Test meta tag optimization
  await mcp__playwright__browser_type({element: 'meta title', ref: 'input[name="metaTitle"]', text: 'Best Denver Wedding Photographer'});
  
  // Step 3: Verify preview updates
  await mcp__playwright__browser_snapshot();
  
  // Step 4: Test public profile SEO
  await mcp__playwright__browser_navigate({url: '/suppliers/denver/photographer/test-supplier'});
  
  // Step 5: Verify meta tags in HTML
  const title = await page.title();
  expect(title).toContain('Denver');
  
  // Test Core Web Vitals and mobile performance
  await mcp__playwright__browser_resize({width: 375, height: 667}); // Mobile
  await mcp__playwright__browser_take_screenshot({filename: 'mobile-seo-test.png'});
});
```

### ACCEPTANCE CRITERIA
- [x] Supplier profiles auto-generate SEO-optimized URLs with location + category + business name
- [x] Meta titles stay under 60 characters, descriptions under 160 characters
- [x] Schema markup includes LocalBusiness, Review aggregates, and Event data
- [x] Core Web Vitals score >90 on all supplier profile pages
- [x] Dynamic sitemap.xml updates within 5 minutes of new supplier registration
- [x] Performance: SEO analysis completes in <3 seconds, metadata generation <500ms
- [x] Security: All SEO data sanitized to prevent injection attacks
- [x] Accessibility: All SEO-generated content maintains WCAG 2.1 AA compliance

### DEPENDENCIES
- Must complete after: Directory Listing Management (WS-048) - needs profile URLs to optimize
- Must complete before: Viral Mechanics System (WS-050) - SEO drives organic discovery
- Shares code with: Directory system, Profile management, Analytics tracking

### ESTIMATED EFFORT
- Team A Frontend: 16 hours
- Team B Backend: 24 hours
- Team C Integration: 12 hours
- Total: 52 hours