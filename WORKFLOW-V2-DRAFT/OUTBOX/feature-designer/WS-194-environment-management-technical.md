# TECHNICAL SPECIFICATION: WS-194 - Environment Management
## Generated by Feature Development Session - August 25, 2025

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** WedSync DevOps engineer managing deployments across multiple environments
**I want to:** Implement secure environment variable management with automated secret rotation and validation
**So that:** I can safely deploy updates during peak wedding season without configuration errors, protect sensitive API keys and database credentials, and maintain environment isolation between development, staging, and production systems

**Real Wedding Scenario:**
A critical bug fix needs deployment during peak wedding season (June) when 500+ couples are actively using the platform for vendor coordination. Environment management ensures the production deployment uses validated configuration with proper database URLs, encrypted API keys, and correct feature flags, while staging maintains identical configuration for testing. Automated secret rotation prevents security breaches, and environment validation catches configuration errors before they can affect couples coordinating their wedding day details.

### SPECIFICATION SOURCE
- **Feature ID:** WS-194
- **Original Spec:** /CORE-SPECIFICATIONS/11-TESTING-DEPLOYMENT/02-CI-CD/03-environment-management md.md
- **Current Implementation:** 0% complete (new)
- **Files to Modify:** None (new feature)
- **New Files to Create:** 
  - `/wedsync/lib/env.ts`
  - `/wedsync/config/environments.ts`
  - `/wedsync/lib/feature-flags.ts`
  - `/wedsync/scripts/setup-vercel-env.sh`
  - `/wedsync/scripts/rotate-secrets.ts`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Environment configuration tracking
CREATE TABLE environment_configs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  environment_name TEXT NOT NULL, -- 'development', 'staging', 'production'
  config_version TEXT NOT NULL,
  
  -- Configuration metadata
  variables_count INTEGER,
  feature_flags JSONB,
  service_endpoints JSONB,
  
  -- Validation status
  is_validated BOOLEAN DEFAULT FALSE,
  validation_errors JSONB,
  last_validated_at TIMESTAMPTZ,
  
  -- Deployment tracking
  deployed_at TIMESTAMPTZ,
  deployed_by UUID REFERENCES users(id),
  deployment_status TEXT CHECK (deployment_status IN ('pending', 'active', 'deprecated')),
  
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Secret rotation audit log
CREATE TABLE secret_rotation_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  secret_name TEXT NOT NULL,
  environment TEXT NOT NULL,
  
  -- Rotation details
  rotation_type TEXT CHECK (rotation_type IN ('scheduled', 'manual', 'emergency')),
  old_value_hash TEXT, -- SHA-256 hash for audit purposes
  rotated_at TIMESTAMPTZ DEFAULT NOW(),
  rotated_by TEXT, -- 'system' or user ID
  
  -- Status tracking
  rotation_status TEXT CHECK (rotation_status IN ('initiated', 'completed', 'failed', 'rolled_back')),
  next_rotation_due DATE,
  
  -- Rollback information
  rollback_reason TEXT,
  rollback_at TIMESTAMPTZ,
  
  notes TEXT
);

-- Feature flag configurations
CREATE TABLE feature_flags (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  flag_name TEXT UNIQUE NOT NULL,
  description TEXT,
  
  -- Environment-specific values
  development_enabled BOOLEAN DEFAULT FALSE,
  staging_enabled BOOLEAN DEFAULT FALSE,
  production_enabled BOOLEAN DEFAULT FALSE,
  
  -- Rollout configuration
  rollout_percentage INTEGER DEFAULT 100 CHECK (rollout_percentage >= 0 AND rollout_percentage <= 100),
  target_user_segments TEXT[],
  
  -- Lifecycle tracking
  is_permanent BOOLEAN DEFAULT FALSE, -- Temporary flags should be cleaned up
  created_at TIMESTAMPTZ DEFAULT NOW(),
  deprecated_at TIMESTAMPTZ,
  cleanup_after DATE,
  
  -- Ownership
  owner_team TEXT,
  created_by UUID REFERENCES users(id)
);

-- Environment health monitoring
CREATE TABLE environment_health (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  environment_name TEXT NOT NULL,
  check_timestamp TIMESTAMPTZ DEFAULT NOW(),
  
  -- Health metrics
  config_valid BOOLEAN,
  secrets_valid BOOLEAN,
  services_reachable BOOLEAN,
  database_connection BOOLEAN,
  
  -- Performance indicators
  response_time_ms INTEGER,
  error_rate DECIMAL(5,4),
  uptime_percentage DECIMAL(5,4),
  
  -- Issues detected
  issues_detected JSONB,
  alert_sent BOOLEAN DEFAULT FALSE
);
```

#### API Endpoints Required
```typescript
// POST /api/admin/environments/validate
interface ValidateEnvironmentRequest {
  environment: 'development' | 'staging' | 'production';
  configVersion?: string;
  validateSecrets: boolean;
}

interface ValidateEnvironmentResponse {
  success: boolean;
  data: {
    configVersion: string;
    validationStatus: 'valid' | 'invalid' | 'warnings';
    validationResults: ValidationResult[];
    missingVariables: string[];
    deprecatedFlags: string[];
  };
}
```

#### Frontend Components Required
```typescript
// Component: EnvironmentDashboard
// Location: /src/components/admin/EnvironmentDashboard.tsx

interface Props {
  environments: EnvironmentConfig[];
  secretRotationStatus: SecretRotationStatus[];
  featureFlags: FeatureFlag[];
}

// Key functionality:
- Environment configuration validation with real-time status monitoring
- Secret rotation scheduling with automated alerts for due rotations
- Feature flag management with environment-specific toggles
- Configuration diff comparison between environments
```

#### Integration Points
```typescript
// Service: EnvironmentManager
// Dependencies: Vercel API, secret management, configuration validation

class EnvironmentManager {
  async validateEnvironment(env: Environment): Promise<ValidationResult> {
    // Comprehensive environment validation with security checks
  }
  
  async rotateSecrets(environment: string, secrets: string[]): Promise<RotationResult> {
    // Automated secret rotation with rollback capabilities
  }
}
```

### CODE EXAMPLES

#### Example 1: Comprehensive Environment Validation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { z } from 'zod';
import { createClient } from '@supabase/supabase-js';

export class EnvironmentValidator {
  private readonly envSchema = z.object({
    // Core application configuration
    NODE_ENV: z.enum(['development', 'test', 'staging', 'production']),
    NEXT_PUBLIC_APP_URL: z.string().url(),
    NEXT_PUBLIC_APP_NAME: z.string().min(1),
    
    // Database configuration (required in non-development)
    DATABASE_URL: z.string().min(1).refine((url) => {
      if (process.env.NODE_ENV === 'development') return true;
      return url.startsWith('postgresql://') && !url.includes('localhost');
    }, 'Production database must be external PostgreSQL'),
    
    // Supabase configuration
    NEXT_PUBLIC_SUPABASE_URL: z.string().url(),
    NEXT_PUBLIC_SUPABASE_ANON_KEY: z.string().min(100), // Supabase keys are long
    SUPABASE_SERVICE_KEY: z.string().min(100).refine((key) => {
      return process.env.NODE_ENV === 'development' || !key.includes('localhost');
    }, 'Production must use hosted Supabase'),
    
    // External service APIs (required in production)
    OPENAI_API_KEY: z.string().startsWith('sk-').optional().refine((key) => {
      if (process.env.NODE_ENV === 'production') {
        return key && key.length > 20;
      }
      return true;
    }, 'OpenAI API key required in production'),
    
    TWILIO_ACCOUNT_SID: z.string().startsWith('AC').optional(),
    TWILIO_AUTH_TOKEN: z.string().min(20).optional(),
    SENDGRID_API_KEY: z.string().startsWith('SG.').optional(),
    
    // Storage configuration
    AWS_ACCESS_KEY_ID: z.string().min(16).optional(),
    AWS_SECRET_ACCESS_KEY: z.string().min(30).optional(),
    AWS_REGION: z.string().optional(),
    S3_BUCKET: z.string().optional(),
    
    // Monitoring (required in production)
    SENTRY_DSN: z.string().url().optional().refine((dsn) => {
      if (process.env.NODE_ENV === 'production') {
        return dsn && dsn.includes('sentry.io');
      }
      return true;
    }, 'Sentry DSN required in production'),
    
    // Feature flags
    FEATURE_AI_CHATBOT: z.string().transform(val => val === 'true').optional(),
    FEATURE_MARKETPLACE: z.string().transform(val => val === 'true').optional(),
    FEATURE_ADVANCED_ANALYTICS: z.string().transform(val => val === 'true').optional(),
  });

  async validateEnvironment(environmentName: string): Promise<ValidationResult> {
    const validationResult: ValidationResult = {
      environment: environmentName,
      isValid: true,
      errors: [],
      warnings: [],
      missingVariables: [],
      configVersion: this.generateConfigVersion(),
    };

    try {
      // Step 1: Validate environment variable schema
      const parsedEnv = this.envSchema.parse(process.env);
      
      // Step 2: Test database connectivity
      const dbResult = await this.validateDatabaseConnection(parsedEnv.DATABASE_URL);
      if (!dbResult.connected) {
        validationResult.errors.push({
          variable: 'DATABASE_URL',
          message: `Database connection failed: ${dbResult.error}`,
          severity: 'error'
        });
        validationResult.isValid = false;
      }

      // Step 3: Validate Supabase configuration
      const supabaseResult = await this.validateSupabaseConfig({
        url: parsedEnv.NEXT_PUBLIC_SUPABASE_URL,
        anonKey: parsedEnv.NEXT_PUBLIC_SUPABASE_ANON_KEY,
        serviceKey: parsedEnv.SUPABASE_SERVICE_KEY
      });

      if (!supabaseResult.valid) {
        validationResult.errors.push({
          variable: 'SUPABASE_CONFIG',
          message: supabaseResult.error,
          severity: 'error'
        });
        validationResult.isValid = false;
      }

      // Step 4: Validate external service credentials
      if (environmentName === 'production') {
        const externalServices = await this.validateExternalServices(parsedEnv);
        validationResult.warnings.push(...externalServices.warnings);
        validationResult.errors.push(...externalServices.errors);
        
        if (externalServices.errors.length > 0) {
          validationResult.isValid = false;
        }
      }

      // Step 5: Validate feature flags consistency
      const featureFlagResult = await this.validateFeatureFlags(environmentName);
      validationResult.warnings.push(...featureFlagResult.warnings);

      // Step 6: Store validation results
      await this.storeValidationResults(validationResult);

      return validationResult;

    } catch (zodError) {
      if (zodError instanceof z.ZodError) {
        validationResult.isValid = false;
        validationResult.errors = zodError.errors.map(err => ({
          variable: err.path.join('.'),
          message: err.message,
          severity: 'error' as const
        }));
      }

      return validationResult;
    }
  }

  private async validateSupabaseConfig(config: {
    url: string;
    anonKey: string;
    serviceKey: string;
  }): Promise<{valid: boolean; error?: string}> {
    try {
      const supabase = createClient(config.url, config.serviceKey);
      
      // Test service key functionality
      const { data, error } = await supabase.auth.admin.listUsers({ page: 1, perPage: 1 });
      
      if (error) {
        return { valid: false, error: `Supabase service key invalid: ${error.message}` };
      }

      // Validate anon key format
      if (!config.anonKey.includes('eyJ')) {
        return { valid: false, error: 'Supabase anon key appears to be invalid JWT format' };
      }

      return { valid: true };
    } catch (error) {
      return { valid: false, error: `Supabase connection failed: ${error.message}` };
    }
  }

  private async validateExternalServices(env: any): Promise<{
    errors: ValidationError[];
    warnings: ValidationError[];
  }> {
    const errors: ValidationError[] = [];
    const warnings: ValidationError[] = [];

    // Validate OpenAI API key
    if (env.OPENAI_API_KEY) {
      try {
        const response = await fetch('https://api.openai.com/v1/models', {
          headers: { Authorization: `Bearer ${env.OPENAI_API_KEY}` }
        });
        
        if (!response.ok) {
          errors.push({
            variable: 'OPENAI_API_KEY',
            message: 'OpenAI API key authentication failed',
            severity: 'error'
          });
        }
      } catch (error) {
        warnings.push({
          variable: 'OPENAI_API_KEY',
          message: 'Could not validate OpenAI API key - network error',
          severity: 'warning'
        });
      }
    }

    // Validate Twilio credentials
    if (env.TWILIO_ACCOUNT_SID && env.TWILIO_AUTH_TOKEN) {
      try {
        const auth = Buffer.from(`${env.TWILIO_ACCOUNT_SID}:${env.TWILIO_AUTH_TOKEN}`).toString('base64');
        const response = await fetch(`https://api.twilio.com/2010-04-01/Accounts/${env.TWILIO_ACCOUNT_SID}.json`, {
          headers: { Authorization: `Basic ${auth}` }
        });
        
        if (!response.ok) {
          errors.push({
            variable: 'TWILIO_CREDENTIALS',
            message: 'Twilio credentials authentication failed',
            severity: 'error'
          });
        }
      } catch (error) {
        warnings.push({
          variable: 'TWILIO_CREDENTIALS',
          message: 'Could not validate Twilio credentials - network error',
          severity: 'warning'
        });
      }
    }

    return { errors, warnings };
  }
}

interface ValidationResult {
  environment: string;
  isValid: boolean;
  errors: ValidationError[];
  warnings: ValidationError[];
  missingVariables: string[];
  configVersion: string;
}

interface ValidationError {
  variable: string;
  message: string;
  severity: 'error' | 'warning';
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for environment management best practices, Zod validation
- [x] Filesystem: Manage environment files and configuration scripts
- [x] Supabase: Validate Supabase configuration and connectivity

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/zod/zod", "schema validation", 3000);
await mcp__context7__get-library-docs("/vercel/vercel", "environment management", 4000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('EnvironmentValidator', () => {
  it('should validate production environment with all required variables', () => {
    // Test comprehensive production environment validation
  });
  
  it('should detect missing critical environment variables', () => {
    // Test validation error handling for missing variables
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Environment dashboard shows configuration status', async () => {
  await mcp__playwright__browser_navigate({url: '/admin/environments'});
  
  // Verify environment status display
  await expect(page.locator('[data-testid="production-status"]')).toBeVisible();
  await expect(page.locator('[data-testid="staging-status"]')).toBeVisible();
  
  // Test configuration validation
  await mcp__playwright__browser_click({
    element: 'validate production button',
    ref: '[data-testid="validate-production"]'
  });
  
  await mcp__playwright__browser_wait_for({text: 'Validation completed'});
});
```

### ACCEPTANCE CRITERIA
- [x] Environment validation prevents deployments with invalid configuration
- [x] Secret rotation completes automatically with zero-downtime rollover
- [x] Feature flags can be toggled per environment with immediate effect
- [x] Performance: Environment validation completes within 30 seconds
- [x] Security: All secrets encrypted at rest and in transit with audit logging
- [x] Accessibility: Environment dashboard works with screen readers for DevOps monitoring

### DEPENDENCIES
- Must complete after: CI/CD pipeline foundation and deployment infrastructure
- Must complete before: Production deployment and security compliance validation
- Shares code with: Secret management, monitoring systems, deployment automation

### ESTIMATED EFFORT
- Team B Backend: 56 hours (Environment validation, secret rotation, configuration management)
- Team C Integration: 48 hours (Vercel integration, deployment automation, monitoring)
- Team A Frontend: 16 hours (Environment dashboard, configuration interface)
- Total: 120 hours