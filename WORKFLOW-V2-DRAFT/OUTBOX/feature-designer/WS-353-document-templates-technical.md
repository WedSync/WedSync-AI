# TECHNICAL SPECIFICATION: WS-353 - Document Templates System
## Generated by Feature Development Session - 2025-01-20

### USER STORY & BUSINESS CONTEXT
**As a:** Wedding supplier (photographer, venue, florist, caterer)
**I want to:** Generate professional documents from customizable templates including contracts, quotes, invoices, timeline sheets, and vendor guides
**So that:** I can save 5-8 hours per wedding on document creation while maintaining professional consistency and branding

**Real Wedding Scenario:**
Sarah, a wedding photographer, receives an inquiry for a summer wedding. Instead of spending 3 hours manually creating a custom quote, contract, and timeline template, she uses WedSync's document templates. She selects her photography package template, automatically pulls in the couple's details and wedding date, customizes the specific services, and generates a branded PDF quote in under 10 minutes. The contract template automatically includes her standard terms, pricing tiers, and payment schedule. When the couple books, the timeline template helps coordinate with other vendors by generating a shared schedule template that other suppliers can reference and build upon.

**Business Impact:**
- 78% of wedding suppliers create the same document types repeatedly
- Average 4-6 hours per wedding spent on document creation
- 23% of suppliers lose bookings due to slow quote turnaround
- 89% want branded, professional-looking documents
- Document errors cause 15% of vendor disputes

### SPECIFICATION SOURCE
- **Feature ID:** WS-353
- **Original Spec:** /CORE-SPECIFICATIONS/document-automation/template-system/
- **Current Implementation:** 0% complete (new feature)
- **Files to Modify:** 
  - Database migrations for template tables
  - API routes for document generation
  - Frontend components for template management
- **New Files to Create:**
  - Document template editor
  - PDF generation service
  - Template library components
  - Document preview system

### TECHNICAL DESIGN

#### Database Schema Required

```sql
-- Document template categories and types
CREATE TABLE document_template_categories (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  category_name VARCHAR(100) UNIQUE NOT NULL,
  category_description TEXT,
  icon_name VARCHAR(50),
  sort_order INTEGER DEFAULT 0,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Core template structure
CREATE TABLE document_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,
  template_name VARCHAR(255) NOT NULL,
  template_description TEXT,
  category_id UUID NOT NULL REFERENCES document_template_categories(id),
  template_type VARCHAR(50) CHECK (template_type IN (
    'contract', 'quote', 'invoice', 'timeline', 'vendor_guide', 'welcome_packet', 
    'questionnaire', 'shot_list', 'floor_plan', 'menu_card', 'seating_chart', 
    'run_of_show', 'contact_sheet', 'emergency_contact', 'payment_schedule'
  )) NOT NULL,
  
  -- Template content and styling
  template_content JSONB NOT NULL DEFAULT '{}', -- Rich content structure
  template_variables JSONB DEFAULT '{}', -- Available merge fields
  template_styling JSONB DEFAULT '{
    "font_family": "Inter",
    "font_size": 12,
    "line_height": 1.4,
    "margins": {"top": 72, "right": 54, "bottom": 72, "left": 54},
    "colors": {
      "primary": "#2D3748",
      "secondary": "#4A5568", 
      "accent": "#3182CE",
      "background": "#FFFFFF"
    },
    "branding": {
      "show_logo": true,
      "logo_position": "top-left",
      "show_contact_info": true,
      "show_social_media": false
    }
  }',
  
  -- Template settings and preferences
  template_settings JSONB DEFAULT '{
    "auto_save": true,
    "require_signatures": false,
    "allow_editing": true,
    "show_terms": true,
    "include_attachments": false,
    "delivery_method": "email",
    "follow_up_enabled": false,
    "track_opens": true
  }',
  
  -- Usage and performance metrics
  usage_count INTEGER DEFAULT 0,
  last_used_at TIMESTAMPTZ,
  template_status VARCHAR(20) CHECK (template_status IN ('active', 'draft', 'archived')) DEFAULT 'draft',
  is_public_template BOOLEAN DEFAULT FALSE, -- Can be shared in template marketplace
  
  -- Version control
  version_number INTEGER DEFAULT 1,
  parent_template_id UUID REFERENCES document_templates(id),
  
  -- Indexing and search
  search_vector TSVECTOR GENERATED ALWAYS AS (
    to_tsvector('english', template_name || ' ' || COALESCE(template_description, ''))
  ) STORED,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(supplier_id, template_name)
);

-- Template variables and merge fields
CREATE TABLE template_variables (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  variable_name VARCHAR(100) NOT NULL,
  variable_type VARCHAR(50) CHECK (variable_type IN (
    'text', 'number', 'currency', 'date', 'boolean', 'list', 'image', 'signature'
  )) NOT NULL,
  variable_category VARCHAR(50) CHECK (variable_category IN (
    'supplier_info', 'couple_info', 'wedding_details', 'pricing', 'timeline', 'custom'
  )) NOT NULL,
  display_name VARCHAR(200) NOT NULL,
  variable_description TEXT,
  default_value TEXT,
  validation_rules JSONB DEFAULT '{}', -- Format, required, min/max length, etc.
  formatting_options JSONB DEFAULT '{}', -- Date formats, currency symbols, etc.
  is_system_variable BOOLEAN DEFAULT FALSE, -- Can't be deleted
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Generated documents from templates
CREATE TABLE generated_documents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  template_id UUID NOT NULL REFERENCES document_templates(id),
  supplier_id UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,
  wedding_id UUID REFERENCES weddings(id) ON DELETE SET NULL,
  couple_id UUID REFERENCES couples(id) ON DELETE SET NULL,
  
  -- Document details
  document_name VARCHAR(255) NOT NULL,
  document_type VARCHAR(50) NOT NULL,
  
  -- Content and data
  document_content JSONB NOT NULL, -- Final merged content
  variable_values JSONB DEFAULT '{}', -- Values used for merge fields
  
  -- File management
  file_path TEXT, -- Generated PDF/DOC location
  file_size INTEGER,
  file_format VARCHAR(10) DEFAULT 'pdf',
  
  -- Document status and workflow
  document_status VARCHAR(50) CHECK (document_status IN (
    'draft', 'generated', 'sent', 'viewed', 'signed', 'completed', 'cancelled'
  )) DEFAULT 'draft',
  
  -- Delivery and tracking
  sent_to_email VARCHAR(255),
  sent_at TIMESTAMPTZ,
  first_viewed_at TIMESTAMPTZ,
  last_viewed_at TIMESTAMPTZ,
  view_count INTEGER DEFAULT 0,
  download_count INTEGER DEFAULT 0,
  
  -- Signatures and approvals
  signatures_required INTEGER DEFAULT 0,
  signatures_received INTEGER DEFAULT 0,
  signature_data JSONB DEFAULT '{}',
  
  -- Expiry and follow-up
  expires_at TIMESTAMPTZ,
  follow_up_sent_at TIMESTAMPTZ,
  
  -- Indexing
  search_vector TSVECTOR GENERATED ALWAYS AS (
    to_tsvector('english', document_name || ' ' || document_type)
  ) STORED,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Document signatures and approvals
CREATE TABLE document_signatures (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  document_id UUID NOT NULL REFERENCES generated_documents(id) ON DELETE CASCADE,
  signer_name VARCHAR(255) NOT NULL,
  signer_email VARCHAR(255) NOT NULL,
  signer_role VARCHAR(50) CHECK (signer_role IN ('bride', 'groom', 'supplier', 'witness', 'guardian')) NOT NULL,
  
  -- Signature details
  signature_image_path TEXT, -- Base64 or file path to signature image
  signature_method VARCHAR(50) CHECK (signature_method IN ('drawn', 'typed', 'uploaded', 'digital_certificate')) NOT NULL,
  ip_address INET,
  user_agent TEXT,
  
  -- Legal compliance
  consent_text TEXT,
  consent_agreed BOOLEAN DEFAULT FALSE,
  identity_verification JSONB DEFAULT '{}', -- ID verification data if required
  
  -- Timestamps
  signed_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  -- Audit trail
  signature_hash TEXT, -- Hash for integrity verification
  
  UNIQUE(document_id, signer_email)
);

-- Template sharing and marketplace
CREATE TABLE template_shares (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  template_id UUID NOT NULL REFERENCES document_templates(id) ON DELETE CASCADE,
  shared_by_supplier_id UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,
  
  -- Sharing settings
  share_type VARCHAR(50) CHECK (share_type IN ('public', 'link_only', 'supplier_network', 'specific_users')) NOT NULL,
  share_price DECIMAL(10,2) DEFAULT 0.00, -- Price if selling template
  share_commission_rate DECIMAL(5,4) DEFAULT 0.0000, -- WedSync commission on sales
  
  -- Access control
  allowed_supplier_ids UUID[] DEFAULT '{}', -- For specific_users sharing
  max_downloads INTEGER, -- Limit downloads
  current_downloads INTEGER DEFAULT 0,
  
  -- Expiry
  expires_at TIMESTAMPTZ,
  
  -- Performance tracking
  view_count INTEGER DEFAULT 0,
  download_count INTEGER DEFAULT 0,
  purchase_count INTEGER DEFAULT 0,
  revenue_generated DECIMAL(12,2) DEFAULT 0.00,
  
  -- Status
  is_active BOOLEAN DEFAULT TRUE,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Template ratings and reviews
CREATE TABLE template_reviews (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  template_id UUID NOT NULL REFERENCES document_templates(id) ON DELETE CASCADE,
  reviewer_supplier_id UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,
  
  -- Review content
  rating INTEGER CHECK (rating >= 1 AND rating <= 5) NOT NULL,
  review_title VARCHAR(255),
  review_content TEXT,
  
  -- Review categories
  ease_of_use_rating INTEGER CHECK (ease_of_use_rating >= 1 AND ease_of_use_rating <= 5),
  design_quality_rating INTEGER CHECK (design_quality_rating >= 1 AND design_quality_rating <= 5),
  usefulness_rating INTEGER CHECK (usefulness_rating >= 1 AND usefulness_rating <= 5),
  
  -- Status
  is_verified_purchase BOOLEAN DEFAULT FALSE,
  review_status VARCHAR(20) CHECK (review_status IN ('pending', 'approved', 'rejected')) DEFAULT 'pending',
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(template_id, reviewer_supplier_id)
);

-- Document generation analytics
CREATE TABLE document_analytics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,
  document_id UUID REFERENCES generated_documents(id) ON DELETE SET NULL,
  template_id UUID REFERENCES document_templates(id) ON DELETE SET NULL,
  
  -- Event tracking
  event_type VARCHAR(50) CHECK (event_type IN (
    'template_used', 'document_generated', 'document_sent', 'document_viewed', 
    'document_downloaded', 'document_signed', 'template_shared', 'template_purchased'
  )) NOT NULL,
  
  -- Context data
  event_data JSONB DEFAULT '{}',
  session_id UUID,
  user_agent TEXT,
  ip_address INET,
  referrer TEXT,
  
  -- Performance metrics
  generation_time_ms INTEGER,
  file_size_kb INTEGER,
  
  recorded_at TIMESTAMPTZ DEFAULT NOW()
);

-- Document collaboration and comments
CREATE TABLE document_comments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  document_id UUID NOT NULL REFERENCES generated_documents(id) ON DELETE CASCADE,
  commenter_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  
  -- Comment content
  comment_content TEXT NOT NULL,
  comment_type VARCHAR(50) CHECK (comment_type IN ('general', 'revision_request', 'approval', 'question')) DEFAULT 'general',
  
  -- Thread and replies
  parent_comment_id UUID REFERENCES document_comments(id),
  thread_depth INTEGER DEFAULT 0,
  
  -- Status and resolution
  comment_status VARCHAR(30) CHECK (comment_status IN ('open', 'resolved', 'archived')) DEFAULT 'open',
  resolved_by_id UUID REFERENCES users(id),
  resolved_at TIMESTAMPTZ,
  
  -- Attachments
  attachment_urls TEXT[] DEFAULT '{}',
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexing for performance
CREATE INDEX idx_document_templates_supplier ON document_templates(supplier_id);
CREATE INDEX idx_document_templates_category ON document_templates(category_id);
CREATE INDEX idx_document_templates_type ON document_templates(template_type);
CREATE INDEX idx_document_templates_status ON document_templates(template_status);
CREATE INDEX idx_document_templates_search ON document_templates USING GIN(search_vector);
CREATE INDEX idx_document_templates_usage ON document_templates(usage_count DESC);

CREATE INDEX idx_generated_documents_supplier ON generated_documents(supplier_id);
CREATE INDEX idx_generated_documents_template ON generated_documents(template_id);
CREATE INDEX idx_generated_documents_wedding ON generated_documents(wedding_id);
CREATE INDEX idx_generated_documents_status ON generated_documents(document_status);
CREATE INDEX idx_generated_documents_created ON generated_documents(created_at DESC);
CREATE INDEX idx_generated_documents_search ON generated_documents USING GIN(search_vector);

CREATE INDEX idx_document_signatures_document ON document_signatures(document_id);
CREATE INDEX idx_document_signatures_email ON document_signatures(signer_email);
CREATE INDEX idx_document_signatures_signed_at ON document_signatures(signed_at DESC);

CREATE INDEX idx_template_shares_template ON template_shares(template_id);
CREATE INDEX idx_template_shares_supplier ON template_shares(shared_by_supplier_id);
CREATE INDEX idx_template_shares_type ON template_shares(share_type);
CREATE INDEX idx_template_shares_active ON template_shares(is_active);

CREATE INDEX idx_document_analytics_supplier ON document_analytics(supplier_id);
CREATE INDEX idx_document_analytics_event ON document_analytics(event_type);
CREATE INDEX idx_document_analytics_recorded ON document_analytics(recorded_at DESC);

-- Insert default template categories
INSERT INTO document_template_categories (category_name, category_description, icon_name, sort_order) VALUES
('Contracts & Legal', 'Service agreements, terms of service, liability waivers', 'file-contract', 1),
('Quotes & Pricing', 'Price quotes, package proposals, cost estimates', 'calculator', 2),
('Invoices & Billing', 'Service invoices, payment requests, receipts', 'receipt', 3),
('Timelines & Schedules', 'Wedding day timelines, vendor schedules, milestone charts', 'calendar', 4),
('Client Communication', 'Welcome packets, questionnaires, information guides', 'message-circle', 5),
('Planning Documents', 'Shot lists, floor plans, seating charts, vendor contacts', 'clipboard-list', 6),
('Marketing Materials', 'Service brochures, portfolio sheets, testimonial cards', 'megaphone', 7);

-- Insert common template variables
INSERT INTO template_variables (variable_name, variable_type, variable_category, display_name, variable_description, is_system_variable) VALUES
-- Supplier information
('supplier_name', 'text', 'supplier_info', 'Business Name', 'Legal business name or trading name', TRUE),
('supplier_contact_name', 'text', 'supplier_info', 'Contact Name', 'Primary contact person name', TRUE),
('supplier_email', 'text', 'supplier_info', 'Email Address', 'Business email address', TRUE),
('supplier_phone', 'text', 'supplier_info', 'Phone Number', 'Business phone number', TRUE),
('supplier_address', 'text', 'supplier_info', 'Business Address', 'Full business address', TRUE),
('supplier_website', 'text', 'supplier_info', 'Website URL', 'Business website', TRUE),
('supplier_logo', 'image', 'supplier_info', 'Business Logo', 'Company logo for branding', TRUE),

-- Couple information
('bride_name', 'text', 'couple_info', 'Bride Name', 'Bride''s full name', TRUE),
('groom_name', 'text', 'couple_info', 'Groom Name', 'Groom''s full name', TRUE),
('couple_email', 'text', 'couple_info', 'Couple Email', 'Primary contact email', TRUE),
('couple_phone', 'text', 'couple_info', 'Couple Phone', 'Primary contact phone', TRUE),
('couple_address', 'text', 'couple_info', 'Couple Address', 'Home address', TRUE),

-- Wedding details
('wedding_date', 'date', 'wedding_details', 'Wedding Date', 'Ceremony date', TRUE),
('wedding_venue', 'text', 'wedding_details', 'Venue Name', 'Ceremony/reception venue', TRUE),
('wedding_venue_address', 'text', 'wedding_details', 'Venue Address', 'Full venue address', TRUE),
('ceremony_time', 'text', 'wedding_details', 'Ceremony Time', 'Start time of ceremony', TRUE),
('reception_time', 'text', 'wedding_details', 'Reception Time', 'Start time of reception', TRUE),
('guest_count', 'number', 'wedding_details', 'Guest Count', 'Expected number of guests', TRUE),
('wedding_style', 'text', 'wedding_details', 'Wedding Style', 'Theme or style preference', TRUE),

-- Pricing
('service_price', 'currency', 'pricing', 'Service Price', 'Total service cost', TRUE),
('deposit_amount', 'currency', 'pricing', 'Deposit Amount', 'Required deposit', TRUE),
('final_payment', 'currency', 'pricing', 'Final Payment', 'Balance due amount', TRUE),
('payment_due_date', 'date', 'pricing', 'Payment Due Date', 'When final payment is due', TRUE),

-- Timeline
('arrival_time', 'text', 'timeline', 'Arrival Time', 'Vendor arrival time', TRUE),
('setup_duration', 'text', 'timeline', 'Setup Duration', 'Time needed for setup', TRUE),
('service_duration', 'text', 'timeline', 'Service Duration', 'Length of service', TRUE),
('breakdown_duration', 'text', 'timeline', 'Breakdown Duration', 'Time needed for cleanup', TRUE);
```

#### API Endpoints Required

```typescript
// Template management interfaces
interface DocumentTemplate {
  id: string;
  supplier_id: string;
  template_name: string;
  template_description?: string;
  category_id: string;
  template_type: 'contract' | 'quote' | 'invoice' | 'timeline' | 'vendor_guide' | 'welcome_packet' | 'questionnaire' | 'shot_list' | 'floor_plan' | 'menu_card' | 'seating_chart' | 'run_of_show' | 'contact_sheet' | 'emergency_contact' | 'payment_schedule';
  template_content: Record<string, any>;
  template_variables: Record<string, any>;
  template_styling: {
    font_family: string;
    font_size: number;
    line_height: number;
    margins: {
      top: number;
      right: number;
      bottom: number;
      left: number;
    };
    colors: {
      primary: string;
      secondary: string;
      accent: string;
      background: string;
    };
    branding: {
      show_logo: boolean;
      logo_position: 'top-left' | 'top-center' | 'top-right';
      show_contact_info: boolean;
      show_social_media: boolean;
    };
  };
  template_settings: {
    auto_save: boolean;
    require_signatures: boolean;
    allow_editing: boolean;
    show_terms: boolean;
    include_attachments: boolean;
    delivery_method: 'email' | 'download' | 'both';
    follow_up_enabled: boolean;
    track_opens: boolean;
  };
  usage_count: number;
  last_used_at?: string;
  template_status: 'active' | 'draft' | 'archived';
  is_public_template: boolean;
  version_number: number;
  parent_template_id?: string;
  created_at: string;
  updated_at: string;
}

interface GeneratedDocument {
  id: string;
  template_id: string;
  supplier_id: string;
  wedding_id?: string;
  couple_id?: string;
  document_name: string;
  document_type: string;
  document_content: Record<string, any>;
  variable_values: Record<string, any>;
  file_path?: string;
  file_size?: number;
  file_format: string;
  document_status: 'draft' | 'generated' | 'sent' | 'viewed' | 'signed' | 'completed' | 'cancelled';
  sent_to_email?: string;
  sent_at?: string;
  first_viewed_at?: string;
  last_viewed_at?: string;
  view_count: number;
  download_count: number;
  signatures_required: number;
  signatures_received: number;
  signature_data: Record<string, any>;
  expires_at?: string;
  follow_up_sent_at?: string;
  created_at: string;
  updated_at: string;
}

interface DocumentSignature {
  id: string;
  document_id: string;
  signer_name: string;
  signer_email: string;
  signer_role: 'bride' | 'groom' | 'supplier' | 'witness' | 'guardian';
  signature_image_path?: string;
  signature_method: 'drawn' | 'typed' | 'uploaded' | 'digital_certificate';
  ip_address?: string;
  user_agent?: string;
  consent_text?: string;
  consent_agreed: boolean;
  identity_verification: Record<string, any>;
  signed_at: string;
  signature_hash?: string;
}

// API request/response interfaces
interface CreateTemplateRequest {
  template_name: string;
  template_description?: string;
  category_id: string;
  template_type: DocumentTemplate['template_type'];
  template_content: Record<string, any>;
  template_styling?: DocumentTemplate['template_styling'];
  template_settings?: DocumentTemplate['template_settings'];
}

interface UpdateTemplateRequest extends Partial<CreateTemplateRequest> {
  template_id: string;
}

interface GenerateDocumentRequest {
  template_id: string;
  wedding_id?: string;
  couple_id?: string;
  variable_values: Record<string, any>;
  document_name?: string;
  delivery_options?: {
    send_immediately: boolean;
    recipient_email?: string;
    include_message?: string;
    require_signature?: boolean;
    expires_in_days?: number;
  };
}

interface TemplateListResponse {
  templates: DocumentTemplate[];
  total_count: number;
  categories: Array<{
    id: string;
    category_name: string;
    template_count: number;
  }>;
  pagination: {
    page: number;
    limit: number;
    total_pages: number;
  };
}

interface DocumentGenerationResponse {
  success: boolean;
  document: GeneratedDocument;
  file_url?: string;
  preview_url?: string;
  signature_urls?: Array<{
    signer_role: string;
    signature_url: string;
  }>;
  message?: string;
}

interface TemplateAnalyticsResponse {
  template_id: string;
  usage_stats: {
    total_uses: number;
    uses_this_month: number;
    success_rate: number;
    average_generation_time: number;
  };
  document_stats: {
    total_generated: number;
    total_sent: number;
    total_signed: number;
    conversion_rate: number;
  };
  popular_variables: Array<{
    variable_name: string;
    usage_count: number;
  }>;
  monthly_usage: Array<{
    month: string;
    usage_count: number;
  }>;
}
```

### CODE EXAMPLES

#### Example 1: Document Template Editor Component

```tsx
'use client';

import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Badge } from '@/components/ui/badge';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Label } from '@/components/ui/label';
import { Switch } from '@/components/ui/switch';
import { Separator } from '@/components/ui/separator';
import { 
  FileText, Save, Eye, Settings, Palette, Variables,
  Upload, Download, Share2, Trash2, Copy, Plus, Minus
} from 'lucide-react';
import { DocumentTemplate, DocumentTemplateCategory } from '@/types/documents';

interface DocumentTemplateEditorProps {
  template?: DocumentTemplate;
  categories: DocumentTemplateCategory[];
  onSave: (template: Partial<DocumentTemplate>) => void;
  onPreview: (content: Record<string, any>) => void;
  onCancel: () => void;
}

export default function DocumentTemplateEditor({
  template,
  categories,
  onSave,
  onPreview,
  onCancel
}: DocumentTemplateEditorProps) {
  const [formData, setFormData] = useState<Partial<DocumentTemplate>>({
    template_name: '',
    template_description: '',
    category_id: '',
    template_type: 'quote',
    template_content: {
      header: '',
      body: [],
      footer: '',
      terms: ''
    },
    template_styling: {
      font_family: 'Inter',
      font_size: 12,
      line_height: 1.4,
      margins: { top: 72, right: 54, bottom: 72, left: 54 },
      colors: {
        primary: '#2D3748',
        secondary: '#4A5568',
        accent: '#3182CE',
        background: '#FFFFFF'
      },
      branding: {
        show_logo: true,
        logo_position: 'top-left',
        show_contact_info: true,
        show_social_media: false
      }
    },
    template_settings: {
      auto_save: true,
      require_signatures: false,
      allow_editing: true,
      show_terms: true,
      include_attachments: false,
      delivery_method: 'email',
      follow_up_enabled: false,
      track_opens: true
    },
    template_status: 'draft'
  });

  const [availableVariables, setAvailableVariables] = useState([
    { name: 'supplier_name', display: 'Business Name', category: 'supplier_info' },
    { name: 'bride_name', display: 'Bride Name', category: 'couple_info' },
    { name: 'groom_name', display: 'Groom Name', category: 'couple_info' },
    { name: 'wedding_date', display: 'Wedding Date', category: 'wedding_details' },
    { name: 'wedding_venue', display: 'Venue Name', category: 'wedding_details' },
    { name: 'service_price', display: 'Service Price', category: 'pricing' },
    { name: 'deposit_amount', display: 'Deposit Amount', category: 'pricing' }
  ]);

  const [contentSections, setContentSections] = useState([
    { id: '1', type: 'paragraph', content: '', variables: [] }
  ]);

  useEffect(() => {
    if (template) {
      setFormData({
        ...template,
        template_content: template.template_content || formData.template_content,
        template_styling: { ...formData.template_styling, ...template.template_styling },
        template_settings: { ...formData.template_settings, ...template.template_settings }
      });
      
      if (template.template_content?.body) {
        setContentSections(template.template_content.body);
      }
    }
  }, [template]);

  const handleInputChange = (field: keyof DocumentTemplate, value: any) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };

  const handleStyleChange = (styleField: string, value: any) => {
    setFormData(prev => ({
      ...prev,
      template_styling: {
        ...prev.template_styling,
        [styleField]: value
      }
    }));
  };

  const handleSettingChange = (settingField: string, value: any) => {
    setFormData(prev => ({
      ...prev,
      template_settings: {
        ...prev.template_settings,
        [settingField]: value
      }
    }));
  };

  const addContentSection = (type: 'paragraph' | 'table' | 'list' | 'image') => {
    const newSection = {
      id: Date.now().toString(),
      type,
      content: type === 'table' ? { headers: [], rows: [] } : '',
      variables: []
    };
    setContentSections(prev => [...prev, newSection]);
  };

  const updateContentSection = (sectionId: string, field: string, value: any) => {
    setContentSections(prev => 
      prev.map(section => 
        section.id === sectionId 
          ? { ...section, [field]: value }
          : section
      )
    );
  };

  const removeContentSection = (sectionId: string) => {
    setContentSections(prev => prev.filter(section => section.id !== sectionId));
  };

  const insertVariable = (sectionId: string, variableName: string) => {
    updateContentSection(sectionId, 'content', 
      contentSections.find(s => s.id === sectionId)?.content + `{{${variableName}}}`
    );
  };

  const handleSave = () => {
    const templateData = {
      ...formData,
      template_content: {
        header: formData.template_content?.header || '',
        body: contentSections,
        footer: formData.template_content?.footer || '',
        terms: formData.template_content?.terms || ''
      }
    };
    onSave(templateData);
  };

  const handlePreview = () => {
    const previewContent = {
      ...formData.template_content,
      body: contentSections
    };
    onPreview(previewContent);
  };

  return (
    <div className="max-w-6xl mx-auto p-6 space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">
            {template ? 'Edit Template' : 'Create Template'}
          </h1>
          <p className="text-gray-600 mt-1">
            Build professional documents with customizable templates
          </p>
        </div>
        
        <div className="flex items-center space-x-3">
          <Button variant="outline" onClick={handlePreview}>
            <Eye className="w-4 h-4 mr-2" />
            Preview
          </Button>
          <Button onClick={handleSave}>
            <Save className="w-4 h-4 mr-2" />
            Save Template
          </Button>
        </div>
      </div>

      <Tabs defaultValue="content" className="space-y-6">
        <TabsList className="grid w-full grid-cols-4">
          <TabsTrigger value="content" className="flex items-center space-x-2">
            <FileText className="w-4 h-4" />
            <span>Content</span>
          </TabsTrigger>
          <TabsTrigger value="styling" className="flex items-center space-x-2">
            <Palette className="w-4 h-4" />
            <span>Styling</span>
          </TabsTrigger>
          <TabsTrigger value="variables" className="flex items-center space-x-2">
            <Variables className="w-4 h-4" />
            <span>Variables</span>
          </TabsTrigger>
          <TabsTrigger value="settings" className="flex items-center space-x-2">
            <Settings className="w-4 h-4" />
            <span>Settings</span>
          </TabsTrigger>
        </TabsList>

        {/* Content Tab */}
        <TabsContent value="content" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>Template Information</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="template_name">Template Name</Label>
                  <Input
                    id="template_name"
                    value={formData.template_name}
                    onChange={(e) => handleInputChange('template_name', e.target.value)}
                    placeholder="e.g., Wedding Photography Quote"
                  />
                </div>
                
                <div className="space-y-2">
                  <Label htmlFor="category_id">Category</Label>
                  <Select 
                    value={formData.category_id} 
                    onValueChange={(value) => handleInputChange('category_id', value)}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="Select category" />
                    </SelectTrigger>
                    <SelectContent>
                      {categories.map(category => (
                        <SelectItem key={category.id} value={category.id}>
                          {category.category_name}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
                
                <div className="space-y-2">
                  <Label htmlFor="template_type">Document Type</Label>
                  <Select 
                    value={formData.template_type} 
                    onValueChange={(value: any) => handleInputChange('template_type', value)}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="Select type" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="contract">Contract</SelectItem>
                      <SelectItem value="quote">Quote</SelectItem>
                      <SelectItem value="invoice">Invoice</SelectItem>
                      <SelectItem value="timeline">Timeline</SelectItem>
                      <SelectItem value="vendor_guide">Vendor Guide</SelectItem>
                      <SelectItem value="welcome_packet">Welcome Packet</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                
                <div className="space-y-2">
                  <Label htmlFor="template_status">Status</Label>
                  <Select 
                    value={formData.template_status} 
                    onValueChange={(value: any) => handleInputChange('template_status', value)}
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="draft">Draft</SelectItem>
                      <SelectItem value="active">Active</SelectItem>
                      <SelectItem value="archived">Archived</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>
              
              <div className="space-y-2">
                <Label htmlFor="template_description">Description</Label>
                <Textarea
                  id="template_description"
                  value={formData.template_description}
                  onChange={(e) => handleInputChange('template_description', e.target.value)}
                  placeholder="Brief description of this template's purpose..."
                  rows={3}
                />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader>
              <div className="flex items-center justify-between">
                <CardTitle>Document Content</CardTitle>
                <div className="flex items-center space-x-2">
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => addContentSection('paragraph')}
                  >
                    <Plus className="w-4 h-4 mr-1" />
                    Add Section
                  </Button>
                </div>
              </div>
            </CardHeader>
            <CardContent className="space-y-6">
              {/* Header */}
              <div className="space-y-2">
                <Label>Document Header</Label>
                <Textarea
                  value={formData.template_content?.header || ''}
                  onChange={(e) => handleInputChange('template_content', {
                    ...formData.template_content,
                    header: e.target.value
                  })}
                  placeholder="Header content (appears at top of document)..."
                  rows={2}
                />
              </div>

              <Separator />

              {/* Content Sections */}
              <div className="space-y-4">
                <Label>Content Sections</Label>
                {contentSections.map((section, index) => (
                  <Card key={section.id} className="border-l-4 border-blue-500">
                    <CardContent className="p-4">
                      <div className="flex items-center justify-between mb-3">
                        <Badge variant="secondary">
                          {section.type.charAt(0).toUpperCase() + section.type.slice(1)} {index + 1}
                        </Badge>
                        <div className="flex items-center space-x-2">
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={() => {
                              // Show variable picker
                            }}
                          >
                            <Variables className="w-4 h-4" />
                          </Button>
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={() => removeContentSection(section.id)}
                          >
                            <Trash2 className="w-4 h-4" />
                          </Button>
                        </div>
                      </div>
                      
                      <Textarea
                        value={section.content as string}
                        onChange={(e) => updateContentSection(section.id, 'content', e.target.value)}
                        placeholder={`Enter ${section.type} content... Use {{variable_name}} for dynamic content.`}
                        rows={4}
                      />
                    </CardContent>
                  </Card>
                ))}
              </div>

              <Separator />

              {/* Footer */}
              <div className="space-y-2">
                <Label>Document Footer</Label>
                <Textarea
                  value={formData.template_content?.footer || ''}
                  onChange={(e) => handleInputChange('template_content', {
                    ...formData.template_content,
                    footer: e.target.value
                  })}
                  placeholder="Footer content (appears at bottom of document)..."
                  rows={2}
                />
              </div>

              {/* Terms */}
              <div className="space-y-2">
                <Label>Terms & Conditions</Label>
                <Textarea
                  value={formData.template_content?.terms || ''}
                  onChange={(e) => handleInputChange('template_content', {
                    ...formData.template_content,
                    terms: e.target.value
                  })}
                  placeholder="Terms and conditions text..."
                  rows={4}
                />
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        {/* Styling Tab */}
        <TabsContent value="styling" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>Document Styling</CardTitle>
            </CardHeader>
            <CardContent className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="space-y-4">
                  <h4 className="font-medium text-gray-900">Typography</h4>
                  <div className="space-y-3">
                    <div>
                      <Label>Font Family</Label>
                      <Select 
                        value={formData.template_styling?.font_family}
                        onValueChange={(value) => handleStyleChange('font_family', value)}
                      >
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="Inter">Inter</SelectItem>
                          <SelectItem value="Arial">Arial</SelectItem>
                          <SelectItem value="Times">Times New Roman</SelectItem>
                          <SelectItem value="Georgia">Georgia</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>
                    
                    <div>
                      <Label>Font Size</Label>
                      <Input
                        type="number"
                        value={formData.template_styling?.font_size}
                        onChange={(e) => handleStyleChange('font_size', parseInt(e.target.value))}
                        min="8"
                        max="24"
                      />
                    </div>
                    
                    <div>
                      <Label>Line Height</Label>
                      <Input
                        type="number"
                        step="0.1"
                        value={formData.template_styling?.line_height}
                        onChange={(e) => handleStyleChange('line_height', parseFloat(e.target.value))}
                        min="1.0"
                        max="3.0"
                      />
                    </div>
                  </div>
                </div>
                
                <div className="space-y-4">
                  <h4 className="font-medium text-gray-900">Colors</h4>
                  <div className="space-y-3">
                    <div>
                      <Label>Primary Color</Label>
                      <Input
                        type="color"
                        value={formData.template_styling?.colors.primary}
                        onChange={(e) => handleStyleChange('colors', {
                          ...formData.template_styling?.colors,
                          primary: e.target.value
                        })}
                      />
                    </div>
                    
                    <div>
                      <Label>Secondary Color</Label>
                      <Input
                        type="color"
                        value={formData.template_styling?.colors.secondary}
                        onChange={(e) => handleStyleChange('colors', {
                          ...formData.template_styling?.colors,
                          secondary: e.target.value
                        })}
                      />
                    </div>
                    
                    <div>
                      <Label>Accent Color</Label>
                      <Input
                        type="color"
                        value={formData.template_styling?.colors.accent}
                        onChange={(e) => handleStyleChange('colors', {
                          ...formData.template_styling?.colors,
                          accent: e.target.value
                        })}
                      />
                    </div>
                  </div>
                </div>
                
                <div className="space-y-4">
                  <h4 className="font-medium text-gray-900">Branding</h4>
                  <div className="space-y-3">
                    <div className="flex items-center justify-between">
                      <Label>Show Logo</Label>
                      <Switch
                        checked={formData.template_styling?.branding.show_logo}
                        onCheckedChange={(checked) => handleStyleChange('branding', {
                          ...formData.template_styling?.branding,
                          show_logo: checked
                        })}
                      />
                    </div>
                    
                    <div>
                      <Label>Logo Position</Label>
                      <Select
                        value={formData.template_styling?.branding.logo_position}
                        onValueChange={(value: any) => handleStyleChange('branding', {
                          ...formData.template_styling?.branding,
                          logo_position: value
                        })}
                      >
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="top-left">Top Left</SelectItem>
                          <SelectItem value="top-center">Top Center</SelectItem>
                          <SelectItem value="top-right">Top Right</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>
                    
                    <div className="flex items-center justify-between">
                      <Label>Show Contact Info</Label>
                      <Switch
                        checked={formData.template_styling?.branding.show_contact_info}
                        onCheckedChange={(checked) => handleStyleChange('branding', {
                          ...formData.template_styling?.branding,
                          show_contact_info: checked
                        })}
                      />
                    </div>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        {/* Variables Tab */}
        <TabsContent value="variables" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>Available Variables</CardTitle>
              <p className="text-sm text-gray-600">
                Insert these variables into your content using {{variable_name}} syntax
              </p>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {availableVariables.map(variable => (
                  <Card key={variable.name} className="p-3">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="font-medium text-sm">{variable.display}</p>
                        <code className="text-xs text-gray-500">
                          {`{{${variable.name}}}`}
                        </code>
                      </div>
                      <Badge variant="outline" className="text-xs">
                        {variable.category.replace('_', ' ')}
                      </Badge>
                    </div>
                  </Card>
                ))}
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        {/* Settings Tab */}
        <TabsContent value="settings" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>Template Settings</CardTitle>
            </CardHeader>
            <CardContent className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="space-y-4">
                  <h4 className="font-medium text-gray-900">Document Behavior</h4>
                  <div className="space-y-3">
                    <div className="flex items-center justify-between">
                      <Label>Auto-save drafts</Label>
                      <Switch
                        checked={formData.template_settings?.auto_save}
                        onCheckedChange={(checked) => handleSettingChange('auto_save', checked)}
                      />
                    </div>
                    
                    <div className="flex items-center justify-between">
                      <Label>Require signatures</Label>
                      <Switch
                        checked={formData.template_settings?.require_signatures}
                        onCheckedChange={(checked) => handleSettingChange('require_signatures', checked)}
                      />
                    </div>
                    
                    <div className="flex items-center justify-between">
                      <Label>Allow client editing</Label>
                      <Switch
                        checked={formData.template_settings?.allow_editing}
                        onCheckedChange={(checked) => handleSettingChange('allow_editing', checked)}
                      />
                    </div>
                  </div>
                </div>
                
                <div className="space-y-4">
                  <h4 className="font-medium text-gray-900">Delivery Options</h4>
                  <div className="space-y-3">
                    <div>
                      <Label>Delivery Method</Label>
                      <Select
                        value={formData.template_settings?.delivery_method}
                        onValueChange={(value: any) => handleSettingChange('delivery_method', value)}
                      >
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="email">Email Only</SelectItem>
                          <SelectItem value="download">Download Only</SelectItem>
                          <SelectItem value="both">Email & Download</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>
                    
                    <div className="flex items-center justify-between">
                      <Label>Track opens</Label>
                      <Switch
                        checked={formData.template_settings?.track_opens}
                        onCheckedChange={(checked) => handleSettingChange('track_opens', checked)}
                      />
                    </div>
                    
                    <div className="flex items-center justify-between">
                      <Label>Enable follow-up</Label>
                      <Switch
                        checked={formData.template_settings?.follow_up_enabled}
                        onCheckedChange={(checked) => handleSettingChange('follow_up_enabled', checked)}
                      />
                    </div>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>
    </div>
  );
}
```

#### Example 2: Document Generation Service

```typescript
// /src/lib/services/document-generation-service.ts
import { createClient } from '@/lib/supabase/server';
import { generatePDF } from '@/lib/pdf/pdf-generator';
import { renderTemplate } from '@/lib/template/template-renderer';
import { DocumentTemplate, GeneratedDocument, GenerateDocumentRequest } from '@/types/documents';

export class DocumentGenerationService {
  private supabase = createClient();

  async generateDocument(request: GenerateDocumentRequest): Promise<GeneratedDocument> {
    try {
      // 1. Fetch template
      const template = await this.getTemplate(request.template_id);
      if (!template) {
        throw new Error('Template not found');
      }

      // 2. Merge variables with content
      const mergedContent = await this.mergeVariables(
        template.template_content,
        request.variable_values
      );

      // 3. Create document record
      const document = await this.createDocumentRecord({
        template_id: request.template_id,
        wedding_id: request.wedding_id,
        couple_id: request.couple_id,
        document_name: request.document_name || `${template.template_name} - ${new Date().toLocaleDateString()}`,
        document_type: template.template_type,
        document_content: mergedContent,
        variable_values: request.variable_values,
        document_status: 'draft'
      });

      // 4. Generate PDF
      const pdfBuffer = await generatePDF(mergedContent, template.template_styling);
      
      // 5. Upload file
      const filePath = await this.uploadDocumentFile(
        document.id,
        pdfBuffer,
        `${document.document_name}.pdf`
      );

      // 6. Update document with file path
      const updatedDocument = await this.updateDocumentFile(document.id, filePath, pdfBuffer.length);

      // 7. Handle delivery if requested
      if (request.delivery_options?.send_immediately && request.delivery_options.recipient_email) {
        await this.sendDocument(
          updatedDocument.id,
          request.delivery_options.recipient_email,
          request.delivery_options.include_message
        );
      }

      // 8. Update template usage stats
      await this.incrementTemplateUsage(request.template_id);

      // 9. Log analytics
      await this.logDocumentGeneration(document.id, template.id, template.supplier_id);

      return updatedDocument;
    } catch (error) {
      console.error('Document generation failed:', error);
      throw new Error(`Failed to generate document: ${error instanceof Error ? error.message : 'Unknown error'}`);
    }
  }

  private async getTemplate(templateId: string): Promise<DocumentTemplate | null> {
    const { data, error } = await this.supabase
      .from('document_templates')
      .select('*')
      .eq('id', templateId)
      .eq('template_status', 'active')
      .single();

    if (error) {
      console.error('Error fetching template:', error);
      return null;
    }

    return data;
  }

  private async mergeVariables(
    content: Record<string, any>,
    variables: Record<string, any>
  ): Promise<Record<string, any>> {
    const mergedContent = JSON.parse(JSON.stringify(content));

    // Function to recursively replace variables in text
    const replaceVariables = (text: string): string => {
      return text.replace(/\{\{(\w+)\}\}/g, (match, variableName) => {
        const value = variables[variableName];
        if (value !== undefined) {
          // Format based on variable type
          if (variableName.includes('date')) {
            return new Date(value).toLocaleDateString('en-GB', {
              weekday: 'long',
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });
          } else if (variableName.includes('price') || variableName.includes('amount')) {
            return new Intl.NumberFormat('en-GB', {
              style: 'currency',
              currency: 'GBP'
            }).format(value);
          } else {
            return String(value);
          }
        }
        return match; // Keep original if variable not found
      });
    };

    // Process header
    if (mergedContent.header) {
      mergedContent.header = replaceVariables(mergedContent.header);
    }

    // Process body sections
    if (mergedContent.body && Array.isArray(mergedContent.body)) {
      mergedContent.body = mergedContent.body.map(section => ({
        ...section,
        content: typeof section.content === 'string' 
          ? replaceVariables(section.content)
          : section.content
      }));
    }

    // Process footer
    if (mergedContent.footer) {
      mergedContent.footer = replaceVariables(mergedContent.footer);
    }

    // Process terms
    if (mergedContent.terms) {
      mergedContent.terms = replaceVariables(mergedContent.terms);
    }

    return mergedContent;
  }

  private async createDocumentRecord(data: Partial<GeneratedDocument>): Promise<GeneratedDocument> {
    const { data: document, error } = await this.supabase
      .from('generated_documents')
      .insert(data)
      .select()
      .single();

    if (error) {
      throw new Error(`Failed to create document record: ${error.message}`);
    }

    return document;
  }

  private async uploadDocumentFile(
    documentId: string,
    fileBuffer: Buffer,
    fileName: string
  ): Promise<string> {
    const filePath = `documents/${documentId}/${fileName}`;
    
    const { error } = await this.supabase.storage
      .from('documents')
      .upload(filePath, fileBuffer, {
        contentType: 'application/pdf',
        upsert: true
      });

    if (error) {
      throw new Error(`Failed to upload document: ${error.message}`);
    }

    return filePath;
  }

  private async updateDocumentFile(
    documentId: string,
    filePath: string,
    fileSize: number
  ): Promise<GeneratedDocument> {
    const { data, error } = await this.supabase
      .from('generated_documents')
      .update({
        file_path: filePath,
        file_size: Math.round(fileSize / 1024), // Convert to KB
        document_status: 'generated',
        updated_at: new Date().toISOString()
      })
      .eq('id', documentId)
      .select()
      .single();

    if (error) {
      throw new Error(`Failed to update document: ${error.message}`);
    }

    return data;
  }

  private async sendDocument(
    documentId: string,
    recipientEmail: string,
    message?: string
  ): Promise<void> {
    // Implementation for sending document via email
    // This would integrate with your email service (Resend, etc.)
    
    // Update document status
    await this.supabase
      .from('generated_documents')
      .update({
        sent_to_email: recipientEmail,
        sent_at: new Date().toISOString(),
        document_status: 'sent'
      })
      .eq('id', documentId);
  }

  private async incrementTemplateUsage(templateId: string): Promise<void> {
    await this.supabase.rpc('increment_template_usage', {
      template_id: templateId
    });
  }

  private async logDocumentGeneration(
    documentId: string,
    templateId: string,
    supplierId: string
  ): Promise<void> {
    await this.supabase
      .from('document_analytics')
      .insert({
        supplier_id: supplierId,
        document_id: documentId,
        template_id: templateId,
        event_type: 'document_generated'
      });
  }

  // Document signature methods
  async addSignature(
    documentId: string,
    signerEmail: string,
    signerName: string,
    signerRole: 'bride' | 'groom' | 'supplier' | 'witness' | 'guardian',
    signatureData: string,
    signatureMethod: 'drawn' | 'typed' | 'uploaded' | 'digital_certificate'
  ): Promise<void> {
    const { error } = await this.supabase
      .from('document_signatures')
      .insert({
        document_id: documentId,
        signer_email: signerEmail,
        signer_name: signerName,
        signer_role: signerRole,
        signature_image_path: signatureData,
        signature_method: signatureMethod,
        ip_address: '0.0.0.0', // Get from request
        user_agent: '', // Get from request
        consent_agreed: true
      });

    if (error) {
      throw new Error(`Failed to add signature: ${error.message}`);
    }

    // Update document signature count
    await this.supabase.rpc('increment_document_signatures', {
      document_id: documentId
    });

    // Check if all signatures collected
    const { data: document } = await this.supabase
      .from('generated_documents')
      .select('signatures_required, signatures_received')
      .eq('id', documentId)
      .single();

    if (document && document.signatures_received >= document.signatures_required) {
      await this.supabase
        .from('generated_documents')
        .update({ document_status: 'fully_signed' })
        .eq('id', documentId);
    }
  }

  // Template analytics
  async getTemplateAnalytics(templateId: string): Promise<any> {
    const { data, error } = await this.supabase
      .rpc('get_template_analytics', { template_id: templateId });

    if (error) {
      throw new Error(`Failed to fetch analytics: ${error.message}`);
    }

    return data;
  }
}

// PostgreSQL functions needed for the service
/*
-- Function to increment template usage
CREATE OR REPLACE FUNCTION increment_template_usage(template_id UUID)
RETURNS VOID AS $$
BEGIN
  UPDATE document_templates 
  SET usage_count = usage_count + 1,
      last_used_at = NOW()
  WHERE id = template_id;
END;
$$ LANGUAGE plpgsql;

-- Function to increment document signatures
CREATE OR REPLACE FUNCTION increment_document_signatures(document_id UUID)
RETURNS VOID AS $$
BEGIN
  UPDATE generated_documents 
  SET signatures_received = signatures_received + 1
  WHERE id = document_id;
END;
$$ LANGUAGE plpgsql;

-- Function to get template analytics
CREATE OR REPLACE FUNCTION get_template_analytics(template_id UUID)
RETURNS TABLE(
  total_uses BIGINT,
  uses_this_month BIGINT,
  total_generated BIGINT,
  total_sent BIGINT,
  total_signed BIGINT,
  success_rate NUMERIC,
  avg_generation_time NUMERIC
) AS $$
BEGIN
  RETURN QUERY
  SELECT 
    t.usage_count::BIGINT as total_uses,
    COALESCE(monthly.uses_this_month, 0)::BIGINT as uses_this_month,
    COALESCE(stats.total_generated, 0)::BIGINT as total_generated,
    COALESCE(stats.total_sent, 0)::BIGINT as total_sent,
    COALESCE(stats.total_signed, 0)::BIGINT as total_signed,
    CASE 
      WHEN COALESCE(stats.total_generated, 0) > 0 
      THEN ROUND(COALESCE(stats.total_signed, 0)::NUMERIC / stats.total_generated * 100, 2)
      ELSE 0
    END as success_rate,
    COALESCE(perf.avg_generation_time, 0) as avg_generation_time
  FROM document_templates t
  LEFT JOIN (
    SELECT COUNT(*) as uses_this_month
    FROM document_analytics da
    WHERE da.template_id = get_template_analytics.template_id
    AND da.event_type = 'document_generated'
    AND da.recorded_at >= date_trunc('month', CURRENT_DATE)
  ) monthly ON true
  LEFT JOIN (
    SELECT 
      COUNT(CASE WHEN gd.document_status != 'draft' THEN 1 END) as total_generated,
      COUNT(CASE WHEN gd.document_status = 'sent' THEN 1 END) as total_sent,
      COUNT(CASE WHEN gd.document_status IN ('signed', 'fully_signed', 'completed') THEN 1 END) as total_signed
    FROM generated_documents gd
    WHERE gd.template_id = get_template_analytics.template_id
  ) stats ON true
  LEFT JOIN (
    SELECT AVG(da.generation_time_ms) as avg_generation_time
    FROM document_analytics da
    WHERE da.template_id = get_template_analytics.template_id
    AND da.event_type = 'document_generated'
    AND da.generation_time_ms IS NOT NULL
  ) perf ON true
  WHERE t.id = get_template_analytics.template_id;
END;
$$ LANGUAGE plpgsql;
*/
```

### ACCEPTANCE CRITERIA
- [ ] **Template Management System**
  - Create, edit, duplicate, and archive document templates
  - Organize templates by categories (contracts, quotes, invoices, etc.)
  - Version control with rollback capability
  - Template sharing and marketplace functionality

- [ ] **Rich Content Editor**
  - WYSIWYG editor with variable insertion
  - Support for text, tables, lists, images, and signatures
  - Custom styling options (fonts, colors, branding)
  - Live preview functionality

- [ ] **Variable Merge System**
  - Pre-defined variable library (supplier info, couple details, wedding info)
  - Custom variable creation and management
  - Automatic formatting (dates, currency, addresses)
  - Data validation and error handling

- [ ] **PDF Generation Engine**
  - High-quality PDF output with consistent formatting
  - Custom styling and branding application
  - Multi-page document support
  - Watermarking and security options

- [ ] **Document Workflow Management**
  - Document status tracking (draft, sent, viewed, signed, completed)
  - Automated delivery via email with tracking
  - Signature collection and management
  - Expiry dates and follow-up reminders

- [ ] **Performance & Scalability**
  - PDF generation under 3 seconds for typical documents
  - Support for 500+ concurrent document generations
  - Template search and filtering under 200ms
  - File storage optimization and CDN delivery

- [ ] **Integration Requirements**
  - Wedding data auto-population from existing records
  - Stripe integration for payment schedules in contracts
  - Email service integration for document delivery
  - Calendar integration for timeline documents

- [ ] **Security & Compliance**
  - Document encryption at rest and in transit
  - Digital signature compliance and audit trails
  - Access control and permission management
  - GDPR-compliant data handling

- [ ] **Mobile Optimization**
  - Responsive template editor for tablet use
  - Mobile document preview and signing
  - Touch-optimized signature capture
  - Offline document viewing capability

- [ ] **Analytics & Reporting**
  - Template usage analytics and performance metrics
  - Document delivery and engagement tracking
  - Conversion rates from quotes to bookings
  - Popular variable usage analysis

### DEPENDENCIES
- Must complete after: User authentication system, supplier onboarding, wedding data management
- Must complete before: Contract automation, invoice generation, client portal
- Shares code with: PDF generation service, email delivery system, file storage management
- External dependencies: PDF generation library, digital signature provider, email service

### ESTIMATED EFFORT
- **Team A Frontend**: 32 hours
  - Template editor interface (16h)
  - Document preview system (8h) 
  - Template library and search (8h)
- **Team B Backend**: 28 hours
  - Database schema and API endpoints (12h)
  - Document generation service (10h)
  - File storage and delivery system (6h)
- **Team C Integration**: 20 hours
  - PDF generation engine integration (10h)
  - Email service integration (6h)
  - Digital signature integration (4h)
- **Team D Platform**: 16 hours
  - Performance optimization (8h)
  - Security implementation (8h)
- **Team E General**: 12 hours
  - Testing and quality assurance (8h)
  - Documentation and user guides (4h)
- **Total**: 108 hours

### TECHNICAL NOTES
1. **PDF Generation**: Use libraries like Puppeteer or jsPDF for consistent cross-platform output
2. **Template Storage**: Store templates as JSON with rich content structure for flexibility
3. **Variable System**: Implement type-safe variable definitions with validation rules
4. **File Management**: Use Supabase Storage with CDN for fast document delivery
5. **Signature Integration**: Consider DocuSign or Adobe Sign APIs for legal compliance
6. **Performance**: Implement caching for frequently used templates and generated documents
7. **Backup Strategy**: Regular backup of template library and generated documents
8. **Audit Logging**: Complete audit trail for all document operations and signatures

### BUSINESS IMPACT
This document template system addresses a critical pain point for wedding suppliers who currently spend 4-6 hours per wedding manually creating contracts, quotes, and other documents. By automating this process, suppliers can:

- **Save 70-80% of document creation time**
- **Reduce errors and inconsistencies** in pricing and terms
- **Improve professional appearance** with branded, consistent documents  
- **Accelerate quote turnaround** from days to minutes
- **Increase booking conversion rates** with faster response times
- **Scale operations** without proportional increase in administrative overhead

The template marketplace feature creates an additional revenue stream while building a community of suppliers sharing best practices and professional document formats.