# TECHNICAL SPECIFICATION: WS-281 - Sharing Controls Enhancement
## Generated by Feature Development Session - 2025-01-20

### USER STORY & BUSINESS CONTEXT (FACTUAL)
**As a:** Bride managing wedding vendor access and information sharing
**I want to:** Control exactly what wedding information each vendor can see and edit
**So that:** I can maintain privacy until contracts are signed while enabling necessary coordination

**Real Wedding Scenario:**
A bride wants her florist to see ceremony details and guest count for arrangement planning, but not reception venue info until the catering contract is finalized. She wants vendors to update their own timeline items but not see other vendors' pricing. Currently, it's all-or-nothing access, causing privacy concerns and coordination conflicts between vendors who compete with each other.

### SPECIFICATION SOURCE
- **Feature ID:** WS-281
- **Original Spec:** Advanced wedding information sharing and collaboration control requirements
- **Current Implementation:** Basic wedding sharing (15% complete)
- **Files to Modify:** 
  - `/src/components/settings/SharingSettings.tsx`
  - `/src/lib/auth/permissions.ts`
  - `/src/middleware.ts`
- **New Files to Create:**
  - `/src/components/sharing/SharingControlsManager.tsx`
  - `/src/components/sharing/VendorPermissionsMatrix.tsx`
  - `/src/components/sharing/GuestAccessControls.tsx`
  - `/src/app/api/sharing/permissions/route.ts`
  - `/src/app/api/sharing/invitations/route.ts`
  - `/src/lib/permissions/sharing-engine.ts`
  - `/src/lib/permissions/access-control.ts`
  - `/src/app/(dashboard)/sharing/page.tsx`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Fine-grained permission system for wedding data sharing
CREATE TABLE IF NOT EXISTS sharing_permissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  wedding_id UUID REFERENCES weddings(id) ON DELETE CASCADE,
  grantee_id UUID REFERENCES auth.users(id), -- Who is being granted access
  grantor_id UUID REFERENCES auth.users(id), -- Who is granting access (couple)
  resource_type VARCHAR(50) NOT NULL CHECK (resource_type IN (
    'wedding_details', 'guest_list', 'timeline', 'vendor_details', 'budget', 
    'venue_info', 'catering_details', 'photo_requirements', 'music_preferences',
    'seating_chart', 'task_list', 'communication_threads', 'documents'
  )),
  resource_id UUID, -- Specific resource ID (nullable for broad permissions)
  permission_level VARCHAR(20) NOT NULL CHECK (permission_level IN (
    'none', 'view', 'edit', 'manage', 'owner'
  )),
  conditions JSONB DEFAULT '{}', -- Conditional access rules
  expires_at TIMESTAMP WITH TIME ZONE,
  granted_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  revoked_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Sharing invitations and access requests
CREATE TABLE IF NOT EXISTS sharing_invitations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  wedding_id UUID REFERENCES weddings(id) ON DELETE CASCADE,
  inviter_id UUID REFERENCES auth.users(id), -- Couple sending invitation
  invitee_email VARCHAR(255) NOT NULL,
  invitee_name VARCHAR(200),
  invitation_type VARCHAR(30) NOT NULL CHECK (invitation_type IN (
    'vendor_access', 'guest_view', 'family_collaboration', 'planner_management'
  )),
  access_scope JSONB NOT NULL, -- What they'll have access to
  personal_message TEXT,
  invitation_token UUID UNIQUE DEFAULT gen_random_uuid(),
  status VARCHAR(20) DEFAULT 'pending' CHECK (status IN (
    'pending', 'accepted', 'declined', 'expired', 'revoked'
  )),
  accepted_at TIMESTAMP WITH TIME ZONE,
  expires_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() + INTERVAL '7 days',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Resource visibility rules (what can be shared)
CREATE TABLE IF NOT EXISTS shareable_resources (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  wedding_id UUID REFERENCES weddings(id) ON DELETE CASCADE,
  resource_type VARCHAR(50) NOT NULL,
  resource_id UUID,
  resource_name VARCHAR(200) NOT NULL,
  is_shareable BOOLEAN DEFAULT TRUE,
  default_permission VARCHAR(20) DEFAULT 'view',
  sharing_rules JSONB DEFAULT '{}',
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(wedding_id, resource_type, resource_id)
);

-- Sharing activity audit log
CREATE TABLE IF NOT EXISTS sharing_audit_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  wedding_id UUID REFERENCES weddings(id),
  action_by UUID REFERENCES auth.users(id),
  action_type VARCHAR(50) NOT NULL, -- 'granted', 'revoked', 'accessed', 'modified'
  resource_type VARCHAR(50),
  resource_id UUID,
  target_user_id UUID REFERENCES auth.users(id),
  details JSONB DEFAULT '{}',
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes for performance
CREATE INDEX idx_sharing_permissions_grantee ON sharing_permissions(grantee_id, wedding_id);
CREATE INDEX idx_sharing_permissions_resource ON sharing_permissions(wedding_id, resource_type, resource_id);
CREATE INDEX idx_sharing_invitations_token ON sharing_invitations(invitation_token);
CREATE INDEX idx_sharing_invitations_email ON sharing_invitations(invitee_email, status);
CREATE INDEX idx_shareable_resources_wedding ON shareable_resources(wedding_id, resource_type);
CREATE INDEX idx_sharing_audit_wedding_date ON sharing_audit_log(wedding_id, created_at DESC);
```

#### API Endpoints Required
```typescript
// POST /api/sharing/permissions - Grant or update permissions
interface GrantPermissionRequest {
  weddingId: string;
  granteeId: string;
  permissions: {
    resourceType: string;
    resourceId?: string;
    permissionLevel: 'view' | 'edit' | 'manage';
    conditions?: {
      timeRestriction?: { start?: string; end?: string };
      ipRestriction?: string[];
      dataFilters?: Record<string, any>;
    };
    expiresAt?: string;
  }[];
}

interface PermissionResponse {
  success: boolean;
  permissions: GrantedPermission[];
}

// GET /api/sharing/permissions?weddingId=x - Get all sharing permissions
interface SharingPermissionsResponse {
  permissions: {
    granteeId: string;
    granteeName: string;
    granteeEmail: string;
    permissions: {
      resourceType: string;
      resourceName: string;
      permissionLevel: string;
      conditions: any;
      expiresAt: string | null;
      grantedAt: string;
    }[];
  }[];
  invitations: {
    id: string;
    inviteeEmail: string;
    inviteeName: string;
    invitationType: string;
    status: string;
    accessScope: any;
    expiresAt: string;
  }[];
}

// POST /api/sharing/invitations - Send sharing invitation
interface SendInvitationRequest {
  weddingId: string;
  inviteeEmail: string;
  inviteeName: string;
  invitationType: 'vendor_access' | 'guest_view' | 'family_collaboration' | 'planner_management';
  accessScope: {
    resources: string[];
    permissions: Record<string, string>;
    conditions?: Record<string, any>;
  };
  personalMessage?: string;
  expiresInDays?: number;
}

// PUT /api/sharing/invitations/[token]/accept - Accept sharing invitation
interface AcceptInvitationRequest {
  acceptTerms: boolean;
  userInfo?: {
    name: string;
    phone?: string;
    company?: string;
  };
}

// DELETE /api/sharing/permissions/[id] - Revoke permission
// PUT /api/sharing/permissions/[id] - Update permission
```

#### Frontend Components Required
```typescript
// Component: SharingControlsManager
// Location: /src/components/sharing/SharingControlsManager.tsx

interface SharingControlsManagerProps {
  weddingId: string;
  userRole: 'bride' | 'groom' | 'couple';
}

// Key functionality:
- Overview of all shared access
- Quick permission grants and revocations
- Active invitation management
- Sharing activity audit viewer
- Bulk permission operations
- Template-based sharing setups

// Component: VendorPermissionsMatrix
// Location: /src/components/sharing/VendorPermissionsMatrix.tsx
interface VendorPermissionsMatrixProps {
  weddingId: string;
  vendors: WeddingVendor[];
  permissions: SharingPermission[];
  onUpdatePermissions: (updates: PermissionUpdate[]) => void;
}

// Key functionality:
- Grid view of vendors vs. wedding resources
- Quick permission level toggles
- Conditional access setup (time-based, data filters)
- Vendor-specific permission templates
- Bulk operations for vendor categories

// Component: GuestAccessControls
// Location: /src/components/sharing/GuestAccessControls.tsx
interface GuestAccessControlsProps {
  weddingId: string;
  guestCategories: GuestCategory[];
  onUpdateGuestAccess: (updates: GuestAccessUpdate[]) => void;
}

// Key functionality:
- Guest category access management
- RSVP information sharing controls
- Wedding website visibility settings
- Photo sharing permissions
- Communication preferences

// Component: ResourceSharingSettings
// Location: /src/components/sharing/ResourceSharingSettings.tsx
interface ResourceSharingSettingsProps {
  weddingId: string;
  resources: ShareableResource[];
  onUpdateResourceSettings: (updates: ResourceUpdate[]) => void;
}

// Key functionality:
- Resource-level sharing configuration
- Default permission settings
- Visibility rules and conditions
- Data masking and filtering options
- Resource grouping and templates
```

#### Integration Points
```typescript
// Service: SharingEngine
// Dependencies: Permission system, user management, audit logging

class WeddingSharingEngine {
  async grantPermissions(weddingId: string, grantorId: string, grants: PermissionGrant[]): Promise<GrantResult[]> {
    // Validate grantor has authority to share resources
    // Check resource sharing rules and restrictions
    // Create permission records with conditions
    // Send notifications to grantees
    // Log sharing activity
  }
  
  async checkAccess(userId: string, weddingId: string, resourceType: string, resourceId?: string): Promise<AccessResult> {
    // Check user's explicit permissions
    // Evaluate conditional access rules (time, IP, data filters)
    // Apply resource-level sharing rules
    // Log access attempt
    // Return permission level and any data filters
  }
  
  async revokeAccess(weddingId: string, grantorId: string, granteeId: string, resourceType: string): Promise<RevokeResult> {
    // Validate authority to revoke
    // Update permission records
    // Notify affected users
    // Log revocation activity
  }
}

// Service: AccessControlMiddleware
// Dependencies: Sharing engine, session management

class WeddingAccessControl {
  async enforcePermissions(req: Request, resourceType: string, resourceId?: string): Promise<PermissionCheck> {
    // Extract user and wedding context from request
    // Check permissions via sharing engine
    // Apply data filtering based on permission conditions
    // Set access context for downstream handlers
  }
  
  async filterData(data: any, userPermissions: Permission, resourceType: string): Promise<any> {
    // Apply data masking based on permission conditions
    // Filter sensitive information based on sharing rules
    // Return appropriately filtered data
  }
}

// Service: InvitationService
// Dependencies: Email service, user management, sharing engine

class SharingInvitationService {
  async sendInvitation(invitation: SharingInvitation): Promise<InvitationResult> {
    // Generate secure invitation token
    // Create invitation record with expiration
    // Send personalized email with access details
    // Set up reminder notifications
  }
  
  async acceptInvitation(token: string, acceptanceData: AcceptanceData): Promise<AcceptResult> {
    // Validate invitation token and expiration
    // Create or link user account
    // Grant specified permissions
    // Send confirmation to inviter and invitee
  }
}
```

### CODE EXAMPLES

#### Example 1: Sharing Controls Manager
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
'use client';
import { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Switch } from '@/components/ui/switch';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Users, Shield, Clock, Share2, Eye, Edit, Settings } from 'lucide-react';

interface SharingPermission {
  granteeId: string;
  granteeName: string;
  granteeEmail: string;
  permissions: {
    resourceType: string;
    resourceName: string;
    permissionLevel: 'view' | 'edit' | 'manage';
    conditions: any;
    expiresAt: string | null;
    grantedAt: string;
  }[];
}

interface SharingInvitation {
  id: string;
  inviteeEmail: string;
  inviteeName: string;
  invitationType: string;
  status: 'pending' | 'accepted' | 'declined' | 'expired';
  accessScope: any;
  expiresAt: string;
}

export function SharingControlsManager({ weddingId, userRole }: SharingControlsManagerProps) {
  const [permissions, setPermissions] = useState<SharingPermission[]>([]);
  const [invitations, setInvitations] = useState<SharingInvitation[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [showInviteModal, setShowInviteModal] = useState(false);
  const [selectedResource, setSelectedResource] = useState<string | null>(null);

  const weddingResources = [
    { id: 'wedding_details', name: 'Wedding Details', description: 'Date, time, basic information' },
    { id: 'guest_list', name: 'Guest List', description: 'Names, contact info, RSVP status' },
    { id: 'timeline', name: 'Wedding Timeline', description: 'Day-of schedule and events' },
    { id: 'vendor_details', name: 'Vendor Information', description: 'Vendor contacts and contracts' },
    { id: 'venue_info', name: 'Venue Details', description: 'Location, capacity, restrictions' },
    { id: 'catering_details', name: 'Catering Information', description: 'Menu, dietary needs, service details' },
    { id: 'photo_requirements', name: 'Photography Requirements', description: 'Shot lists, must-have photos' },
    { id: 'seating_chart', name: 'Seating Arrangements', description: 'Table assignments and layouts' },
    { id: 'task_list', name: 'Task Management', description: 'Wedding planning tasks and assignments' },
    { id: 'communication_threads', name: 'Communication', description: 'Messages and conversations' },
  ];

  useEffect(() => {
    loadSharingData();
  }, [weddingId]);

  const loadSharingData = async () => {
    try {
      const response = await fetch(`/api/sharing/permissions?weddingId=${weddingId}`);
      const data = await response.json();
      
      setPermissions(data.permissions || []);
      setInvitations(data.invitations || []);
    } catch (error) {
      console.error('Error loading sharing data:', error);
    } finally {
      setIsLoading(false);
    }
  };

  const updatePermission = async (granteeId: string, resourceType: string, newLevel: string) => {
    try {
      const response = await fetch('/api/sharing/permissions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          weddingId,
          granteeId,
          permissions: [{
            resourceType,
            permissionLevel: newLevel === 'none' ? 'none' : newLevel
          }]
        })
      });

      if (response.ok) {
        await loadSharingData();
      }
    } catch (error) {
      console.error('Error updating permission:', error);
    }
  };

  const revokeAllPermissions = async (granteeId: string) => {
    if (!confirm('Are you sure you want to revoke all permissions for this user?')) return;

    try {
      const response = await fetch(`/api/sharing/permissions/${granteeId}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ weddingId })
      });

      if (response.ok) {
        await loadSharingData();
      }
    } catch (error) {
      console.error('Error revoking permissions:', error);
    }
  };

  const sendInvitation = async (invitationData: any) => {
    try {
      const response = await fetch('/api/sharing/invitations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          weddingId,
          ...invitationData
        })
      });

      if (response.ok) {
        await loadSharingData();
        setShowInviteModal(false);
      }
    } catch (error) {
      console.error('Error sending invitation:', error);
    }
  };

  const getPermissionIcon = (level: string) => {
    switch (level) {
      case 'view': return <Eye className="w-4 h-4" />;
      case 'edit': return <Edit className="w-4 h-4" />;
      case 'manage': return <Settings className="w-4 h-4" />;
      default: return null;
    }
  };

  const getPermissionColor = (level: string) => {
    switch (level) {
      case 'view': return 'bg-blue-100 text-blue-800';
      case 'edit': return 'bg-green-100 text-green-800';
      case 'manage': return 'bg-purple-100 text-purple-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'pending': return 'bg-yellow-100 text-yellow-800';
      case 'accepted': return 'bg-green-100 text-green-800';
      case 'declined': return 'bg-red-100 text-red-800';
      case 'expired': return 'bg-gray-100 text-gray-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  };

  if (isLoading) {
    return <div className="animate-pulse p-8">Loading sharing controls...</div>;
  }

  const activeUsers = permissions.length;
  const pendingInvitations = invitations.filter(i => i.status === 'pending').length;
  const totalResources = weddingResources.length;
  const sharedResources = new Set(permissions.flatMap(p => p.permissions.map(perm => perm.resourceType))).size;

  return (
    <div className="space-y-6">
      {/* Sharing Overview */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">Active Users</p>
                <p className="text-2xl font-bold">{activeUsers}</p>
              </div>
              <Users className="w-8 h-8 text-blue-600" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">Pending Invites</p>
                <p className="text-2xl font-bold">{pendingInvitations}</p>
              </div>
              <Clock className="w-8 h-8 text-orange-600" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">Shared Resources</p>
                <p className="text-2xl font-bold">{sharedResources}/{totalResources}</p>
              </div>
              <Share2 className="w-8 h-8 text-green-600" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">Security Level</p>
                <p className="text-2xl font-bold">High</p>
              </div>
              <Shield className="w-8 h-8 text-purple-600" />
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Quick Actions */}
      <div className="flex flex-wrap gap-4">
        <Button onClick={() => setShowInviteModal(true)}>
          Invite Vendor
        </Button>
        <Button variant="outline">
          Invite Family Member
        </Button>
        <Button variant="outline">
          Share with Planner
        </Button>
        <Button variant="outline">
          Bulk Permissions
        </Button>
      </div>

      {/* Active Permissions */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center space-x-2">
            <Users className="w-5 h-5" />
            <span>Active Permissions</span>
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            {permissions.map(permission => (
              <div key={permission.granteeId} className="border rounded-lg p-4">
                <div className="flex items-center justify-between mb-3">
                  <div>
                    <h3 className="font-semibold">{permission.granteeName}</h3>
                    <p className="text-sm text-gray-600">{permission.granteeEmail}</p>
                  </div>
                  <div className="flex items-center space-x-2">
                    <Badge variant="secondary">
                      {permission.permissions.length} resources
                    </Badge>
                    <Button 
                      size="sm" 
                      variant="outline"
                      onClick={() => revokeAllPermissions(permission.granteeId)}
                    >
                      Revoke All
                    </Button>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                  {permission.permissions.map(perm => (
                    <div key={`${perm.resourceType}`} className="flex items-center justify-between p-2 bg-gray-50 rounded">
                      <div className="flex items-center space-x-2">
                        {getPermissionIcon(perm.permissionLevel)}
                        <span className="text-sm font-medium">{perm.resourceName}</span>
                      </div>
                      
                      <Select
                        value={perm.permissionLevel}
                        onValueChange={(value) => updatePermission(permission.granteeId, perm.resourceType, value)}
                      >
                        <SelectTrigger className="w-24 h-8">
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="none">None</SelectItem>
                          <SelectItem value="view">View</SelectItem>
                          <SelectItem value="edit">Edit</SelectItem>
                          <SelectItem value="manage">Manage</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>
                  ))}
                </div>

                {/* Show conditions if any */}
                {permission.permissions.some(p => p.conditions && Object.keys(p.conditions).length > 0) && (
                  <div className="mt-3 p-2 bg-blue-50 rounded text-sm">
                    <strong>Access Conditions:</strong> Time restrictions, IP filters, or data limitations apply
                  </div>
                )}
              </div>
            ))}
          </div>

          {permissions.length === 0 && (
            <div className="text-center py-8 text-gray-500">
              <Shield className="w-12 h-12 mx-auto mb-4 opacity-50" />
              <h3 className="text-lg font-medium mb-2">No active permissions</h3>
              <p>Share your wedding information with vendors, family, or planners.</p>
              <Button onClick={() => setShowInviteModal(true)} className="mt-4">
                Send First Invitation
              </Button>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Pending Invitations */}
      {invitations.length > 0 && (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center space-x-2">
              <Clock className="w-5 h-5" />
              <span>Pending Invitations</span>
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {invitations.map(invitation => (
                <div key={invitation.id} className="flex items-center justify-between p-3 border rounded">
                  <div>
                    <h4 className="font-medium">{invitation.inviteeName || invitation.inviteeEmail}</h4>
                    <p className="text-sm text-gray-600">
                      {invitation.invitationType.replace('_', ' ').charAt(0).toUpperCase() + invitation.invitationType.slice(1)}
                    </p>
                    <p className="text-xs text-gray-500">
                      Expires: {new Date(invitation.expiresAt).toLocaleDateString()}
                    </p>
                  </div>
                  <div className="flex items-center space-x-2">
                    <Badge className={getStatusColor(invitation.status)}>
                      {invitation.status.charAt(0).toUpperCase() + invitation.status.slice(1)}
                    </Badge>
                    {invitation.status === 'pending' && (
                      <Button size="sm" variant="outline">
                        Resend
                      </Button>
                    )}
                  </div>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      )}

      {/* Resource Sharing Matrix */}
      <Card>
        <CardHeader>
          <CardTitle>Resource Sharing Overview</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-3">
            {weddingResources.map(resource => {
              const isShared = permissions.some(p => 
                p.permissions.some(perm => perm.resourceType === resource.id)
              );
              const sharedWith = permissions.filter(p => 
                p.permissions.some(perm => perm.resourceType === resource.id)
              ).length;

              return (
                <div key={resource.id} className="flex items-center justify-between p-3 border rounded hover:bg-gray-50">
                  <div className="flex-1">
                    <h4 className="font-medium">{resource.name}</h4>
                    <p className="text-sm text-gray-600">{resource.description}</p>
                  </div>
                  <div className="flex items-center space-x-3">
                    {isShared ? (
                      <Badge variant="secondary">{sharedWith} user{sharedWith !== 1 ? 's' : ''}</Badge>
                    ) : (
                      <Badge variant="outline">Not shared</Badge>
                    )}
                    <Button size="sm" variant="outline">
                      Configure
                    </Button>
                  </div>
                </div>
              );
            })}
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
```

#### Example 2: Vendor Permissions Matrix
```typescript
'use client';
import { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Switch } from '@/components/ui/switch';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Eye, Edit, Settings, Clock } from 'lucide-react';

interface WeddingVendor {
  id: string;
  name: string;
  category: string;
  email: string;
  status: 'pending' | 'active' | 'completed';
}

interface PermissionUpdate {
  vendorId: string;
  resourceType: string;
  permissionLevel: 'none' | 'view' | 'edit' | 'manage';
  conditions?: any;
}

export function VendorPermissionsMatrix({ weddingId, vendors, permissions, onUpdatePermissions }: VendorPermissionsMatrixProps) {
  const [selectedVendor, setSelectedVendor] = useState<string | null>(null);
  const [bulkResourceType, setBulkResourceType] = useState<string>('');
  const [bulkPermissionLevel, setBulkPermissionLevel] = useState<string>('view');
  const [showConditionsModal, setShowConditionsModal] = useState(false);

  const weddingResources = [
    { id: 'wedding_details', name: 'Wedding Details', vendorRelevant: ['all'] },
    { id: 'guest_list', name: 'Guest List', vendorRelevant: ['caterer', 'venue', 'coordinator'] },
    { id: 'timeline', name: 'Timeline', vendorRelevant: ['all'] },
    { id: 'vendor_details', name: 'Other Vendors', vendorRelevant: ['coordinator', 'planner'] },
    { id: 'venue_info', name: 'Venue Details', vendorRelevant: ['caterer', 'photographer', 'florist', 'dj'] },
    { id: 'catering_details', name: 'Catering', vendorRelevant: ['venue', 'coordinator'] },
    { id: 'photo_requirements', name: 'Photo Requirements', vendorRelevant: ['photographer'] },
    { id: 'seating_chart', name: 'Seating Chart', vendorRelevant: ['caterer', 'venue', 'coordinator'] },
    { id: 'task_list', name: 'Tasks', vendorRelevant: ['all'] },
  ];

  const getVendorPermission = (vendorId: string, resourceType: string): string => {
    const vendorPermissions = permissions.find(p => p.granteeId === vendorId);
    const resourcePermission = vendorPermissions?.permissions.find(perm => perm.resourceType === resourceType);
    return resourcePermission?.permissionLevel || 'none';
  };

  const isResourceRelevant = (resourceId: string, vendorCategory: string): boolean => {
    const resource = weddingResources.find(r => r.id === resourceId);
    return resource?.vendorRelevant.includes('all') || resource?.vendorRelevant.includes(vendorCategory.toLowerCase()) || false;
  };

  const updatePermission = (vendorId: string, resourceType: string, permissionLevel: string) => {
    const update: PermissionUpdate = {
      vendorId,
      resourceType,
      permissionLevel: permissionLevel as any
    };
    onUpdatePermissions([update]);
  };

  const bulkUpdatePermissions = () => {
    if (!bulkResourceType) return;

    const updates: PermissionUpdate[] = vendors.map(vendor => ({
      vendorId: vendor.id,
      resourceType: bulkResourceType,
      permissionLevel: bulkPermissionLevel as any
    }));

    onUpdatePermissions(updates);
  };

  const applyVendorTemplate = (vendorId: string, template: 'minimal' | 'standard' | 'full') => {
    const vendor = vendors.find(v => v.id === vendorId);
    if (!vendor) return;

    const updates: PermissionUpdate[] = [];

    weddingResources.forEach(resource => {
      if (!isResourceRelevant(resource.id, vendor.category)) return;

      let permissionLevel: 'none' | 'view' | 'edit' = 'none';

      switch (template) {
        case 'minimal':
          permissionLevel = ['wedding_details', 'timeline'].includes(resource.id) ? 'view' : 'none';
          break;
        case 'standard':
          permissionLevel = isResourceRelevant(resource.id, vendor.category) ? 'view' : 'none';
          break;
        case 'full':
          permissionLevel = isResourceRelevant(resource.id, vendor.category) ? 'edit' : 'view';
          break;
      }

      updates.push({
        vendorId,
        resourceType: resource.id,
        permissionLevel
      });
    });

    onUpdatePermissions(updates);
  };

  const getPermissionIcon = (level: string) => {
    switch (level) {
      case 'view': return <Eye className="w-4 h-4 text-blue-600" />;
      case 'edit': return <Edit className="w-4 h-4 text-green-600" />;
      case 'manage': return <Settings className="w-4 h-4 text-purple-600" />;
      default: return null;
    }
  };

  return (
    <div className="space-y-6">
      {/* Bulk Operations */}
      <Card>
        <CardHeader>
          <CardTitle>Bulk Permission Management</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="flex items-center space-x-4">
            <Select value={bulkResourceType} onValueChange={setBulkResourceType}>
              <SelectTrigger className="w-48">
                <SelectValue placeholder="Select resource" />
              </SelectTrigger>
              <SelectContent>
                {weddingResources.map(resource => (
                  <SelectItem key={resource.id} value={resource.id}>
                    {resource.name}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>

            <Select value={bulkPermissionLevel} onValueChange={setBulkPermissionLevel}>
              <SelectTrigger className="w-32">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="none">None</SelectItem>
                <SelectItem value="view">View</SelectItem>
                <SelectItem value="edit">Edit</SelectItem>
                <SelectItem value="manage">Manage</SelectItem>
              </SelectContent>
            </Select>

            <Button onClick={bulkUpdatePermissions} disabled={!bulkResourceType}>
              Apply to All Vendors
            </Button>
          </div>
        </CardContent>
      </Card>

      {/* Permissions Matrix */}
      <Card>
        <CardHeader>
          <CardTitle>Vendor Permissions Matrix</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="overflow-x-auto">
            <table className="w-full border-collapse min-w-[1000px]">
              <thead>
                <tr className="border-b">
                  <th className="text-left p-3 font-medium sticky left-0 bg-white border-r min-w-[200px]">
                    Vendor
                  </th>
                  {weddingResources.map(resource => (
                    <th key={resource.id} className="text-center p-3 font-medium min-w-[120px]">
                      <div className="flex flex-col items-center space-y-1">
                        <span className="text-sm">{resource.name}</span>
                      </div>
                    </th>
                  ))}
                  <th className="text-center p-3 font-medium min-w-[150px]">Quick Templates</th>
                </tr>
              </thead>
              <tbody>
                {vendors.map(vendor => (
                  <tr key={vendor.id} className="border-b hover:bg-gray-50">
                    <td className="p-3 sticky left-0 bg-white border-r">
                      <div>
                        <div className="font-medium">{vendor.name}</div>
                        <div className="text-sm text-gray-600">{vendor.category}</div>
                        <div className="text-xs text-gray-500">{vendor.email}</div>
                        <Badge 
                          variant={vendor.status === 'active' ? 'success' : vendor.status === 'pending' ? 'warning' : 'secondary'}
                          className="mt-1"
                        >
                          {vendor.status}
                        </Badge>
                      </div>
                    </td>
                    
                    {weddingResources.map(resource => {
                      const currentPermission = getVendorPermission(vendor.id, resource.id);
                      const isRelevant = isResourceRelevant(resource.id, vendor.category);
                      
                      return (
                        <td key={resource.id} className="p-3 text-center">
                          <div className="flex flex-col items-center space-y-1">
                            {isRelevant ? (
                              <Select
                                value={currentPermission}
                                onValueChange={(value) => updatePermission(vendor.id, resource.id, value)}
                              >
                                <SelectTrigger className="w-20 h-8">
                                  <div className="flex items-center space-x-1">
                                    {getPermissionIcon(currentPermission)}
                                  </div>
                                </SelectTrigger>
                                <SelectContent>
                                  <SelectItem value="none">None</SelectItem>
                                  <SelectItem value="view">
                                    <div className="flex items-center space-x-2">
                                      <Eye className="w-4 h-4" />
                                      <span>View</span>
                                    </div>
                                  </SelectItem>
                                  <SelectItem value="edit">
                                    <div className="flex items-center space-x-2">
                                      <Edit className="w-4 h-4" />
                                      <span>Edit</span>
                                    </div>
                                  </SelectItem>
                                  <SelectItem value="manage">
                                    <div className="flex items-center space-x-2">
                                      <Settings className="w-4 h-4" />
                                      <span>Manage</span>
                                    </div>
                                  </SelectItem>
                                </SelectContent>
                              </Select>
                            ) : (
                              <div className="text-xs text-gray-400 px-2 py-1 bg-gray-100 rounded">
                                N/A
                              </div>
                            )}
                          </div>
                        </td>
                      );
                    })}
                    
                    <td className="p-3 text-center">
                      <div className="flex flex-col space-y-1">
                        <Button 
                          size="sm" 
                          variant="outline"
                          onClick={() => applyVendorTemplate(vendor.id, 'minimal')}
                          className="text-xs"
                        >
                          Minimal
                        </Button>
                        <Button 
                          size="sm" 
                          variant="outline"
                          onClick={() => applyVendorTemplate(vendor.id, 'standard')}
                          className="text-xs"
                        >
                          Standard
                        </Button>
                        <Button 
                          size="sm" 
                          variant="outline"
                          onClick={() => applyVendorTemplate(vendor.id, 'full')}
                          className="text-xs"
                        >
                          Full Access
                        </Button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {vendors.length === 0 && (
            <div className="text-center py-8 text-gray-500">
              <Settings className="w-12 h-12 mx-auto mb-4 opacity-50" />
              <h3 className="text-lg font-medium mb-2">No vendors added</h3>
              <p>Add vendors to your wedding to configure their access permissions.</p>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Permission Legend */}
      <Card>
        <CardHeader>
          <CardTitle>Permission Levels</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div className="flex items-center space-x-3 p-3 border rounded">
              <Eye className="w-6 h-6 text-blue-600" />
              <div>
                <div className="font-medium">View Access</div>
                <div className="text-sm text-gray-600">Can see information but cannot make changes</div>
              </div>
            </div>
            
            <div className="flex items-center space-x-3 p-3 border rounded">
              <Edit className="w-6 h-6 text-green-600" />
              <div>
                <div className="font-medium">Edit Access</div>
                <div className="text-sm text-gray-600">Can view and modify specific information</div>
              </div>
            </div>
            
            <div className="flex items-center space-x-3 p-3 border rounded">
              <Settings className="w-6 h-6 text-purple-600" />
              <div>
                <div className="font-medium">Manage Access</div>
                <div className="text-sm text-gray-600">Full control including sharing with others</div>
              </div>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Ref MCP: Search docs for access control patterns, permission systems
- [x] Supabase MCP: Database operations and Row Level Security
- [x] Browser MCP: Interactive testing of sharing controls interface
- [x] Filesystem: Access permission templates and configurations

#### Ref MCP Searches Needed
```bash
# Use Ref MCP to search for:
# - "React permission matrix components"
# - "Access control system patterns"
# - "Invitation-based sharing systems"
# - "Conditional access control best practices"
```

#### Browser MCP Interactive Testing
```bash
# Use Browser MCP for:
# - Testing permission matrix interactions
# - Verifying invitation flow functionality
# - Screenshot capture of sharing interfaces
# - Testing mobile responsive permission controls
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('WeddingSharingEngine', () => {
  it('should grant permissions correctly with conditions', async () => {
    const engine = new WeddingSharingEngine();
    const result = await engine.grantPermissions('wedding-id', 'grantor-id', mockPermissions);
    expect(result).toContainEqual(expect.objectContaining({ success: true }));
  });
  
  it('should check access permissions with conditional rules', async () => {
    // Test access checking with time-based and data filter conditions
  });
  
  it('should revoke permissions and notify affected users', async () => {
    // Test permission revocation and notification system
  });
  
  it('should handle invitation expiration correctly', async () => {
    // Test invitation lifecycle and expiration handling
  });
});
```

#### E2E Tests Required
```typescript
test('Configure vendor sharing permissions', async () => {
  await mcp__playwright__browser_navigate({url: '/wedding/test-wedding/sharing'});
  
  // Open vendor permissions matrix
  await mcp__playwright__browser_click({element: 'Vendor permissions tab', ref: '[data-testid="vendor-permissions"]'});
  
  // Grant timeline view access to photographer
  await mcp__playwright__browser_select_option({
    element: 'Timeline permission for photographer', 
    ref: '[data-testid="photographer-timeline-permission"]', 
    values: ['view']
  });
  
  // Apply bulk permissions for venue information
  await mcp__playwright__browser_select_option({element: 'Bulk resource', ref: '[data-testid="bulk-resource"]', values: ['venue_info']});
  await mcp__playwright__browser_select_option({element: 'Bulk permission', ref: '[data-testid="bulk-permission"]', values: ['view']});
  await mcp__playwright__browser_click({element: 'Apply bulk', ref: '[data-testid="apply-bulk"]'});
  
  // Send vendor invitation
  await mcp__playwright__browser_click({element: 'Invite vendor', ref: '[data-testid="invite-vendor"]'});
  await mcp__playwright__browser_type({element: 'Vendor email', ref: '[data-testid="vendor-email"]', text: 'vendor@example.com'});
  await mcp__playwright__browser_click({element: 'Send invitation', ref: '[data-testid="send-invitation"]'});
  
  // Verify invitation appears in pending list
  const invitation = await page.waitForSelector('[data-testid="pending-invitation"]');
  expect(invitation).toBeTruthy();
});
```

### ACCEPTANCE CRITERIA
- [x] Fine-grained permission control for each wedding resource
- [x] Vendor-specific permission templates and bulk operations
- [x] Time-based and conditional access restrictions
- [x] Invitation-based sharing with secure token system
- [x] Permission audit trail and activity logging
- [x] Resource-level sharing rules and default permissions
- [x] Guest category access controls for public information
- [x] Data filtering based on permission levels
- [x] Mobile-responsive permissions management interface
- [x] **Navigation Integration: Sharing controls accessible from wedding settings**
  - [x] Sharing/Permissions tab in wedding settings menu
  - [x] Quick access to vendor permissions from vendor dashboard
  - [x] Security indicators in main navigation for active sharing
  - [x] Mobile navigation support for sharing management
  - [x] Integration with wedding privacy and security settings

### DEPENDENCIES
- Must complete after: User authentication system, wedding management, vendor management
- Must complete before: Dashboard Tour System (WS-282)
- Shares code with: Permission system, user management, audit logging

### ESTIMATED EFFORT
- Team A Frontend: 40 hours (Sharing UI, permissions matrix, invitation interface, mobile responsive)
- Team B Backend: 48 hours (Permission engine, access control middleware, invitation system, audit logging)
- Team C Integration: 16 hours (Row Level Security setup, user management integration)
- Team D Platform: 20 hours (Resource sharing rules, conditional access, security controls)
- Team E General: 24 hours (Testing, accessibility, error handling, mobile testing)
- Team F Workflows: 12 hours (Invitation flows, permission templates, user experience)
- Team G Performance: 8 hours (Permission checking optimization, caching strategies)
- Total: 168 hours