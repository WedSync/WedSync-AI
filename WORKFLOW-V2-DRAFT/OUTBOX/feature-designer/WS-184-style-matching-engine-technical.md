# TECHNICAL SPECIFICATION: WS-184 - Style Matching Engine
## Generated by Feature Development Session - August 25, 2025

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Couple planning their wedding and searching for suppliers with matching aesthetic vision
**I want to:** Complete a visual style assessment and receive AI-matched suppliers who align with my specific wedding aesthetic preferences
**So that:** I can find photographers, venues, and florists whose portfolio style perfectly matches my vision, eliminating hours of manual portfolio browsing and ensuring aesthetic consistency across vendors

**Real Wedding Scenario:**
A couple planning a bohemian outdoor wedding in earthy tones spends weeks scrolling through hundreds of photographer portfolios, trying to identify who shoots in their preferred style. Many photographers mix styles, making it hard to assess compatibility. The Style Matching Engine analyzes the couple's color preferences (sage green, terracotta, cream) and style tags (bohemian, natural, relaxed) to automatically identify photographers whose portfolios show 85%+ style compatibility, presenting only 12 highly compatible photographers instead of 200+ generic results.

### SPECIFICATION SOURCE
- **Feature ID:** WS-184
- **Original Spec:** /CORE-SPECIFICATIONS/06-DIRECTORY/03-Discovery-Features/04-style-matching md.md
- **Current Implementation:** 0% complete (new)
- **Files to Modify:** None (new feature)
- **New Files to Create:** 
  - `/wedsync/src/components/directory/StyleDiscoveryWizard.tsx`
  - `/wedsync/src/components/directory/StyleMatchResults.tsx`
  - `/wedsync/src/lib/ai/style-matching-engine.ts`
  - `/wedsync/src/app/api/ai/style-analysis/route.ts`
  - `/wedsync/supabase/migrations/style-matching-system.sql`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Style profiles with AI embeddings
CREATE TABLE style_profiles (
  id UUID PRIMARY KEY,
  owner_id UUID NOT NULL,
  owner_type VARCHAR(20) CHECK (owner_type IN ('couple', 'supplier')),
  style_tags JSONB,
  color_palette JSONB,
  aesthetic_preferences JSONB,
  style_vector vector(512), -- Using pgvector for similarity search
  confidence_score DECIMAL(3,2),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Style matching results cache
CREATE TABLE style_matches (
  id UUID PRIMARY KEY,
  couple_style_id UUID REFERENCES style_profiles(id),
  supplier_style_id UUID REFERENCES style_profiles(id),
  compatibility_score DECIMAL(3,2),
  matching_elements JSONB,
  calculated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Vector similarity index for fast style matching
CREATE INDEX idx_style_vector_similarity 
ON style_profiles USING ivfflat (style_vector vector_cosine_ops);
```

#### API Endpoints Required
```typescript
// POST /api/ai/style-analysis
interface StyleAnalysisRequest {
  style_tags: StyleTag[];
  color_palette: ColorPalette;
  inspiration_images?: string[];
  aesthetic_preferences: AestheticPreference[];
}

interface StyleAnalysisResponse {
  success: boolean;
  data: {
    style_vector: number[];
    confidence_score: number;
    generated_tags: StyleTag[];
  };
}
```

#### Frontend Components Required
```typescript
// Component: StyleDiscoveryWizard
// Location: /src/components/directory/StyleDiscoveryWizard.tsx

interface Props {
  onStyleProfileComplete: (profile: StyleProfile) => void;
  supplierCategory?: string;
}

// Key functionality:
- Multi-step visual style selector with inspiration images
- Color palette picker with seasonal affinity detection
- Aesthetic preference sliders (formality, vintage, nature, luxury)
- AI-powered style vector generation from user selections
```

#### Integration Points
```typescript
// Service: StyleMatchingEngine
// Dependencies: AI vector similarity, supplier portfolio analysis

class StyleMatchingEngine {
  async findStyleCompatibleSuppliers(
    coupleStyleProfile: StyleProfile,
    supplierCategory: string,
    location?: GeoPoint
  ): Promise<StyleMatch[]> {
    // Multi-factor compatibility scoring with vector similarity
  }
}
```

### CODE EXAMPLES

#### Example 1: AI Style Vector Generation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { supabase } from '@/lib/supabase';

export async function generateStyleVector(profile: Partial<StyleProfile>) {
  // Step 1: Send profile data to AI style analysis
  const { data, error } = await supabase.functions.invoke('style-analysis', {
    body: {
      style_tags: profile.style_tags,
      color_palette: profile.color_palette,
      aesthetic_preferences: profile.aesthetic_preferences
    }
  });
    
  // Step 2: Process AI-generated style vector
  if (error) throw new Error('Style analysis failed');
  
  return {
    style_vector: data.style_vector,
    confidence_score: data.confidence,
    ai_detected_tags: data.generated_tags
  };
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for AI/ML libraries, vector similarity algorithms
- [x] PostgreSQL: Execute vector similarity queries with pgvector
- [x] Playwright: Test style discovery wizard user flow

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/tensorflow/tensorflow", "image analysis", 4000);
await mcp__context7__get-library-docs("/supabase/supabase", "edge functions AI", 3000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('StyleMatchingEngine', () => {
  it('should calculate accurate compatibility scores between couple and supplier styles', () => {
    // Test style compatibility algorithm with known style profiles
  });
  
  it('should prioritize vector similarity over tag matching for aesthetic alignment', () => {
    // Test weighting of different matching factors
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Couple can complete style discovery and view matched suppliers', async () => {
  await mcp__playwright__browser_navigate({url: '/directory/style-discovery'});
  await mcp__playwright__browser_snapshot();
  // Verify style wizard completion and accurate supplier matching
});
```

### ACCEPTANCE CRITERIA
- [x] Style discovery wizard captures couple preferences in under 5 minutes
- [x] AI matching returns 80%+ relevant suppliers based on visual style compatibility
- [x] Vector similarity search completes within 2 seconds for 10,000+ supplier profiles
- [x] Performance: Style analysis processes all components within 3 seconds
- [x] Security: Style profile data encrypted and couple-owned
- [x] Accessibility: Visual style selector compatible with screen readers and color-blind users

### DEPENDENCIES
- Must complete after: AI integration infrastructure setup
- Must complete before: Advanced discovery features and supplier recommendations
- Shares code with: Supplier portfolio management system

### ESTIMATED EFFORT
- Team A Frontend: 48 hours (Style discovery wizard with complex visual components and match results)
- Team B Backend: 32 hours (Vector similarity infrastructure and caching)
- Team D AI/ML: 56 hours (Style analysis algorithms, portfolio analysis, AI training)
- Total: 136 hours