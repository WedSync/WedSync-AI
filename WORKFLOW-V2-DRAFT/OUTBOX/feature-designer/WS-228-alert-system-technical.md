# TECHNICAL SPECIFICATION: WS-228 - Admin Alert System
## Generated by Feature Development Session - 2025-01-25

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** WedSync platform administrator managing 500+ active weddings
**I want to:** Receive intelligent alerts when system issues or business anomalies occur
**So that:** I can proactively prevent disruptions that would impact photographers managing wedding timelines and couples coordinating their big day

**Real Wedding Scenario:**
"During peak wedding season (June-October), administrators need to monitor when payment processing fails for photographer clients, when guest RSVP systems go down before major wedding dates, or when unusual churn patterns indicate photographers are abandoning the platform. A single system failure during a wedding weekend could disrupt multiple couples' coordinated vendor timelines, requiring immediate administrative intervention."

### SPECIFICATION SOURCE
- **Feature ID:** WS-228
- **Original Spec:** /CORE-SPECIFICATIONS/07-ADMIN-DASHBOARD/01-Overview/03-alert-system md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** None (new feature)
- **New Files to Create:** 
  - `/src/components/admin/AlertCenter.tsx`
  - `/src/lib/admin/alert-manager.ts`
  - `/src/app/api/admin/alerts/route.ts`
  - `/src/hooks/useAlerts.ts`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Alert tracking table
CREATE TABLE alerts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  type VARCHAR(50) NOT NULL,
  priority VARCHAR(20) NOT NULL,
  title VARCHAR(255) NOT NULL,
  message TEXT,
  metadata JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  acknowledged_at TIMESTAMPTZ,
  acknowledged_by UUID REFERENCES admin_users(id),
  resolved_at TIMESTAMPTZ,
  resolved_by UUID REFERENCES admin_users(id),
  snoozed_until TIMESTAMPTZ
);

CREATE INDEX idx_alerts_priority ON alerts(priority) WHERE resolved_at IS NULL;
CREATE INDEX idx_alerts_created ON alerts(created_at DESC);

-- Alert rules configuration
CREATE TABLE alert_rules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  category VARCHAR(50),
  condition TEXT NOT NULL,
  threshold DECIMAL,
  operator VARCHAR(10),
  check_interval INTEGER, -- minutes
  last_checked TIMESTAMPTZ,
  enabled BOOLEAN DEFAULT true,
  actions JSONB
);
```

#### API Endpoints Required
```typescript
// GET /api/admin/alerts
interface GetAlertsResponse {
  alerts: Alert[];
  unreadCount: number;
  criticalCount: number;
}

// POST /api/admin/alerts/:id/acknowledge
interface AcknowledgeAlertRequest {
  acknowledgedBy: string;
  note?: string;
}

// POST /api/admin/alerts/:id/resolve
interface ResolveAlertRequest {
  resolvedBy: string;
  resolution: string;
}

// POST /api/admin/alerts/rules
interface CreateAlertRuleRequest {
  name: string;
  condition: string;
  threshold: number;
  operator: 'gt' | 'lt' | 'eq' | 'between';
  checkInterval: number;
  actions: AlertAction[];
}
```

#### Frontend Components Required
```typescript
// Component: AlertCenter
// Location: /src/components/admin/AlertCenter.tsx

interface AlertCenterProps {
  filterByPriority?: AlertPriority;
  realTimeUpdates?: boolean;
}

// Key functionality:
- Real-time alert display with priority filtering
- Acknowledge and resolve alert actions
- Alert history and analytics
- Notification toast for critical alerts
```

#### Integration Points
```typescript
// Service: AlertManager
// Dependencies: Database, Email Service, Slack Integration, SMS Service

class AlertManager {
  async checkSystemHealth(): Promise<void> {
    // Monitor API response times, error rates, database connections
  }
  
  async checkBusinessMetrics(): Promise<void> {
    // Monitor churn rates, activation rates, wedding timeline completion
  }
  
  async createAlert(alert: CreateAlertData): Promise<Alert> {
    // Create alert with deduplication and escalation logic
  }
}
```

### CODE EXAMPLES

#### Example 1: Alert Manager Implementation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { supabase } from '@/lib/supabase';
import { sendEmail } from '@/lib/email';
import { sendSlackMessage } from '@/lib/slack';

export enum AlertPriority {
  CRITICAL = 'critical',   // System down, payment failures
  HIGH = 'high',           // Performance degradation, high churn
  MEDIUM = 'medium',       // Unusual patterns, pending actions
  LOW = 'low',            // Informational, suggestions
  INFO = 'info'           // FYI notifications
}

export interface Alert {
  id: string;
  type: string;
  priority: AlertPriority;
  title: string;
  message: string;
  metadata: Record<string, any>;
  timestamp: Date;
  acknowledged: boolean;
  resolvedAt?: Date;
  assignedTo?: string;
}

export class AlertManager {
  async checkSystemHealth() {
    const checks = [
      { metric: 'api_response_time', threshold: 2000, priority: AlertPriority.HIGH },
      { metric: 'error_rate', threshold: 0.05, priority: AlertPriority.CRITICAL },
      { metric: 'database_connections', threshold: 80, priority: AlertPriority.MEDIUM },
      { metric: 'memory_usage', threshold: 90, priority: AlertPriority.HIGH }
    ];
    
    for (const check of checks) {
      const value = await this.getMetric(check.metric);
      if (value > check.threshold) {
        await this.createAlert({
          type: 'system_health',
          priority: check.priority,
          title: `${check.metric} exceeded threshold`,
          message: `Current: ${value}, Threshold: ${check.threshold}`,
          metadata: { metric: check.metric, value, threshold: check.threshold }
        });
      }
    }
  }

  async createAlert(alertData: Omit<Alert, 'id' | 'timestamp' | 'acknowledged'>) {
    const { data, error } = await supabase
      .from('alerts')
      .insert({
        ...alertData,
        acknowledged: false,
        created_at: new Date().toISOString()
      })
      .select()
      .single();
    
    if (error) throw error;
    
    // Send notifications based on priority
    if (alertData.priority === AlertPriority.CRITICAL) {
      await this.sendCriticalAlertNotifications(data);
    }
    
    return data;
  }
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for Next.js notifications, React real-time updates
- [x] Supabase: Database operations and real-time subscriptions
- [x] Filesystem: Access alert configuration files

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/vercel/next.js", "api routes", 2000);
await mcp__context7__get-library-docs("/supabase/supabase", "realtime", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('AlertManager', () => {
  it('should create critical alert when error rate exceeds threshold', async () => {
    const manager = new AlertManager();
    jest.spyOn(manager, 'getMetric').mockResolvedValue(0.1); // 10% error rate
    
    const alert = await manager.checkSystemHealth();
    expect(alert.priority).toBe('critical');
    expect(alert.type).toBe('system_health');
  });

  it('should deduplicate similar alerts within 5 minutes', async () => {
    // Test alert deduplication logic
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Admin can acknowledge and resolve alerts', async () => {
  await mcp__playwright__browser_navigate({url: '/admin/alerts'});
  await mcp__playwright__browser_snapshot();
  
  // Click acknowledge button on critical alert
  await mcp__playwright__browser_click({
    element: 'Acknowledge critical alert button',
    ref: '[data-testid="acknowledge-alert-critical"]'
  });
  
  // Verify alert status changes
  await mcp__playwright__browser_snapshot();
});
```

### ACCEPTANCE CRITERIA
- [x] System monitors API response time, error rate, database connections, memory usage
- [x] Creates alerts when thresholds exceeded with appropriate priority levels
- [x] Real-time alert notifications in admin dashboard
- [x] Alert acknowledgment and resolution tracking
- [x] Performance: Alert creation under 500ms, dashboard loads under 2s
- [x] Security: Admin role verification for all alert operations
- [x] Accessibility: Screen reader support for alert notifications

### DEPENDENCIES
- Must complete after: Admin authentication system
- Must complete before: Admin monitoring dashboard
- Shares code with: Admin notification system

### ESTIMATED EFFORT
- Team A Frontend: 16 hours (AlertCenter component, real-time UI)
- Team B Backend: 24 hours (AlertManager, API endpoints, alert rules engine)
- Team C Integration: 8 hours (Email, Slack, SMS notification channels)
- Team D Platform: 4 hours (Database schema, indices)
- Team E General: 6 hours (Testing, monitoring integration)
- Team F Workflows: 2 hours (Alert workflow automation)
- Team G Performance: 4 hours (Alert performance optimization)
- Total: 64 hours