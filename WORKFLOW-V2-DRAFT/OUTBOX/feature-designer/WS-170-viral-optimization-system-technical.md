# TECHNICAL SPECIFICATION: WS-170 - Viral Optimization System
## Generated by Feature Development Session - 2025-01-24

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding supplier using WedSync
**I want to:** Leverage happy clients to refer other couples and suppliers
**So that:** I can grow my business through word-of-mouth while helping WedSync expand

**Real Wedding Scenario:**
A photographer completes a wedding and their happy couple shares their WedSync experience with 3 other engaged couples. Each referral that signs up gives both the photographer and couple rewards. This viral loop reduces customer acquisition cost by 60%.

### SPECIFICATION SOURCE
- **Feature ID:** WS-170
- **Original Spec:** /CORE-SPECIFICATIONS/13-BUSINESS-OPERATIONS/05-viral-optimization md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** None (new feature)
- **New Files to Create:**
  - /src/lib/viral/referral-tracker.ts
  - /src/lib/viral/sharing-mechanics.ts
  - /src/lib/viral/growth-coefficient.ts
  - /src/components/viral/ReferralWidget.tsx
  - /src/app/api/referrals/route.ts

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Referral tracking
CREATE TABLE IF NOT EXISTS referrals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  referrer_id UUID REFERENCES user_profiles(id),
  referrer_type TEXT CHECK (referrer_type IN ('supplier', 'couple')),
  referred_email TEXT NOT NULL,
  referral_code TEXT UNIQUE NOT NULL,
  status TEXT CHECK (status IN ('pending', 'signed_up', 'converted', 'expired')),
  reward_type TEXT,
  reward_value DECIMAL(10,2),
  signed_up_at TIMESTAMPTZ,
  converted_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Viral metrics
CREATE TABLE IF NOT EXISTS viral_metrics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  date DATE NOT NULL,
  new_users INT DEFAULT 0,
  referral_users INT DEFAULT 0,
  viral_coefficient DECIMAL(3,2),
  sharing_rate DECIMAL(3,2),
  conversion_rate DECIMAL(3,2),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Sharing events
CREATE TABLE IF NOT EXISTS sharing_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES user_profiles(id),
  share_type TEXT CHECK (share_type IN ('email', 'social', 'link', 'qr_code')),
  content_shared TEXT,
  platform TEXT,
  clicks INT DEFAULT 0,
  conversions INT DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_referrals_referrer ON referrals(referrer_id);
CREATE INDEX idx_referrals_code ON referrals(referral_code);
CREATE INDEX idx_sharing_events_user ON sharing_events(user_id);
```

#### API Endpoints Required
```typescript
// POST /api/referrals/create
interface CreateReferralRequest {
  referredEmail: string;
  rewardType?: 'discount' | 'credit' | 'feature';
}

interface CreateReferralResponse {
  referralCode: string;
  shareUrl: string;
  rewardDetails: {
    type: string;
    value: number;
    description: string;
  };
}

// GET /api/referrals/stats
interface ReferralStatsResponse {
  totalReferrals: number;
  successfulReferrals: number;
  pendingRewards: number;
  earnedRewards: number;
  viralCoefficient: number;
}
```

#### Frontend Components Required
```typescript
// Component: ReferralWidget
// Location: /src/components/viral/ReferralWidget.tsx

interface Props {
  userId: string;
  userType: 'supplier' | 'couple';
  onShare: (platform: string) => void;
}

// Key functionality:
- Display referral code and link
- Social sharing buttons
- Copy to clipboard
- QR code generation
- Referral stats display
- Reward progress tracker
```

### CODE EXAMPLES

#### Example 1: Viral Coefficient Calculation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { supabase } from '@/lib/supabase';

export async function calculateViralCoefficient(
  dateRange: { start: Date; end: Date }
): Promise<number> {
  // Get new users in period
  const { data: newUsers } = await supabase
    .from('user_profiles')
    .select('id')
    .gte('created_at', dateRange.start.toISOString())
    .lte('created_at', dateRange.end.toISOString());
  
  // Get referrals sent by these users
  const { data: referrals } = await supabase
    .from('referrals')
    .select('*')
    .in('referrer_id', newUsers?.map(u => u.id) || [])
    .eq('status', 'converted');
  
  const invitesSent = referrals?.length || 0;
  const conversions = referrals?.filter(r => r.converted_at).length || 0;
  const totalUsers = newUsers?.length || 1;
  
  // K = (invites sent Ã— conversion rate) / users
  const viralCoefficient = (invitesSent * (conversions / invitesSent)) / totalUsers;
  
  // Store metric
  await supabase
    .from('viral_metrics')
    .insert({
      date: new Date().toISOString(),
      new_users: totalUsers,
      referral_users: conversions,
      viral_coefficient: viralCoefficient
    });
  
  return viralCoefficient;
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [ ] Context7: Load docs for sharing libraries
- [ ] PostgreSQL: Execute migration scripts
- [ ] Supabase: Configure referral tracking

### ACCEPTANCE CRITERIA
- [ ] Referral codes generate uniquely
- [ ] Sharing mechanisms work across platforms
- [ ] Rewards track and apply correctly
- [ ] Viral coefficient calculates accurately
- [ ] Double-sided rewards function
- [ ] Referral attribution works
- [ ] Analytics dashboard shows viral metrics
- [ ] QR codes generate for offline sharing

### DEPENDENCIES
- Must complete after: WS-046 (Referral Programs)
- Must complete before: None
- Shares code with: WS-169 (Marketing Automation)

### ESTIMATED EFFORT
- Team A Frontend: 12 hours
- Team D Analytics: 16 hours
- Total: 28 hours