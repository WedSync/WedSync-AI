# TECHNICAL SPECIFICATION: WS-231 - Activation Funnel Tracking
## Generated by Feature Development Session - 2025-01-25

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** WedSync growth analyst tracking user onboarding success
**I want to:** Monitor detailed activation funnels with wedding industry-specific milestones  
**So that:** I can identify exactly where photographers drop off (after profile completion vs after adding first client) and optimize onboarding flows based on different user behaviors between suppliers and couples

**Real Wedding Scenario:**
"A photographer typically activates when they complete profile, create first form, and add 2+ clients within 7 days. A couple activates when they set wedding date, add venue, and start guest list within 14 days. Our funnel needs to track these different paths because a photographer who adds clients but never creates forms has different needs than one who creates forms but never adds clients - each requires different interventions."

### SPECIFICATION SOURCE
- **Feature ID:** WS-231
- **Original Spec:** /CORE-SPECIFICATIONS/07-ADMIN-DASHBOARD/03-Growth-Metrics/02-activation-funnel md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** None (new feature)
- **New Files to Create:**
  - `/src/components/admin/ActivationFunnelDashboard.tsx`
  - `/src/lib/analytics/activation-tracker.ts`
  - `/src/app/api/admin/activation-metrics/route.ts`
  - `/src/hooks/useActivationMetrics.ts`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- User activation events tracking
CREATE TABLE user_activation_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  user_type TEXT CHECK (user_type IN ('supplier', 'couple')),
  event_name TEXT NOT NULL,
  event_data JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  session_id TEXT
);

-- Activation funnel stages
CREATE TABLE activation_stages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_type TEXT NOT NULL,
  stage_order INTEGER NOT NULL,
  stage_name TEXT NOT NULL,
  required_events TEXT[],
  min_events INTEGER DEFAULT 1,
  max_timeframe_days INTEGER,
  UNIQUE(user_type, stage_order)
);

CREATE INDEX idx_activation_events_user ON user_activation_events(user_id, created_at);
CREATE INDEX idx_activation_events_type ON user_activation_events(user_type, event_name);
```

#### API Endpoints Required
```typescript
// GET /api/admin/activation-metrics
interface ActivationMetricsResponse {
  funnel: ActivationFunnel;
  byUserType: Record<'supplier' | 'couple', ActivationFunnel>;
  cohortAnalysis: CohortActivationData[];
  dropoffAnalysis: DropoffPoint[];
}

// GET /api/admin/activation-metrics/cohort/:date
interface CohortActivationResponse {
  cohortDate: string;
  totalSignups: number;
  activationRate: number;
  stageBreakdown: FunnelStage[];
  avgTimeToActivation: number;
}
```

#### Frontend Components Required
```typescript
// Component: ActivationFunnelDashboard
// Location: /src/components/admin/ActivationFunnelDashboard.tsx

interface ActivationFunnelDashboardProps {
  timeframe: string;
  userTypeFilter?: 'supplier' | 'couple' | 'all';
}

// Key functionality:
- Visual funnel chart showing conversion at each stage
- User type comparison (supplier vs couple activation paths)
- Dropoff point analysis with improvement recommendations
- Time-to-activation trends and benchmarking
```

### CODE EXAMPLES

#### Example 1: Activation Tracker Implementation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
export interface ActivationFunnel {
  stages: FunnelStage[];
  overallConversion: number;
  timeToActivation: number; // Average days
  dropoffAnalysis: DropoffPoint[];
}

export interface FunnelStage {
  name: string;
  description: string;
  users: number;
  conversionRate: number;
  avgTimeToReach: number; // Hours from signup
  dropoffRate: number;
}

export class ActivationTracker {
  private readonly ACTIVATION_CRITERIA = {
    supplier: {
      requiredActions: [
        'email_verified',
        'profile_completed', 
        'form_created',
        'client_added',
        'journey_started'
      ],
      minActions: 3,
      timeframe: 7 // days
    },
    couple: {
      requiredActions: [
        'email_verified',
        'wedding_date_set',
        'venue_added',
        'guest_list_started'
      ],
      minActions: 3,
      timeframe: 14 // days
    }
  };

  async calculateActivationFunnel(
    userType: 'supplier' | 'couple',
    period: { start: Date; end: Date }
  ): Promise<ActivationFunnel> {
    const { data: userData, error } = await supabase.rpc('calculate_activation_funnel', {
      user_type: userType,
      start_date: period.start.toISOString(),
      end_date: period.end.toISOString()
    });

    if (error) throw error;

    const stages: FunnelStage[] = userData.stages.map((stage: any) => ({
      name: stage.stage_name,
      description: stage.description,
      users: stage.user_count,
      conversionRate: stage.conversion_rate,
      avgTimeToReach: stage.avg_hours_to_reach,
      dropoffRate: 1 - stage.conversion_rate
    }));

    return {
      stages,
      overallConversion: userData.overall_conversion,
      timeToActivation: userData.avg_activation_days,
      dropoffAnalysis: await this.analyzeDropoffs(userType, period)
    };
  }

  async trackActivationEvent(userId: string, eventName: string, eventData?: any): Promise<void> {
    const { error } = await supabase.from('user_activation_events').insert({
      user_id: userId,
      event_name: eventName,
      event_data: eventData || {},
      session_id: getSessionId()
    });

    if (error) throw error;

    // Check if user has reached activation
    await this.checkActivationStatus(userId);
  }

  private async checkActivationStatus(userId: string): Promise<boolean> {
    const { data: user } = await supabase
      .from('users')
      .select('user_type')
      .eq('id', userId)
      .single();

    if (!user) return false;

    const criteria = this.ACTIVATION_CRITERIA[user.user_type as keyof typeof this.ACTIVATION_CRITERIA];
    
    const { data: events } = await supabase
      .from('user_activation_events') 
      .select('event_name, created_at')
      .eq('user_id', userId)
      .gte('created_at', new Date(Date.now() - criteria.timeframe * 24 * 60 * 60 * 1000).toISOString());

    if (!events) return false;

    const completedEvents = new Set(events.map(e => e.event_name));
    const requiredCount = criteria.requiredActions.filter(action => 
      completedEvents.has(action)
    ).length;

    const isActivated = requiredCount >= criteria.minActions;

    if (isActivated) {
      await supabase.from('users').update({ activated_at: new Date().toISOString() }).eq('id', userId);
    }

    return isActivated;
  }
}
```

### ACCEPTANCE CRITERIA
- [x] Tracks activation funnel for both suppliers and couples with different criteria
- [x] Identifies dropoff points with conversion rates at each stage
- [x] Calculates average time-to-activation by user type and cohort
- [x] Provides actionable recommendations for improving activation rates
- [x] Performance: Funnel calculations complete under 5 seconds
- [x] Accuracy: Activation tracking matches manual verification within 2%

### DEPENDENCIES  
- Must complete after: Event tracking framework, user analytics infrastructure
- Must complete before: User onboarding optimization, growth experiments
- Shares code with: User behavior analytics, cohort analysis tools

### ESTIMATED EFFORT
- Team A Frontend: 20 hours (Funnel visualization, dashboard components)
- Team B Backend: 24 hours (Activation tracker, funnel calculations) 
- Team C Integration: 6 hours (Event tracking integration)
- Team D Platform: 8 hours (Database schema, analytical queries)
- Team E General: 12 hours (Testing, funnel validation)
- Total: 70 hours