# TECHNICAL SPECIFICATION: WS-344 - Supplier-to-Supplier Referral & Gamification System
## Generated by Feature Development Session - 2025-01-22

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding photographer running a successful WedSync business
**I want to:** Refer other wedding suppliers to WedSync and earn free months when they become paying customers
**So that:** I can reduce my monthly costs while growing the wedding vendor community in my area

**Real Wedding Scenario:**
"Sarah, a wedding photographer, knows 15+ other wedding vendors in her region who still use Excel and email for wedding coordination. She refers them to WedSync using her personal referral link. When DJ Mike converts from trial to a paid subscription, Sarah earns a free month of WedSync at her current Professional tier. This creates a viral growth loop where successful suppliers drive adoption across their professional networks."

### SPECIFICATION SOURCE
- **Feature ID:** WS-344
- **Original Spec:** Custom specification for supplier referral system
- **Current Implementation:** 0% complete - new feature
- **Files to Modify:** 
  - `/src/lib/supabase/database.types.ts` (add referral types)
  - `/src/components/layout/sidebar-nav.tsx` (add referral menu)
  - `/src/app/(dashboard)/referrals/page.tsx` (new page)
- **New Files to Create:**
  - `/supabase/migrations/055_supplier_referrals.sql`
  - `/src/app/api/referrals/create-link/route.ts`
  - `/src/app/api/referrals/track-conversion/route.ts`
  - `/src/components/referrals/ReferralCenter.tsx`
  - `/src/components/referrals/LeaderboardView.tsx`
  - `/src/components/referrals/ReferralStats.tsx`
  - `/src/services/referral-tracking.ts`
  - `/src/services/qr-generator.ts`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Supplier Referrals Tracking
CREATE TABLE supplier_referrals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  referrer_id UUID REFERENCES organizations(id) NOT NULL,
  referred_email TEXT NOT NULL,
  referred_id UUID REFERENCES organizations(id),
  
  -- Tracking Information
  referral_code TEXT UNIQUE NOT NULL,
  custom_link TEXT NOT NULL,
  qr_code_url TEXT,
  source TEXT CHECK (source IN ('link', 'qr', 'email', 'social', 'direct_entry')) DEFAULT 'link',
  source_details TEXT,
  
  -- Status Tracking
  stage TEXT CHECK (stage IN ('link_created', 'link_clicked', 'signup_started', 'trial_active', 'first_payment', 'reward_issued')) DEFAULT 'link_created',
  clicked_at TIMESTAMPTZ,
  signed_up_at TIMESTAMPTZ,
  trial_started_at TIMESTAMPTZ,
  converted_at TIMESTAMPTZ,
  reward_issued_at TIMESTAMPTZ,
  
  -- Rewards
  referrer_reward TEXT CHECK (referrer_reward IN ('1_month_free', 'pending', 'not_eligible')) DEFAULT 'pending',
  referee_bonus TEXT DEFAULT '1_month_free_on_subscription',
  
  -- Attribution
  primary_referrer BOOLEAN DEFAULT true,
  attribution_window INTEGER DEFAULT 30,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Leaderboard Rankings
CREATE TABLE referral_leaderboard (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID REFERENCES organizations(id) NOT NULL,
  
  -- Ranking Metrics (Conversions Only)
  paid_conversions INTEGER DEFAULT 0,
  total_referrals_sent INTEGER DEFAULT 0,
  conversion_rate DECIMAL(5,2) DEFAULT 0.00,
  months_earned INTEGER DEFAULT 0,
  
  -- Category Rankings
  category_rank INTEGER,
  geographic_rank INTEGER,
  overall_rank INTEGER,
  rank_change INTEGER DEFAULT 0,
  trend TEXT CHECK (trend IN ('rising', 'falling', 'stable')) DEFAULT 'stable',
  
  -- Time Period Tracking
  period_type TEXT CHECK (period_type IN ('all_time', 'this_year', 'this_quarter', 'this_month', 'this_week')),
  
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Milestone Rewards
CREATE TABLE referral_milestones (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID REFERENCES organizations(id) NOT NULL,
  milestone_type TEXT CHECK (milestone_type IN ('5_conversions', '10_conversions', '25_conversions', '50_conversions', '100_conversions')),
  reward_description TEXT NOT NULL,
  achieved_at TIMESTAMPTZ DEFAULT NOW(),
  reward_claimed BOOLEAN DEFAULT false,
  claimed_at TIMESTAMPTZ
);

-- Achievement Badges
CREATE TABLE referral_badges (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID REFERENCES organizations(id) NOT NULL,
  badge_id TEXT NOT NULL, -- 'first_conversion', 'trusted_referrer', etc.
  badge_name TEXT NOT NULL,
  badge_icon TEXT NOT NULL,
  badge_description TEXT NOT NULL,
  earned_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes for Performance
CREATE INDEX idx_supplier_referrals_referrer ON supplier_referrals(referrer_id);
CREATE INDEX idx_supplier_referrals_code ON supplier_referrals(referral_code);
CREATE INDEX idx_supplier_referrals_stage ON supplier_referrals(stage);
CREATE INDEX idx_supplier_referrals_converted ON supplier_referrals(converted_at) WHERE converted_at IS NOT NULL;
CREATE INDEX idx_leaderboard_category ON referral_leaderboard(category_rank) WHERE category_rank IS NOT NULL;
CREATE INDEX idx_leaderboard_conversions ON referral_leaderboard(paid_conversions DESC);
```

#### API Endpoints Required
```typescript
// POST /api/referrals/create-link
interface CreateReferralLinkRequest {
  customMessage?: string;
  source?: 'dashboard' | 'mobile_app';
}

interface CreateReferralLinkResponse {
  success: boolean;
  data: {
    referralCode: string;
    customLink: string;
    qrCodeUrl: string;
  };
}

// POST /api/referrals/track-conversion  
interface TrackConversionRequest {
  referralCode: string;
  stage: 'link_clicked' | 'signup_started' | 'trial_active' | 'first_payment';
  referredId?: string;
  sourceDetails?: string;
}

interface TrackConversionResponse {
  success: boolean;
  rewardEarned?: boolean;
  milestoneAchieved?: string;
}

// GET /api/referrals/stats
interface ReferralStatsResponse {
  success: boolean;
  data: {
    totalReferrals: number;
    activeTrials: number;
    paidConversions: number;
    conversionRate: number;
    monthsEarned: number;
    currentRankings: {
      category: { rank: number; total: number };
      geographic: { rank: number; total: number };
      overall: { rank: number; total: number };
    };
    recentActivity: ReferralActivity[];
  };
}

// GET /api/referrals/leaderboard
interface LeaderboardRequest {
  type: 'industry' | 'geographic' | 'temporal';
  category?: string;
  location?: string;
  period?: 'all_time' | 'this_year' | 'this_quarter' | 'this_month' | 'this_week';
  limit?: number;
}

interface LeaderboardResponse {
  success: boolean;
  data: {
    entries: LeaderboardEntry[];
    userRank?: number;
    totalEntries: number;
    lastUpdated: string;
  };
}
```

#### Frontend Components Required
```typescript
// Component: ReferralCenter
// Location: /src/components/referrals/ReferralCenter.tsx

interface ReferralCenterProps {
  supplierId: string;
  currentTier: string;
}

// Key functionality:
// - Display referral statistics and pipeline
// - Generate and share referral links
// - Show QR codes for offline sharing
// - Track referral progress in real-time
// - Display earned rewards and milestones

// Component: LeaderboardView  
// Location: /src/components/referrals/LeaderboardView.tsx

interface LeaderboardViewProps {
  currentSupplier: {
    id: string;
    category: string;
    location: string;
  };
}

// Key functionality:
// - Multi-dimensional leaderboard displays
// - Category and geographic filtering
// - Time period selection
// - User rank highlighting
// - Rising stars and trends display

// Component: ReferralStats
// Location: /src/components/referrals/ReferralStats.tsx

interface ReferralStatsProps {
  stats: ReferralStatsData;
  onRefresh: () => void;
}

// Key functionality:
// - Real-time statistics display
// - Conversion funnel visualization
// - Achievement badges display
// - Milestone progress tracking
```

#### Integration Points
```typescript
// Service: ReferralTrackingService
// Dependencies: Supabase, QR Generation, Email Service

class ReferralTrackingService {
  async createReferralLink(supplierId: string, customMessage?: string) {
    // Generate unique referral code
    // Create trackable link
    // Generate QR code
    // Store in database with tracking
  }
  
  async trackReferralEvent(referralCode: string, stage: string, details: any) {
    // Update referral stage
    // Check for conversion milestones
    // Issue rewards if applicable
    // Update leaderboard rankings
  }
  
  async calculateLeaderboards() {
    // Aggregate conversion data
    // Rank suppliers by paid conversions
    // Update all leaderboard tables
    // Cache results for performance
  }
  
  async processReward(referralId: string, rewardType: string) {
    // Credit free months to referrer account
    // Update subscription billing
    // Send confirmation notifications
    // Record milestone achievements
  }
}

// Service: QRGeneratorService  
// Dependencies: QR Code Library, File Storage

class QRGeneratorService {
  async generateQRCode(referralLink: string, supplierId: string) {
    // Generate QR code image
    // Upload to Supabase Storage
    // Return public URL
  }
}
```

### CODE EXAMPLES

#### Example 1: Referral Link Creation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { createClient } from '@supabase/supabase-js';
import { nanoid } from 'nanoid';

export async function createReferralLink(supplierId: string) {
  const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
  );
  
  // Step 1: Generate unique referral code
  const referralCode = nanoid(8).toUpperCase();
  const customLink = `${process.env.NEXT_PUBLIC_APP_URL}/join/${referralCode}`;
  
  // Step 2: Create referral record
  const { data: referral, error } = await supabase
    .from('supplier_referrals')
    .insert({
      referrer_id: supplierId,
      referral_code: referralCode,
      custom_link: customLink,
      stage: 'link_created'
    })
    .select()
    .single();
    
  if (error) throw error;
  
  // Step 3: Generate QR code
  const qrCodeUrl = await generateQRCode(customLink, supplierId);
  
  // Step 4: Update with QR code URL
  await supabase
    .from('supplier_referrals')
    .update({ qr_code_url: qrCodeUrl })
    .eq('id', referral.id);
  
  return {
    referralCode,
    customLink,
    qrCodeUrl
  };
}
```

#### Example 2: Conversion Tracking
```typescript
import { createClient } from '@supabase/supabase-js';

export async function trackConversion(
  referralCode: string, 
  stage: string, 
  referredId?: string
) {
  const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
  );
  
  // Step 1: Find referral record
  const { data: referral, error: findError } = await supabase
    .from('supplier_referrals')
    .select('*')
    .eq('referral_code', referralCode)
    .single();
    
  if (findError || !referral) return { success: false };
  
  // Step 2: Update referral stage
  const updates: any = { 
    stage,
    updated_at: new Date().toISOString()
  };
  
  if (stage === 'link_clicked') updates.clicked_at = new Date();
  if (stage === 'signup_started') updates.signed_up_at = new Date();
  if (stage === 'trial_active') updates.trial_started_at = new Date();
  if (stage === 'first_payment') {
    updates.converted_at = new Date();
    updates.referrer_reward = '1_month_free';
    if (referredId) updates.referred_id = referredId;
  }
  
  await supabase
    .from('supplier_referrals')
    .update(updates)
    .eq('id', referral.id);
  
  // Step 3: Process rewards if conversion
  if (stage === 'first_payment') {
    await processReferralReward(referral.referrer_id, referral.id);
    await updateLeaderboards(referral.referrer_id);
  }
  
  return { success: true };
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Ref MCP: Search docs for QR code libraries, ranking algorithms
- [x] Playwright: Test referral flow end-to-end
- [x] Browser MCP: Interactive testing of sharing flows and leaderboards
- [x] Filesystem: Access referral templates and assets
- [x] Sequential Thinking MCP: Complex gamification system planning
- [x] PostgreSQL MCP: Database schema validation and optimization
- [x] Supabase MCP: Test referral tracking and reward automation

#### Ref MCP Searches Needed
```bash
# Use Ref MCP to search for:
# - "QR code generation libraries Node.js"
# - "Viral referral system best practices"
# - "Gamification leaderboard algorithms"
# - "Attribution tracking web analytics"
# - "Social sharing widgets React"
```

#### Browser MCP Interactive Testing
```bash
# Use Browser MCP for:
# - Test referral link generation and sharing flows
# - Verify QR code display and scanning functionality
# - Test leaderboard filtering and navigation
# - Capture screenshots of all referral dashboard states
# - Test mobile responsiveness of referral tools
# - Monitor network requests during referral tracking
```

#### Sequential Thinking MCP Planning (For Complex Features)
```yaml
# Use Sequential Thinking MCP to structure complex gamification development:

# 1. Problem Analysis
- How do successful referral programs work in B2B SaaS?
- What motivates wedding suppliers to refer competitors?
- How can we prevent gaming of the referral system?

# 2. Solution Decomposition  
- Referral link generation with unique tracking
- Multi-touch attribution handling
- Real-time leaderboard calculations
- Reward automation and validation

# 3. Implementation Planning
- Database design for scalable tracking
- API architecture for real-time updates
- Frontend components for engaging UX
- Integration with billing system for rewards

# 4. Risk Assessment
- Preventing referral fraud and gaming
- Performance impact of leaderboard calculations
- Attribution conflicts between multiple referrers
- Reward validation and billing integration complexity

# 5. Testing Strategy
- A/B testing referral conversion rates
- Load testing leaderboard performance
- End-to-end referral flow validation
- Fraud detection and prevention testing
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('ReferralTrackingService', () => {
  it('should generate unique referral codes', () => {
    // Test referral code uniqueness
  });
  
  it('should track conversion stages correctly', () => {
    // Test stage progression tracking
  });
  
  it('should calculate conversion rates accurately', () => {
    // Test conversion rate math
  });
  
  it('should issue rewards only for paid conversions', () => {
    // Test reward logic validation
  });
});

describe('LeaderboardService', () => {
  it('should rank suppliers by paid conversions only', () => {
    // Test ranking algorithm
  });
  
  it('should handle ties with earliest conversion date', () => {
    // Test tiebreaker logic
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP for automated testing
test('Complete referral flow', async () => {
  await mcp__playwright__browser_navigate({url: '/dashboard/referrals'});
  await mcp__playwright__browser_snapshot();
  
  // Test referral link creation
  await mcp__playwright__browser_click({
    element: 'Create Referral Link button',
    ref: '[data-testid="create-referral-link"]'
  });
  
  // Verify link generation
  await mcp__playwright__browser_wait_for({text: 'wedsync.com/join/'});
  
  // Test sharing functionality
  await mcp__playwright__browser_click({
    element: 'Copy Link button',
    ref: '[data-testid="copy-referral-link"]'
  });
  
  // Verify QR code generation
  await mcp__playwright__browser_wait_for({text: 'QR Code generated'});
  
  // Test leaderboard views
  await mcp__playwright__browser_navigate({url: '/dashboard/referrals/leaderboard'});
  await mcp__playwright__browser_snapshot();
});
```

#### Interactive Testing with Browser MCP
```typescript
// Use Browser MCP during development for immediate feedback

// 1. Test referral dashboard
await browser_navigate('/dashboard/referrals');
await browser_take_screenshot('referral-center-desktop.png');

// 2. Test referral link creation flow
await browser_click('[data-testid="create-referral-link"]');
await browser_wait_for(2); // Wait for link generation
await browser_take_screenshot('referral-link-created.png');

// 3. Test QR code display
await browser_click('[data-testid="show-qr-code"]');
await browser_take_screenshot('qr-code-display.png');

// 4. Test leaderboard interactions
await browser_navigate('/dashboard/referrals/leaderboard');
await browser_select_option({
  element: 'Category filter',
  ref: '[data-testid="category-filter"]',
  values: ['photography']
});
await browser_take_screenshot('leaderboard-filtered.png');

// 5. Test mobile responsiveness
await browser_resize(375, 667); // Mobile viewport
await browser_navigate('/dashboard/referrals');
await browser_take_screenshot('referral-center-mobile.png');

// 6. Monitor network requests during usage
const requests = await browser_network_requests();
console.log('API calls:', requests.filter(r => r.url.includes('/api/referrals')));
```

### ACCEPTANCE CRITERIA
- [x] **Referral Link Generation**: Generate unique trackable links with QR codes in <2 seconds
- [x] **Conversion Tracking**: Accurately track all 5 referral stages with timestamp precision
- [x] **Reward Automation**: Issue 1 month free credit within 24 hours of paid conversion
- [x] **Leaderboard Performance**: Load category leaderboards (50 suppliers) in <500ms
- [x] **Real-time Updates**: Reflect referral progress updates within 30 seconds
- [x] **Mobile Optimization**: Full functionality on 375px viewport with touch-friendly controls
- [x] **Attribution Handling**: Correctly handle multi-touch attribution with 30-day window
- [x] **Fraud Prevention**: Validate conversions against actual subscription payments
- [x] **Data Integrity**: Zero data loss during concurrent referral tracking
- [x] **Security**: All referral endpoints require authentication and rate limiting (5 req/min)
- [x] **Navigation Integration: Referral center properly integrated into supplier dashboard navigation (MANDATORY for all UI features)**
  - [x] Desktop navigation link added to main supplier dashboard sidebar
  - [x] Mobile navigation drawer includes referral section
  - [x] Navigation states (active/current) working for referral pages
  - [x] Breadcrumbs show "Dashboard > Referrals > [Section]"
  - [x] Accessibility labels for all referral navigation items
  - [x] Navigation integration verified with Browser MCP testing

### DEPENDENCIES
- Must complete after: WS-255 (Vercel Deployment Pipeline) - for referral link generation
- Must complete after: WS-256 (Environment Variables Management) - for QR code API keys  
- Must complete before: WS-285 (Client Portal Analytics) - referral data feeds analytics
- Shares code with: Billing system integration for reward credits

### ESTIMATED EFFORT
- Team A Frontend: 32 hours (ReferralCenter, LeaderboardView, mobile optimization)
- Team B Backend: 28 hours (API endpoints, tracking service, reward automation)
- Team C Integration: 16 hours (billing integration, QR generation, email notifications)
- Team D Platform: 12 hours (database migration, performance optimization)
- Team E General: 20 hours (testing, documentation, deployment)
- Team F Workflows: 8 hours (referral tracking workflows)  
- Team G Performance: 12 hours (leaderboard caching, query optimization)
- **Total: 128 hours**

### BUSINESS IMPACT METRICS
- **Target Viral Coefficient**: >1.3 (each supplier brings 1.3+ paying suppliers)
- **Referral Activation Rate**: 30% of paid suppliers make at least 1 referral  
- **Conversion Rate**: 40% of referred trials convert to paid subscriptions
- **Monthly Referral Revenue**: Â£50K+ in new subscription revenue via referrals
- **Leaderboard Engagement**: 50% of suppliers check monthly rankings
- **Average Conversions**: 3-5 paid conversions per active referrer annually

This referral system transforms WedSync from a tool into a viral growth engine where successful suppliers drive exponential user acquisition through their professional networks.