# TECHNICAL SPECIFICATION: WS-305 - Client Management Section Overview
## Generated by Feature Development Session - 2025-01-20

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding photographer managing 15+ couples annually
**I want to:** Access a unified client management system that organizes all my wedding couples with their details, photos, notes, and communication history in one place
**So that:** I can save 3+ hours per week currently spent searching through emails, spreadsheets, and folders to find basic client information before calls and shoots

**Real Wedding Scenario:**
"A wedding photographer currently maintains client info in 4 different places: an Excel spreadsheet for basic details, email threads for communication history, a folder system for photos, and handwritten notes for preferences. With this client management system, all wedding couple information is centralized, searchable, and automatically synchronized across all wedding coordination activities."

### SPECIFICATION SOURCE
- **Feature ID:** WS-305
- **Original Spec:** /CORE-SPECIFICATIONS/02-WEDSYNC-SUPPLIER-PLATFORM/03-Client-Management.md
- **Current Implementation:** 20% complete (basic client model exists)
- **Files to Modify:** 
  - /wedsync/src/app/(dashboard)/clients/page.tsx
  - /wedsync/src/components/clients/ClientManagementLayout.tsx
- **New Files to Create:**
  - /wedsync/src/components/clients/ClientOverview.tsx
  - /wedsync/src/lib/services/client-management-service.ts
  - /wedsync/src/hooks/useClientManagement.ts

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Extend existing clients table with management metadata
ALTER TABLE clients ADD COLUMN IF NOT EXISTS management_status VARCHAR(50) DEFAULT 'active';
ALTER TABLE clients ADD COLUMN IF NOT EXISTS last_activity_at TIMESTAMPTZ;
ALTER TABLE clients ADD COLUMN IF NOT EXISTS total_interactions INTEGER DEFAULT 0;
ALTER TABLE clients ADD COLUMN IF NOT EXISTS priority_level VARCHAR(20) DEFAULT 'normal';
ALTER TABLE clients ADD COLUMN IF NOT EXISTS completion_percentage DECIMAL(5,2) DEFAULT 0;

-- Client management settings table
CREATE TABLE IF NOT EXISTS client_management_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID NOT NULL REFERENCES user_profiles(id) ON DELETE CASCADE,
  default_view VARCHAR(20) DEFAULT 'grid',
  items_per_page INTEGER DEFAULT 12,
  sort_preference VARCHAR(50) DEFAULT 'wedding_date_asc',
  filter_preferences JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Client activity tracking
CREATE TABLE IF NOT EXISTS client_activities (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  client_id UUID NOT NULL REFERENCES clients(id) ON DELETE CASCADE,
  activity_type VARCHAR(50) NOT NULL,
  description TEXT,
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### API Endpoints Required
```typescript
// GET /api/clients/management/overview
interface ClientManagementOverview {
  total_clients: number;
  active_clients: number;
  upcoming_weddings: number;
  pending_tasks: number;
  recent_activities: ClientActivity[];
}

// GET /api/clients/management/settings
interface ClientManagementSettings {
  default_view: 'grid' | 'list' | 'timeline';
  items_per_page: number;
  sort_preference: string;
  filter_preferences: Record<string, any>;
}

// PUT /api/clients/management/settings
interface UpdateSettingsRequest {
  default_view?: 'grid' | 'list' | 'timeline';
  items_per_page?: number;
  sort_preference?: string;
  filter_preferences?: Record<string, any>;
}
```

#### Frontend Components Required
```typescript
// Component: ClientManagementLayout
// Location: /src/components/clients/ClientManagementLayout.tsx

interface ClientManagementLayoutProps {
  children: React.ReactNode;
  currentView: 'grid' | 'list' | 'timeline';
  onViewChange: (view: 'grid' | 'list' | 'timeline') => void;
}

// Key functionality:
- Navigation between client management sub-sections
- View toggle controls (grid/list/timeline)
- Search and filter integration
- Quick action buttons (add client, import, export)

// Component: ClientOverview
// Location: /src/components/clients/ClientOverview.tsx

interface ClientOverviewProps {
  overview: ClientManagementOverview;
  loading?: boolean;
}

// Key functionality:
- Display client statistics cards
- Show recent activity feed
- Quick access to common actions
- Upcoming weddings timeline
```

#### Integration Points
```typescript
// Service: ClientManagementService
// Dependencies: SupabaseService, ActivityTracker

class ClientManagementService {
  async getOverview(supplierId: string): Promise<ClientManagementOverview> {
    // Aggregate client statistics and recent activities
  }
  
  async updateSettings(supplierId: string, settings: Partial<ClientManagementSettings>) {
    // Update user preferences for client management
  }
  
  async trackActivity(clientId: string, activity: ClientActivity) {
    // Log client interaction for history tracking
  }
}
```

### CODE EXAMPLES

#### Example 1: Client Management Hook Implementation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabase';
import { useToast } from '@/components/ui/use-toast';

export function useClientManagement(supplierId: string) {
  const [overview, setOverview] = useState<ClientManagementOverview | null>(null);
  const [settings, setSettings] = useState<ClientManagementSettings | null>(null);
  const [loading, setLoading] = useState(true);
  const { toast } = useToast();

  useEffect(() => {
    loadClientManagementData();
  }, [supplierId]);

  async function loadClientManagementData() {
    try {
      setLoading(true);
      
      // Load overview data
      const { data: overviewData } = await supabase
        .rpc('get_client_management_overview', { supplier_id: supplierId });
      
      // Load user settings
      const { data: settingsData } = await supabase
        .from('client_management_settings')
        .select('*')
        .eq('supplier_id', supplierId)
        .single();
        
      setOverview(overviewData);
      setSettings(settingsData || getDefaultSettings());
      
    } catch (error) {
      toast({
        title: "Error loading client management",
        description: "Please try refreshing the page",
        variant: "destructive"
      });
    } finally {
      setLoading(false);
    }
  }

  async function updateViewSettings(newSettings: Partial<ClientManagementSettings>) {
    try {
      const { error } = await supabase
        .from('client_management_settings')
        .upsert({
          supplier_id: supplierId,
          ...newSettings,
          updated_at: new Date().toISOString()
        });

      if (!error) {
        setSettings(prev => ({ ...prev!, ...newSettings }));
        toast({
          title: "Settings updated",
          description: "Your preferences have been saved"
        });
      }
    } catch (error) {
      toast({
        title: "Error updating settings",
        variant: "destructive"
      });
    }
  }

  return {
    overview,
    settings,
    loading,
    updateViewSettings,
    refresh: loadClientManagementData
  };
}

function getDefaultSettings(): ClientManagementSettings {
  return {
    default_view: 'grid',
    items_per_page: 12,
    sort_preference: 'wedding_date_asc',
    filter_preferences: {}
  };
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for React state management, Supabase queries
- [ ] Playwright: Test client management flow navigation
- [ ] Filesystem: Access component templates

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/facebook/react", "hooks useEffect useState", 2000);
await mcp__context7__get-library-docs("/supabase/supabase", "database queries rpc", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('ClientManagementService', () => {
  it('should load client overview statistics', async () => {
    const service = new ClientManagementService();
    const overview = await service.getOverview('supplier-123');
    expect(overview.total_clients).toBeGreaterThanOrEqual(0);
    expect(overview.active_clients).toBeLessThanOrEqual(overview.total_clients);
  });

  it('should update client management settings', async () => {
    const service = new ClientManagementService();
    const newSettings = { default_view: 'list' as const, items_per_page: 20 };
    await service.updateSettings('supplier-123', newSettings);
    // Verify settings were saved
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Client management navigation flow', async () => {
  await mcp__playwright__browser_navigate({url: '/clients'});
  await mcp__playwright__browser_snapshot();
  
  // Test view switching
  await mcp__playwright__browser_click({
    element: "List view button", 
    ref: "[data-testid='view-toggle-list']"
  });
  
  // Verify accessibility
  await mcp__playwright__browser_snapshot();
});
```

### ACCEPTANCE CRITERIA
- [ ] Client overview displays accurate statistics (total, active, upcoming weddings)
- [ ] View preferences (grid/list/timeline) persist across sessions
- [ ] Recent activity feed updates in real-time
- [ ] Quick action buttons provide one-click access to common tasks
- [ ] Performance: Page loads in under 2 seconds with 50+ clients
- [ ] Security: All client data filtered by authenticated supplier
- [ ] Accessibility: Screen reader compatible, keyboard navigation

### DEPENDENCIES
- Must complete after: WS-304 (Supplier Dashboard foundation)
- Must complete before: WS-306 (Forms System integration)
- Shares code with: Client list views, client profiles, analytics tracking

### ESTIMATED EFFORT
- Team A Frontend: 16 hours
- Team B Backend: 12 hours
- Team C Integration: 4 hours
- Team D Platform: 0 hours
- Team E General: 2 hours
- Team F Workflows: 0 hours
- Team G Performance: 2 hours
- Total: 36 hours