# TECHNICAL SPECIFICATION: WS-142 - Customer Success System
## Generated by Feature Development Session - 2025-01-24

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding photographer growing my business
**I want to:** Receive proactive guidance and support based on my usage patterns
**So that:** I can maximize the value from WedSync and avoid churning due to confusion or low adoption

**Real Wedding Scenario:**
Sarah, a wedding photographer, signed up 2 weeks ago but has only imported 5 clients and created 1 form. The customer success system detects she's at risk based on low activity and sends her a personalized email with tips on importing her 2024 client list, plus offers a 15-minute setup call. This intervention increases her feature adoption by 300% and prevents churn.

### SPECIFICATION SOURCE
- **Feature ID:** WS-142
- **Original Spec:** /CORE-SPECIFICATIONS/13-BUSINESS-OPERATIONS/03-customer-success md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** None (new feature)
- **New Files to Create:** 
  - /src/lib/services/customer-success-service.ts
  - /src/lib/services/health-scoring-engine.ts
  - /src/lib/services/milestone-tracking-service.ts
  - /src/components/customer-success/InAppCoach.tsx
  - /src/components/customer-success/MilestoneCard.tsx
  - /src/app/api/health/score/[supplierId]/route.ts
  - /src/app/api/success/milestone/route.ts
  - /src/app/api/success/recommendations/[supplierId]/route.ts

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Customer health scoring
CREATE TABLE IF NOT EXISTS customer_health (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID REFERENCES suppliers(id) ON DELETE CASCADE,
  health_score INT CHECK (health_score >= 0 AND health_score <= 100),
  risk_level TEXT CHECK (risk_level IN ('healthy', 'at_risk', 'critical')) DEFAULT 'healthy',
  last_login TIMESTAMPTZ,
  feature_adoption_score INT DEFAULT 0,
  client_engagement_score INT DEFAULT 0,
  login_frequency DECIMAL(5,2) DEFAULT 0, -- Days since last login
  form_completion_rate DECIMAL(5,4) DEFAULT 0, -- 0.0 to 1.0
  journey_performance DECIMAL(5,4) DEFAULT 0, -- Email open rates
  calculated_at TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Success milestones tracking
CREATE TABLE IF NOT EXISTS success_milestones (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID REFERENCES suppliers(id) ON DELETE CASCADE,
  milestone_type TEXT NOT NULL, -- 'first_form', 'ten_clients', 'first_automation', 'first_payment'
  achieved_at TIMESTAMPTZ DEFAULT NOW(),
  celebrated BOOLEAN DEFAULT false,
  celebration_sent_at TIMESTAMPTZ,
  milestone_data JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(supplier_id, milestone_type)
);

-- Support interactions
CREATE TABLE IF NOT EXISTS support_interactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID REFERENCES suppliers(id) ON DELETE CASCADE,
  interaction_type TEXT NOT NULL, -- 'onboarding_call', 'check_in', 'technical_support', 'churn_prevention'
  status TEXT DEFAULT 'scheduled', -- 'scheduled', 'completed', 'cancelled', 'no_show'
  scheduled_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  duration_minutes INT,
  agent_id UUID, -- Internal team member
  notes TEXT,
  outcome TEXT, -- 'resolved', 'escalated', 'follow_up_needed'
  satisfaction_score INT CHECK (satisfaction_score >= 1 AND satisfaction_score <= 5),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Automated interventions tracking
CREATE TABLE IF NOT EXISTS success_interventions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID REFERENCES suppliers(id) ON DELETE CASCADE,
  trigger_condition TEXT NOT NULL, -- 'no_login_7_days', 'low_client_adoption', 'stuck_onboarding'
  intervention_type TEXT NOT NULL, -- 'email', 'in_app_notification', 'support_call'
  template_used TEXT,
  sent_at TIMESTAMPTZ DEFAULT NOW(),
  opened_at TIMESTAMPTZ,
  clicked_at TIMESTAMPTZ,
  converted BOOLEAN DEFAULT false, -- Did user complete desired action
  converted_at TIMESTAMPTZ,
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create indexes
CREATE INDEX idx_customer_health_supplier ON customer_health(supplier_id);
CREATE INDEX idx_customer_health_risk ON customer_health(risk_level) WHERE risk_level != 'healthy';
CREATE INDEX idx_success_milestones_supplier ON success_milestones(supplier_id);
CREATE INDEX idx_success_milestones_uncelebrated ON success_milestones(celebrated) WHERE celebrated = false;
CREATE INDEX idx_support_interactions_supplier ON support_interactions(supplier_id);
CREATE INDEX idx_interventions_supplier ON success_interventions(supplier_id);
```

#### API Endpoints Required
```typescript
// GET /api/health/score/:supplierId
interface HealthScoreResponse {
  score: number; // 0-100
  riskLevel: 'healthy' | 'at_risk' | 'critical';
  breakdown: {
    loginFrequency: number;
    featureAdoption: number;
    clientActivity: number;
    formCompletion: number;
    journeyPerformance: number;
  };
  trend: 'improving' | 'declining' | 'stable';
  lastCalculated: string;
}

// POST /api/success/milestone
interface MilestoneRequest {
  supplierId: string;
  milestoneType: 'first_form' | 'ten_clients' | 'first_automation' | 'first_payment';
  metadata?: Record<string, any>;
}

interface MilestoneResponse {
  success: boolean;
  milestone: {
    id: string;
    type: string;
    achievedAt: string;
    celebrated: boolean;
  };
  celebration?: {
    message: string;
    reward?: string;
  };
}

// GET /api/success/recommendations/:supplierId
interface RecommendationsResponse {
  recommendations: Array<{
    id: string;
    type: 'feature_tip' | 'best_practice' | 'integration' | 'upgrade';
    title: string;
    description: string;
    actionText: string;
    actionUrl: string;
    priority: 'high' | 'medium' | 'low';
    estimatedImpact: string;
  }>;
  coachingTips: Array<{
    tip: string;
    category: 'onboarding' | 'engagement' | 'growth';
    videoUrl?: string;
  }>;
}

// POST /api/support/schedule-call
interface ScheduleCallRequest {
  supplierId: string;
  preferredTimes: string[];
  reason: 'onboarding' | 'technical_issue' | 'growth_consultation';
  urgency: 'low' | 'medium' | 'high';
  notes?: string;
}
```

#### Frontend Components Required
```typescript
// Component: InAppCoach
// Location: /src/components/customer-success/InAppCoach.tsx

interface InAppCoachProps {
  supplierId: string;
  currentPage: string;
}

// Key functionality:
- Display contextual tips based on user's health score and current page
- Show milestone celebrations with confetti animations
- Offer quick actions to improve health score
- Schedule support calls for at-risk users
- Progressive disclosure of advanced features

// Component: MilestoneCard
// Location: /src/components/customer-success/MilestoneCard.tsx

interface MilestoneCardProps {
  milestone: {
    type: string;
    achieved: boolean;
    progress: number;
    nextStep: string;
  };
  onCelebrate: () => void;
}

// Key functionality:
- Visual progress indicators
- Celebration animations when achieved
- Clear next steps for incomplete milestones
- Social sharing options for achievements
```

#### Integration Points
```typescript
// Service: CustomerSuccessService
// Dependencies: Email service, Analytics, Supabase

class CustomerSuccessService {
  async calculateHealthScore(supplierId: string): Promise<HealthMetrics> {
    const metrics = await this.gatherHealthMetrics(supplierId);
    return this.computeHealthScore(metrics);
  }
  
  async checkMilestoneAchievements(supplierId: string, action: string) {
    const milestones = await this.getPendingMilestones(supplierId);
    for (const milestone of milestones) {
      if (this.isMilestoneTriggered(milestone, action)) {
        await this.awardMilestone(supplierId, milestone);
      }
    }
  }
  
  async runDailyInterventions() {
    const atRiskSuppliers = await this.getAtRiskSuppliers();
    for (const supplier of atRiskSuppliers) {
      await this.executeInterventions(supplier);
    }
  }
  
  async detectChurnRisk(supplierId: string): Promise<ChurnPrediction> {
    const signals = await this.gatherChurnSignals(supplierId);
    return this.predictChurnProbability(signals);
  }
}
```

### CODE EXAMPLES

#### Example 1: Health Score Calculation Engine
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { differenceInDays } from 'date-fns';

interface HealthMetrics {
  loginFrequency: number; // Days since last login
  featureAdoption: number; // % of key features used (0-1)
  clientActivity: number; // Active clients / total clients (0-1)
  formCompletionRate: number; // Client form completion % (0-1)
  journeyPerformance: number; // Journey email open rates (0-1)
}

export function calculateHealthScore(metrics: HealthMetrics): {
  score: number;
  risk: 'healthy' | 'at_risk' | 'critical';
} {
  let score = 0;
  
  // Login frequency (30 points) - most important for engagement
  if (metrics.loginFrequency < 3) score += 30;
  else if (metrics.loginFrequency < 7) score += 20;
  else if (metrics.loginFrequency < 14) score += 10;
  else if (metrics.loginFrequency < 30) score += 5;
  // 0 points for 30+ days
  
  // Feature adoption (25 points) - core platform value
  score += Math.min(25, metrics.featureAdoption * 25);
  
  // Client activity (25 points) - business growth indicator
  score += Math.min(25, metrics.clientActivity * 25);
  
  // Form completion (10 points) - client engagement
  score += Math.min(10, metrics.formCompletionRate * 10);
  
  // Journey performance (10 points) - automation success
  score += Math.min(10, metrics.journeyPerformance * 10);
  
  // Determine risk level with hysteresis to avoid flapping
  const risk = score < 40 ? 'critical' : 
               score < 70 ? 'at_risk' : 'healthy';
  
  return { score: Math.round(score), risk };
}

export async function gatherHealthMetrics(supplierId: string): Promise<HealthMetrics> {
  const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  
  // Get supplier's last login
  const { data: supplier } = await supabase
    .from('suppliers')
    .select('last_sign_in_at')
    .eq('id', supplierId)
    .single();
  
  const loginFrequency = supplier?.last_sign_in_at 
    ? differenceInDays(new Date(), new Date(supplier.last_sign_in_at))
    : 999; // Never logged in
  
  // Feature adoption - check usage of key features
  const keyFeatures = ['forms_created', 'clients_imported', 'journeys_created', 'templates_used'];
  const { data: usage } = await supabase
    .from('supplier_feature_usage')
    .select('feature_name')
    .eq('supplier_id', supplierId)
    .in('feature_name', keyFeatures);
  
  const featureAdoption = usage ? usage.length / keyFeatures.length : 0;
  
  // Client activity - active vs total clients
  const { count: totalClients } = await supabase
    .from('clients')
    .select('id', { count: 'exact' })
    .eq('supplier_id', supplierId);
  
  const { count: activeClients } = await supabase
    .from('clients')
    .select('id', { count: 'exact' })
    .eq('supplier_id', supplierId)
    .gte('last_activity_at', thirtyDaysAgo.toISOString());
  
  const clientActivity = totalClients > 0 ? (activeClients || 0) / totalClients : 0;
  
  // Form completion rate
  const { data: formStats } = await supabase
    .rpc('get_form_completion_rate', { supplier_id: supplierId });
  
  const formCompletionRate = formStats?.[0]?.completion_rate || 0;
  
  // Journey performance - email open rates
  const { data: journeyStats } = await supabase
    .rpc('get_journey_performance', { 
      supplier_id: supplierId,
      days_back: 30 
    });
  
  const journeyPerformance = journeyStats?.[0]?.avg_open_rate || 0;
  
  return {
    loginFrequency,
    featureAdoption,
    clientActivity,
    formCompletionRate,
    journeyPerformance
  };
}
```

#### Example 2: Automated Intervention System
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
interface InterventionTrigger {
  condition: string;
  action: string;
  template: string;
  delay?: number; // Hours to wait before sending
  maxPerWeek?: number;
}

const INTERVENTION_TRIGGERS: InterventionTrigger[] = [
  {
    condition: 'no_login_7_days',
    action: 'send_re_engagement_email',
    template: 'we_miss_you',
    maxPerWeek: 1
  },
  {
    condition: 'zero_clients_imported',
    action: 'send_onboarding_help',
    template: 'import_clients_guide',
    delay: 72, // 3 days after signup
    maxPerWeek: 2
  },
  {
    condition: 'first_form_created',
    action: 'celebrate_milestone',
    template: 'first_form_celebration'
  },
  {
    condition: 'high_usage_free_tier',
    action: 'send_upgrade_suggestion',
    template: 'unlock_more_features',
    maxPerWeek: 1
  }
];

export async function runDailyInterventions() {
  console.log('Starting daily customer success interventions...');
  
  const suppliers = await getAllActiveSuppliers();
  
  for (const supplier of suppliers) {
    try {
      const health = await calculateHealthScore(await gatherHealthMetrics(supplier.id));
      
      // Skip healthy users unless they hit specific triggers
      if (health.risk === 'healthy') {
        await checkPositiveInterventions(supplier);
        continue;
      }
      
      for (const trigger of INTERVENTION_TRIGGERS) {
        const shouldTrigger = await checkCondition(trigger.condition, supplier);
        
        if (shouldTrigger) {
          // Check if we've already sent this intervention recently
          const recentlySent = await hasRecentIntervention(
            supplier.id,
            trigger.template,
            trigger.maxPerWeek || 999
          );
          
          if (!recentlySent) {
            await executeIntervention(trigger, supplier, health);
          }
        }
      }
    } catch (error) {
      console.error(`Error processing interventions for supplier ${supplier.id}:`, error);
    }
  }
}

async function executeIntervention(
  trigger: InterventionTrigger,
  supplier: any,
  health: { score: number; risk: string }
) {
  const interventionId = crypto.randomUUID();
  
  try {
    // Log intervention attempt
    await supabase.from('success_interventions').insert({
      id: interventionId,
      supplier_id: supplier.id,
      trigger_condition: trigger.condition,
      intervention_type: 'email',
      template_used: trigger.template,
      metadata: { health_score: health.score, risk_level: health.risk }
    });
    
    // Personalize the intervention
    const personalization = await gatherPersonalizationData(supplier.id);
    
    // Send intervention
    switch (trigger.action) {
      case 'send_re_engagement_email':
        await sendReEngagementEmail(supplier, personalization);
        break;
      case 'send_onboarding_help':
        await sendOnboardingHelp(supplier, personalization);
        break;
      case 'celebrate_milestone':
        await celebrateMilestone(supplier, personalization);
        break;
      case 'send_upgrade_suggestion':
        await sendUpgradeSuggestion(supplier, personalization);
        break;
    }
    
    console.log(`Sent ${trigger.template} to ${supplier.email}`);
    
  } catch (error) {
    console.error(`Failed to execute intervention ${interventionId}:`, error);
  }
}

async function gatherPersonalizationData(supplierId: string) {
  const [supplier, clientCount, recentActivity] = await Promise.all([
    getSupplierDetails(supplierId),
    getClientCount(supplierId),
    getRecentActivity(supplierId)
  ]);
  
  return {
    firstName: supplier.first_name,
    businessName: supplier.business_name,
    vendorType: supplier.vendor_type,
    clientCount,
    daysSinceLastLogin: recentActivity.daysSinceLogin,
    hasCreatedForms: recentActivity.formsCreated > 0,
    hasActiveJourneys: recentActivity.activeJourneys > 0
  };
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [ ] Context7: Load docs for customer success best practices, email automation
- [ ] PostgreSQL: Execute health score calculations and intervention queries
- [ ] Supabase: Configure RLS policies for customer success data

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/sendgrid/sendgrid-node", "email automation", 2000);
await mcp__context7__get-library-docs("/mixpanel/mixpanel-node", "user analytics", 1500);
await mcp__context7__get-library-docs("/supabase/supabase", "database functions", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('CustomerSuccessService', () => {
  it('should calculate accurate health scores', async () => {
    const metrics = {
      loginFrequency: 2, // Recent login
      featureAdoption: 0.75, // Used 3/4 key features
      clientActivity: 0.6, // 60% clients active
      formCompletionRate: 0.8, // 80% completion
      journeyPerformance: 0.4 // 40% open rate
    };
    
    const result = calculateHealthScore(metrics);
    expect(result.score).toBe(85); // High score
    expect(result.risk).toBe('healthy');
  });
  
  it('should detect at-risk suppliers correctly', async () => {
    const supplierId = 'test-supplier-at-risk';
    const health = await calculateHealthScore(await gatherHealthMetrics(supplierId));
    expect(health.risk).toBe('at_risk');
  });
  
  it('should trigger milestone celebrations', async () => {
    await CustomerSuccessService.checkMilestoneAchievements('supplier-id', 'form_created');
    // Verify milestone was recorded and celebration triggered
  });
});

describe('InterventionEngine', () => {
  it('should not spam users with interventions', async () => {
    // Test rate limiting of intervention emails
    const supplier = { id: 'test', email: 'test@example.com' };
    
    // Send first intervention
    await executeIntervention(INTERVENTION_TRIGGERS[0], supplier, { score: 30, risk: 'critical' });
    
    // Second attempt should be blocked
    const recentlySent = await hasRecentIntervention(supplier.id, 'we_miss_you', 1);
    expect(recentlySent).toBe(true);
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Customer success coach appears for at-risk users', async () => {
  // Login as at-risk supplier
  await mcp__playwright__browser_navigate({url: '/dashboard'});
  
  // Should see in-app coach widget
  await mcp__playwright__browser_wait_for({
    text: 'Need help? Let\'s schedule a quick call'
  });
  
  await mcp__playwright__browser_snapshot();
});

test('Milestone celebration workflow', async () => {
  // Create first form to trigger milestone
  await mcp__playwright__browser_navigate({url: '/forms/new'});
  await mcp__playwright__browser_fill_form({
    fields: [
      { name: 'Form Name', type: 'textbox', ref: '[data-testid="form-name"]', value: 'Test Form' }
    ]
  });
  
  // Should see celebration modal
  await mcp__playwright__browser_wait_for({
    text: 'Congratulations on creating your first form!'
  });
});
```

### ACCEPTANCE CRITERIA
- [ ] Health scores accurately reflect user engagement and feature adoption
- [ ] At-risk users receive proactive interventions within 24 hours
- [ ] Milestone celebrations trigger immediately when achievements occur
- [ ] In-app coach appears contextually based on user state and current page
- [ ] Support call scheduling works for high-risk users
- [ ] Intervention emails are personalized with user's actual data
- [ ] Rate limiting prevents spam - max 3 interventions per week per user
- [ ] GDPR compliant - users can opt out of success communications
- [ ] All customer success interactions are logged for analysis
- [ ] Success metrics improve: 25% reduction in 30-day churn rate

### DEPENDENCIES
- Must complete after: WS-166 (Pricing Strategy) - Need subscription data for health scoring
- Must complete before: WS-143 (Marketing Automation) - Feeds data to marketing campaigns
- Shares code with: WS-169 (Marketing Automation Engine), WS-132 (Trial Management System)

### ESTIMATED EFFORT
- Team A Frontend: 20 hours (in-app coach, milestone UI, success dashboard)
- Team B Backend: 28 hours (health scoring engine, intervention system, milestone tracking)
- Team C Integration: 12 hours (email templates, analytics integration, Supabase functions)
- Total: 60 hours