# TECHNICAL SPECIFICATION: WS-097 - Environment Management
## Generated by Feature Development Session - August 22, 2025

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding photographer trying to coordinate with venues and vendors
**I want to:** Access wedding details on any platform environment (dev, staging, production) reliably
**So that:** I never lose client wedding information or coordination messages when systems are deployed or updated

**Real Wedding Scenario:**
A photographer is coordinating final shots with a venue coordinator 2 hours before the ceremony. The venue coordinator updates timeline details in the staging environment during testing, but the photographer sees outdated information in production. With proper environment management, all deployment environments maintain consistent, secure data access ensuring no critical wedding coordination is lost during deployments.

### SPECIFICATION SOURCE
- **Feature ID:** WS-097
- **Original Spec:** /CORE-SPECIFICATIONS/11-TESTING-DEPLOYMENT/02-CI-CD/03-environment-management md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** 
  - `/wedsync/lib/env.ts` (create new)
  - `/wedsync/config/environments.ts` (create new)
  - `/wedsync/lib/feature-flags.ts` (create new)
- **New Files to Create:**
  - `/wedsync/types/env.d.ts`
  - `/wedsync/scripts/setup-vercel-env.sh`
  - `/wedsync/scripts/sync-env.ts`
  - `/wedsync/scripts/rotate-secrets.ts`
  - `/wedsync/.env.example`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Secret rotation tracking
CREATE TABLE IF NOT EXISTS secret_rotation_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  secret_type VARCHAR(50) NOT NULL,
  old_value_hash VARCHAR(256) NOT NULL,
  rotated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  rotated_by VARCHAR(100) NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Environment audit log
CREATE TABLE IF NOT EXISTS environment_audit (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  environment VARCHAR(20) NOT NULL,
  variable_name VARCHAR(100) NOT NULL,
  action VARCHAR(20) NOT NULL, -- 'added', 'updated', 'removed'
  user_id UUID REFERENCES auth.users(id),
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### API Endpoints Required
```typescript
// GET /api/env/health
interface HealthResponse {
  environment: string;
  status: 'healthy' | 'degraded' | 'error';
  checks: {
    database: boolean;
    supabase: boolean;
    openai: boolean;
    twilio: boolean;
  };
}

// POST /api/env/validate
interface ValidateRequest {
  environment: 'development' | 'staging' | 'production';
}

interface ValidateResponse {
  valid: boolean;
  errors: string[];
  warnings: string[];
}

// GET /api/features
interface FeatureResponse {
  flag: string;
  enabled: boolean;
  userId?: string;
}
```

#### Frontend Components Required
```typescript
// Component: EnvironmentIndicator
// Location: /src/components/admin/EnvironmentIndicator.tsx

interface Props {
  environment: string;
  health: 'healthy' | 'degraded' | 'error';
}

// Key functionality:
- Shows current environment (dev/staging/prod)
- Displays health status with color coding
- Shows active feature flags for current user

// Component: FeatureFlagProvider
// Location: /src/components/providers/FeatureFlagProvider.tsx

interface Props {
  children: React.ReactNode;
  flags: Record<string, boolean>;
}

// Key functionality:
- Provides feature flag context to app
- Handles client-side flag checking
- Supports A/B testing integration
```

#### Integration Points
```typescript
// Service: EnvironmentService
// Dependencies: Supabase client, validation library

class EnvironmentService {
  async validateConfig(env: string) {
    // Validates all required environment variables
    // Returns detailed error messages for missing/invalid vars
  }
  
  async healthCheck() {
    // Tests connections to all external services
    // Returns status for database, APIs, etc.
  }
  
  async rotateSecrets() {
    // Handles automated secret rotation
    // Updates Vercel environment variables
  }
}

// Hook: useFeatureFlag
export function useFeatureFlag(flag: string): boolean {
  // Returns feature flag status for current user
  // Supports client-side and server-side checks
}
```

### CODE EXAMPLES

#### Example 1: Environment Validation Setup
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { z } from 'zod';

const envSchema = z.object({
  NODE_ENV: z.enum(['development', 'test', 'production']),
  NEXT_PUBLIC_APP_URL: z.string().url(),
  NEXT_PUBLIC_SUPABASE_URL: z.string().url(),
  NEXT_PUBLIC_SUPABASE_ANON_KEY: z.string().min(1),
  SUPABASE_SERVICE_KEY: z.string().min(1).optional(),
  DATABASE_URL: z.string().min(1).optional(),
});

export function validateEnv() {
  try {
    return envSchema.parse(process.env);
  } catch (error) {
    console.error('Environment validation failed:', error);
    if (process.env.NODE_ENV === 'production') {
      process.exit(1);
    }
    throw error;
  }
}

export const env = validateEnv();
```

#### Example 2: Feature Flag Implementation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { createContext, useContext } from 'react';

interface FeatureFlagContextType {
  isEnabled: (flag: string) => boolean;
}

const FeatureFlagContext = createContext<FeatureFlagContextType | null>(null);

export function FeatureFlagProvider({ children, flags }) {
  const isEnabled = (flag: string) => flags[flag] || false;
  
  return (
    <FeatureFlagContext.Provider value={{ isEnabled }}>
      {children}
    </FeatureFlagContext.Provider>
  );
}

export function useFeatureFlag(flag: string) {
  const context = useContext(FeatureFlagContext);
  if (!context) {
    throw new Error('useFeatureFlag must be used within FeatureFlagProvider');
  }
  return context.isEnabled(flag);
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [ ] Context7: Load docs for Next.js environment variables, Vercel deployment
- [ ] Filesystem: Create environment files and scripts
- [ ] PostgreSQL: Create audit tables

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/vercel/vercel", "environment variables", 2000);
await mcp__context7__get-library-docs("/colinhacks/zod", "validation", 1500);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('Environment Management', () => {
  it('should validate required environment variables', () => {
    // Test validation schema with valid/invalid inputs
  });
  
  it('should handle missing production secrets gracefully', () => {
    // Test graceful degradation in development
  });
  
  it('should rotate secrets without service interruption', () => {
    // Test secret rotation process
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Environment health check displays correctly', async () => {
  await mcp__playwright__browser_navigate({url: '/admin/health'});
  await mcp__playwright__browser_snapshot();
  // Verify health indicators show correct status
});
```

### ACCEPTANCE CRITERIA
- [ ] All three environments (dev/staging/prod) have proper variable validation
- [ ] Secret rotation script works without service downtime
- [ ] Feature flags can be toggled per environment
- [ ] Environment health check API returns accurate status
- [ ] Performance: Environment validation completes under 100ms
- [ ] Security: No secrets logged or exposed in client code
- [ ] Accessibility: Environment indicators follow WCAG 2.1 standards

### DEPENDENCIES
- Must complete after: None - foundational infrastructure
- Must complete before: WS-095 (GitHub Actions CI/CD)
- Shares code with: All other features (provides environment foundation)

### ESTIMATED EFFORT
- Team A Frontend: 8 hours (environment indicators, feature flag components)
- Team B Backend: 12 hours (validation, health checks, secret rotation)
- Team C Integration: 6 hours (Vercel setup, deployment scripts)
- Total: 26 hours