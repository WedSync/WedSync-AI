# TECHNICAL SPECIFICATION: WS-229 - Admin Quick Actions
## Generated by Feature Development Session - 2025-01-25

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** WedSync platform administrator managing peak wedding season operations
**I want to:** Execute common administrative tasks instantly without navigating multiple screens
**So that:** I can quickly resolve photographer billing issues, reset couple passwords, and handle emergency situations that could disrupt active wedding coordination

**Real Wedding Scenario:**
"During a Saturday with 20 active weddings, administrators need rapid access to critical actions: a photographer can't log in 2 hours before their wedding ceremony, a couple's guest RSVP system crashed, or payment processing fails for multiple vendors. Quick actions enable 30-second resolutions for tasks that would otherwise require 5+ minutes of navigation through multiple admin screens, preventing wedding day disruptions."

### SPECIFICATION SOURCE
- **Feature ID:** WS-229
- **Original Spec:** /CORE-SPECIFICATIONS/07-ADMIN-DASHBOARD/01-Overview/04-quick-actions md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** None (new feature)
- **New Files to Create:**
  - `/src/components/admin/QuickActionsPanel.tsx`
  - `/src/components/admin/BulkOperations.tsx`
  - `/src/components/admin/EmergencyActions.tsx`
  - `/src/lib/admin/quick-actions.ts`
  - `/src/app/api/admin/actions/route.ts`
  - `/src/hooks/useQuickActions.ts`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Admin actions audit log
CREATE TABLE admin_actions_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  admin_id UUID NOT NULL REFERENCES admin_users(id),
  action_type VARCHAR(100) NOT NULL,
  action_category VARCHAR(50),
  target_type VARCHAR(50), -- 'user', 'supplier', 'system'
  target_id VARCHAR(255),
  parameters JSONB,
  result JSONB,
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_admin_actions_admin ON admin_actions_log(admin_id);
CREATE INDEX idx_admin_actions_created ON admin_actions_log(created_at DESC);
CREATE INDEX idx_admin_actions_type ON admin_actions_log(action_type);

-- Quick action templates for custom tasks
CREATE TABLE quick_action_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  category VARCHAR(50),
  action_type VARCHAR(100),
  parameters JSONB,
  permissions TEXT[],
  keyboard_shortcut VARCHAR(50),
  created_by UUID REFERENCES admin_users(id),
  is_public BOOLEAN DEFAULT false
);
```

#### API Endpoints Required
```typescript
// POST /api/admin/actions/execute
interface ExecuteActionRequest {
  actionId: string;
  parameters?: Record<string, any>;
  confirmation?: string;
}

interface ExecuteActionResponse {
  success: boolean;
  result: any;
  message: string;
  auditLogId: string;
}

// GET /api/admin/actions/history
interface ActionHistoryResponse {
  actions: AdminAction[];
  pagination: {
    page: number;
    totalPages: number;
    totalCount: number;
  };
}

// POST /api/admin/actions/bulk
interface BulkOperationRequest {
  operation: string;
  targetIds: string[];
  parameters?: Record<string, any>;
}
```

#### Frontend Components Required
```typescript
// Component: QuickActionsPanel
// Location: /src/components/admin/QuickActionsPanel.tsx

interface QuickActionsPanelProps {
  adminPermissions: AdminPermission[];
  recentActions?: AdminAction[];
}

// Key functionality:
- Command palette style search with keyboard shortcuts
- Permission-filtered action display
- Confirmation dialogs for critical actions
- Real-time action history tracking
- Keyboard shortcut support (Cmd/Ctrl + K for search)

// Component: BulkOperations  
// Location: /src/components/admin/BulkOperations.tsx

interface BulkOperationsProps {
  selectedItems: string[];
  targetType: 'users' | 'suppliers' | 'weddings';
}

// Key functionality:
- Multi-select operation execution
- Progress tracking for long-running operations
- Bulk email, data export, account modifications
- Operation result reporting and error handling
```

#### Integration Points
```typescript
// Service: QuickActionsManager
// Dependencies: Database, Email Service, Redis Cache, Audit Logger

class QuickActionsManager {
  async executeAction(
    actionId: string, 
    parameters: any, 
    adminId: string
  ): Promise<ActionResult> {
    // Execute action with full audit trail
  }
  
  async executeBulkOperation(
    operation: BulkOperation,
    targetIds: string[],
    adminId: string
  ): Promise<BulkResult> {
    // Handle bulk operations with progress tracking
  }
}
```

### CODE EXAMPLES

#### Example 1: Quick Actions Panel Implementation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabase';
import { toast } from 'react-hot-toast';

export interface QuickAction {
  id: string;
  category: 'user' | 'system' | 'financial' | 'support' | 'data';
  label: string;
  icon: string;
  action: (params?: any) => Promise<void>;
  requiresConfirmation: boolean;
  permissions: AdminPermission[];
  keyboardShortcut?: string;
}

export const QuickActionsPanel = ({ adminPermissions }: { adminPermissions: AdminPermission[] }) => {
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedAction, setSelectedAction] = useState<QuickAction | null>(null);
  const [isExecuting, setIsExecuting] = useState(false);

  const quickActions: QuickAction[] = [
    {
      id: 'reset_password',
      category: 'user',
      label: 'Reset User Password',
      icon: 'key',
      action: async (email: string) => {
        const { error } = await supabase.auth.admin.generateLink({
          type: 'recovery',
          email,
        });
        if (error) throw error;
        toast.success('Password reset email sent');
      },
      requiresConfirmation: false,
      permissions: ['user_management'],
    },
    {
      id: 'clear_cache',
      category: 'system',
      label: 'Clear All Caches',
      icon: 'refresh',
      action: async () => {
        await fetch('/api/admin/cache/clear', { method: 'POST' });
        toast.success('All caches cleared');
      },
      requiresConfirmation: true,
      permissions: ['system_admin'],
      keyboardShortcut: 'cmd+shift+c',
    },
    {
      id: 'apply_credit',
      category: 'financial', 
      label: 'Apply Account Credit',
      icon: 'credit-card',
      action: async (params: { userId: string; amount: number; reason: string }) => {
        await fetch('/api/admin/billing/credit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(params),
        });
        toast.success(`$${params.amount} credit applied`);
      },
      requiresConfirmation: true,
      permissions: ['billing_admin'],
    },
  ];

  // Filter actions based on admin permissions
  const availableActions = quickActions.filter(action =>
    action.permissions.some(perm => adminPermissions.includes(perm))
  );

  const filteredActions = availableActions.filter(action =>
    action.label.toLowerCase().includes(searchQuery.toLowerCase())
  );

  const executeAction = async (action: QuickAction, parameters?: any) => {
    if (action.requiresConfirmation && !confirm(`Execute "${action.label}"?`)) {
      return;
    }

    setIsExecuting(true);
    try {
      await action.action(parameters);
      
      // Log the action
      await supabase.from('admin_actions_log').insert({
        action_type: action.id,
        action_category: action.category,
        parameters: parameters || {},
        ip_address: await getUserIP(),
      });
      
    } catch (error) {
      toast.error(`Action failed: ${error.message}`);
    } finally {
      setIsExecuting(false);
    }
  };

  // Keyboard shortcuts handler
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        document.getElementById('action-search')?.focus();
      }
      
      // Handle action shortcuts
      quickActions.forEach(action => {
        if (action.keyboardShortcut && checkShortcut(e, action.keyboardShortcut)) {
          e.preventDefault();
          executeAction(action);
        }
      });
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, []);

  return (
    <div className="quick-actions-panel">
      <div className="search-bar">
        <input
          id="action-search"
          type="text"
          placeholder="Search actions or press Cmd+K"
          value={searchQuery}
          onChange={(e) => setSearchQuery(e.target.value)}
          className="w-full p-3 border rounded-lg"
        />
      </div>

      <div className="action-categories mt-4">
        {Object.entries(groupBy(filteredActions, 'category')).map(([category, actions]) => (
          <div key={category} className="mb-6">
            <h3 className="text-sm font-semibold text-gray-600 uppercase mb-3">
              {category}
            </h3>
            <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
              {actions.map(action => (
                <ActionButton
                  key={action.id}
                  action={action}
                  onClick={() => executeAction(action)}
                  isLoading={isExecuting}
                />
              ))}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

const ActionButton = ({ action, onClick, isLoading }: {
  action: QuickAction;
  onClick: () => void;
  isLoading: boolean;
}) => (
  <button
    onClick={onClick}
    disabled={isLoading}
    className="p-4 border rounded-lg hover:bg-gray-50 flex flex-col items-center gap-2 transition-colors"
  >
    <span className="text-2xl">{action.icon}</span>
    <span className="text-sm font-medium">{action.label}</span>
    {action.keyboardShortcut && (
      <span className="text-xs text-gray-500">{action.keyboardShortcut}</span>
    )}
  </button>
);
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for React hooks, form handling patterns
- [x] Supabase: Database operations and admin authentication
- [x] Filesystem: Access admin configuration templates

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/vercel/next.js", "api routes admin", 2000);
await mcp__context7__get-library-docs("/supabase/supabase", "admin api", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('QuickActionsManager', () => {
  it('should execute password reset action with audit log', async () => {
    const manager = new QuickActionsManager();
    const result = await manager.executeAction('reset_password', { email: 'test@example.com' }, 'admin-id');
    
    expect(result.success).toBe(true);
    expect(result.auditLogId).toBeDefined();
  });

  it('should require confirmation for critical actions', async () => {
    const action = quickActions.find(a => a.id === 'clear_cache');
    expect(action.requiresConfirmation).toBe(true);
  });

  it('should filter actions by admin permissions', async () => {
    const permissions = ['user_management'];
    const filtered = filterActionsByPermissions(quickActions, permissions);
    expect(filtered.every(a => a.permissions.includes('user_management'))).toBe(true);
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Admin can execute quick actions with keyboard shortcuts', async () => {
  await mcp__playwright__browser_navigate({url: '/admin/dashboard'});
  
  // Test keyboard shortcut for opening search
  await mcp__playwright__browser_press_key({key: 'Meta+k'});
  await mcp__playwright__browser_snapshot();
  
  // Search for password reset action
  await mcp__playwright__browser_type({
    element: 'Action search input',
    ref: '#action-search',
    text: 'reset password'
  });
  
  // Execute action
  await mcp__playwright__browser_click({
    element: 'Reset password action button',
    ref: '[data-testid="action-reset_password"]'
  });
  
  await mcp__playwright__browser_snapshot();
});
```

### ACCEPTANCE CRITERIA
- [x] Quick actions panel displays all permitted actions grouped by category
- [x] Search functionality filters actions in real-time
- [x] Keyboard shortcuts work for common actions (Cmd+K for search)
- [x] Critical actions require explicit confirmation dialogs
- [x] All actions create detailed audit logs with IP tracking
- [x] Performance: Action search under 100ms, execution under 3s
- [x] Security: Permission verification before every action execution
- [x] Accessibility: Full keyboard navigation and screen reader support

### DEPENDENCIES
- Must complete after: Admin authentication system, admin permissions framework
- Must complete before: Admin monitoring dashboard
- Shares code with: Admin audit logging system

### ESTIMATED EFFORT
- Team A Frontend: 32 hours (QuickActionsPanel, BulkOperations, EmergencyActions components)
- Team B Backend: 20 hours (Action execution engine, audit logging, API endpoints)
- Team C Integration: 8 hours (Email service, Redis cache integration)
- Team D Platform: 6 hours (Database schema, performance optimization)
- Team E General: 8 hours (Testing, keyboard shortcuts, accessibility)
- Team F Workflows: 4 hours (Action workflow automation)
- Team G Performance: 4 hours (Action execution optimization)
- Total: 82 hours