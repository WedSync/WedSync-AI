# TECHNICAL SPECIFICATION: WS-033 - CSV/Excel Import
## Generated by Feature Development Session - 2025-08-21

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding photographer switching from Excel to WedSync with 150 existing clients
**I want to:** Import my entire client database from Excel without losing data or spending hours on manual entry
**So that:** I can start using WedSync immediately without redoing years of client data entry work

**Real Wedding Scenario:**
A photographer has an Excel file with columns like "Couple Names", "Wedding Date", "Venue", "Package", "Email", and "Phone". Some rows have "John & Jane Smith", others have "Smith, John and Jane". Wedding dates vary between "6/15/2024", "June 15, 2024", and "15/06/2024". The import tool needs to intelligently parse all these variations and create clean, standardized client records.

### SPECIFICATION SOURCE
- **Feature ID:** WS-033
- **Original Spec:** /CORE-SPECIFICATIONS/02-WEDSYNC-SUPPLIER-PLATFORM/03-Client-Management/04-csv-excel-import md.md
- **Current Implementation:** 0% complete
- **Files to Modify:**
  - `/src/app/(dashboard)/clients/import/page.tsx` (new)
  - `/src/components/import/ImportWizard.tsx` (new)
- **New Files to Create:**
  - `/src/components/import/FileUpload.tsx`
  - `/src/components/import/ColumnMapping.tsx`
  - `/src/components/import/DataPreview.tsx`
  - `/src/components/import/ValidationResults.tsx`
  - `/src/lib/import/parser.ts`
  - `/src/lib/import/validator.ts`
  - `/src/lib/import/transformer.ts`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Import jobs for tracking and rollback
CREATE TABLE IF NOT EXISTS import_jobs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID REFERENCES suppliers(id) ON DELETE CASCADE,
  file_name TEXT NOT NULL,
  file_size INTEGER NOT NULL,
  total_rows INTEGER NOT NULL,
  successful_rows INTEGER DEFAULT 0,
  failed_rows INTEGER DEFAULT 0,
  status TEXT CHECK (status IN ('processing', 'completed', 'failed')) DEFAULT 'processing',
  error_log JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ
);

-- Import errors for detailed reporting
CREATE TABLE IF NOT EXISTS import_errors (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  import_job_id UUID REFERENCES import_jobs(id) ON DELETE CASCADE,
  row_number INTEGER NOT NULL,
  column_name TEXT,
  error_type TEXT NOT NULL, -- 'validation', 'parsing', 'duplicate'
  error_message TEXT NOT NULL,
  raw_value TEXT,
  suggested_fix TEXT
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_import_jobs_supplier_id ON import_jobs(supplier_id);
CREATE INDEX IF NOT EXISTS idx_import_errors_job_id ON import_errors(import_job_id);
```

#### API Endpoints Required
```typescript
// POST /api/import/upload
interface UploadFileRequest {
  file: File;
}

interface UploadFileResponse {
  jobId: string;
  preview: {
    headers: string[];
    rows: any[][];
    totalRows: number;
  };
  detectedFormat: {
    delimiter: string;
    encoding: string;
    hasHeaders: boolean;
  };
}

// POST /api/import/process
interface ProcessImportRequest {
  jobId: string;
  columnMapping: Record<string, string>;
  options: {
    skipErrors: boolean;
    updateExisting: boolean;
  };
}

interface ProcessImportResponse {
  success: boolean;
  jobId: string;
  results: {
    total: number;
    successful: number;
    failed: number;
    errors: ImportError[];
  };
}

// GET /api/import/[jobId]/status
interface ImportStatusResponse {
  status: 'processing' | 'completed' | 'failed';
  progress: {
    current: number;
    total: number;
    percentage: number;
  };
  errors?: ImportError[];
}
```

#### Frontend Components Required
```typescript
// Component: ImportWizard
// Location: /src/components/import/ImportWizard.tsx

interface ImportWizardProps {
  onComplete: (results: ImportResults) => void;
}

// Key functionality:
- Multi-step wizard (Upload → Map → Preview → Process)
- Progress indicator with step completion
- Error handling with detailed feedback
- File validation before upload
- Real-time processing status

// Component: FileUpload
// Location: /src/components/import/FileUpload.tsx
interface FileUploadProps {
  onFileSelect: (file: File) => void;
  acceptedFormats: string[];
}

// Key functionality:
- Drag-and-drop file upload
- File format validation (CSV, XLSX, XLS)
- File size limit checking (10MB max)
- Format detection and preview

// Component: ColumnMapping
// Location: /src/components/import/ColumnMapping.tsx
interface ColumnMappingProps {
  headers: string[];
  onMappingChange: (mapping: Record<string, string>) => void;
}

// Key functionality:
- Smart column detection with confidence scores
- Dropdown mapping for each column
- Preview of mapped data
- Required field validation
```

#### Integration Points
```typescript
// Service: ImportService
// Dependencies: Papa Parse, XLSX, Web Workers

class ImportService {
  async uploadFile(file: File): Promise<UploadFileResponse> {
    // Create web worker for file processing
    const worker = new Worker('/workers/import-parser.js');
    
    return new Promise((resolve, reject) => {
      worker.postMessage({ file, action: 'parse' });
      
      worker.onmessage = (e) => {
        const { success, data, error } = e.data;
        if (success) {
          resolve(data);
        } else {
          reject(error);
        }
      };
    });
  }
  
  async processImport(jobId: string, mapping: Record<string, string>): Promise<void> {
    const response = await fetch('/api/import/process', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ jobId, columnMapping: mapping })
    });
    
    if (!response.ok) {
      throw new Error('Import processing failed');
    }
    
    // Poll for status updates
    return this.pollImportStatus(jobId);
  }
  
  private async pollImportStatus(jobId: string): Promise<void> {
    return new Promise((resolve, reject) => {
      const poll = async () => {
        const status = await this.getImportStatus(jobId);
        
        if (status.status === 'completed') {
          resolve();
        } else if (status.status === 'failed') {
          reject(new Error('Import failed'));
        } else {
          setTimeout(poll, 1000);
        }
      };
      
      poll();
    });
  }
}
```

### CODE EXAMPLES

#### Example 1: Smart Column Detection
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { parse } from 'papaparse';

interface ColumnDetection {
  column: string;
  confidence: number;
  detectedType: string;
}

export class ColumnDetector {
  private static patterns = {
    email: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
    phone: /^[\+]?[1-9][\d]{0,15}$/,
    date: /^\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}$/,
    names: /(and|&|\+)/i
  };
  
  static detectColumns(headers: string[], sampleData: any[][]): Record<string, ColumnDetection> {
    const results: Record<string, ColumnDetection> = {};
    
    headers.forEach((header, index) => {
      const columnData = sampleData.map(row => row[index]).filter(Boolean);
      const detection = this.analyzeColumn(header, columnData);
      results[header] = detection;
    });
    
    return results;
  }
  
  private static analyzeColumn(header: string, data: any[]): ColumnDetection {
    const headerLower = header.toLowerCase();
    
    // Check header text patterns
    if (headerLower.includes('email')) {
      return { column: 'email', confidence: 0.9, detectedType: 'email' };
    }
    
    if (headerLower.includes('couple') || headerLower.includes('names')) {
      return { column: 'couple_name', confidence: 0.85, detectedType: 'names' };
    }
    
    if (headerLower.includes('wedding') && headerLower.includes('date')) {
      return { column: 'wedding_date', confidence: 0.9, detectedType: 'date' };
    }
    
    // Check data patterns
    const emailMatches = data.filter(val => this.patterns.email.test(val)).length;
    if (emailMatches / data.length > 0.8) {
      return { column: 'email', confidence: 0.8, detectedType: 'email' };
    }
    
    const dateMatches = data.filter(val => this.patterns.date.test(val)).length;
    if (dateMatches / data.length > 0.7) {
      return { column: 'wedding_date', confidence: 0.7, detectedType: 'date' };
    }
    
    return { column: 'custom', confidence: 0.1, detectedType: 'text' };
  }
}
```

#### Example 2: Name Parsing Logic
```typescript
export class NameParser {
  static parseCoupleName(rawName: string): { name1: string; name2: string; lastName?: string } {
    const cleaned = rawName.trim().replace(/\s+/g, ' ');
    
    // Handle "John & Jane Smith"
    const ampersandMatch = cleaned.match(/^(.+?)\s*&\s*(.+?)(\s+\w+)?$/);
    if (ampersandMatch) {
      const [, name1, name2, lastNamePart] = ampersandMatch;
      return {
        name1: name1.trim(),
        name2: name2.trim(),
        lastName: lastNamePart?.trim()
      };
    }
    
    // Handle "Smith, John and Jane"
    const commaMatch = cleaned.match(/^(\w+),\s*(.+?)\s+and\s+(.+)$/);
    if (commaMatch) {
      const [, lastName, name1, name2] = commaMatch;
      return {
        name1: name1.trim(),
        name2: name2.trim(),
        lastName: lastName.trim()
      };
    }
    
    // Handle "John and Jane Smith"
    const andMatch = cleaned.match(/^(.+?)\s+and\s+(.+?)(\s+\w+)?$/);
    if (andMatch) {
      const [, name1, name2, lastNamePart] = andMatch;
      return {
        name1: name1.trim(),
        name2: name2.trim(),
        lastName: lastNamePart?.trim()
      };
    }
    
    // Fallback: treat as single name
    return { name1: cleaned, name2: '' };
  }
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for Papa Parse, XLSX library, Web Workers
- [x] Playwright: Test import wizard flow, file upload, error handling
- [x] Filesystem: Access existing client creation patterns

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/papaparse/papaparse", "csv parsing", 2000);
await mcp__context7__get-library-docs("/sheetjs/sheetjs", "excel file reading", 2000);
await mcp__context7__get-library-docs("/vercel/next.js", "file upload api routes", 3000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('ColumnDetector', () => {
  it('should detect email columns correctly', () => {
    const headers = ['Email Address', 'Phone'];
    const data = [['john@email.com', '555-1234']];
    const result = ColumnDetector.detectColumns(headers, data);
    expect(result['Email Address'].column).toBe('email');
    expect(result['Email Address'].confidence).toBeGreaterThan(0.8);
  });
});

describe('NameParser', () => {
  it('should parse "John & Jane Smith" correctly', () => {
    const result = NameParser.parseCoupleName('John & Jane Smith');
    expect(result).toEqual({
      name1: 'John',
      name2: 'Jane',
      lastName: 'Smith'
    });
  });
  
  it('should handle "Smith, John and Jane"', () => {
    const result = NameParser.parseCoupleName('Smith, John and Jane');
    expect(result).toEqual({
      name1: 'John',
      name2: 'Jane',
      lastName: 'Smith'
    });
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('CSV import workflow', async () => {
  await mcp__playwright__browser_navigate({url: '/clients/import'});
  
  // Test file upload
  await mcp__playwright__browser_file_upload({
    paths: ['/test-data/sample-clients.csv']
  });
  
  // Test column mapping
  await mcp__playwright__browser_select_option({
    element: 'Couple Names mapping dropdown',
    ref: '[data-testid="mapping-couple_name"]',
    values: ['couple_name']
  });
  
  // Test import processing
  await mcp__playwright__browser_click({
    element: 'Import button',
    ref: '[data-testid="import-submit"]'
  });
  
  // Wait for completion
  await mcp__playwright__browser_wait_for({
    text: 'Import completed'
  });
  
  await mcp__playwright__browser_snapshot();
});
```

### ACCEPTANCE CRITERIA
- [x] Supports CSV, XLSX, XLS file formats up to 10MB
- [x] Auto-detects delimiters (comma, tab, pipe, semicolon)
- [x] Intelligently maps columns with 80%+ accuracy
- [x] Parses couple names in multiple formats correctly
- [x] Performance: Processes 1000 rows in <30 seconds
- [x] Security: Files processed server-side, not stored permanently
- [x] Accessibility: Full keyboard navigation through wizard

### DEPENDENCIES
- Must complete after: WS-031 (Client List Views) 
- Must complete before: None (standalone feature)
- Shares code with: Client creation forms, validation utilities

### ESTIMATED EFFORT
- Team A Frontend: 14 hours
- Team B Backend: 16 hours
- Team C Integration: 12 hours
- Total: 42 hours