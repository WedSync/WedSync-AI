<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WedSync Live Monitoring Dashboard</title>
    <meta http-equiv="refresh" content="30"> <!-- Auto-refresh every 30 seconds -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }
        .dashboard { max-width: 1400px; margin: 0 auto; }
        .header { 
            background: rgba(255,255,255,0.1); 
            padding: 20px; 
            border-radius: 10px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            text-align: center;
        }
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: rgba(255,255,255,0.95);
            color: #333;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .status-ok { color: #10b981; }
        .status-warning { color: #f59e0b; }
        .status-critical { color: #ef4444; }
        .metric { font-size: 2em; font-weight: bold; margin: 10px 0; }
        .label { color: #666; font-size: 0.9em; margin-bottom: 5px; }
        .details { font-size: 0.8em; color: #888; margin-top: 10px; }
        #lastUpdate { 
            position: fixed; 
            top: 10px; 
            right: 10px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        .wide-card {
            grid-column: 1 / -1;
        }
        .error-list, .deployment-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .error-item, .deployment-item {
            padding: 10px;
            border-left: 4px solid #ef4444;
            margin: 10px 0;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 0 5px 5px 0;
        }
        .deployment-item {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.3s ease;
        }
        .connection-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .connected { background: #10b981; }
        .disconnected { background: #ef4444; }
        .health-indicator {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div id="lastUpdate">Initializing...</div>
    <div class="dashboard">
        <div class="header">
            <h1>üöÄ WedSync Real-Time Monitoring</h1>
            <p>Development & Production Status Dashboard</p>
            <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">
                Auto-refresh: 30 seconds | Environment: <span id="environmentInfo">Loading...</span>
            </div>
        </div>
        
        <div class="grid">
            <!-- System Health -->
            <div class="card">
                <h3>üü¢ System Health</h3>
                <div class="metric status-ok" id="systemStatus">Loading...</div>
                <div class="label">Overall System Status</div>
                <div id="healthChecks">
                    <div class="health-indicator">
                        <span class="connection-status" id="apiStatus"></span>
                        <span>API Services</span>
                    </div>
                    <div class="health-indicator">
                        <span class="connection-status" id="dbStatus"></span>
                        <span>Database</span>
                    </div>
                    <div class="health-indicator">
                        <span class="connection-status" id="authStatus"></span>
                        <span>Authentication</span>
                    </div>
                    <div class="health-indicator">
                        <span class="connection-status" id="storageStatus"></span>
                        <span>Storage</span>
                    </div>
                </div>
            </div>
            
            <!-- Error Tracking -->
            <div class="card">
                <h3>üêõ Errors (24h)</h3>
                <div class="metric" id="errorCount">0</div>
                <div class="label">
                    <span class="status-critical">Critical: <span id="criticalErrors">0</span></span> | 
                    <span class="status-warning">Warning: <span id="warningErrors">0</span></span> |
                    <span class="status-ok">Info: <span id="infoErrors">0</span></span>
                </div>
                <div class="details" id="errorTrend">
                    Trend: Loading...
                </div>
            </div>
            
            <!-- Performance -->
            <div class="card">
                <h3>‚ö° Performance</h3>
                <div class="metric" id="avgResponseTime">0ms</div>
                <div class="label">Average API Response</div>
                <div id="performanceDetails">
                    <div>LCP: <span id="lcp">-</span></div>
                    <div>FID: <span id="fid">-</span></div>
                    <div>CLS: <span id="cls">-</span></div>
                    <div>TTFB: <span id="ttfb">-</span></div>
                </div>
            </div>
            
            <!-- Active Users -->
            <div class="card">
                <h3>üë• Active Users</h3>
                <div class="metric" id="activeUsers">0</div>
                <div class="label">Currently Online</div>
                <div class="details">
                    <div>Peak today: <span id="peakUsers">0</span></div>
                    <div>New signups: <span id="newSignups">0</span></div>
                </div>
            </div>
            
            <!-- Database -->
            <div class="card">
                <h3>üíæ Database</h3>
                <div class="metric" id="dbConnections">0/100</div>
                <div class="label">Connection Pool</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="dbProgress" style="width: 0%"></div>
                </div>
                <div id="dbStats">
                    <div>Slow queries: <span id="slowQueries">0</span></div>
                    <div>Cache hit rate: <span id="cacheHitRate">0%</span></div>
                </div>
            </div>
            
            <!-- Security -->
            <div class="card">
                <h3>üîí Security</h3>
                <div class="metric status-ok" id="securityStatus">Secure</div>
                <div class="label" id="securityLabel">No vulnerabilities detected</div>
                <div id="securityDetails">
                    <div>Failed logins: <span id="failedLogins">0</span></div>
                    <div>Last scan: <span id="lastSecurityScan">Never</span></div>
                </div>
            </div>

            <!-- Wedding-Specific Metrics -->
            <div class="card">
                <h3>üíí Wedding Context</h3>
                <div class="metric" id="upcomingWeddings">0</div>
                <div class="label">Weddings This Week</div>
                <div id="weddingDetails">
                    <div>Critical period: <span id="criticalWeddings">0</span></div>
                    <div>Active vendors: <span id="activeVendors">0</span></div>
                </div>
            </div>

            <!-- Revenue & Business -->
            <div class="card">
                <h3>üí∞ Business Metrics</h3>
                <div class="metric" id="dailyRevenue">$0</div>
                <div class="label">Today's Revenue</div>
                <div class="details">
                    <div>Monthly: <span id="monthlyRevenue">$0</span></div>
                    <div>Churn rate: <span id="churnRate">0%</span></div>
                </div>
            </div>
        </div>
        
        <!-- Recent Errors -->
        <div class="card wide-card">
            <h3>üìã Recent Errors</h3>
            <div id="recentErrors" class="error-list">
                <p>Loading recent errors...</p>
            </div>
        </div>
        
        <!-- Deployment Status -->
        <div class="card wide-card">
            <h3>üöÄ Recent Deployments</h3>
            <div id="deployments" class="deployment-list">
                <p>Loading deployment history...</p>
            </div>
        </div>
    </div>

    <script>
        let updateInterval;
        let isOnline = navigator.onLine;

        // Configuration
        const API_BASE = window.location.hostname === 'localhost' ? 
                          'http://localhost:3000' : 
                          'https://wedsync.com';

        // Main update function
        async function updateDashboard() {
            const startTime = Date.now();
            
            try {
                // Check if we're online
                if (!navigator.onLine) {
                    showOfflineStatus();
                    return;
                }

                // Fetch monitoring data from API
                const response = await fetch(`${API_BASE}/api/monitoring/status`, {
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                // Update all metrics
                updateSystemHealth(data.system || {});
                updateErrorMetrics(data.errors || {});
                updatePerformanceMetrics(data.performance || {});
                updateUserMetrics(data.users || {});
                updateDatabaseMetrics(data.database || {});
                updateSecurityMetrics(data.security || {});
                updateWeddingMetrics(data.wedding || {});
                updateBusinessMetrics(data.business || {});
                updateRecentErrors(data.errors?.recent || []);
                updateDeployments(data.deployments?.recent || []);
                
                // Update timestamp and response time
                const responseTime = Date.now() - startTime;
                document.getElementById('lastUpdate').textContent = 
                    `Last Update: ${new Date().toLocaleTimeString()} | Response: ${responseTime}ms | Auto-refresh: 30s`;
                
                document.getElementById('environmentInfo').textContent = data.environment || 'production';

                // Clear any error states
                clearErrorState();
                
            } catch (error) {
                console.error('Failed to fetch monitoring data:', error);
                showErrorState(error.message);
            }
        }

        function updateSystemHealth(system) {
            const statusEl = document.getElementById('systemStatus');
            const status = system.status || 'Unknown';
            
            statusEl.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            statusEl.className = `metric status-${getStatusClass(status)}`;
            
            // Update individual service statuses
            updateServiceStatus('apiStatus', system.api?.status);
            updateServiceStatus('dbStatus', system.database?.status);
            updateServiceStatus('authStatus', system.auth?.status);
            updateServiceStatus('storageStatus', system.storage?.status);
        }

        function updateServiceStatus(elementId, status) {
            const el = document.getElementById(elementId);
            if (el) {
                el.className = `connection-status ${status === 'healthy' ? 'connected' : 'disconnected'}`;
            }
        }

        function updateErrorMetrics(errors) {
            document.getElementById('errorCount').textContent = errors.total || '0';
            document.getElementById('criticalErrors').textContent = errors.critical || '0';
            document.getElementById('warningErrors').textContent = errors.warning || '0';
            document.getElementById('infoErrors').textContent = errors.info || '0';
            
            if (errors.trend) {
                document.getElementById('errorTrend').textContent = `Trend: ${errors.trend}`;
            }
        }

        function updatePerformanceMetrics(performance) {
            document.getElementById('avgResponseTime').textContent = performance.avgResponseTime || '0ms';
            
            // Update Web Vitals
            document.getElementById('lcp').textContent = performance.lcp?.value ? `${performance.lcp.value}ms` : '-';
            document.getElementById('fid').textContent = performance.fid?.value ? `${performance.fid.value}ms` : '-';
            document.getElementById('cls').textContent = performance.cls?.value || '-';
            document.getElementById('ttfb').textContent = performance.ttfb?.value ? `${performance.ttfb.value}ms` : '-';
        }

        function updateUserMetrics(users) {
            document.getElementById('activeUsers').textContent = users.active || '0';
            document.getElementById('peakUsers').textContent = users.peak || '0';
            document.getElementById('newSignups').textContent = users.newSignups || '0';
        }

        function updateDatabaseMetrics(database) {
            const connections = database.active || 0;
            const maxConnections = database.max || 100;
            const percentage = (connections / maxConnections) * 100;
            
            document.getElementById('dbConnections').textContent = `${connections}/${maxConnections}`;
            document.getElementById('dbProgress').style.width = `${percentage}%`;
            document.getElementById('slowQueries').textContent = database.slowQueries || '0';
            document.getElementById('cacheHitRate').textContent = database.cacheHitRate || '0%';
        }

        function updateSecurityMetrics(security) {
            const statusEl = document.getElementById('securityStatus');
            const status = security.status || 'Unknown';
            
            statusEl.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            statusEl.className = `metric status-${getStatusClass(status)}`;
            
            document.getElementById('securityLabel').textContent = security.message || 'Status unknown';
            document.getElementById('failedLogins').textContent = security.failedLogins || '0';
            document.getElementById('lastSecurityScan').textContent = security.lastScan || 'Never';
        }

        function updateWeddingMetrics(wedding) {
            document.getElementById('upcomingWeddings').textContent = wedding.thisWeek || '0';
            document.getElementById('criticalWeddings').textContent = wedding.critical || '0';
            document.getElementById('activeVendors').textContent = wedding.vendors || '0';
        }

        function updateBusinessMetrics(business) {
            document.getElementById('dailyRevenue').textContent = business.daily || '$0';
            document.getElementById('monthlyRevenue').textContent = business.monthly || '$0';
            document.getElementById('churnRate').textContent = business.churnRate || '0%';
        }

        function updateRecentErrors(errors) {
            const container = document.getElementById('recentErrors');
            
            if (!errors.length) {
                container.innerHTML = '<p>No recent errors üéâ</p>';
                return;
            }
            
            const errorsList = errors.slice(0, 5).map(err => `
                <div class="error-item">
                    <strong>${err.message || 'Unknown Error'}</strong><br>
                    <small>${err.count || 1} occurrences | ${err.lastSeen || 'Recently'} | Severity: ${err.severity || 'unknown'}</small>
                </div>
            `).join('');
            
            container.innerHTML = errorsList;
        }

        function updateDeployments(deployments) {
            const container = document.getElementById('deployments');
            
            if (!deployments.length) {
                container.innerHTML = '<p>No recent deployments</p>';
                return;
            }
            
            const deploymentsList = deployments.slice(0, 3).map(deployment => `
                <div class="deployment-item">
                    <strong>${deployment.version || 'Unknown Version'}</strong> - ${deployment.status || 'Unknown Status'}<br>
                    <small>Deployed: ${deployment.deployedAt || 'Unknown'} | Environment: ${deployment.environment || 'unknown'}</small>
                </div>
            `).join('');
            
            container.innerHTML = deploymentsList;
        }

        function getStatusClass(status) {
            switch (status?.toLowerCase()) {
                case 'healthy':
                case 'operational':
                case 'secure':
                case 'good':
                    return 'ok';
                case 'warning':
                case 'degraded':
                    return 'warning';
                case 'error':
                case 'critical':
                case 'down':
                    return 'critical';
                default:
                    return 'warning';
            }
        }

        function showErrorState(message) {
            document.getElementById('lastUpdate').innerHTML = `
                <span style="color: #ef4444;">‚ö†Ô∏è Connection Error</span><br>
                <small>${message}</small><br>
                <small>Retrying in 30s...</small>
            `;
        }

        function showOfflineStatus() {
            document.getElementById('lastUpdate').innerHTML = `
                <span style="color: #f59e0b;">üì° Offline Mode</span><br>
                <small>Check your internet connection</small>
            `;
        }

        function clearErrorState() {
            // Clear any error styling if needed
        }

        // Handle online/offline events
        window.addEventListener('online', () => {
            isOnline = true;
            updateDashboard();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            showOfflineStatus();
        });

        // Initialize the dashboard
        updateDashboard();
        
        // Set up auto-refresh every 30 seconds
        updateInterval = setInterval(updateDashboard, 30000);

        // Update immediately on page focus (when user returns to tab)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && isOnline) {
                updateDashboard();
            }
        });

        // Manual refresh on click
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
                e.preventDefault();
                updateDashboard();
            }
        });
    </script>
</body>
</html>