# TECHNICAL SPECIFICATION: WS-051 - Client Activity Tracking
## Generated by Feature Development Session - 2025-08-21

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding photographer tracking client engagement
**I want to:** See exactly when couples view my forms, open emails, and complete tasks
**So that:** I can follow up at the perfect moment and increase booking rates by 40%

**Real Wedding Scenario:**
Photographer Anna sends a client questionnaire on Monday. The activity tracker shows the couple opened it Tuesday at 8pm, started filling it out but abandoned it at question 12. Anna sees they haven't returned in 3 days, so she sends a gentle follow-up offering a 15-minute call to help complete it. The couple books immediately, saying they were overwhelmed by the questions.

### SPECIFICATION SOURCE
- **Feature ID:** WS-051
- **Original Spec:** /CORE-SPECIFICATIONS/02-WEDSYNC-SUPPLIER-PLATFORM/10-Analytics/01-client-activity-tracking md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** None - new feature
- **New Files to Create:**
  - `/src/components/analytics/ActivityTracker.tsx`
  - `/src/components/analytics/ActivityTimeline.tsx`
  - `/src/app/api/analytics/activities/route.ts`
  - `/src/lib/analytics/activity-engine.ts`
  - `/src/lib/analytics/session-manager.ts`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Client Activities table
CREATE TABLE IF NOT EXISTS client_activities (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  client_id UUID NOT NULL REFERENCES couples(id),
  supplier_id UUID NOT NULL REFERENCES suppliers(id),
  session_id VARCHAR(64) NOT NULL,
  event_type VARCHAR(30) NOT NULL, -- 'page_view', 'form_start', 'email_open'
  event_target TEXT, -- form_id, document_id, page_url
  event_data JSONB, -- Additional context
  ip_address_hash VARCHAR(64), -- Hashed for GDPR compliance
  user_agent TEXT,
  duration_seconds INTEGER,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- Indexes for performance
  INDEX idx_client_activities_client_supplier (client_id, supplier_id),
  INDEX idx_client_activities_session (session_id),
  INDEX idx_client_activities_event_type (event_type),
  INDEX idx_client_activities_created_at (created_at)
);

-- Activity Sessions table
CREATE TABLE IF NOT EXISTS activity_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id VARCHAR(64) UNIQUE NOT NULL,
  client_id UUID NOT NULL REFERENCES couples(id),
  supplier_id UUID NOT NULL REFERENCES suppliers(id),
  started_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  last_activity_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  ended_at TIMESTAMP WITH TIME ZONE,
  total_duration_seconds INTEGER DEFAULT 0,
  page_views INTEGER DEFAULT 0,
  actions_taken INTEGER DEFAULT 0,
  is_active BOOLEAN DEFAULT TRUE,
  device_type VARCHAR(20), -- 'desktop', 'mobile', 'tablet'
  referrer_source VARCHAR(100)
);

-- Activity Aggregates table (for performance)
CREATE TABLE IF NOT EXISTS activity_aggregates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  client_id UUID NOT NULL,
  supplier_id UUID NOT NULL,
  date DATE NOT NULL,
  session_count INTEGER DEFAULT 0,
  total_time_seconds INTEGER DEFAULT 0,
  page_views INTEGER DEFAULT 0,
  form_interactions INTEGER DEFAULT 0,
  email_opens INTEGER DEFAULT 0,
  document_downloads INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(client_id, supplier_id, date)
);
```

#### API Endpoints Required
```typescript
// POST /api/analytics/activities/track
interface TrackActivityRequest {
  sessionId: string;
  eventType: 'page_view' | 'form_start' | 'form_submit' | 'email_open' | 'download';
  eventTarget?: string;
  eventData?: Record<string, any>;
  duration?: number;
}

// GET /api/analytics/activities/[clientId]
interface GetClientActivitiesResponse {
  success: boolean;
  activities: Array<{
    id: string;
    eventType: string;
    eventTarget?: string;
    timestamp: string;
    duration?: number;
    deviceType: string;
  }>;
  summary: {
    totalSessions: number;
    totalTimeSpent: number;
    lastActivity: string;
    mostViewedPages: string[];
  };
}

// GET /api/analytics/activities/timeline/[supplierId]
interface GetActivityTimelineResponse {
  success: boolean;
  timeline: Array<{
    clientId: string;
    clientName: string;
    activities: Array<{
      timestamp: string;
      eventType: string;
      description: string;
      duration?: number;
    }>;
    engagementScore: number;
  }>;
}
```

#### Integration Points
```typescript
// Service: ActivityEngine
// Dependencies: SessionManager, PrivacyService

class ActivityEngine {
  async trackActivity(
    clientId: string,
    supplierId: string,
    activity: ActivityEvent
  ) {
    // Real-time activity tracking with privacy compliance
    const session = await this.sessionManager.getOrCreateSession(
      activity.sessionId,
      clientId,
      supplierId
    );
    
    // Hash IP for privacy
    const ipHash = await this.hashIP(activity.ipAddress);
    
    await supabase.from('client_activities').insert({
      client_id: clientId,
      supplier_id: supplierId,
      session_id: session.id,
      event_type: activity.eventType,
      event_target: activity.eventTarget,
      event_data: activity.eventData,
      ip_address_hash: ipHash,
      user_agent: activity.userAgent,
      duration_seconds: activity.duration
    });
    
    // Update session metrics
    await this.updateSessionMetrics(session.id, activity);
  }
}
```

### ACCEPTANCE CRITERIA
- [x] Real-time activity tracking with <100ms latency
- [x] GDPR compliant with 90-day data retention
- [x] Session timeout after 30 minutes of inactivity
- [x] Activity aggregation runs hourly for performance
- [x] Privacy: IP addresses hashed, no PII in event data

### ESTIMATED EFFORT
- Team B Backend: 20 hours
- Team D Analytics: 16 hours
- Total: 36 hours