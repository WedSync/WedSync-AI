# TECHNICAL SPECIFICATION: WS-002 - Client Profiles
## Generated by Feature Development Session - 2025-08-21

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding venue coordinator
**I want to:** Access complete client information with all details, history, and documents in one place
**So that:** I can answer any question about a couple's wedding in seconds instead of searching through emails and spreadsheets for 15 minutes

**Real Wedding Scenario:**
A venue coordinator managing 200+ weddings per year gets calls from couples, suppliers, and staff needing information. Currently they search through 5 different systems (email, spreadsheet, calendar, file folders, notes app). With this feature, they open one profile and see everything: contact info, preferences, timeline, documents, notes, and communication history - reducing response time from 15 minutes to 30 seconds.

### SPECIFICATION SOURCE
- **Feature ID:** WS-002
- **Original Spec:** /CORE-SPECIFICATIONS/02-WEDSYNC-SUPPLIER-PLATFORM/03-Client-Management/02-client-profiles.md
- **Current Implementation:** 0% complete
- **Files to Modify:** None - new feature
- **New Files to Create:**
  - /src/app/(dashboard)/clients/[id]/page.tsx
  - /src/components/clients/profile/ClientProfileHeader.tsx
  - /src/components/clients/profile/ClientInfoTabs.tsx
  - /src/components/clients/profile/ClientActivityFeed.tsx
  - /src/components/clients/profile/ClientDocuments.tsx
  - /src/components/clients/profile/ClientNotes.tsx
  - /src/lib/stores/clientProfileStore.ts
  - /src/app/api/clients/[id]/route.ts
  - /src/app/api/clients/[id]/activity/route.ts
  - /src/app/api/clients/[id]/notes/route.ts

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Extended client information
CREATE TABLE IF NOT EXISTS client_profiles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  couple_names TEXT NOT NULL,
  partner1_name TEXT,
  partner1_email TEXT,
  partner1_phone TEXT,
  partner2_name TEXT,
  partner2_email TEXT,
  partner2_phone TEXT,
  pronunciation_notes TEXT,
  wedding_date DATE,
  venue_name TEXT,
  venue_address TEXT,
  guest_count INTEGER,
  package_details JSONB,
  status TEXT CHECK (status IN ('active', 'past', 'upcoming', 'draft')),
  wedme_connection_id UUID,
  wedme_status TEXT CHECK (wedme_status IN ('connected', 'invited', 'not_connected')),
  photo_url TEXT,
  custom_fields JSONB DEFAULT '{}',
  form_responses JSONB DEFAULT '{}',
  core_fields_status JSONB DEFAULT '{}',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  archived_at TIMESTAMP
);

-- Client activity timeline
CREATE TABLE IF NOT EXISTS client_activity (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  client_id UUID REFERENCES client_profiles(id) ON DELETE CASCADE,
  activity_type TEXT NOT NULL,
  title TEXT NOT NULL,
  description TEXT,
  metadata JSONB DEFAULT '{}',
  user_id UUID REFERENCES auth.users(id),
  created_at TIMESTAMP DEFAULT NOW()
);

-- Client notes
CREATE TABLE IF NOT EXISTS client_notes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  client_id UUID REFERENCES client_profiles(id) ON DELETE CASCADE,
  note_text TEXT NOT NULL,
  is_private BOOLEAN DEFAULT true,
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Client documents
CREATE TABLE IF NOT EXISTS client_documents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  client_id UUID REFERENCES client_profiles(id) ON DELETE CASCADE,
  document_name TEXT NOT NULL,
  document_type TEXT,
  file_url TEXT NOT NULL,
  file_size INTEGER,
  uploaded_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMP DEFAULT NOW()
);

-- Audit log for changes
CREATE TABLE IF NOT EXISTS client_audit_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  client_id UUID REFERENCES client_profiles(id) ON DELETE CASCADE,
  field_name TEXT NOT NULL,
  old_value TEXT,
  new_value TEXT,
  changed_by UUID REFERENCES auth.users(id),
  change_source TEXT CHECK (change_source IN ('manual', 'import', 'wedme_sync', 'api')),
  created_at TIMESTAMP DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_client_activity_client_id ON client_activity(client_id);
CREATE INDEX idx_client_notes_client_id ON client_notes(client_id);
CREATE INDEX idx_client_documents_client_id ON client_documents(client_id);
CREATE INDEX idx_client_audit_client_id ON client_audit_log(client_id);
```

#### API Endpoints Required
```typescript
// GET /api/clients/[id]
interface GetClientProfileResponse {
  success: boolean;
  data: {
    id: string;
    coupleNames: string;
    partner1: {
      name: string;
      email: string;
      phone: string;
    };
    partner2: {
      name: string;
      email: string;
      phone: string;
    };
    pronunciationNotes: string | null;
    weddingDate: string;
    weddingCountdown: number; // days
    venue: {
      name: string;
      address: string;
    };
    guestCount: number;
    packageDetails: Record<string, any>;
    status: 'active' | 'past' | 'upcoming' | 'draft';
    wedmeStatus: 'connected' | 'invited' | 'not_connected';
    photoUrl: string | null;
    customFields: Record<string, any>;
    formResponses: Record<string, any>;
    coreFieldsStatus: {
      [fieldName: string]: 'complete' | 'partial' | 'missing';
    };
    lastUpdated: string;
  };
}

// PATCH /api/clients/[id]
interface UpdateClientProfileRequest {
  coupleNames?: string;
  partner1?: Partial<{
    name: string;
    email: string;
    phone: string;
  }>;
  partner2?: Partial<{
    name: string;
    email: string;
    phone: string;
  }>;
  pronunciationNotes?: string;
  weddingDate?: string;
  venue?: Partial<{
    name: string;
    address: string;
  }>;
  guestCount?: number;
  packageDetails?: Record<string, any>;
  customFields?: Record<string, any>;
}

// GET /api/clients/[id]/activity
interface GetActivityFeedResponse {
  success: boolean;
  data: {
    activities: Array<{
      id: string;
      type: string;
      title: string;
      description: string;
      metadata: Record<string, any>;
      createdBy: string;
      createdAt: string;
    }>;
  };
}

// POST /api/clients/[id]/notes
interface CreateNoteRequest {
  noteText: string;
  isPrivate?: boolean;
}

// GET /api/clients/[id]/documents
interface GetDocumentsResponse {
  success: boolean;
  data: {
    documents: Array<{
      id: string;
      name: string;
      type: string;
      fileUrl: string;
      fileSize: number;
      uploadedBy: string;
      createdAt: string;
    }>;
  };
}
```

#### Frontend Components Required
```typescript
// Component: ClientProfileHeader
// Location: /src/components/clients/profile/ClientProfileHeader.tsx

interface ClientProfileHeaderProps {
  client: ClientProfile;
  onPhotoUpload: (file: File) => void;
  onQuickAction: (action: 'email' | 'phone' | 'sms') => void;
}

// Key functionality:
- Display couple photo with upload capability
- Show names with pronunciation helper
- Wedding countdown timer (updates daily)
- Quick contact action buttons
- Status and WedMe connection badges
- Breadcrumb navigation back to list

// Component: ClientInfoTabs
// Location: /src/components/clients/profile/ClientInfoTabs.tsx

interface ClientInfoTabsProps {
  client: ClientProfile;
  activeTab: string;
  onTabChange: (tab: string) => void;
}

// Key functionality:
- Tab navigation (Overview, Details, Timeline, Notes, Documents, Journey, Communications)
- Lazy load tab content on selection
- Tab badge indicators for updates
- Keyboard navigation (arrow keys)
- Mobile: Horizontal scrollable tabs

// Component: ClientActivityFeed
// Location: /src/components/clients/profile/ClientActivityFeed.tsx

interface ClientActivityFeedProps {
  clientId: string;
  activities: Activity[];
  onLoadMore: () => void;
}

// Key functionality:
- Chronological timeline display
- Activity type icons and colors
- Infinite scroll with pagination
- Filter by activity type
- Real-time updates via WebSocket
```

#### Integration Points
```typescript
// Store: clientProfileStore
// Dependencies: zustand, supabase client

interface ClientProfileStore {
  profile: ClientProfile | null;
  loading: boolean;
  activities: Activity[];
  notes: Note[];
  documents: Document[];
  
  fetchProfile: (clientId: string) => Promise<void>;
  updateProfile: (updates: Partial<ClientProfile>) => Promise<void>;
  addNote: (note: CreateNoteRequest) => Promise<void>;
  uploadDocument: (file: File) => Promise<void>;
  trackActivity: (activity: Activity) => void;
}

// Auto-save functionality
const useAutoSave = (data: any, saveFunction: Function) => {
  const debouncedSave = useDebounce(saveFunction, 1000);
  
  useEffect(() => {
    if (data) {
      debouncedSave(data);
    }
  }, [data]);
};
```

### CODE EXAMPLES

#### Example 1: Profile Data Fetching with Relations
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { supabase } from '@/lib/supabase';

export async function fetchClientProfile(clientId: string) {
  // Step 1: Fetch main profile data
  const { data: profile, error: profileError } = await supabase
    .from('client_profiles')
    .select(`
      *,
      client_activity (
        id,
        activity_type,
        title,
        description,
        created_at
      ),
      client_notes (
        id,
        note_text,
        is_private,
        created_at
      ),
      client_documents (
        id,
        document_name,
        file_url,
        created_at
      )
    `)
    .eq('id', clientId)
    .single();
  
  if (profileError) throw profileError;
  
  // Step 2: Calculate wedding countdown
  const weddingDate = new Date(profile.wedding_date);
  const today = new Date();
  const daysUntilWedding = Math.ceil(
    (weddingDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24)
  );
  
  // Step 3: Process core fields status
  const coreFieldsStatus = calculateFieldCompleteness(profile);
  
  return {
    ...profile,
    weddingCountdown: daysUntilWedding,
    coreFieldsStatus
  };
}
```

#### Example 2: Optimistic Updates with Rollback
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { useState } from 'react';
import { useClientProfileStore } from '@/lib/stores/clientProfileStore';

export function useOptimisticUpdate() {
  const [previousState, setPreviousState] = useState(null);
  const { profile, updateProfile } = useClientProfileStore();
  
  const optimisticUpdate = async (updates: Partial<ClientProfile>) => {
    // Step 1: Store current state for rollback
    setPreviousState(profile);
    
    // Step 2: Apply optimistic update
    useClientProfileStore.setState({
      profile: { ...profile, ...updates }
    });
    
    try {
      // Step 3: Perform actual update
      await supabase
        .from('client_profiles')
        .update(updates)
        .eq('id', profile.id);
      
      // Step 4: Log to audit trail
      await supabase
        .from('client_audit_log')
        .insert({
          client_id: profile.id,
          field_name: Object.keys(updates).join(', '),
          old_value: JSON.stringify(previousState),
          new_value: JSON.stringify(updates),
          change_source: 'manual'
        });
        
    } catch (error) {
      // Step 5: Rollback on error
      useClientProfileStore.setState({
        profile: previousState
      });
      throw error;
    }
  };
  
  return { optimisticUpdate };
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for tabs, file upload
- [ ] Playwright: Test tab navigation, form editing
- [x] Filesystem: Access profile components

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/vercel/next.js", "dynamic routes params", 3000);
await mcp__context7__get-library-docs("/supabase/supabase", "storage file upload", 2000);
await mcp__context7__get-library-docs("/radix-ui/primitives", "tabs component", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('ClientProfile', () => {
  it('should load and display client data', () => {
    // Test profile data loading
  });
  
  it('should calculate wedding countdown correctly', () => {
    // Test countdown calculation
  });
  
  it('should handle optimistic updates', () => {
    // Test update with rollback
  });
  
  it('should track changes in audit log', () => {
    // Test audit trail creation
  });
});

describe('ClientActivityFeed', () => {
  it('should display activities chronologically', () => {
    // Test timeline ordering
  });
  
  it('should paginate on scroll', () => {
    // Test infinite scroll
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Client profile editing', async () => {
  await mcp__playwright__browser_navigate({url: '/clients/123'});
  await mcp__playwright__browser_snapshot();
  
  // Edit client name
  await mcp__playwright__browser_click({
    element: 'Edit button',
    ref: '[data-testid="edit-profile"]'
  });
  
  await mcp__playwright__browser_type({
    element: 'Couple names input',
    ref: '[name="coupleNames"]',
    text: 'John & Jane Smith'
  });
  
  // Verify auto-save
  await mcp__playwright__browser_wait_for({time: 2});
  
  // Check audit log updated
  await mcp__playwright__browser_click({
    element: 'Activity tab',
    ref: '[data-testid="tab-activity"]'
  });
});
```

### ACCEPTANCE CRITERIA
- [ ] All 7 tabs load and display correct information
- [ ] Photo upload works with 5MB limit
- [ ] Auto-save triggers after 1 second of inactivity
- [ ] Audit log captures all changes with rollback capability
- [ ] Wedding countdown updates daily
- [ ] Core fields completeness indicators accurate
- [ ] WedMe sync status displays correctly
- [ ] Notes support markdown formatting
- [ ] Documents preview inline for images/PDFs
- [ ] Activity feed updates in real-time

### DEPENDENCIES
- Must complete after: WS-001 (Client List Views)
- Must complete before: WS-006 (Photo Management)
- Shares code with: WS-001 (data models), WS-013 (Journey Canvas)

### ESTIMATED EFFORT
- Team A Frontend: 20 hours
- Team B Backend: 12 hours
- Team C Integration: 0 hours
- Total: 32 hours