# TECHNICAL SPECIFICATION: WS-086 - PWA Configuration
## Generated by Feature Development Session - 2025-08-22

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding photographer working on-site at venues
**I want to:** Access WedSync as an installable app on my phone home screen
**So that:** I can quickly access shot lists and timelines without opening a browser during hectic wedding moments

**Real Wedding Scenario:**
A photographer at an outdoor venue with spotty cellular service needs to access the ceremony timeline while directing group photos. With PWA installed, they can access cached wedding data instantly without waiting for pages to load, ensuring they don't miss the scheduled golden hour shots.

### SPECIFICATION SOURCE
- **Feature ID:** WS-086
- **Original Spec:** /CORE-SPECIFICATIONS/09-MOBILE-OPTIMIZATION/02-pwa-configuration md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** 
  - /wedsync/next.config.js
  - /wedsync/public/manifest.json
  - /wedsync/public/sw.js
  - /wedsync/src/components/InstallPrompt.tsx
- **New Files to Create:** 
  - /wedsync/cache.config.js
  - /wedsync/public/icons/ (multiple icon files)

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Push notification subscriptions
CREATE TABLE push_subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  subscription JSONB NOT NULL,
  device_type TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- PWA installation tracking
CREATE TABLE pwa_installations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  device_fingerprint TEXT,
  platform TEXT,
  installed_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### API Endpoints Required
```typescript
// POST /api/notifications/subscribe
interface PushSubscriptionRequest {
  subscription: PushSubscription;
  userId: string;
}

interface PushSubscriptionResponse {
  success: boolean;
  message: string;
}

// POST /api/pwa/install-track
interface PWAInstallRequest {
  deviceFingerprint: string;
  platform: string;
  userAgent: string;
}
```

#### Frontend Components Required
```typescript
// Component: InstallPrompt
// Location: /src/components/InstallPrompt.tsx

interface InstallPromptProps {
  onInstall?: () => void;
  onDismiss?: () => void;
}

// Key functionality:
- Detect when PWA can be installed
- Show custom install banner for iOS
- Track installation events
- Handle beforeinstallprompt event
```

#### Integration Points
```typescript
// Service: PWAService
// Dependencies: Web Push API, Service Worker Registration

class PWAService {
  async registerServiceWorker() {
    // Register SW with caching strategies
  }
  
  async requestPushPermission() {
    // Handle notification permissions
  }
  
  async trackInstallation() {
    // Track PWA install events
  }
}
```

### CODE EXAMPLES

#### Example 1: Next.js PWA Configuration
```typescript
// next.config.js
const withPWA = require('next-pwa')({
  dest: 'public',
  register: true,
  skipWaiting: true,
  runtimeCaching: require('./cache.config.js'),
  buildExcludes: [/middleware-manifest.json$/],
  disable: process.env.NODE_ENV === 'development',
  reloadOnOnline: true,
  fallbacks: {
    document: '/offline',
    image: '/static/images/fallback.png'
  }
});

module.exports = withPWA({
  reactStrictMode: true,
  swcMinify: true
});
```

#### Example 2: Service Worker Implementation
```typescript
// public/sw.js
import { precacheAndRoute } from 'workbox-precaching';
import { NetworkFirst, CacheFirst } from 'workbox-strategies';
import { registerRoute } from 'workbox-routing';

precacheAndRoute(self.__WB_MANIFEST);

// Cache wedding day data for offline access
registerRoute(
  /^https:\/\/.*\.supabase\.co\/rest\/v1\/weddings.*$/,
  new NetworkFirst({
    cacheName: 'wedding-data-cache',
    plugins: [{
      cacheKeyWillBeUsed: async ({ request }) => {
        return `${request.url}?offline=true`;
      }
    }]
  })
);
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for next-pwa, workbox
- [x] Playwright: Test PWA installation flow
- [x] Filesystem: Access manifest and SW files

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/next-pwa/docs", "configuration", 3000);
await mcp__context7__get-library-docs("/workbox/docs", "caching strategies", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('PWA Configuration', () => {
  it('should register service worker on load', () => {
    // Test SW registration
  });
  
  it('should show install prompt when available', () => {
    // Test install banner
  });
  
  it('should cache wedding day data offline', () => {
    // Test offline functionality
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('PWA Installation Flow', async () => {
  await mcp__playwright__browser_navigate({url: '/dashboard'});
  await mcp__playwright__browser_click({element: 'Install App button', ref: '#install-prompt'});
  await mcp__playwright__browser_snapshot();
  // Verify app installs and works offline
});
```

### ACCEPTANCE CRITERIA
- [x] Web app manifest validates with Google Lighthouse
- [x] Service worker registers and precaches critical routes
- [x] Install prompts appear on supported browsers
- [x] Offline page displays when network unavailable
- [x] Push notifications work for wedding day reminders
- [x] Performance: App shell loads in <2 seconds
- [x] Security: All cached content served over HTTPS
- [x] Accessibility: Install prompt is keyboard accessible

### DEPENDENCIES
- Must complete after: WS-021 (Mobile Responsive Dashboard)
- Must complete before: WS-087 (Touch Optimization)
- Shares code with: Authentication system, Notification service

### ESTIMATED EFFORT
- Team A Frontend: 12 hours
- Team B Backend: 6 hours
- Team C Integration: 4 hours
- Total: 22 hours