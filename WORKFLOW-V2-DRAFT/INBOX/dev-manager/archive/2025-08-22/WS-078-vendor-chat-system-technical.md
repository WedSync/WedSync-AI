# TECHNICAL SPECIFICATION: WS-078 - Vendor Chat System
## Generated by Feature Development Session - August 22, 2025

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding venue coordinator managing 12 vendors for Saturday's wedding
**I want to:** Have one central chat system where all vendors can communicate in real-time
**So that:** Last-minute changes (weather moved ceremony indoors) reach everyone instantly without 30 phone calls

**Real Wedding Scenario:**
A sudden rainstorm requires moving the ceremony indoors. Currently, the venue coordinator calls/texts each vendor individually, taking 45 minutes and missing the DJ who's driving. With vendor chat, they post once in the "Smith Wedding" channel, all vendors get push notifications, acknowledge receipt, and coordinate the change in 5 minutes. The chat history provides a clear record of who was notified and when.

### SPECIFICATION SOURCE
- **Feature ID:** WS-078
- **Original Spec:** Real-time messaging between couples and vendors
- **Current Implementation:** 0% complete
- **Files to Modify:**
  - /wedsync/src/app/(dashboard)/layout.tsx (add chat menu)
- **New Files to Create:**
  - /wedsync/src/app/(dashboard)/messages/page.tsx
  - /wedsync/src/app/(dashboard)/messages/[channelId]/page.tsx
  - /wedsync/src/app/api/chat/channels/route.ts
  - /wedsync/src/app/api/chat/messages/route.ts
  - /wedsync/src/app/api/chat/messages/send/route.ts
  - /wedsync/src/components/chat/ChatInterface.tsx
  - /wedsync/src/components/chat/MessageList.tsx
  - /wedsync/src/components/chat/ChatInput.tsx
  - /wedsync/src/lib/services/chatService.ts
  - /wedsync/src/lib/realtime/chatSubscription.ts

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Chat channels
CREATE TABLE IF NOT EXISTS chat_channels (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  couple_id UUID NOT NULL REFERENCES couples(id),
  channel_name VARCHAR(255) NOT NULL,
  channel_type VARCHAR(50) DEFAULT 'wedding', -- 'wedding', 'vendor_group', 'direct'
  is_active BOOLEAN DEFAULT true,
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Channel participants
CREATE TABLE IF NOT EXISTS channel_participants (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  channel_id UUID NOT NULL REFERENCES chat_channels(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id),
  user_email VARCHAR(255) NOT NULL,
  user_name VARCHAR(255) NOT NULL,
  user_role VARCHAR(50), -- 'couple', 'photographer', 'venue', etc.
  last_read_at TIMESTAMP WITH TIME ZONE,
  notifications_enabled BOOLEAN DEFAULT true,
  joined_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  left_at TIMESTAMP WITH TIME ZONE,
  
  UNIQUE(channel_id, user_email)
);

-- Chat messages
CREATE TABLE IF NOT EXISTS chat_messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  channel_id UUID NOT NULL REFERENCES chat_channels(id) ON DELETE CASCADE,
  sender_id UUID NOT NULL REFERENCES auth.users(id),
  sender_name VARCHAR(255) NOT NULL,
  sender_role VARCHAR(50),
  message_text TEXT,
  message_type VARCHAR(50) DEFAULT 'text', -- 'text', 'image', 'file', 'system'
  attachments JSONB, -- Array of attachment URLs
  is_edited BOOLEAN DEFAULT false,
  edited_at TIMESTAMP WITH TIME ZONE,
  is_deleted BOOLEAN DEFAULT false,
  deleted_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Read receipts
CREATE TABLE IF NOT EXISTS message_read_receipts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  message_id UUID NOT NULL REFERENCES chat_messages(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id),
  read_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  
  UNIQUE(message_id, user_id)
);

-- Enable real-time subscriptions
ALTER TABLE chat_messages REPLICA IDENTITY FULL;
ALTER TABLE message_read_receipts REPLICA IDENTITY FULL;

CREATE INDEX idx_chat_messages_channel ON chat_messages(channel_id);
CREATE INDEX idx_chat_messages_created ON chat_messages(created_at DESC);
CREATE INDEX idx_channel_participants_user ON channel_participants(user_id);
```

#### API Endpoints Required
```typescript
// GET /api/chat/channels - Get user's chat channels
interface GetChannelsResponse {
  channels: {
    id: string;
    name: string;
    type: string;
    unreadCount: number;
    lastMessage?: {
      text: string;
      senderName: string;
      timestamp: string;
    };
    participants: {
      name: string;
      role: string;
      isOnline: boolean;
    }[];
  }[];
}

// POST /api/chat/messages/send - Send message
interface SendMessageRequest {
  channelId: string;
  messageText: string;
  attachments?: Attachment[];
}

// Real-time subscription types
interface RealtimeMessage {
  type: 'message' | 'typing' | 'read_receipt';
  channelId: string;
  data: any;
}
```

#### Frontend Components Required
```typescript
// Component: ChatInterface
// Location: /src/components/chat/ChatInterface.tsx

interface ChatInterfaceProps {
  channelId: string;
  currentUser: User;
}

// Key functionality:
- Real-time message updates via WebSocket
- Typing indicators
- Read receipts display
- File/image uploads
- Message search
- Notification management
- Mobile-responsive design

// Component: MessageList
// Location: /src/components/chat/MessageList.tsx

interface MessageListProps {
  messages: Message[];
  currentUserId: string;
  onLoadMore: () => void;
}

// Key functionality:
- Virtual scrolling for performance
- Auto-scroll to new messages
- Message grouping by sender
- Timestamp display
- Read receipt indicators
- Message actions (edit, delete)
```

### CODE EXAMPLES

#### Example 1: Real-time Chat with Supabase
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { useEffect, useState } from 'react';
import { supabase } from '@/lib/supabase';

export function ChatInterface({ channelId, currentUser }: ChatInterfaceProps) {
  const [messages, setMessages] = useState<Message[]>([]);
  const [typingUsers, setTypingUsers] = useState<string[]>([]);
  
  useEffect(() => {
    // Step 1: Load initial messages
    loadMessages();
    
    // Step 2: Subscribe to real-time updates
    const subscription = supabase
      .channel(`chat:${channelId}`)
      .on('postgres_changes', 
        { 
          event: 'INSERT', 
          schema: 'public', 
          table: 'chat_messages',
          filter: `channel_id=eq.${channelId}`
        }, 
        (payload) => {
          setMessages(prev => [...prev, payload.new as Message]);
          playNotificationSound();
        }
      )
      .on('presence', { event: 'sync' }, () => {
        const state = subscription.presenceState();
        const typing = Object.values(state).filter(u => u[0]?.typing);
        setTypingUsers(typing.map(u => u[0].userName));
      })
      .subscribe();
    
    return () => {
      supabase.removeChannel(subscription);
    };
  }, [channelId]);
  
  const sendMessage = async (text: string) => {
    const { data, error } = await supabase
      .from('chat_messages')
      .insert({
        channel_id: channelId,
        sender_id: currentUser.id,
        sender_name: currentUser.name,
        sender_role: currentUser.role,
        message_text: text
      })
      .select()
      .single();
    
    if (!error) {
      // Message will appear via real-time subscription
      await markChannelAsRead();
    }
  };
  
  const markChannelAsRead = async () => {
    await supabase
      .from('channel_participants')
      .update({ last_read_at: new Date().toISOString() })
      .eq('channel_id', channelId)
      .eq('user_id', currentUser.id);
  };
  
  return (
    <div className="flex flex-col h-full">
      <MessageList messages={messages} currentUserId={currentUser.id} />
      {typingUsers.length > 0 && (
        <div className="px-4 py-2 text-sm text-gray-500">
          {typingUsers.join(', ')} {typingUsers.length === 1 ? 'is' : 'are'} typing...
        </div>
      )}
      <ChatInput onSendMessage={sendMessage} />
    </div>
  );
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [ ] Context7: Load docs for Supabase real-time, WebSocket handling
- [ ] Playwright: Test real-time messaging and notifications
- [ ] Filesystem: Access chat UI templates

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/supabase/realtime-js", "channels presence", 3000);
await mcp__context7__get-library-docs("/socket.io/socket.io-client", "websocket", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('Chat Service', () => {
  it('should handle message delivery correctly', async () => {
    const message = await chatService.sendMessage(mockMessage);
    expect(message.id).toBeTruthy();
    expect(message.delivered).toBe(true);
  });
  
  it('should track read receipts accurately', async () => {
    await chatService.markAsRead('message-123', 'user-456');
    const receipts = await chatService.getReadReceipts('message-123');
    expect(receipts).toContainEqual(expect.objectContaining({ userId: 'user-456' }));
  });
});
```

#### E2E Tests Required
```typescript
test('Real-time chat functionality', async () => {
  await mcp__playwright__browser_navigate({url: '/messages/channel-123'});
  
  // Send message
  await mcp__playwright__browser_type({
    element: "Message input",
    ref: "input[data-testid='chat-input']",
    text: "Ceremony moving indoors due to weather"
  });
  
  await mcp__playwright__browser_press_key({key: "Enter"});
  
  // Verify message appears
  await mcp__playwright__browser_wait_for({text: "Ceremony moving indoors"});
  
  // Check typing indicator
  await mcp__playwright__browser_type({
    element: "Message input",
    ref: "input[data-testid='chat-input']",
    text: "Everyone please",
    slowly: true
  });
  
  // Typing indicator should appear
  await mcp__playwright__browser_wait_for({text: "is typing"});
});
```

### ACCEPTANCE CRITERIA
- [ ] Real-time message delivery with < 500ms latency
- [ ] Push notifications for new messages
- [ ] File and image sharing up to 10MB
- [ ] Message search across all channels
- [ ] Read receipts and typing indicators
- [ ] Performance: Handle 50+ simultaneous users
- [ ] Security: Messages encrypted in transit
- [ ] Accessibility: Screen reader compatible

### DEPENDENCIES
- Must complete after: WS-074/075 (User accounts)
- Must complete before: Vendor collaboration features
- Shares code with: Notification system, real-time updates

### ESTIMATED EFFORT
- Team C Integration: 20 hours (Real-time infrastructure, WebSocket)
- Team B Backend: 16 hours (Message storage, delivery, notifications)
- Total: 36 hours