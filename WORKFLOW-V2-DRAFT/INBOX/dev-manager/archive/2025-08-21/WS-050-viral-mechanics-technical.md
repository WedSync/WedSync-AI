# TECHNICAL SPECIFICATION: WS-050 - Viral Mechanics System
## Generated by Feature Development Session - 2025-08-21

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding photographer who just completed a successful wedding
**I want to:** My clients to automatically invite their 14 other vendors to WedSync
**So that:** I get referrals from peer vendors and couples experience seamless coordination (viral coefficient >1.5)

**Real Wedding Scenario:**
Sarah books photographer Mike through WedSync. Mike invites Sarah to WedMe (couple platform). Sarah loves the free planning tools and invites her venue, caterer, florist, and DJ. Those 4 vendors see real client work happening, join WedSync, and each bring their own couples. Sarah's wedding generates 4 new suppliers and 8 new couples on the platform - viral coefficient of 2.0x.

### SPECIFICATION SOURCE
- **Feature ID:** WS-050
- **Original Spec:** /CORE-SPECIFICATIONS/02-WEDSYNC-SUPPLIER-PLATFORM/08-Growth-Features/05-viral-mechanics md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** None - new feature
- **New Files to Create:**
  - `/src/components/viral/InvitationManager.tsx`
  - `/src/components/viral/ViralDashboard.tsx`
  - `/src/app/api/viral/invites/route.ts`
  - `/src/app/api/viral/track/route.ts`
  - `/src/lib/viral/viral-engine.ts`
  - `/src/lib/viral/k-factor-calculator.ts`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Viral Invitations table
CREATE TABLE IF NOT EXISTS viral_invitations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  inviter_id UUID NOT NULL, -- Can be supplier_id or couple_id
  inviter_type VARCHAR(20) NOT NULL CHECK (inviter_type IN ('supplier', 'couple')),
  invitee_email VARCHAR(255) NOT NULL,
  invitee_name VARCHAR(100),
  invitation_type VARCHAR(20) NOT NULL CHECK (invitation_type IN ('supplier_to_couple', 'couple_to_supplier', 'supplier_to_supplier')),
  invitation_context VARCHAR(50), -- 'contract_signing', 'form_distribution', 'payment_milestone'
  invitation_token VARCHAR(64) UNIQUE NOT NULL,
  message_template_id UUID,
  custom_message TEXT,
  sent_at TIMESTAMP WITH TIME ZONE,
  opened_at TIMESTAMP WITH TIME ZONE,
  clicked_at TIMESTAMP WITH TIME ZONE,
  converted_at TIMESTAMP WITH TIME ZONE,
  status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'sent', 'opened', 'clicked', 'converted', 'expired')),
  incentive_type VARCHAR(20), -- 'feature_unlock', 'early_access', 'discount'
  incentive_value JSONB,
  expires_at TIMESTAMP WITH TIME ZONE DEFAULT (NOW() + INTERVAL '30 days'),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Viral Loops table
CREATE TABLE IF NOT EXISTS viral_loops (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  loop_type VARCHAR(30) NOT NULL, -- 'supplier_to_couple', 'couple_to_supplier_team'
  trigger_event VARCHAR(50) NOT NULL, -- 'contract_signed', 'wedding_completed'
  original_inviter_id UUID NOT NULL,
  original_inviter_type VARCHAR(20) NOT NULL,
  generation INTEGER DEFAULT 1, -- How many degrees of separation
  total_invitations INTEGER DEFAULT 0,
  total_conversions INTEGER DEFAULT 0,
  k_factor DECIMAL(4,2) DEFAULT 0, -- Viral coefficient
  revenue_generated DECIMAL(10,2) DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Viral Incentives table
CREATE TABLE IF NOT EXISTS viral_incentives (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL,
  user_type VARCHAR(20) NOT NULL,
  incentive_type VARCHAR(30) NOT NULL,
  required_invites INTEGER DEFAULT 1,
  completed_invites INTEGER DEFAULT 0,
  reward_unlocked BOOLEAN DEFAULT FALSE,
  reward_data JSONB, -- Feature access, credits, etc.
  expires_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Network Effects table  
CREATE TABLE IF NOT EXISTS network_effects (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL,
  user_type VARCHAR(20) NOT NULL,
  network_size INTEGER DEFAULT 0, -- Connected suppliers/couples
  collaboration_score DECIMAL(3,1) DEFAULT 0,
  referral_quality_score DECIMAL(3,1) DEFAULT 0,
  preferred_vendor_status BOOLEAN DEFAULT FALSE,
  last_calculated TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Viral Analytics table
CREATE TABLE IF NOT EXISTS viral_analytics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  date DATE NOT NULL,
  total_invitations_sent INTEGER DEFAULT 0,
  total_conversions INTEGER DEFAULT 0,
  daily_k_factor DECIMAL(4,2) DEFAULT 0,
  new_suppliers_from_viral INTEGER DEFAULT 0,
  new_couples_from_viral INTEGER DEFAULT 0,
  revenue_from_viral DECIMAL(10,2) DEFAULT 0,
  top_viral_triggers JSONB, -- Which events drive most invitations
  super_spreaders JSONB, -- Users generating most viral growth
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(date)
);
```

#### API Endpoints Required
```typescript
// POST /api/viral/invites/send
interface SendViralInviteRequest {
  inviteeEmail: string;
  inviteeName?: string;
  invitationType: 'supplier_to_couple' | 'couple_to_supplier' | 'supplier_to_supplier';
  context: 'contract_signing' | 'form_distribution' | 'payment_milestone' | 'wedding_completed';
  customMessage?: string;
  incentiveType?: 'feature_unlock' | 'early_access' | 'discount';
}

// GET /api/viral/invites/[userId]
interface GetViralInvitesResponse {
  success: boolean;
  invitations: Array<{
    id: string;
    inviteeEmail: string;
    status: string;
    sentAt: string;
    incentiveOffered?: string;
  }>;
  metrics: {
    totalSent: number;
    conversionRate: number;
    personalKFactor: number;
  };
}

// POST /api/viral/track/[token]
interface TrackViralActionRequest {
  action: 'opened' | 'clicked' | 'converted';
  metadata?: {
    userAgent: string;
    referrer: string;
  };
}

// GET /api/viral/incentives/[userId]
interface GetViralIncentivesResponse {
  success: boolean;
  activeIncentives: Array<{
    id: string;
    type: string;
    requiredInvites: number;
    completedInvites: number;
    progress: number;
    reward: object;
  }>;
  unlockedRewards: object[];
}

// GET /api/viral/network/[userId]
interface GetNetworkEffectsResponse {
  success: boolean;
  networkStats: {
    connectedSuppliers: number;
    connectedCouples: number;
    collaborationScore: number;
    preferredVendorStatus: boolean;
    qualityRating: string;
  };
  collaborationOpportunities: Array<{
    supplierId: string;
    businessName: string;
    mutualConnections: number;
    collaborationPotential: number;
  }>;
}

// GET /api/viral/analytics/platform
interface GetViralAnalyticsResponse {
  success: boolean;
  platformMetrics: {
    overallKFactor: number;
    monthlyGrowthRate: number;
    viralRevenue: number;
    topGrowthTriggers: Array<{
      trigger: string;
      invitations: number;
      conversions: number;
    }>;
    superSpreaders: Array<{
      userId: string;
      name: string;
      invitationsSent: number;
      conversions: number;
      personalKFactor: number;
    }>;
  };
}
```

#### Integration Points
```typescript
// Service: ViralEngine
// Dependencies: EmailService, IncentiveService, NetworkService

class ViralEngine {
  async triggerViralInvitation(
    inviterId: string, 
    context: string, 
    suggestedInvitees?: string[]
  ) {
    // Auto-suggest invitations based on context and user behavior
  }
  
  async processInvitationConversion(token: string, newUserId: string) {
    // Handle successful viral conversion and reward attribution
  }
  
  async calculateKFactor(userId: string, timeframe: number = 30): Promise<number> {
    // Calculate viral coefficient for individual users
  }
  
  async identifySuperSpreaders(): Promise<User[]> {
    // Find users generating exceptional viral growth
  }
}

// Service: IncentiveManager
// Dependencies: FeatureToggleService, RewardService

class IncentiveManager {
  async createIncentiveProgram(
    userType: 'supplier' | 'couple',
    incentiveType: string,
    requirements: object
  ) {
    // Create viral incentive programs
  }
  
  async checkIncentiveProgress(userId: string) {
    // Monitor progress toward viral rewards
  }
  
  async unlockIncentiveReward(userId: string, incentiveId: string) {
    // Grant viral rewards (features, credits, early access)
  }
}

// Service: NetworkEffectsCalculator
// Dependencies: CollaborationService, QualityService

class NetworkEffectsCalculator {
  async calculateNetworkValue(userId: string): Promise<NetworkMetrics> {
    // Measure network effects and collaboration potential
  }
  
  async updateCollaborationScores() {
    // Update supplier collaboration and quality scores
  }
  
  async identifyPreferredVendors(location: string, category: string) {
    // Identify suppliers with strong network effects
  }
}
```

### CODE EXAMPLES

#### Example 1: Viral Loop Tracking
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { supabase } from '@/lib/supabase';

export async function processViralConversion(token: string, newUserId: string, userType: 'supplier' | 'couple') {
  // Step 1: Find and validate invitation
  const { data: invitation } = await supabase
    .from('viral_invitations')
    .select(`
      *,
      viral_loops(*)
    `)
    .eq('invitation_token', token)
    .eq('status', 'clicked')
    .single();
    
  if (!invitation) throw new Error('Invalid or expired invitation');
  
  // Step 2: Mark invitation as converted
  await supabase
    .from('viral_invitations')
    .update({
      status: 'converted',
      converted_at: new Date().toISOString()
    })
    .eq('id', invitation.id);
  
  // Step 3: Update viral loop metrics
  const currentLoop = invitation.viral_loops;
  const newInvitations = await countExpectedInvitations(userType);
  const updatedKFactor = (currentLoop.total_conversions + 1) * newInvitations / currentLoop.total_invitations;
  
  await supabase
    .from('viral_loops')
    .update({
      total_conversions: currentLoop.total_conversions + 1,
      k_factor: updatedKFactor,
      updated_at: new Date().toISOString()
    })
    .eq('id', currentLoop.id);
  
  // Step 4: Check for incentive unlock
  await checkViralIncentives(invitation.inviter_id, invitation.inviter_type);
  
  // Step 5: Create next generation viral loop
  if (userType === 'supplier') {
    await createSupplierViralLoop(newUserId, invitation.inviter_id, currentLoop.generation + 1);
  } else {
    await createCoupleViralLoop(newUserId, invitation.inviter_id, currentLoop.generation + 1);
  }
  
  // Step 6: Update daily analytics
  await updateViralAnalytics(new Date(), {
    new_conversions: 1,
    new_suppliers: userType === 'supplier' ? 1 : 0,
    new_couples: userType === 'couple' ? 1 : 0
  });
  
  // Step 7: Trigger welcome sequence with viral prompts
  await scheduleViralWelcomeSequence(newUserId, userType, invitation.inviter_id);
  
  return {
    success: true,
    viralGeneration: currentLoop.generation + 1,
    kFactorContribution: updatedKFactor,
    incentivesUnlocked: await getUnlockedIncentives(invitation.inviter_id)
  };
}

async function countExpectedInvitations(userType: 'supplier' | 'couple'): Promise<number> {
  // Expected viral invitations based on user type
  return userType === 'supplier' ? 12 : 14; // Supplier invites couples, couple invites 14 vendors
}

async function checkViralIncentives(userId: string, userType: string) {
  const { data: incentives } = await supabase
    .from('viral_incentives')
    .select('*')
    .eq('user_id', userId)
    .eq('user_type', userType)
    .eq('reward_unlocked', false);
  
  for (const incentive of incentives || []) {
    const { count } = await supabase
      .from('viral_invitations')
      .select('id', { count: 'exact' })
      .eq('inviter_id', userId)
      .eq('status', 'converted');
    
    if ((count || 0) >= incentive.required_invites) {
      await supabase
        .from('viral_incentives')
        .update({
          reward_unlocked: true,
          completed_invites: count
        })
        .eq('id', incentive.id);
      
      // Grant reward
      await grantViralReward(userId, incentive.reward_data);
    }
  }
}
```

### ACCEPTANCE CRITERIA
- [x] Viral coefficient >1.5 achieved within 90 days of feature launch
- [x] Supplier-to-couple invitations have >70% activation rate
- [x] Couple-to-supplier invitations have >30% conversion rate  
- [x] System tracks viral loops through 5+ generations accurately
- [x] Incentive programs unlock features for achieving invite milestones
- [x] Performance: Viral tracking APIs respond in <300ms, real-time updates
- [x] Security: Invitation tokens expire after 30 days, rate limiting prevents abuse
- [x] Analytics: Daily K-factor calculation with 99.9% accuracy

### DEPENDENCIES
- Must complete after: Referral Programs System (WS-046) - builds on referral foundation
- Must complete before: Platform launch - viral mechanics drive user acquisition
- Shares code with: Email system, User onboarding, Analytics dashboard

### ESTIMATED EFFORT
- Team A Frontend: 20 hours
- Team B Backend: 36 hours
- Team C Integration: 16 hours
- Total: 72 hours