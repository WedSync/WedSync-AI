# TECHNICAL SPECIFICATION: WS-166 - Budget Reports & Export System
## Generated by Dev Manager - January 20, 2025

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding couple managing their wedding budget
**I want to:** Generate and download comprehensive budget reports in PDF, CSV, or Excel formats with customizable filters
**So that:** I can share financial summaries with family, track spending against goals, and have professional documentation for records

### REAL WEDDING PROBLEM THIS SOLVES:
**Wedding Scenario:** Sarah and Mike are 3 months before their wedding. Sarah's parents are contributing $15,000 and want a detailed report showing how their money is being allocated across vendors. Mike needs to provide his work's HR department with expense documentation for their wedding day off benefits. They also want to export their complete payment schedule to share with their financial advisor for cash flow planning.

### SPECIFICATION SOURCE
- **Feature ID:** WS-166
- **Original Spec:** /CORE-SPECIFICATIONS/03-WEDME-COUPLE-PLATFORM/08-Budget-Tracker/04-reports-export md.md

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Budget export tracking
CREATE TABLE IF NOT EXISTS budget_exports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  couple_id UUID REFERENCES couples(id),
  export_type VARCHAR(20) CHECK (export_type IN ('pdf', 'csv', 'excel')) NOT NULL,
  export_filters JSONB NOT NULL DEFAULT '{}',
  file_name VARCHAR(255) NOT NULL,
  file_url TEXT,
  file_size_bytes INTEGER,
  generated_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ,
  download_count INTEGER DEFAULT 0,
  status VARCHAR(20) CHECK (status IN ('generating', 'completed', 'failed', 'expired')) DEFAULT 'generating',
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Export generation queue for async processing
CREATE TABLE IF NOT EXISTS export_queue (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  export_id UUID REFERENCES budget_exports(id) ON DELETE CASCADE,
  priority INTEGER DEFAULT 1,
  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  error_message TEXT,
  retry_count INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_budget_exports_couple_id ON budget_exports(couple_id);
CREATE INDEX IF NOT EXISTS idx_budget_exports_status ON budget_exports(status);
CREATE INDEX IF NOT EXISTS idx_export_queue_priority ON export_queue(priority DESC, created_at ASC);
```

### API ENDPOINTS REQUIRED

```typescript
// POST /api/wedme/budget/export
interface ExportRequest {
  format: 'pdf' | 'csv' | 'excel';
  filters: {
    categories?: string[];
    date_range?: { start: string; end: string };
    payment_status?: 'paid' | 'pending' | 'planned' | 'all';
    include_notes?: boolean;
  };
  options: {
    include_charts?: boolean;
    include_timeline?: boolean;
    email_delivery?: boolean;
  };
}

// GET /api/wedme/budget/export/[exportId]
// Returns file stream or download URL

// GET /api/wedme/budget/export-history
// Returns list of previous exports for couple
```

### CODE EXAMPLES

```typescript
export function BudgetExportDialog({ coupleId, isOpen, onClose }: Props) {
  const [exportFormat, setExportFormat] = useState<'pdf' | 'csv' | 'excel'>('pdf');
  const [filters, setFilters] = useState<ExportFilters>({});
  const [isGenerating, setIsGenerating] = useState(false);

  const handleExport = async () => {
    setIsGenerating(true);
    try {
      const response = await fetch('/api/wedme/budget/export', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          format: exportFormat,
          filters,
          options: {
            include_charts: exportFormat === 'pdf',
            include_timeline: true,
            email_delivery: false
          }
        })
      });

      const { exportId, status } = await response.json();
      
      if (status === 'completed') {
        // Direct download
        window.location.href = `/api/wedme/budget/export/${exportId}`;
      } else {
        // Poll for completion
        pollExportStatus(exportId);
      }
    } catch (error) {
      toast.error('Export failed. Please try again.');
    } finally {
      setIsGenerating(false);
    }
  };

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Export Budget Report</DialogTitle>
          <DialogDescription>
            Generate a comprehensive report of your wedding budget
          </DialogDescription>
        </DialogHeader>
        
        <div className="space-y-4">
          <div>
            <Label>Export Format</Label>
            <Select value={exportFormat} onValueChange={setExportFormat}>
              <SelectTrigger>
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="pdf">PDF - Professional Report</SelectItem>
                <SelectItem value="excel">Excel - Detailed Spreadsheet</SelectItem>
                <SelectItem value="csv">CSV - Data Only</SelectItem>
              </SelectContent>
            </Select>
          </div>

          {/* Filter options */}
          <ExportFilters filters={filters} onChange={setFilters} />
          
          <Button 
            onClick={handleExport} 
            disabled={isGenerating}
            className="w-full"
          >
            {isGenerating ? 'Generating...' : `Generate ${exportFormat.toUpperCase()}`}
          </Button>
        </div>
      </DialogContent>
    </Dialog>
  );
}

// PDF Generation Service
export class BudgetPDFGenerator {
  static async generatePDF(coupleId: string, budgetData: BudgetData, options: PDFOptions) {
    const doc = (
      <Document>
        <Page size="A4" style={styles.page}>
          <View style={styles.header}>
            <Text style={styles.title}>Wedding Budget Report</Text>
            <Text style={styles.subtitle}>
              {budgetData.couple_names} â€¢ {format(new Date(), 'MMMM d, yyyy')}
            </Text>
          </View>

          {/* Budget Summary */}
          <View style={styles.section}>
            <Text style={styles.sectionTitle}>Budget Summary</Text>
            <View style={styles.summaryGrid}>
              <BudgetSummaryItem label="Total Budget" value={budgetData.total_budget} />
              <BudgetSummaryItem label="Amount Spent" value={budgetData.amount_spent} />
              <BudgetSummaryItem label="Remaining" value={budgetData.remaining} />
            </View>
          </View>

          {/* Category Breakdown Chart */}
          {options.include_charts && (
            <View style={styles.section}>
              <Text style={styles.sectionTitle}>Spending by Category</Text>
              <Image src={await this.generateChartImage(budgetData.categories)} />
            </View>
          )}

          {/* Payment Timeline */}
          {options.include_timeline && (
            <PaymentTimelineTable payments={budgetData.payments} />
          )}

          {/* Vendor Details Table */}
          <VendorPaymentTable vendors={budgetData.vendors} />
        </Page>
      </Document>
    );

    return await pdf(doc).toBuffer();
  }
}
```

### ACCEPTANCE CRITERIA
- [x] Generate PDF reports with charts and professional formatting
- [x] Export to CSV with customizable columns and data filtering
- [x] Create Excel files with multiple sheets (Summary, Details, Schedule)
- [x] Filter exports by categories, date ranges, and payment status
- [x] Queue system for large export processing
- [x] File caching and expiration management (24-hour retention)
- [x] Export history tracking for couples
- [x] Email delivery option for large files
- [x] Mobile-responsive export interface
- [x] Progress indicators during generation

### DEPENDENCIES
- Must complete after: WS-165 (Payment Calendar)
- Requires: WS-163 (Budget Categories) and WS-164 (Manual Budget Tracking)
- Estimated Effort: 48 hours total

### TECHNICAL CONSIDERATIONS
- Use React-PDF for client-side PDF generation
- Implement Supabase Edge Function for server-side processing
- Add Redis caching for export file storage
- Use streaming for large file downloads
- Implement queue system with retry logic for failed exports