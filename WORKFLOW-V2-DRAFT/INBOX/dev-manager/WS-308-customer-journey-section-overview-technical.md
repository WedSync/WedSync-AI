# TECHNICAL SPECIFICATION: WS-308 - Customer Journey Section Overview
## Generated by Feature Development Session - 2025-01-20

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding photographer who manually sends 15 different emails at various stages of each wedding project
**I want to:** Create visual workflows that automatically send the right information at the right time based on wedding dates, form completions, and client actions
**So that:** I can eliminate 4+ hours per wedding spent on repetitive communication while ensuring no couple misses important milestones or deadlines

**Real Wedding Scenario:**
"A wedding photographer currently maintains a spreadsheet to track what stage each couple is at (booked, engagement shoot done, timeline received, final payment, etc.) and manually sends different emails for each milestone. With customer journeys, a visual workflow automatically triggers the right emails, forms, and reminders based on wedding date proximity and client responses, reducing manual work from hours to minutes per couple."

### SPECIFICATION SOURCE
- **Feature ID:** WS-308
- **Original Spec:** /CORE-SPECIFICATIONS/02-WEDSYNC-SUPPLIER-PLATFORM/05-Customer-Journey.md
- **Current Implementation:** 30% complete (basic journey structure exists)
- **Files to Modify:**
  - /wedsync/src/app/(dashboard)/journeys/page.tsx
  - /wedsync/src/lib/journey-engine/startup.ts
- **New Files to Create:**
  - /wedsync/src/components/journeys/JourneySystemLayout.tsx
  - /wedsync/src/components/journeys/JourneyOverview.tsx
  - /wedsync/src/lib/services/journey-system-service.ts
  - /wedsync/src/hooks/useJourneySystem.ts

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Journey definitions table
CREATE TABLE IF NOT EXISTS journeys (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID NOT NULL REFERENCES user_profiles(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  trigger_event VARCHAR(100) NOT NULL, -- 'client_added', 'form_submitted', 'date_based'
  is_active BOOLEAN DEFAULT TRUE,
  is_template BOOLEAN DEFAULT FALSE,
  journey_data JSONB NOT NULL DEFAULT '{}', -- Flow chart structure
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Journey instances (active executions)
CREATE TABLE IF NOT EXISTS journey_instances (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  journey_id UUID NOT NULL REFERENCES journeys(id) ON DELETE CASCADE,
  client_id UUID NOT NULL REFERENCES clients(id) ON DELETE CASCADE,
  current_step VARCHAR(100),
  status VARCHAR(50) DEFAULT 'active', -- 'active', 'paused', 'completed', 'failed'
  step_data JSONB DEFAULT '{}',
  started_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ,
  UNIQUE(journey_id, client_id)
);

-- Journey step executions
CREATE TABLE IF NOT EXISTS journey_step_executions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  instance_id UUID NOT NULL REFERENCES journey_instances(id) ON DELETE CASCADE,
  step_id VARCHAR(100) NOT NULL,
  step_type VARCHAR(50) NOT NULL, -- 'email', 'form', 'wait', 'condition', 'task'
  status VARCHAR(50) DEFAULT 'pending', -- 'pending', 'running', 'completed', 'failed', 'skipped'
  executed_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ,
  result_data JSONB DEFAULT '{}',
  error_message TEXT
);
```

#### API Endpoints Required
```typescript
// GET /api/journeys/system/overview
interface JourneySystemOverview {
  total_journeys: number;
  active_journeys: number;
  total_instances: number;
  success_rate: number;
  recent_executions: JourneyExecution[];
}

// GET /api/journeys/templates
interface JourneyTemplate {
  id: string;
  name: string;
  description: string;
  vendor_type: string;
  preview_image: string;
  estimated_duration: string; // "6 months", "12 weeks"
  step_count: number;
}

// POST /api/journeys/create-from-template
interface CreateFromTemplateRequest {
  template_id: string;
  name: string;
  customizations?: Record<string, any>;
}
```

#### Frontend Components Required
```typescript
// Component: JourneySystemLayout
// Location: /src/components/journeys/JourneySystemLayout.tsx

interface JourneySystemLayoutProps {
  children: React.ReactNode;
  currentSection: 'overview' | 'builder' | 'templates' | 'instances' | 'analytics';
}

// Key functionality:
- Navigation between journey management sections
- Quick access to create new journey or use template
- System health indicators (active instances, success rates)
- Journey performance metrics

// Component: JourneyOverview
// Location: /src/components/journeys/JourneyOverview.tsx

interface JourneyOverviewProps {
  overview: JourneySystemOverview;
  recentJourneys: Journey[];
  loading?: boolean;
}

// Key functionality:
- Display journey system statistics
- Show recently created or modified journeys
- Quick access to journey templates
- Active instances monitoring
- Performance trends visualization
```

#### Integration Points
```typescript
// Service: JourneySystemService
// Dependencies: JourneyEngine, EmailService, FormService, TaskService

class JourneySystemService {
  async getSystemOverview(supplierId: string): Promise<JourneySystemOverview> {
    // Aggregate journey statistics and performance metrics
  }
  
  async getJourneyTemplates(vendorType?: string): Promise<JourneyTemplate[]> {
    // Load available journey templates, optionally filtered by vendor type
  }
  
  async createFromTemplate(templateId: string, customizations: any): Promise<string> {
    // Create new journey from template with customizations
  }
  
  async getActiveInstances(supplierId: string): Promise<JourneyInstance[]> {
    // Get all active journey instances for monitoring
  }
  
  async pauseJourney(instanceId: string): Promise<void> {
    // Pause a running journey instance
  }
  
  async resumeJourney(instanceId: string): Promise<void> {
    // Resume a paused journey instance
  }
}
```

### CODE EXAMPLES

#### Example 1: Journey System Hook Implementation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabase';
import { useToast } from '@/components/ui/use-toast';

export function useJourneySystem(supplierId: string) {
  const [overview, setOverview] = useState<JourneySystemOverview | null>(null);
  const [journeys, setJourneys] = useState<Journey[]>([]);
  const [templates, setTemplates] = useState<JourneyTemplate[]>([]);
  const [activeInstances, setActiveInstances] = useState<JourneyInstance[]>([]);
  const [loading, setLoading] = useState(true);
  const { toast } = useToast();

  useEffect(() => {
    loadJourneySystemData();
  }, [supplierId]);

  async function loadJourneySystemData() {
    try {
      setLoading(true);
      
      // Load system overview
      const { data: overviewData } = await supabase
        .rpc('get_journey_system_overview', { supplier_id: supplierId });
      
      // Load user journeys
      const { data: journeysData } = await supabase
        .from('journeys')
        .select(`
          id, name, description, is_active, is_template, created_at,
          journey_instances(count)
        `)
        .eq('supplier_id', supplierId)
        .eq('is_template', false)
        .order('updated_at', { ascending: false });
      
      // Load journey templates
      const { data: templatesData } = await supabase
        .from('journeys')
        .select('id, name, description, journey_data')
        .eq('is_template', true)
        .eq('is_active', true);
      
      // Load active instances
      const { data: instancesData } = await supabase
        .from('journey_instances')
        .select(`
          id, journey_id, client_id, current_step, status, started_at,
          journeys(name),
          clients(couple_name)
        `)
        .eq('status', 'active')
        .in('journey_id', journeysData?.map(j => j.id) || []);
        
      setOverview(overviewData);
      setJourneys(journeysData || []);
      setTemplates(templatesData || []);
      setActiveInstances(instancesData || []);
      
    } catch (error) {
      toast({
        title: "Error loading journey system",
        description: "Please try refreshing the page",
        variant: "destructive"
      });
    } finally {
      setLoading(false);
    }
  }

  async function createFromTemplate(templateId: string, name: string) {
    try {
      // Get template data
      const { data: template } = await supabase
        .from('journeys')
        .select('journey_data, description')
        .eq('id', templateId)
        .single();

      if (!template) throw new Error('Template not found');

      // Create new journey from template
      const { data: newJourney, error } = await supabase
        .from('journeys')
        .insert({
          supplier_id: supplierId,
          name,
          description: template.description,
          journey_data: template.journey_data,
          trigger_event: 'manual', // Default trigger
          is_active: true,
          is_template: false
        })
        .select()
        .single();

      if (!error && newJourney) {
        setJourneys(prev => [newJourney, ...prev]);
        toast({
          title: "Journey created",
          description: `"${name}" has been created from template`
        });
        return newJourney.id;
      }
    } catch (error) {
      toast({
        title: "Error creating journey",
        description: "Failed to create journey from template",
        variant: "destructive"
      });
      throw error;
    }
  }

  async function pauseJourneyInstance(instanceId: string) {
    try {
      const { error } = await supabase
        .from('journey_instances')
        .update({ status: 'paused' })
        .eq('id', instanceId);

      if (!error) {
        setActiveInstances(prev =>
          prev.map(instance =>
            instance.id === instanceId
              ? { ...instance, status: 'paused' }
              : instance
          )
        );
        
        toast({
          title: "Journey paused",
          description: "The journey instance has been paused"
        });
      }
    } catch (error) {
      toast({
        title: "Error pausing journey",
        variant: "destructive"
      });
    }
  }

  return {
    overview,
    journeys,
    templates,
    activeInstances,
    loading,
    createFromTemplate,
    pauseJourneyInstance,
    refresh: loadJourneySystemData
  };
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for workflow engines, React Flow
- [ ] Playwright: Test journey creation workflow
- [ ] Filesystem: Access journey template files

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/xyflow/xyflow", "react flow workflow", 2500);
await mcp__context7__get-library-docs("/supabase/supabase", "realtime subscriptions", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('JourneySystemService', () => {
  it('should load system overview with correct statistics', async () => {
    const service = new JourneySystemService();
    const overview = await service.getSystemOverview('supplier-123');
    
    expect(overview.total_journeys).toBeGreaterThanOrEqual(0);
    expect(overview.success_rate).toBeGreaterThanOrEqual(0);
    expect(overview.success_rate).toBeLessThanOrEqual(100);
  });

  it('should create journey from template', async () => {
    const service = new JourneySystemService();
    const journeyId = await service.createFromTemplate('template-123', {
      name: 'Photography Workflow',
      customizations: { email_sender: 'photographer@example.com' }
    });
    
    expect(journeyId).toBeDefined();
  });

  it('should pause and resume journey instances', async () => {
    const service = new JourneySystemService();
    await service.pauseJourney('instance-123');
    
    const instance = await service.getJourneyInstance('instance-123');
    expect(instance.status).toBe('paused');
    
    await service.resumeJourney('instance-123');
    const resumedInstance = await service.getJourneyInstance('instance-123');
    expect(resumedInstance.status).toBe('active');
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Journey system overview and template creation', async () => {
  await mcp__playwright__browser_navigate({url: '/journeys'});
  await mcp__playwright__browser_snapshot();
  
  // Test creating journey from template
  await mcp__playwright__browser_click({
    element: "Use template button",
    ref: "[data-testid='use-template-btn']"
  });
  
  // Fill journey name
  await mcp__playwright__browser_type({
    element: "Journey name input",
    ref: "[data-testid='journey-name']",
    text: "Photography Client Workflow"
  });
  
  // Save journey
  await mcp__playwright__browser_click({
    element: "Create journey button",
    ref: "[data-testid='create-journey']"
  });
  
  await mcp__playwright__browser_snapshot();
});
```

### ACCEPTANCE CRITERIA
- [ ] Journey system overview displays accurate statistics (total journeys, active instances, success rates)
- [ ] Journey templates are categorized by vendor type (photographer, venue, caterer, etc.)
- [ ] Users can create new journeys from templates with customization options
- [ ] Active journey instances can be monitored in real-time
- [ ] Journey instances can be paused and resumed
- [ ] Performance: Overview page loads in under 2 seconds with 100+ journey instances
- [ ] Security: Journey data is isolated per supplier
- [ ] Accessibility: Journey system interface is keyboard navigable

### DEPENDENCIES
- Must complete after: WS-307 (Field Types for form integration)
- Must complete before: WS-309 (Journey Module Types implementation)
- Shares code with: Journey engine, email service, form system, task management

### ESTIMATED EFFORT
- Team A Frontend: 20 hours
- Team B Backend: 16 hours
- Team C Integration: 8 hours
- Team D Platform: 4 hours
- Team E General: 4 hours
- Team F Workflows: 12 hours
- Team G Performance: 4 hours
- Total: 68 hours