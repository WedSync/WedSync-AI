# TECHNICAL SPECIFICATION: WS-037 - Main Dashboard Layout
## Generated by Feature Development Session - 2025-08-21

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Busy wedding planner checking WedSync first thing each morning
**I want to:** See my most urgent tasks, upcoming weddings, and key metrics immediately upon login
**So that:** I can prioritize my day without hunting through multiple screens or losing track of time-sensitive client needs

**Real Wedding Scenario:**
A wedding planner logs in Monday morning and immediately sees: "3 weddings this weekend need final headcount confirmation", "Sarah & Mike's timeline review overdue by 2 days", and "5 new form responses from couples". The dashboard highlights what needs attention NOW versus what can wait, preventing forgotten deadlines that damage client relationships.

### SPECIFICATION SOURCE
- **Feature ID:** WS-037
- **Original Spec:** /CORE-SPECIFICATIONS/02-WEDSYNC-SUPPLIER-PLATFORM/02-Dashboard/01-main-dashboard-layout md.md
- **Current Implementation:** 0% complete
- **Files to Modify:**
  - `/src/app/(dashboard)/page.tsx` (new)
  - `/src/components/dashboard/Dashboard.tsx` (new)
- **New Files to Create:**
  - `/src/components/dashboard/QuickActionsBar.tsx`
  - `/src/components/dashboard/TodaysFocusWidget.tsx`
  - `/src/components/dashboard/ActivityFeed.tsx`
  - `/src/components/dashboard/PerformanceSnapshot.tsx`
  - `/src/components/dashboard/CommandBar.tsx`
  - `/src/lib/stores/dashboardStore.ts`
  - `/src/lib/hooks/useDashboardData.ts`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Dashboard widget preferences
CREATE TABLE IF NOT EXISTS dashboard_preferences (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID REFERENCES suppliers(id) ON DELETE CASCADE,
  widget_id TEXT NOT NULL,
  position INTEGER NOT NULL,
  size TEXT CHECK (size IN ('small', 'medium', 'large')) DEFAULT 'medium',
  visible BOOLEAN DEFAULT true,
  settings JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(supplier_id, widget_id)
);

-- Quick actions usage tracking for personalization
CREATE TABLE IF NOT EXISTS quick_action_usage (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID REFERENCES suppliers(id) ON DELETE CASCADE,
  action_id TEXT NOT NULL,
  usage_count INTEGER DEFAULT 1,
  last_used_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(supplier_id, action_id)
);

-- Dashboard metrics cache for performance
CREATE TABLE IF NOT EXISTS dashboard_metrics_cache (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID REFERENCES suppliers(id) ON DELETE CASCADE,
  metric_type TEXT NOT NULL,
  metric_value JSONB NOT NULL,
  calculated_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ NOT NULL,
  UNIQUE(supplier_id, metric_type)
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_dashboard_preferences_supplier_id ON dashboard_preferences(supplier_id);
CREATE INDEX IF NOT EXISTS idx_quick_action_usage_supplier_id ON quick_action_usage(supplier_id);
CREATE INDEX IF NOT EXISTS idx_dashboard_metrics_cache_supplier_id ON dashboard_metrics_cache(supplier_id);
CREATE INDEX IF NOT EXISTS idx_dashboard_metrics_cache_expires ON dashboard_metrics_cache(expires_at);
```

#### API Endpoints Required
```typescript
// GET /api/dashboard/data
interface DashboardDataResponse {
  quickActions: QuickAction[];
  todaysFocus: FocusItem[];
  recentActivity: ActivityItem[];
  metrics: {
    activeClients: number;
    upcomingWeddings: number;
    pendingTasks: number;
    completionRate: number;
  };
  widgets: DashboardWidget[];
}

// PUT /api/dashboard/preferences
interface UpdateDashboardPreferencesRequest {
  widgets: Array<{
    id: string;
    position: number;
    size: 'small' | 'medium' | 'large';
    visible: boolean;
    settings?: any;
  }>;
}

// POST /api/dashboard/quick-action
interface LogQuickActionRequest {
  actionId: string;
}

// GET /api/dashboard/search
interface DashboardSearchRequest {
  query: string;
  type?: 'clients' | 'forms' | 'all';
}

interface DashboardSearchResponse {
  results: SearchResult[];
  suggestions: string[];
}
```

#### Frontend Components Required
```typescript
// Component: Dashboard
// Location: /src/components/dashboard/Dashboard.tsx

interface DashboardProps {
  initialData: DashboardData;
}

// Key functionality:
- Responsive grid layout (CSS Grid)
- Drag-and-drop widget positioning
- Real-time data updates via Supabase subscriptions
- Lazy loading of non-critical widgets
- Keyboard shortcuts (Cmd+K for search)
- Widget state persistence

// Component: QuickActionsBar
// Location: /src/components/dashboard/QuickActionsBar.tsx
interface QuickActionsBarProps {
  actions: QuickAction[];
  onActionClick: (action: QuickAction) => void;
}

// Key functionality:
- Most used actions prioritized
- Customizable action buttons
- Usage tracking for personalization
- Responsive button layout

// Component: TodaysFocusWidget
// Location: /src/components/dashboard/TodaysFocusWidget.tsx
interface TodaysFocusWidgetProps {
  items: FocusItem[];
  onItemComplete: (itemId: string) => void;
}

// Key functionality:
- Time-sensitive items highlighted
- Priority scoring algorithm
- One-click completion actions
- Smart refresh based on time of day

// Component: CommandBar
// Location: /src/components/dashboard/CommandBar.tsx
interface CommandBarProps {
  isOpen: boolean;
  onClose: () => void;
}

// Key functionality:
- Global search with fuzzy matching
- Keyboard navigation (up/down arrows)
- Recent searches and suggestions
- Quick actions and navigation
```

#### Integration Points
```typescript
// Service: DashboardService
// Dependencies: Supabase, Real-time subscriptions

class DashboardService {
  async getDashboardData(): Promise<DashboardData> {
    const [
      quickActions,
      todaysFocus,
      recentActivity,
      metrics
    ] = await Promise.all([
      this.getQuickActions(),
      this.getTodaysFocus(),
      this.getRecentActivity(),
      this.getMetrics()
    ]);
    
    return {
      quickActions,
      todaysFocus,
      recentActivity,
      metrics,
      widgets: await this.getWidgetPreferences()
    };
  }
  
  async getTodaysFocus(): Promise<FocusItem[]> {
    // Smart priority algorithm
    const now = new Date();
    const urgent = await supabase
      .from('clients')
      .select('*')
      .lt('wedding_date', addDays(now, 7))
      .is('timeline_confirmed', false);
      
    const overdue = await supabase
      .from('form_responses')
      .select('*')
      .lt('created_at', subDays(now, 2))
      .is('reviewed', false);
      
    return this.prioritizeItems([...urgent.data, ...overdue.data]);
  }
  
  async updateWidgetPreferences(widgets: DashboardWidget[]): Promise<void> {
    const updates = widgets.map(widget => ({
      supplier_id: getCurrentSupplierId(),
      widget_id: widget.id,
      position: widget.position,
      size: widget.size,
      visible: widget.visible,
      settings: widget.settings
    }));
    
    await supabase
      .from('dashboard_preferences')
      .upsert(updates, { onConflict: 'supplier_id,widget_id' });
  }
}
```

### CODE EXAMPLES

#### Example 1: Responsive Dashboard Grid
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { useState, useEffect, useCallback } from 'react';
import { DndProvider, useDrag, useDrop } from 'react-dnd';
import { HTML5Backend } from 'react-dnd-html5-backend';

interface DashboardGridProps {
  widgets: DashboardWidget[];
  onWidgetMove: (dragId: string, hoverId: string) => void;
}

export function DashboardGrid({ widgets, onWidgetMove }: DashboardGridProps) {
  const [gridLayout, setGridLayout] = useState(widgets);
  
  const moveWidget = useCallback((dragIndex: number, hoverIndex: number) => {
    const newLayout = [...gridLayout];
    const [draggedItem] = newLayout.splice(dragIndex, 1);
    newLayout.splice(hoverIndex, 0, draggedItem);
    setGridLayout(newLayout);
  }, [gridLayout]);
  
  return (
    <DndProvider backend={HTML5Backend}>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 p-6">
        {gridLayout.map((widget, index) => (
          <DraggableWidget
            key={widget.id}
            widget={widget}
            index={index}
            moveWidget={moveWidget}
          />
        ))}
      </div>
    </DndProvider>
  );
}

interface DraggableWidgetProps {
  widget: DashboardWidget;
  index: number;
  moveWidget: (dragIndex: number, hoverIndex: number) => void;
}

function DraggableWidget({ widget, index, moveWidget }: DraggableWidgetProps) {
  const [{ isDragging }, drag] = useDrag({
    type: 'widget',
    item: { index },
    collect: (monitor) => ({
      isDragging: monitor.isDragging()
    })
  });
  
  const [, drop] = useDrop({
    accept: 'widget',
    hover: (item: { index: number }) => {
      if (item.index !== index) {
        moveWidget(item.index, index);
        item.index = index;
      }
    }
  });
  
  return (
    <div
      ref={(node) => drag(drop(node))}
      className={`
        bg-white rounded-lg shadow-sm border border-gray-200 p-4
        ${isDragging ? 'opacity-50' : 'opacity-100'}
        ${widget.size === 'large' ? 'col-span-2' : ''}
        transition-opacity duration-200
        cursor-move hover:shadow-md
      `}
    >
      <WidgetContent widget={widget} />
    </div>
  );
}
```

#### Example 2: Command Bar with Search
```typescript
import { useState, useEffect, useRef } from 'react';
import { useDebounce } from 'use-debounce';
import { Command } from 'cmdk';

interface CommandBarProps {
  isOpen: boolean;
  onClose: () => void;
}

export function CommandBar({ isOpen, onClose }: CommandBarProps) {
  const [query, setQuery] = useState('');
  const [debouncedQuery] = useDebounce(query, 300);
  const [results, setResults] = useState<SearchResult[]>([]);
  const inputRef = useRef<HTMLInputElement>(null);
  
  useEffect(() => {
    if (isOpen && inputRef.current) {
      inputRef.current.focus();
    }
  }, [isOpen]);
  
  useEffect(() => {
    if (debouncedQuery.length > 2) {
      searchDashboard(debouncedQuery).then(setResults);
    } else {
      setResults([]);
    }
  }, [debouncedQuery]);
  
  const handleSelect = (result: SearchResult) => {
    switch (result.type) {
      case 'client':
        router.push(`/clients/${result.id}`);
        break;
      case 'form':
        router.push(`/forms/${result.id}`);
        break;
      case 'action':
        executeQuickAction(result.id);
        break;
    }
    onClose();
  };
  
  if (!isOpen) return null;
  
  return (
    <div className="fixed inset-0 z-50 bg-black bg-opacity-50 flex items-start justify-center pt-20">
      <Command className="bg-white rounded-lg shadow-2xl max-w-2xl w-full mx-4">
        <Command.Input
          ref={inputRef}
          value={query}
          onValueChange={setQuery}
          placeholder="Search clients, forms, or type a command..."
          className="w-full px-4 py-3 text-lg border-0 outline-none"
        />
        
        <Command.List className="max-h-96 overflow-y-auto border-t border-gray-200">
          {results.length === 0 && query.length > 2 && (
            <Command.Empty className="px-4 py-8 text-center text-gray-500">
              No results found for "{query}"
            </Command.Empty>
          )}
          
          <Command.Group heading="Quick Actions">
            <Command.Item onSelect={() => handleSelect({ type: 'action', id: 'new-client' })}>
              <span className="flex items-center gap-2">
                <PlusIcon className="w-4 h-4" />
                Add New Client
              </span>
            </Command.Item>
            <Command.Item onSelect={() => handleSelect({ type: 'action', id: 'new-form' })}>
              <span className="flex items-center gap-2">
                <DocumentIcon className="w-4 h-4" />
                Create Form
              </span>
            </Command.Item>
          </Command.Group>
          
          {results.map((result) => (
            <Command.Item
              key={result.id}
              onSelect={() => handleSelect(result)}
              className="px-4 py-3 flex items-center gap-3 hover:bg-gray-50"
            >
              <ResultIcon type={result.type} />
              <div>
                <div className="font-medium">{result.title}</div>
                <div className="text-sm text-gray-500">{result.subtitle}</div>
              </div>
            </Command.Item>
          ))}
        </Command.List>
      </Command>
    </div>
  );
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for React DnD, CMDK, CSS Grid, Supabase real-time
- [x] Playwright: Test dashboard interactions, drag-and-drop, command bar
- [x] Filesystem: Access existing layout components and patterns

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/react-dnd/react-dnd", "drag and drop", 3000);
await mcp__context7__get-library-docs("/pacocoursey/cmdk", "command palette", 2000);
await mcp__context7__get-library-docs("/supabase/supabase", "real-time data", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('Dashboard', () => {
  it('should load dashboard data on mount', () => {
    // Test initial data loading
  });
  
  it('should persist widget layout changes', () => {
    // Test drag-and-drop persistence
  });
  
  it('should update real-time data', () => {
    // Test subscription updates
  });
  
  it('should handle command bar search', () => {
    // Test search functionality
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Dashboard workflow', async () => {
  await mcp__playwright__browser_navigate({url: '/dashboard'});
  await mcp__playwright__browser_snapshot();
  
  // Test command bar
  await mcp__playwright__browser_press_key({key: 'Meta+k'});
  await mcp__playwright__browser_type({
    element: 'Command input',
    ref: '[cmdk-input]',
    text: 'new client'
  });
  
  // Test widget drag-and-drop
  await mcp__playwright__browser_drag({
    startElement: 'Activity widget',
    startRef: '[data-testid="widget-activity"]',
    endElement: 'Metrics widget',
    endRef: '[data-testid="widget-metrics"]'
  });
  
  // Verify layout persistence
  await mcp__playwright__browser_navigate({url: '/clients'});
  await mcp__playwright__browser_navigate_back();
  await mcp__playwright__browser_snapshot();
});
```

### ACCEPTANCE CRITERIA
- [x] Loads dashboard data in <3 seconds on first visit
- [x] All critical info visible without scrolling on desktop (1440px+)
- [x] Drag-and-drop widget positioning works smoothly
- [x] Command bar (Cmd+K) provides instant search results
- [x] Performance: Real-time updates without blocking UI
- [x] Security: Dashboard data filtered by supplier via RLS
- [x] Accessibility: Keyboard navigation, focus management, screen reader support

### DEPENDENCIES
- Must complete after: User authentication, basic layout components
- Must complete before: WS-038 (Navigation Structure)
- Shares code with: Layout components, search utilities

### ESTIMATED EFFORT
- Team A Frontend: 18 hours
- Team B Backend: 8 hours
- Team C Integration: 4 hours
- Total: 30 hours