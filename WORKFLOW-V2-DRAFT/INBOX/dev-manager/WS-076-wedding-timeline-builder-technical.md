# TECHNICAL SPECIFICATION: WS-076 - Wedding Timeline Builder
## Generated by Feature Development Session - August 22, 2025

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding photographer coordinating with 8 other vendors
**I want to:** Build and share a unified wedding day timeline that all vendors can access and update
**So that:** Everyone knows exactly when to arrive, set up, and perform their services without constant phone calls

**Real Wedding Scenario:**
A photographer currently creates timelines in Excel, emails them to all vendors, then gets 15+ revision requests via different channels. With this timeline builder, they create one master timeline, share a link with all vendors who can view their specific times, and any updates sync instantly to everyone. This eliminates the "which version is final?" chaos and saves 4+ hours per wedding.

### SPECIFICATION SOURCE
- **Feature ID:** WS-076
- **Original Spec:** Wedding day coordination timeline system
- **Current Implementation:** 0% complete
- **Files to Modify:**
  - /wedsync/src/app/(dashboard)/layout.tsx (add timeline menu)
- **New Files to Create:**
  - /wedsync/src/app/(dashboard)/timeline/page.tsx
  - /wedsync/src/app/(dashboard)/timeline/[id]/page.tsx
  - /wedsync/src/app/(dashboard)/timeline/[id]/edit/page.tsx
  - /wedsync/src/app/api/timeline/route.ts
  - /wedsync/src/app/api/timeline/[id]/route.ts
  - /wedsync/src/app/api/timeline/[id]/share/route.ts
  - /wedsync/src/components/timeline/TimelineBuilder.tsx
  - /wedsync/src/components/timeline/TimelineEvent.tsx
  - /wedsync/src/components/timeline/VendorAssignment.tsx
  - /wedsync/src/lib/services/timelineService.ts

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Wedding timelines
CREATE TABLE IF NOT EXISTS wedding_timelines (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  couple_id UUID NOT NULL REFERENCES couples(id),
  wedding_date DATE NOT NULL,
  ceremony_time TIME,
  reception_time TIME,
  timezone VARCHAR(50) DEFAULT 'America/New_York',
  title VARCHAR(255) NOT NULL,
  status VARCHAR(50) DEFAULT 'draft', -- 'draft', 'published', 'final'
  share_token VARCHAR(255) UNIQUE,
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Timeline events
CREATE TABLE IF NOT EXISTS timeline_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  timeline_id UUID NOT NULL REFERENCES wedding_timelines(id) ON DELETE CASCADE,
  event_name VARCHAR(255) NOT NULL,
  event_type VARCHAR(50), -- 'preparation', 'ceremony', 'photos', 'reception'
  start_time TIME NOT NULL,
  duration_minutes INTEGER DEFAULT 30,
  location VARCHAR(500),
  notes TEXT,
  display_order INTEGER NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Vendor assignments to events
CREATE TABLE IF NOT EXISTS timeline_vendor_assignments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  timeline_event_id UUID NOT NULL REFERENCES timeline_events(id) ON DELETE CASCADE,
  vendor_type VARCHAR(50) NOT NULL, -- 'photographer', 'videographer', 'florist', etc.
  vendor_name VARCHAR(255),
  vendor_email VARCHAR(255),
  arrival_time TIME,
  setup_minutes INTEGER DEFAULT 30,
  responsibilities TEXT,
  confirmed BOOLEAN DEFAULT false,
  confirmed_at TIMESTAMP WITH TIME ZONE,
  
  UNIQUE(timeline_event_id, vendor_type)
);

-- Timeline access logs
CREATE TABLE IF NOT EXISTS timeline_access_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  timeline_id UUID NOT NULL REFERENCES wedding_timelines(id),
  accessed_by_email VARCHAR(255),
  access_type VARCHAR(50), -- 'view', 'edit', 'download'
  ip_address INET,
  accessed_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE INDEX idx_timeline_couple ON wedding_timelines(couple_id);
CREATE INDEX idx_timeline_events_timeline ON timeline_events(timeline_id);
CREATE INDEX idx_vendor_assignments_event ON timeline_vendor_assignments(timeline_event_id);
```

#### API Endpoints Required
```typescript
// GET /api/timeline - Get all timelines for couple/supplier
interface GetTimelinesResponse {
  timelines: {
    id: string;
    title: string;
    weddingDate: string;
    status: 'draft' | 'published' | 'final';
    eventCount: number;
    vendorCount: number;
    lastUpdated: string;
  }[];
}

// POST /api/timeline - Create new timeline
interface CreateTimelineRequest {
  title: string;
  weddingDate: string;
  ceremonyTime: string;
  receptionTime?: string;
  timezone: string;
  templateId?: string; // Use pre-built template
}

// PUT /api/timeline/[id] - Update timeline and events
interface UpdateTimelineRequest {
  timeline?: {
    title?: string;
    status?: 'draft' | 'published' | 'final';
  };
  events?: {
    id?: string;
    eventName: string;
    startTime: string;
    duration: number;
    location?: string;
    vendorAssignments?: VendorAssignment[];
  }[];
}

// POST /api/timeline/[id]/share - Generate shareable link
interface ShareTimelineResponse {
  shareUrl: string;
  shareToken: string;
  expiresAt?: string;
}
```

#### Frontend Components Required
```typescript
// Component: TimelineBuilder
// Location: /src/components/timeline/TimelineBuilder.tsx

interface TimelineBuilderProps {
  timeline?: Timeline;
  onSave: (timeline: Timeline) => Promise<void>;
}

// Key functionality:
- Drag-and-drop event reordering
- Time slot conflict detection
- Auto-calculate buffer times
- Template application
- Print-friendly view
- Mobile-responsive design

// Component: TimelineEvent
// Location: /src/components/timeline/TimelineEvent.tsx

interface TimelineEventProps {
  event: Event;
  vendors: VendorAssignment[];
  onUpdate: (event: Event) => void;
  onDelete: () => void;
}

// Key functionality:
- Event time and duration editing
- Vendor assignment management
- Location and notes fields
- Visual timeline representation
- Conflict warnings

// Component: VendorAssignment
// Location: /src/components/timeline/VendorAssignment.tsx

interface VendorAssignmentProps {
  assignment: VendorAssignment;
  onConfirm: () => void;
  onUpdate: (assignment: VendorAssignment) => void;
}

// Key functionality:
- Vendor type selection
- Arrival/setup time calculation
- Email notification trigger
- Confirmation status display
- Responsibility checklist
```

#### Integration Points
```typescript
// Service: TimelineService
// Dependencies: Supabase, email service, PDF generator

class TimelineService {
  async createTimeline(coupleId: string, data: CreateTimelineRequest) {
    // Create base timeline
    const { data: timeline } = await supabase
      .from('wedding_timelines')
      .insert({
        couple_id: coupleId,
        title: data.title,
        wedding_date: data.weddingDate,
        ceremony_time: data.ceremonyTime,
        reception_time: data.receptionTime,
        timezone: data.timezone
      })
      .select()
      .single();
    
    // Apply template if specified
    if (data.templateId) {
      const events = await this.getTemplateEvents(data.templateId);
      await this.createEventsFromTemplate(timeline.id, events, data.ceremonyTime);
    }
    
    return timeline;
  }
  
  async detectConflicts(timelineId: string): Promise<Conflict[]> {
    const events = await this.getTimelineEvents(timelineId);
    const conflicts: Conflict[] = [];
    
    // Check for overlapping vendor assignments
    for (let i = 0; i < events.length; i++) {
      for (let j = i + 1; j < events.length; j++) {
        if (this.eventsOverlap(events[i], events[j])) {
          const sharedVendors = this.findSharedVendors(events[i], events[j]);
          if (sharedVendors.length > 0) {
            conflicts.push({
              type: 'vendor_overlap',
              events: [events[i].id, events[j].id],
              vendors: sharedVendors,
              message: `${sharedVendors.join(', ')} assigned to overlapping events`
            });
          }
        }
      }
    }
    
    return conflicts;
  }
  
  async generateShareableLink(timelineId: string): Promise<string> {
    const token = crypto.randomBytes(32).toString('hex');
    
    await supabase
      .from('wedding_timelines')
      .update({ share_token: token })
      .eq('id', timelineId);
    
    return `${process.env.NEXT_PUBLIC_APP_URL}/timeline/view/${token}`;
  }
}
```

### CODE EXAMPLES

#### Example 1: Timeline Builder with Drag-and-Drop
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { useState } from 'react';
import { DragDropContext, Droppable, Draggable } from '@hello-pangea/dnd';
import { supabase } from '@/lib/supabase';

export function TimelineBuilder({ timeline, onSave }: TimelineBuilderProps) {
  const [events, setEvents] = useState<TimelineEvent[]>(timeline?.events || []);
  const [conflicts, setConflicts] = useState<Conflict[]>([]);
  
  // Handle drag and drop reordering
  const handleDragEnd = async (result: DropResult) => {
    if (!result.destination) return;
    
    const items = Array.from(events);
    const [reorderedItem] = items.splice(result.source.index, 1);
    items.splice(result.destination.index, 0, reorderedItem);
    
    // Update display order
    const updatedEvents = items.map((event, index) => ({
      ...event,
      display_order: index
    }));
    
    setEvents(updatedEvents);
    
    // Check for conflicts after reorder
    await checkTimelineConflicts(updatedEvents);
  };
  
  const checkTimelineConflicts = async (eventList: TimelineEvent[]) => {
    const timelineService = new TimelineService();
    const detectedConflicts = await timelineService.detectConflicts(timeline.id);
    setConflicts(detectedConflicts);
  };
  
  const addEvent = () => {
    const lastEvent = events[events.length - 1];
    const startTime = lastEvent 
      ? addMinutes(lastEvent.start_time, lastEvent.duration_minutes)
      : timeline.ceremony_time;
    
    const newEvent: TimelineEvent = {
      id: `temp-${Date.now()}`,
      event_name: 'New Event',
      start_time: startTime,
      duration_minutes: 30,
      display_order: events.length,
      vendor_assignments: []
    };
    
    setEvents([...events, newEvent]);
  };
  
  return (
    <div className="max-w-4xl mx-auto p-6">
      <div className="bg-white rounded-lg shadow">
        <div className="p-6 border-b">
          <h2 className="text-2xl font-bold">{timeline.title}</h2>
          <p className="text-gray-600">{formatDate(timeline.wedding_date)}</p>
        </div>
        
        {conflicts.length > 0 && (
          <div className="p-4 bg-red-50 border-l-4 border-red-500">
            <h3 className="font-semibold text-red-800">Timeline Conflicts Detected:</h3>
            {conflicts.map((conflict, i) => (
              <p key={i} className="text-red-600 text-sm mt-1">{conflict.message}</p>
            ))}
          </div>
        )}
        
        <DragDropContext onDragEnd={handleDragEnd}>
          <Droppable droppableId="timeline">
            {(provided) => (
              <div {...provided.droppableProps} ref={provided.innerRef} className="p-6">
                {events.map((event, index) => (
                  <Draggable key={event.id} draggableId={event.id} index={index}>
                    {(provided, snapshot) => (
                      <div
                        ref={provided.innerRef}
                        {...provided.draggableProps}
                        {...provided.dragHandleProps}
                        className={`mb-4 ${snapshot.isDragging ? 'opacity-50' : ''}`}
                      >
                        <TimelineEvent
                          event={event}
                          vendors={event.vendor_assignments}
                          onUpdate={(updated) => updateEvent(index, updated)}
                          onDelete={() => removeEvent(index)}
                        />
                      </div>
                    )}
                  </Draggable>
                ))}
                {provided.placeholder}
              </div>
            )}
          </Droppable>
        </DragDropContext>
        
        <div className="p-6 border-t">
          <button
            onClick={addEvent}
            className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
          >
            Add Event
          </button>
        </div>
      </div>
    </div>
  );
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [ ] Context7: Load docs for drag-and-drop libraries, timeline visualization
- [ ] Playwright: Test timeline builder interactions and sharing
- [ ] Filesystem: Access timeline templates

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/hello-pangea/dnd", "drag and drop", 2500);
await mcp__context7__get-library-docs("/react-big-calendar/react-big-calendar", "timeline view", 2000);
await mcp__context7__get-library-docs("/date-fns/date-fns", "time calculations", 1500);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('Timeline Service', () => {
  it('should detect vendor conflicts correctly', async () => {
    const conflicts = await timelineService.detectConflicts('timeline-123');
    expect(conflicts).toHaveLength(1);
    expect(conflicts[0].type).toBe('vendor_overlap');
    expect(conflicts[0].vendors).toContain('photographer');
  });
  
  it('should calculate buffer times between events', async () => {
    const events = await timelineService.addBufferTime(mockEvents, 15);
    expect(events[1].start_time).toBe('10:45'); // 15 min after first event ends
  });
});
```

#### E2E Tests Required
```typescript
test('Complete timeline creation and sharing flow', async () => {
  await mcp__playwright__browser_navigate({url: '/timeline/create'});
  
  // Add events
  await mcp__playwright__browser_click({
    element: "Add Event button",
    ref: "button:has-text('Add Event')"
  });
  
  // Test drag and drop
  await mcp__playwright__browser_drag({
    startElement: "First event",
    startRef: "[data-testid='event-0']",
    endElement: "Third position",
    endRef: "[data-testid='event-2']"
  });
  
  // Generate share link
  await mcp__playwright__browser_click({
    element: "Share Timeline button",
    ref: "button[data-testid='share-timeline']"
  });
  
  await mcp__playwright__browser_wait_for({text: "Share this link"});
});
```

### ACCEPTANCE CRITERIA
- [ ] Timeline events can be reordered via drag-and-drop
- [ ] Vendor conflicts are detected and highlighted
- [ ] Shareable links work without login for viewing
- [ ] Timeline exports to PDF for printing
- [ ] Mobile view allows event management
- [ ] Performance: Timeline loads in under 2 seconds
- [ ] Security: Share tokens are cryptographically secure
- [ ] Accessibility: Keyboard navigation for all features

### DEPENDENCIES
- Must complete after: Core couple/supplier accounts
- Must complete before: Vendor coordination features
- Shares code with: Calendar systems, event management

### ESTIMATED EFFORT
- Team A Frontend: 24 hours (Timeline UI, drag-drop, visualization)
- Team B Backend: 16 hours (API, conflict detection, sharing)
- Total: 40 hours