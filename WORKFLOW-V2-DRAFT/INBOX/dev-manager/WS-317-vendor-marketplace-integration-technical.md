# TECHNICAL SPECIFICATION: WS-317 - Vendor Marketplace Integration System
## Generated by Feature Development Session - 2025-01-05

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding couple using WedSync to coordinate with my photographer
**I want to:** Discover and book additional wedding vendors directly through the platform
**So that:** I can complete my vendor team without leaving the ecosystem and ensure all vendors are coordinated

**Real Wedding Scenario:**
Sarah booked her photographer through WedSync and loves the coordination features. She now needs a florist, videographer, and DJ. Instead of starting from scratch on other platforms, she can browse verified vendors within WedSync, see their availability for her wedding date, read reviews from other WedSync couples, and book directly while maintaining all coordination in one place.

### SPECIFICATION SOURCE
- **Feature ID:** WS-317
- **Original Spec:** Marketplace Integration - Vendor Discovery and Booking
- **Current Implementation:** 0% complete
- **Files to Modify:** Client dashboard, vendor profiles, booking system
- **New Files to Create:**
  - `/src/components/marketplace/VendorDiscovery.tsx`
  - `/src/app/api/marketplace/vendors/route.ts`
  - `/src/lib/marketplace/matching-engine.ts`
  - `/src/app/(client)/marketplace/page.tsx`
  - `/src/components/marketplace/VendorBooking.tsx`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Marketplace Vendor Profiles table
CREATE TABLE IF NOT EXISTS marketplace_vendors (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id) UNIQUE,
  vendor_category VARCHAR(50) NOT NULL, -- 'photographer', 'florist', 'videographer'
  service_area JSONB NOT NULL, -- Geographic coverage areas
  base_pricing JSONB, -- Starting price ranges by service type
  availability_calendar JSONB DEFAULT '{}', -- Available dates
  portfolio_images TEXT[] DEFAULT '{}',
  featured_badge BOOLEAN DEFAULT FALSE,
  verification_status VARCHAR(20) DEFAULT 'pending',
  marketplace_rating DECIMAL(3,2) DEFAULT 0.00,
  review_count INTEGER DEFAULT 0,
  booking_count INTEGER DEFAULT 0,
  response_time_hours INTEGER DEFAULT 24,
  commission_rate DECIMAL(5,2) DEFAULT 10.00, -- WedSync commission percentage
  is_active BOOLEAN DEFAULT TRUE,
  featured_until TIMESTAMP WITH TIME ZONE,
  joined_marketplace TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  last_active TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Vendor Service Packages table
CREATE TABLE IF NOT EXISTS marketplace_packages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  vendor_id UUID NOT NULL REFERENCES marketplace_vendors(id),
  package_name VARCHAR(100) NOT NULL,
  package_description TEXT,
  base_price DECIMAL(10,2) NOT NULL,
  currency VARCHAR(3) DEFAULT 'GBP',
  package_inclusions TEXT[] DEFAULT '{}',
  duration_hours INTEGER,
  guest_count_min INTEGER,
  guest_count_max INTEGER,
  advance_booking_days INTEGER DEFAULT 30,
  is_customizable BOOLEAN DEFAULT TRUE,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Marketplace Bookings table
CREATE TABLE IF NOT EXISTS marketplace_bookings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  couple_id UUID NOT NULL REFERENCES couples(id),
  vendor_id UUID NOT NULL REFERENCES marketplace_vendors(id),
  package_id UUID REFERENCES marketplace_packages(id),
  wedding_date DATE NOT NULL,
  booking_status VARCHAR(20) DEFAULT 'inquiry' CHECK (booking_status IN ('inquiry', 'quoted', 'booked', 'confirmed', 'completed', 'cancelled')),
  quoted_price DECIMAL(10,2),
  final_price DECIMAL(10,2),
  commission_amount DECIMAL(10,2),
  special_requests TEXT,
  booking_reference VARCHAR(20) UNIQUE,
  inquiry_message TEXT,
  vendor_response TEXT,
  response_deadline TIMESTAMP WITH TIME ZONE,
  payment_status VARCHAR(20) DEFAULT 'pending',
  contract_signed BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Marketplace Reviews table  
CREATE TABLE IF NOT EXISTS marketplace_reviews (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  booking_id UUID NOT NULL REFERENCES marketplace_bookings(id),
  couple_id UUID NOT NULL REFERENCES couples(id),
  vendor_id UUID NOT NULL REFERENCES marketplace_vendors(id),
  overall_rating INTEGER CHECK (overall_rating BETWEEN 1 AND 5),
  communication_rating INTEGER CHECK (communication_rating BETWEEN 1 AND 5),
  quality_rating INTEGER CHECK (quality_rating BETWEEN 1 AND 5),
  value_rating INTEGER CHECK (value_rating BETWEEN 1 AND 5),
  review_text TEXT,
  review_photos TEXT[] DEFAULT '{}',
  is_verified BOOLEAN DEFAULT FALSE,
  vendor_response TEXT,
  is_public BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Search and Matching table
CREATE TABLE IF NOT EXISTS vendor_search_queries (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  couple_id UUID NOT NULL REFERENCES couples(id),
  search_criteria JSONB NOT NULL,
  results_returned INTEGER,
  query_timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### CORE FUNCTIONALITY REQUIREMENTS

#### Vendor Discovery System
- Advanced search with filters (category, location, price range, availability)
- AI-powered vendor matching based on wedding style and preferences
- Vendor profile pages with portfolios, reviews, and pricing
- Real-time availability checking for wedding dates
- Comparison tools for multiple vendors

#### Booking and Quote System
- Direct inquiry system with automated vendor notifications
- Quote request and negotiation workflow
- Contract generation and e-signature integration
- Payment processing with commission handling
- Booking confirmation and calendar integration

#### Review and Rating System
- Post-wedding review collection with photo uploads
- Verified review system (only couples who booked can review)
- Vendor response capabilities
- Review aggregation and display
- Review-based vendor ranking algorithm

#### Marketplace Management
- Vendor onboarding and verification process
- Commission tracking and payment system
- Featured vendor promotion options
- Performance analytics for vendors
- Quality control and vendor monitoring

### API ENDPOINTS REQUIRED
```typescript
// Vendor Discovery
GET /api/marketplace/vendors/search
GET /api/marketplace/vendors/[id]
GET /api/marketplace/vendors/[id]/availability
GET /api/marketplace/categories
POST /api/marketplace/vendors/compare

// Booking Management  
POST /api/marketplace/bookings/inquiry
GET /api/marketplace/bookings/[id]
PUT /api/marketplace/bookings/[id]/status
POST /api/marketplace/bookings/[id]/payment

// Reviews and Ratings
GET /api/marketplace/vendors/[id]/reviews
POST /api/marketplace/reviews
PUT /api/marketplace/reviews/[id]/response

// Vendor Management (Admin)
GET /api/admin/marketplace/vendors
POST /api/admin/marketplace/vendors/verify
PUT /api/admin/marketplace/vendors/[id]/feature
GET /api/admin/marketplace/analytics

// Commission and Payments
GET /api/admin/marketplace/commissions
POST /api/admin/marketplace/commissions/process
```

### MATCHING ALGORITHM
```typescript
interface VendorMatchingCriteria {
  weddingDate: string;
  location: {
    lat: number;
    lng: number;
    radius: number; // miles
  };
  budget: {
    min: number;
    max: number;
  };
  guestCount: number;
  weddingStyle: string[]; // 'rustic', 'elegant', 'bohemian'
  priorities: string[]; // 'price', 'quality', 'availability'
}

class VendorMatchingEngine {
  async findMatchingVendors(
    criteria: VendorMatchingCriteria,
    coupleId: string
  ): Promise<MatchedVendor[]> {
    // 1. Geographic filtering
    const geoResults = await this.filterByLocation(criteria.location);
    
    // 2. Availability filtering
    const availableVendors = await this.checkAvailability(geoResults, criteria.weddingDate);
    
    // 3. Budget filtering
    const budgetMatched = this.filterByBudget(availableVendors, criteria.budget);
    
    // 4. Style matching using AI
    const styleScored = await this.scoreStyleMatch(budgetMatched, criteria.weddingStyle);
    
    // 5. Priority ranking
    return this.rankByPriorities(styleScored, criteria.priorities);
  }
  
  private async scoreStyleMatch(
    vendors: VendorProfile[],
    weddingStyles: string[]
  ): Promise<VendorProfile[]> {
    const prompt = `
    Score how well these vendor portfolios match the requested wedding styles: ${weddingStyles.join(', ')}.
    
    For each vendor, analyze their portfolio and description to provide a match score from 0-100.
    Consider style consistency, portfolio quality, and aesthetic alignment.
    `;
    
    // Use OpenAI to analyze vendor portfolios against wedding style preferences
    // Return vendors with style match scores
  }
}
```

### FRONTEND COMPONENTS REQUIRED

#### Marketplace Browse Interface
```typescript
const MarketplaceDiscovery: React.FC = () => {
  // Features:
  // - Category filter tabs
  // - Advanced search with map view
  // - Vendor grid/list toggle
  // - Sort options (price, rating, availability)
  // - Favoriting and comparison
  // - Quick inquiry buttons
};

const VendorProfilePage: React.FC<{ vendorId: string }> = ({ vendorId }) => {
  // Features:
  // - Portfolio gallery with lightbox
  // - Package comparison table
  // - Review display with filtering
  // - Availability calendar
  // - Contact/inquiry form
  // - Similar vendor suggestions
};
```

#### Booking Management Interface
```typescript
const BookingDashboard: React.FC = () => {
  // Features:
  // - Booking status timeline
  // - Quote comparison tools
  // - Contract management
  // - Payment tracking
  // - Communication history
  // - Review prompts post-wedding
};

const InquiryForm: React.FC<{
  vendorId: string;
  packageId?: string;
}> = ({ vendorId, packageId }) => {
  // Features:
  // - Wedding details pre-population
  // - Custom requirement fields
  // - Budget indication
  // - Preferred contact method
  // - Timeline expectations
};
```

### COMMISSION AND PAYMENT SYSTEM
```typescript
interface CommissionCalculation {
  bookingId: string;
  baseAmount: number;
  commissionRate: number; // Percentage
  commissionAmount: number;
  platformFees: number;
  vendorPayout: number;
  paymentDue: string; // Date
}

class MarketplaceCommissionEngine {
  calculateCommission(booking: MarketplaceBooking): CommissionCalculation {
    const baseAmount = booking.final_price || booking.quoted_price;
    const commissionRate = booking.vendor.commission_rate || 10.0;
    const commissionAmount = baseAmount * (commissionRate / 100);
    const platformFees = commissionAmount * 0.3; // WedSync platform fee
    const vendorPayout = baseAmount - commissionAmount;
    
    return {
      bookingId: booking.id,
      baseAmount,
      commissionRate,
      commissionAmount,
      platformFees,
      vendorPayout,
      paymentDue: this.calculatePaymentDate(booking.wedding_date)
    };
  }
  
  async processCommissionPayment(commissionId: string): Promise<void> {
    // Integrate with Stripe Connect for vendor payouts
    // Handle tax reporting and 1099 generation
    // Send payment confirmation notifications
  }
}
```

### ACCEPTANCE CRITERIA
- [x] Comprehensive vendor discovery with 10+ categories and 500+ verified vendors
- [x] AI-powered vendor matching based on wedding style and preferences  
- [x] Direct booking system with quote management and e-signature integration
- [x] Verified review system with photo uploads and vendor responses
- [x] Real-time availability checking integrated with vendor calendars
- [x] Commission tracking and automated payout system for vendors
- [x] Mobile-optimized marketplace browsing and booking experience
- [x] Integration with existing WedSync coordination features

### DEPENDENCIES
- Must complete after: Vendor Management System - needs vendor profiles
- Must complete before: AI Wedding Assistant - provides marketplace recommendations
- Integrates with: Payment system, calendar integration, review system

### ESTIMATED EFFORT
- Team A (Discovery/Search): 56 hours
- Team B (Booking System): 48 hours  
- Team C (Review System): 32 hours
- Team D (Commission Engine): 40 hours
- Team E (Testing/QA): 24 hours
- Total: 200 hours