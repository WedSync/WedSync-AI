# TECHNICAL SPECIFICATION: WS-074 - Invitation Landing
## Generated by Feature Development Session - August 22, 2025

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Engaged couple who received an invitation link from their photographer
**I want to:** Quickly understand the value of this wedding planning tool and sign up effortlessly
**So that:** I can start organizing my wedding details in one place without filling out the same information multiple times

**Real Wedding Scenario:**
A photographer texts their newly booked clients: "Visit wedme.app/invite/abc123 to access your wedding dashboard - I've already set up your timeline!" The couple clicks, sees a personalized landing page showing their photographer's branding, a preview of their dashboard, and clear value props like "Never fill the same form twice." They sign up in 30 seconds with Google, automatically linking to their photographer's account.

### SPECIFICATION SOURCE
- **Feature ID:** WS-074
- **Original Spec:** /CORE-SPECIFICATIONS/03-WEDME-COUPLE-PLATFORM/01-Onboarding/01-invitation-landing md.md
- **Current Implementation:** 0% complete
- **Files to Modify:**
  - /wedsync/src/app/layout.tsx (add WedMe subdomain routing)
- **New Files to Create:**
  - /wedsync/src/app/invite/[code]/page.tsx
  - /wedsync/src/app/api/invite/[code]/route.ts
  - /wedsync/src/app/api/invite/validate/route.ts
  - /wedsync/src/components/wedme/InvitationLanding.tsx
  - /wedsync/src/components/wedme/SupplierPreview.tsx
  - /wedsync/src/components/wedme/ValueProposition.tsx
  - /wedsync/src/components/wedme/SignupPrompt.tsx
  - /wedsync/src/lib/services/invitationService.ts
  - /wedsync/src/lib/wedme/conversionTracking.ts

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Couple invitations from suppliers
CREATE TABLE IF NOT EXISTS couple_invitations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID NOT NULL REFERENCES suppliers(id),
  invitation_code VARCHAR(255) NOT NULL UNIQUE,
  couple_email_1 VARCHAR(255) NOT NULL,
  couple_email_2 VARCHAR(255), -- Optional second partner
  couple_names VARCHAR(500), -- "Sarah & Mike Johnson"
  wedding_date DATE,
  personal_message TEXT,
  supplier_branding JSONB, -- Logo, colors, custom message
  status VARCHAR(50) DEFAULT 'pending', -- 'pending', 'viewed', 'signed_up', 'expired'
  expires_at TIMESTAMP WITH TIME ZONE DEFAULT (now() + interval '30 days'),
  viewed_at TIMESTAMP WITH TIME ZONE,
  signed_up_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  
  INDEX idx_couple_invitations_code (invitation_code),
  INDEX idx_couple_invitations_supplier (supplier_id),
  INDEX idx_couple_invitations_status (status)
);

-- Invitation analytics
CREATE TABLE IF NOT EXISTS invitation_analytics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  invitation_id UUID NOT NULL REFERENCES couple_invitations(id),
  event_type VARCHAR(50) NOT NULL, -- 'page_view', 'signup_click', 'conversion'
  event_data JSONB, -- Additional event metadata
  user_agent TEXT,
  ip_address INET,
  referrer TEXT,
  timestamp TIMESTAMP WITH TIME ZONE DEFAULT now(),
  
  INDEX idx_invitation_analytics_invitation (invitation_id),
  INDEX idx_invitation_analytics_event (event_type),
  INDEX idx_invitation_analytics_timestamp (timestamp)
);

-- Pre-filled couple data from invitations
CREATE TABLE IF NOT EXISTS invitation_prefill_data (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  invitation_id UUID NOT NULL REFERENCES couple_invitations(id),
  data_type VARCHAR(50) NOT NULL, -- 'wedding_date', 'venue', 'guest_count'
  data_value JSONB NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  
  UNIQUE(invitation_id, data_type)
);
```

#### API Endpoints Required
```typescript
// GET /api/invite/[code] - Get invitation details
interface GetInvitationResponse {
  invitation: {
    id: string;
    supplierName: string;
    supplierLogo?: string;
    supplierType: string; // 'photographer', 'venue', 'caterer'
    coupleNames: string;
    personalMessage?: string;
    branding: {
      primaryColor?: string;
      logo?: string;
      customMessage?: string;
    };
    prefilledData?: {
      weddingDate?: string;
      venue?: string;
      guestCount?: number;
    };
  };
  isExpired: boolean;
  hasBeenUsed: boolean;
}

// POST /api/invite/validate - Validate invitation code
interface ValidateInvitationRequest {
  code: string;
}

interface ValidateInvitationResponse {
  valid: boolean;
  invitation?: InvitationData;
  error?: string;
}

// POST /api/invite/[code]/track - Track invitation events
interface TrackInvitationEventRequest {
  eventType: 'page_view' | 'signup_click' | 'conversion';
  eventData?: Record<string, any>;
}
```

#### Frontend Components Required
```typescript
// Component: InvitationLanding
// Location: /src/components/wedme/InvitationLanding.tsx

interface InvitationLandingProps {
  invitation: InvitationData;
  onSignupClick: () => void;
}

// Key functionality:
- Hero section with supplier branding and personalization
- Value proposition section with wedding-specific benefits
- Dashboard preview with blurred content
- Trust signals and social proof
- Mobile-optimized layout with fast loading
- Conversion tracking for all user interactions

// Component: SupplierPreview
// Location: /src/components/wedme/SupplierPreview.tsx

interface SupplierPreviewProps {
  supplierName: string;
  supplierType: string;
  supplierLogo?: string;
  personalMessage?: string;
  branding?: BrandingData;
}

// Key functionality:
- Supplier logo and name prominently displayed
- Service type badge (photographer, venue, etc.)
- Personal message from supplier
- Trust signal: "Recommended by your [supplier type]"
- Supplier's custom branding colors

// Component: ValueProposition
// Location: /src/components/wedme/ValueProposition.tsx

interface ValuePropositionProps {
  supplierType: string;
  coupleNames: string;
}

// Key functionality:
- Tailored value props based on supplier type
- Visual demonstration of form pre-filling
- "All your vendors in one place" preview
- Mobile-friendly benefit cards
- Progress indicator showing saved time

// Component: SignupPrompt
// Location: /src/components/wedme/SignupPrompt.tsx

interface SignupPromptProps {
  onGoogleSignup: () => Promise<void>;
  onAppleSignup: () => Promise<void>;
  onEmailSignup: () => void;
  isLoading: boolean;
}

// Key functionality:
- Large Google/Apple sign-in buttons
- Email signup fallback option
- "100% free for couples" badge
- Security and privacy assurances
- Loading states for all signup methods
```

#### Integration Points
```typescript
// Service: InvitationService
// Dependencies: Supabase, analytics, email service

class InvitationService {
  async getInvitationByCode(code: string) {
    // Validate invitation code format
    if (!this.isValidInvitationCode(code)) {
      throw new Error('Invalid invitation code format');
    }
    
    // Fetch invitation with supplier details
    const { data: invitation, error } = await supabase
      .from('couple_invitations')
      .select(`
        *,
        suppliers (
          name,
          business_type,
          logo_url,
          brand_colors
        )
      `)
      .eq('invitation_code', code)
      .single();
    
    if (error || !invitation) {
      throw new Error('Invitation not found');
    }
    
    // Check expiration
    if (new Date(invitation.expires_at) < new Date()) {
      await this.updateInvitationStatus(invitation.id, 'expired');
      throw new Error('Invitation has expired');
    }
    
    // Track page view
    await this.trackInvitationEvent(invitation.id, 'page_view', {
      userAgent: navigator.userAgent,
      timestamp: new Date().toISOString()
    });
    
    // Mark as viewed if first time
    if (!invitation.viewed_at) {
      await this.updateInvitationStatus(invitation.id, 'viewed');
    }
    
    return invitation;
  }
  
  async createInvitation(supplierId: string, invitationData: CreateInvitationRequest) {
    // Generate unique invitation code
    const code = this.generateInvitationCode();
    
    // Get supplier branding
    const supplierBranding = await this.getSupplierBranding(supplierId);
    
    // Create invitation record
    const { data: invitation } = await supabase
      .from('couple_invitations')
      .insert({
        supplier_id: supplierId,
        invitation_code: code,
        couple_email_1: invitationData.coupleEmail1,
        couple_email_2: invitationData.coupleEmail2,
        couple_names: invitationData.coupleNames,
        wedding_date: invitationData.weddingDate,
        personal_message: invitationData.personalMessage,
        supplier_branding: supplierBranding
      })
      .select()
      .single();
    
    // Create pre-fill data if provided
    if (invitationData.prefilledData) {
      await this.savePrefillData(invitation.id, invitationData.prefilledData);
    }
    
    return {
      ...invitation,
      invitationUrl: `${process.env.NEXT_PUBLIC_WEDME_URL}/invite/${code}`
    };
  }
  
  async trackConversion(invitationId: string, coupleId: string) {
    // Update invitation status
    await supabase
      .from('couple_invitations')
      .update({
        status: 'signed_up',
        signed_up_at: new Date().toISOString()
      })
      .eq('id', invitationId);
    
    // Track conversion event
    await this.trackInvitationEvent(invitationId, 'conversion', {
      couple_id: coupleId,
      conversion_time: new Date().toISOString()
    });
    
    // Update supplier metrics
    await this.updateSupplierConversionMetrics(invitationId);
  }
  
  private generateInvitationCode(): string {
    // Format: abc123def (9 chars, easy to type/remember)
    const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < 9; i++) {
      result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
  }
}
```

### CODE EXAMPLES

#### Example 1: Invitation Landing Page Implementation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { supabase } from '@/lib/supabase';

export default function InvitationLandingPage({ params }: { params: { code: string } }) {
  const [invitation, setInvitation] = useState<InvitationData | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const router = useRouter();
  
  useEffect(() => {
    async function loadInvitation() {
      try {
        // Step 1: Validate and load invitation
        const invitationService = new InvitationService();
        const invitationData = await invitationService.getInvitationByCode(params.code);
        
        setInvitation(invitationData);
        
        // Step 2: Track page view
        await invitationService.trackInvitationEvent(invitationData.id, 'page_view');
        
      } catch (err) {
        setError(err.message);
      } finally {
        setLoading(false);
      }
    }
    
    loadInvitation();
  }, [params.code]);
  
  const handleSignupClick = async (method: 'google' | 'apple' | 'email') => {
    if (!invitation) return;
    
    // Track signup intent
    await invitationService.trackInvitationEvent(invitation.id, 'signup_click', { method });
    
    // Redirect to signup with invitation context
    const signupUrl = `/signup?invitation=${params.code}&method=${method}`;
    router.push(signupUrl);
  };
  
  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-rose-50 to-pink-50">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-rose-500"></div>
      </div>
    );
  }
  
  if (error || !invitation) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-rose-50 to-pink-50">
        <div className="text-center p-8">
          <h1 className="text-2xl font-bold text-gray-900 mb-4">Invitation Not Found</h1>
          <p className="text-gray-600 mb-6">{error || 'This invitation link is invalid or has expired.'}</p>
          <button 
            onClick={() => router.push('/signup')}
            className="bg-rose-500 text-white px-6 py-2 rounded-lg hover:bg-rose-600"
          >
            Sign Up Anyway
          </button>
        </div>
      </div>
    );
  }
  
  return (
    <div className="min-h-screen bg-gradient-to-br from-rose-50 to-pink-50">
      {/* Hero Section */}
      <section className="pt-12 pb-8 px-4 text-center">
        <div className="max-w-4xl mx-auto">
          <div className="mb-6">
            {invitation.supplier.logo_url && (
              <img 
                src={invitation.supplier.logo_url} 
                alt={invitation.supplier.name}
                className="h-16 w-auto mx-auto mb-4"
              />
            )}
            <h1 className="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
              {invitation.supplier.name} invited you to your<br />
              <span className="text-rose-600">Free Wedding Planning Dashboard!</span>
            </h1>
            <p className="text-xl text-gray-600">
              {invitation.couple_names} â€¢ Never fill out the same form twice
            </p>
          </div>
          
          {invitation.personal_message && (
            <div className="bg-white rounded-lg p-6 mb-8 max-w-2xl mx-auto border-l-4 border-rose-500">
              <p className="text-gray-700 italic">"{invitation.personal_message}"</p>
              <p className="text-sm text-gray-500 mt-2">- {invitation.supplier.name}</p>
            </div>
          )}
        </div>
      </section>
      
      {/* Value Proposition */}
      <ValueProposition 
        supplierType={invitation.supplier.business_type}
        coupleNames={invitation.couple_names}
      />
      
      {/* Signup Section */}
      <section className="py-12 px-4 bg-white">
        <div className="max-w-md mx-auto">
          <SignupPrompt 
            onGoogleSignup={() => handleSignupClick('google')}
            onAppleSignup={() => handleSignupClick('apple')}
            onEmailSignup={() => handleSignupClick('email')}
            isLoading={false}
          />
        </div>
      </section>
    </div>
  );
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [ ] Context7: Load docs for Next.js app router, OAuth integration
- [ ] Playwright: Test invitation landing page conversion flow
- [ ] Filesystem: Access landing page templates and assets

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/vercel/next.js", "app router dynamic routes", 2500);
await mcp__context7__get-library-docs("/supabase/auth-js", "oauth providers", 2000);
await mcp__context7__get-library-docs("/tailwindcss/tailwindcss", "responsive design", 1500);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('Invitation Service', () => {
  it('should validate invitation codes correctly', async () => {
    const validCode = 'abc123def';
    const invalidCode = 'invalid';
    
    expect(invitationService.isValidInvitationCode(validCode)).toBe(true);
    expect(invitationService.isValidInvitationCode(invalidCode)).toBe(false);
  });
  
  it('should track conversion events', async () => {
    const invitationId = 'inv-123';
    const coupleId = 'couple-456';
    
    await invitationService.trackConversion(invitationId, coupleId);
    
    const invitation = await getInvitation(invitationId);
    expect(invitation.status).toBe('signed_up');
    expect(invitation.signed_up_at).toBeTruthy();
  });
  
  it('should handle expired invitations', async () => {
    const expiredCode = 'expired123';
    
    await expect(
      invitationService.getInvitationByCode(expiredCode)
    ).rejects.toThrow('Invitation has expired');
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Invitation landing page conversion flow', async () => {
  // Test valid invitation
  await mcp__playwright__browser_navigate({url: '/invite/abc123def'});
  await mcp__playwright__browser_snapshot();
  
  // Verify supplier branding
  await mcp__playwright__browser_wait_for({text: "Photography invited you"});
  
  // Test value proposition display
  const valueProps = await mcp__playwright__browser_evaluate({
    function: "() => document.querySelectorAll('[data-testid=\"value-prop\"]').length"
  });
  expect(valueProps).toBeGreaterThan(0);
  
  // Test Google signup flow
  await mcp__playwright__browser_click({
    element: "Sign up with Google button",
    ref: "button[data-testid='google-signup']"
  });
  
  // Should redirect to signup with invitation context
  await mcp__playwright__browser_wait_for({text: "signup?invitation=abc123def"});
  
  // Test mobile responsiveness
  await mcp__playwright__browser_resize({width: 375, height: 667});
  await mcp__playwright__browser_snapshot();
});

test('Invalid invitation handling', async () => {
  await mcp__playwright__browser_navigate({url: '/invite/invalid123'});
  
  // Should show error message
  await mcp__playwright__browser_wait_for({text: "Invitation Not Found"});
  
  // Should offer fallback signup option
  await mcp__playwright__browser_click({
    element: "Sign Up Anyway button",
    ref: "button:has-text('Sign Up Anyway')"
  });
});
```

### ACCEPTANCE CRITERIA
- [ ] Landing page loads in under 2 seconds on 3G connections
- [ ] Supplier branding (logo, colors) displayed prominently
- [ ] Value propositions tailored to supplier type (photographer vs venue)
- [ ] Mobile-optimized with 60%+ of traffic expected on mobile
- [ ] OAuth signup with Google and Apple as primary options
- [ ] Conversion tracking for page views, signup clicks, and completions
- [ ] Performance: 90+ Lighthouse score on mobile
- [ ] Security: Invitation codes are cryptographically secure
- [ ] Accessibility: WCAG 2.1 AA compliant with screen reader support

### DEPENDENCIES
- Must complete after: None (foundational couple onboarding)
- Must complete before: WS-075 (Couple Signup) - landing page leads to signup flow
- Shares code with: WedMe authentication system, supplier branding

### ESTIMATED EFFORT
- Team A Frontend: 20 hours (Landing page UI, mobile optimization, branding system)
- Team C Integration: 12 hours (OAuth integration, invitation validation API)
- Team B Backend: 8 hours (Invitation analytics, conversion tracking)
- Total: 40 hours