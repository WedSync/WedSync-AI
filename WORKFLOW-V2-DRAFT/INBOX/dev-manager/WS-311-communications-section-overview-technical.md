# TECHNICAL SPECIFICATION: WS-311 - Communications Section Overview
## Generated by Feature Development Session - 2025-01-20

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding venue coordinator managing communication with 20+ couples across different wedding stages
**I want to:** Access a unified communications hub that handles email templates, SMS, WhatsApp, calendar scheduling, and message history from one interface
**So that:** I can eliminate switching between 5+ different apps (Gmail, phone SMS, WhatsApp Business, Calendly, spreadsheets) to communicate with couples throughout their wedding journey

**Real Wedding Scenario:**
"A wedding venue coordinator currently uses Gmail for formal communication, their phone for urgent SMS, WhatsApp Business for quick updates, Calendly for venue tours, and a spreadsheet to track what was sent when. With the communications hub, all client communication channels are centralized with templates, automated scheduling, and complete message history, reducing coordination errors and saving 2+ hours daily."

### SPECIFICATION SOURCE
- **Feature ID:** WS-311
- **Original Spec:** /CORE-SPECIFICATIONS/02-WEDSYNC-SUPPLIER-PLATFORM/06-Communications.md
- **Current Implementation:** 40% complete (basic email system exists)
- **Files to Modify:**
  - /wedsync/src/app/(dashboard)/communications/page.tsx
  - /wedsync/src/lib/webhooks/webhook-manager.ts
- **New Files to Create:**
  - /wedsync/src/components/communications/CommunicationsLayout.tsx
  - /wedsync/src/components/communications/UnifiedInbox.tsx
  - /wedsync/src/lib/services/communications-service.ts

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Communications channels configuration
CREATE TABLE IF NOT EXISTS communication_channels (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID NOT NULL REFERENCES user_profiles(id) ON DELETE CASCADE,
  channel_type VARCHAR(20) NOT NULL, -- 'email', 'sms', 'whatsapp', 'calendar'
  is_enabled BOOLEAN DEFAULT TRUE,
  configuration JSONB NOT NULL DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Message history across all channels
CREATE TABLE IF NOT EXISTS message_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID NOT NULL REFERENCES user_profiles(id) ON DELETE CASCADE,
  client_id UUID NOT NULL REFERENCES clients(id) ON DELETE CASCADE,
  channel_type VARCHAR(20) NOT NULL,
  direction VARCHAR(10) NOT NULL, -- 'inbound', 'outbound'
  subject VARCHAR(255),
  content TEXT,
  metadata JSONB DEFAULT '{}',
  sent_at TIMESTAMPTZ DEFAULT NOW(),
  read_at TIMESTAMPTZ,
  replied_at TIMESTAMPTZ
);

-- Email templates
CREATE TABLE IF NOT EXISTS email_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID NOT NULL REFERENCES user_profiles(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  subject VARCHAR(255) NOT NULL,
  html_content TEXT NOT NULL,
  text_content TEXT,
  variables JSONB DEFAULT '[]',
  category VARCHAR(50) DEFAULT 'general',
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### API Endpoints Required
```typescript
// GET /api/communications/overview
interface CommunicationsOverview {
  total_messages: number;
  unread_messages: number;
  channels_configured: string[];
  recent_conversations: ConversationSummary[];
  pending_meetings: MeetingSummary[];
}

// GET /api/communications/channels/{type}/config
interface ChannelConfiguration {
  channel_type: string;
  is_enabled: boolean;
  configuration: Record<string, any>;
  last_sync: string;
  status: 'active' | 'error' | 'pending_setup';
}

// POST /api/communications/send
interface SendMessageRequest {
  client_id: string;
  channel_type: 'email' | 'sms' | 'whatsapp';
  template_id?: string;
  subject?: string;
  content: string;
  variables?: Record<string, string>;
}
```

#### Frontend Components Required
```typescript
// Component: CommunicationsLayout
// Location: /src/components/communications/CommunicationsLayout.tsx

interface CommunicationsLayoutProps {
  children: React.ReactNode;
  currentSection: 'overview' | 'inbox' | 'templates' | 'calendar' | 'settings';
}

// Key functionality:
- Navigation between communication sections
- Channel status indicators (email/SMS/WhatsApp/calendar)
- Quick access to compose new messages
- Unread message count badges

// Component: UnifiedInbox
// Location: /src/components/communications/UnifiedInbox.tsx

interface UnifiedInboxProps {
  messages: Message[];
  onReply: (messageId: string, content: string) => void;
  onMarkRead: (messageId: string) => void;
  filters: InboxFilters;
}

// Key functionality:
- Unified view of messages across email, SMS, WhatsApp
- Thread view for conversation history
- Quick reply functionality
- Filter by client, channel, date range
- Message search across all channels
```

#### Integration Points
```typescript
// Service: CommunicationsService
// Dependencies: EmailService, SMSService, WhatsAppService, CalendarService

class CommunicationsService {
  async getOverview(supplierId: string): Promise<CommunicationsOverview> {
    // Aggregate communication statistics and activity
  }
  
  async sendMessage(request: SendMessageRequest): Promise<void> {
    // Send message through appropriate channel with template processing
  }
  
  async getUnifiedInbox(supplierId: string, filters: InboxFilters): Promise<Message[]> {
    // Load messages from all channels with unified formatting
  }
  
  async configureChannel(channelType: string, config: any): Promise<void> {
    // Set up communication channel (email SMTP, SMS API, WhatsApp Business)
  }
  
  async syncMessageHistory(channelType: string): Promise<void> {
    // Sync external message history (Gmail, WhatsApp Business API)
  }
}
```

### CODE EXAMPLES

#### Example 1: Unified Communications Hook
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabase';
import { useToast } from '@/components/ui/use-toast';

export function useCommunications(supplierId: string) {
  const [overview, setOverview] = useState<CommunicationsOverview | null>(null);
  const [messages, setMessages] = useState<Message[]>([]);
  const [channels, setChannels] = useState<ChannelConfiguration[]>([]);
  const [loading, setLoading] = useState(true);
  const { toast } = useToast();

  useEffect(() => {
    loadCommunicationsData();
    subscribeToMessages();
  }, [supplierId]);

  async function loadCommunicationsData() {
    try {
      setLoading(true);
      
      // Load overview
      const { data: overviewData } = await supabase
        .rpc('get_communications_overview', { supplier_id: supplierId });
      
      // Load recent messages
      const { data: messagesData } = await supabase
        .from('message_history')
        .select(`
          id, channel_type, direction, subject, content, sent_at, read_at,
          clients(couple_name)
        `)
        .eq('supplier_id', supplierId)
        .order('sent_at', { ascending: false })
        .limit(50);
      
      // Load channel configurations
      const { data: channelsData } = await supabase
        .from('communication_channels')
        .select('*')
        .eq('supplier_id', supplierId);
        
      setOverview(overviewData);
      setMessages(messagesData || []);
      setChannels(channelsData || []);
      
    } catch (error) {
      toast({
        title: "Error loading communications",
        description: "Please try refreshing the page",
        variant: "destructive"
      });
    } finally {
      setLoading(false);
    }
  }

  function subscribeToMessages() {
    const subscription = supabase
      .channel(`messages_${supplierId}`)
      .on('postgres_changes',
        { 
          event: 'INSERT', 
          schema: 'public', 
          table: 'message_history',
          filter: `supplier_id=eq.${supplierId}`
        },
        (payload) => {
          setMessages(prev => [payload.new as Message, ...prev]);
          // Update overview counters
          setOverview(prev => prev ? {
            ...prev,
            total_messages: prev.total_messages + 1,
            unread_messages: prev.unread_messages + (payload.new.direction === 'inbound' ? 1 : 0)
          } : null);
        }
      )
      .subscribe();

    return () => subscription.unsubscribe();
  }

  async function sendMessage(request: SendMessageRequest) {
    try {
      const response = await fetch('/api/communications/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(request)
      });

      if (response.ok) {
        toast({
          title: "Message sent",
          description: `${request.channel_type} sent successfully`
        });
        
        // Add to local state
        const newMessage: Message = {
          id: crypto.randomUUID(),
          supplier_id: supplierId,
          client_id: request.client_id,
          channel_type: request.channel_type,
          direction: 'outbound',
          subject: request.subject,
          content: request.content,
          sent_at: new Date().toISOString()
        };
        
        setMessages(prev => [newMessage, ...prev]);
      }
    } catch (error) {
      toast({
        title: "Failed to send message",
        variant: "destructive"
      });
    }
  }

  async function markAsRead(messageId: string) {
    try {
      const { error } = await supabase
        .from('message_history')
        .update({ read_at: new Date().toISOString() })
        .eq('id', messageId);

      if (!error) {
        setMessages(prev =>
          prev.map(msg =>
            msg.id === messageId ? { ...msg, read_at: new Date().toISOString() } : msg
          )
        );
      }
    } catch (error) {
      console.error('Failed to mark message as read:', error);
    }
  }

  return {
    overview,
    messages,
    channels,
    loading,
    sendMessage,
    markAsRead,
    refresh: loadCommunicationsData
  };
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for email APIs, SMS services
- [ ] Playwright: Test communication workflows
- [ ] Filesystem: Access email template files

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/sendgrid/sendgrid-nodejs", "email templates API", 2000);
await mcp__context7__get-library-docs("/twilio/twilio-node", "SMS WhatsApp integration", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('CommunicationsService', () => {
  it('should send email with template processing', async () => {
    const service = new CommunicationsService();
    const request = {
      client_id: 'client-123',
      channel_type: 'email' as const,
      template_id: 'welcome-template',
      variables: { couple_name: 'John & Jane', wedding_date: '2025-06-15' }
    };
    
    await service.sendMessage(request);
    // Verify email sent through provider
  });

  it('should aggregate message history across channels', async () => {
    const service = new CommunicationsService();
    const messages = await service.getUnifiedInbox('supplier-123', {});
    
    expect(messages.some(m => m.channel_type === 'email')).toBe(true);
    expect(messages.some(m => m.channel_type === 'sms')).toBe(true);
    expect(messages).toBeSorted((a, b) => new Date(b.sent_at).getTime() - new Date(a.sent_at).getTime());
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Communications unified inbox workflow', async () => {
  await mcp__playwright__browser_navigate({url: '/communications'});
  await mcp__playwright__browser_snapshot();
  
  // Test composing new message
  await mcp__playwright__browser_click({
    element: "Compose message button",
    ref: "[data-testid='compose-message']"
  });
  
  // Select communication channel
  await mcp__playwright__browser_select_option({
    element: "Channel selector",
    ref: "[data-testid='channel-select']",
    values: ["email"]
  });
  
  await mcp__playwright__browser_snapshot();
});
```

### ACCEPTANCE CRITERIA
- [ ] Unified inbox displays messages from email, SMS, WhatsApp in chronological order
- [ ] Email templates support variable substitution (couple names, wedding dates, etc.)
- [ ] SMS and WhatsApp integration for quick client communication
- [ ] Calendar integration for meeting scheduling and reminders
- [ ] Message search across all communication channels
- [ ] Bulk messaging capabilities for multiple clients
- [ ] Performance: Inbox loads 100+ messages in under 2 seconds
- [ ] Security: All communications are encrypted and access-controlled
- [ ] Accessibility: Communication interface supports screen readers

### DEPENDENCIES
- Must complete after: WS-310 (React Flow for journey integration)
- Must complete before: WS-312 (Client Dashboard Builder)
- Shares code with: Email service, SMS service, calendar integration, template system

### ESTIMATED EFFORT
- Team A Frontend: 24 hours
- Team B Backend: 20 hours
- Team C Integration: 16 hours
- Team D Platform: 4 hours
- Team E General: 6 hours
- Team F Workflows: 8 hours
- Team G Performance: 4 hours
- Total: 82 hours