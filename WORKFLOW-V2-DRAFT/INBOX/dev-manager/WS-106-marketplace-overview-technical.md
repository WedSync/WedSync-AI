# TECHNICAL SPECIFICATION: WS-106 - Marketplace Overview Structure
## Generated by Feature Development Session - August 22, 2025

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding photographer struggling to create effective client questionnaires after 3 inquiries converted poorly
**I want to:** Browse and purchase proven form templates from top-performing photographers in my market
**So that:** I can quickly implement questionnaires that have generated 6-figure photography bookings for other professionals

**Real Wedding Scenario:**
A new wedding photographer has spent 8 hours creating a client intake form, but only 2 of 15 couples who filled it out booked consultations. They discover the marketplace where a successful photographer from their city sells a "Luxury Wedding Photography Intake Suite" for ¬£47. This template generated ¬£340,000 in bookings last year with a 73% consultation-to-booking conversion rate. Within 30 minutes of purchase, the template is installed and customized with their branding. Their next 12 form submissions result in 9 consultation bookings, directly leading to 7 contracts worth ¬£84,000 - a 10,000% ROI on the template purchase.

### SPECIFICATION SOURCE
- **Feature ID:** WS-106
- **Original Spec:** /CORE-SPECIFICATIONS/05-MARKETPLACE/01-Structure/01-marketplace-overview md.md
- **Current Implementation:** 0% complete
- **Files to Modify:**
  - `/wedsync/lib/marketplace/templates.ts` (create new)
  - `/wedsync/lib/marketplace/purchases.ts` (create new)
- **New Files to Create:**
  - `/wedsync/src/app/(dashboard)/marketplace/page.tsx`
  - `/wedsync/src/app/(dashboard)/marketplace/templates/[id]/page.tsx`
  - `/wedsync/src/components/marketplace/MarketplaceLanding.tsx`
  - `/wedsync/src/components/marketplace/TemplateCard.tsx`
  - `/wedsync/src/components/marketplace/TemplateGrid.tsx`
  - `/wedsync/src/components/marketplace/CategoryFilter.tsx`
  - `/wedsync/src/components/marketplace/CreatorLeaderboard.tsx`
  - `/wedsync/src/components/marketplace/TemplatePreview.tsx`
  - `/wedsync/src/components/marketplace/PurchaseButton.tsx`
  - `/wedsync/app/api/marketplace/templates/route.ts`
  - `/wedsync/app/api/marketplace/templates/[id]/route.ts`
  - `/wedsync/app/api/marketplace/purchase/route.ts`
  - `/wedsync/app/api/marketplace/install/[purchase_id]/route.ts`
  - `/wedsync/lib/marketplace/search.ts`
  - `/wedsync/lib/marketplace/analytics.ts`
  - `/wedsync/supabase/migrations/20250822000007_marketplace_foundation.sql`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Core marketplace template system
CREATE TABLE IF NOT EXISTS marketplace_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID NOT NULL REFERENCES suppliers(id),
  title VARCHAR(255) NOT NULL,
  description TEXT NOT NULL,
  template_type VARCHAR(50) NOT NULL CHECK (template_type IN ('form', 'email_sequence', 'journey_workflow', 'bundle')),
  category VARCHAR(50) NOT NULL, -- 'photography', 'catering', 'venue', 'planning', 'florals', 'music'
  subcategory VARCHAR(50), -- 'engagement_forms', 'contract_templates', 'timeline_builders'
  
  -- Pricing and access
  price_cents INTEGER NOT NULL DEFAULT 0,
  currency VARCHAR(3) DEFAULT 'GBP',
  minimum_tier VARCHAR(20) DEFAULT 'starter' CHECK (minimum_tier IN ('starter', 'professional', 'scale')),
  
  -- Content and preview
  template_data JSONB NOT NULL, -- Encrypted template content
  preview_data JSONB DEFAULT '{}', -- Public structure preview
  preview_images TEXT[] DEFAULT '{}', -- S3 URLs for screenshots
  demo_url TEXT, -- Live demo link if applicable
  
  -- Performance metrics
  install_count INTEGER DEFAULT 0,
  view_count INTEGER DEFAULT 0,
  conversion_rate DECIMAL(5,4) DEFAULT 0.0000, -- views to purchases
  average_rating DECIMAL(3,2) DEFAULT 0.00,
  rating_count INTEGER DEFAULT 0,
  
  -- Status and quality
  status VARCHAR(20) DEFAULT 'draft' CHECK (status IN ('draft', 'pending_review', 'active', 'suspended', 'rejected')),
  quality_score INTEGER DEFAULT 0, -- 0-100 internal quality rating
  review_notes TEXT,
  reviewed_by UUID REFERENCES suppliers(id),
  reviewed_at TIMESTAMP WITH TIME ZONE,
  
  -- Wedding industry context
  target_wedding_types TEXT[] DEFAULT '{}', -- 'luxury', 'budget', 'destination', 'intimate'
  target_price_range VARCHAR(50), -- '¬£2k-5k', '¬£5k-10k', '¬£10k-20k', '¬£20k+'
  seasonal_relevance TEXT[] DEFAULT '{}', -- 'spring', 'summer', 'fall', 'winter'
  
  -- Metadata
  tags TEXT[] DEFAULT '{}',
  search_vector tsvector,
  featured BOOLEAN DEFAULT false,
  featured_until TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_marketplace_templates_status ON marketplace_templates(status, created_at DESC);
CREATE INDEX idx_marketplace_templates_category ON marketplace_templates(category, subcategory);
CREATE INDEX idx_marketplace_templates_tier ON marketplace_templates(minimum_tier, price_cents);
CREATE INDEX idx_marketplace_templates_performance ON marketplace_templates(install_count DESC, average_rating DESC);
CREATE INDEX idx_marketplace_templates_search ON marketplace_templates USING GIN (search_vector);
CREATE INDEX idx_marketplace_templates_supplier ON marketplace_templates(supplier_id, status);

-- Template purchases and installations
CREATE TABLE IF NOT EXISTS marketplace_purchases (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  template_id UUID NOT NULL REFERENCES marketplace_templates(id),
  buyer_id UUID NOT NULL REFERENCES suppliers(id),
  seller_id UUID NOT NULL REFERENCES suppliers(id),
  
  -- Transaction details
  price_paid_cents INTEGER NOT NULL,
  currency VARCHAR(3) DEFAULT 'GBP',
  commission_cents INTEGER NOT NULL, -- Platform commission (30%)
  seller_payout_cents INTEGER NOT NULL, -- Amount paid to seller
  
  -- Payment processing
  stripe_payment_intent_id VARCHAR(255),
  stripe_charge_id VARCHAR(255),
  payment_status VARCHAR(20) DEFAULT 'pending' CHECK (payment_status IN ('pending', 'completed', 'failed', 'refunded')),
  
  -- Installation tracking
  installed BOOLEAN DEFAULT false,
  installed_at TIMESTAMP WITH TIME ZONE,
  installation_data JSONB DEFAULT '{}', -- Track what was installed
  
  -- Refund and support
  refund_requested BOOLEAN DEFAULT false,
  refund_reason TEXT,
  refunded_at TIMESTAMP WITH TIME ZONE,
  refund_amount_cents INTEGER,
  
  -- Wedding context for analytics
  buyer_wedding_context JSONB DEFAULT '{}',
  purchase_source VARCHAR(50), -- 'search', 'featured', 'recommendation', 'creator_profile'
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_marketplace_purchases_template ON marketplace_purchases(template_id, created_at DESC);
CREATE INDEX idx_marketplace_purchases_buyer ON marketplace_purchases(buyer_id, created_at DESC);
CREATE INDEX idx_marketplace_purchases_seller ON marketplace_purchases(seller_id, payment_status, created_at DESC);
CREATE INDEX idx_marketplace_purchases_status ON marketplace_purchases(payment_status, installed);

-- Template ratings and reviews
CREATE TABLE IF NOT EXISTS marketplace_reviews (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  template_id UUID NOT NULL REFERENCES marketplace_templates(id),
  reviewer_id UUID NOT NULL REFERENCES suppliers(id),
  purchase_id UUID NOT NULL REFERENCES marketplace_purchases(id),
  
  -- Review content
  rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
  title VARCHAR(255),
  review_text TEXT,
  pros TEXT[] DEFAULT '{}',
  cons TEXT[] DEFAULT '{}',
  
  -- Business impact data
  business_impact_rating INTEGER CHECK (business_impact_rating >= 1 AND business_impact_rating <= 5),
  estimated_revenue_increase_percent INTEGER, -- Reported by reviewer
  time_saved_hours INTEGER, -- Hours saved using this template
  
  -- Status and moderation
  status VARCHAR(20) DEFAULT 'published' CHECK (status IN ('draft', 'published', 'flagged', 'removed')),
  helpful_votes INTEGER DEFAULT 0,
  flagged_as_fake BOOLEAN DEFAULT false,
  
  -- Wedding context
  reviewer_wedding_context JSONB DEFAULT '{}', -- Vendor type, typical client price range
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(template_id, reviewer_id) -- One review per buyer per template
);

CREATE INDEX idx_marketplace_reviews_template ON marketplace_reviews(template_id, status, rating DESC);
CREATE INDEX idx_marketplace_reviews_reviewer ON marketplace_reviews(reviewer_id, created_at DESC);

-- Template categories and tags system
CREATE TABLE IF NOT EXISTS marketplace_categories (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) UNIQUE NOT NULL,
  slug VARCHAR(100) UNIQUE NOT NULL,
  description TEXT,
  icon_name VARCHAR(50), -- For UI icons
  parent_id UUID REFERENCES marketplace_categories(id),
  sort_order INTEGER DEFAULT 0,
  template_count INTEGER DEFAULT 0, -- Cached count
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_marketplace_categories_parent ON marketplace_categories(parent_id, sort_order);
CREATE INDEX idx_marketplace_categories_active ON marketplace_categories(is_active, template_count DESC);

-- Wedding-specific marketplace analytics
CREATE TABLE IF NOT EXISTS marketplace_analytics_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  event_type VARCHAR(50) NOT NULL, -- 'view', 'click', 'purchase', 'install', 'review'
  template_id UUID REFERENCES marketplace_templates(id),
  user_id UUID REFERENCES suppliers(id),
  session_id VARCHAR(255),
  
  -- Event details
  event_data JSONB DEFAULT '{}',
  conversion_funnel_step VARCHAR(50), -- For tracking conversion paths
  
  -- Wedding business context
  user_vendor_type VARCHAR(50),
  user_tier VARCHAR(20),
  user_typical_wedding_budget VARCHAR(50),
  seasonal_context VARCHAR(20), -- 'peak', 'shoulder', 'off_season'
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_marketplace_analytics_template ON marketplace_analytics_events(template_id, event_type, created_at DESC);
CREATE INDEX idx_marketplace_analytics_user ON marketplace_analytics_events(user_id, created_at DESC);
CREATE INDEX idx_marketplace_analytics_funnel ON marketplace_analytics_events(template_id, conversion_funnel_step, created_at);
```

#### API Endpoints Required
```typescript
// GET /api/marketplace/templates
interface MarketplaceTemplatesRequest {
  category?: string;
  subcategory?: string;
  minPrice?: number;
  maxPrice?: number;
  minTier?: 'starter' | 'professional' | 'scale';
  sort?: 'popular' | 'newest' | 'price_low' | 'price_high' | 'rating';
  search?: string;
  page?: number;
  limit?: number;
  targetWeddingTypes?: string[];
  priceRange?: string;
}

interface MarketplaceTemplatesResponse {
  templates: Array<{
    id: string;
    title: string;
    description: string;
    templateType: string;
    category: string;
    subcategory: string;
    priceCents: number;
    currency: string;
    minimumTier: string;
    previewImages: string[];
    installCount: number;
    averageRating: number;
    ratingCount: number;
    creator: {
      id: string;
      businessName: string;
      vendorType: string;
      avatarUrl?: string;
    };
    featured: boolean;
    tags: string[];
    targetWeddingTypes: string[];
    targetPriceRange: string;
  }>;
  pagination: {
    page: number;
    limit: number;
    total: number;
    hasMore: boolean;
  };
  filters: {
    categories: Array<{ name: string; count: number }>;
    priceRanges: Array<{ range: string; count: number }>;
    tiers: Array<{ tier: string; count: number }>;
  };
}

// GET /api/marketplace/templates/:id
interface TemplateDetailsResponse {
  template: {
    id: string;
    title: string;
    description: string;
    templateType: string;
    category: string;
    subcategory: string;
    priceCents: number;
    currency: string;
    minimumTier: string;
    previewData: Record<string, any>; // Structure preview
    previewImages: string[];
    demoUrl?: string;
    installCount: number;
    viewCount: number;
    averageRating: number;
    ratingCount: number;
    tags: string[];
    targetWeddingTypes: string[];
    targetPriceRange: string;
    seasonalRelevance: string[];
    creator: {
      id: string;
      businessName: string;
      vendorType: string;
      avatarUrl?: string;
      totalTemplates: number;
      totalSales: number;
      averageRating: number;
    };
  };
  userContext: {
    canPurchase: boolean;
    tierUpgradeRequired?: string;
    alreadyPurchased: boolean;
    purchaseId?: string;
    installedVersion?: boolean;
  };
  similarTemplates: Array<{
    id: string;
    title: string;
    priceCents: number;
    averageRating: number;
    installCount: number;
  }>;
}

// POST /api/marketplace/purchase
interface PurchaseTemplateRequest {
  templateId: string;
  paymentMethodId?: string; // Stripe payment method
  savePaymentMethod?: boolean;
}

interface PurchaseTemplateResponse {
  success: boolean;
  purchaseId: string;
  clientSecret?: string; // For Stripe confirmation if required
  requiresAction?: boolean;
  confirmationUrl?: string;
  installationAvailable: boolean;
  message: string;
}

// POST /api/marketplace/install/:purchaseId
interface InstallTemplateRequest {
  customizations?: {
    brandingColors?: string[];
    businessName?: string;
    contactInfo?: Record<string, string>;
  };
  installationOptions?: {
    createCopy?: boolean;
    overwriteExisting?: boolean;
    targetFolderId?: string;
  };
}

interface InstallTemplateResponse {
  success: boolean;
  installedItems: Array<{
    type: 'form' | 'email_template' | 'journey_workflow';
    id: string;
    name: string;
    url: string;
  }>;
  message: string;
  setupInstructions?: string[];
}

// GET /api/marketplace/analytics/popular
interface PopularTemplatesResponse {
  trending: Array<{
    id: string;
    title: string;
    category: string;
    installCount: number;
    weeklyGrowthPercent: number;
  }>;
  featured: Array<{
    id: string;
    title: string;
    featuredReason: string;
    previewImage: string;
  }>;
  recommendations: Array<{
    id: string;
    title: string;
    recommendationReason: string;
    relevanceScore: number;
  }>;
}
```

#### Frontend Components Required
```typescript
// Component: MarketplaceLanding
// Location: /src/components/marketplace/MarketplaceLanding.tsx

interface Props {
  initialCategory?: string;
  userTier: 'starter' | 'professional' | 'scale';
  vendorType: string;
}

// Key functionality:
- Hero section showcasing top templates
- Category navigation with visual icons
- Featured templates carousel
- Search and filter interface
- Creator spotlight section
- Success story testimonials

// Component: TemplateCard
// Location: /src/components/marketplace/TemplateCard.tsx

interface Props {
  template: MarketplaceTemplate;
  onView: (templateId: string) => void;
  onPurchase: (templateId: string) => void;
  showCreator?: boolean;
  size?: 'compact' | 'standard' | 'detailed';
}

// Key functionality:
- Template preview with image carousel
- Pricing with tier requirement badges
- Creator information and reputation
- Purchase button with tier validation
- Quick preview modal trigger
- Performance metrics display

// Component: TemplateGrid
// Location: /src/components/marketplace/TemplateGrid.tsx

interface Props {
  templates: MarketplaceTemplate[];
  loading: boolean;
  onLoadMore: () => void;
  hasMore: boolean;
  gridLayout?: 'masonry' | 'uniform';
}

// Key functionality:
- Responsive grid layout with virtual scrolling
- Infinite scroll with load more button
- Skeleton loading states
- Sort and filter controls
- Empty state with search suggestions

// Component: CategoryFilter
// Location: /src/components/marketplace/CategoryFilter.tsx

interface Props {
  categories: Category[];
  selectedCategory?: string;
  selectedSubcategory?: string;
  onCategoryChange: (category: string, subcategory?: string) => void;
  templateCounts: Record<string, number>;
}

// Key functionality:
- Hierarchical category navigation
- Template count indicators
- Popular categories highlighting
- Mobile-friendly collapsed view
- Search within categories

// Component: CreatorLeaderboard
// Location: /src/components/marketplace/CreatorLeaderboard.tsx

interface Props {
  period: 'week' | 'month' | 'all_time';
  limit?: number;
  showEarnings?: boolean;
}

// Key functionality:
- Top creators by sales/ratings
- Creator profile links
- Earnings highlights (if authorized)
- Follow/subscribe functionality
- Wedding industry specializations
```

#### Integration Points
```typescript
// Service: MarketplaceService
// Dependencies: Stripe, Supabase, file storage, search engine

class MarketplaceService {
  async searchTemplates(
    query: string,
    filters: MarketplaceFilters,
    userContext: UserContext
  ): Promise<SearchResults> {
    // 1. Build full-text search query with filters
    // 2. Apply tier-based access restrictions
    // 3. Personalize results based on vendor type
    // 4. Track search analytics
    // 5. Return paginated results with facets
  }
  
  async purchaseTemplate(
    templateId: string,
    buyerId: string,
    paymentMethodId: string
  ): Promise<PurchaseResult> {
    // 1. Validate tier access and pricing
    // 2. Create Stripe payment intent
    // 3. Process payment with commission split
    // 4. Create purchase record
    // 5. Notify creator and buyer
    // 6. Enable installation access
  }
  
  async installTemplate(
    purchaseId: string,
    customizations: Customizations
  ): Promise<InstallationResult> {
    // 1. Verify purchase ownership
    // 2. Deep clone template with new IDs
    // 3. Apply branding customizations
    // 4. Install into buyer's account
    // 5. Update analytics and usage metrics
  }
}

// Service: TemplateProcessor
// Dependencies: Form system, email templates, journey workflows

class TemplateProcessor {
  async validateTemplate(
    templateData: any,
    templateType: string
  ): Promise<ValidationResult> {
    // Validate template structure and content
    // Check for appropriate wedding industry context
    // Ensure no inappropriate or copyrighted content
    // Verify technical compatibility
  }
  
  async generatePreview(
    templateData: any,
    templateType: string
  ): Promise<PreviewData> {
    // Create safe preview without sensitive content
    // Generate screenshots for visual preview
    // Extract key metrics and features
    // Create demo experience if applicable
  }
}

// Hook: useMarketplace
export function useMarketplace() {
  // Template search and filtering
  // Purchase flow management
  // Installation progress tracking
  // User tier validation
}

// Hook: useTemplatePreview
export function useTemplatePreview(templateId: string) {
  // Template details loading
  // Preview image handling
  // Demo interaction
  // Purchase eligibility checking
}
```

### CODE EXAMPLES

#### Example 1: Marketplace Landing Page Component
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';

interface MarketplaceTemplate {
  id: string;
  title: string;
  description: string;
  templateType: string;
  category: string;
  priceCents: number;
  currency: string;
  minimumTier: string;
  previewImages: string[];
  installCount: number;
  averageRating: number;
  ratingCount: number;
  creator: {
    id: string;
    businessName: string;
    vendorType: string;
    avatarUrl?: string;
  };
  featured: boolean;
  tags: string[];
}

interface Props {
  userTier: 'starter' | 'professional' | 'scale';
  vendorType: string;
}

export function MarketplaceLanding({ userTier, vendorType }: Props) {
  const [templates, setTemplates] = useState<MarketplaceTemplate[]>([]);
  const [featuredTemplates, setFeaturedTemplates] = useState<MarketplaceTemplate[]>([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedCategory, setSelectedCategory] = useState<string>('all');
  const [loading, setLoading] = useState(true);
  
  const categories = [
    { id: 'all', name: 'All Templates', icon: 'üìÑ', count: 0 },
    { id: 'photography', name: 'Photography', icon: 'üì∏', count: 0 },
    { id: 'catering', name: 'Catering', icon: 'üçΩÔ∏è', count: 0 },
    { id: 'venue', name: 'Venues', icon: 'üè∞', count: 0 },
    { id: 'planning', name: 'Planning', icon: 'üìã', count: 0 },
    { id: 'florals', name: 'Florals', icon: 'üå∏', count: 0 },
    { id: 'music', name: 'Music & DJ', icon: 'üéµ', count: 0 }
  ];
  
  useEffect(() => {
    fetchTemplates();
    fetchFeaturedTemplates();
  }, [selectedCategory, searchQuery]);
  
  const fetchTemplates = async () => {
    setLoading(true);
    try {
      const params = new URLSearchParams({
        ...(selectedCategory !== 'all' && { category: selectedCategory }),
        ...(searchQuery && { search: searchQuery }),
        sort: 'popular',
        limit: '12'
      });
      
      const response = await fetch(`/api/marketplace/templates?${params}`);
      const data = await response.json();
      setTemplates(data.templates);
    } catch (error) {
      console.error('Failed to fetch templates:', error);
    } finally {
      setLoading(false);
    }
  };
  
  const fetchFeaturedTemplates = async () => {
    try {
      const response = await fetch('/api/marketplace/analytics/popular');
      const data = await response.json();
      setFeaturedTemplates(data.featured || []);
    } catch (error) {
      console.error('Failed to fetch featured templates:', error);
    }
  };
  
  const formatPrice = (priceCents: number, currency: string): string => {
    const price = priceCents / 100;
    const formatter = new Intl.NumberFormat('en-GB', {
      style: 'currency',
      currency: currency || 'GBP'
    });
    return formatter.format(price);
  };
  
  const canAccessTemplate = (template: MarketplaceTemplate): boolean => {
    const tierLevels = { starter: 1, professional: 2, scale: 3 };
    const userLevel = tierLevels[userTier];
    const requiredLevel = tierLevels[template.minimumTier as keyof typeof tierLevels];
    return userLevel >= requiredLevel;
  };
  
  const getPersonalizedRecommendation = (template: MarketplaceTemplate): string | null => {
    if (template.creator.vendorType === vendorType) {
      return 'From your industry';
    }
    if (template.tags.includes(vendorType)) {
      return 'Relevant to your business';
    }
    if (template.installCount > 100 && template.averageRating > 4.5) {
      return 'Highly rated';
    }
    return null;
  };
  
  return (
    <div className="space-y-8 p-6">
      {/* Hero Section */}
      <div className="text-center py-12 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg">
        <h1 className="text-4xl font-bold mb-4">
          Wedding Business Templates
        </h1>
        <p className="text-xl text-muted-foreground mb-6 max-w-2xl mx-auto">
          Proven forms, email sequences, and workflows from top-performing wedding vendors.
          Save time and increase bookings with templates that work.
        </p>
        <div className="flex items-center max-w-md mx-auto space-x-2">
          <Input
            type="text"
            placeholder="Search templates..."
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            className="flex-1"
          />
          <Button onClick={fetchTemplates}>
            Search
          </Button>
        </div>
      </div>
      
      {/* Featured Templates */}
      {featuredTemplates.length > 0 && (
        <section>
          <h2 className="text-2xl font-bold mb-4">Featured This Week</h2>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            {featuredTemplates.slice(0, 3).map(template => (
              <Card key={template.id} className="hover:shadow-lg transition-shadow">
                <div className="relative">
                  {template.previewImages[0] && (
                    <img
                      src={template.previewImages[0]}
                      alt={template.title}
                      className="w-full h-48 object-cover rounded-t-lg"
                    />
                  )}
                  <Badge className="absolute top-2 right-2 bg-orange-500">
                    Featured
                  </Badge>
                </div>
                <CardHeader>
                  <CardTitle className="text-lg">{template.title}</CardTitle>
                  <p className="text-sm text-muted-foreground">
                    by {template.creator.businessName}
                  </p>
                </CardHeader>
                <CardContent>
                  <div className="flex items-center justify-between">
                    <div>
                      <span className="text-lg font-bold">
                        {formatPrice(template.priceCents, template.currency)}
                      </span>
                      <div className="flex items-center mt-1">
                        <span className="text-yellow-400">‚≠ê</span>
                        <span className="text-sm ml-1">
                          {template.averageRating.toFixed(1)} ({template.ratingCount})
                        </span>
                      </div>
                    </div>
                    <Button
                      size="sm"
                      disabled={!canAccessTemplate(template)}
                      onClick={() => window.location.href = `/marketplace/templates/${template.id}`}
                    >
                      View Details
                    </Button>
                  </div>
                  {!canAccessTemplate(template) && (
                    <Badge variant="outline" className="mt-2">
                      Requires {template.minimumTier} tier
                    </Badge>
                  )}
                </CardContent>
              </Card>
            ))}
          </div>
        </section>
      )}
      
      {/* Category Navigation */}
      <section>
        <h2 className="text-2xl font-bold mb-4">Browse by Category</h2>
        <Tabs value={selectedCategory} onValueChange={setSelectedCategory}>
          <TabsList className="grid w-full grid-cols-7">
            {categories.map(category => (
              <TabsTrigger key={category.id} value={category.id} className="flex items-center space-x-2">
                <span>{category.icon}</span>
                <span className="hidden sm:inline">{category.name}</span>
              </TabsTrigger>
            ))}
          </TabsList>
          
          <TabsContent value={selectedCategory} className="mt-6">
            {loading ? (
              <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                {Array.from({ length: 8 }).map((_, index) => (
                  <Card key={index} className="animate-pulse">
                    <div className="w-full h-48 bg-gray-200 rounded-t-lg"></div>
                    <CardHeader>
                      <div className="h-4 bg-gray-200 rounded w-3/4"></div>
                      <div className="h-3 bg-gray-200 rounded w-1/2"></div>
                    </CardHeader>
                    <CardContent>
                      <div className="h-3 bg-gray-200 rounded w-1/4"></div>
                    </CardContent>
                  </Card>
                ))}
              </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                {templates.map(template => {
                  const recommendation = getPersonalizedRecommendation(template);
                  return (
                    <Card key={template.id} className="hover:shadow-lg transition-shadow cursor-pointer">
                      <div className="relative">
                        {template.previewImages[0] && (
                          <img
                            src={template.previewImages[0]}
                            alt={template.title}
                            className="w-full h-48 object-cover rounded-t-lg"
                          />
                        )}
                        {recommendation && (
                          <Badge className="absolute top-2 right-2 bg-green-500">
                            {recommendation}
                          </Badge>
                        )}
                      </div>
                      <CardHeader className="pb-2">
                        <CardTitle className="text-base line-clamp-2">
                          {template.title}
                        </CardTitle>
                        <div className="flex items-center justify-between text-sm text-muted-foreground">
                          <span>by {template.creator.businessName}</span>
                          <span>{template.installCount} installs</span>
                        </div>
                      </CardHeader>
                      <CardContent>
                        <div className="flex items-center justify-between">
                          <div>
                            <span className="font-bold">
                              {formatPrice(template.priceCents, template.currency)}
                            </span>
                            <div className="flex items-center">
                              <span className="text-yellow-400 text-sm">‚≠ê</span>
                              <span className="text-sm ml-1">
                                {template.averageRating.toFixed(1)}
                              </span>
                            </div>
                          </div>
                          <Button
                            size="sm"
                            variant={canAccessTemplate(template) ? "default" : "outline"}
                            disabled={!canAccessTemplate(template)}
                            onClick={() => window.location.href = `/marketplace/templates/${template.id}`}
                          >
                            {canAccessTemplate(template) ? 'View' : 'Locked'}
                          </Button>
                        </div>
                        {!canAccessTemplate(template) && (
                          <Badge variant="outline" className="mt-2 text-xs">
                            Requires {template.minimumTier} tier
                          </Badge>
                        )}
                      </CardContent>
                    </Card>
                  );
                })}
              </div>
            )}
            
            {!loading && templates.length === 0 && (
              <div className="text-center py-12">
                <p className="text-muted-foreground mb-4">
                  No templates found{searchQuery && ` for "${searchQuery}"`}
                </p>
                <Button variant="outline" onClick={() => {
                  setSearchQuery('');
                  setSelectedCategory('all');
                }}>
                  Clear Filters
                </Button>
              </div>
            )}
          </TabsContent>
        </Tabs>
      </section>
      
      {/* Success Stories */}
      <section className="bg-green-50 rounded-lg p-8">
        <h2 className="text-2xl font-bold mb-4 text-center">Success Stories</h2>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div className="text-center">
            <div className="text-3xl font-bold text-green-600 mb-2">¬£340k</div>
            <p className="text-sm text-muted-foreground">
              Revenue generated using our top-rated photography intake form
            </p>
          </div>
          <div className="text-center">
            <div className="text-3xl font-bold text-blue-600 mb-2">73%</div>
            <p className="text-sm text-muted-foreground">
              Average conversion rate improvement after template installation
            </p>
          </div>
          <div className="text-center">
            <div className="text-3xl font-bold text-purple-600 mb-2">12hr</div>
            <p className="text-sm text-muted-foreground">
              Average time saved per template vs. building from scratch
            </p>
          </div>
        </div>
      </section>
    </div>
  );
}
```

#### Example 2: Template Purchase and Installation Service
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { createClient } from '@supabase/supabase-js';
import Stripe from 'stripe';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2023-10-16'
});

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_KEY!
);

export class MarketplaceService {
  async purchaseTemplate(
    templateId: string,
    buyerId: string,
    paymentMethodId: string
  ): Promise<{
    success: boolean;
    purchaseId?: string;
    clientSecret?: string;
    message: string;
  }> {
    try {
      // 1. Get template and validate access
      const { data: template, error: templateError } = await supabase
        .from('marketplace_templates')
        .select(`
          id, title, price_cents, currency, minimum_tier, supplier_id,
          supplier:suppliers(id, business_name, tier)
        `)
        .eq('id', templateId)
        .eq('status', 'active')
        .single();
      
      if (templateError || !template) {
        return { success: false, message: 'Template not found or unavailable' };
      }
      
      // 2. Get buyer information and validate tier access
      const { data: buyer, error: buyerError } = await supabase
        .from('suppliers')
        .select('id, business_name, tier, stripe_customer_id')
        .eq('id', buyerId)
        .single();
      
      if (buyerError || !buyer) {
        return { success: false, message: 'Buyer account not found' };
      }
      
      // 3. Check tier access
      const tierLevels = { starter: 1, professional: 2, scale: 3 };
      const buyerLevel = tierLevels[buyer.tier as keyof typeof tierLevels] || 0;
      const requiredLevel = tierLevels[template.minimum_tier as keyof typeof tierLevels] || 1;
      
      if (buyerLevel < requiredLevel) {
        return {
          success: false,
          message: `This template requires ${template.minimum_tier} tier or higher`
        };
      }
      
      // 4. Check if already purchased
      const { data: existingPurchase } = await supabase
        .from('marketplace_purchases')
        .select('id')
        .eq('template_id', templateId)
        .eq('buyer_id', buyerId)
        .eq('payment_status', 'completed')
        .single();
      
      if (existingPurchase) {
        return { success: false, message: 'You have already purchased this template' };
      }
      
      // 5. Calculate pricing with commission
      const totalAmount = template.price_cents;
      const commissionRate = 0.30; // 30% platform commission
      const commissionAmount = Math.round(totalAmount * commissionRate);
      const sellerAmount = totalAmount - commissionAmount;
      
      // 6. Create purchase record
      const { data: purchase, error: purchaseError } = await supabase
        .from('marketplace_purchases')
        .insert({
          template_id: templateId,
          buyer_id: buyerId,
          seller_id: template.supplier_id,
          price_paid_cents: totalAmount,
          currency: template.currency,
          commission_cents: commissionAmount,
          seller_payout_cents: sellerAmount,
          payment_status: 'pending'
        })
        .select()
        .single();
      
      if (purchaseError || !purchase) {
        return { success: false, message: 'Failed to create purchase record' };
      }
      
      // 7. Create Stripe payment intent
      const paymentIntent = await stripe.paymentIntents.create({
        amount: totalAmount,
        currency: template.currency.toLowerCase(),
        customer: buyer.stripe_customer_id,
        payment_method: paymentMethodId,
        confirmation_method: 'manual',
        confirm: true,
        return_url: `${process.env.NEXT_PUBLIC_BASE_URL}/marketplace/purchase-complete`,
        metadata: {
          purchase_id: purchase.id,
          template_id: templateId,
          buyer_id: buyerId,
          seller_id: template.supplier_id
        },
        application_fee_amount: commissionAmount,
        on_behalf_of: template.supplier.stripe_account_id, // For Stripe Connect
        transfer_data: {
          destination: template.supplier.stripe_account_id
        }
      });
      
      // 8. Update purchase with Stripe details
      await supabase
        .from('marketplace_purchases')
        .update({
          stripe_payment_intent_id: paymentIntent.id,
          payment_status: paymentIntent.status === 'succeeded' ? 'completed' : 'pending'
        })
        .eq('id', purchase.id);
      
      // 9. Handle payment status
      if (paymentIntent.status === 'succeeded') {
        // Payment completed immediately
        await this.handleSuccessfulPayment(purchase.id, paymentIntent.id);
        
        return {
          success: true,
          purchaseId: purchase.id,
          message: 'Purchase completed successfully! You can now install the template.'
        };
      } else if (paymentIntent.status === 'requires_action') {
        // 3D Secure or other authentication required
        return {
          success: true,
          purchaseId: purchase.id,
          clientSecret: paymentIntent.client_secret!,
          message: 'Additional authentication required'
        };
      } else {
        // Payment failed
        await supabase
          .from('marketplace_purchases')
          .update({ payment_status: 'failed' })
          .eq('id', purchase.id);
        
        return { success: false, message: 'Payment failed. Please try again.' };
      }
      
    } catch (error) {
      console.error('Purchase error:', error);
      return { success: false, message: 'An error occurred during purchase' };
    }
  }
  
  async installTemplate(
    purchaseId: string,
    buyerId: string,
    customizations?: {
      brandingColors?: string[];
      businessName?: string;
      contactInfo?: Record<string, string>;
    }
  ): Promise<{
    success: boolean;
    installedItems?: Array<{
      type: string;
      id: string;
      name: string;
      url: string;
    }>;
    message: string;
  }> {
    try {
      // 1. Verify purchase ownership and status
      const { data: purchase, error: purchaseError } = await supabase
        .from('marketplace_purchases')
        .select(`
          id, template_id, installed,
          template:marketplace_templates(
            id, title, template_type, template_data, supplier_id
          )
        `)
        .eq('id', purchaseId)
        .eq('buyer_id', buyerId)
        .eq('payment_status', 'completed')
        .single();
      
      if (purchaseError || !purchase) {
        return { success: false, message: 'Purchase not found or not completed' };
      }
      
      if (purchase.installed) {
        return { success: false, message: 'Template already installed' };
      }
      
      // 2. Decrypt and process template data
      const templateData = purchase.template.template_data;
      const installedItems: Array<{
        type: string;
        id: string;
        name: string;
        url: string;
      }> = [];
      
      // 3. Install based on template type
      switch (purchase.template.template_type) {
        case 'form':
          const formResult = await this.installFormTemplate(
            templateData,
            buyerId,
            customizations
          );
          installedItems.push(...formResult);
          break;
          
        case 'email_sequence':
          const emailResult = await this.installEmailTemplate(
            templateData,
            buyerId,
            customizations
          );
          installedItems.push(...emailResult);
          break;
          
        case 'journey_workflow':
          const journeyResult = await this.installJourneyTemplate(
            templateData,
            buyerId,
            customizations
          );
          installedItems.push(...journeyResult);
          break;
          
        case 'bundle':
          // Install multiple template types
          for (const subTemplate of templateData.templates) {
            const subResult = await this.installSubTemplate(
              subTemplate,
              buyerId,
              customizations
            );
            installedItems.push(...subResult);
          }
          break;
          
        default:
          return { success: false, message: 'Unknown template type' };
      }
      
      // 4. Mark as installed and update analytics
      await supabase
        .from('marketplace_purchases')
        .update({
          installed: true,
          installed_at: new Date().toISOString(),
          installation_data: { installedItems, customizations }
        })
        .eq('id', purchaseId);
      
      // 5. Update template install count
      await supabase.rpc('increment_template_installs', {
        template_id: purchase.template_id
      });
      
      // 6. Track analytics event
      await this.trackMarketplaceEvent('install', {
        templateId: purchase.template_id,
        userId: buyerId,
        purchaseId: purchase.id,
        itemsInstalled: installedItems.length
      });
      
      return {
        success: true,
        installedItems,
        message: `${purchase.template.title} installed successfully! Check your dashboard to start using it.`
      };
      
    } catch (error) {
      console.error('Installation error:', error);
      return { success: false, message: 'Failed to install template' };
    }
  }
  
  private async installFormTemplate(
    templateData: any,
    buyerId: string,
    customizations?: any
  ) {
    // Create a new form based on template structure
    const { data: newForm, error } = await supabase
      .from('forms')
      .insert({
        supplier_id: buyerId,
        title: `${templateData.title} (Copy)`,
        description: templateData.description,
        form_fields: this.customizeFormFields(templateData.fields, customizations),
        settings: {
          ...templateData.settings,
          branding: customizations?.brandingColors ? {
            primaryColor: customizations.brandingColors[0],
            secondaryColor: customizations.brandingColors[1]
          } : templateData.settings.branding
        },
        status: 'draft'
      })
      .select()
      .single();
    
    if (error) throw error;
    
    return [{
      type: 'form',
      id: newForm.id,
      name: newForm.title,
      url: `/forms/${newForm.id}/edit`
    }];
  }
  
  private async handleSuccessfulPayment(purchaseId: string, chargeId: string) {
    // Update purchase status
    await supabase
      .from('marketplace_purchases')
      .update({
        payment_status: 'completed',
        stripe_charge_id: chargeId
      })
      .eq('id', purchaseId);
    
    // Send notification emails to buyer and seller
    // Update seller earnings
    // Track revenue analytics
  }
  
  private async trackMarketplaceEvent(
    eventType: string,
    data: Record<string, any>
  ) {
    await supabase
      .from('marketplace_analytics_events')
      .insert({
        event_type: eventType,
        template_id: data.templateId,
        user_id: data.userId,
        event_data: data
      });
  }
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [ ] Context7: Load docs for Stripe Connect, e-commerce patterns
- [ ] PostgreSQL: Create marketplace database schema
- [ ] Filesystem: Create marketplace components and services

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/stripe/stripe-node", "marketplace payments", 2000);
await mcp__context7__get-library-docs("/vercel/commerce", "template marketplace", 1500);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('Marketplace Foundation', () => {
  it('should create template listings with proper validation', () => {
    // Test template creation and validation
  });
  
  it('should handle purchase flow with commission calculation', () => {
    // Test purchase processing and commission splits
  });
  
  it('should install templates with customization', () => {
    // Test template installation and customization
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('User can browse and purchase marketplace template', async () => {
  await mcp__playwright__browser_navigate({url: '/marketplace'});
  await mcp__playwright__browser_click({element: 'template card', ref: '[data-template-id="123"]'});
  await mcp__playwright__browser_click({element: 'purchase button', ref: '[data-action="purchase"]'});
  // Verify purchase flow completion
});
```

### ACCEPTANCE CRITERIA
- [ ] Templates display with proper pricing and tier restrictions
- [ ] Purchase flow processes payments and calculates commissions correctly
- [ ] Template installation creates working copies in buyer's account
- [ ] Search and filtering work with wedding industry categories
- [ ] Performance: Marketplace loads under 2 seconds on 3G connections
- [ ] Security: Template content is encrypted and access-controlled
- [ ] Accessibility: All marketplace components are screen reader accessible

### DEPENDENCIES
- Must complete after: Subscription tiers (WS-071), Stripe setup (WS-076)
- Must complete before: Template builder (WS-111), purchase flow (WS-115)
- Shares code with: Form system (WS-031), email templates, payment processing

### ESTIMATED EFFORT
- Team A Frontend: 22 hours (marketplace UI, template cards, search interface, installation flow)
- Team B Backend: 24 hours (database schema, API endpoints, purchase processing, template installation)
- Team C Integration: 12 hours (Stripe Connect setup, payment flow, commission handling)
- Total: 58 hours