# TECHNICAL SPECIFICATION: WS-080 - Form Response Analytics
## Generated by Feature Development Session - August 22, 2025

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding venue sales manager with 40% form abandonment rate
**I want to:** See exactly where couples drop off in my 12-question booking inquiry form
**So that:** I can simplify the process and capture 60% more leads (currently losing $180K annually to abandoned forms)

**Real Wedding Scenario:**
A venue's booking form asks for wedding date, guest count, budget, contact info, then dives into detailed preferences. Analytics show 78% complete the first 4 fields, but only 22% finish after the "Preferred menu style" question. The venue realizes couples feel overwhelmed by detailed menu questions before knowing if their date is available. They move menu questions to after date confirmation and see completion rates jump to 67%.

### SPECIFICATION SOURCE
- **Feature ID:** WS-080
- **Original Spec:** Track form completion rates and user behavior
- **Current Implementation:** 0% complete
- **Files to Modify:**
  - /wedsync/src/app/(dashboard)/layout.tsx (add analytics menu)
  - /wedsync/src/components/forms/FormBuilder.tsx (add tracking)
- **New Files to Create:**
  - /wedsync/src/app/(dashboard)/analytics/forms/page.tsx
  - /wedsync/src/app/(dashboard)/analytics/forms/[formId]/page.tsx
  - /wedsync/src/app/api/analytics/forms/route.ts
  - /wedsync/src/app/api/analytics/forms/[formId]/events/route.ts
  - /wedsync/src/app/api/forms/tracking/route.ts
  - /wedsync/src/components/analytics/FormAnalyticsDashboard.tsx
  - /wedsync/src/components/analytics/FormFunnelChart.tsx
  - /wedsync/src/components/analytics/FieldAnalyticsTable.tsx
  - /wedsync/src/lib/analytics/formTracking.ts
  - /wedsync/src/lib/services/analyticsService.ts

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Form definitions
CREATE TABLE IF NOT EXISTS forms (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  vendor_id UUID NOT NULL REFERENCES auth.users(id),
  form_name VARCHAR(255) NOT NULL,
  form_type VARCHAR(50) DEFAULT 'inquiry', -- 'inquiry', 'booking', 'questionnaire'
  form_structure JSONB NOT NULL, -- Fields, validation, logic
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Form submissions
CREATE TABLE IF NOT EXISTS form_submissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  form_id UUID NOT NULL REFERENCES forms(id),
  session_id VARCHAR(255) NOT NULL,
  user_email VARCHAR(255),
  is_completed BOOLEAN DEFAULT false,
  completion_time INTEGER, -- seconds to complete
  submitted_at TIMESTAMP WITH TIME ZONE,
  started_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  user_agent TEXT,
  ip_address INET,
  referrer VARCHAR(500),
  form_data JSONB DEFAULT '{}' -- Actual form responses
);

-- Field interaction events
CREATE TABLE IF NOT EXISTS form_field_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  submission_id UUID NOT NULL REFERENCES form_submissions(id) ON DELETE CASCADE,
  field_name VARCHAR(255) NOT NULL,
  field_type VARCHAR(50) NOT NULL,
  event_type VARCHAR(50) NOT NULL, -- 'focus', 'blur', 'change', 'error'
  field_value TEXT, -- Current value when event occurred
  time_spent INTEGER, -- milliseconds focused on field
  error_message TEXT, -- For validation errors
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Form abandonment tracking
CREATE TABLE IF NOT EXISTS form_abandonments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  submission_id UUID NOT NULL REFERENCES form_submissions(id),
  last_field VARCHAR(255) NOT NULL,
  fields_completed INTEGER NOT NULL,
  total_fields INTEGER NOT NULL,
  time_spent INTEGER NOT NULL, -- Total seconds on form
  abandonment_reason VARCHAR(100), -- 'timeout', 'navigation', 'close'
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- A/B test experiments for forms
CREATE TABLE IF NOT EXISTS form_experiments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  form_id UUID NOT NULL REFERENCES forms(id),
  experiment_name VARCHAR(255) NOT NULL,
  variant_a JSONB NOT NULL, -- Original form structure
  variant_b JSONB NOT NULL, -- Modified form structure
  traffic_split DECIMAL(3,2) DEFAULT 0.50, -- 50/50 split
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  ended_at TIMESTAMP WITH TIME ZONE
);

CREATE INDEX idx_form_submissions_form ON form_submissions(form_id);
CREATE INDEX idx_form_submissions_session ON form_submissions(session_id);
CREATE INDEX idx_form_field_events_submission ON form_field_events(submission_id);
CREATE INDEX idx_form_field_events_field ON form_field_events(field_name);
CREATE INDEX idx_form_abandonments_field ON form_abandonments(last_field);
```

#### API Endpoints Required
```typescript
// GET /api/analytics/forms - Get form analytics overview
interface FormAnalyticsResponse {
  forms: {
    id: string;
    name: string;
    totalSubmissions: number;
    completionRate: number;
    averageCompletionTime: number;
    abandonmentRate: number;
    lastSubmissionDate: string;
  }[];
}

// GET /api/analytics/forms/[id] - Detailed form analytics
interface FormDetailAnalyticsResponse {
  form: {
    id: string;
    name: string;
    structure: FormField[];
  };
  metrics: {
    totalSubmissions: number;
    completedSubmissions: number;
    completionRate: number;
    averageCompletionTime: number;
    conversionFunnel: FunnelStep[];
  };
  fieldAnalytics: {
    fieldName: string;
    fieldType: string;
    focusRate: number; // % who clicked/focused
    completionRate: number; // % who filled and moved on
    averageTimeSpent: number;
    errorRate: number;
    commonErrors: string[];
    abandonmentRate: number; // % who abandoned at this field
  }[];
  timeAnalysis: {
    hourlySubmissions: { hour: number; count: number }[];
    dailySubmissions: { date: string; count: number }[];
  };
}

// POST /api/forms/tracking - Track form interaction event
interface FormTrackingRequest {
  sessionId: string;
  formId: string;
  eventType: 'form_start' | 'field_focus' | 'field_blur' | 'field_change' | 'field_error' | 'form_submit' | 'form_abandon';
  fieldName?: string;
  fieldValue?: string;
  errorMessage?: string;
  timeSpent?: number;
}
```

#### Frontend Components Required
```typescript
// Component: FormAnalyticsDashboard
// Location: /src/components/analytics/FormAnalyticsDashboard.tsx

interface FormAnalyticsDashboardProps {
  formId: string;
  dateRange: { start: string; end: string };
}

// Key functionality:
- Completion rate trends over time
- Field-by-field analysis
- Abandonment heatmap
- A/B test result comparison
- Export analytics data
- Real-time updates

// Component: FormFunnelChart
// Location: /src/components/analytics/FormFunnelChart.tsx

interface FormFunnelChartProps {
  funnelData: {
    stepName: string;
    visitorsCount: number;
    conversionRate: number;
    dropoffCount: number;
  }[];
}

// Key functionality:
- Visual funnel representation
- Click-through to detailed field analysis
- Comparison mode for A/B tests
- Export chart as image
- Interactive hover details
```

### CODE EXAMPLES

#### Example 1: Form Tracking Implementation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { useEffect, useRef, useCallback } from 'react';
import { formTrackingService } from '@/lib/analytics/formTracking';

export function useFormTracking(formId: string, sessionId: string) {
  const fieldTimeSpent = useRef<Record<string, number>>({});
  const fieldFocusTime = useRef<Record<string, number>>({});
  
  const trackEvent = useCallback(async (eventType: string, fieldName?: string, additionalData?: any) => {
    await formTrackingService.trackEvent({
      sessionId,
      formId,
      eventType,
      fieldName,
      ...additionalData
    });
  }, [formId, sessionId]);
  
  const trackFormStart = useCallback(() => {
    trackEvent('form_start');
  }, [trackEvent]);
  
  const trackFieldFocus = useCallback((fieldName: string) => {
    fieldFocusTime.current[fieldName] = Date.now();
    trackEvent('field_focus', fieldName);
  }, [trackEvent]);
  
  const trackFieldBlur = useCallback((fieldName: string, fieldValue: string) => {
    const focusTime = fieldFocusTime.current[fieldName];
    const timeSpent = focusTime ? Date.now() - focusTime : 0;
    fieldTimeSpent.current[fieldName] = (fieldTimeSpent.current[fieldName] || 0) + timeSpent;
    
    trackEvent('field_blur', fieldName, { fieldValue, timeSpent });
  }, [trackEvent]);
  
  const trackFieldChange = useCallback((fieldName: string, fieldValue: string) => {
    trackEvent('field_change', fieldName, { fieldValue });
  }, [trackEvent]);
  
  const trackFieldError = useCallback((fieldName: string, errorMessage: string) => {
    trackEvent('field_error', fieldName, { errorMessage });
  }, [trackEvent]);
  
  const trackFormSubmit = useCallback((formData: Record<string, any>) => {
    const totalTimeSpent = Object.values(fieldTimeSpent.current).reduce((sum, time) => sum + time, 0);
    trackEvent('form_submit', undefined, { formData, totalTimeSpent });
  }, [trackEvent]);
  
  const trackFormAbandon = useCallback((lastField: string) => {
    const totalTimeSpent = Object.values(fieldTimeSpent.current).reduce((sum, time) => sum + time, 0);
    trackEvent('form_abandon', lastField, { totalTimeSpent });
  }, [trackEvent]);
  
  // Track page unload as potential abandonment
  useEffect(() => {
    const handleBeforeUnload = () => {
      const activeField = document.activeElement?.getAttribute('name');
      if (activeField) {
        trackFormAbandon(activeField);
      }
    };
    
    window.addEventListener('beforeunload', handleBeforeUnload);
    return () => window.removeEventListener('beforeunload', handleBeforeUnload);
  }, [trackFormAbandon]);
  
  return {
    trackFormStart,
    trackFieldFocus,
    trackFieldBlur,
    trackFieldChange,
    trackFieldError,
    trackFormSubmit,
    trackFormAbandon
  };
}

// Enhanced Form Component with Tracking
export function TrackedForm({ formId, fields }: TrackedFormProps) {
  const sessionId = useRef(crypto.randomUUID());
  const {
    trackFormStart,
    trackFieldFocus,
    trackFieldBlur,
    trackFieldChange,
    trackFieldError,
    trackFormSubmit
  } = useFormTracking(formId, sessionId.current);
  
  useEffect(() => {
    trackFormStart();
  }, [trackFormStart]);
  
  const handleFieldFocus = (fieldName: string) => {
    trackFieldFocus(fieldName);
  };
  
  const handleFieldBlur = (fieldName: string, value: string) => {
    trackFieldBlur(fieldName, value);
  };
  
  const handleFieldChange = (fieldName: string, value: string) => {
    trackFieldChange(fieldName, value);
  };
  
  const handleValidationError = (fieldName: string, error: string) => {
    trackFieldError(fieldName, error);
  };
  
  const handleSubmit = async (formData: Record<string, any>) => {
    trackFormSubmit(formData);
    
    // Submit to backend
    await fetch(`/api/forms/${formId}/submit`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        sessionId: sessionId.current,
        data: formData
      })
    });
  };
  
  return (
    <form onSubmit={handleSubmit}>
      {fields.map((field) => (
        <FormField
          key={field.name}
          {...field}
          onFocus={() => handleFieldFocus(field.name)}
          onBlur={(value) => handleFieldBlur(field.name, value)}
          onChange={(value) => handleFieldChange(field.name, value)}
          onError={(error) => handleValidationError(field.name, error)}
        />
      ))}
      <button type="submit">Submit</button>
    </form>
  );
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [ ] Context7: Load docs for analytics libraries, charting
- [ ] Playwright: Test form tracking and analytics display
- [ ] Filesystem: Access form templates and analytics configs

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/recharts/recharts", "funnel chart analytics", 2500);
await mcp__context7__get-library-docs("/google-analytics/gtag", "event tracking", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('Form Analytics Service', () => {
  it('should calculate completion rates correctly', async () => {
    const analytics = await analyticsService.getFormAnalytics('form-123');
    expect(analytics.completionRate).toBe(0.75); // 75%
    expect(analytics.totalSubmissions).toBe(100);
  });
  
  it('should track field abandonment points', async () => {
    const fieldAnalytics = await analyticsService.getFieldAnalytics('form-123');
    const emailField = fieldAnalytics.find(f => f.fieldName === 'email');
    expect(emailField.abandonmentRate).toBeLessThan(0.1); // Less than 10%
  });
});
```

#### E2E Tests Required
```typescript
test('Form analytics tracking', async () => {
  await mcp__playwright__browser_navigate({url: '/forms/inquiry-form'});
  
  // Fill form partially
  await mcp__playwright__browser_type({
    element: "Name field",
    ref: "input[name='name']",
    text: "John Smith"
  });
  
  await mcp__playwright__browser_type({
    element: "Email field", 
    ref: "input[name='email']",
    text: "john@example.com"
  });
  
  // Abandon form (navigate away)
  await mcp__playwright__browser_navigate({url: '/another-page'});
  
  // Check analytics
  await mcp__playwright__browser_navigate({url: '/analytics/forms/inquiry-form'});
  
  await mcp__playwright__browser_wait_for({text: "Abandonment at email field"});
  
  // Verify funnel chart shows drop-off
  const funnelChart = await mcp__playwright__browser_snapshot();
  // Visual verification would be done here
});
```

### ACCEPTANCE CRITERIA
- [ ] Track all field interactions (focus, blur, change)
- [ ] Calculate accurate completion and abandonment rates
- [ ] Identify drop-off points in form funnel
- [ ] Show average time spent per field
- [ ] Track validation errors and common issues
- [ ] A/B test different form variations
- [ ] Export analytics data to CSV/PDF
- [ ] Real-time dashboard updates
- [ ] Mobile-responsive analytics views

### DEPENDENCIES
- Must complete after: WS-077 (Form system foundation)
- Must complete before: A/B testing features
- Shares code with: Analytics infrastructure, form builder

### ESTIMATED EFFORT
- Team C Integration: 18 hours (Analytics dashboard, charts)
- Team B Backend: 22 hours (Event tracking, data processing)
- Total: 40 hours