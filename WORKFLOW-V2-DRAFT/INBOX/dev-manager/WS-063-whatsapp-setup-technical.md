# TECHNICAL SPECIFICATION: WS-063 - WhatsApp Setup
## Generated by Feature Development Session - August 21, 2025

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding photographer
**I want to:** Send couples photo previews, timeline updates, and shot list confirmations via WhatsApp with rich media support
**So that:** I can communicate through couples' preferred messaging platform (2+ billion users globally) and share high-quality images instantly without email attachment limitations

**Real Wedding Scenario:**
A photographer finishes the engagement session and wants to send couples 3-5 preview images immediately to build excitement. Instead of uploading to a gallery and sending email links (which couples often miss), they send WhatsApp messages with actual images, captions like "Sarah & Mike, here are some beautiful shots from today! Full gallery coming Monday. Can't wait to share more! ðŸ“¸âœ¨" with immediate delivery confirmation and read receipts.

### SPECIFICATION SOURCE
- **Feature ID:** WS-063
- **Original Spec:** /CORE-SPECIFICATIONS/02-WEDSYNC-SUPPLIER-PLATFORM/06-Communications/03-whatsapp-setup md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** 
  - `/wedsync/src/lib/services/whatsapp-service.ts`
- **New Files to Create:** 
  - `/wedsync/src/components/communications/WhatsAppConfiguration.tsx`
  - `/wedsync/src/components/communications/WhatsAppComposer.tsx`
  - `/wedsync/src/components/communications/MediaUploader.tsx`
  - `/wedsync/src/app/api/whatsapp/route.ts`
  - `/wedsync/src/app/api/whatsapp/webhooks/route.ts`
  - `/wedsync/src/types/whatsapp.ts`
  - `/wedsync/supabase/migrations/026_whatsapp_integration_system.sql`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- WhatsApp Business API configuration
CREATE TABLE IF NOT EXISTS whatsapp_configurations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  business_id VARCHAR(255) NOT NULL,
  phone_number_id VARCHAR(255) NOT NULL,
  access_token_encrypted TEXT NOT NULL, -- Encrypted WhatsApp access token
  webhook_verify_token VARCHAR(255) NOT NULL,
  api_version VARCHAR(10) DEFAULT 'v18.0',
  business_phone VARCHAR(20) NOT NULL,
  display_name VARCHAR(255),
  is_verified BOOLEAN DEFAULT false,
  is_active BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- WhatsApp message templates (for 24hr window compliance)
CREATE TABLE IF NOT EXISTS whatsapp_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  template_name VARCHAR(255) NOT NULL,
  template_id VARCHAR(255) NOT NULL, -- WhatsApp template ID
  category whatsapp_template_category NOT NULL,
  language_code VARCHAR(10) DEFAULT 'en_US',
  header_type whatsapp_header_type,
  header_content TEXT,
  body_content TEXT NOT NULL,
  footer_content TEXT,
  button_config JSONB,
  variables JSONB DEFAULT '[]'::jsonb,
  status whatsapp_template_status DEFAULT 'pending',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TYPE whatsapp_template_category AS ENUM (
  'UTILITY',
  'MARKETING', 
  'AUTHENTICATION'
);

CREATE TYPE whatsapp_header_type AS ENUM (
  'TEXT',
  'IMAGE',
  'VIDEO',
  'DOCUMENT'
);

CREATE TYPE whatsapp_template_status AS ENUM (
  'pending',
  'approved',
  'rejected',
  'disabled'
);

-- WhatsApp conversations and messages
CREATE TABLE IF NOT EXISTS whatsapp_conversations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  client_id UUID REFERENCES clients(id) ON DELETE CASCADE,
  whatsapp_contact VARCHAR(20) NOT NULL, -- Phone number with country code
  conversation_id VARCHAR(255), -- WhatsApp conversation ID
  last_message_at TIMESTAMPTZ DEFAULT NOW(),
  session_expires_at TIMESTAMPTZ,
  is_within_24hr_window BOOLEAN DEFAULT false,
  conversation_cost DECIMAL(10,4) DEFAULT 0,
  message_count INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, whatsapp_contact)
);

CREATE TABLE IF NOT EXISTS whatsapp_messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  conversation_id UUID REFERENCES whatsapp_conversations(id) ON DELETE CASCADE,
  whatsapp_message_id VARCHAR(255) UNIQUE,
  direction whatsapp_message_direction NOT NULL,
  message_type whatsapp_message_type NOT NULL,
  content TEXT,
  media_url TEXT,
  media_type VARCHAR(50),
  media_caption TEXT,
  media_filename VARCHAR(255),
  template_id UUID REFERENCES whatsapp_templates(id) ON DELETE SET NULL,
  status whatsapp_message_status DEFAULT 'sent',
  error_code VARCHAR(20),
  error_message TEXT,
  timestamp TIMESTAMPTZ DEFAULT NOW(),
  delivered_at TIMESTAMPTZ,
  read_at TIMESTAMPTZ
);

CREATE TYPE whatsapp_message_direction AS ENUM (
  'outbound',
  'inbound'
);

CREATE TYPE whatsapp_message_type AS ENUM (
  'text',
  'image',
  'document',
  'audio', 
  'video',
  'template',
  'interactive'
);

CREATE TYPE whatsapp_message_status AS ENUM (
  'sent',
  'delivered',
  'read',
  'failed'
);

-- Media storage tracking for WhatsApp
CREATE TABLE IF NOT EXISTS whatsapp_media (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  message_id UUID REFERENCES whatsapp_messages(id) ON DELETE CASCADE,
  whatsapp_media_id VARCHAR(255),
  original_filename VARCHAR(255),
  file_size INTEGER,
  mime_type VARCHAR(100),
  storage_path TEXT, -- Supabase storage path
  download_url TEXT,
  expires_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS policies
ALTER TABLE whatsapp_configurations ENABLE ROW LEVEL SECURITY;
ALTER TABLE whatsapp_templates ENABLE ROW LEVEL SECURITY;
ALTER TABLE whatsapp_conversations ENABLE ROW LEVEL SECURITY;
ALTER TABLE whatsapp_messages ENABLE ROW LEVEL SECURITY;
ALTER TABLE whatsapp_media ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage their own WhatsApp configuration" ON whatsapp_configurations
  FOR ALL USING (auth.uid() = user_id);

CREATE POLICY "Users can manage their own WhatsApp templates" ON whatsapp_templates
  FOR ALL USING (auth.uid() = user_id);

CREATE POLICY "Users can access their own WhatsApp conversations" ON whatsapp_conversations
  FOR ALL USING (auth.uid() = user_id);

CREATE POLICY "Users can access messages from their conversations" ON whatsapp_messages
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM whatsapp_conversations 
      WHERE whatsapp_conversations.id = whatsapp_messages.conversation_id 
      AND whatsapp_conversations.user_id = auth.uid()
    )
  );

CREATE POLICY "Users can manage their own WhatsApp media" ON whatsapp_media
  FOR ALL USING (auth.uid() = user_id);
```

#### API Endpoints Required
```typescript
// POST /api/whatsapp/configure
interface ConfigureWhatsAppRequest {
  businessId: string;
  phoneNumberId: string;
  accessToken: string;
  webhookVerifyToken: string;
}

interface ConfigureWhatsAppResponse {
  success: boolean;
  data: {
    configurationId: string;
    verified: boolean;
    businessPhone: string;
    displayName: string;
  };
}

// POST /api/whatsapp/verify
interface VerifyWhatsAppResponse {
  success: boolean;
  data: {
    verified: boolean;
    phoneNumber: string;
    businessInfo: {
      name: string;
      about: string;
      email: string;
    };
  };
}

// POST /api/whatsapp/send
interface SendWhatsAppRequest {
  clientId: string;
  messageType: 'text' | 'image' | 'document' | 'template';
  content?: string;
  mediaFile?: File;
  mediaCaption?: string;
  templateId?: string;
  templateVariables?: Record<string, string>;
}

interface SendWhatsAppResponse {
  success: boolean;
  data: {
    messageId: string;
    whatsappMessageId: string;
    conversationId: string;
    isWithin24HrWindow: boolean;
    estimatedCost: number;
  };
}

// GET /api/whatsapp/conversations
interface GetConversationsResponse {
  success: boolean;
  data: {
    conversations: Array<{
      id: string;
      clientName: string;
      lastMessage: string;
      lastMessageAt: string;
      unreadCount: number;
      isWithin24HrWindow: boolean;
    }>;
  };
}

// GET /api/whatsapp/conversations/[id]/messages
interface GetMessagesResponse {
  success: boolean;
  data: {
    messages: WhatsAppMessage[];
    conversation: WhatsAppConversation;
    hasMore: boolean;
  };
}

// POST /api/whatsapp/media/upload
interface UploadMediaRequest {
  file: File;
  caption?: string;
}

interface UploadMediaResponse {
  success: boolean;
  data: {
    mediaId: string;
    downloadUrl: string;
    expiresAt: string;
  };
}

// POST /api/whatsapp/webhooks (Webhook handler)
interface WhatsAppWebhookPayload {
  object: string;
  entry: Array<{
    id: string;
    changes: Array<{
      value: {
        messaging_product: string;
        metadata: any;
        contacts?: any[];
        messages?: any[];
        statuses?: any[];
      };
      field: string;
    }>;
  }>;
}
```

#### Frontend Components Required
```typescript
// Component: WhatsAppConfiguration
// Location: /src/components/communications/WhatsAppConfiguration.tsx

interface WhatsAppConfigurationProps {
  onConfigurationComplete: (config: WhatsAppConfiguration) => void;
}

// Key functionality:
- WhatsApp Business API setup wizard
- Phone number verification flow
- Webhook URL configuration and testing
- Business profile display and editing
- Template submission interface
- Integration status monitoring

// Component: WhatsAppComposer
// Location: /src/components/communications/WhatsAppComposer.tsx

interface WhatsAppComposerProps {
  conversationId: string;
  clientId: string;
  onMessageSent: (message: WhatsAppMessage) => void;
}

// Key functionality:
- Rich text composer with emoji picker
- Media attachment (image, document, audio, video)
- Template message selection when outside 24hr window
- Message type indicator (within/outside session window)
- Live character counting and media size limits
- Send confirmation with cost display

// Component: MediaUploader
// Location: /src/components/communications/MediaUploader.tsx

interface MediaUploaderProps {
  onMediaUploaded: (media: WhatsAppMedia) => void;
  acceptedTypes: string[];
  maxFileSize: number;
}

// Key functionality:
- Drag-and-drop file upload
- Image preview and compression
- File type validation for WhatsApp requirements
- Progress indicators for upload status
- Automatic caption generation for wedding photos
- Media optimization for mobile delivery
```

#### Integration Points
```typescript
// Service: WhatsAppService (new service)
// Dependencies: WhatsApp Business API, MediaUploadService, ClientService

class WhatsAppService {
  private readonly apiBaseUrl = 'https://graph.facebook.com/v18.0';
  
  async sendTextMessage(
    phoneNumber: string,
    message: string,
    clientId: string
  ): Promise<WhatsAppMessage> {
    // 1. Check if conversation is within 24-hour window
    // 2. Send direct message if within window, template if outside
    // 3. Handle media attachments via WhatsApp media API
    // 4. Log conversation and update session tracking
    // 5. Update cost tracking for business billing
  }

  async sendMediaMessage(
    phoneNumber: string,
    mediaFile: File,
    caption: string,
    clientId: string
  ): Promise<WhatsAppMessage> {
    // 1. Upload media to WhatsApp servers
    // 2. Validate file type and size requirements
    // 3. Send media message with caption
    // 4. Handle delivery status and read receipts
  }

  async processIncomingWebhook(payload: WhatsAppWebhookPayload): Promise<void> {
    // 1. Verify webhook signature
    // 2. Process incoming messages and status updates
    // 3. Update conversation sessions and costs
    // 4. Handle media downloads and storage
    // 5. Trigger real-time updates to UI
  }

  async checkSessionWindow(phoneNumber: string, userId: string): Promise<boolean> {
    // 1. Calculate time since last client-initiated contact
    // 2. Return true if within 24-hour messaging window
    // 3. Handle timezone considerations for global clients
  }

  async submitTemplate(template: WhatsAppTemplateRequest): Promise<void> {
    // 1. Format template for WhatsApp submission
    // 2. Submit to WhatsApp for approval
    // 3. Handle approval/rejection notifications
    // 4. Update template status in database
  }
}
```

### CODE EXAMPLES

#### Example 1: WhatsApp Media Message with Wedding Context
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { supabase } from '@/lib/supabase';
import { WhatsAppAPI } from '@/lib/whatsapp-api';

export async function sendWeddingPhotoPreview(
  clientId: string,
  imageFile: File,
  caption: string
): Promise<void> {
  // Step 1: Get client WhatsApp info
  const { data: client, error: clientError } = await supabase
    .from('clients')
    .select(`
      id,
      partner1_name,
      partner2_name,
      whatsapp_phone,
      wedding_date
    `)
    .eq('id', clientId)
    .single();
    
  if (clientError) throw clientError;
  if (!client.whatsapp_phone) throw new Error('Client WhatsApp not available');
  
  // Step 2: Get WhatsApp configuration
  const { data: config } = await supabase
    .from('whatsapp_configurations')
    .select('*')
    .eq('user_id', auth.uid())
    .eq('is_active', true)
    .single();
    
  if (!config) throw new Error('WhatsApp not configured');
  
  // Step 3: Check session window
  const conversation = await getOrCreateConversation(client.whatsapp_phone, auth.uid());
  const isWithinWindow = checkSessionWindow(conversation);
  
  if (!isWithinWindow) {
    throw new Error('Outside 24-hour messaging window. Use approved template instead.');
  }
  
  // Step 4: Upload media to WhatsApp
  const mediaUpload = await fetch(`${config.apiBaseUrl}/${config.phone_number_id}/media`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${config.access_token}`,
    },
    body: createFormData(imageFile)
  });
  
  const mediaResult = await mediaUpload.json();
  if (!mediaUpload.ok) throw new Error(mediaResult.error.message);
  
  // Step 5: Send image message with personalized caption
  const personalizedCaption = `${client.partner1_name} & ${client.partner2_name}, ${caption}`;
  
  const messagePayload = {
    messaging_product: 'whatsapp',
    recipient_type: 'individual',
    to: client.whatsapp_phone,
    type: 'image',
    image: {
      id: mediaResult.id,
      caption: personalizedCaption
    }
  };
  
  const response = await fetch(`${config.apiBaseUrl}/${config.phone_number_id}/messages`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${config.access_token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(messagePayload)
  });
  
  const result = await response.json();
  if (!response.ok) throw new Error(result.error.message);
  
  // Step 6: Log message in database
  await supabase
    .from('whatsapp_messages')
    .insert({
      conversation_id: conversation.id,
      whatsapp_message_id: result.messages[0].id,
      direction: 'outbound',
      message_type: 'image',
      content: personalizedCaption,
      media_url: mediaResult.url,
      media_type: 'image',
      media_caption: personalizedCaption,
      status: 'sent'
    });
    
  // Step 7: Update conversation session
  await supabase
    .from('whatsapp_conversations')
    .update({
      last_message_at: new Date().toISOString(),
      message_count: conversation.message_count + 1,
      is_within_24hr_window: true
    })
    .eq('id', conversation.id);
}

async function handleWhatsAppWebhook(payload: WhatsAppWebhookPayload): Promise<void> {
  // Step 1: Verify webhook (implement signature verification)
  
  for (const entry of payload.entry) {
    for (const change of entry.changes) {
      if (change.field === 'messages') {
        const { messages, statuses } = change.value;
        
        // Handle incoming messages
        if (messages) {
          for (const message of messages) {
            await processIncomingMessage(message);
          }
        }
        
        // Handle status updates (delivered, read, failed)
        if (statuses) {
          for (const status of statuses) {
            await updateMessageStatus(status);
          }
        }
      }
    }
  }
}

async function processIncomingMessage(message: any): Promise<void> {
  // Step 1: Find conversation
  const { data: conversation } = await supabase
    .from('whatsapp_conversations')
    .select('*')
    .eq('whatsapp_contact', message.from)
    .single();
    
  if (!conversation) {
    // Create new conversation if client initiated contact
    // This opens the 24-hour messaging window
  }
  
  // Step 2: Store message
  await supabase
    .from('whatsapp_messages')
    .insert({
      conversation_id: conversation.id,
      whatsapp_message_id: message.id,
      direction: 'inbound',
      message_type: message.type,
      content: message.text?.body || '',
      timestamp: new Date(message.timestamp * 1000).toISOString()
    });
    
  // Step 3: Update conversation window
  await supabase
    .from('whatsapp_conversations')
    .update({
      last_message_at: new Date().toISOString(),
      session_expires_at: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
      is_within_24hr_window: true
    })
    .eq('id', conversation.id);
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for WhatsApp Business API, Facebook Graph API
- [x] Filesystem: Access existing WhatsApp service implementations
- [x] Memory: Store WhatsApp template patterns and media handling

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/facebook/graph-api", "whatsapp business", 3000);
await mcp__context7__get-library-docs("/supabase/storage-js", "file upload", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('WhatsAppService', () => {
  it('should check 24-hour session window correctly', () => {
    const lastContact = new Date(Date.now() - 23 * 60 * 60 * 1000); // 23 hours ago
    expect(checkSessionWindow(lastContact)).toBe(true);
    
    const expiredContact = new Date(Date.now() - 25 * 60 * 60 * 1000); // 25 hours ago  
    expect(checkSessionWindow(expiredContact)).toBe(false);
  });

  it('should handle media upload with wedding context', async () => {
    const imageFile = new File([''], 'engagement-photos.jpg', { type: 'image/jpeg' });
    const result = await sendWeddingPhotoPreview('client-123', imageFile, 'Beautiful shots from today!');
    expect(result.mediaType).toBe('image');
    expect(result.caption).toContain('John & Jane');
  });

  it('should process webhook status updates', async () => {
    const statusPayload = {
      id: 'wamid.123',
      status: 'read',
      timestamp: '1234567890',
      recipient_id: '+1234567890'
    };
    await updateMessageStatus(statusPayload);
    
    const message = await getMessageByWhatsAppId('wamid.123');
    expect(message.status).toBe('read');
    expect(message.read_at).toBeDefined();
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('WhatsApp configuration and media sending', async () => {
  await mcp__playwright__browser_navigate({url: '/communications/whatsapp/setup'});
  
  // Configure WhatsApp Business API
  await mcp__playwright__browser_type({
    element: 'business ID input',
    ref: 'input[name="businessId"]',
    text: 'business_123456789'
  });
  
  await mcp__playwright__browser_type({
    element: 'phone number ID input',
    ref: 'input[name="phoneNumberId"]', 
    text: 'phone_123456789'
  });
  
  // Upload and send media message
  await mcp__playwright__browser_navigate({url: '/communications/whatsapp/conversations/conv-123'});
  
  await mcp__playwright__browser_file_upload({
    paths: ['/path/to/test-wedding-photo.jpg']
  });
  
  await mcp__playwright__browser_type({
    element: 'caption input',
    ref: 'textarea[name="mediaCaption"]',
    text: 'Here are your beautiful engagement photos! ðŸ“¸'
  });
  
  await mcp__playwright__browser_click({element: 'send button', ref: 'button[data-testid="send-media"]'});
  
  // Verify message appears in conversation
  await mcp__playwright__browser_wait_for({text: 'Here are your beautiful engagement photos!'});
  
  // Verify session window indicator
  await mcp__playwright__browser_wait_for({text: 'Within 24hr window'});
  
  // Verify accessibility
  await mcp__playwright__browser_evaluate({
    function: '() => axe.run()'
  });
});
```

### ACCEPTANCE CRITERIA
- [x] WhatsApp Business API configuration with phone number verification
- [x] Rich media messaging (images, documents, audio, video) with wedding context
- [x] 24-hour session window management and template fallback
- [x] Real-time message delivery and read receipt tracking
- [x] Media upload optimization for mobile delivery
- [x] Performance: Media messages send within 5 seconds
- [x] Security: Access tokens encrypted, webhook signature verification
- [x] Accessibility: WhatsApp interface meets WCAG 2.1 AA standards

### DEPENDENCIES
- Must complete after: WS-062 (SMS Configuration)
- Must complete before: WS-026 (Bulk Messaging)
- Shares code with: SMS service, media upload service, communication infrastructure

### ESTIMATED EFFORT
- Team C Integration: 24 hours (WhatsApp Business API, webhook handling, media processing)
- Team A Frontend: 16 hours (Configuration UI, message composer, media uploader)
- Team B Backend: 12 hours (Database schema, message storage, session management)
- Total: 52 hours