# TECHNICAL SPECIFICATION: WS-151 - Guest List Builder
## Generated by Feature Development Session - August 23, 2025

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding couple planning guest invitations
**I want to:** Build and organize my wedding guest list with household grouping and smart categorization
**So that:** I can avoid entering the same address multiple times, ensure proper invitation counts, and easily track RSVPs by family groups

**Real Wedding Scenario:**
A couple currently maintains guest lists in spreadsheets, often entering the "Smith Family" as separate rows with duplicate addresses. With this feature, they can group John Smith, Jane Smith, and little Emma Smith into one household, send one invitation, and track RSVPs collectively. This eliminates duplicate data entry and reduces invitation printing costs by 30-40%.

### SPECIFICATION SOURCE
- **Feature ID:** WS-151
- **Original Spec:** /CORE-SPECIFICATIONS/03-WEDME-COUPLE-PLATFORM/04-Guest-Management/01-guest-list-builder md.md
- **Current Implementation:** 0% complete (new)
- **Files to Modify:** None (new feature)
- **New Files to Create:** 
  - `/src/app/(dashboard)/guests/page.tsx`
  - `/src/components/guests/GuestListBuilder.tsx`
  - `/src/components/guests/GuestImporter.tsx` 
  - `/src/components/guests/QuickAddGuest.tsx`
  - `/src/lib/services/guestService.ts`
  - `/src/types/guests.ts`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Guest management tables
CREATE TABLE IF NOT EXISTS households (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  couple_id UUID REFERENCES couples(id),
  name VARCHAR(255) NOT NULL,
  address_line1 VARCHAR(255),
  address_line2 VARCHAR(255),
  city VARCHAR(100),
  state VARCHAR(50),
  postal_code VARCHAR(20),
  country VARCHAR(50) DEFAULT 'US',
  invitation_sent BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS guests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  couple_id UUID REFERENCES couples(id),
  household_id UUID REFERENCES households(id),
  first_name VARCHAR(100) NOT NULL,
  last_name VARCHAR(100) NOT NULL,
  email VARCHAR(255),
  phone VARCHAR(20),
  category VARCHAR(50) CHECK (category IN ('family', 'friends', 'work', 'other')),
  side VARCHAR(20) CHECK (side IN ('partner1', 'partner2', 'mutual')),
  plus_one BOOLEAN DEFAULT false,
  plus_one_name VARCHAR(255),
  age_group VARCHAR(20) CHECK (age_group IN ('adult', 'child', 'infant')),
  table_number INTEGER,
  helper_role VARCHAR(255),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes for performance
CREATE INDEX idx_guests_couple_id ON guests(couple_id);
CREATE INDEX idx_guests_household_id ON guests(household_id);
CREATE INDEX idx_households_couple_id ON households(couple_id);
```

#### API Endpoints Required
```typescript
// POST /api/guests/bulk-import
interface BulkImportRequestBody {
  guests: {
    first_name: string;
    last_name: string;
    email?: string;
    phone?: string;
    category: string;
    side: string;
    age_group: string;
    plus_one: boolean;
    household_name?: string;
    address?: Address;
  }[];
}

interface BulkImportResponseBody {
  success: boolean;
  data: {
    guests_created: number;
    households_created: number;
    duplicates_skipped: number;
  };
  errors?: string[];
}

// GET /api/guests
interface GuestListResponse {
  success: boolean;
  data: {
    households: Household[];
    guest_count: {
      adults: number;
      children: number;
      infants: number;
      total: number;
    };
  };
}

// POST /api/guests/quick-add
interface QuickAddRequest {
  input_text: string; // "John and Jane Smith, john@email.com"
  category: string;
  side: string;
}
```

#### Frontend Components Required
```typescript
// Component: GuestListBuilder
// Location: /src/components/guests/GuestListBuilder.tsx

interface GuestListBuilderProps {
  coupleId: string;
  onGuestUpdate: (guests: Guest[]) => void;
}

// Key functionality:
- Display guests grouped by households
- Drag-and-drop between categories (family/friends/work/other)
- Bulk operations (select all, delete, mark attending)
- Real-time guest count summaries
- Export to CSV functionality

// Component: GuestImporter  
// Location: /src/components/guests/GuestImporter.tsx

interface GuestImporterProps {
  onImportComplete: (result: BulkImportResult) => void;
}

// Key functionality:
- CSV/Excel file upload with drag-and-drop
- Smart field mapping (auto-detect First Name, Last Name, Email columns)
- Preview imported data before committing
- Duplicate detection and handling
- Auto-generate households based on last name and address matching

// Component: QuickAddGuest
// Location: /src/components/guests/QuickAddGuest.tsx

// Key functionality:
- Natural language parsing of guest input
- Autocomplete for existing households
- Quick category assignment
- Real-time validation
```

#### Integration Points
```typescript
// Service: GuestService
// Dependencies: Supabase client, household service

class GuestService {
  async bulkCreateGuests(guests: GuestData[]): Promise<BulkImportResult> {
    // Group guests by potential households
    const households = this.groupByHousehold(guests);
    
    // Create households first, then guests
    const householdResults = await this.createHouseholds(households);
    const guestResults = await this.createGuestsWithHouseholds(guests, householdResults);
    
    return {
      guests_created: guestResults.length,
      households_created: householdResults.length,
      duplicates_skipped: 0
    };
  }
  
  async parseQuickAddInput(input: string): Promise<Guest[]> {
    // Parse patterns like "John and Jane Smith" or "Family of 4"
    const patterns = [
      /([A-Z][a-z]+)\s+and\s+([A-Z][a-z]+)\s+([A-Z][a-z]+)/, // John and Jane Smith
      /([A-Z][a-z]+)\s+([A-Z][a-z]+),\s*(.+@.+)/, // John Smith, john@email.com
      /Family\s+of\s+(\d+)/i // Family of 4
    ];
    
    // Return parsed guest objects
  }
}
```

### CODE EXAMPLES

#### Example 1: Guest List Builder Component
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
'use client';

import { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabase';
import { Guest, Household } from '@/types/guests';
import { DragDropContext, Droppable, Draggable } from '@hello-pangea/dnd';

export function GuestListBuilder({ coupleId }: { coupleId: string }) {
  const [households, setHouseholds] = useState<Household[]>([]);
  const [loading, setLoading] = useState(true);
  const [guestCounts, setGuestCounts] = useState({
    adults: 0,
    children: 0,
    infants: 0,
    total: 0
  });

  useEffect(() => {
    fetchGuests();
  }, [coupleId]);

  const fetchGuests = async () => {
    const { data, error } = await supabase
      .from('households')
      .select(`
        *,
        guests!guests_household_id_fkey(*)
      `)
      .eq('couple_id', coupleId)
      .order('name');
    
    if (error) throw error;
    
    setHouseholds(data || []);
    calculateGuestCounts(data || []);
    setLoading(false);
  };

  const calculateGuestCounts = (households: Household[]) => {
    const counts = { adults: 0, children: 0, infants: 0, total: 0 };
    
    households.forEach(household => {
      household.guests?.forEach(guest => {
        counts[guest.age_group as keyof typeof counts]++;
        counts.total++;
      });
    });
    
    setGuestCounts(counts);
  };

  const handleDragEnd = async (result: any) => {
    // Handle category changes via drag-and-drop
    const { destination, source, draggableId } = result;
    
    if (!destination || destination.droppableId === source.droppableId) return;
    
    const guestId = draggableId;
    const newCategory = destination.droppableId;
    
    const { error } = await supabase
      .from('guests')
      .update({ category: newCategory })
      .eq('id', guestId);
      
    if (!error) {
      fetchGuests(); // Refresh data
    }
  };

  if (loading) return <div>Loading guest list...</div>;

  return (
    <div className="guest-list-builder">
      <div className="guest-counts mb-6">
        <div className="grid grid-cols-4 gap-4">
          <div className="text-center">
            <div className="text-2xl font-bold">{guestCounts.adults}</div>
            <div className="text-sm text-gray-500">Adults</div>
          </div>
          <div className="text-center">
            <div className="text-2xl font-bold">{guestCounts.children}</div>
            <div className="text-sm text-gray-500">Children</div>
          </div>
          <div className="text-center">
            <div className="text-2xl font-bold">{guestCounts.infants}</div>
            <div className="text-sm text-gray-500">Infants</div>
          </div>
          <div className="text-center">
            <div className="text-2xl font-bold">{guestCounts.total}</div>
            <div className="text-sm text-gray-500">Total</div>
          </div>
        </div>
      </div>

      <DragDropContext onDragEnd={handleDragEnd}>
        <div className="categories-grid grid grid-cols-1 md:grid-cols-4 gap-6">
          {['family', 'friends', 'work', 'other'].map(category => (
            <Droppable key={category} droppableId={category}>
              {(provided) => (
                <div 
                  ref={provided.innerRef}
                  {...provided.droppableProps}
                  className="category-column bg-gray-50 p-4 rounded-lg"
                >
                  <h3 className="font-semibold mb-4 capitalize">{category}</h3>
                  {households
                    .filter(h => h.guests?.some(g => g.category === category))
                    .map((household, index) => (
                      <Draggable 
                        key={household.id} 
                        draggableId={household.id} 
                        index={index}
                      >
                        {(provided) => (
                          <div
                            ref={provided.innerRef}
                            {...provided.draggableProps}
                            {...provided.dragHandleProps}
                            className="household-card bg-white p-3 mb-2 rounded border"
                          >
                            <div className="font-medium">{household.name}</div>
                            <div className="text-sm text-gray-600">
                              {household.guests?.length || 0} guests
                            </div>
                          </div>
                        )}
                      </Draggable>
                    ))}
                  {provided.placeholder}
                </div>
              )}
            </Droppable>
          ))}
        </div>
      </DragDropContext>
    </div>
  );
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for React DnD, Supabase
- [x] Playwright: Test guest list management flows
- [x] Filesystem: Access guest management components

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/hello-pangea/dnd", "drag and drop", 2000);
await mcp__context7__get-library-docs("/supabase/supabase-js", "database queries", 2000);
await mcp__context7__get-library-docs("/papaparse/papaparse", "csv parsing", 1500);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('GuestService', () => {
  it('should parse quick add input correctly', () => {
    const service = new GuestService();
    const result = service.parseQuickAddInput("John and Jane Smith");
    expect(result).toEqual([
      { first_name: 'John', last_name: 'Smith', household_name: 'Smith Family' },
      { first_name: 'Jane', last_name: 'Smith', household_name: 'Smith Family' }
    ]);
  });

  it('should group guests by household correctly', () => {
    const guests = [
      { first_name: 'John', last_name: 'Smith', address: '123 Main St' },
      { first_name: 'Jane', last_name: 'Smith', address: '123 Main St' }
    ];
    
    const households = service.groupByHousehold(guests);
    expect(households).toHaveLength(1);
    expect(households[0].members).toHaveLength(2);
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Guest list management flow', async () => {
  await mcp__playwright__browser_navigate({url: '/guests'});
  await mcp__playwright__browser_snapshot();
  
  // Test CSV import
  await mcp__playwright__browser_click({
    element: 'Import CSV button',
    ref: 'button[data-testid="import-csv"]'
  });
  
  // Test drag and drop between categories
  await mcp__playwright__browser_drag({
    startElement: 'Guest card in family category',
    startRef: '[data-testid="guest-john-smith"]',
    endElement: 'Friends category drop zone',
    endRef: '[data-testid="category-friends"]'
  });
  
  // Verify accessibility
  await mcp__playwright__browser_snapshot();
});
```

### ACCEPTANCE CRITERIA
- [x] Users can import guests from CSV/Excel files with smart field mapping
- [x] Households are automatically created based on last name and address matching
- [x] Users can drag and drop guests between categories (family/friends/work/other)  
- [x] Real-time guest count summaries display (adults/children/infants/total)
- [x] Quick add functionality parses natural language input
- [x] Export to CSV functionality works for printing
- [x] Performance: Handles guest lists up to 500 guests with <2s load time
- [x] Security: All guest data is scoped to couple_id with RLS policies
- [x] Accessibility: Keyboard navigation and screen reader support

### DEPENDENCIES
- Must complete after: None (foundational feature)
- Must complete before: WS-152 (Dietary Requirements), WS-153 (Photo Groups), WS-154 (Seating), WS-155 (Guest Communications)
- Shares code with: All guest management features

### ESTIMATED EFFORT
- Team A Frontend: 16 hours
- Team B Backend: 12 hours  
- Team C Integration: 8 hours
- Total: 36 hours