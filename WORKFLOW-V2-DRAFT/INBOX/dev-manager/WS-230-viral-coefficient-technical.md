# TECHNICAL SPECIFICATION: WS-230 - Enhanced Viral Coefficient Tracking System
## Generated by Feature Development Session - 2025-01-25

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** WedSync platform growth analyst managing wedding industry virality
**I want to:** Track sophisticated viral coefficients with wedding-specific seasonality and vendor network effects
**So that:** I can optimize growth strategies accounting for the fact that photographers refer couples differently in peak season (June-September) versus off-season, and vendor-to-vendor referrals behave differently than couple-to-couple referrals

**Real Wedding Scenario:**
"A photographer who joins in March (off-season) typically invites 2-3 couples initially, but a photographer joining in July (peak season) invites 8+ couples immediately due to active wedding schedules. Our viral coefficient needs to account for these seasonal patterns, track that venue-to-photographer referrals have 3x higher conversion than photographer-to-photographer referrals, and measure the network effects when multiple vendors serve the same wedding couple."

### SPECIFICATION SOURCE
- **Feature ID:** WS-230
- **Original Spec:** /CORE-SPECIFICATIONS/07-ADMIN-DASHBOARD/03-Growth-Metrics/01-viral-coefficient md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** None (new feature)
- **New Files to Create:**
  - `/src/components/admin/EnhancedViralDashboard.tsx`
  - `/src/lib/analytics/advanced-viral-calculator.ts`
  - `/src/lib/analytics/wedding-viral-analyzer.ts`
  - `/src/lib/analytics/viral-optimization-engine.ts`
  - `/src/app/api/admin/viral-metrics/route.ts`
  - `/src/hooks/useEnhancedViralMetrics.ts`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Enhanced invitation tracking with attribution
CREATE TABLE invitation_tracking (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  inviter_id UUID REFERENCES users(id),
  inviter_type TEXT CHECK (inviter_type IN ('supplier', 'couple')),
  inviter_vendor_type TEXT,
  invitee_email TEXT NOT NULL,
  invitee_type TEXT CHECK (invitee_type IN ('supplier', 'couple')),
  invitation_code TEXT UNIQUE,

  -- Enhanced status tracking
  status TEXT DEFAULT 'sent',
  sent_at TIMESTAMPTZ DEFAULT NOW(),
  sent_channel TEXT, -- email, sms, in_app
  opened_at TIMESTAMPTZ,
  opened_device TEXT,
  clicked_at TIMESTAMPTZ,
  signed_up_at TIMESTAMPTZ,
  activated_at TIMESTAMPTZ,

  -- Attribution & quality
  invitee_id UUID REFERENCES users(id),
  attribution_value DECIMAL(10, 2), -- Revenue attributed to this invite
  quality_score DECIMAL(3, 2), -- 0-1 score based on invitee behavior

  -- Context
  invitation_context JSONB, -- Where/when/why invited
  experiment_variant TEXT,
  incentive_offered TEXT,

  -- Network effects
  network_distance INTEGER, -- Degrees of separation
  shared_connections INTEGER, -- Mutual connections

  CONSTRAINT unique_invitation UNIQUE(inviter_id, invitee_email)
);

-- Viral loop performance tracking
CREATE TABLE viral_loop_metrics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  loop_type TEXT NOT NULL,
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,

  -- Volume metrics
  loop_count INTEGER,
  unique_participants INTEGER,

  -- Performance metrics
  avg_cycle_time_days DECIMAL(5, 2),
  conversion_rate DECIMAL(4, 3),
  activation_rate DECIMAL(4, 3),

  -- Quality metrics
  revenue_generated DECIMAL(10, 2),
  ltv_cohort DECIMAL(10, 2),
  retention_30d DECIMAL(4, 3),
  retention_90d DECIMAL(4, 3),

  -- Network metrics
  avg_network_size DECIMAL(6, 2),
  network_density DECIMAL(4, 3),
  clustering_coefficient DECIMAL(4, 3),

  calculated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(loop_type, start_date, end_date)
);

-- Wedding cohort network analysis
CREATE TABLE wedding_cohort_networks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  cohort_month DATE NOT NULL,

  -- Cohort metrics
  total_couples INTEGER,
  total_vendors INTEGER,

  -- Network metrics
  avg_vendors_per_couple DECIMAL(4, 2),
  avg_couples_per_vendor DECIMAL(5, 2),
  vendor_overlap_rate DECIMAL(4, 3), -- % sharing vendors

  -- Viral metrics
  intra_cohort_referrals INTEGER,
  cross_cohort_referrals INTEGER,
  viral_coefficient DECIMAL(4, 3),

  -- Geographic distribution
  geographic_clusters JSONB,
  primary_regions TEXT[],

  calculated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(cohort_month)
);

CREATE INDEX idx_invitations_performance ON invitation_tracking(status, quality_score);
CREATE INDEX idx_viral_loops_date ON viral_loop_metrics(start_date, loop_type);
CREATE INDEX idx_wedding_cohorts ON wedding_cohort_networks(cohort_month);
```

#### API Endpoints Required
```typescript
// GET /api/admin/viral-metrics
interface ViralMetricsResponse {
  enhanced: EnhancedViralCoefficient;
  historical: ViralTrendData[];
  loops: ViralLoop[];
  seasonal: SeasonalAdjustments;
}

// POST /api/admin/viral-metrics/simulate
interface ViralSimulationRequest {
  intervention: ViralIntervention;
  duration: number; // days
  targetSegment?: 'all' | 'photographers' | 'venues' | 'couples';
}

interface ViralSimulationResponse {
  currentCoefficient: number;
  projectedCoefficient: number;
  userGrowthImpact: number;
  revenueImpact: number;
  confidence: number;
  breakEvenDays: number;
}

// GET /api/admin/viral-metrics/bottlenecks
interface ViralBottlenecksResponse {
  bottlenecks: ViralBottleneck[];
  recommendations: OptimizationRecommendation[];
}
```

#### Frontend Components Required
```typescript
// Component: EnhancedViralDashboard
// Location: /src/components/admin/EnhancedViralDashboard.tsx

interface EnhancedViralDashboardProps {
  timeframe: '7d' | '30d' | '90d' | '1y';
  vendorTypeFilter?: VendorType[];
}

// Key functionality:
- Multi-dimensional viral coefficient display (raw, seasonal, sustainable)
- Viral loop Sankey diagram with revenue attribution
- Vendor type performance heatmap
- Wedding cohort network visualization
- Geographic viral spread mapping
- Viral growth prediction modeling

// Component: ViralOptimizationPanel
// Location: /src/components/admin/ViralOptimizationPanel.tsx

interface ViralOptimizationPanelProps {
  currentMetrics: EnhancedViralCoefficient;
  bottlenecks: ViralBottleneck[];
}

// Key functionality:
- Bottleneck identification and recommendations
- A/B test management for viral experiments
- Intervention simulation and ROI calculation
- Personalized invite strategy recommendations
```

#### Integration Points
```typescript
// Service: AdvancedViralCalculator
// Dependencies: Database, Analytics Engine, Machine Learning Models

class AdvancedViralCalculator {
  async calculateEnhanced(period: DateRange): Promise<EnhancedViralCoefficient> {
    // Calculate base, seasonal-adjusted, and sustainable viral coefficients
  }
  
  async analyzeEnhancedLoops(users: string[]): Promise<ViralLoop[]> {
    // Track complex multi-hop referral chains with revenue attribution
  }
  
  async calculateSustainableCoefficient(
    users: string[],
    baseCoefficient: number
  ): Promise<number> {
    // Remove outliers and one-time events for realistic projections
  }
}

// Service: WeddingViralAnalyzer
// Dependencies: Advanced Calculator, Network Analysis Tools

class WeddingViralAnalyzer {
  async analyzeWeddingCohortVirality(weddingDate: Date): Promise<CohortViralData> {
    // Analyze how couples in same wedding season influence each other
  }
  
  async trackVendorReferralNetwork(): Promise<VendorNetworkMetrics> {
    // Map vendor-to-vendor referral patterns within wedding parties
  }
}
```

### CODE EXAMPLES

#### Example 1: Advanced Viral Calculator Implementation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { supabase } from '@/lib/supabase';

export interface EnhancedViralCoefficient {
  // Core Metrics
  coefficient: number; // K-factor (target > 1.0)
  adjustedCoefficient: number; // Seasonally adjusted
  sustainableCoefficient: number; // Excluding one-time events

  // Invitation Metrics
  invitationRate: number;
  acceptanceRate: number;
  activationRate: number;
  avgInvitesPerUser: number;
  qualityScore: number;

  // Time Metrics
  timeToInvite: number; // Days from signup
  viralCycleTime: number; // Full loop completion
  velocityTrend: 'accelerating' | 'stable' | 'decelerating';

  // Loop Analysis
  loops: ViralLoop[];
  dominantLoop: string;
  loopEfficiency: number;

  // Wedding Context
  weddingSeasonMultiplier: number;
  vendorTypeBreakdown: VendorViralMetrics[];
  geographicSpread: GeoViralData[];
}

export interface ViralLoop {
  type: 'supplier_to_couple' | 'couple_to_supplier' | 'supplier_to_supplier' | 'couple_to_couple';
  count: number;
  conversionRate: number;
  avgCycleTime: number;
  revenue: number; // Revenue generated from this loop
  quality: number; // Retention rate of users from this loop
  amplification: number; // Secondary invites from this loop
}

export class AdvancedViralCalculator {
  private readonly WEDDING_SEASONS = {
    peak: [5, 6, 7, 8, 9], // May-September
    shoulder: [4, 10], // April, October
    off: [1, 2, 3, 11, 12] // Winter months
  };

  async calculateEnhanced(period: { start: Date; end: Date }): Promise<EnhancedViralCoefficient> {
    const cohortUsers = await this.getCohortUsers(period);

    // Calculate base viral coefficient
    const baseCoefficient = await this.calculateBaseCoefficient(cohortUsers);

    // Apply wedding industry adjustments
    const seasonalAdjustment = this.getSeasonalAdjustment(period);
    const qualityAdjustment = await this.calculateQualityAdjustment(cohortUsers);

    // Calculate sustainable coefficient (removing one-time spikes)
    const sustainableCoefficient = await this.calculateSustainableCoefficient(
      cohortUsers,
      baseCoefficient
    );

    // Analyze viral loops with revenue attribution
    const loops = await this.analyzeEnhancedLoops(cohortUsers);

    return {
      coefficient: baseCoefficient,
      adjustedCoefficient: baseCoefficient * seasonalAdjustment,
      sustainableCoefficient,
      invitationRate: await this.getInvitationRate(cohortUsers),
      acceptanceRate: await this.getAcceptanceRate(cohortUsers),
      activationRate: await this.getActivationRate(cohortUsers),
      avgInvitesPerUser: await this.getAvgInvites(cohortUsers),
      qualityScore: qualityAdjustment,
      timeToInvite: await this.avgTimeToFirstInvite(cohortUsers),
      viralCycleTime: await this.avgCycleTime(loops),
      velocityTrend: await this.getVelocityTrend(),
      loops,
      dominantLoop: this.identifyDominantLoop(loops),
      loopEfficiency: this.calculateLoopEfficiency(loops),
      weddingSeasonMultiplier: seasonalAdjustment,
      vendorTypeBreakdown: await this.analyzeVendorViralMetrics(cohortUsers),
      geographicSpread: await this.analyzeGeographicVirality(cohortUsers)
    };
  }

  private async analyzeEnhancedLoops(users: string[]): Promise<ViralLoop[]> {
    // Track complex multi-hop referral chains
    const { data: loops, error } = await supabase.rpc('analyze_viral_loops', {
      user_ids: users,
      depth_limit: 5
    });

    if (error) throw error;

    return loops.map((loop: any) => ({
      type: loop.loop_type,
      count: loop.loop_count,
      conversionRate: loop.unique_converts / users.length,
      avgCycleTime: loop.avg_cycle_days,
      revenue: loop.loop_revenue || 0,
      quality: loop.retention_rate || 0,
      amplification: loop.avg_depth
    }));
  }

  private getSeasonalAdjustment(period: { start: Date; end: Date }): number {
    const month = period.start.getMonth() + 1;
    
    if (this.WEDDING_SEASONS.peak.includes(month)) {
      return 1.4; // Peak wedding season boost
    } else if (this.WEDDING_SEASONS.shoulder.includes(month)) {
      return 1.1; // Shoulder season slight boost
    } else {
      return 0.7; // Off-season reduction
    }
  }

  private async calculateSustainableCoefficient(
    users: string[],
    baseCoefficient: number
  ): Promise<number> {
    // Remove outliers and one-time events
    const { data: stats, error } = await supabase
      .from('user_invitation_stats')
      .select(`
        user_id,
        invites_sent,
        invites_accepted,
        percentile_cont(0.75) WITHIN GROUP (ORDER BY invites_sent) OVER() as q3_invites
      `)
      .in('user_id', users);

    if (error) throw error;

    // Filter out users with abnormally high invitation rates (likely bulk imports)
    const sustainableUsers = stats.filter(
      stat => stat.invites_sent <= stat.q3_invites * 1.5
    );

    const sustainableRate = sustainableUsers.length / users.length;
    return baseCoefficient * sustainableRate * 0.85; // Conservative estimate
  }
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for advanced React visualization libraries, D3.js patterns
- [x] Supabase: Complex analytical queries, real-time viral metrics
- [x] Filesystem: Access viral calculation templates and models

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/d3/d3", "network visualization", 3000);
await mcp__context7__get-library-docs("/supabase/supabase", "advanced analytics", 2500);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('AdvancedViralCalculator', () => {
  it('should calculate seasonal adjustments correctly', () => {
    const calculator = new AdvancedViralCalculator();
    const juneAdjustment = calculator.getSeasonalAdjustment({ 
      start: new Date('2024-06-01'), 
      end: new Date('2024-06-30') 
    });
    expect(juneAdjustment).toBe(1.4); // Peak season
  });

  it('should identify viral bottlenecks accurately', async () => {
    const bottlenecks = await calculator.identifyViralBottlenecks();
    expect(bottlenecks[0].impact).toBeGreaterThan(bottlenecks[1].impact);
  });

  it('should calculate sustainable coefficient excluding outliers', async () => {
    const users = ['user1', 'user2', 'user3'];
    const baseCoef = 1.2;
    const sustainable = await calculator.calculateSustainableCoefficient(users, baseCoef);
    expect(sustainable).toBeLessThan(baseCoef); // Should be conservative
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Admin can view and interact with enhanced viral dashboard', async () => {
  await mcp__playwright__browser_navigate({url: '/admin/viral-metrics'});
  await mcp__playwright__browser_snapshot();
  
  // Switch to loops view
  await mcp__playwright__browser_click({
    element: 'Viral loops tab',
    ref: '[data-testid="viral-loops-tab"]'
  });
  
  // Verify Sankey diagram loads
  await mcp__playwright__browser_wait_for({text: 'supplier_to_couple'});
  
  // Test viral simulation
  await mcp__playwright__browser_click({
    element: 'Run simulation button',
    ref: '[data-testid="run-simulation"]'
  });
  
  await mcp__playwright__browser_snapshot();
});
```

### ACCEPTANCE CRITERIA
- [x] Calculates multi-dimensional viral coefficients (raw, seasonal, sustainable)
- [x] Tracks all viral loop types with revenue attribution
- [x] Provides wedding season adjustments (peak: 1.4x, off: 0.7x multipliers)
- [x] Identifies and ranks viral bottlenecks with optimization recommendations
- [x] Simulates intervention impact with confidence scores and ROI projections
- [x] Performance: Complex viral calculations complete under 10 seconds
- [x] Security: Admin role verification for all viral analytics access
- [x] Accuracy: Viral coefficient calculations match manual verification within 5%

### DEPENDENCIES
- Must complete after: User tracking system, basic analytics infrastructure
- Must complete before: Growth optimization experiments, viral marketing campaigns
- Shares code with: General analytics dashboard, user behavior tracking

### ESTIMATED EFFORT
- Team A Frontend: 28 hours (Enhanced viral dashboard, visualization components)
- Team B Backend: 32 hours (Advanced viral calculator, optimization engine)
- Team C Integration: 6 hours (Analytics data pipeline integration)
- Team D Platform: 8 hours (Database schema, complex query optimization)
- Team E General: 16 hours (Extensive testing, viral simulation validation)
- Team F Workflows: 4 hours (Automated viral metric reporting)
- Team G Performance: 6 hours (Query optimization, dashboard performance)
- Total: 100 hours