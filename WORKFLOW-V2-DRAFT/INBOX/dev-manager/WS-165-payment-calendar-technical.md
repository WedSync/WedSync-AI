# TECHNICAL SPECIFICATION: WS-165 - Payment Calendar
## Generated by Feature Development Session - August 23, 2025

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding couple managing payment deadlines
**I want to:** View upcoming payment due dates on a calendar with automatic reminders
**So that:** I never miss important payment deadlines and can plan cash flow effectively

### SPECIFICATION SOURCE
- **Feature ID:** WS-165
- **Original Spec:** /CORE-SPECIFICATIONS/03-WEDME-COUPLE-PLATFORM/08-Budget-Tracker/03-payment-calendar md.md

### TECHNICAL DESIGN

#### Database Schema Required
```sql
CREATE TABLE IF NOT EXISTS payment_schedule (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  couple_id UUID REFERENCES couples(id),
  category_id UUID REFERENCES budget_categories(id),
  vendor_name VARCHAR(255),
  payment_title VARCHAR(255) NOT NULL,
  amount DECIMAL(10,2) NOT NULL,
  due_date DATE NOT NULL,
  payment_type VARCHAR(50) CHECK (payment_type IN ('deposit', 'milestone', 'final_payment', 'installment')),
  status VARCHAR(30) CHECK (status IN ('upcoming', 'due_soon', 'overdue', 'paid')) DEFAULT 'upcoming',
  reminder_days_before INTEGER DEFAULT 7,
  last_reminder_sent TIMESTAMPTZ,
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS payment_reminders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  payment_id UUID REFERENCES payment_schedule(id) ON DELETE CASCADE,
  reminder_type VARCHAR(30) CHECK (reminder_type IN ('upcoming', 'due_today', 'overdue')),
  sent_at TIMESTAMPTZ DEFAULT NOW(),
  delivery_method VARCHAR(20)
);
```

### CODE EXAMPLES

```typescript
export function PaymentCalendar({ coupleId }: { coupleId: string }) {
  const [payments, setPayments] = useState<ScheduledPayment[]>([]);
  const [selectedDate, setSelectedDate] = useState(new Date());

  const getPaymentsByMonth = (date: Date) => {
    return payments.filter(payment => 
      new Date(payment.due_date).getMonth() === date.getMonth() &&
      new Date(payment.due_date).getFullYear() === date.getFullYear()
    );
  };

  const markPaymentPaid = async (paymentId: string, actualAmount: number) => {
    const { error } = await supabase
      .from('payment_schedule')
      .update({ 
        status: 'paid',
        actual_amount_paid: actualAmount,
        paid_date: new Date().toISOString().split('T')[0]
      })
      .eq('id', paymentId);

    if (!error) {
      // Update local state
      setPayments(payments.map(p => 
        p.id === paymentId ? { ...p, status: 'paid' } : p
      ));
    }
  };

  return (
    <div className="payment-calendar">
      <div className="calendar-view">
        <h2>Payment Calendar</h2>
        
        {/* Calendar component with payment indicators */}
        <div className="calendar-grid">
          {/* Calendar implementation */}
        </div>

        {/* Upcoming payments list */}
        <div className="upcoming-payments">
          <h3>Upcoming Payments</h3>
          {payments
            .filter(p => p.status !== 'paid')
            .sort((a, b) => new Date(a.due_date).getTime() - new Date(b.due_date).getTime())
            .map(payment => (
              <div key={payment.id} className="payment-item">
                <div className="flex justify-between items-center p-3 border rounded">
                  <div>
                    <div className="font-medium">{payment.payment_title}</div>
                    <div className="text-sm text-gray-600">
                      {payment.vendor_name} â€¢ Due {payment.due_date}
                    </div>
                  </div>
                  <div className="text-right">
                    <div className="font-bold">${payment.amount.toLocaleString()}</div>
                    <button
                      onClick={() => markPaymentPaid(payment.id, payment.amount)}
                      className="text-sm text-green-600 hover:text-green-800"
                    >
                      Mark Paid
                    </button>
                  </div>
                </div>
              </div>
            ))}
        </div>
      </div>
    </div>
  );
}
```

### ACCEPTANCE CRITERIA
- [x] Visual calendar showing payment due dates
- [x] Automatic payment reminders via email/SMS
- [x] Payment status tracking (upcoming/due/overdue/paid)
- [x] Integration with budget categories for cash flow planning
- [x] Installment payment schedules for large expenses

### DEPENDENCIES
- Must complete after: WS-163 (Budget Categories)
- Estimated Effort: 36 hours total