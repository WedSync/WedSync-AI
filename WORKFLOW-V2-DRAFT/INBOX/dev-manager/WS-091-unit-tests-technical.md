# TECHNICAL SPECIFICATION: WS-091 - Unit Tests Implementation
## Generated by Feature Development Session - 2025-08-22

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** WedSync development team
**I want to:** Have comprehensive unit testing for all components
**So that:** We can catch bugs before production, reduce debugging time by 70%, and ensure wedding data never gets corrupted

**Real Wedding Scenario:**
A photographer's form breaks in production, causing couples to re-enter 30+ fields multiple times.
With unit tests, this would be caught during development, preventing frustrated couples and saving photographers from apologizing for technical issues.

### SPECIFICATION SOURCE
- **Feature ID:** WS-091
- **Original Spec:** /CORE-SPECIFICATIONS/11-TESTING-DEPLOYMENT/01-Testing/01-unit-tests md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** 
  - /wedsync/vitest.config.ts (create)
  - /wedsync/tests/setup.ts (create)
  - /wedsync/package.json (update scripts)
- **New Files to Create:** 
  - Test files alongside components: `*.test.tsx`, `*.test.ts`
  - /wedsync/tests/mocks/* (mock utilities)

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- No new database schema required
-- Tests will use mocked database interactions
```

#### API Endpoints Required
```typescript
// No new API endpoints - testing existing endpoints
// Test utilities for mocking API responses
interface MockAPIResponse {
  status: number;
  data: any;
  error?: string;
}
```

#### Frontend Components Required
```typescript
// No new UI components - testing existing components
// Test setup utilities
interface TestProviders {
  children: React.ReactNode;
  initialState?: Partial<AppState>;
}

const AllTheProviders: React.FC<TestProviders> = ({ children, initialState }) => {
  return (
    <QueryClient>
      <AuthProvider mockUser={initialState?.user}>
        {children}
      </AuthProvider>
    </QueryClient>
  );
};
```

#### Integration Points
```typescript
// Testing utility service
class TestingService {
  async setupTestEnvironment() {
    // Configure vitest
    // Setup mocks
    // Initialize test database
  }
  
  async teardownTestEnvironment() {
    // Clean up mocks
    // Reset test state
  }
  
  mockSupabase() {
    return {
      from: vi.fn(),
      auth: { getUser: vi.fn() },
      storage: { from: vi.fn() }
    };
  }
}
```

### CODE EXAMPLES

#### Example 1: Vitest Configuration
```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  test: {
    environment: 'jsdom',
    globals: true,
    setupFiles: ['./tests/setup.ts'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html', 'lcov'],
      exclude: [
        'node_modules/',
        'tests/',
        '*.config.*',
        '**/*.d.ts',
        '**/types/**',
        '.next/**'
      ],
      thresholds: {
        statements: 80,
        branches: 75,
        functions: 80,
        lines: 80
      }
    }
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
      '@/lib': path.resolve(__dirname, './src/lib'),
      '@/components': path.resolve(__dirname, './src/components')
    }
  }
});
```

#### Example 2: Component Test Implementation
```typescript
// src/components/clients/__tests__/ClientList.test.tsx
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { ClientList } from '../ClientList';
import { mockSupabase } from '@/tests/mocks/supabase';

describe('ClientList Component', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('should render client list with correct data', async () => {
    const mockClients = [
      { id: '1', couple_names: 'Sarah & John', wedding_date: '2025-06-15' },
      { id: '2', couple_names: 'Emma & Michael', wedding_date: '2025-07-20' }
    ];
    
    mockSupabase.from.mockReturnValue({
      select: vi.fn().mockResolvedValue({ data: mockClients, error: null })
    });

    render(<ClientList supplierId="photographer-123" />);
    
    await waitFor(() => {
      expect(screen.getByText('Sarah & John')).toBeInTheDocument();
      expect(screen.getByText('Emma & Michael')).toBeInTheDocument();
    });
  });

  it('should handle empty client list gracefully', async () => {
    mockSupabase.from.mockReturnValue({
      select: vi.fn().mockResolvedValue({ data: [], error: null })
    });

    render(<ClientList supplierId="photographer-123" />);
    
    await waitFor(() => {
      expect(screen.getByText(/No clients found/i)).toBeInTheDocument();
    });
  });

  it('should filter clients by search term', async () => {
    const mockClients = [
      { id: '1', couple_names: 'Sarah & John', wedding_date: '2025-06-15' }
    ];
    
    mockSupabase.from.mockReturnValue({
      select: vi.fn().mockResolvedValue({ data: mockClients, error: null })
    });

    const { getByPlaceholderText } = render(<ClientList supplierId="photographer-123" />);
    const searchInput = getByPlaceholderText('Search clients...');
    
    fireEvent.change(searchInput, { target: { value: 'Sarah' } });
    
    await waitFor(() => {
      expect(screen.getByText('Sarah & John')).toBeInTheDocument();
    });
  });
});
```

#### Example 3: Utility Function Tests
```typescript
// src/lib/journey-engine/__tests__/executor.test.ts
import { describe, it, expect, vi } from 'vitest';
import { JourneyExecutor } from '../executor';
import { mockSupabase } from '@/tests/mocks/supabase';

describe('JourneyExecutor', () => {
  let executor: JourneyExecutor;
  
  beforeEach(() => {
    executor = new JourneyExecutor(mockSupabase);
  });

  it('should execute email node correctly', async () => {
    const node = {
      id: 'node-1',
      type: 'email',
      data: {
        template_id: 'welcome-email',
        to: 'couple@example.com'
      }
    };

    const emailSpy = vi.spyOn(executor, 'sendEmail').mockResolvedValue(true);
    
    await executor.executeNode(node);
    
    expect(emailSpy).toHaveBeenCalledWith({
      template_id: 'welcome-email',
      to: 'couple@example.com'
    });
  });

  it('should handle conditional branching', async () => {
    const journey = {
      nodes: [
        { id: 'start', type: 'trigger' },
        { id: 'branch', type: 'condition', data: { field: 'venue_type', operator: 'equals', value: 'outdoor' } },
        { id: 'outdoor-path', type: 'email' },
        { id: 'indoor-path', type: 'email' }
      ]
    };

    const context = { venue_type: 'outdoor' };
    const path = await executor.evaluatePath(journey, context);
    
    expect(path).toContain('outdoor-path');
    expect(path).not.toContain('indoor-path');
  });
});
```

### MCP SERVER USAGE

#### Required MCP Servers
- [ ] Context7: Load Vitest documentation
- [ ] Playwright: Not needed for unit tests
- [ ] Filesystem: Create test file structure

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/vitest/vitest", "config", 2000);
await mcp__context7__get-library-docs("/testing-library/react", "queries", 2000);
await mcp__context7__get-library-docs("/vitest/vitest", "mocking", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('Unit Test Coverage', () => {
  it('should test all React components', () => {
    // Every component needs at least:
    // - Render test
    // - Props validation test
    // - User interaction test
    // - Error state test
  });
  
  it('should test all utility functions', () => {
    // Every utility needs:
    // - Happy path test
    // - Edge cases test
    // - Error handling test
  });
  
  it('should test all API routes', () => {
    // Every route needs:
    // - Success response test
    // - Validation error test
    // - Auth check test
    // - Database error test
  });
});
```

#### E2E Tests Required
```typescript
// Not part of this feature - see WS-093
```

### ACCEPTANCE CRITERIA
- [ ] Vitest configured and running
- [ ] 80% code coverage achieved
- [ ] All critical paths have tests
- [ ] Test suite runs in under 60 seconds
- [ ] Coverage reports generated in CI
- [ ] Mocking utilities created for all external services
- [ ] Test documentation written
- [ ] Pre-commit hook runs tests

### DEPENDENCIES
- Must complete after: None - foundational
- Must complete before: WS-092 (Integration Tests), WS-095 (CI/CD)
- Shares code with: All features (testing them)

### ESTIMATED EFFORT
- Team A Frontend: 16 hours (component tests)
- Team B Backend: 12 hours (API/utility tests)
- Team C Integration: 8 hours (setup and configuration)
- Total: 36 hours