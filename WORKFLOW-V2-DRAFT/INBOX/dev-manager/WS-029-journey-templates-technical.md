# TECHNICAL SPECIFICATION: WS-029 - Journey Templates
## Generated by Feature Development Session - August 21, 2025

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding photographer launching my business with limited workflow knowledge
**I want to:** Choose from proven journey templates instead of building workflows from scratch
**So that:** I can start delivering professional client experiences immediately without guessing what communications couples expect

**Real Wedding Scenario:**
A new photographer spends 20+ hours creating email sequences for client communication.
They miss crucial touchpoints like timeline confirmation, resulting in day-of confusion.
With templates, they choose "Premium Photography Journey" and immediately have a 6-month communication flow with proven timing and content.

### SPECIFICATION SOURCE
- **Feature ID:** WS-029
- **Original Spec:** /CORE-SPECIFICATIONS/02-WEDSYNC-SUPPLIER-PLATFORM/05-Customer-Journey/06-journey-templates md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** None (new feature)
- **New Files to Create:**
  - /wedsync/src/components/templates/TemplateGallery.tsx
  - /wedsync/src/components/templates/TemplatePreview.tsx
  - /wedsync/src/components/templates/TemplateImporter.tsx
  - /wedsync/src/lib/services/template-service.ts
  - /wedsync/src/app/api/templates/route.ts
  - /wedsync/src/app/api/templates/clone/route.ts
  - /wedsync/supabase/migrations/021_journey_templates.sql

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Journey template definitions
CREATE TABLE IF NOT EXISTS journey_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  description TEXT,
  category TEXT NOT NULL CHECK (category IN ('photography', 'dj', 'catering', 'florist', 'venue', 'planner', 'other')),
  tier TEXT NOT NULL CHECK (tier IN ('basic', 'standard', 'premium')),
  created_by UUID REFERENCES suppliers(id) ON DELETE SET NULL,
  is_public BOOLEAN DEFAULT false,
  is_verified BOOLEAN DEFAULT false, -- Official WedSync templates
  template_data JSONB NOT NULL, -- Complete journey structure
  default_timeline JSONB NOT NULL, -- Timeline configuration
  variables JSONB DEFAULT '{}', -- Customizable variables
  usage_count INTEGER DEFAULT 0,
  rating_average DECIMAL(3,2) DEFAULT 0.00,
  rating_count INTEGER DEFAULT 0,
  tags TEXT[] DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Template usage tracking
CREATE TABLE IF NOT EXISTS template_usage (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  template_id UUID NOT NULL REFERENCES journey_templates(id) ON DELETE CASCADE,
  supplier_id UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,
  journey_id UUID REFERENCES journeys(id) ON DELETE SET NULL,
  cloned_at TIMESTAMPTZ DEFAULT NOW(),
  customizations JSONB DEFAULT '{}', -- What they changed
  performance_rating INTEGER CHECK (performance_rating >= 1 AND performance_rating <= 5)
);

-- Template ratings and reviews
CREATE TABLE IF NOT EXISTS template_reviews (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  template_id UUID NOT NULL REFERENCES journey_templates(id) ON DELETE CASCADE,
  supplier_id UUID NOT NULL REFERENCES suppliers(id) ON DELETE CASCADE,
  rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
  review_text TEXT,
  is_verified_purchase BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(template_id, supplier_id)
);

-- Template categories and collections
CREATE TABLE IF NOT EXISTS template_collections (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  description TEXT,
  template_ids UUID[] NOT NULL,
  is_featured BOOLEAN DEFAULT false,
  display_order INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_templates_category ON journey_templates(category, tier);
CREATE INDEX idx_templates_public ON journey_templates(is_public, is_verified);
CREATE INDEX idx_templates_rating ON journey_templates(rating_average DESC);
CREATE INDEX idx_template_usage_supplier ON template_usage(supplier_id, cloned_at DESC);
CREATE INDEX idx_template_reviews_rating ON template_reviews(template_id, rating);
```

#### API Endpoints Required
```typescript
// GET /api/templates?category=photography&tier=premium
interface TemplateListResponse {
  success: boolean;
  data: {
    templates: {
      id: string;
      name: string;
      description: string;
      category: string;
      tier: string;
      rating: number;
      usageCount: number;
      tags: string[];
      preview: {
        moduleCount: number;
        timelineLength: string;
        sampleModules: string[];
      };
      isVerified: boolean;
    }[];
    totalCount: number;
    featured: string[];
  };
}

// GET /api/templates/{templateId}
interface TemplateDetailResponse {
  success: boolean;
  data: {
    template: {
      id: string;
      name: string;
      description: string;
      category: string;
      tier: string;
      templateData: JourneyDefinition;
      defaultTimeline: TimelineConfig;
      variables: Record<string, VariableDefinition>;
      rating: number;
      reviews: TemplateReview[];
      usageCount: number;
      tags: string[];
    };
  };
}

// POST /api/templates/clone
interface CloneTemplateRequest {
  templateId: string;
  customizations: {
    name?: string;
    timeline?: Partial<TimelineConfig>;
    variableOverrides?: Record<string, any>;
    moduleModifications?: ModuleUpdate[];
  };
}

interface CloneTemplateResponse {
  success: boolean;
  data: {
    journeyId: string;
    clonedTemplate: JourneyDefinition;
  };
}

// POST /api/templates/{templateId}/rate
interface RateTemplateRequest {
  rating: number;
  review?: string;
}

// POST /api/templates/import
interface ImportTemplateRequest {
  templateJson: string;
  makePublic?: boolean;
}
```

#### Frontend Components Required
```typescript
// Component: TemplateGallery
// Location: /src/components/templates/TemplateGallery.tsx

interface TemplateGalleryProps {
  category?: string;
  tier?: string;
  onTemplateSelect: (template: TemplatePreview) => void;
  showFeatured?: boolean;
}

// Key functionality:
- Filter by category and tier
- Search by name and tags
- Sort by rating/usage/recent
- Featured template carousel
- Infinite scroll pagination
- Preview on hover

// Component: TemplatePreview
// Location: /src/components/templates/TemplatePreview.tsx

interface TemplatePreviewProps {
  template: TemplateDetail;
  onClone: (customizations: TemplateCustomizations) => void;
  onRate?: (rating: number, review?: string) => void;
}

// Key functionality:
- Visual journey flow diagram
- Module breakdown display
- Timeline visualization
- Customization panel
- One-click clone with defaults
- Rating and review interface

// Component: TemplateImporter
// Location: /src/components/templates/TemplateImporter.tsx

interface TemplateImporterProps {
  onImport: (template: ImportedTemplate) => void;
  onExport: (journeyId: string) => void;
}

// Key functionality:
- JSON file upload/download
- Template validation
- Export existing journeys as templates
- Version comparison
- Bulk import handling
```

#### Integration Points
```typescript
// Service: TemplateService
// Dependencies: JourneyService, ValidationService, FileService

class TemplateService {
  async getTemplates(filters: TemplateFilters) {
    // Fetch templates with filtering
    // Apply user preferences
    // Return paginated results
  }

  async cloneTemplate(templateId: string, customizations: TemplateCustomizations) {
    // Load template definition
    // Apply customizations
    // Create new journey instance
    // Schedule initial modules
  }

  async validateTemplate(templateData: any) {
    // Schema validation
    // Module compatibility check
    // Timeline consistency
    // Variable reference validation
  }

  async exportTemplate(journeyId: string) {
    // Convert journey to template format
    // Strip instance-specific data
    // Include performance metrics
    // Generate shareable JSON
  }
}
```

### CODE EXAMPLES

#### Example 1: Template Cloning with Customizations
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { supabase } from '@/lib/supabase';
import { JourneyService } from '@/lib/services/journey-service';

export async function cloneJourneyTemplate(
  templateId: string,
  customizations: TemplateCustomizations,
  supplierId: string
) {
  // Step 1: Load template definition
  const { data: template, error } = await supabase
    .from('journey_templates')
    .select('*')
    .eq('id', templateId)
    .single();

  if (error) throw new Error(`Template not found: ${error.message}`);

  // Step 2: Apply customizations to template data
  const clonedJourney = {
    ...template.template_data,
    name: customizations.name || `${template.name} (Copy)`,
    supplier_id: supplierId
  };

  // Step 3: Customize timeline if provided
  if (customizations.timeline) {
    clonedJourney.timeline = {
      ...template.default_timeline,
      ...customizations.timeline
    };
  }

  // Step 4: Apply variable overrides
  if (customizations.variableOverrides) {
    clonedJourney.variables = {
      ...template.variables,
      ...customizations.variableOverrides
    };
  }

  // Step 5: Modify modules if requested
  if (customizations.moduleModifications) {
    for (const modification of customizations.moduleModifications) {
      const moduleIndex = clonedJourney.modules.findIndex(
        m => m.id === modification.moduleId
      );
      
      if (moduleIndex >= 0) {
        if (modification.action === 'remove') {
          clonedJourney.modules.splice(moduleIndex, 1);
        } else if (modification.action === 'update') {
          clonedJourney.modules[moduleIndex] = {
            ...clonedJourney.modules[moduleIndex],
            ...modification.updates
          };
        }
      }
    }
  }

  // Step 6: Create the new journey
  const journeyService = new JourneyService();
  const newJourney = await journeyService.createJourney(clonedJourney);

  // Step 7: Track template usage
  await supabase
    .from('template_usage')
    .insert({
      template_id: templateId,
      supplier_id: supplierId,
      journey_id: newJourney.id,
      customizations: customizations
    });

  // Step 8: Update template usage count
  await supabase
    .rpc('increment_template_usage', { template_id: templateId });

  return newJourney;
}
```

#### Example 2: Template Validation and Import
```typescript
// Template validation before import/save
export async function validateJourneyTemplate(templateData: any): Promise<ValidationResult> {
  const errors: string[] = [];
  const warnings: string[] = [];

  // Step 1: Schema validation
  if (!templateData.name || typeof templateData.name !== 'string') {
    errors.push('Template name is required and must be a string');
  }

  if (!templateData.modules || !Array.isArray(templateData.modules)) {
    errors.push('Template must have modules array');
  }

  // Step 2: Module validation
  for (const [index, module] of templateData.modules.entries()) {
    if (!module.type || !module.config) {
      errors.push(`Module ${index}: Missing type or config`);
    }

    // Validate module type exists
    const validModuleTypes = ['email', 'sms', 'form', 'task', 'delay'];
    if (!validModuleTypes.includes(module.type)) {
      errors.push(`Module ${index}: Invalid type '${module.type}'`);
    }

    // Validate module config based on type
    if (module.type === 'email') {
      if (!module.config.subject || !module.config.template) {
        errors.push(`Module ${index}: Email modules require subject and template`);
      }
    }
  }

  // Step 3: Timeline validation
  if (templateData.timeline) {
    const timeline = templateData.timeline;
    
    // Check for valid duration
    if (timeline.duration && timeline.duration < 1) {
      warnings.push('Timeline duration is very short (less than 1 day)');
    }

    // Validate timeline events
    for (const event of timeline.events || []) {
      if (!event.trigger || !event.moduleId) {
        errors.push(`Timeline event missing trigger or moduleId`);
      }

      // Check if referenced module exists
      const moduleExists = templateData.modules.some(m => m.id === event.moduleId);
      if (!moduleExists) {
        errors.push(`Timeline references non-existent module: ${event.moduleId}`);
      }
    }
  }

  // Step 4: Variable validation
  if (templateData.variables) {
    for (const [varName, varDef] of Object.entries(templateData.variables)) {
      if (!varDef.type || !varDef.defaultValue) {
        warnings.push(`Variable '${varName}' missing type or default value`);
      }
    }
  }

  return {
    isValid: errors.length === 0,
    errors,
    warnings,
    score: calculateTemplateScore(templateData, errors, warnings)
  };
}

function calculateTemplateScore(template: any, errors: string[], warnings: string[]): number {
  let score = 100;
  score -= errors.length * 20; // Major penalty for errors
  score -= warnings.length * 5; // Minor penalty for warnings
  
  // Bonus points for good practices
  if (template.description && template.description.length > 50) score += 5;
  if (template.modules.length >= 5) score += 10;
  if (template.timeline && template.timeline.events.length > 0) score += 10;
  
  return Math.max(0, Math.min(100, score));
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load Next.js and Supabase docs
- [x] Filesystem: Access project structure
- [ ] Playwright: Test template gallery interaction

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/vercel/next.js", "app router api routes", 3000);
await mcp__context7__get-library-docs("/supabase/supabase", "database functions", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('TemplateService', () => {
  it('should clone template with customizations', async () => {
    const template = mockTemplate();
    const customizations = { name: 'Custom Journey' };
    const cloned = await cloneTemplate(template.id, customizations);
    expect(cloned.name).toBe('Custom Journey');
  });

  it('should validate template structure', async () => {
    const invalidTemplate = { name: 'Test' }; // Missing modules
    const result = await validateTemplate(invalidTemplate);
    expect(result.isValid).toBe(false);
    expect(result.errors).toContain('Template must have modules array');
  });

  it('should calculate template score correctly', () => {
    const goodTemplate = {
      name: 'Premium Photography',
      description: 'A comprehensive wedding photography communication flow',
      modules: Array(6).fill(mockModule()),
      timeline: { events: [mockEvent()] }
    };
    const score = calculateTemplateScore(goodTemplate, [], []);
    expect(score).toBeGreaterThan(80);
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Template gallery and cloning flow', async () => {
  await mcp__playwright__browser_navigate({url: '/templates'});
  
  // Verify gallery loads
  await mcp__playwright__browser_snapshot();
  
  // Filter by category
  await mcp__playwright__browser_click({
    element: 'Photography filter',
    ref: 'button:has-text("Photography")'
  });
  
  // Select a template
  await mcp__playwright__browser_click({
    element: 'Template card',
    ref: '.template-card:first-child'
  });
  
  // Customize and clone
  await mcp__playwright__browser_type({
    element: 'Template name input',
    ref: 'input[name="templateName"]',
    text: 'My Custom Journey'
  });
  
  await mcp__playwright__browser_click({
    element: 'Clone template button',
    ref: 'button:has-text("Clone Template")'
  });
  
  // Verify success
  await mcp__playwright__browser_wait_for({text: 'Template cloned successfully'});
});
```

### ACCEPTANCE CRITERIA
- [x] Browse templates by category and tier
- [x] Preview template structure before cloning
- [x] Clone with customizations (name, timeline, variables)
- [x] Import/export templates as JSON files
- [x] Rate and review templates
- [x] Search templates by name and tags
- [x] Featured template collections
- [x] Performance: Gallery loads in <2 seconds
- [x] Security: Only show appropriate templates per supplier type
- [x] Validation: Prevent importing broken templates

### DEPENDENCIES
- Must complete after: WS-015 (Journey Builder UI)
- Must complete before: None
- Shares code with: WS-030 (Journey Execution Engine)

### ESTIMATED EFFORT
- Team A Frontend: 32 hours
- Team B Backend: 20 hours
- Team C Integration: 12 hours (import/export)
- Total: 64 hours