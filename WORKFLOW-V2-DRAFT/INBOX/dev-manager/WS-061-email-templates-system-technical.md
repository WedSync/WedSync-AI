# TECHNICAL SPECIFICATION: WS-061 - Email Templates System
## Generated by Feature Development Session - August 21, 2025

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding photographer 
**I want to:** Create and manage personalized email templates for different wedding stages
**So that:** I can save 3+ hours per client by not rewriting the same emails repeatedly and ensure consistent communication throughout the wedding process

**Real Wedding Scenario:**
A wedding photographer currently writes personalized emails for initial consultation, contract sending, shot list requests, timeline confirmation, post-wedding photo delivery, and review requests. Each email takes 10-15 minutes to personalize with client details. With this template system, they create templates once with merge fields like {{couple_names}}, {{wedding_date}}, {{venue_name}} and generate personalized emails in seconds.

### SPECIFICATION SOURCE
- **Feature ID:** WS-061
- **Original Spec:** /CORE-SPECIFICATIONS/02-WEDSYNC-SUPPLIER-PLATFORM/06-Communications/01-email-templates md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** 
  - `/wedsync/src/components/communications/EmailTemplateEditor.tsx`
  - `/wedsync/src/lib/services/emailTemplateService.ts`
  - `/wedsync/src/app/api/templates/route.ts`
- **New Files to Create:** 
  - `/wedsync/src/components/communications/TemplateLibrary.tsx`
  - `/wedsync/src/components/communications/MergeFieldSelector.tsx`
  - `/wedsync/src/types/email-templates.ts`
  - `/wedsync/supabase/migrations/024_email_templates_system.sql`

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Email templates table
CREATE TABLE IF NOT EXISTS email_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  category email_template_category NOT NULL DEFAULT 'custom',
  subject TEXT NOT NULL,
  html_content TEXT NOT NULL,
  plain_text_content TEXT,
  merge_fields JSONB DEFAULT '[]'::jsonb,
  folder_id UUID REFERENCES template_folders(id) ON DELETE SET NULL,
  is_favorite BOOLEAN DEFAULT false,
  version INTEGER DEFAULT 1,
  parent_template_id UUID REFERENCES email_templates(id) ON DELETE SET NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Template categories enum
CREATE TYPE email_template_category AS ENUM (
  'welcome',
  'reminder', 
  'follow_up',
  'contract',
  'timeline',
  'delivery',
  'review_request',
  'custom'
);

-- Template folders for organization
CREATE TABLE IF NOT EXISTS template_folders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  parent_folder_id UUID REFERENCES template_folders(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Content blocks for reusable components
CREATE TABLE IF NOT EXISTS template_content_blocks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  block_type content_block_type NOT NULL,
  content TEXT NOT NULL,
  is_global BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TYPE content_block_type AS ENUM (
  'header',
  'footer', 
  'signature',
  'social_links',
  'call_to_action',
  'image_gallery'
);

-- RLS policies
ALTER TABLE email_templates ENABLE ROW LEVEL SECURITY;
ALTER TABLE template_folders ENABLE ROW LEVEL SECURITY;
ALTER TABLE template_content_blocks ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage their own email templates" ON email_templates
  FOR ALL USING (auth.uid() = user_id);

CREATE POLICY "Users can manage their own template folders" ON template_folders
  FOR ALL USING (auth.uid() = user_id);

CREATE POLICY "Users can manage their own content blocks" ON template_content_blocks
  FOR ALL USING (auth.uid() = user_id);
```

#### API Endpoints Required
```typescript
// GET /api/templates
interface GetTemplatesResponse {
  success: boolean;
  data: {
    templates: EmailTemplate[];
    folders: TemplateFolder[];
    totalCount: number;
  };
}

// POST /api/templates
interface CreateTemplateRequest {
  name: string;
  category: EmailTemplateCategory;
  subject: string;
  htmlContent: string;
  plainTextContent?: string;
  mergeFields: string[];
  folderId?: string;
}

interface CreateTemplateResponse {
  success: boolean;
  data: EmailTemplate;
}

// PUT /api/templates/[id]
interface UpdateTemplateRequest {
  name?: string;
  subject?: string;
  htmlContent?: string;
  plainTextContent?: string;
  mergeFields?: string[];
  folderId?: string;
  isFavorite?: boolean;
}

// POST /api/templates/[id]/clone
interface CloneTemplateResponse {
  success: boolean;
  data: EmailTemplate;
}

// POST /api/templates/[id]/preview
interface PreviewTemplateRequest {
  clientId: string;
  mergeData: Record<string, any>;
}

interface PreviewTemplateResponse {
  success: boolean;
  data: {
    subject: string;
    htmlContent: string;
    plainTextContent: string;
  };
}

// GET /api/templates/merge-fields
interface GetMergeFieldsResponse {
  success: boolean;
  data: {
    client: Array<{key: string; label: string; example: string}>;
    supplier: Array<{key: string; label: string; example: string}>;
    wedding: Array<{key: string; label: string; example: string}>;
  };
}
```

#### Frontend Components Required
```typescript
// Component: EmailTemplateEditor
// Location: /src/components/communications/EmailTemplateEditor.tsx

interface EmailTemplateEditorProps {
  template?: EmailTemplate;
  onSave: (template: Partial<EmailTemplate>) => Promise<void>;
  onCancel: () => void;
}

// Key functionality:
- WYSIWYG rich text editor with wedding-specific content blocks
- HTML/visual mode toggle
- Real-time responsive preview (desktop/mobile)
- Merge field insertion with autocomplete
- Brand kit integration (colors, fonts, logos)
- Template organization (folders, favorites)
- Version history and rollback
- AI-powered content suggestions

// Component: TemplateLibrary
// Location: /src/components/communications/TemplateLibrary.tsx

interface TemplateLibraryProps {
  onSelectTemplate: (template: EmailTemplate) => void;
  selectedCategory?: EmailTemplateCategory;
  searchQuery?: string;
}

// Key functionality:
- Grid/list view of templates with thumbnails
- Category filtering and folder navigation
- Search by name, content, or merge fields
- Favorite/unfavorite templates
- Clone, edit, delete actions
- Bulk operations for multiple templates

// Component: MergeFieldSelector
// Location: /src/components/communications/MergeFieldSelector.tsx

interface MergeFieldSelectorProps {
  onInsertField: (field: string) => void;
  currentContent: string;
}

// Key functionality:
- Categorized merge field browser (client, wedding, supplier)
- Field preview with example data
- Drag-and-drop field insertion
- Custom field creation for advanced users
```

#### Integration Points
```typescript
// Service: EmailTemplateService
// Dependencies: Supabase, ClientService, FileUploadService

class EmailTemplateService {
  async createTemplate(template: CreateTemplateRequest): Promise<EmailTemplate> {
    // 1. Validate template structure and merge fields
    // 2. Process embedded images and upload to storage
    // 3. Save template to database
    // 4. Generate thumbnail for library view
  }

  async renderTemplate(templateId: string, clientData: any): Promise<RenderedEmail> {
    // 1. Fetch template and merge field definitions
    // 2. Process merge fields with client data
    // 3. Handle conditional content based on wedding details
    // 4. Return fully rendered HTML and plain text
  }

  async getMergeFieldData(clientId: string): Promise<MergeFieldData> {
    // 1. Aggregate client, wedding, and supplier data
    // 2. Format data for template rendering
    // 3. Include computed fields like days_until_wedding
  }
}
```

### CODE EXAMPLES

#### Example 1: Template Rendering with Merge Fields
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { supabase } from '@/lib/supabase';
import { EmailTemplate, MergeFieldData } from '@/types/email-templates';

export async function renderEmailTemplate(
  templateId: string, 
  clientId: string
): Promise<{subject: string; htmlContent: string; plainTextContent: string}> {
  // Step 1: Fetch template
  const { data: template, error: templateError } = await supabase
    .from('email_templates')
    .select('*')
    .eq('id', templateId)
    .single();
    
  if (templateError) throw templateError;
  
  // Step 2: Get client merge data
  const { data: client, error: clientError } = await supabase
    .from('clients')
    .select(`
      *,
      wedding_details:wedding_details(*),
      supplier_profile:profiles(business_name, contact_email)
    `)
    .eq('id', clientId)
    .single();
    
  if (clientError) throw clientError;
  
  // Step 3: Build merge field data
  const mergeData = {
    '{{couple_names}}': `${client.partner1_name} & ${client.partner2_name}`,
    '{{wedding_date}}': new Date(client.wedding_date).toLocaleDateString(),
    '{{venue_name}}': client.wedding_details?.venue_name || 'TBD',
    '{{days_until}}': Math.ceil((new Date(client.wedding_date).getTime() - Date.now()) / (1000 * 60 * 60 * 24)),
    '{{supplier_name}}': client.supplier_profile?.business_name,
    '{{supplier_email}}': client.supplier_profile?.contact_email
  };
  
  // Step 4: Replace merge fields
  let renderedSubject = template.subject;
  let renderedHtml = template.html_content;
  let renderedPlain = template.plain_text_content || '';
  
  Object.entries(mergeData).forEach(([field, value]) => {
    const regex = new RegExp(field.replace(/[{}]/g, '\\$&'), 'g');
    renderedSubject = renderedSubject.replace(regex, String(value));
    renderedHtml = renderedHtml.replace(regex, String(value));
    renderedPlain = renderedPlain.replace(regex, String(value));
  });
  
  return {
    subject: renderedSubject,
    htmlContent: renderedHtml,
    plainTextContent: renderedPlain
  };
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for React WYSIWYG editors, email template libraries
- [x] Filesystem: Access existing email service implementations
- [x] Memory: Store email template patterns for consistency

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/facebook/draft-js", "rich text editor", 3000);
await mcp__context7__get-library-docs("/microsoft/monaco-editor", "html editor", 2000);
await mcp__context7__get-library-docs("/supabase/supabase", "real-time subscriptions", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('EmailTemplateService', () => {
  it('should render template with wedding merge fields', async () => {
    const rendered = await renderEmailTemplate('template-123', 'client-456');
    expect(rendered.subject).toContain('John & Jane');
    expect(rendered.htmlContent).toContain('June 15, 2025');
  });

  it('should handle missing merge field data gracefully', async () => {
    const rendered = await renderEmailTemplate('template-123', 'client-incomplete');
    expect(rendered.htmlContent).not.toContain('{{venue_name}}');
    expect(rendered.htmlContent).toContain('TBD');
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Email template creation workflow', async () => {
  await mcp__playwright__browser_navigate({url: '/communications/templates'});
  await mcp__playwright__browser_snapshot();
  
  // Create new template
  await mcp__playwright__browser_click({element: 'Create Template button', ref: 'button[data-testid="create-template"]'});
  await mcp__playwright__browser_type({
    element: 'template name input',
    ref: 'input[name="templateName"]',
    text: 'Wedding Consultation Follow-up'
  });
  
  // Insert merge field
  await mcp__playwright__browser_click({element: 'merge field selector', ref: 'button[data-testid="merge-fields"]'});
  await mcp__playwright__browser_click({element: 'couple names field', ref: 'button[data-field="couple_names"]'});
  
  // Verify accessibility
  await mcp__playwright__browser_evaluate({
    function: '() => axe.run()'
  });
});
```

### ACCEPTANCE CRITERIA
- [x] Email templates can be created with WYSIWYG editor
- [x] Merge fields automatically populate with client wedding data
- [x] Templates are organized in folders with search/filter capability
- [x] Responsive email preview works for desktop and mobile
- [x] Template versioning allows rollback to previous versions
- [x] Performance: Template rendering completes within 500ms
- [x] Security: Templates are isolated per supplier user
- [x] Accessibility: Editor meets WCAG 2.1 AA standards

### DEPENDENCIES
- Must complete after: None (foundational feature)
- Must complete before: WS-062 (SMS Configuration), WS-064 (Meeting Scheduler)  
- Shares code with: Communication infrastructure, client data services

### ESTIMATED EFFORT
- Team A Frontend: 24 hours (WYSIWYG editor, template library, merge field UI)
- Team B Backend: 16 hours (API endpoints, template rendering, database schema)
- Team C Integration: 8 hours (Email service integration, merge field processing)
- Total: 48 hours