# TECHNICAL SPECIFICATION: WS-306 - Forms System Section Overview
## Generated by Feature Development Session - 2025-01-20

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding photographer who sends the same 20 questions to every couple via email
**I want to:** Create dynamic wedding forms with drag-drop fields, AI assistance, and automatic data sync to client profiles
**So that:** I can eliminate 2+ hours per couple spent copying responses from emails into spreadsheets and asking the same questions multiple times

**Real Wedding Scenario:**
"A wedding photographer currently emails couples a list of 20 questions about venue, timeline, guest count, special requests, etc. Couples respond inconsistently, information gets scattered across email threads, and the photographer has to manually transfer data to planning documents. With the forms system, one custom form collects all wedding details in a structured format that automatically populates client profiles and wedding timelines."

### SPECIFICATION SOURCE
- **Feature ID:** WS-306
- **Original Spec:** /CORE-SPECIFICATIONS/02-WEDSYNC-SUPPLIER-PLATFORM/04-Forms-System.md
- **Current Implementation:** 15% complete (basic form structure exists)
- **Files to Modify:**
  - /wedsync/src/app/(dashboard)/forms/page.tsx
  - /wedsync/src/lib/validations/forms.ts
- **New Files to Create:**
  - /wedsync/src/components/forms/FormSystemLayout.tsx
  - /wedsync/src/components/forms/FormBuilder.tsx
  - /wedsync/src/lib/services/form-system-service.ts
  - /wedsync/src/hooks/useFormSystem.ts

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- Core forms table
CREATE TABLE IF NOT EXISTS forms (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  supplier_id UUID NOT NULL REFERENCES user_profiles(id) ON DELETE CASCADE,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  fields JSONB NOT NULL DEFAULT '[]',
  settings JSONB DEFAULT '{}',
  is_template BOOLEAN DEFAULT FALSE,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Form responses table
CREATE TABLE IF NOT EXISTS form_responses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  form_id UUID NOT NULL REFERENCES forms(id) ON DELETE CASCADE,
  client_id UUID NOT NULL REFERENCES clients(id) ON DELETE CASCADE,
  responses JSONB NOT NULL DEFAULT '{}',
  submitted_at TIMESTAMPTZ DEFAULT NOW(),
  ip_address INET,
  user_agent TEXT
);

-- Form analytics table
CREATE TABLE IF NOT EXISTS form_analytics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  form_id UUID NOT NULL REFERENCES forms(id) ON DELETE CASCADE,
  metric_type VARCHAR(50) NOT NULL,
  metric_value NUMERIC,
  date_recorded DATE DEFAULT CURRENT_DATE,
  metadata JSONB DEFAULT '{}'
);
```

#### API Endpoints Required
```typescript
// GET /api/forms/system/overview
interface FormSystemOverview {
  total_forms: number;
  active_forms: number;
  total_responses: number;
  avg_completion_rate: number;
  recent_forms: FormSummary[];
}

// POST /api/forms
interface CreateFormRequest {
  title: string;
  description?: string;
  fields: FormField[];
  settings: FormSettings;
  is_template?: boolean;
}

interface FormField {
  id: string;
  type: 'text' | 'email' | 'phone' | 'date' | 'select' | 'multiselect' | 'textarea' | 'number' | 'wedding_date' | 'venue_address' | 'guest_count';
  label: string;
  required: boolean;
  options?: string[];
  validation?: Record<string, any>;
  mapping?: string; // Maps to core wedding fields
}
```

#### Frontend Components Required
```typescript
// Component: FormSystemLayout
// Location: /src/components/forms/FormSystemLayout.tsx

interface FormSystemLayoutProps {
  children: React.ReactNode;
  currentSection: 'overview' | 'builder' | 'templates' | 'responses' | 'analytics';
}

// Key functionality:
- Navigation between form management sections
- Quick access to form builder and templates
- Search and filter forms
- Form performance metrics display

// Component: FormBuilder
// Location: /src/components/forms/FormBuilder.tsx

interface FormBuilderProps {
  formId?: string;
  onSave: (form: FormData) => void;
  onPublish: (form: FormData) => void;
}

// Key functionality:
- Drag-drop form field interface
- Wedding-specific field types
- Real-time preview
- AI-powered field suggestions
- Core fields mapping
```

#### Integration Points
```typescript
// Service: FormSystemService
// Dependencies: SupabaseService, AIService, ValidationService

class FormSystemService {
  async getSystemOverview(supplierId: string): Promise<FormSystemOverview> {
    // Aggregate form statistics and recent activity
  }
  
  async createForm(form: CreateFormRequest): Promise<string> {
    // Create new form with validation
  }
  
  async generateFormFromTemplate(templateType: string): Promise<FormField[]> {
    // AI-powered form generation based on wedding vendor type
  }
  
  async mapFieldsToCore(responses: Record<string, any>): Promise<CoreWeddingData> {
    // Map form responses to standardized wedding data structure
  }
}
```

### CODE EXAMPLES

#### Example 1: Form Builder Hook Implementation
```typescript
// ACTUAL CODE PATTERN TO FOLLOW:
import { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabase';
import { useToast } from '@/components/ui/use-toast';

interface FormField {
  id: string;
  type: string;
  label: string;
  required: boolean;
  options?: string[];
  validation?: Record<string, any>;
}

export function useFormSystem(supplierId: string) {
  const [overview, setOverview] = useState<FormSystemOverview | null>(null);
  const [forms, setForms] = useState<FormSummary[]>([]);
  const [loading, setLoading] = useState(true);
  const { toast } = useToast();

  useEffect(() => {
    loadFormSystemData();
  }, [supplierId]);

  async function loadFormSystemData() {
    try {
      setLoading(true);
      
      // Load forms overview
      const { data: overviewData } = await supabase
        .rpc('get_form_system_overview', { supplier_id: supplierId });
      
      // Load user forms
      const { data: formsData } = await supabase
        .from('forms')
        .select(`
          id, title, description, is_active, is_template, created_at,
          form_responses(count)
        `)
        .eq('supplier_id', supplierId)
        .order('updated_at', { ascending: false });
        
      setOverview(overviewData);
      setForms(formsData || []);
      
    } catch (error) {
      toast({
        title: "Error loading forms",
        description: "Please try refreshing the page",
        variant: "destructive"
      });
    } finally {
      setLoading(false);
    }
  }

  async function createForm(formData: CreateFormRequest) {
    try {
      const { data, error } = await supabase
        .from('forms')
        .insert({
          supplier_id: supplierId,
          ...formData,
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        })
        .select()
        .single();

      if (!error) {
        setForms(prev => [data, ...prev]);
        toast({
          title: "Form created",
          description: `"${formData.title}" has been created successfully`
        });
        return data.id;
      }
    } catch (error) {
      toast({
        title: "Error creating form",
        variant: "destructive"
      });
      throw error;
    }
  }

  async function generateWeddingForm(vendorType: string) {
    try {
      // Call AI service to generate form fields based on vendor type
      const response = await fetch('/api/ai/generate-form', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ vendor_type: vendorType, supplier_id: supplierId })
      });
      
      const { fields } = await response.json();
      return fields;
      
    } catch (error) {
      toast({
        title: "Error generating form",
        description: "AI form generation temporarily unavailable",
        variant: "destructive"
      });
      return [];
    }
  }

  return {
    overview,
    forms,
    loading,
    createForm,
    generateWeddingForm,
    refresh: loadFormSystemData
  };
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for React DnD, form validation libraries
- [ ] Playwright: Test form builder drag-drop functionality
- [ ] Filesystem: Access form field templates

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/react-hook-form/react-hook-form", "validation schemas", 2500);
await mcp__context7__get-library-docs("/atlassian/react-beautiful-dnd", "drag drop forms", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('FormSystemService', () => {
  it('should create wedding form with required fields', async () => {
    const service = new FormSystemService();
    const formData = {
      title: 'Wedding Details Form',
      fields: [
        { id: '1', type: 'wedding_date', label: 'Wedding Date', required: true },
        { id: '2', type: 'venue_address', label: 'Venue Address', required: true }
      ],
      settings: { allow_multiple_submissions: false }
    };
    
    const formId = await service.createForm(formData);
    expect(formId).toBeDefined();
  });

  it('should map form responses to core wedding data', async () => {
    const service = new FormSystemService();
    const responses = {
      'wedding_date': '2025-06-15',
      'venue_address': '123 Wedding Venue St',
      'guest_count': '150'
    };
    
    const coreData = await service.mapFieldsToCore(responses);
    expect(coreData.wedding_date).toBe('2025-06-15');
    expect(coreData.estimated_guest_count).toBe(150);
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('Form builder drag-drop workflow', async () => {
  await mcp__playwright__browser_navigate({url: '/forms/builder'});
  await mcp__playwright__browser_snapshot();
  
  // Test dragging field from palette
  await mcp__playwright__browser_drag({
    startElement: "Text field from palette",
    startRef: "[data-field-type='text']",
    endElement: "Form canvas drop zone",
    endRef: "[data-testid='form-canvas']"
  });
  
  // Verify field was added
  await mcp__playwright__browser_snapshot();
});
```

### ACCEPTANCE CRITERIA
- [ ] Form builder supports drag-drop interface for wedding-specific field types
- [ ] AI can generate relevant form templates based on vendor type (photographer, venue, caterer)
- [ ] Form responses automatically map to core wedding data fields
- [ ] Forms can be shared via public links with couples
- [ ] Performance: Form builder loads and operates smoothly with 50+ fields
- [ ] Security: Form responses are encrypted and access-controlled per supplier
- [ ] Accessibility: Form builder and generated forms are screen reader compatible

### DEPENDENCIES
- Must complete after: WS-305 (Client Management foundation for response tracking)
- Must complete before: WS-308 (Customer Journey system integration)
- Shares code with: AI form generation, PDF import system, core fields mapping

### ESTIMATED EFFORT
- Team A Frontend: 24 hours
- Team B Backend: 16 hours
- Team C Integration: 8 hours
- Team D Platform: 12 hours (AI form generation)
- Team E General: 4 hours
- Team F Workflows: 0 hours
- Team G Performance: 4 hours
- Total: 68 hours