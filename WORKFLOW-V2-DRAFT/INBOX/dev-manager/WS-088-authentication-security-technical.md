# TECHNICAL SPECIFICATION: WS-088 - Authentication Security
## Generated by Feature Development Session - 2025-08-22

### USER STORY & BUSINESS CONTEXT (THINK HARD - BE FACTUAL)
**As a:** Wedding photographer storing client personal information and payment details
**I want to:** Know my account and client data are protected from unauthorized access
**So that:** I can confidently store sensitive wedding details without fear of data breaches affecting my business reputation

**Real Wedding Scenario:**
A photographer's account contains guest lists with addresses, dietary restrictions, and personal notes for 50+ upcoming weddings. If their account is compromised, not only could client personal data be exposed, but competitor photographers could access their client list and business strategies. Multi-factor authentication and session monitoring protect both their business and client privacy.

### SPECIFICATION SOURCE
- **Feature ID:** WS-088
- **Original Spec:** /CORE-SPECIFICATIONS/10-SECURITY-COMPLIANCE/01-authentication-security md.md
- **Current Implementation:** 0% complete
- **Files to Modify:** 
  - /wedsync/src/middleware.ts
  - /wedsync/src/lib/auth/supabase.ts
  - /wedsync/src/components/auth/*.tsx
- **New Files to Create:** 
  - /wedsync/src/lib/security/auth-security.ts
  - /wedsync/src/lib/security/mfa.ts
  - /wedsync/src/lib/security/rate-limiter.ts
  - /wedsync/src/components/auth/MFASetup.tsx

### TECHNICAL DESIGN

#### Database Schema Required
```sql
-- User devices tracking for security
CREATE TABLE user_devices (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  device_fingerprint TEXT NOT NULL,
  device_name TEXT,
  browser TEXT,
  os TEXT,
  ip_address INET,
  last_seen TIMESTAMPTZ DEFAULT NOW(),
  trusted BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Authentication audit log
CREATE TABLE auth_audit_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  event_type TEXT NOT NULL, -- login, logout, password_change, mfa_enable
  success BOOLEAN NOT NULL,
  ip_address INET,
  user_agent TEXT,
  device_fingerprint TEXT,
  error_message TEXT,
  metadata JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- MFA setup and backup codes
CREATE TABLE user_mfa (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  totp_secret TEXT,
  backup_codes TEXT[],
  enabled BOOLEAN DEFAULT false,
  last_used_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Rate limiting tracking
CREATE TABLE rate_limits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  identifier TEXT NOT NULL, -- IP or user_id
  action TEXT NOT NULL, -- login, password_reset
  attempts INTEGER DEFAULT 1,
  window_start TIMESTAMPTZ DEFAULT NOW(),
  locked_until TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(identifier, action)
);
```

#### API Endpoints Required
```typescript
// POST /api/auth/setup-mfa
interface MFASetupRequest {
  totpSecret: string;
  verificationCode: string;
}

interface MFASetupResponse {
  success: boolean;
  backupCodes: string[];
  qrCodeUrl: string;
}

// POST /api/auth/verify-mfa
interface MFAVerifyRequest {
  code: string;
  backupCode?: string;
}

// GET /api/auth/devices
interface UserDevice {
  id: string;
  deviceName: string;
  browser: string;
  lastSeen: string;
  trusted: boolean;
}
```

#### Frontend Components Required
```typescript
// Component: MFASetup
// Location: /src/components/auth/MFASetup.tsx

interface MFASetupProps {
  onComplete: (backupCodes: string[]) => void;
  onCancel: () => void;
}

// Key functionality:
- Generate and display QR code for TOTP setup
- Verify authenticator app connection
- Display and allow user to save backup codes
- Handle backup code verification
```

#### Integration Points
```typescript
// Service: AuthSecurityService
// Dependencies: Supabase Auth, Rate Limiter, Device Detection

class AuthSecurityService {
  async validateLoginAttempt(credentials: LoginCredentials) {
    // Check rate limits, validate credentials, log attempt
  }
  
  async setupMFA(userId: string) {
    // Generate TOTP secret, create backup codes
  }
  
  async trackDevice(userId: string, deviceInfo: DeviceInfo) {
    // Record device fingerprint and notify if new device
  }
}
```

### CODE EXAMPLES

#### Example 1: Rate Limiting Implementation
```typescript
// rate-limiter.ts
import { createClient } from '@/lib/supabase/server';

export class RateLimiter {
  private limits = {
    login_attempts: { max: 5, windowMinutes: 15, lockoutMinutes: 30 },
    password_reset: { max: 3, windowHours: 1, cooldownHours: 24 }
  };

  async checkRateLimit(
    identifier: string, 
    action: string
  ): Promise<{ allowed: boolean; retryAfter?: number }> {
    const supabase = createClient();
    const limit = this.limits[action];
    
    if (!limit) return { allowed: true };

    const { data: existing } = await supabase
      .from('rate_limits')
      .select('*')
      .eq('identifier', identifier)
      .eq('action', action)
      .single();

    if (!existing) {
      // First attempt - create record
      await this.createRateLimit(identifier, action);
      return { allowed: true };
    }

    // Check if still in lockout period
    if (existing.locked_until && new Date(existing.locked_until) > new Date()) {
      return { 
        allowed: false, 
        retryAfter: Math.ceil((new Date(existing.locked_until).getTime() - Date.now()) / 1000)
      };
    }

    // Check if window has reset
    const windowStart = new Date(existing.window_start);
    const windowDuration = limit.windowMinutes ? limit.windowMinutes * 60000 : limit.windowHours * 3600000;
    
    if (Date.now() - windowStart.getTime() > windowDuration) {
      // Reset window
      await this.resetRateLimit(identifier, action);
      return { allowed: true };
    }

    // Increment attempts
    const newAttempts = existing.attempts + 1;
    
    if (newAttempts > limit.max) {
      // Lock account
      const lockDuration = limit.lockoutMinutes ? limit.lockoutMinutes * 60000 : limit.cooldownHours * 3600000;
      await this.lockAccount(identifier, action, lockDuration);
      return { allowed: false, retryAfter: lockDuration / 1000 };
    }

    await this.incrementAttempts(identifier, action, newAttempts);
    return { allowed: true };
  }
}
```

#### Example 2: MFA Implementation
```typescript
// mfa.ts
import * as OTPAuth from 'otpauth';
import { randomBytes } from 'crypto';

export class MFAService {
  async setupTOTP(userId: string, userEmail: string) {
    // Generate secret
    const secret = randomBytes(20).toString('base32');
    
    // Create TOTP instance
    const totp = new OTPAuth.TOTP({
      issuer: 'WedSync',
      label: userEmail,
      algorithm: 'SHA256',
      digits: 6,
      period: 30,
      secret: secret
    });

    // Generate QR code URL
    const qrCodeUrl = totp.toString();
    
    // Generate backup codes
    const backupCodes = Array.from({ length: 10 }, () => 
      randomBytes(4).toString('hex').toUpperCase()
    );

    // Store in database
    await this.storeMFASetup(userId, secret, backupCodes);

    return {
      secret,
      qrCodeUrl,
      backupCodes
    };
  }

  async verifyTOTP(userId: string, code: string): Promise<boolean> {
    const { data: mfaData } = await supabase
      .from('user_mfa')
      .select('totp_secret')
      .eq('user_id', userId)
      .single();

    if (!mfaData?.totp_secret) return false;

    const totp = new OTPAuth.TOTP({
      secret: mfaData.totp_secret,
      digits: 6,
      period: 30
    });

    const delta = totp.validate({ token: code, window: 1 });
    return delta !== null;
  }
}
```

### MCP SERVER USAGE

#### Required MCP Servers
- [x] Context7: Load docs for Supabase Auth, TOTP libraries
- [x] Playwright: Test authentication flows and security features
- [x] Filesystem: Access auth-related files

#### Context7 Queries Needed
```typescript
await mcp__context7__get-library-docs("/supabase/supabase", "auth security", 3000);
await mcp__context7__get-library-docs("/otpauth/docs", "totp implementation", 2000);
```

### TEST REQUIREMENTS

#### Unit Tests Required
```typescript
describe('Authentication Security', () => {
  it('should enforce rate limiting on login attempts', async () => {
    const rateLimiter = new RateLimiter();
    
    // Test multiple failed attempts
    for (let i = 0; i < 6; i++) {
      const result = await rateLimiter.checkRateLimit('test@example.com', 'login_attempts');
      if (i < 5) {
        expect(result.allowed).toBe(true);
      } else {
        expect(result.allowed).toBe(false);
        expect(result.retryAfter).toBeGreaterThan(0);
      }
    }
  });
  
  it('should generate valid TOTP codes', () => {
    const mfa = new MFAService();
    const setup = mfa.setupTOTP('user-id', 'test@example.com');
    expect(setup.qrCodeUrl).toContain('otpauth://totp/');
    expect(setup.backupCodes).toHaveLength(10);
  });
});
```

#### E2E Tests Required
```typescript
// Using Playwright MCP
test('MFA Setup Flow', async () => {
  await mcp__playwright__browser_navigate({url: '/auth/setup-mfa'});
  
  // Test QR code display
  await mcp__playwright__browser_snapshot();
  
  // Test backup code generation
  await mcp__playwright__browser_click({element: 'Generate Codes button', ref: '#generate-codes'});
  
  // Test verification
  await mcp__playwright__browser_type({
    element: 'Verification code input',
    ref: '#verification-code',
    text: '123456'
  });
  
  await mcp__playwright__browser_click({element: 'Verify button', ref: '#verify-mfa'});
});
```

### ACCEPTANCE CRITERIA
- [x] Rate limiting prevents brute force attacks (5 attempts per 15 min)
- [x] MFA setup generates valid TOTP QR codes and backup codes
- [x] Device fingerprinting detects and alerts on new device logins
- [x] Password requirements enforce 12+ characters with complexity
- [x] Session tokens expire and rotate appropriately
- [x] Performance: Authentication response time <500ms
- [x] Security: All auth endpoints use HTTPS and security headers
- [x] Accessibility: MFA setup is screen reader compatible

### DEPENDENCIES
- Must complete after: WS-087 (Touch Optimization)
- Must complete before: WS-089 (Data Encryption)
- Shares code with: User management, Session handling

### ESTIMATED EFFORT
- Team A Frontend: 14 hours
- Team B Backend: 20 hours
- Team C Integration: 8 hours
- Total: 42 hours