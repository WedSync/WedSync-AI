import { Metadata } from 'next';
import { redirect } from 'next/navigation';
import { createClient } from '@supabase/supabase-js';
import { cookies } from 'next/headers';
import { Suspense } from 'react';
import { ExecutiveDashboard } from '@/components/admin/ExecutiveDashboard';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { RefreshCw, AlertTriangle } from 'lucide-react';

export const metadata: Metadata = {
  title: 'Executive Metrics | WedSync Admin',
  description: 'Executive-level analytics and business intelligence dashboard for WedSync platform performance.',
  robots: 'noindex, nofollow', // Admin pages should not be indexed
};

/**
 * Executive Dashboard Admin Page
 * 
 * Provides C-level executives with comprehensive business intelligence including:
 * - Revenue metrics and growth trends
 * - User acquisition and retention analytics
 * - Platform health and performance indicators
 * - Strategic business insights and forecasts
 * 
 * Access Level: Super Admin Only
 * Mobile: Optimized for tablet/desktop viewing
 */
export default async function ExecutiveDashboardPage() {
  // Server-side authentication check
  const cookieStore = await cookies();
  const supabase = createServerComponentClient({ cookies: () => cookieStore });
  
  const {
    data: { session },
    error: sessionError
  } = await supabase.auth.getSession();

  if (sessionError || !session) {
    redirect('/login?returnTo=/admin/executive');
  }

  // Check if user has admin privileges
  const { data: profile, error: profileError } = await supabase
    .from('user_profiles')
    .select('role, first_name, last_name, organization_id')
    .eq('user_id', session.user.id)
    .single();

  if (profileError || !profile) {
    redirect('/dashboard?error=profile_not_found');
  }

  // Additional check for super admin access (executive metrics are sensitive)
  const { data: orgData, error: orgError } = await supabase
    .from('organizations')
    .select('subscription_tier')
    .eq('id', profile.organization_id)
    .single();

  const isSuperAdmin = profile.role === 'super_admin';

  if (!isSuperAdmin) {
    redirect('/dashboard?error=insufficient_executive_access');
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="mb-8">
          <nav className="flex" aria-label="Breadcrumb">
            <ol className="inline-flex items-center space-x-1 md:space-x-3">
              <li className="inline-flex items-center">
                <a href="/admin" className="text-sm font-medium text-gray-700 hover:text-blue-600">
                  Admin
                </a>
              </li>
              <li>
                <div className="flex items-center">
                  <svg className="w-4 h-4 text-gray-400 mx-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clipRule="evenodd"></path>
                  </svg>
                  <span className="text-sm font-medium text-gray-500">Executive Metrics</span>
                </div>
              </li>
            </ol>
          </nav>
          
          <div className="mt-4">
            <h1 className="text-3xl font-bold text-gray-900">
              Executive Metrics
            </h1>
            <p className="mt-2 text-lg text-gray-600">
              Comprehensive business intelligence and strategic insights for WedSync platform performance.
            </p>
          </div>
        </div>

        <div className="space-y-6">
          <Suspense fallback={
            <div className="flex items-center justify-center min-h-96">
              <div className="text-center">
                <RefreshCw className="h-12 w-12 animate-spin text-blue-500 mx-auto mb-4" />
                <p className="text-gray-600">
                  Loading executive metrics...
                </p>
              </div>
            </div>
          }>
            <ExecutiveDashboard />
          </Suspense>
        </div>
      </div>
    </div>
  );
}

// Error boundary fallback
function ExecutiveDashboardError() {
  return (
    <div className="bg-red-50 border border-red-200 rounded-lg p-6">
      <h3 className="text-lg font-semibold text-red-800 flex items-center gap-2">
        <AlertTriangle className="h-5 w-5" />
        Executive Dashboard Error
      </h3>
      <p className="mt-2 text-red-700">
        Unable to load executive metrics. Please contact system administrator.
      </p>
    </div>
  );
}