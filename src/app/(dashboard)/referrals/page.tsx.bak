'use client';

import { useState, useEffect } from 'react';
import { Card } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { ReferralProgramBuilder } from '@/components/growth/ReferralProgramBuilder';
import { 
  PlusIcon, 
  ChartBarIcon,
  QrCodeIcon,
  ShareIcon,
  ExclamationTriangleIcon,
  UserGroupIcon,
  CurrencyDollarIcon,
  TrophyIcon,
  ArrowTrendingUpIcon,
  EyeIcon
} from '@heroicons/react/24/outline';
import { Line, Bar } from 'recharts';
import { LineChart, BarChart, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';
import { toast } from '@/lib/toast-helper';

interface ReferralProgram {
  id: string;
  name: string;
  reward_type: string;
  referrer_reward_amount: number;
  referee_reward_amount: number;
  is_active: boolean;
  created_at: string;
}

interface AnalyticsData {
  totalInvitations: number;
  clickThroughRate: number;
  conversionRate: number;
  roi: number;
  topReferrers: Array<{
    coupleName: string;
    conversions: number;
    earnings: number;
  }>;
}

export default function ReferralsPage() {
  const [programs, setPrograms] = useState<ReferralProgram[]>([]);
  const [selectedProgram, setSelectedProgram] = useState<ReferralProgram | null>(null);
  const [analytics, setAnalytics] = useState<AnalyticsData | null>(null);
  const [chartData, setChartData] = useState<any[]>([]);
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  const [fraudAlerts, setFraudAlerts] = useState<any[]>([]);

  useEffect(() => {
    fetchPrograms();
  }, []);

  useEffect(() => {
    if (selectedProgram) {
      fetchAnalytics(selectedProgram.id);
    }
  }, [selectedProgram]);

  const fetchPrograms = async () => {
    try {
      setIsLoading(true);
      const response = await fetch('/api/referrals');
      if (!response.ok) throw new Error('Failed to fetch programs');
      
      const data = await response.json();
      setPrograms(data.programs || []);
      
      // Select first program by default
      if (data.programs && data.programs.length > 0) {
        setSelectedProgram(data.programs[0]);
      }
    } catch (error) {
      console.error('Error fetching programs:', error);
      toast.error('Failed to load referral programs');
    } finally {
      setIsLoading(false);
    }
  };

  const fetchAnalytics = async (programId: string) => {
    try {
      const response = await fetch(`/api/referrals/analytics/${programId}`);
      if (!response.ok) throw new Error('Failed to fetch analytics');
      
      const data = await response.json();
      setAnalytics(data.metrics);
      setChartData(data.dailyData || []);
    } catch (error) {
      console.error('Error fetching analytics:', error);
      toast.error('Failed to load analytics data');
    }
  };

  const handleProgramCreated = (newProgram: ReferralProgram) => {
    setPrograms(prev => [newProgram, ...prev]);
    setSelectedProgram(newProgram);
    setShowCreateModal(false);
    toast.success('Referral program created successfully!');
  };

  const generateQRCode = async (programId: string) => {
    try {
      // This would typically call an API to get QR codes for the program
      toast.success('QR codes generated! Check your email for download links.');
    } catch (error) {
      toast.error('Failed to generate QR codes');
    }
  };

  const downloadQRCode = (programId: string) => {
    // Simulate QR code download
    const link = document.createElement('a');
    link.download = `referral-qr-${programId}.png`;
    link.href = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';
    link.click();
    toast.success('QR code downloaded!');
  };

  if (isLoading) {
    return (
      <div className="p-6">
        <div className="animate-pulse">
          <div className="h-8 bg-gray-200 rounded w-1/4 mb-6"></div>
          <div className="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
            {[...Array(4)].map((_, i) => (
              <div key={i} className="bg-white p-6 rounded-lg shadow">
                <div className="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                <div className="h-8 bg-gray-200 rounded w-1/2"></div>
              </div>
            ))}
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Referral Programs</h1>
          <p className="text-gray-600 mt-1">
            Turn your happy couples into your best marketing team
          </p>
        </div>
        <Button onClick={() => setShowCreateModal(true)} variant="primary">
          <PlusIcon className="h-5 w-5 mr-2" />
          Create Program
        </Button>
      </div>

      {programs.length === 0 ? (
        // Empty State
        <Card className="p-12 text-center">
          <UserGroupIcon className="h-16 w-16 text-gray-400 mx-auto mb-4" />
          <h2 className="text-xl font-semibold text-gray-900 mb-2">No Referral Programs Yet</h2>
          <p className="text-gray-600 mb-6 max-w-md mx-auto">
            Create your first referral program to start turning satisfied couples into powerful advocates for your business.
          </p>
          <Button onClick={() => setShowCreateModal(true)} variant="primary">
            <PlusIcon className="h-5 w-5 mr-2" />
            Create Your First Program
          </Button>
        </Card>
      ) : (
        <>
          {/* Program Selector */}
          <div className="flex flex-wrap gap-3">
            {programs.map((program) => (
              <Button
                key={program.id}
                variant={selectedProgram?.id === program.id ? 'primary' : 'outline'}
                onClick={() => setSelectedProgram(program)}
                className="flex items-center gap-2"
              >
                {program.name}
                <Badge 
                  variant={program.is_active ? 'success' : 'secondary'}
                  className="ml-2"
                >
                  {program.is_active ? 'Active' : 'Inactive'}
                </Badge>
              </Button>
            ))}
          </div>

          {selectedProgram && (
            <>
              {/* Analytics Cards */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <Card className="p-6">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm font-medium text-gray-600">Total Invitations</p>
                      <p className="text-3xl font-bold text-gray-900">
                        {analytics?.totalInvitations || 0}
                      </p>
                    </div>
                    <UserGroupIcon className="h-8 w-8 text-blue-500" />
                  </div>
                  <p className="text-sm text-green-600 mt-2">
                    ↗️ Invitations sent to happy couples
                  </p>
                </Card>

                <Card className="p-6">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm font-medium text-gray-600">Click-Through Rate</p>
                      <p className="text-3xl font-bold text-gray-900">
                        {analytics?.clickThroughRate?.toFixed(1) || 0}%
                      </p>
                    </div>
                    <ArrowTrendingUpIcon className="h-8 w-8 text-green-500" />
                  </div>
                  <p className="text-sm text-gray-500 mt-2">
                    Of invitations result in clicks
                  </p>
                </Card>

                <Card className="p-6">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm font-medium text-gray-600">Conversion Rate</p>
                      <p className="text-3xl font-bold text-gray-900">
                        {analytics?.conversionRate?.toFixed(1) || 0}%
                      </p>
                    </div>
                    <TrophyIcon className="h-8 w-8 text-purple-500" />
                  </div>
                  <p className="text-sm text-gray-500 mt-2">
                    Of clicks become bookings
                  </p>
                </Card>

                <Card className="p-6">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm font-medium text-gray-600">ROI</p>
                      <p className="text-3xl font-bold text-gray-900">
                        {analytics?.roi?.toFixed(0) || 0}%
                      </p>
                    </div>
                    <CurrencyDollarIcon className="h-8 w-8 text-yellow-500" />
                  </div>
                  <p className="text-sm text-green-600 mt-2">
                    Return on referral investment
                  </p>
                </Card>
              </div>

              {/* Charts Section */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <Card className="p-6">
                  <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                    <ChartBarIcon className="h-5 w-5" />
                    Referral Performance
                  </h3>
                  <div className="h-64">
                    <ResponsiveContainer width="100%" height="100%">
                      <LineChart data={chartData}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis dataKey="date" />
                        <YAxis />
                        <Tooltip />
                        <Line type="monotone" dataKey="clicks" stroke="#3B82F6" strokeWidth={2} />
                        <Line type="monotone" dataKey="conversions" stroke="#10B981" strokeWidth={2} />
                      </LineChart>
                    </ResponsiveContainer>
                  </div>
                </Card>

                <Card className="p-6">
                  <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                    <TrophyIcon className="h-5 w-5" />
                    Top Referrers
                  </h3>
                  <div className="space-y-4">
                    {analytics?.topReferrers?.map((referrer, index) => (
                      <div key={index} className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div className="flex items-center gap-3">
                          <div className="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                            <span className="text-sm font-semibold text-purple-600">
                              #{index + 1}
                            </span>
                          </div>
                          <div>
                            <p className="font-medium text-gray-900">{referrer.coupleName}</p>
                            <p className="text-sm text-gray-500">{referrer.conversions} referrals</p>
                          </div>
                        </div>
                        <div className="text-right">
                          <p className="font-semibold text-green-600">${referrer.earnings}</p>
                          <p className="text-xs text-gray-500">earned</p>
                        </div>
                      </div>
                    )) || (
                      <div className="text-center text-gray-500 py-8">
                        <UserGroupIcon className="h-12 w-12 text-gray-300 mx-auto mb-3" />
                        <p>No referrals yet</p>
                        <p className="text-sm">Start inviting your happy couples!</p>
                      </div>
                    )}
                  </div>
                </Card>
              </div>

              {/* QR Code and Marketing Tools */}
              <Card className="p-6">
                <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                  <QrCodeIcon className="h-5 w-5" />
                  Marketing Tools
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <div className="text-center p-6 bg-gray-50 rounded-lg">
                    <QrCodeIcon className="h-12 w-12 text-purple-600 mx-auto mb-3" />
                    <h4 className="font-medium mb-2">QR Codes</h4>
                    <p className="text-sm text-gray-600 mb-4">
                      Generate QR codes for physical marketing materials
                    </p>
                    <Button 
                      variant="outline" 
                      size="sm"
                      onClick={() => generateQRCode(selectedProgram.id)}
                    >
                      Generate QR Codes
                    </Button>
                  </div>

                  <div className="text-center p-6 bg-gray-50 rounded-lg">
                    <ShareIcon className="h-12 w-12 text-blue-600 mx-auto mb-3" />
                    <h4 className="font-medium mb-2">Social Sharing</h4>
                    <p className="text-sm text-gray-600 mb-4">
                      Pre-made social media templates for couples
                    </p>
                    <Button variant="outline" size="sm">
                      Download Templates
                    </Button>
                  </div>

                  <div className="text-center p-6 bg-gray-50 rounded-lg">
                    <EyeIcon className="h-12 w-12 text-green-600 mx-auto mb-3" />
                    <h4 className="font-medium mb-2">Landing Pages</h4>
                    <p className="text-sm text-gray-600 mb-4">
                      Customizable referral landing pages
                    </p>
                    <Button variant="outline" size="sm">
                      Preview Pages
                    </Button>
                  </div>
                </div>
              </Card>

              {/* Fraud Detection Alerts */}
              {fraudAlerts.length > 0 && (
                <Card className="p-6 border-yellow-200 bg-yellow-50">
                  <h3 className="text-lg font-semibold mb-4 flex items-center gap-2 text-yellow-800">
                    <ExclamationTriangleIcon className="h-5 w-5" />
                    Fraud Detection Alerts
                  </h3>
                  <div className="space-y-3">
                    {fraudAlerts.map((alert, index) => (
                      <div key={index} className="flex items-center justify-between p-3 bg-white rounded-lg">
                        <div>
                          <p className="font-medium text-gray-900">{alert.type}</p>
                          <p className="text-sm text-gray-600">{alert.description}</p>
                        </div>
                        <Badge variant="warning">Needs Review</Badge>
                      </div>
                    ))}
                  </div>
                </Card>
              )}
            </>
          )}
        </>
      )}

      {/* Create Program Modal */}
      <Dialog open={showCreateModal} onOpenChange={setShowCreateModal}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>Create New Referral Program</DialogTitle>
          </DialogHeader>
          <ReferralProgramBuilder
            supplierId="current-supplier" // This would come from auth context
            onProgramCreated={handleProgramCreated}
          />
        </DialogContent>
      </Dialog>
    </div>
  );
}