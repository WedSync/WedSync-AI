/**
 * WS-198 Error Boundary Test Suite
 * Comprehensive tests for error boundary system with wedding context
 */

import React from 'react'
import { render, screen, fireEvent, waitFor, act } from '@testing-library/react'
import { vi, describe, it, expect, beforeEach, afterEach } from 'vitest'
import { ErrorBoundary, SupplierDashboardErrorBoundary, CoupleFormsErrorBoundary, AdminPanelErrorBoundary } from '../ErrorBoundary'

// Mock Supabase client
vi.mock('@supabase/auth-helpers-nextjs', () => ({
  createClientComponentClient: () => ({
    from: () => ({
      insert: vi.fn().mockResolvedValue({ data: null, error: null })
    })
  })
}))

// Mock child component that throws errors
const ThrowError = ({ shouldThrow, errorMessage }: { shouldThrow: boolean; errorMessage?: string }) => {
  if (shouldThrow) {
    throw new Error(errorMessage || 'Test error')
  }
  return <div>No error</div>
}

// Mock console.error to prevent test noise
const originalConsoleError = console.error
beforeEach(() => {
  console.error = vi.fn()
})

afterEach(() => {
  console.error = originalConsoleError
  vi.clearAllMocks()
})

describe('ErrorBoundary', () => {
  describe('Normal Operation', () => {
    it('renders children when no error occurs', () => {
      render(
        <ErrorBoundary>
          <div data-testid="child">Normal content</div>
        </ErrorBoundary>
      )
      
      expect(screen.getByTestId('child')).toBeInTheDocument()
    })

    it('passes props correctly to children', () => {
      const TestChild = ({ testProp }: { testProp: string }) => (
        <div data-testid="child">{testProp}</div>
      )
      
      render(
        <ErrorBoundary>
          <TestChild testProp="test value" />
        </ErrorBoundary>
      )
      
      expect(screen.getByText('test value')).toBeInTheDocument()
    })
  })

  describe('Error Handling', () => {
    it('catches and displays errors from child components', () => {
      render(
        <ErrorBoundary>
          <ThrowError shouldThrow={true} errorMessage="Test error message" />
        </ErrorBoundary>
      )
      
      expect(screen.getByText('Loading error interface...')).toBeInTheDocument()
    })

    it('generates unique error IDs for each error', () => {
      const onError = vi.fn()
      
      render(
        <ErrorBoundary onError={onError}>
          <ThrowError shouldThrow={true} />
        </ErrorBoundary>
      )
      
      expect(onError).toHaveBeenCalledWith(
        expect.any(Error),
        expect.objectContaining({
          componentStack: expect.any(String)
        })
      )
    })

    it('calls custom error handler when provided', () => {
      const customErrorHandler = vi.fn()
      
      render(
        <ErrorBoundary onError={customErrorHandler}>
          <ThrowError shouldThrow={true} errorMessage="Custom error" />
        </ErrorBoundary>
      )
      
      expect(customErrorHandler).toHaveBeenCalledWith(
        expect.objectContaining({ message: 'Custom error' }),
        expect.any(Object)
      )
    })

    it('logs error to database', async () => {
      const consoleSpy = vi.spyOn(console, 'error')
      
      render(
        <ErrorBoundary context="supplier_dashboard">
          <ThrowError shouldThrow={true} errorMessage="Database logging test" />
        </ErrorBoundary>
      )
      
      await waitFor(() => {
        expect(consoleSpy).toHaveBeenCalledWith(
          'Error Boundary Caught Error:',
          expect.objectContaining({
            error: expect.objectContaining({
              message: 'Database logging test'
            })
          })
        )
      })
    })
  })

  describe('Wedding Context Detection', () => {
    it('detects wedding day (Saturday) correctly', () => {
      // Mock Date to return Saturday
      const mockDate = new Date('2024-06-08') // Saturday
      vi.setSystemTime(mockDate)
      
      render(
        <ErrorBoundary>
          <ThrowError shouldThrow={true} errorMessage="Saturday error" />
        </ErrorBoundary>
      )
      
      expect(screen.getByText('Loading error interface...')).toBeInTheDocument()
    })

    it('detects peak wedding season (May-October)', () => {
      // Mock Date to return peak season
      const mockDate = new Date('2024-07-15') // July - peak season
      vi.setSystemTime(mockDate)
      
      render(
        <ErrorBoundary context="supplier_dashboard">
          <ThrowError shouldThrow={true} errorMessage="Peak season error" />
        </ErrorBoundary>
      )
      
      expect(screen.getByText('Loading error interface...')).toBeInTheDocument()
    })

    it('determines correct business impact based on context', () => {
      const consoleSpy = vi.spyOn(console, 'error')
      
      render(
        <ErrorBoundary context="admin_panel">
          <ThrowError shouldThrow={true} errorMessage="Admin error" />
        </ErrorBoundary>
      )
      
      expect(consoleSpy).toHaveBeenCalledWith(
        'Error Boundary Caught Error:',
        expect.objectContaining({
          context: expect.objectContaining({
            weddingContext: expect.objectContaining({
              businessImpact: 'high'
            })
          })
        })
      )
    })
  })

  describe('Retry Mechanism', () => {
    beforeEach(() => {
      vi.useFakeTimers()
    })

    afterEach(() => {
      vi.useRealTimers()
    })

    it('enables retry by default', () => {
      render(
        <ErrorBoundary>
          <ThrowError shouldThrow={true} />
        </ErrorBoundary>
      )
      
      // Should show fallback interface with retry capability
      expect(screen.getByText('Loading error interface...')).toBeInTheDocument()
    })

    it('respects enableRetry=false', () => {
      render(
        <ErrorBoundary enableRetry={false}>
          <ThrowError shouldThrow={true} />
        </ErrorBoundary>
      )
      
      // Should still show fallback but without retry
      expect(screen.getByText('Loading error interface...')).toBeInTheDocument()
    })

    it('limits retry attempts based on maxRetries', () => {
      const { rerender } = render(
        <ErrorBoundary maxRetries={2}>
          <ThrowError shouldThrow={true} />
        </ErrorBoundary>
      )
      
      // Should respect maxRetries setting
      expect(screen.getByText('Loading error interface...')).toBeInTheDocument()
    })

    it('implements exponential backoff for retries', () => {
      const TestComponent = () => {
        const [shouldThrow, setShouldThrow] = React.useState(true)
        
        React.useEffect(() => {
          const timer = setTimeout(() => setShouldThrow(false), 100)
          return () => clearTimeout(timer)
        }, [])
        
        return <ThrowError shouldThrow={shouldThrow} />
      }
      
      render(
        <ErrorBoundary>
          <TestComponent />
        </ErrorBoundary>
      )
      
      act(() => {
        vi.advanceTimersByTime(2000)
      })
      
      // Should implement exponential backoff timing
    })
  })

  describe('Wedding Day Emergency Protocol', () => {
    beforeEach(() => {
      // Mock Saturday (wedding day)
      const mockDate = new Date('2024-06-08') // Saturday
      vi.setSystemTime(mockDate)
    })

    it('triggers wedding day protocol on Saturday', () => {
      const fetchSpy = vi.fn().mockResolvedValue({ ok: true })
      global.fetch = fetchSpy
      
      render(
        <ErrorBoundary>
          <ThrowError shouldThrow={true} errorMessage="Wedding day emergency" />
        </ErrorBoundary>
      )
      
      expect(fetchSpy).toHaveBeenCalledWith(
        '/api/emergency/wedding-day-error',
        expect.objectContaining({
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: expect.stringContaining('wedding_day_emergency')
        })
      )
    })

    it('logs wedding day emergency to console', () => {
      const consoleSpy = vi.spyOn(console, 'error')
      
      render(
        <ErrorBoundary>
          <ThrowError shouldThrow={true} errorMessage="Saturday error" />
        </ErrorBoundary>
      )
      
      expect(consoleSpy).toHaveBeenCalledWith(
        'ðŸš¨ WEDDING DAY EMERGENCY - ERROR DETECTED ðŸš¨',
        expect.any(Object)
      )
    })
  })

  describe('Context-Specific Behavior', () => {
    it('handles supplier dashboard context', () => {
      render(
        <ErrorBoundary context="supplier_dashboard">
          <ThrowError shouldThrow={true} />
        </ErrorBoundary>
      )
      
      expect(screen.getByText('Loading error interface...')).toBeInTheDocument()
    })

    it('handles couple forms context', () => {
      render(
        <ErrorBoundary context="couple_forms">
          <ThrowError shouldThrow={true} />
        </ErrorBoundary>
      )
      
      expect(screen.getByText('Loading error interface...')).toBeInTheDocument()
    })

    it('handles admin panel context with critical level', () => {
      render(
        <ErrorBoundary context="admin_panel" level="critical">
          <ThrowError shouldThrow={true} />
        </ErrorBoundary>
      )
      
      expect(screen.getByText('Loading error interface...')).toBeInTheDocument()
    })
  })

  describe('Custom Fallback Components', () => {
    it('renders custom fallback when provided', () => {
      const CustomFallback = ({ componentStack }: { componentStack: string }) => (
        <div data-testid="custom-fallback">Custom error UI</div>
      )
      
      render(
        <ErrorBoundary fallback={CustomFallback}>
          <ThrowError shouldThrow={true} />
        </ErrorBoundary>
      )
      
      expect(screen.getByTestId('custom-fallback')).toBeInTheDocument()
      expect(screen.getByText('Custom error UI')).toBeInTheDocument()
    })

    it('prefers custom fallback over default interface', () => {
      const CustomFallback = () => <div data-testid="custom">Custom</div>
      
      render(
        <ErrorBoundary fallback={CustomFallback}>
          <ThrowError shouldThrow={true} />
        </ErrorBoundary>
      )
      
      expect(screen.getByTestId('custom')).toBeInTheDocument()
      expect(screen.queryByText('Loading error interface...')).not.toBeInTheDocument()
    })
  })

  describe('Cleanup and Memory Management', () => {
    it('cleans up timers on unmount', () => {
      const clearTimeoutSpy = vi.spyOn(global, 'clearTimeout')
      
      const { unmount } = render(
        <ErrorBoundary>
          <ThrowError shouldThrow={true} />
        </ErrorBoundary>
      )
      
      unmount()
      
      // Should clean up any pending timers
      expect(clearTimeoutSpy).toHaveBeenCalled()
    })
  })
})

describe('Specialized Error Boundaries', () => {
  describe('SupplierDashboardErrorBoundary', () => {
    it('uses supplier dashboard context by default', () => {
      const consoleSpy = vi.spyOn(console, 'error')
      
      render(
        <SupplierDashboardErrorBoundary>
          <ThrowError shouldThrow={true} />
        </SupplierDashboardErrorBoundary>
      )
      
      expect(consoleSpy).toHaveBeenCalledWith(
        'Error Boundary Caught Error:',
        expect.objectContaining({
          context: expect.objectContaining({
            page: 'supplier_dashboard'
          })
        })
      )
    })

    it('configures appropriate settings for supplier dashboard', () => {
      render(
        <SupplierDashboardErrorBoundary>
          <div data-testid="child">Content</div>
        </SupplierDashboardErrorBoundary>
      )
      
      expect(screen.getByTestId('child')).toBeInTheDocument()
    })
  })

  describe('CoupleFormsErrorBoundary', () => {
    it('uses couple forms context by default', () => {
      const consoleSpy = vi.spyOn(console, 'error')
      
      render(
        <CoupleFormsErrorBoundary>
          <ThrowError shouldThrow={true} />
        </CoupleFormsErrorBoundary>
      )
      
      expect(consoleSpy).toHaveBeenCalledWith(
        'Error Boundary Caught Error:',
        expect.objectContaining({
          context: expect.objectContaining({
            page: 'couple_forms'
          })
        })
      )
    })
  })

  describe('AdminPanelErrorBoundary', () => {
    it('uses admin panel context with critical level', () => {
      const consoleSpy = vi.spyOn(console, 'error')
      
      render(
        <AdminPanelErrorBoundary>
          <ThrowError shouldThrow={true} />
        </AdminPanelErrorBoundary>
      )
      
      expect(consoleSpy).toHaveBeenCalledWith(
        'Error Boundary Caught Error:',
        expect.objectContaining({
          context: expect.objectContaining({
            page: 'admin_panel',
            level: 'critical'
          })
        })
      )
    })

    it('disables retry for admin panel by default', () => {
      render(
        <AdminPanelErrorBoundary>
          <ThrowError shouldThrow={true} />
        </AdminPanelErrorBoundary>
      )
      
      // Admin panel errors should not auto-retry
      expect(screen.getByText('Loading error interface...')).toBeInTheDocument()
    })
  })
})

describe('withErrorBoundary HOC', () => {
  it('wraps components with error boundary', () => {
    const TestComponent = ({ message }: { message: string }) => (
      <div data-testid="wrapped">{message}</div>
    )
    
    const WrappedComponent = ErrorBoundary.prototype.constructor.withErrorBoundary
      ? ErrorBoundary.prototype.constructor.withErrorBoundary(TestComponent)
      : TestComponent
    
    // Test would depend on actual HOC implementation
    expect(TestComponent).toBeDefined()
  })
})

describe('Edge Cases and Error Conditions', () => {
  it('handles errors in error handler gracefully', () => {
    const faultyErrorHandler = () => {
      throw new Error('Error handler error')
    }
    
    render(
      <ErrorBoundary onError={faultyErrorHandler}>
        <ThrowError shouldThrow={true} errorMessage="Original error" />
      </ErrorBoundary>
    )
    
    // Should still show fallback interface
    expect(screen.getByText('Loading error interface...')).toBeInTheDocument()
  })

  it('handles network failures in error logging', () => {
    const fetchSpy = vi.fn().mockRejectedValue(new Error('Network error'))
    global.fetch = fetchSpy
    
    render(
      <ErrorBoundary>
        <ThrowError shouldThrow={true} errorMessage="Network logging test" />
      </ErrorBoundary>
    )
    
    // Should not crash when logging fails
    expect(screen.getByText('Loading error interface...')).toBeInTheDocument()
  })

  it('handles missing wedding context gracefully', () => {
    render(
      <ErrorBoundary context={undefined as any}>
        <ThrowError shouldThrow={true} />
      </ErrorBoundary>
    )
    
    expect(screen.getByText('Loading error interface...')).toBeInTheDocument()
  })

  it('handles extremely rapid successive errors', () => {
    const MultipleErrors = () => {
      React.useEffect(() => {
        throw new Error('First error')
      }, [])
      
      throw new Error('Second error')
    }
    
    render(
      <ErrorBoundary>
        <MultipleErrors />
      </ErrorBoundary>
    )
    
    expect(screen.getByText('Loading error interface...')).toBeInTheDocument()
  })
})

describe('Performance and Optimization', () => {
  it('does not re-render unnecessarily when no errors', () => {
    const renderSpy = vi.fn()
    
    const TestChild = () => {
      renderSpy()
      return <div>Child</div>
    }
    
    const { rerender } = render(
      <ErrorBoundary>
        <TestChild />
      </ErrorBoundary>
    )
    
    rerender(
      <ErrorBoundary>
        <TestChild />
      </ErrorBoundary>
    )
    
    // Should not cause unnecessary re-renders
    expect(renderSpy).toHaveBeenCalledTimes(2)
  })

  it('handles memory cleanup properly', () => {
    const { unmount } = render(
      <ErrorBoundary>
        <ThrowError shouldThrow={true} />
      </ErrorBoundary>
    )
    
    unmount()
    
    // Should not leave memory leaks
    expect(true).toBe(true) // Placeholder for memory leak detection
  })
})

describe('Accessibility (WCAG 2.1 AA)', () => {
  it('provides accessible error interface', () => {
    render(
      <ErrorBoundary>
        <ThrowError shouldThrow={true} />
      </ErrorBoundary>
    )
    
    // Should load accessible fallback interface
    expect(screen.getByText('Loading error interface...')).toBeInTheDocument()
  })

  it('supports screen reader navigation', () => {
    render(
      <ErrorBoundary>
        <ThrowError shouldThrow={true} errorMessage="Screen reader test" />
      </ErrorBoundary>
    )
    
    // Screen reader support would be tested in the ErrorFallbackInterface component
    expect(screen.getByText('Loading error interface...')).toBeInTheDocument()
  })
})

describe('Integration with Wedding Platform', () => {
  it('integrates with supplier workflow correctly', () => {
    render(
      <ErrorBoundary context="supplier_dashboard">
        <ThrowError shouldThrow={true} />
      </ErrorBoundary>
    )
    
    expect(screen.getByText('Loading error interface...')).toBeInTheDocument()
  })

  it('preserves wedding data integrity during errors', () => {
    const consoleSpy = vi.spyOn(console, 'error')
    
    render(
      <ErrorBoundary context="couple_forms">
        <ThrowError shouldThrow={true} errorMessage="Data integrity test" />
      </ErrorBoundary>
    )
    
    expect(consoleSpy).toHaveBeenCalledWith(
      'Error Boundary Caught Error:',
      expect.objectContaining({
        errorId: expect.any(String)
      })
    )
  })

  it('handles supplier-specific error contexts', () => {
    ['photographer', 'venue', 'florist', 'catering'].forEach(supplierType => {
      const { unmount } = render(
        <ErrorBoundary context="supplier_dashboard">
          <ThrowError shouldThrow={true} errorMessage={`${supplierType} error`} />
        </ErrorBoundary>
      )
      
      expect(screen.getByText('Loading error interface...')).toBeInTheDocument()
      unmount()
    })
  })
})