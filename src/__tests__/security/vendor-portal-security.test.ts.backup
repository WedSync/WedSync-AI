import { GET as getPerformance } from '@/app/api/vendor-portal/performance/route'
import { GET as getWeddings } from '@/app/api/vendor-portal/weddings/route'
import { GET as getCommunications } from '@/app/api/vendor-portal/communications/route'
import { createClient } from '@/lib/supabase/server'
import { NextRequest } from 'next/server'

// Mock dependencies
jest.mock('@/lib/supabase/server')
const mockCreateClient = createClient as jest.MockedFunction<typeof createClient>

// Mock Supabase client
const mockSupabaseClient = {
  auth: {
    getUser: jest.fn(),
  },
  from: jest.fn(() => ({
    select: jest.fn(() => ({
      eq: jest.fn(() => ({
        single: jest.fn(),
        order: jest.fn(() => ({
          limit: jest.fn(),
        })),
      })),
    })),
  })),
}

describe('Vendor Portal Security Tests', () => {
  beforeEach(() => {
    jest.clearAllMocks()
    mockCreateClient.mockReturnValue(mockSupabaseClient as any)
  })

  describe('Authentication Security', () => {
    it('blocks unauthenticated access to performance API', async () => {
      mockSupabaseClient.auth.getUser.mockResolvedValue({
        data: { user: null },
        error: new Error('Not authenticated'),
      })

      const request = new NextRequest('http://localhost:3000/api/vendor-portal/performance?vendor_id=vendor1')
      const response = await getPerformance(request)

      expect(response.status).toBe(401)
      const data = await response.json()
      expect(data.error).toBe('Unauthorized')
    })

    it('blocks unauthenticated access to weddings API', async () => {
      mockSupabaseClient.auth.getUser.mockResolvedValue({
        data: { user: null },
        error: new Error('Not authenticated'),
      })

      const request = new NextRequest('http://localhost:3000/api/vendor-portal/weddings?vendor_id=vendor1')
      const response = await getWeddings(request)

      expect(response.status).toBe(401)
      const data = await response.json()
      expect(data.error).toBe('Unauthorized')
    })

    it('blocks unauthenticated access to communications API', async () => {
      mockSupabaseClient.auth.getUser.mockResolvedValue({
        data: { user: null },
        error: new Error('Not authenticated'),
      })

      const request = new NextRequest('http://localhost:3000/api/vendor-portal/communications?vendor_id=vendor1')
      const response = await getCommunications(request)

      expect(response.status).toBe(401)
      const data = await response.json()
      expect(data.error).toBe('Unauthorized')
    })
  })

  describe('Authorization Security', () => {
    it('blocks access to vendors from different organizations in performance API', async () => {
      // Mock authenticated user
      mockSupabaseClient.auth.getUser.mockResolvedValue({
        data: { user: { id: 'user1' } },
        error: null,
      })

      // Mock vendor from different organization
      mockSupabaseClient.from().select().eq().single
        .mockResolvedValueOnce({
          data: { id: 'vendor1', organization_id: 'other-org' },
          error: null,
        })
        .mockResolvedValueOnce({
          data: { organization_id: 'my-org' },
          error: null,
        })

      const request = new NextRequest('http://localhost:3000/api/vendor-portal/performance?vendor_id=vendor1')
      const response = await getPerformance(request)

      expect(response.status).toBe(404)
      const data = await response.json()
      expect(data.error).toBe('Vendor not found')
    })

    it('blocks access to weddings from different organizations', async () => {
      mockSupabaseClient.auth.getUser.mockResolvedValue({
        data: { user: { id: 'user1' } },
        error: null,
      })

      // Mock vendor from different organization
      mockSupabaseClient.from().select().eq().single
        .mockResolvedValueOnce({
          data: { organization_id: 'other-org' },
          error: null,
        })
        .mockResolvedValueOnce({
          data: { organization_id: 'my-org' },
          error: null,
        })

      const request = new NextRequest('http://localhost:3000/api/vendor-portal/weddings?vendor_id=vendor1')
      const response = await getWeddings(request)

      expect(response.status).toBe(403)
      const data = await response.json()
      expect(data.error).toBe('Unauthorized')
    })

    it('allows access to vendors from same organization', async () => {
      mockSupabaseClient.auth.getUser.mockResolvedValue({
        data: { user: { id: 'user1' } },
        error: null,
      })

      // Mock vendor from same organization
      const mockVendor = {
        id: 'vendor1',
        organization_id: 'my-org',
        business_name: 'Test Photography',
        average_rating: 4.5,
        total_reviews: 25,
      }

      mockSupabaseClient.from().select().eq().single
        .mockResolvedValueOnce({ data: mockVendor, error: null })

      mockSupabaseClient.from().select().eq().single
        .mockResolvedValueOnce({
          data: { organization_id: 'my-org' },
          error: null,
        })

      mockSupabaseClient.from().select().eq().eq().gte()
        .mockResolvedValue({ data: [], error: null })

      const request = new NextRequest('http://localhost:3000/api/vendor-portal/performance?vendor_id=vendor1')
      const response = await getPerformance(request)

      expect(response.status).toBe(200)
    })
  })

  describe('Data Access Security', () => {
    it('only returns weddings assigned to the specific vendor', async () => {
      mockSupabaseClient.auth.getUser.mockResolvedValue({
        data: { user: { id: 'user1' } },
        error: null,
      })

      mockSupabaseClient.from().select().eq().single
        .mockResolvedValueOnce({
          data: { organization_id: 'my-org' },
          error: null,
        })
        .mockResolvedValueOnce({
          data: { organization_id: 'my-org' },
          error: null,
        })

      const mockWeddings = [
        {
          id: 'connection1',
          clients: {
            id: 'client1',
            first_name: 'John',
            last_name: 'Doe',
            wedding_date: '2024-06-15',
            venue_name: 'Test Venue',
          },
        },
      ]

      mockSupabaseClient.from().select().eq()
        .mockImplementationOnce(() => ({
          order: jest.fn(() => ({
            limit: jest.fn(() => Promise.resolve({
              data: mockWeddings,
              error: null,
            })),
          })),
        }))

      const request = new NextRequest('http://localhost:3000/api/vendor-portal/weddings?vendor_id=vendor1')
      const response = await getWeddings(request)

      expect(response.status).toBe(200)
      
      // Verify that the query filters by supplier_id
      expect(mockSupabaseClient.from).toHaveBeenCalledWith('supplier_client_connections')
    })

    it('filters performance data by vendor and date range', async () => {
      mockSupabaseClient.auth.getUser.mockResolvedValue({
        data: { user: { id: 'user1' } },
        error: null,
      })

      const mockVendor = {
        id: 'vendor1',
        organization_id: 'my-org',
        business_name: 'Test Photography',
        average_rating: 4.5,
        total_reviews: 25,
      }

      mockSupabaseClient.from().select().eq().single
        .mockResolvedValue({ data: mockVendor, error: null })

      mockSupabaseClient.from().select().eq().eq().gte()
        .mockResolvedValue({ data: [], error: null })

      const request = new NextRequest('http://localhost:3000/api/vendor-portal/performance?vendor_id=vendor1&period=1month')
      const response = await getPerformance(request)

      expect(response.status).toBe(200)
      
      // Verify performance data is filtered by vendor
      expect(mockSupabaseClient.from).toHaveBeenCalledWith('suppliers')
    })

    it('ensures communication data is organization-scoped', async () => {
      mockSupabaseClient.auth.getUser.mockResolvedValue({
        data: { user: { id: 'user1' } },
        error: null,
      })

      const mockVendor = {
        id: 'vendor1',
        organization_id: 'my-org',
        business_name: 'Test Photography',
      }

      mockSupabaseClient.from().select().eq().single
        .mockResolvedValue({ data: mockVendor, error: null })

      mockSupabaseClient.from().select().eq().single
        .mockResolvedValue({
          data: { organization_id: 'my-org' },
          error: null,
        })

      mockSupabaseClient.from().select().eq().order()
        .mockResolvedValue({ data: [], error: null })

      const request = new NextRequest('http://localhost:3000/api/vendor-portal/communications?vendor_id=vendor1')
      const response = await getCommunications(request)

      expect(response.status).toBe(200)
    })
  })

  describe('Input Validation Security', () => {
    it('rejects requests without vendor_id parameter', async () => {
      mockSupabaseClient.auth.getUser.mockResolvedValue({
        data: { user: { id: 'user1' } },
        error: null,
      })

      const request = new NextRequest('http://localhost:3000/api/vendor-portal/performance')
      const response = await getPerformance(request)

      expect(response.status).toBe(400)
      const data = await response.json()
      expect(data.error).toBe('Vendor ID required')
    })

    it('validates vendor_id format and existence', async () => {
      mockSupabaseClient.auth.getUser.mockResolvedValue({
        data: { user: { id: 'user1' } },
        error: null,
      })

      mockSupabaseClient.from().select().eq().single
        .mockResolvedValue({
          data: null,
          error: new Error('Not found'),
        })

      const request = new NextRequest('http://localhost:3000/api/vendor-portal/performance?vendor_id=invalid-vendor-id')
      const response = await getPerformance(request)

      expect(response.status).toBe(404)
      const data = await response.json()
      expect(data.error).toBe('Vendor not found')
    })

    it('sanitizes and validates period parameter', async () => {
      mockSupabaseClient.auth.getUser.mockResolvedValue({
        data: { user: { id: 'user1' } },
        error: null,
      })

      const mockVendor = {
        id: 'vendor1',
        organization_id: 'my-org',
        business_name: 'Test Photography',
        average_rating: 4.5,
        total_reviews: 25,
      }

      mockSupabaseClient.from().select().eq().single
        .mockResolvedValue({ data: mockVendor, error: null })

      mockSupabaseClient.from().select().eq().eq().gte()
        .mockResolvedValue({ data: [], error: null })

      // Test with valid period
      const validRequest = new NextRequest('http://localhost:3000/api/vendor-portal/performance?vendor_id=vendor1&period=1month')
      const validResponse = await getPerformance(validRequest)
      expect(validResponse.status).toBe(200)

      // Test with invalid period - should default to 6months
      const invalidRequest = new NextRequest('http://localhost:3000/api/vendor-portal/performance?vendor_id=vendor1&period=invalid_period')
      const invalidResponse = await getPerformance(invalidRequest)
      expect(invalidResponse.status).toBe(200) // Should still work with default period
    })
  })

  describe('Rate Limiting and DoS Protection', () => {
    it('handles database query errors gracefully', async () => {
      mockSupabaseClient.auth.getUser.mockResolvedValue({
        data: { user: { id: 'user1' } },
        error: null,
      })

      mockSupabaseClient.from().select().eq().single
        .mockRejectedValue(new Error('Database connection failed'))

      const request = new NextRequest('http://localhost:3000/api/vendor-portal/performance?vendor_id=vendor1')
      const response = await getPerformance(request)

      expect(response.status).toBe(500)
      const data = await response.json()
      expect(data.error).toBe('Internal server error')
    })

    it('handles malformed JSON payloads in POST requests', async () => {
      mockSupabaseClient.auth.getUser.mockResolvedValue({
        data: { user: { id: 'user1' } },
        error: null,
      })

      // Create a request with malformed JSON
      const request = new NextRequest('http://localhost:3000/api/vendor-portal/communications', {
        method: 'POST',
        body: '{invalid-json',
        headers: {
          'Content-Type': 'application/json',
        },
      })

      const response = await getCommunications(request)
      expect(response.status).toBe(500) // Should handle JSON parse error
    })
  })

  describe('Data Sanitization', () => {
    it('prevents SQL injection in search parameters', async () => {
      mockSupabaseClient.auth.getUser.mockResolvedValue({
        data: { user: { id: 'user1' } },
        error: null,
      })

      // Mock vendor from same organization
      mockSupabaseClient.from().select().eq().single
        .mockResolvedValueOnce({
          data: { organization_id: 'my-org' },
          error: null,
        })
        .mockResolvedValueOnce({
          data: { organization_id: 'my-org' },
          error: null,
        })

      // Attempt SQL injection in vendor_id parameter
      const maliciousRequest = new NextRequest("http://localhost:3000/api/vendor-portal/weddings?vendor_id=vendor1'; DROP TABLE suppliers; --")
      const response = await getWeddings(maliciousRequest)

      // Should either be 404 (vendor not found) or handle the malicious input safely
      expect([404, 403, 500].includes(response.status)).toBe(true)
    })

    it('sanitizes user input in performance metrics', async () => {
      mockSupabaseClient.auth.getUser.mockResolvedValue({
        data: { user: { id: 'user1' } },
        error: null,
      })

      const mockVendor = {
        id: 'vendor1',
        organization_id: 'my-org',
        business_name: 'Test Photography<script>alert("xss")</script>',
        average_rating: 4.5,
        total_reviews: 25,
      }

      mockSupabaseClient.from().select().eq().single
        .mockResolvedValue({ data: mockVendor, error: null })

      mockSupabaseClient.from().select().eq().eq().gte()
        .mockResolvedValue({ data: [], error: null })

      const request = new NextRequest('http://localhost:3000/api/vendor-portal/performance?vendor_id=vendor1')
      const response = await getPerformance(request)

      expect(response.status).toBe(200)
      // The API should return data without executing any scripts
      const data = await response.json()
      expect(data).toBeDefined()
    })
  })

  describe('Session Security', () => {
    it('validates session expiry', async () => {
      // Mock expired session
      mockSupabaseClient.auth.getUser.mockResolvedValue({
        data: { user: null },
        error: new Error('Session expired'),
      })

      const request = new NextRequest('http://localhost:3000/api/vendor-portal/performance?vendor_id=vendor1')
      const response = await getPerformance(request)

      expect(response.status).toBe(401)
      const data = await response.json()
      expect(data.error).toBe('Unauthorized')
    })

    it('prevents session fixation attacks', async () => {
      // Mock user with valid session
      mockSupabaseClient.auth.getUser.mockResolvedValue({
        data: { user: { id: 'user1' } },
        error: null,
      })

      const mockVendor = {
        id: 'vendor1',
        organization_id: 'my-org',
        business_name: 'Test Photography',
        average_rating: 4.5,
        total_reviews: 25,
      }

      mockSupabaseClient.from().select().eq().single
        .mockResolvedValue({ data: mockVendor, error: null })

      mockSupabaseClient.from().select().eq().eq().gte()
        .mockResolvedValue({ data: [], error: null })

      // Test with potentially malicious session token in headers
      const request = new NextRequest('http://localhost:3000/api/vendor-portal/performance?vendor_id=vendor1', {
        headers: {
          'Authorization': 'Bearer malicious-token-attempt',
          'X-Forwarded-For': '127.0.0.1',
        },
      })

      const response = await getPerformance(request)
      
      // Should use Supabase's built-in session validation
      expect(response.status).toBe(200)
    })
  })
})