import { SecurityAuditLogger, SecurityEventType, SecurityEventSeverity } from '@/lib/security/audit-logger';

// Mock Supabase client
jest.mock('@supabase/supabase-js', () => ({
  createClient: jest.fn(() => mockSupabaseClient)
}));

const mockSupabaseClient = {
  from: jest.fn().mockReturnThis(),
  insert: jest.fn().mockReturnThis(),
  select: jest.fn().mockReturnThis(),
  eq: jest.fn().mockReturnThis(),
  gte: jest.fn().mockReturnThis(),
  lte: jest.fn().mockReturnThis(),
  order: jest.fn().mockReturnThis(),
  limit: jest.fn().mockReturnThis(),
  range: jest.fn().mockReturnThis()
};

describe('SecurityAuditLogger', () => {
  let auditLogger: SecurityAuditLogger;
  let consoleSpy: jest.SpyInstance;
  let consoleErrorSpy: jest.SpyInstance;
  let consoleWarnSpy: jest.SpyInstance;

  beforeEach(() => {
    auditLogger = SecurityAuditLogger.getInstance();
    consoleSpy = jest.spyOn(console, 'log').mockImplementation(() => {});
    consoleErrorSpy = jest.spyOn(console, 'error').mockImplementation(() => {});
    consoleWarnSpy = jest.spyOn(console, 'warn').mockImplementation(() => {});
    
    // Reset mocks
    jest.clearAllMocks();
  });

  afterEach(() => {
    consoleSpy.mockRestore();
    consoleErrorSpy.mockRestore();
    consoleWarnSpy.mockRestore();
  });

  describe('Singleton Pattern', () => {
    it('should return the same instance', () => {
      const instance1 = SecurityAuditLogger.getInstance();
      const instance2 = SecurityAuditLogger.getInstance();
      expect(instance1).toBe(instance2);
    });
  });

  describe('logEvent', () => {
    it('should log security events successfully', async () => {
      mockSupabaseClient.from.mockImplementation(() => ({
        insert: jest.fn().mockResolvedValue({ error: null })
      }));

      const event = {
        event_type: SecurityEventType.LOGIN_SUCCESS,
        severity: SecurityEventSeverity.LOW,
        user_id: 'user123',
        ip_address: '192.168.1.1',
        description: 'User logged in successfully'
      };

      await auditLogger.logEvent(event);

      expect(mockSupabaseClient.from).toHaveBeenCalledWith('security_audit_logs');
      expect(consoleErrorSpy).not.toHaveBeenCalled();
    });

    it('should handle database insertion errors', async () => {
      const dbError = new Error('Database error');
      mockSupabaseClient.from.mockImplementation(() => ({
        insert: jest.fn().mockResolvedValue({ error: dbError })
      }));

      const event = {
        event_type: SecurityEventType.LOGIN_FAILED,
        severity: SecurityEventSeverity.MEDIUM,
        user_id: 'user123',
        description: 'Login attempt failed'
      };

      await auditLogger.logEvent(event);

      expect(consoleErrorSpy).toHaveBeenCalledWith('Failed to log security event:', dbError);
    });

    it('should trigger critical event notifications', async () => {
      mockSupabaseClient.from.mockImplementation(() => ({
        insert: jest.fn().mockResolvedValue({ error: null })
      }));

      const criticalEvent = {
        event_type: SecurityEventType.BRUTE_FORCE_DETECTED,
        severity: SecurityEventSeverity.CRITICAL,
        user_id: 'user123',
        description: 'Brute force attack detected'
      };

      await auditLogger.logEvent(criticalEvent);

      expect(consoleErrorSpy).toHaveBeenCalledWith('CRITICAL SECURITY EVENT:', expect.any(Object));
    });

    it('should use fallback logging when database fails', async () => {
      mockSupabaseClient.from.mockImplementation(() => {
        throw new Error('Database connection failed');
      });

      const event = {
        event_type: SecurityEventType.SUSPICIOUS_ACTIVITY,
        severity: SecurityEventSeverity.HIGH,
        description: 'Suspicious activity detected'
      };

      await auditLogger.logEvent(event);

      expect(consoleErrorSpy).toHaveBeenCalledWith('Security audit logging error:', expect.any(Error));
      expect(consoleWarnSpy).toHaveBeenCalledWith(
        expect.stringContaining('[SECURITY_AUDIT] HIGH'),
        event
      );
    });
  });

  describe('logAuthEvent', () => {
    it('should log successful authentication events', async () => {
      mockSupabaseClient.from.mockImplementation(() => ({
        insert: jest.fn().mockResolvedValue({ error: null })
      }));

      await auditLogger.logAuthEvent(
        'user123',
        SecurityEventType.LOGIN_SUCCESS,
        true,
        { session_id: 'session123' }
      );

      expect(mockSupabaseClient.from).toHaveBeenCalledWith('security_audit_logs');
    });

    it('should assign higher severity to failed auth events', async () => {
      mockSupabaseClient.from.mockImplementation(() => ({
        insert: jest.fn().mockResolvedValue({ error: null })
      }));

      await auditLogger.logAuthEvent(
        'user123',
        SecurityEventType.LOGIN_FAILED,
        false
      );

      expect(mockSupabaseClient.from).toHaveBeenCalledWith('security_audit_logs');
    });
  });

  describe('logMFAEvent', () => {
    it('should log MFA enrollment events', async () => {
      mockSupabaseClient.from.mockImplementation(() => ({
        insert: jest.fn().mockResolvedValue({ error: null })
      }));

      await auditLogger.logMFAEvent(
        'user123',
        SecurityEventType.MFA_ENROLLED,
        'totp',
        true
      );

      expect(mockSupabaseClient.from).toHaveBeenCalledWith('security_audit_logs');
    });

    it('should log MFA failure events with medium severity', async () => {
      mockSupabaseClient.from.mockImplementation(() => ({
        insert: jest.fn().mockResolvedValue({ error: null })
      }));

      await auditLogger.logMFAEvent(
        'user123',
        SecurityEventType.MFA_FAILED,
        'totp',
        false
      );

      expect(mockSupabaseClient.from).toHaveBeenCalledWith('security_audit_logs');
    });
  });

  describe('logDataAccessEvent', () => {
    it('should log data access events', async () => {
      mockSupabaseClient.from.mockImplementation(() => ({
        insert: jest.fn().mockResolvedValue({ error: null })
      }));

      await auditLogger.logDataAccessEvent(
        'user123',
        'guest_data',
        'guest456',
        'view_profile',
        { permission_level: 'read' }
      );

      expect(mockSupabaseClient.from).toHaveBeenCalledWith('security_audit_logs');
    });
  });

  describe('logSecurityThreat', () => {
    it('should log security threats with critical severity', async () => {
      mockSupabaseClient.from.mockImplementation(() => ({
        insert: jest.fn().mockResolvedValue({ error: null })
      }));

      await auditLogger.logSecurityThreat(
        SecurityEventType.SQL_INJECTION_BLOCKED,
        '192.168.1.100',
        'Mozilla/5.0',
        { blocked_query: 'malicious sql' }
      );

      expect(mockSupabaseClient.from).toHaveBeenCalledWith('security_audit_logs');
      expect(consoleErrorSpy).toHaveBeenCalledWith('CRITICAL SECURITY EVENT:', expect.any(Object));
    });
  });

  describe('queryLogs', () => {
    it('should query logs with filters', async () => {
      const mockData = [
        {
          id: '1',
          event_type: SecurityEventType.LOGIN_SUCCESS,
          severity: SecurityEventSeverity.LOW,
          user_id: 'user123',
          created_at: '2024-01-01T00:00:00.000Z'
        }
      ];

      mockSupabaseClient.from.mockImplementation(() => ({
        select: jest.fn().mockReturnThis(),
        eq: jest.fn().mockReturnThis(),
        gte: jest.fn().mockReturnThis(),
        lte: jest.fn().mockReturnThis(),
        order: jest.fn().mockReturnThis(),
        limit: jest.fn().mockReturnThis(),
        range: jest.fn().mockResolvedValue({ data: mockData, error: null })
      }));

      const query = {
        userId: 'user123',
        eventType: SecurityEventType.LOGIN_SUCCESS,
        severity: SecurityEventSeverity.LOW,
        startDate: new Date('2024-01-01'),
        endDate: new Date('2024-01-02'),
        limit: 10
      };

      const result = await auditLogger.queryLogs(query);

      expect(result).toEqual(mockData);
      expect(mockSupabaseClient.from).toHaveBeenCalledWith('security_audit_logs');
    });

    it('should handle query errors gracefully', async () => {
      const dbError = new Error('Query failed');
      mockSupabaseClient.from.mockImplementation(() => ({
        select: jest.fn().mockReturnThis(),
        order: jest.fn().mockReturnThis(),
        limit: jest.fn().mockResolvedValue({ data: null, error: dbError })
      }));

      const result = await auditLogger.queryLogs({});

      expect(result).toEqual([]);
      expect(consoleErrorSpy).toHaveBeenCalledWith('Failed to query audit logs:', dbError);
    });
  });

  describe('getUserSecuritySummary', () => {
    it('should generate user security summary', async () => {
      const mockLogs = [
        {
          event_type: SecurityEventType.LOGIN_SUCCESS,
          severity: SecurityEventSeverity.LOW,
          created_at: new Date()
        },
        {
          event_type: SecurityEventType.LOGIN_FAILED,
          severity: SecurityEventSeverity.MEDIUM,
          created_at: new Date()
        },
        {
          event_type: SecurityEventType.MFA_VERIFIED,
          severity: SecurityEventSeverity.LOW,
          created_at: new Date()
        }
      ];

      mockSupabaseClient.from.mockImplementation(() => ({
        select: jest.fn().mockReturnThis(),
        eq: jest.fn().mockReturnThis(),
        gte: jest.fn().mockReturnThis(),
        order: jest.fn().mockReturnThis(),
        limit: jest.fn().mockResolvedValue({ data: mockLogs, error: null })
      }));

      const summary = await auditLogger.getUserSecuritySummary('user123', 30);

      expect(summary).toMatchObject({
        totalEvents: 3,
        loginAttempts: 2,
        failedLogins: 1,
        mfaEvents: 1,
        securityThreats: 0,
        suspiciousActivities: 0
      });
    });
  });

  describe('exportAuditLogs', () => {
    it('should export logs in JSON format', async () => {
      const mockLogs = [
        {
          id: '1',
          event_type: SecurityEventType.LOGIN_SUCCESS,
          severity: SecurityEventSeverity.LOW,
          created_at: new Date('2024-01-01')
        }
      ];

      mockSupabaseClient.from.mockImplementation(() => ({
        select: jest.fn().mockReturnThis(),
        gte: jest.fn().mockReturnThis(),
        lte: jest.fn().mockReturnThis(),
        order: jest.fn().mockReturnThis(),
        limit: jest.fn().mockResolvedValue({ data: mockLogs, error: null })
      }));

      const result = await auditLogger.exportAuditLogs(
        new Date('2024-01-01'),
        new Date('2024-01-02'),
        'json'
      );

      expect(result).toBe(JSON.stringify(mockLogs, null, 2));
    });

    it('should export logs in CSV format', async () => {
      const mockLogs = [
        {
          id: '1',
          event_type: SecurityEventType.LOGIN_SUCCESS,
          severity: SecurityEventSeverity.LOW,
          user_id: 'user123',
          ip_address: '192.168.1.1',
          description: 'User logged in',
          created_at: new Date('2024-01-01')
        }
      ];

      mockSupabaseClient.from.mockImplementation(() => ({
        select: jest.fn().mockReturnThis(),
        gte: jest.fn().mockReturnThis(),
        lte: jest.fn().mockReturnThis(),
        order: jest.fn().mockReturnThis(),
        limit: jest.fn().mockResolvedValue({ data: mockLogs, error: null })
      }));

      const result = await auditLogger.exportAuditLogs(
        new Date('2024-01-01'),
        new Date('2024-01-02'),
        'csv'
      );

      expect(result).toContain('ID,Event Type,Severity,User ID,IP Address,Description,Created At');
      expect(result).toContain('"1","login_success","low","user123","192.168.1.1"');
    });
  });

  describe('Security Alert Thresholds', () => {
    beforeEach(() => {
      // Mock the queryLogs method to return recent events for threshold testing
      jest.spyOn(auditLogger, 'queryLogs').mockImplementation(async (query) => {
        if (query.eventType === SecurityEventType.LOGIN_FAILED) {
          return Array(6).fill({
            event_type: SecurityEventType.LOGIN_FAILED,
            user_id: query.userId,
            created_at: new Date()
          });
        }
        return [];
      });
    });

    it('should trigger security alerts when thresholds are exceeded', async () => {
      mockSupabaseClient.from.mockImplementation(() => ({
        insert: jest.fn().mockResolvedValue({ error: null })
      }));

      const event = {
        event_type: SecurityEventType.LOGIN_FAILED,
        severity: SecurityEventSeverity.MEDIUM,
        user_id: 'user123',
        description: 'Login failed'
      };

      await auditLogger.logEvent(event);

      // Should trigger alert for excessive login failures
      expect(mockSupabaseClient.from).toHaveBeenCalledWith('security_audit_logs');
    });
  });
});